(window.webpackJsonp=window.webpackJsonp||[]).push([[188],{589:function(t,a,s){"use strict";s.r(a);var n=s(54),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"不再神秘的优先级机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#不再神秘的优先级机制"}},[t._v("#")]),t._v(" 不再神秘的优先级机制")]),t._v(" "),s("p"),s("div",{staticClass:"table-of-contents"},[s("ul",[s("li",[s("a",{attrs:{href:"#为什么需要优先级"}},[t._v("为什么需要优先级")]),s("ul",[s("li",[s("a",{attrs:{href:"#同步模式下的-react-运行时"}},[t._v("同步模式下的 react 运行时")])]),s("li",[s("a",{attrs:{href:"#如何运用优先级机制优化-react-运行时"}},[t._v("如何运用优先级机制优化 react 运行时")])])])]),s("li",[s("a",{attrs:{href:"#确定不同场景下的调度优先级"}},[t._v("确定不同场景下的调度优先级")]),s("ul",[s("li",[s("a",{attrs:{href:"#lane-优先级"}},[t._v("lane 优先级")])]),s("li",[s("a",{attrs:{href:"#event-优先级"}},[t._v("event 优先级")])]),s("li",[s("a",{attrs:{href:"#scheduler-优先级"}},[t._v("scheduler 优先级")])]),s("li",[s("a",{attrs:{href:"#优先级间的转换"}},[t._v("优先级间的转换")])])])]),s("li",[s("a",{attrs:{href:"#优先级机制如何设计"}},[t._v("优先级机制如何设计")]),s("ul",[s("li",[s("a",{attrs:{href:"#设计思路"}},[t._v("设计思路")])]),s("li",[s("a",{attrs:{href:"#合并赛道"}},[t._v("合并赛道")])]),s("li",[s("a",{attrs:{href:"#释放赛道"}},[t._v("释放赛道")])]),s("li",[s("a",{attrs:{href:"#找出最高优先级赛道"}},[t._v("找出最高优先级赛道")])]),s("li",[s("a",{attrs:{href:"#快速定位赛道索引"}},[t._v("快速定位赛道索引")])]),s("li",[s("a",{attrs:{href:"#判断赛道是否被占用"}},[t._v("判断赛道是否被占用")])])])]),s("li",[s("a",{attrs:{href:"#如何将优先级机制融入-react-运行时"}},[t._v("如何将优先级机制融入 React 运行时")]),s("ul",[s("li",[s("a",{attrs:{href:"#生成一个更新任务"}},[t._v("生成一个更新任务")])]),s("li",[s("a",{attrs:{href:"#步骤一-获取本次更新的优先级"}},[t._v("步骤一：获取本次更新的优先级")])]),s("li",[s("a",{attrs:{href:"#步骤二-创建-update-对象"}},[t._v("步骤二：创建 Update 对象")])]),s("li",[s("a",{attrs:{href:"#步骤三-关联优先级"}},[t._v("步骤三：关联优先级")])]),s("li",[s("a",{attrs:{href:"#高优先级任务打断低优先级任务"}},[t._v("高优先级任务打断低优先级任务")])]),s("li",[s("a",{attrs:{href:"#cancelcallback"}},[t._v("cancelCallback")])]),s("li",[s("a",{attrs:{href:"#pop-taskqueue"}},[t._v("pop(taskQueue)")])]),s("li",[s("a",{attrs:{href:"#低优先级任务重启"}},[t._v("低优先级任务重启")])]),s("li",[s("a",{attrs:{href:"#饥饿任务问题"}},[t._v("饥饿任务问题")])])])]),s("li",[s("a",{attrs:{href:"#总结"}},[t._v("总结")])])])]),s("p"),t._v(" "),s("h2",{attrs:{id:"为什么需要优先级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#为什么需要优先级"}},[t._v("#")]),t._v(" 为什么需要优先级")]),t._v(" "),s("p",[t._v("优先级机制最终目的是为了实现"),s("code",[t._v("高优先级任务优先执行，低优先级任务延后执行")]),t._v("。")]),t._v(" "),s("p",[t._v("实现这一目的的本质就是在低优先级任务执行时，有更高优先级任务进来的话，可以打断低优先级任务的执行。")]),t._v(" "),s("h3",{attrs:{id:"同步模式下的-react-运行时"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#同步模式下的-react-运行时"}},[t._v("#")]),t._v(" 同步模式下的 react 运行时")]),t._v(" "),s("p",[t._v("我们知道在同步模式下，从 "),s("code",[t._v("setState")]),t._v(" 到 虚拟 DOM 遍历，再到真实 DOM 更新，整个过程都是同步执行且无法被中断的，这样可能就会出现一个问题 —— 用户事件触发的更新被阻塞。")]),t._v(" "),s("p",[t._v("什么是用户事件触发的更新被阻塞？如果 React 正在进行更新任务，此时用户触发了交互事件，且在事件回调中执行了 "),s("code",[t._v("setState")]),t._v("，在"),s("code",[t._v("同步模式")]),t._v("下，这个更新任务需要 "),s("code",[t._v("等待")]),t._v(" 当前正在更新的任务完成之后，才会被执行。假如当前 React 正在进行的更新任务耗时比较久，用户事件触发的更新任务不能及时被执行，造成下个更新任务被阻塞，从而形成了卡顿。")]),t._v(" "),s("p",[t._v("这时候，我们就希望能够及时响应用户触发的事件，优先执行用户事件触发的更新任务，也就是我们说的"),s("code",[t._v("异步模式")])]),t._v(" "),s("p",[t._v("我们可以比较一下，"),s("code",[t._v("同步模式")]),t._v("下和"),s("code",[t._v("异步模式")]),t._v("("),s("code",[t._v("优先级机制")]),t._v(")下更新任务执行的差异")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'react'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./styles.css'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("extends")]),t._v(" React"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      list"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Array")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fill")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domRef "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentDidMount")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setTimeout 准备更新'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" performance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          list"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Array")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fill")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("random")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          updateLanes"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setTimeout 更新完毕'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" performance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domRef"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("click")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("150")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" list "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("div\n        ref"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("v")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domRef "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        className"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'App'")]),t._v("\n        onClick"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'click 准备更新'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" performance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" list"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Array")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fill")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" updateLanes"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n              console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'click 更新完毕'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" performance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" index")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("h1 key"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("Hello "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("h1"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br"),s("span",{staticClass:"line-number"},[t._v("39")]),s("br"),s("span",{staticClass:"line-number"},[t._v("40")]),s("br"),s("span",{staticClass:"line-number"},[t._v("41")]),s("br"),s("span",{staticClass:"line-number"},[t._v("42")]),s("br"),s("span",{staticClass:"line-number"},[t._v("43")]),s("br"),s("span",{staticClass:"line-number"},[t._v("44")]),s("br"),s("span",{staticClass:"line-number"},[t._v("45")]),s("br"),s("span",{staticClass:"line-number"},[t._v("46")]),s("br"),s("span",{staticClass:"line-number"},[t._v("47")]),s("br"),s("span",{staticClass:"line-number"},[t._v("48")]),s("br"),s("span",{staticClass:"line-number"},[t._v("49")]),s("br"),s("span",{staticClass:"line-number"},[t._v("50")]),s("br"),s("span",{staticClass:"line-number"},[t._v("51")]),s("br")])]),s("p",[t._v("上面代码在同步模式下的打印是")]),t._v(" "),s("div",{attrs:{align:"center"}},[s("img",{attrs:{src:t.$withBase("/images/react/05-react18/react18-092501.webp"),alt:"react/05-react18/react18-092501.webp"}})]),t._v(" "),s("p",[t._v("可以看到 "),s("code",[t._v("click 事件")]),t._v(" 触发的更新，需要等待 "),s("code",[t._v("setTimeout")]),t._v(" 触发的更新才会被执行")]),t._v(" "),s("p",[t._v("上面代码在"),s("code",[t._v("异步模式")]),t._v("下的打印是")]),t._v(" "),s("div",{attrs:{align:"center"}},[s("img",{attrs:{src:t.$withBase("/images/react/05-react18/react18-092502.webp"),alt:"react/05-react18/react18-092502.webp"}})]),t._v(" "),s("p",[t._v("可以看到 "),s("code",[t._v("click 事件")]),t._v(" 触发的更新，会比 "),s("code",[t._v("setTimeout")]),t._v(" 触发的更新更优先执行，做到了及时响应用户事件，打断 "),s("code",[t._v("setTimeout")]),t._v(" 更新任务("),s("code",[t._v("低优先级任务")]),t._v(")的执行。")]),t._v(" "),s("h3",{attrs:{id:"如何运用优先级机制优化-react-运行时"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何运用优先级机制优化-react-运行时"}},[t._v("#")]),t._v(" 如何运用优先级机制优化 react 运行时")]),t._v(" "),s("p",[t._v("为了解决同步模式渲染下的缺陷，我们希望能够对 react 做出下面这些优化")]),t._v(" "),s("ol",[s("li",[t._v("确定不同场景下所触发更新的优先级，以便我们可以决定优先执行哪些任务")]),t._v(" "),s("li",[t._v("若有更高优先级的任务进来，我们需要打断当前进行的任务，然后执行这个高优先级任务")]),t._v(" "),s("li",[t._v("确保低优先级任务不会被一直打断，在一定时间后能够被升级为最高优先级的任务")])]),t._v(" "),s("h2",{attrs:{id:"确定不同场景下的调度优先级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#确定不同场景下的调度优先级"}},[t._v("#")]),t._v(" 确定不同场景下的调度优先级")]),t._v(" "),s("p",[t._v("看过 react 源码的小伙伴可能都会有一个疑惑，为什么源码里面有那么多优先级相关的单词？？怎么区分他们呢？")]),t._v(" "),s("p",[t._v("其实在 react 中主要分为两类优先级，"),s("code",[t._v("scheduler")]),t._v(" 优先级和 "),s("code",[t._v("lane")]),t._v(" 优先级，"),s("code",[t._v("lane")]),t._v("优先级下面又派生出 "),s("code",[t._v("event")]),t._v(" 优先级")]),t._v(" "),s("ul",[s("li",[t._v("lane 优先级：主要用于任务调度前，对当前正在进行的任务和被调度任务做一个优先级校验，判断是否需要打断当前正在进行的任务")]),t._v(" "),s("li",[t._v("event 优先级：本质上也是 lane 优先级，lane 优先级是通用的，event 优先级更多是结合浏览器原生事件，对 lane 优先级做了分类和映射")]),t._v(" "),s("li",[t._v("scheduler 优先级：主要用在时间分片中任务过期时间的计算")])]),t._v(" "),s("h3",{attrs:{id:"lane-优先级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lane-优先级"}},[t._v("#")]),t._v(" lane 优先级")]),t._v(" "),s("p",[t._v("可以用赛道的概念去理解 lane 优先级，lane 优先级有 31 个，我们可以用 31 位的二进制值去表示，值的每一位代表一条赛道对应一个 lane 优先级，"),s("code",[t._v("赛道位置越靠前，优先级越高")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("优先级")]),t._v(" "),s("th",[t._v("十进制值")]),t._v(" "),s("th",[t._v("二进制值")]),t._v(" "),s("th",[t._v("赛道位置")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("NoLane")]),t._v(" "),s("td",[t._v("0")]),t._v(" "),s("td",[t._v("0000000000000000000000000000000")]),t._v(" "),s("td",[t._v("0")])]),t._v(" "),s("tr",[s("td",[t._v("SyncLane")]),t._v(" "),s("td",[t._v("1")]),t._v(" "),s("td",[t._v("0000000000000000000000000000001")]),t._v(" "),s("td",[t._v("0")])]),t._v(" "),s("tr",[s("td",[t._v("InputContinuousHydrationLane")]),t._v(" "),s("td",[t._v("2")]),t._v(" "),s("td",[t._v("0000000000000000000000000000010")]),t._v(" "),s("td",[t._v("1")])]),t._v(" "),s("tr",[s("td",[t._v("InputContinuousLane")]),t._v(" "),s("td",[t._v("4")]),t._v(" "),s("td",[t._v("0000000000000000000000000000100")]),t._v(" "),s("td",[t._v("2")])]),t._v(" "),s("tr",[s("td",[t._v("DefaultHydrationLane")]),t._v(" "),s("td",[t._v("8")]),t._v(" "),s("td",[t._v("0000000000000000000000000001000")]),t._v(" "),s("td",[t._v("3")])]),t._v(" "),s("tr",[s("td",[t._v("DefaultLane")]),t._v(" "),s("td",[t._v("16")]),t._v(" "),s("td",[t._v("0000000000000000000000000010000")]),t._v(" "),s("td",[t._v("4")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionHydrationLane")]),t._v(" "),s("td",[t._v("32")]),t._v(" "),s("td",[t._v("0000000000000000000000000100000")]),t._v(" "),s("td",[t._v("5")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane1")]),t._v(" "),s("td",[t._v("64")]),t._v(" "),s("td",[t._v("0000000000000000000000001000000")]),t._v(" "),s("td",[t._v("6")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane2")]),t._v(" "),s("td",[t._v("128")]),t._v(" "),s("td",[t._v("0000000000000000000000010000000")]),t._v(" "),s("td",[t._v("7")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane3")]),t._v(" "),s("td",[t._v("256")]),t._v(" "),s("td",[t._v("0000000000000000000000100000000")]),t._v(" "),s("td",[t._v("8")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane4")]),t._v(" "),s("td",[t._v("512")]),t._v(" "),s("td",[t._v("0000000000000000000001000000000")]),t._v(" "),s("td",[t._v("9")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane5")]),t._v(" "),s("td",[t._v("1024")]),t._v(" "),s("td",[t._v("0000000000000000000010000000000")]),t._v(" "),s("td",[t._v("10")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane")]),t._v(" "),s("td",[t._v("2048")]),t._v(" "),s("td",[t._v("0000000000000000000100000000000")]),t._v(" "),s("td",[t._v("11")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane7")]),t._v(" "),s("td",[t._v("4096")]),t._v(" "),s("td",[t._v("0000000000000000001000000000000")]),t._v(" "),s("td",[t._v("12")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane8")]),t._v(" "),s("td",[t._v("8192")]),t._v(" "),s("td",[t._v("0000000000000000010000000000000")]),t._v(" "),s("td",[t._v("13")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane9")]),t._v(" "),s("td",[t._v("16384")]),t._v(" "),s("td",[t._v("0000000000000000100000000000000")]),t._v(" "),s("td",[t._v("14")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane10")]),t._v(" "),s("td",[t._v("32768")]),t._v(" "),s("td",[t._v("0000000000000001000000000000000")]),t._v(" "),s("td",[t._v("15")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane11")]),t._v(" "),s("td",[t._v("65536")]),t._v(" "),s("td",[t._v("0000000000000010000000000000000")]),t._v(" "),s("td",[t._v("16")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane12")]),t._v(" "),s("td",[t._v("131072")]),t._v(" "),s("td",[t._v("0000000000000100000000000000000")]),t._v(" "),s("td",[t._v("17")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane13")]),t._v(" "),s("td",[t._v("262144")]),t._v(" "),s("td",[t._v("0000000000001000000000000000000")]),t._v(" "),s("td",[t._v("18")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane14")]),t._v(" "),s("td",[t._v("524288")]),t._v(" "),s("td",[t._v("0000000000010000000000000000000")]),t._v(" "),s("td",[t._v("19")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane15")]),t._v(" "),s("td",[t._v("1048576")]),t._v(" "),s("td",[t._v("0000000000100000000000000000000")]),t._v(" "),s("td",[t._v("20")])]),t._v(" "),s("tr",[s("td",[t._v("TransitionLane16")]),t._v(" "),s("td",[t._v("2097152")]),t._v(" "),s("td",[t._v("0000000001000000000000000000000")]),t._v(" "),s("td",[t._v("21")])]),t._v(" "),s("tr",[s("td",[t._v("RetryLane1")]),t._v(" "),s("td",[t._v("4194304")]),t._v(" "),s("td",[t._v("0000000010000000000000000000000")]),t._v(" "),s("td",[t._v("22")])]),t._v(" "),s("tr",[s("td",[t._v("RetryLane2")]),t._v(" "),s("td",[t._v("8388608")]),t._v(" "),s("td",[t._v("0000000100000000000000000000000")]),t._v(" "),s("td",[t._v("23")])]),t._v(" "),s("tr",[s("td",[t._v("RetryLane3")]),t._v(" "),s("td",[t._v("16777216")]),t._v(" "),s("td",[t._v("0000001000000000000000000000000")]),t._v(" "),s("td",[t._v("24")])]),t._v(" "),s("tr",[s("td",[t._v("RetryLane4")]),t._v(" "),s("td",[t._v("33554432")]),t._v(" "),s("td",[t._v("0000010000000000000000000000000")]),t._v(" "),s("td",[t._v("25")])]),t._v(" "),s("tr",[s("td",[t._v("RetryLane5")]),t._v(" "),s("td",[t._v("67108864")]),t._v(" "),s("td",[t._v("0000100000000000000000000000000")]),t._v(" "),s("td",[t._v("26")])]),t._v(" "),s("tr",[s("td",[t._v("SelectiveHydrationLane")]),t._v(" "),s("td",[t._v("134217728")]),t._v(" "),s("td",[t._v("0001000000000000000000000000000")]),t._v(" "),s("td",[t._v("27")])]),t._v(" "),s("tr",[s("td",[t._v("IdleHydrationLane")]),t._v(" "),s("td",[t._v("268435456")]),t._v(" "),s("td",[t._v("0010000000000000000000000000000")]),t._v(" "),s("td",[t._v("28")])]),t._v(" "),s("tr",[s("td",[t._v("IdleLane")]),t._v(" "),s("td",[t._v("536870912")]),t._v(" "),s("td",[t._v("0100000000000000000000000000000")]),t._v(" "),s("td",[t._v("29")])]),t._v(" "),s("tr",[s("td",[t._v("OffscreenLane")]),t._v(" "),s("td",[t._v("1073741824")]),t._v(" "),s("td",[t._v("1000000000000000000000000000000")]),t._v(" "),s("td",[t._v("30")])])])]),t._v(" "),s("h3",{attrs:{id:"event-优先级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#event-优先级"}},[t._v("#")]),t._v(" event 优先级")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("EventPriority")]),t._v(" "),s("th"),t._v(" "),s("th",[t._v("Lane")]),t._v(" "),s("th",[t._v("数值")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("DiscreteEventPriority")]),t._v(" "),s("td",[t._v("离散事件。click、keydown、focusin 等，事件的触发不是连续，可以做到快速响应")]),t._v(" "),s("td",[t._v("SyncLane")]),t._v(" "),s("td",[t._v("1")])]),t._v(" "),s("tr",[s("td",[t._v("ContinuousEventPriority")]),t._v(" "),s("td",[t._v("连续事件。drag、scroll、mouseover 等，事件的是连续触发的，快速响应可能会阻塞渲染，优先级较离散事件低")]),t._v(" "),s("td",[t._v("InputContinuousLane")]),t._v(" "),s("td",[t._v("4")])]),t._v(" "),s("tr",[s("td",[t._v("DefaultEventPriority")]),t._v(" "),s("td",[t._v("默认的事件优先级")]),t._v(" "),s("td",[t._v("DefaultLane")]),t._v(" "),s("td",[t._v("16")])]),t._v(" "),s("tr",[s("td",[t._v("IdleEventPriority")]),t._v(" "),s("td",[t._v("空闲的优先级")]),t._v(" "),s("td",[t._v("IdleLane")]),t._v(" "),s("td",[t._v("536870912")])])])]),t._v(" "),s("h3",{attrs:{id:"scheduler-优先级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#scheduler-优先级"}},[t._v("#")]),t._v(" scheduler 优先级")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("SchedulerPriority")]),t._v(" "),s("th",[t._v("EventPriority")]),t._v(" "),s("th",[t._v("大于>17.0.2")]),t._v(" "),s("th",[t._v("小于>17.0.2")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("ImmediatePriority")]),t._v(" "),s("td",[t._v("DiscreteEventPriority")]),t._v(" "),s("td",[t._v("1")]),t._v(" "),s("td",[t._v("99")])]),t._v(" "),s("tr",[s("td",[t._v("UserblockingPriority")]),t._v(" "),s("td",[t._v("Userblocking")]),t._v(" "),s("td",[t._v("2")]),t._v(" "),s("td",[t._v("98")])]),t._v(" "),s("tr",[s("td",[t._v("NormalPriority")]),t._v(" "),s("td",[t._v("DefaultEventPriority")]),t._v(" "),s("td",[t._v("3")]),t._v(" "),s("td",[t._v("97")])]),t._v(" "),s("tr",[s("td",[t._v("LowPriority")]),t._v(" "),s("td",[t._v("DefaultEventPriority")]),t._v(" "),s("td",[t._v("4")]),t._v(" "),s("td",[t._v("96")])]),t._v(" "),s("tr",[s("td",[t._v("IdlePriority")]),t._v(" "),s("td",[t._v("IdleEventPriority")]),t._v(" "),s("td",[t._v("5")]),t._v(" "),s("td",[t._v("95")])]),t._v(" "),s("tr",[s("td",[t._v("NoPriority")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("0")]),t._v(" "),s("td",[t._v("90")])])])]),t._v(" "),s("h3",{attrs:{id:"优先级间的转换"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#优先级间的转换"}},[t._v("#")]),t._v(" 优先级间的转换")]),t._v(" "),s("ul",[s("li",[t._v("lane 优先级 转 event 优先级（参考 "),s("code",[t._v("lanesToEventPriority")]),t._v(" 函数）\n"),s("ul",[s("li",[t._v("转换规则：以区间的形式根据传入的 lane 返回对应的 event 优先级。比如传入的优先级不大于 Discrete 优先级，就返回 Discrete 优先级，以此类推")])])]),t._v(" "),s("li",[t._v("event 优先级 转 scheduler 优先级（参考 "),s("code",[t._v("ensureRootIsScheduled")]),t._v(" 函数）\n"),s("ul",[s("li",[t._v("转换规则：可以参考上面 scheduler 优先级表")])])]),t._v(" "),s("li",[t._v("event 优先级 转 lane 优先级（参考 "),s("code",[t._v("getEventPriority")]),t._v(" 函数）\n"),s("ul",[s("li",[t._v("转换规则：对于非离散、连续的事件，会根据一定规则作转换，具体课参考上面 event 优先级表")])])])]),t._v(" "),s("h2",{attrs:{id:"优先级机制如何设计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#优先级机制如何设计"}},[t._v("#")]),t._v(" 优先级机制如何设计")]),t._v(" "),s("p",[t._v("说到优先级机制，我们可能马上能联想到的是优先级队列，其最突出的特性是"),s("code",[t._v("最高优先级先出")]),t._v("，react 的优先级机制跟优先级队列类似，不过其利用了"),s("code",[t._v("赛道")]),t._v("的概念，配合"),s("code",[t._v("位与运算")]),t._v("丰富了队列的功能，比起优先级队列，读写速度更快，更加容易理解")]),t._v(" "),s("h3",{attrs:{id:"设计思路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#设计思路"}},[t._v("#")]),t._v(" 设计思路")]),t._v(" "),s("ol",[s("li",[t._v("合并赛道：维护一个队列，可以存储被占用的赛道")]),t._v(" "),s("li",[t._v("释放赛道：根据优先级释放对应被占用赛道")]),t._v(" "),s("li",[t._v("找出最高优先级赛道：获取队列中最高优先级赛道")]),t._v(" "),s("li",[t._v("快速定位赛道索引：根据优先级获取赛道在队列中所在的位置")]),t._v(" "),s("li",[t._v("判断赛道是否被占用：根据传入优先级判断该优先级所在赛道是否被占用")])]),t._v(" "),s("h3",{attrs:{id:"合并赛道"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#合并赛道"}},[t._v("#")]),t._v(" 合并赛道")]),t._v(" "),s("ul",[s("li",[t._v("场景\n"),s("ul",[s("li",[t._v("比如当前正在调度的任务优先级是 DefaultLane，用户点击触发更新，有一个高优先级的任务 SyncLane 产生，需要存储这个任务所占用的赛道")])])]),t._v(" "),s("li",[t._v("运算过程\n"),s("ul",[s("li",[t._v("运算方式：位或运算 - "),s("code",[t._v("a | b")])]),t._v(" "),s("li",[t._v("运算结果：DefaultLane 和 SyncLane 分别占用了第 1 条和第 5 条赛道")])])])]),t._v(" "),s("div",{staticClass:"language-ini line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[t._v("DefaultLane优先级为16，SyncLane优先级为1\n\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("16 | 1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("17")]),t._v("\n\n17的二进制值为10001\n16的二进制值为10000，1的二进制值为00001\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("h3",{attrs:{id:"释放赛道"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#释放赛道"}},[t._v("#")]),t._v(" 释放赛道")]),t._v(" "),s("ul",[s("li",[t._v("场景\n"),s("ul",[s("li",[t._v("SyncLane 任务执行完，需要释放占用的赛道")])])]),t._v(" "),s("li",[t._v("运算过程\n"),s("ul",[s("li",[t._v("运算方式：位与+位非 - "),s("code",[t._v("a & ~b")])]),t._v(" "),s("li",[t._v("运算结果：SyncLane 赛道被释放，只剩下 DefaultLane 赛道")])])])]),t._v(" "),s("div",{staticClass:"language-ini line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("17 & ~1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("16")]),t._v("\n17的二进制值为10001\n\n为什么用位非？\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("~1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("-2")]),t._v("\n2 的二进制是00010，-2的话符号位取反变为10010\n10001和10010进行位与运算得到10000，也就是十进制的16\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("h3",{attrs:{id:"找出最高优先级赛道"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#找出最高优先级赛道"}},[t._v("#")]),t._v(" 找出最高优先级赛道")]),t._v(" "),s("ul",[s("li",[t._v("场景\n"),s("ul",[s("li",[t._v("当前有 DefaultLane 和 SyncLane 两个优先级的任务占用赛道，在进入 ensureRootIsScheduled 方法后，我需要先调度优先级最高的任务，所以需要找出当前优先级最高的赛道")])])]),t._v(" "),s("li",[t._v("运算过程\n"),s("ul",[s("li",[t._v("运算方式：位与+符号位取反 - "),s("code",[t._v("a & -b")])]),t._v(" "),s("li",[t._v("运算结果：找到了最高优先级的任务 SyncLane，SyncLane 任务为同步任务，Scheduler 将以同步优先级调度当前应用根节点")])])])]),t._v(" "),s("div",{staticClass:"language-ini line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("17 & -17")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("1")]),t._v("\n\n17的二进制值为10001\n-17的二进制值为00001\n10001和00001进行位与运算得到1，也就是SyncLane\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("h3",{attrs:{id:"快速定位赛道索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#快速定位赛道索引"}},[t._v("#")]),t._v(" 快速定位赛道索引")]),t._v(" "),s("ul",[s("li",[t._v("场景\n"),s("ul",[s("li",[t._v("饥饿任务唤醒：在发起调度前，我们需要对队列中的所有赛道进行一个判断，判断该赛道的任务是否过期，如果过期，就优先执行该过期任务。为此，需要维护一个长度为 31 的数组，数组的每个元素的下标索引与 31 个优先级赛道一一对应，数组中存储的是"),s("code",[t._v("任务的过期时间")]),t._v("，在判断时，我们希望能根据优先级快速找到该优先级在数组中对应的位置。")])])]),t._v(" "),s("li",[t._v("运算过程\n"),s("ul",[s("li",[t._v("运算方式："),s("code",[t._v("Math.clz32")])]),t._v(" "),s("li",[t._v("运算结果：找到了 DefaultLane 的索引位置为 4，那就可以释放应用根节点上的 eventTimes、expirationTimes，将其所在位置的值赋值为-1，然后执行对应的过期任务")])])])]),t._v(" "),s("div",{staticClass:"language-ini line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[t._v("// 找出 DefaultLane 赛道索引\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("31 - Math.clz32(16)")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("4")]),t._v("\n\n16的二进制值为10000\n索引4对应的就是第五个赛道\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("Math.clz32 是用来干什么的？")]),t._v(" "),s("ul",[s("li",[t._v("获取一个十进制数字对应二进制值中开头 0 的个数。")]),t._v(" "),s("li",[t._v("所以用 31 减去 "),s("code",[t._v("Math.clz32")]),t._v(" 的值就能得到该赛道的索引")])]),t._v(" "),s("h3",{attrs:{id:"判断赛道是否被占用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#判断赛道是否被占用"}},[t._v("#")]),t._v(" 判断赛道是否被占用")]),t._v(" "),s("p",[s("code",[t._v("异步模式")]),t._v("下会存在高优先级任务插队的情况，此情况下 "),s("code",[t._v("state")]),t._v(" 的计算方式会跟"),s("code",[t._v("同步模式")]),t._v("下有些不同。")]),t._v(" "),s("ul",[s("li",[t._v("场景\n"),s("ol",[s("li",[t._v("我们 "),s("code",[t._v("setState")]),t._v(" 之后并不是马上就会更新 state，而是会根据 setState 的内容生成一个 "),s("code",[t._v("Update")]),t._v(" 对象，这个对象包含了更新内容、更新优先级等属性。")]),t._v(" "),s("li",[t._v("更新 "),s("code",[t._v("state")]),t._v(" 这个动作是在 "),s("code",[t._v("processUpdateQueue")]),t._v(" 函数里进行的，函数里面会判断 "),s("code",[t._v("Update")]),t._v(" 对象的优先级所在赛道是否被占用，来决定是否在此轮任务中计算这个 Update 对象的 state\n"),s("ul",[s("li",[t._v("如果被占用，代表 "),s("code",[t._v("Update")]),t._v(" 对象优先级和当前正在进行的任务相等，可以根据 "),s("code",[t._v("Update")]),t._v(" 对象计算 state 并更新到 "),s("code",[t._v("Fiber")]),t._v(" 节点的 "),s("code",[t._v("memoizedState")]),t._v(" 属性上")]),t._v(" "),s("li",[t._v("如果未被占用，代表当前正在进行的任务优先级比这个 "),s("code",[t._v("Update")]),t._v(" 对象优先级高，相应的这个低优先级的 "),s("code",[t._v("Update")]),t._v(" 对象将暂不被计算 state，留到下一轮低优先级任务被重启时再进行计算")])])])])]),t._v(" "),s("li",[t._v("运算过程\n"),s("ul",[s("li",[t._v("运算方式：位与 "),s("code",[t._v("(renderLanes & updateLanes) == updateLanes")])]),t._v(" "),s("li",[t._v("运算结果：0 代表当前调度优先级高于某个 Update 对象优先级")])])])]),t._v(" "),s("div",{staticClass:"language-ini line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[t._v("运算公式\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("(1 & 16)")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("= 16")]),t._v("\n\n1的二进制值为00001\n16的二进制值为10000\n00001和10000进行位与运算得到0\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("h2",{attrs:{id:"如何将优先级机制融入-react-运行时"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何将优先级机制融入-react-运行时"}},[t._v("#")]),t._v(" 如何将优先级机制融入 React 运行时")]),t._v(" "),s("h3",{attrs:{id:"生成一个更新任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#生成一个更新任务"}},[t._v("#")]),t._v(" 生成一个更新任务")]),t._v(" "),s("p",[t._v("生成任务的流程其实非常简单，入口就在我们常用的 setState 函数，先上图")]),t._v(" "),s("img",{attrs:{src:t.$withBase("/images/react/05-react18/react18-092503.webp"),alt:"react/05-react18/react18-092503.webp"}}),t._v(" "),s("p",[s("code",[t._v("setState")]),t._v(" 函数内部执行的就是 "),s("code",[t._v("enqueueUpdate")]),t._v(" 函数，而 "),s("code",[t._v("enqueueUpdate")]),t._v(" 函数的工作主要分为 4 步：")]),t._v(" "),s("ol",[s("li",[t._v("获取本次更新的优先级。")]),t._v(" "),s("li",[t._v("创建 "),s("code",[t._v("Update")]),t._v(" 对象")]),t._v(" "),s("li",[t._v("将本次更新优先级关联到当前 Fiber 节点、父级节点和应用根节点")]),t._v(" "),s("li",[t._v("发起 "),s("code",[t._v("ensureRootIsScheduled")]),t._v(" 调度。")])]),t._v(" "),s("h3",{attrs:{id:"步骤一-获取本次更新的优先级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#步骤一-获取本次更新的优先级"}},[t._v("#")]),t._v(" 步骤一：获取本次更新的优先级")]),t._v(" "),s("p",[t._v("步骤一的工作是调用 "),s("code",[t._v("requestUpdateLane")]),t._v(" 函数拿到此次更新任务的优先级")]),t._v(" "),s("ol",[s("li",[t._v("如果当前为非 "),s("code",[t._v("concurrent")]),t._v(" 模式\n"),s("ul",[s("li",[t._v("当前不在 render 阶段。返回 syncLane")]),t._v(" "),s("li",[t._v("当前正在 render 阶段。返回 workInProgressRootRenderLanes 中最高的优先级（这里就用到上面的优先级运算机制，"),s("code",[t._v("找出最高优先级赛道")]),t._v("）")])])]),t._v(" "),s("li",[t._v("如果当前为 "),s("code",[t._v("concurrent")]),t._v(" 模式\n"),s("ul",[s("li",[t._v("需要执行延迟任务的话，比如 "),s("code",[t._v("Suspend")]),t._v("、"),s("code",[t._v("useTransition")]),t._v("、"),s("code",[t._v("useDefferedValue")]),t._v(" 等特性。在 "),s("code",[t._v("transition")]),t._v(" 类型的优先级中寻找空闲的赛道。"),s("code",[t._v("transition")]),t._v(" 类型的赛道有 16 条，从第 1 条到第 16 条，当到达第 16 条赛道后，下一次 transition 类型的任务会回到第 1 条赛道，如此往复。")]),t._v(" "),s("li",[t._v("执行 "),s("code",[t._v("getCurrentUpdatePriority")]),t._v(" 函数。获取当前更新优先级。如果不为 "),s("code",[t._v("NoLane")]),t._v(" 就返回")]),t._v(" "),s("li",[t._v("执行 "),s("code",[t._v("getCurrentEventPriority")]),t._v(" 函数。返回当前的事件优先级。如果没有事件产生，返回 "),s("code",[t._v("DefaultEventPriority")])])])])]),t._v(" "),s("p",[t._v("总的来说，"),s("code",[t._v("requestUpdateLane")]),t._v(" 函数的优先级选取判断顺序如下：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("SyncLane  >>  TransitionLane  >>  UpdateLane  >>  EventLane\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("blockquote",[s("p",[t._v("估计有很多小伙伴都会很困惑一个问题，为什么会有这么多获取优先级的函数，这里我整理了一下其他函数的职责")])]),t._v(" "),s("img",{attrs:{src:t.$withBase("/images/react/05-react18/react18-092504.webp"),alt:"react/05-react18/react18-092504.webp"}}),t._v(" "),s("h3",{attrs:{id:"步骤二-创建-update-对象"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#步骤二-创建-update-对象"}},[t._v("#")]),t._v(" 步骤二：创建 Update 对象")]),t._v(" "),s("p",[t._v("这里的代码量不多，其实就是将 setState 的参数用一个对象封装起来，留给 render 阶段用")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createUpdate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("eventTime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lane")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" update "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    eventTime"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" eventTime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    lane"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" lane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    tag"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" UpdateState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    payload"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    callback"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    next"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" update"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("h3",{attrs:{id:"步骤三-关联优先级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#步骤三-关联优先级"}},[t._v("#")]),t._v(" 步骤三：关联优先级")]),t._v(" "),s("p",[t._v("在这里先解释两个概念，一个是 "),s("code",[t._v("HostRoot")]),t._v("，一个是 "),s("code",[t._v("FiberRootNode")])]),t._v(" "),s("ul",[s("li",[s("code",[t._v("HostRoot")]),t._v("：就是 "),s("code",[t._v("ReactDOM.render")]),t._v(" 的第一个参数，组件树的根节点。"),s("code",[t._v("HostRoot")]),t._v("可能会存在多个，因为 "),s("code",[t._v("ReactDOM.render")]),t._v(" 可以多次调用")]),t._v(" "),s("li",[s("code",[t._v("FiberRootNode")]),t._v("：react 的应用根节点，每个页面只有一个 react 的应用根节点。可以从 "),s("code",[t._v("HostRoot")]),t._v(" 节点的 "),s("code",[t._v("stateNode")]),t._v(" 属性访问")])]),t._v(" "),s("p",[t._v("这里关联优先级主要执行了两个函数")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("markUpdateLaneFromFiberToRoot")]),t._v("。该函数主要做了两个事情\n"),s("ul",[s("li",[t._v("将优先级合并到当前 Fiber 节点的 lanes 属性中")]),t._v(" "),s("li",[t._v("将优先级合并到父级节点的 childLanes 属性中（告诉父节点他的子节点有多少条赛道要跑） 但因为函数传入的 Fiber 节点是 "),s("code",[t._v("HostRoot")]),t._v("，也就是 "),s("code",[t._v("ReactDOM.render")]),t._v(" 的根节点，也就是说没有父节点了，所以第二件事情没有做")])])]),t._v(" "),s("li",[t._v("markRootUpdated。该函数也是主要做了两个事情\n"),s("ul",[s("li",[t._v("将待调度任务优先级合并到当前 react 应用根节点上")]),t._v(" "),s("li",[t._v("计算当前任务优先级赛道占用的开始时间（eventTime）")])])])]),t._v(" "),s("p",[t._v("由此可见，react 的优先级机制并不独立运行在每一个组件节点里面，而是依赖一个全局的 react 应用根节点去控制下面多个组件树的任务调度")]),t._v(" "),s("blockquote",[s("p",[t._v("将优先级关联到这些 Fiber 节点有什么用？")])]),t._v(" "),s("p",[t._v("先说说他们的"),s("code",[t._v("区别")])]),t._v(" "),s("ul",[s("li",[t._v("lanes：只存在非 react 应用根节点上，记录当前 Fiber 节点的 lane 优先级")]),t._v(" "),s("li",[t._v("childLanes：只存在非 react 应用根节点上，记录当前 Fiber 节点下的所有子 Fiber 节点的 lane 优先级")]),t._v(" "),s("li",[t._v("pendingLanes：只存在 react 应用根节点上，记录的是所有 HostRoot 的 lane 优先级")])]),t._v(" "),s("p",[t._v("具体"),s("code",[t._v("应用场景")])]),t._v(" "),s("ol",[s("li",[t._v("释放赛道。上面说的优先级运算机制提到了任务执行完毕会释放赛道，具体来说是在 commit 阶段结束之后释放被占用的优先级，也就是 markRootFinished 函数。")]),t._v(" "),s("li",[t._v("判断赛道是否被占用。在 render 阶段的 beginWork 流程里面，会有很多判断 childLanes 是否被占用的判断")])]),t._v(" "),s("h3",{attrs:{id:"高优先级任务打断低优先级任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#高优先级任务打断低优先级任务"}},[t._v("#")]),t._v(" 高优先级任务打断低优先级任务")]),t._v(" "),s("p",[t._v("该部分流程可以分为三部曲")]),t._v(" "),s("ol",[s("li",[t._v("cancelCallback")]),t._v(" "),s("li",[t._v("pop(taskQueue)")]),t._v(" "),s("li",[t._v("低优先级任务重启")])]),t._v(" "),s("h3",{attrs:{id:"cancelcallback"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cancelcallback"}},[t._v("#")]),t._v(" cancelCallback")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" existingCallbackNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" existingCallbackPriority "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackPriority"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" newCallbackPriority "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getHighestPriorityLane")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nextLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("existingCallbackPriority "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" newCallbackPriority")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("existingCallbackNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cancelCallback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("existingCallbackNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nnewCallbackNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleCallback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    schedulerPriorityLevel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("performConcurrentWorkOnRoot")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nroot"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackPriority "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCallbackPriority"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nroot"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" newCallbackNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br")])]),s("p",[t._v("上面是 "),s("code",[t._v("ensureRootIsScheduled")]),t._v(" 函数的一些代码片段，先对变量做解释")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("existingCallbackNode")]),t._v("：当前 render 阶段正在进行的任务")]),t._v(" "),s("li",[s("code",[t._v("existingCallbackPriority")]),t._v("：当前 render 阶段正在进行的任务优先级")]),t._v(" "),s("li",[s("code",[t._v("newCallbackPriority")]),t._v("：此次调度优先级")])]),t._v(" "),s("p",[t._v("这里会判断 "),s("code",[t._v("existingCallbackPriority")]),t._v(" 和 "),s("code",[t._v("newCallbackPriority")]),t._v(" 两个优先级是否相等，如果相等，此次更新合并到当前正在进行的任务中。如果不相等，代表此次更新任务的优先级更高，需要打断当前正在进行的任务")]),t._v(" "),s("p",[t._v("如何打断任务？")]),t._v(" "),s("ol",[s("li",[t._v("关键函数 "),s("code",[t._v("cancelCallback(existingCallbackNode)")]),t._v("，"),s("code",[t._v("cancelCallback")]),t._v(" 函数就是将 "),s("code",[t._v("root.callbackNode")]),t._v(" 赋值为 null")]),t._v(" "),s("li",[s("code",[t._v("performConcurrentWorkOnRoot")]),t._v(" 函数会先把 "),s("code",[t._v("root.callbackNode")]),t._v(" 缓存起来，在函数末尾会再判断 "),s("code",[t._v("root.callbackNode")]),t._v(" 和开始缓存起来的值是否一样，如果不一样，就代表 "),s("code",[t._v("root.callbackNode")]),t._v(" 被赋值为 null 了，有更高优先级任务进来。")]),t._v(" "),s("li",[t._v("此时 "),s("code",[t._v("performConcurrentWorkOnRoot")]),t._v(" 返回值为 null")])]),t._v(" "),s("p",[t._v("下面是 "),s("code",[t._v("performConcurrentWorkOnRoot")]),t._v(" 代码片段")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" originalCallbackNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackNode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 函数末尾")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" originalCallbackNode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("performConcurrentWorkOnRoot")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])]),s("p",[t._v("由上面 "),s("code",[t._v("ensureRootIsScheduled")]),t._v(" 的代码片段可以知道，"),s("code",[t._v("performConcurrentWorkOnRoot")]),t._v(" 函数是被 "),s("code",[t._v("scheduleCallback")]),t._v(" 函数调度的，具体返回后的逻辑需要到 "),s("code",[t._v("Scheduler")]),t._v(" 模块去找")]),t._v(" "),s("h3",{attrs:{id:"pop-taskqueue"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pop-taskqueue"}},[t._v("#")]),t._v(" pop(taskQueue)")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" callback "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" currentTask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" callback "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'function'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pop")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("taskQueue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("上面是 "),s("code",[t._v("Scheduler")]),t._v(" 模块里面 "),s("code",[t._v("workLoop")]),t._v(" 函数的代码片段，"),s("code",[t._v("currentTask.callback")]),t._v(" 就是 "),s("code",[t._v("scheduleCallback")]),t._v(" 的第二个参数，也就是 "),s("code",[t._v("performConcurrentWorkOnRoot")]),t._v(" 函数")]),t._v(" "),s("p",[t._v("承接上个主题，如果 "),s("code",[t._v("performConcurrentWorkOnRoot")]),t._v(" 函数返回了 null，"),s("code",[t._v("workLoop")]),t._v(" 内部就会执行 "),s("code",[t._v("pop(taskQueue)")]),t._v("，将当前的任务从 "),s("code",[t._v("taskQueue")]),t._v(" 中弹出。")]),t._v(" "),s("h3",{attrs:{id:"低优先级任务重启"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#低优先级任务重启"}},[t._v("#")]),t._v(" 低优先级任务重启")]),t._v(" "),s("p",[t._v("上一步中说道一个低优先级任务从 "),s("code",[t._v("taskQueue")]),t._v(" 中被弹出。那高优先级任务执行完毕之后，如何重启回之前的低优先级任务呢？")]),t._v(" "),s("p",[t._v("关键是在 "),s("code",[t._v("commitRootImpl")]),t._v(" 函数")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" remainingLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mergeLanes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" finishedWork"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("childLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("markRootFinished")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" remainingLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ensureRootIsScheduled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[s("code",[t._v("markRootFinished")]),t._v(" 函数刚刚上面说了是释放已完成任务所占用的赛道，那也就是说未完成任务依然会占用其赛道，所以我们可以重新调用 "),s("code",[t._v("ensureRootIsScheduled")]),t._v(" 发起一次新的调度，去重启低优先级任务的执行。我们可以看下重启部分的判断")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" nextLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getNextLanes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" root "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" workInProgressRoot "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" workInProgressRootRenderLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" NoLanes\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果 nextLanes 为 NoLanes，就证明所有任务都执行完毕了")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nextLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" NoLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("callbackPriority "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NoLane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 只要 nextLanes 为 NoLanes，就可以结束调度了")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果 nextLanes 不为 NoLanes，就代表还有任务未执行完，也就是那些被打断的低优先级任务")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("h3",{attrs:{id:"饥饿任务问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#饥饿任务问题"}},[t._v("#")]),t._v(" 饥饿任务问题")]),t._v(" "),s("p",[t._v("上面说到，在高优先级任务执行完毕之后，低优先级任务就会被重启，但假设如果持续有高优先级任务持续进来，我的低优先级任务岂不是没有重启之日？")]),t._v(" "),s("p",[t._v("所以 react 为了处理解决饥饿任务问题，react 在 "),s("code",[t._v("ensureRootIsScheduled")]),t._v(" 函数开始的时候做了以下处理：（参考 "),s("code",[t._v("markStarvedLanesAsExpired")]),t._v(" 函数）")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pendingLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" index "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pickArbitraryLaneIndex")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" expirationTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" expirationTimes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expirationTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" NoTimestamp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" suspendedLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" NoLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" pingedLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoLanes\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      expirationTimes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("computeExpirationTime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" currentTime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expirationTime "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" currentTime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("expiredLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|=")]),t._v(" lane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v("lane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br")])]),s("ol",[s("li",[t._v("遍历 31 条赛道，判断每条赛道的过期时间是否为 "),s("code",[t._v("NoTimestamp")]),t._v("，如果是，且该赛道存在待执行的任务，则为该赛道初始化过期时间")]),t._v(" "),s("li",[t._v("如果该赛道已存在过期时间，且过期时间已经小于当前时间，则代表任务已过期，需要将当前优先级合并到 "),s("code",[t._v("expiredLanes")]),t._v("，这样在下一轮 render 阶段就会以同步优先级调度当前 "),s("code",[t._v("HostRoot")])])]),t._v(" "),s("p",[t._v("可以参考 render 阶段执行的函数 "),s("code",[t._v("performConcurrentWorkOnRoot")]),t._v(" 中的代码片段")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" exitStatus "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("shouldTimeSlice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("didTimeout\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("renderRootConcurrent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("renderRootSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("可以看到只要 "),s("code",[t._v("shouldTimeSlice")]),t._v(" 只要返回 false，就会执行 "),s("code",[t._v("renderRootSync")]),t._v("，也就是以同步优先级进入 render 阶段。而 "),s("code",[t._v("shouldTimeSlice")]),t._v(" 的逻辑也就是刚刚的 "),s("code",[t._v("expiredLanes")]),t._v(" 属性相关")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("shouldTimeSlice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lanes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果 expiredLanes 里面有东西，代表有饥饿任务")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("expiredLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" SyncDefaultLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n    InputContinuousHydrationLane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    InputContinuousLane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    DefaultHydrationLane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    DefaultLane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" SyncDefaultLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" NoLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("react 的优先级机制在源码中并不是一个独立的，解耦的模块，而是涉及到了 react 整体运行的方方面面，最后回归整理下优先级机制在源码中的使用，让大家对优先级机制有一个更加整体的认知。")]),t._v(" "),s("ol",[s("li",[t._v("时间分片。涉及到任务打断、根据优先级计算分片时长")]),t._v(" "),s("li",[t._v("setState 生成 Update 对象。每个 Update 对象里面都有一个 lane 属性，代表此次更新的优先级")]),t._v(" "),s("li",[t._v("高优先级任务打断低优先级任务。每一次调度都会对正在进行任务和当前任务最高优先级做比较，如果不相等，就代表有高优先级任务进来，需要打断当前正在的任务。")]),t._v(" "),s("li",[t._v("低优先级任务重启。协调 ("),s("code",[t._v("reconcile")]),t._v(") 的下一个阶段是渲染 (renderer)，也就是我们说的 commit 阶段，在此阶段末尾，会调用 "),s("code",[t._v("ensureRootIsScheduled")]),t._v(" 发起一次新的调度，执行尚未完成的低优先级任务。")]),t._v(" "),s("li",[t._v("饥饿任务唤醒。每次调度的开始，都会先检查下有没有过期任务，如果有的话，下一次就会以同步优先级进行 render 任务("),s("code",[t._v("reconcile")]),t._v(")，同步优先级就是最高的优先级，不会被打断")])]),t._v(" "),s("p",[t._v("最后的最后，整理了一张整体的 react 思维导图，"),s("code",[t._v("Scheduler")]),t._v(" 模块的基本整理完了，后面的会围绕 render 阶段和 commit 阶段开讲。")]),t._v(" "),s("img",{attrs:{src:t.$withBase("/images/react/05-react18/react18-092505.webp"),alt:"react/05-react18/react18-092505.webp"}})])}),[],!1,null,null,null);a.default=e.exports}}]);