(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{451:function(s,a,n){"use strict";n.r(a);var e=n(54),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"lerna-yarn-workspace-使用总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lerna-yarn-workspace-使用总结"}},[s._v("#")]),s._v(" lerna + yarn workspace 使用总结")]),s._v(" "),n("p"),n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#模式对比"}},[s._v("模式对比")]),n("ul",[n("li",[n("a",{attrs:{href:"#multirepo"}},[s._v("Multirepo")])]),n("li",[n("a",{attrs:{href:"#monorepo"}},[s._v("Monorepo")])]),n("li",[n("a",{attrs:{href:"#lerna-yarn-workspace-应用场景"}},[s._v("lerna + yarn workspace 应用场景")])])])]),n("li",[n("a",{attrs:{href:"#lerna"}},[s._v("Lerna")]),n("ul",[n("li",[n("a",{attrs:{href:"#lerna-管理模式"}},[s._v("Lerna 管理模式")])]),n("li",[n("a",{attrs:{href:"#lerna-入门指引"}},[s._v("Lerna 入门指引")])]),n("li",[n("a",{attrs:{href:"#lerna-管理命令"}},[s._v("Lerna 管理命令")])]),n("li",[n("a",{attrs:{href:"#lerna-配置文件"}},[s._v("Lerna 配置文件")])]),n("li",[n("a",{attrs:{href:"#lerna-应用-demo"}},[s._v("Lerna 应用 Demo")])]),n("li",[n("a",{attrs:{href:"#lerna-版本发布"}},[s._v("Lerna 版本发布")])]),n("li",[n("a",{attrs:{href:"#lerna-最佳实践"}},[s._v("Lerna 最佳实践")])]),n("li",[n("a",{attrs:{href:"#leran-注意事项"}},[s._v("Leran 注意事项")])])])]),n("li",[n("a",{attrs:{href:"#yarn-workspace"}},[s._v("yarn workspace")]),n("ul",[n("li",[n("a",{attrs:{href:"#yarn-workspace-管理工程"}},[s._v("yarn workspace 管理工程")])]),n("li",[n("a",{attrs:{href:"#yarn-workspace-管理命令"}},[s._v("yarn workspace 管理命令")])]),n("li",[n("a",{attrs:{href:"#yarn-workspace-入门实战"}},[s._v("yarn workspace 入门实战")])])])])])]),n("p"),s._v(" "),n("p",[s._v("lerna 管理方式属于 "),n("code",[s._v("Monorepo")]),s._v(" 模式，这有别于传统的 "),n("code",[s._v("Multirepo")]),s._v(" 单仓库应用模式，下面我们先来了解一下两者的区别。")]),s._v(" "),n("h2",{attrs:{id:"模式对比"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#模式对比"}},[s._v("#")]),s._v(" 模式对比")]),s._v(" "),n("h3",{attrs:{id:"multirepo"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#multirepo"}},[s._v("#")]),s._v(" Multirepo")]),s._v(" "),n("p",[s._v("传统的项目开发模式，比如 create-react-app、vue-cli 等框架模板脚手架生成的项目。")]),s._v(" "),n("ul",[n("li",[s._v("优点：\n"),n("ol",[n("li",[s._v("各模块管理自由度高；")]),s._v(" "),n("li",[s._v("各模块仓库体积一般不会太大；")])])]),s._v(" "),n("li",[s._v("缺点\n"),n("ol",[n("li",[s._v("仓库分散不好找，分支管理混乱；")]),s._v(" "),n("li",[s._v("版本更新频繁，公共模块版本发生变化，需要对所有模块进行依赖更新；")])])])]),s._v(" "),n("h3",{attrs:{id:"monorepo"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#monorepo"}},[s._v("#")]),s._v(" Monorepo")]),s._v(" "),n("ul",[n("li",[s._v("优点：\n"),n("ol",[n("li",[s._v("统一的规范、构建工具；")]),s._v(" "),n("li",[s._v("方便版本管理和依赖，模块之间的引用调试都变得非常方便；")]),s._v(" "),n("li",[s._v("Multirepo 的缺点就是它的优点。")])])]),s._v(" "),n("li",[s._v("缺点：\n"),n("ol",[n("li",[s._v("随着应用扩展，仓库体积将变大。")])])])]),s._v(" "),n("h3",{attrs:{id:"lerna-yarn-workspace-应用场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lerna-yarn-workspace-应用场景"}},[s._v("#")]),s._v(" lerna + yarn workspace 应用场景")]),s._v(" "),n("ol",[n("li",[s._v("作为业务组件库的工程环境搭建。\n实现单个业务组件作为单独的 "),n("code",[s._v("npm")]),s._v(" 包 进行管理和发布，无需将各个业务组件分开建立在多个 Git 仓库中，且它们的技术栈、构建工具、规范等都可以保持一致。")]),s._v(" "),n("li",[s._v("作为日常业务项目工程管理。\n比如有一个低代码业务需求，低代码核心工作区的交互都相同，不同的是业务场景（外层壳子和一些定制功能），低代码相关的模块都可以复用，我们只需在这个仓库内不断去扩展业务需求即可，达到核心代码的复用（当然，可能会想到将低代码核心作为线上包）。")])]),s._v(" "),n("h2",{attrs:{id:"lerna"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lerna"}},[s._v("#")]),s._v(" Lerna")]),s._v(" "),n("p",[s._v("Lerna 是一个管理工具，用于管理包含多个软件包（package）的 JavaScript 项目，是 Babel 自己用来维护自己的 Monorepo 并开源出的一个项目。")]),s._v(" "),n("p",[s._v("它可以：")]),s._v(" "),n("ul",[n("li",[s._v("统一的一套规范、构建标准；")]),s._v(" "),n("li",[s._v("对相互耦合较大、相互独立的 JS/Git 库进行管理；")]),s._v(" "),n("li",[s._v("统一的工作流和 Code Sharing（代码共享）。")])]),s._v(" "),n("p",[s._v("下面我们从以下几个方面来熟悉 Lerna：")]),s._v(" "),n("ul",[n("li",[s._v("Lerna 管理模式；")]),s._v(" "),n("li",[s._v("Lerna 入门指引；")]),s._v(" "),n("li",[s._v("Lerna 管理命令；")]),s._v(" "),n("li",[s._v("Lerna 配置文件；")]),s._v(" "),n("li",[s._v("Lerna 应用 Demo；")]),s._v(" "),n("li",[s._v("Lerna 版本发布；")]),s._v(" "),n("li",[s._v("Lerna 最佳实践；")]),s._v(" "),n("li",[s._v("Lerna 注意事项。")])]),s._v(" "),n("h3",{attrs:{id:"lerna-管理模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lerna-管理模式"}},[s._v("#")]),s._v(" Lerna 管理模式")]),s._v(" "),n("p",[s._v("lerna 管理项目可以使用两种模式，默认固定模式，当使用 "),n("code",[s._v("lerna init -i")]),s._v(" 命令初始化项目时，此时为独立模式。（模式是用来管理多个 package 发包时的方式）")]),s._v(" "),n("ol",[n("li",[s._v("固定模式：\n在发包时会检测 packages 下涉及到变更的包，给这些变更的包使用同一版本，未发生变更的包不应用改版本，且不做发布升级；发布时可通过 lerna publish major（大） | minor（中） | patch （小）自定义版本。")]),s._v(" "),n("li",[s._v("独立模式（常用的模式）：\n允许每个包有自己独立的版本号，在 lerna publish 发布时，需要为每个改动的库指定版本号（逐个询问需要升级的版本号）。此模式，lerna.json - version 字段指定为 independent。")])]),s._v(" "),n("blockquote",[n("p",[s._v("如果 packages 下，其中一个包发生改动，另一个包依赖了这个包，即使它没有发生改动，也会被进行发布更新。")])]),s._v(" "),n("h3",{attrs:{id:"lerna-入门指引"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lerna-入门指引"}},[s._v("#")]),s._v(" Lerna 入门指引")]),s._v(" "),n("ol",[n("li",[s._v("全局安装 Lerna："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" --global lerna\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[s._v("初始化 git 代码仓库："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" init lerna-repo "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" lerna-repo\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[s._v("初始化 Lerna："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna init\n// lerna info Creating package.json\n// lerna info Creating lerna.json\n// lerna info Creating packages directory\n// lerna success Initialized Lerna files\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])])]),s._v(" "),n("li",[s._v("此时得到了这样一个仓库目录结构："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna-repo/\n    packages/\n    package.json\n    lerna.json\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),s._v("其中 "),n("code",[s._v("packages")]),s._v(" 中保存着每个独立的包模块。")]),s._v(" "),n("li",[s._v("安装 lerna 到仓库 node_modules 中："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])]),s._v(" "),n("p",[s._v("至此，我们就完成了一个 Lerna 工程的初始化工作，下面我们掌握一些操作命令来管理 Lerna。")]),s._v(" "),n("h3",{attrs:{id:"lerna-管理命令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lerna-管理命令"}},[s._v("#")]),s._v(" Lerna 管理命令")]),s._v(" "),n("ol",[n("li",[n("p",[n("code",[s._v("lerna init")]),s._v("\n将一个仓库初始化为 lerna 仓库（默认固定模式）。支持参数：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("--independent/-i – 使用独立的版本控制模式\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("lerna create 「package」")]),s._v("\n创建一个 package 到项目工程的 packages 下。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("lerna add 「module」")])]),s._v(" "),n("ul",[n("li",[s._v("为每个 package 都安装指定依赖："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" react\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[s._v("为指定的 package 安装特定依赖："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" react-dom packages/package1\n// or\nlerna "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" react-dom --scope"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("package1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])])]),s._v(" "),n("li",[s._v("添加依赖到根目录 node_modules 中："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" typescript -D\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[s._v("package 之间的相互依赖（会在 package/package.json 下添加该依赖）："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" package2 --scope package1\n// or\nlerna "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" package2 packages/package1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])])])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("lerna publish")]),s._v("\n用于 npm 包版本发布，具体细节可看下文 「Lerna 版本发布」。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("lerna bootstrap")]),s._v("\n用于将 packages 链接在一起(前提是相互依赖的库)，并安装 package 下的依赖到 package/node_modules。")]),s._v(" "),n("blockquote",[n("p",[s._v("注意，它不会安装根目录 package.json 的依赖，如果需要安装根目录依赖，请使用 npm install。")])]),s._v(" "),n("p",[s._v("参数："),n("code",[s._v("--hoist")]),s._v("：依赖提升，把每个 package 下的依赖包都 "),n("code",[s._v("提升")]),s._v(" 到工程根目录（删除包下的 node_modules，将依赖安装在根目录，但依赖注册不会在 package/package.json 内删除，也不会在 root/package.json 内添加此依赖）")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("lerna clean")]),s._v("\n删除各个包下的 node_modules（不会删除根目录 node_modules）。")])]),s._v(" "),n("li",[n("p",[s._v("lerna ls\n列出当前 Lerna 仓库中的所有公共软件包（public packages）。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("lerna run 「script」")])]),s._v(" "),n("ul",[n("li",[s._v("运行每个包下面的 script（如果某个包没有此 script，将会报错）"),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna run "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[s._v("运行某个包下面的 script"),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna run "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" --scope package1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("lerna exec 「shell」")]),s._v("\n允许去执行 shell 脚本")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" webpack\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("lerna changed")]),s._v("\n检查自上次发布以来哪些软件包被修改过。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("lerna link")]),s._v("\n链接互相引用的库，当 pakcage/package.json 内明确了 packages 下的包时，才会将相关包链接到 package/node_modules 中。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("lerna info")]),s._v("\n查看 lerna 及运行环境的信息。")])])]),s._v(" "),n("h3",{attrs:{id:"lerna-配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lerna-配置文件"}},[s._v("#")]),s._v(" Lerna 配置文件")]),s._v(" "),n("p",[s._v("在 lerna.json 配置文件内可以指定工作模式、packages 的位置以及一些命令的默认参数定义，如下示例：")]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"version"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1.0.0"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"npmClient"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yarn"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"useWorkspaces"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"packages"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/*"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"command"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"bootstrap"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"npmClientArgs"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--no-package-lock"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"version"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"publish"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"npmClient"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"npm"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"ignoreChanges"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"**/*.md"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"**/test/**"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"message"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chore(release): publish"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"registry"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://registry.npmjs.org"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"conventionalCommits"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("version")]),s._v(": 当前仓库的版本，Independent mode 请设置为 independent；")]),s._v(" "),n("li",[n("code",[s._v("packages")]),s._v(": 指定包所在的目录，支持指定多个目录；")]),s._v(" "),n("li",[n("code",[s._v("npmClient")]),s._v(": 允许指定命令使用的 client， 默认是 npm， 可以设置成 yarn；")]),s._v(" "),n("li",[n("code",[s._v("useWorkspaces")]),s._v(": 使用 yarn workspaces 管理 Monorepo；")]),s._v(" "),n("li",[n("code",[s._v("command.bootstrap.npmClientArgs")]),s._v(": 指定默认传给 lerna bootstrap 命令的参数；")]),s._v(" "),n("li",[n("code",[s._v("command.publish.ignoreChanges")]),s._v(": 指定那些目录或者文件的变更不用触发 package 版本的变更；")]),s._v(" "),n("li",[n("code",[s._v("command.publish.message")]),s._v(": 执行发布版本更新时的生成的 commit message；")]),s._v(" "),n("li",[n("code",[s._v("command.publish.registry")]),s._v(": 指定发布到的 registry url，比如可以发布到指定私服，默认是 npmjs.org；")]),s._v(" "),n("li",[n("code",[s._v("command.publish.conventionalCommits")]),s._v(": lerna version 将生成 CHANGELOG.md files（如果设置了这个，lerna 管理模式将直接使用固定模式，version = independent 的配置将失效）。")])]),s._v(" "),n("h3",{attrs:{id:"lerna-应用-demo"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lerna-应用-demo"}},[s._v("#")]),s._v(" Lerna 应用 Demo")]),s._v(" "),n("p",[s._v("有了上面的基础使用的了解，下面我们通过一个简单 Demo 熟悉一下 Lerna 管理 Packages 的流程方式。")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("创建 Lerna 工程：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" init lerna-demo "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" lerna-demo "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" lerna init\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("创建两个 package：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna create lerna-module1\nlerna create lerna-module2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("在 package 中维护几行测试代码：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// lerna-module1/lib/lerna-module1.js")]),s._v("\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" lernaModule1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("lernaModule1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'lerna-module1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// lerna-module2/lib/lerna-module2.js")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" lernaModule1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'lerna-module1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" lernaModule2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("lernaModule2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'lerna-module2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("lernaModule1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("lernaModule2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("在 lerna-module2 下添加一个执行脚本：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// lerna-module2/package.json")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"scripts"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node ./lib/lerna-module2.js"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("运行脚本：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna run "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" --scope lerna-module2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("此时会看到终端报错信息：")]),s._v(" "),n("blockquote",[n("p",[s._v("Error: Cannot find module 'lerna-module1'")])])]),s._v(" "),n("li",[n("p",[s._v("手动建立 package 之间的关联：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" lerna-module1 --scope lerna-module2\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lerna info Adding lerna-module1 in 1 package")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("blockquote",[n("p",[s._v("此时可以在 lerna-module2 目录下看到生成了 node_modules 文件夹，并且在里面放置了和 lerna-module1 一模一样的包（软链接）。")])])]),s._v(" "),n("li",[n("p",[s._v("再来执行一次命令：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna run "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" --scope lerna-module2\n终端输出：\nlerna-module1\nlerna-module2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])])]),s._v(" "),n("h3",{attrs:{id:"lerna-版本发布"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lerna-版本发布"}},[s._v("#")]),s._v(" Lerna 版本发布")]),s._v(" "),n("p",[s._v("packages 下的包版本发布需要使用 "),n("code",[s._v("lerna publish")]),s._v("，这个命令组合了这两个命令："),n("code",[s._v("lerna version")]),s._v(" 和 "),n("code",[s._v("npm publish")]),s._v("。"),n("br"),s._v("\n其中 lerna version 针对 Lerna 的管理模式（固定模式和独立模式），在表现上有所不同。"),n("br"),s._v("\n但主要工作还是在进行 "),n("code",[s._v("npm publish")]),s._v(" 之前，去管理哪些包要进行发布，以及发布过程中生成的 Git commit、Git tag 的提交。")]),s._v(" "),n("ol",[n("li",[s._v("固定模式下的 lerna version：\n"),n("ul",[n("li",[s._v("找出从上一个版本发布以来有过"),n("code",[s._v("变更的 package")]),s._v("；")]),s._v(" "),n("li",[s._v("根据当前 lerna.json 中的版本"),n("code",[s._v("生成新的版本号")]),s._v("；")]),s._v(" "),n("li",[s._v("更新涉及到变更 package 下的 package.json 版本号；")]),s._v(" "),n("li",[s._v("更新 lerna.json 文件中的版本号；")]),s._v(" "),n("li",[s._v("将 "),n("code",[s._v("version")]),s._v(" 更新、生成的 "),n("code",[s._v("CHANGELOG.md")]),s._v(" 文件带来的变动提交为一次 commit；")]),s._v(" "),n("li",[s._v("基于这次 commit 为所有涉及到更新的 package 打上各自的 tag；")]),s._v(" "),n("li",[s._v("推送 commit 和 tags 到远程仓库。")])])]),s._v(" "),n("li",[s._v("独立模式下的 lerna version：\n"),n("ul",[n("li",[s._v("找出从上一个版本发布以来有过变更的 package；")]),s._v(" "),n("li",[s._v("提示开发者为需要更新的 package 选择（一组 Version Select）要发布的版本号；")]),s._v(" "),n("li",[s._v("更新到 package 下的 package.json version 版本号；")]),s._v(" "),n("li",[s._v("如果 packages 下其他包有依赖这个包，那么其他包的 package.json 此包版本也会更新；")]),s._v(" "),n("li",[s._v("将 version 更新、生成的 CHANGELOG.md 文件带来的变动提交为一次 commit；")]),s._v(" "),n("li",[s._v("基于这次 commit 为所有涉及到更新的 package 打上各自的 tag；")]),s._v(" "),n("li",[s._v("推送 commit 和 tags 到远程仓库。")])])])]),s._v(" "),n("p",[s._v("这里需要注意一下 lerna 查找包变更的逻辑：")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("lerna 查找包变更的逻辑")]),s._v(" "),n("p",[s._v("在当前分支，找到最近一次 tag，将当前 commit 和 tag 进行比较，看哪些 package 下的文件发生了变更。")])]),s._v(" "),n("p",[s._v("命令使用如下：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna publish\nlerna publish semver\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# semver bump [major | minor | patch | premajor | preminor | prepatch | prerelease]")]),s._v("\nlerna publish from "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("\nlerna publish from-package\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("初次使用发布时可能会遇到以下一些问题和注意事项：")]),s._v(" "),n("ol",[n("li",[s._v("避免开发者自己去打 tag。\nlerna 发布时会自动生成 tag，并且查找更新是基于 tag 来识别的，避免开发者手动打上 tag 后，影响 lerna 查找变更，可能会造成一些变更包没有按照预期发布。")]),s._v(" "),n("li",[s._v("避免多条分支同时进行。\n在多条分支同时进行时，可能会生成相同的版本号，从而发生版本冲突。解决办法：分支开发者之前应提前约定好版本。")]),s._v(" "),n("li",[s._v("lerna publish 中途发布失败，如何进行重发布。\n有时候发布可能会失败（比如 npm 没有登录、没有使用 npmjs 镜像源），再次运行 lerna publish 时，因为 tag 已经打上了，无法再查找到更新，进行包的发布。"),n("br"),s._v("\n可以采用下面两种发布方式：\n"),n("ul",[n("li",[s._v("运行 "),n("code",[s._v("lerna publish from-git")]),s._v("。会将当前标签中涉及的 NPM 包再发布一次。（不会再更新 package.json，只是执行 npm publish）；")]),s._v(" "),n("li",[s._v("运行 "),n("code",[s._v("lerna publish from-package")]),s._v("。会将当前所有本地包中的 package.json 和远端 npm 比对，如果 npm 上不存在此包的最新版本，都执行一次 npm publish。")])])])]),s._v(" "),n("h3",{attrs:{id:"lerna-最佳实践"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lerna-最佳实践"}},[s._v("#")]),s._v(" Lerna 最佳实践")]),s._v(" "),n("p",[s._v("目前业界使用最多的方案是："),n("code",[s._v("lerna + yarm workspace")]),s._v(" 结合的 "),n("code",[s._v("Monorepo")]),s._v(" 方案，两者工作职责划分不同：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("yarn")]),s._v(" 处理依赖安装工作（只想做好包管理工具）；")]),s._v(" "),n("li",[n("code",[s._v("lerna")]),s._v(" 处理发布流程。")])]),s._v(" "),n("h3",{attrs:{id:"leran-注意事项"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#leran-注意事项"}},[s._v("#")]),s._v(" Leran 注意事项")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("发布前，提交工作区的变更。\n在发布前，需要提交工作区的文件变更，否则终端会收到下面报错信息：")]),s._v(" "),n("blockquote",[n("p",[s._v("lerna ERR! EUNCOMMIT Working tree has uncommitted changes, please commit or remove the following changes before continuing:")])])]),s._v(" "),n("li",[n("p",[s._v("发布前，需使用 npmjs.org 镜像。\n在发布前，如果 npm 设置的镜像源为淘宝镜像，需要切换回 npm 镜像：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" config get registry\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" config "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" registry https://registry.npmjs.org\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("如果要发布一个 Scope 包：\nScope 是指具有“组织”的包，比如 Babel 的相关包都是这一格式：@babel/xxx，在发布一个具有 Scope 包时，需要确保 Organization（组织）已在 npm 上创建，私有包需要收费，公共包则为免费。"),n("br"),s._v("\n在发布 Scope package 时，需要在 package.json 声明 access publish：")]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@feu/tools"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"publishConfig"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"access"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"publish"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果该模块需要发布，对于 scope 模块，需要设置为 publish")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("发布意外中断，进行重发布：\n如果发布因为某些原因中断了，未发布成功，再次执行发布，会得到如下提示：")]),s._v(" "),n("blockquote",[n("p",[s._v("lerna success No changed packages to publish")])]),s._v(" "),n("p",[s._v("但由于包并未成功发布到 npmjs 上，这时可以执行以下命令进行重发布：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna publish from-git\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# or")]),s._v("\nlerna publish from-package\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("independent 模式并未生效：\n在 lerna.json 下指定了 version 为 independent，但是发布时却还是固定模式的流程，原因可能是 lerna.json 内配置了 "),n("code",[s._v("conventionalCommits")]),s._v("：")]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"command"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"publish"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"conventionalCommits"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("可以将其配置移除得到解决。")])]),s._v(" "),n("li",[n("p",[s._v("固定模式如何自己指定版本：\n当我们执行 lerna publish 时，lerna 会"),n("code",[s._v("自定分配一个版本")]),s._v("提供我们使用；但这个版本可能不是我们期望发布的版本；如何自己控制发布的版本呢，在发布时我们可以传递配置：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("lerna publish major（大） "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" minor（中） "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" patch （小）\nlerna publish patch "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 发布小版本")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])])]),s._v(" "),n("h2",{attrs:{id:"yarn-workspace"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#yarn-workspace"}},[s._v("#")]),s._v(" yarn workspace")]),s._v(" "),n("p",[s._v("对于 "),n("code",[s._v("Monorepo")]),s._v(" 的工程，使用最多的方式是 "),n("code",[s._v("lerna")]),s._v(" 结合 "),n("code",[s._v("yarn workspace")]),s._v(" 一起使用。"),n("br"),s._v("\n因为 "),n("code",[s._v("yarn")]),s._v(" 在依赖管理上做的非常不错，适合我们业务场景的依赖模块管理。"),n("br"),s._v("\n而 package 的发布工作依旧交由 "),n("code",[s._v("lerna publish")]),s._v(" 来运转。")]),s._v(" "),n("p",[s._v("下面我们从以下几个方面来熟悉 yarn workspace：")]),s._v(" "),n("ul",[n("li",[s._v("yarn workspace 管理工程；")]),s._v(" "),n("li",[s._v("yarn workspace 管理命令；")]),s._v(" "),n("li",[s._v("yarn workspace 入门实战。")])]),s._v(" "),n("h3",{attrs:{id:"yarn-workspace-管理工程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#yarn-workspace-管理工程"}},[s._v("#")]),s._v(" yarn workspace 管理工程")]),s._v(" "),n("p",[s._v("初始化工程的步骤和上面 "),n("code",[s._v("lerna")]),s._v(" 的方式一样，与 lerna 不同的是，需要做以下配置：")]),s._v(" "),n("ol",[n("li",[s._v("在 lerna.json 中声明使用 "),n("code",[s._v("yarn workspace")]),s._v(" 进行依赖管理："),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  ...\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"npmClient"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yarn"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"useWorkspaces"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])])]),s._v(" "),n("li",[s._v("在 "),n("code",[s._v("root/package.json")]),s._v(" 下必需包含 "),n("code",[s._v("workspaces")]),s._v(" 数组，与 "),n("code",[s._v("lerna.json")]),s._v(" 下的 "),n("code",[s._v("packages")]),s._v(" 保持一致："),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"private"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 工作空间不需要发布")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"workspaces"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/*"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])])])]),s._v(" "),n("h3",{attrs:{id:"yarn-workspace-管理命令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#yarn-workspace-管理命令"}},[s._v("#")]),s._v(" yarn workspace 管理命令")]),s._v(" "),n("p",[s._v("yarn 管理命令大致分为两类（容易混淆，这里先提及一下）：")]),s._v(" "),n("ul",[n("li",[s._v("处理工程下指定的包模块时使用："),n("code",[s._v("yarn workspace")]),s._v("；")]),s._v(" "),n("li",[s._v("处理工程根目录全局或所有包模块时使用："),n("code",[s._v("yarn workspaces")]),s._v("。")])]),s._v(" "),n("ol",[n("li",[n("p",[n("code",[s._v("yarn install")]),s._v("\n代替 "),n("code",[s._v("npm install + lerna bootstrap")]),s._v(" 安装工程依赖。")]),s._v(" "),n("p",[s._v("它与 lerna bootstarp 不同的是：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("yarn install")]),s._v(" 会将 "),n("code",[s._v("package")]),s._v(" 下的依赖"),n("code",[s._v("统一安装到根目录之下")]),s._v("。这有利于提升依赖的安装效率和不同 package 间的版本复用（有些包是需要私有依赖的，而私有依赖会被多个包安装多次，而提升依赖可以解决这一问题）。")]),s._v(" "),n("li",[s._v("yarn install 会自动帮助解决安装（包括根目录下的安装）和 packages link 问题。")])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("yarn add 「module」")])]),s._v(" "),n("ul",[n("li",[s._v("为每个 package 都安装指定依赖："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" workspaces "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" react\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[s._v("为指定的 package 安装特定依赖："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" workspace package1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" react react-dom --save\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("blockquote",[n("p",[s._v("注意，package1 一定是 packages/package1/package.json name 字段，有时候 package 的目录名和 name 字段不一致，要以 name 为准。")])])]),s._v(" "),n("li",[s._v("添加依赖到根目录 node_modules 中："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" 根目录\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" @babel/core -D -W （-W 表示将依赖添加到 workspaces 根目录）\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])]),s._v(" "),n("li",[s._v("package 之间的相互依赖（会在 package/package.json 下添加该依赖）："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" workspace package1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" package2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("blockquote",[n("p",[s._v("注意，当 package2 没有发布在 npmjs 上时，此时会报错：package2 not found；解决办法：显示指定 package2 的版本： yarn workspace package1 add package2@^1.0.0")])])]),s._v(" "),n("li",[s._v("在工程根目录下引入 packages/package 包："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" package@^1.0.0 -W\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("yarn remove「module」")]),s._v("\n和上面 yarn add 命令格式相同，只需将 add 替换为 remove 即可。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("yarn run 「script」")])]),s._v(" "),n("ul",[n("li",[s._v("运行工程根目录下 script："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[s._v("运行指定包模块下的 script："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" workspace package1 run "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("blockquote",[n("p",[s._v("值得注意的是，命令虽然是在根目录下执行，但在执行文件中拿到的 "),n("code",[s._v("process.cwd()")]),s._v(" 是 "),n("code",[s._v("package")]),s._v(" 下的执行文件所在路径")])])]),s._v(" "),n("li",[s._v("运行所有 package 下的 script 命令："),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" workspaces run "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("blockquote",[n("p",[s._v("注意，如果某个 package 下没有对应 script，将会终止命令，并报错。若 package 不具备 script，可以定义一个占位 script，类似如下：")])]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"scripts"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"lint"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"echo lint successful."')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])])])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("yarn workspaces info")]),s._v("\n查看 workspace 依赖树信息。")])])]),s._v(" "),n("h3",{attrs:{id:"yarn-workspace-入门实战"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#yarn-workspace-入门实战"}},[s._v("#")]),s._v(" yarn workspace 入门实战")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("新建 yarn workspace 工程：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" init yarn-demo "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" yarn-demo "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" init -y "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" lerna -D "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" lerna init\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("配置 lerna.json 改用 yarn workspaces：")]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// lerna.json")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"npmClient"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yarn"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"useWorkspaces"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"packages"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/*"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"version"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"independent"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("根目录 package.json 必须包含一个 workspaces 数组:")]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"private"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 工作空间不需要发布")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"workspaces"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"packages/*"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  ...\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("新建两个 package：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" packages "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" yarn-module1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" yarn-module1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" init -y\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" packages "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" yarn-module2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" yarn-module2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" init -y\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("添加几行测试代码：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// yarn-module1/index.js")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarnModule1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yarn-module1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" yarnModule1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// yarn-module2/index.js")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" yarnModule1 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yarn-module1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarnModule2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yarn-module2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarnModule1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarnModule2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" yarnModule2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("为 yarn-module2 添加个 script：")]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// yarn-module2/package.json")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"scripts"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"test"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node index.js"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("回到根目录执行 script：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" workspace yarn-module2 run "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("不出意外，会得到如下错误：")]),s._v(" "),n("blockquote",[n("p",[s._v("Error: Cannot find module 'yarn-module1'")])])]),s._v(" "),n("li",[n("p",[s._v("建立 package 之间的关系：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("可以看到，根目录下的 node_modules 中已经存在了 yarn-module1 和 yarn-module2 这两个包，与 lerna 的区别在于没有在各自的 package 下创建 node_modules，而是统一链接到根目录。"),n("br"),s._v("\n但，"),n("code",[s._v("yarn-module2")]),s._v(" 中依赖的 "),n("code",[s._v("yarn-module1")]),s._v("，应该将其添加到 package.json 中，最好的方式是采用")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" workspace yarn-module2 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" yarn-module1@^1.0.0\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("再来一次 script：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v(" workspace yarn-module2 run "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\n\n输出：\nyarn-module1\nyarn-module2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])])])])])}),[],!1,null,null,null);a.default=t.exports}}]);