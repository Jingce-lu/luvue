<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vite 原理剖析 | Ailjc notes</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel=" " href=" ">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/luvue/assets/css/0.styles.0c275c11.css" as="style"><link rel="preload" href="/luvue/assets/js/app.24d3cb9c.js" as="script"><link rel="preload" href="/luvue/assets/js/2.7e9a2be9.js" as="script"><link rel="preload" href="/luvue/assets/js/3.92ecc592.js" as="script"><link rel="preload" href="/luvue/assets/js/34.e0ca9d9d.js" as="script"><link rel="prefetch" href="/luvue/assets/js/10.fefd87d0.js"><link rel="prefetch" href="/luvue/assets/js/100.19a916cd.js"><link rel="prefetch" href="/luvue/assets/js/101.15e09ebc.js"><link rel="prefetch" href="/luvue/assets/js/102.8c2aa751.js"><link rel="prefetch" href="/luvue/assets/js/103.80aaf15e.js"><link rel="prefetch" href="/luvue/assets/js/104.4b17369d.js"><link rel="prefetch" href="/luvue/assets/js/105.e3b99d7f.js"><link rel="prefetch" href="/luvue/assets/js/106.6cb53770.js"><link rel="prefetch" href="/luvue/assets/js/107.0faf8906.js"><link rel="prefetch" href="/luvue/assets/js/108.695346d6.js"><link rel="prefetch" href="/luvue/assets/js/109.438c6b2e.js"><link rel="prefetch" href="/luvue/assets/js/11.141d84f1.js"><link rel="prefetch" href="/luvue/assets/js/110.6ffb0399.js"><link rel="prefetch" href="/luvue/assets/js/111.61fd8319.js"><link rel="prefetch" href="/luvue/assets/js/112.9998d3be.js"><link rel="prefetch" href="/luvue/assets/js/113.89ee7c2f.js"><link rel="prefetch" href="/luvue/assets/js/114.b21dd215.js"><link rel="prefetch" href="/luvue/assets/js/115.e5ecdcf4.js"><link rel="prefetch" href="/luvue/assets/js/116.5ca6e10a.js"><link rel="prefetch" href="/luvue/assets/js/117.44d630a9.js"><link rel="prefetch" href="/luvue/assets/js/118.3a710062.js"><link rel="prefetch" href="/luvue/assets/js/119.00b1d4d9.js"><link rel="prefetch" href="/luvue/assets/js/12.2730a5bc.js"><link rel="prefetch" href="/luvue/assets/js/120.f785e761.js"><link rel="prefetch" href="/luvue/assets/js/121.021c6306.js"><link rel="prefetch" href="/luvue/assets/js/122.e0bf3cfc.js"><link rel="prefetch" href="/luvue/assets/js/123.01466def.js"><link rel="prefetch" href="/luvue/assets/js/124.2dcfea2f.js"><link rel="prefetch" href="/luvue/assets/js/125.41167849.js"><link rel="prefetch" href="/luvue/assets/js/126.5d739372.js"><link rel="prefetch" href="/luvue/assets/js/127.f56f652e.js"><link rel="prefetch" href="/luvue/assets/js/128.40b9b278.js"><link rel="prefetch" href="/luvue/assets/js/129.207137ba.js"><link rel="prefetch" href="/luvue/assets/js/13.60de938c.js"><link rel="prefetch" href="/luvue/assets/js/130.db104c86.js"><link rel="prefetch" href="/luvue/assets/js/131.2c9e9b26.js"><link rel="prefetch" href="/luvue/assets/js/132.d3d980cb.js"><link rel="prefetch" href="/luvue/assets/js/133.aa1a804e.js"><link rel="prefetch" href="/luvue/assets/js/134.231966e7.js"><link rel="prefetch" href="/luvue/assets/js/135.2dbcd9a0.js"><link rel="prefetch" href="/luvue/assets/js/136.919530da.js"><link rel="prefetch" href="/luvue/assets/js/137.c703c0a8.js"><link rel="prefetch" href="/luvue/assets/js/138.d0fbe76a.js"><link rel="prefetch" href="/luvue/assets/js/139.d6ceef15.js"><link rel="prefetch" href="/luvue/assets/js/14.1bd46c2e.js"><link rel="prefetch" href="/luvue/assets/js/140.5ed92165.js"><link rel="prefetch" href="/luvue/assets/js/141.916b71f0.js"><link rel="prefetch" href="/luvue/assets/js/142.27fd2bd5.js"><link rel="prefetch" href="/luvue/assets/js/143.6ada4af5.js"><link rel="prefetch" href="/luvue/assets/js/144.bd6f10eb.js"><link rel="prefetch" href="/luvue/assets/js/145.10c93542.js"><link rel="prefetch" href="/luvue/assets/js/146.038104a3.js"><link rel="prefetch" href="/luvue/assets/js/147.ef6ffd68.js"><link rel="prefetch" href="/luvue/assets/js/148.7d62ecb5.js"><link rel="prefetch" href="/luvue/assets/js/149.ae6c8e49.js"><link rel="prefetch" href="/luvue/assets/js/15.8a053615.js"><link rel="prefetch" href="/luvue/assets/js/150.5350b1a8.js"><link rel="prefetch" href="/luvue/assets/js/151.1f9fee8b.js"><link rel="prefetch" href="/luvue/assets/js/152.e6e676be.js"><link rel="prefetch" href="/luvue/assets/js/153.068ed172.js"><link rel="prefetch" href="/luvue/assets/js/154.3c4d0eb6.js"><link rel="prefetch" href="/luvue/assets/js/155.f99df381.js"><link rel="prefetch" href="/luvue/assets/js/156.537a2efd.js"><link rel="prefetch" href="/luvue/assets/js/157.0acfc338.js"><link rel="prefetch" href="/luvue/assets/js/158.26d3338f.js"><link rel="prefetch" href="/luvue/assets/js/159.6f1cc4e1.js"><link rel="prefetch" href="/luvue/assets/js/16.7f7a3ee8.js"><link rel="prefetch" href="/luvue/assets/js/160.5bd2b3df.js"><link rel="prefetch" href="/luvue/assets/js/161.f50a7be4.js"><link rel="prefetch" href="/luvue/assets/js/162.4846c312.js"><link rel="prefetch" href="/luvue/assets/js/163.3d6f75ae.js"><link rel="prefetch" href="/luvue/assets/js/164.cf7094e1.js"><link rel="prefetch" href="/luvue/assets/js/165.b084c14e.js"><link rel="prefetch" href="/luvue/assets/js/166.d91162ba.js"><link rel="prefetch" href="/luvue/assets/js/167.69358e95.js"><link rel="prefetch" href="/luvue/assets/js/168.0b12410a.js"><link rel="prefetch" href="/luvue/assets/js/169.91d22f58.js"><link rel="prefetch" href="/luvue/assets/js/17.6a766300.js"><link rel="prefetch" href="/luvue/assets/js/170.c3c7e2cd.js"><link rel="prefetch" href="/luvue/assets/js/171.33dd8106.js"><link rel="prefetch" href="/luvue/assets/js/172.af5c5706.js"><link rel="prefetch" href="/luvue/assets/js/173.5d6b421f.js"><link rel="prefetch" href="/luvue/assets/js/174.6c53f57e.js"><link rel="prefetch" href="/luvue/assets/js/175.737dc55c.js"><link rel="prefetch" href="/luvue/assets/js/176.55b0940c.js"><link rel="prefetch" href="/luvue/assets/js/177.c88610d7.js"><link rel="prefetch" href="/luvue/assets/js/178.5858fe0b.js"><link rel="prefetch" href="/luvue/assets/js/179.9125a0ca.js"><link rel="prefetch" href="/luvue/assets/js/18.ceac0c46.js"><link rel="prefetch" href="/luvue/assets/js/180.3e38599d.js"><link rel="prefetch" href="/luvue/assets/js/181.25c2e254.js"><link rel="prefetch" href="/luvue/assets/js/182.80fa8809.js"><link rel="prefetch" href="/luvue/assets/js/183.da1b5a2b.js"><link rel="prefetch" href="/luvue/assets/js/184.acba5e76.js"><link rel="prefetch" href="/luvue/assets/js/185.eaf51d55.js"><link rel="prefetch" href="/luvue/assets/js/186.8de639f8.js"><link rel="prefetch" href="/luvue/assets/js/187.a02bfc44.js"><link rel="prefetch" href="/luvue/assets/js/188.5f5aac79.js"><link rel="prefetch" href="/luvue/assets/js/189.5e8eaa5e.js"><link rel="prefetch" href="/luvue/assets/js/19.82af8a5d.js"><link rel="prefetch" href="/luvue/assets/js/190.6e3dd61d.js"><link rel="prefetch" href="/luvue/assets/js/191.ff42b9b7.js"><link rel="prefetch" href="/luvue/assets/js/192.133d06c7.js"><link rel="prefetch" href="/luvue/assets/js/193.64fba768.js"><link rel="prefetch" href="/luvue/assets/js/194.660335c7.js"><link rel="prefetch" href="/luvue/assets/js/195.9f6cae6d.js"><link rel="prefetch" href="/luvue/assets/js/196.586e8911.js"><link rel="prefetch" href="/luvue/assets/js/197.9c1be23d.js"><link rel="prefetch" href="/luvue/assets/js/198.95b7d4ed.js"><link rel="prefetch" href="/luvue/assets/js/199.3844e818.js"><link rel="prefetch" href="/luvue/assets/js/20.c59106ba.js"><link rel="prefetch" href="/luvue/assets/js/200.ef447f95.js"><link rel="prefetch" href="/luvue/assets/js/201.10481b4c.js"><link rel="prefetch" href="/luvue/assets/js/202.8b3925fe.js"><link rel="prefetch" href="/luvue/assets/js/203.8e740ff3.js"><link rel="prefetch" href="/luvue/assets/js/204.10e0ff19.js"><link rel="prefetch" href="/luvue/assets/js/205.aa8b64c3.js"><link rel="prefetch" href="/luvue/assets/js/206.5cadd5e0.js"><link rel="prefetch" href="/luvue/assets/js/207.1c3fb502.js"><link rel="prefetch" href="/luvue/assets/js/208.37e57586.js"><link rel="prefetch" href="/luvue/assets/js/209.b251f57c.js"><link rel="prefetch" href="/luvue/assets/js/21.dbcb08ca.js"><link rel="prefetch" href="/luvue/assets/js/210.f4c69350.js"><link rel="prefetch" href="/luvue/assets/js/211.a60ef32b.js"><link rel="prefetch" href="/luvue/assets/js/212.5df085a0.js"><link rel="prefetch" href="/luvue/assets/js/213.6cca02ed.js"><link rel="prefetch" href="/luvue/assets/js/214.e437f7ba.js"><link rel="prefetch" href="/luvue/assets/js/215.9731e93e.js"><link rel="prefetch" href="/luvue/assets/js/216.be0f0876.js"><link rel="prefetch" href="/luvue/assets/js/217.36c30f83.js"><link rel="prefetch" href="/luvue/assets/js/218.680c6053.js"><link rel="prefetch" href="/luvue/assets/js/219.d01d0032.js"><link rel="prefetch" href="/luvue/assets/js/22.6382f403.js"><link rel="prefetch" href="/luvue/assets/js/220.5ca1be98.js"><link rel="prefetch" href="/luvue/assets/js/221.a6371702.js"><link rel="prefetch" href="/luvue/assets/js/222.db815fbb.js"><link rel="prefetch" href="/luvue/assets/js/223.db9037a7.js"><link rel="prefetch" href="/luvue/assets/js/224.23cd9e02.js"><link rel="prefetch" href="/luvue/assets/js/225.45220dd3.js"><link rel="prefetch" href="/luvue/assets/js/226.0b9b7a79.js"><link rel="prefetch" href="/luvue/assets/js/227.0eaaaaf4.js"><link rel="prefetch" href="/luvue/assets/js/228.382e9e0e.js"><link rel="prefetch" href="/luvue/assets/js/229.3ae1b558.js"><link rel="prefetch" href="/luvue/assets/js/23.c6b6dae9.js"><link rel="prefetch" href="/luvue/assets/js/230.d4487ee4.js"><link rel="prefetch" href="/luvue/assets/js/231.f2163054.js"><link rel="prefetch" href="/luvue/assets/js/232.df938b18.js"><link rel="prefetch" href="/luvue/assets/js/233.9330e97c.js"><link rel="prefetch" href="/luvue/assets/js/234.cc4ebd06.js"><link rel="prefetch" href="/luvue/assets/js/235.a222b8e0.js"><link rel="prefetch" href="/luvue/assets/js/236.25768542.js"><link rel="prefetch" href="/luvue/assets/js/237.38e66e45.js"><link rel="prefetch" href="/luvue/assets/js/238.55b39563.js"><link rel="prefetch" href="/luvue/assets/js/239.ae76877e.js"><link rel="prefetch" href="/luvue/assets/js/24.d1d8ef7c.js"><link rel="prefetch" href="/luvue/assets/js/240.924c3283.js"><link rel="prefetch" href="/luvue/assets/js/241.bcfcb6f8.js"><link rel="prefetch" href="/luvue/assets/js/242.7221bb51.js"><link rel="prefetch" href="/luvue/assets/js/243.19be8d64.js"><link rel="prefetch" href="/luvue/assets/js/244.b0ab537d.js"><link rel="prefetch" href="/luvue/assets/js/245.c9903538.js"><link rel="prefetch" href="/luvue/assets/js/246.7c7b2b9c.js"><link rel="prefetch" href="/luvue/assets/js/247.773b9f34.js"><link rel="prefetch" href="/luvue/assets/js/248.094da9b6.js"><link rel="prefetch" href="/luvue/assets/js/249.2c6cf0c1.js"><link rel="prefetch" href="/luvue/assets/js/25.541ff376.js"><link rel="prefetch" href="/luvue/assets/js/250.fb1d17fd.js"><link rel="prefetch" href="/luvue/assets/js/251.fcc04c86.js"><link rel="prefetch" href="/luvue/assets/js/252.3a8d2b0b.js"><link rel="prefetch" href="/luvue/assets/js/253.6225bd1a.js"><link rel="prefetch" href="/luvue/assets/js/254.9d4efc27.js"><link rel="prefetch" href="/luvue/assets/js/255.84f219e2.js"><link rel="prefetch" href="/luvue/assets/js/256.dce304d6.js"><link rel="prefetch" href="/luvue/assets/js/257.597148bd.js"><link rel="prefetch" href="/luvue/assets/js/258.86361cde.js"><link rel="prefetch" href="/luvue/assets/js/259.f963bf59.js"><link rel="prefetch" href="/luvue/assets/js/26.aa800826.js"><link rel="prefetch" href="/luvue/assets/js/260.3a2b7c24.js"><link rel="prefetch" href="/luvue/assets/js/261.8b31c343.js"><link rel="prefetch" href="/luvue/assets/js/262.9bc9b4ed.js"><link rel="prefetch" href="/luvue/assets/js/263.cf027585.js"><link rel="prefetch" href="/luvue/assets/js/264.fdd59d42.js"><link rel="prefetch" href="/luvue/assets/js/265.92a6c3e1.js"><link rel="prefetch" href="/luvue/assets/js/266.6dff3d79.js"><link rel="prefetch" href="/luvue/assets/js/267.748610ba.js"><link rel="prefetch" href="/luvue/assets/js/268.7403658e.js"><link rel="prefetch" href="/luvue/assets/js/269.b06f9631.js"><link rel="prefetch" href="/luvue/assets/js/27.234a1646.js"><link rel="prefetch" href="/luvue/assets/js/270.7b4756b5.js"><link rel="prefetch" href="/luvue/assets/js/271.555a52f0.js"><link rel="prefetch" href="/luvue/assets/js/272.d7885b5c.js"><link rel="prefetch" href="/luvue/assets/js/273.f2233d66.js"><link rel="prefetch" href="/luvue/assets/js/274.723b3e19.js"><link rel="prefetch" href="/luvue/assets/js/275.4048adb4.js"><link rel="prefetch" href="/luvue/assets/js/276.2f1e1578.js"><link rel="prefetch" href="/luvue/assets/js/277.cbba2bac.js"><link rel="prefetch" href="/luvue/assets/js/278.53995e86.js"><link rel="prefetch" href="/luvue/assets/js/279.4f6ccf8b.js"><link rel="prefetch" href="/luvue/assets/js/28.f5cb3cd0.js"><link rel="prefetch" href="/luvue/assets/js/280.673b10f1.js"><link rel="prefetch" href="/luvue/assets/js/281.c68eaa9d.js"><link rel="prefetch" href="/luvue/assets/js/282.daf11127.js"><link rel="prefetch" href="/luvue/assets/js/283.f9098504.js"><link rel="prefetch" href="/luvue/assets/js/284.6e81376b.js"><link rel="prefetch" href="/luvue/assets/js/285.0886b889.js"><link rel="prefetch" href="/luvue/assets/js/286.fac16ac5.js"><link rel="prefetch" href="/luvue/assets/js/287.06875def.js"><link rel="prefetch" href="/luvue/assets/js/288.f1c3ab86.js"><link rel="prefetch" href="/luvue/assets/js/289.5fa60820.js"><link rel="prefetch" href="/luvue/assets/js/29.d66372db.js"><link rel="prefetch" href="/luvue/assets/js/290.30e32d07.js"><link rel="prefetch" href="/luvue/assets/js/291.ba2fabdb.js"><link rel="prefetch" href="/luvue/assets/js/292.1e88c8f2.js"><link rel="prefetch" href="/luvue/assets/js/293.46d9f2af.js"><link rel="prefetch" href="/luvue/assets/js/294.9e9e9a97.js"><link rel="prefetch" href="/luvue/assets/js/295.51089eeb.js"><link rel="prefetch" href="/luvue/assets/js/296.e3aa873c.js"><link rel="prefetch" href="/luvue/assets/js/297.80bbdcce.js"><link rel="prefetch" href="/luvue/assets/js/298.5a37e3df.js"><link rel="prefetch" href="/luvue/assets/js/299.6cc42bda.js"><link rel="prefetch" href="/luvue/assets/js/30.dc058ead.js"><link rel="prefetch" href="/luvue/assets/js/300.607335b0.js"><link rel="prefetch" href="/luvue/assets/js/301.395651cb.js"><link rel="prefetch" href="/luvue/assets/js/302.4d29a7f4.js"><link rel="prefetch" href="/luvue/assets/js/31.023e058b.js"><link rel="prefetch" href="/luvue/assets/js/32.c38eba45.js"><link rel="prefetch" href="/luvue/assets/js/33.96ae807e.js"><link rel="prefetch" href="/luvue/assets/js/35.1ef08ee2.js"><link rel="prefetch" href="/luvue/assets/js/36.9f317212.js"><link rel="prefetch" href="/luvue/assets/js/37.4edf1dd8.js"><link rel="prefetch" href="/luvue/assets/js/38.16c29e38.js"><link rel="prefetch" href="/luvue/assets/js/39.2a932be2.js"><link rel="prefetch" href="/luvue/assets/js/4.0b4fc096.js"><link rel="prefetch" href="/luvue/assets/js/40.82cb02c3.js"><link rel="prefetch" href="/luvue/assets/js/41.12394088.js"><link rel="prefetch" href="/luvue/assets/js/42.d2fa2e92.js"><link rel="prefetch" href="/luvue/assets/js/43.1cb4fd05.js"><link rel="prefetch" href="/luvue/assets/js/44.66674ed7.js"><link rel="prefetch" href="/luvue/assets/js/45.eb01a397.js"><link rel="prefetch" href="/luvue/assets/js/46.c87680a3.js"><link rel="prefetch" href="/luvue/assets/js/47.3b88dbdc.js"><link rel="prefetch" href="/luvue/assets/js/48.f9343fda.js"><link rel="prefetch" href="/luvue/assets/js/49.ac55888f.js"><link rel="prefetch" href="/luvue/assets/js/5.768ccd03.js"><link rel="prefetch" href="/luvue/assets/js/50.f7b99ab4.js"><link rel="prefetch" href="/luvue/assets/js/51.adbf4796.js"><link rel="prefetch" href="/luvue/assets/js/52.2f534912.js"><link rel="prefetch" href="/luvue/assets/js/53.cc8c809f.js"><link rel="prefetch" href="/luvue/assets/js/54.386d731a.js"><link rel="prefetch" href="/luvue/assets/js/55.3f6022b7.js"><link rel="prefetch" href="/luvue/assets/js/56.a651fa0f.js"><link rel="prefetch" href="/luvue/assets/js/57.e4dcd280.js"><link rel="prefetch" href="/luvue/assets/js/58.ccf3ec02.js"><link rel="prefetch" href="/luvue/assets/js/59.b9647de8.js"><link rel="prefetch" href="/luvue/assets/js/6.ac3e0798.js"><link rel="prefetch" href="/luvue/assets/js/60.93806c99.js"><link rel="prefetch" href="/luvue/assets/js/61.89498686.js"><link rel="prefetch" href="/luvue/assets/js/62.15faac6d.js"><link rel="prefetch" href="/luvue/assets/js/63.9d855c5d.js"><link rel="prefetch" href="/luvue/assets/js/64.ba1547e2.js"><link rel="prefetch" href="/luvue/assets/js/65.90372937.js"><link rel="prefetch" href="/luvue/assets/js/66.42c645cb.js"><link rel="prefetch" href="/luvue/assets/js/67.fc7bf953.js"><link rel="prefetch" href="/luvue/assets/js/68.b048c6f4.js"><link rel="prefetch" href="/luvue/assets/js/69.cd1ca1b0.js"><link rel="prefetch" href="/luvue/assets/js/7.0c495c55.js"><link rel="prefetch" href="/luvue/assets/js/70.de796229.js"><link rel="prefetch" href="/luvue/assets/js/71.79fbccd7.js"><link rel="prefetch" href="/luvue/assets/js/72.ef920547.js"><link rel="prefetch" href="/luvue/assets/js/73.7aad1269.js"><link rel="prefetch" href="/luvue/assets/js/74.70e82141.js"><link rel="prefetch" href="/luvue/assets/js/75.7c695c09.js"><link rel="prefetch" href="/luvue/assets/js/76.ebb5ed1a.js"><link rel="prefetch" href="/luvue/assets/js/77.1b4696ba.js"><link rel="prefetch" href="/luvue/assets/js/78.17fbd9e8.js"><link rel="prefetch" href="/luvue/assets/js/79.347e97c2.js"><link rel="prefetch" href="/luvue/assets/js/8.3505ba5a.js"><link rel="prefetch" href="/luvue/assets/js/80.a68ac880.js"><link rel="prefetch" href="/luvue/assets/js/81.29697f3f.js"><link rel="prefetch" href="/luvue/assets/js/82.19ca69f9.js"><link rel="prefetch" href="/luvue/assets/js/83.46ead34f.js"><link rel="prefetch" href="/luvue/assets/js/84.e67d55b4.js"><link rel="prefetch" href="/luvue/assets/js/85.9d228e88.js"><link rel="prefetch" href="/luvue/assets/js/86.43b52482.js"><link rel="prefetch" href="/luvue/assets/js/87.a3a73d27.js"><link rel="prefetch" href="/luvue/assets/js/88.f1caa267.js"><link rel="prefetch" href="/luvue/assets/js/89.1e0c098e.js"><link rel="prefetch" href="/luvue/assets/js/9.65549bfc.js"><link rel="prefetch" href="/luvue/assets/js/90.814a1362.js"><link rel="prefetch" href="/luvue/assets/js/91.604291e4.js"><link rel="prefetch" href="/luvue/assets/js/92.f66726d9.js"><link rel="prefetch" href="/luvue/assets/js/93.46431418.js"><link rel="prefetch" href="/luvue/assets/js/94.c9f65d27.js"><link rel="prefetch" href="/luvue/assets/js/95.9217bd28.js"><link rel="prefetch" href="/luvue/assets/js/96.72450da7.js"><link rel="prefetch" href="/luvue/assets/js/97.1e48a1d5.js"><link rel="prefetch" href="/luvue/assets/js/98.b5889720.js"><link rel="prefetch" href="/luvue/assets/js/99.2635376c.js">
    <link rel="stylesheet" href="/luvue/assets/css/0.styles.0c275c11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/luvue/" class="home-link router-link-active"><!----> <span class="site-name">Ailjc notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link router-link-active">工程化</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link router-link-active">工程化</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/Loader/" class="sidebar-heading clickable"><span>Loader</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/Tabable/" class="sidebar-heading clickable"><span>Tabable</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/Vite/" class="sidebar-heading clickable router-link-active open"><span>Vite</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/luvue/engineering/Vite/01-vite原理剖析.html" class="active sidebar-link">01-vite原理剖析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#一-什么是-vite" class="sidebar-link">一.什么是 Vite？</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#二-vite-的实现原理" class="sidebar-link">二.vite 的实现原理</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#三-手把手实现-vite" class="sidebar-link">三.手把手实现 vite</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#_1-安装依赖" class="sidebar-link">1.安装依赖</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#_2-基本结构搭建" class="sidebar-link">2.基本结构搭建</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#_3-静态服务配置" class="sidebar-link">3.静态服务配置</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#_4-重写模块路径" class="sidebar-link">4.重写模块路径</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#_5-解析-modules-文件" class="sidebar-link">5.解析 /@modules 文件</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#_6-处理-process-的问题" class="sidebar-link">6.处理 process 的问题</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#_7-处理-vue后缀文件" class="sidebar-link">7.处理.vue后缀文件</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#_8-热更新-hot-module-reload-原理" class="sidebar-link">8.热更新(Hot Module Reload)原理</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#vite-热更新的实现" class="sidebar-link">Vite 热更新的实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#客户端" class="sidebar-link">客户端</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#服务端" class="sidebar-link">服务端</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/01-vite原理剖析.html#客户端逻辑的注入" class="sidebar-link">客户端逻辑的注入</a></li></ul></li></ul></li><li><a href="/luvue/engineering/Vite/02-100行代码快速实现一个简易版vite.html" class="sidebar-link">02-100行代码快速实现一个简易版vite</a></li><li><a href="/luvue/engineering/Vite/03-快速实现一个简易版vite.html" class="sidebar-link">03-快速实现一个简易版vite</a></li><li><a href="/luvue/engineering/Vite/04-手撸Vite.html" class="sidebar-link">04-手撸Vite</a></li><li><a href="/luvue/engineering/Vite/05-10分钟搞懂Vite-devServer.html" class="sidebar-link">05-10分钟搞懂Vite-devServer</a></li><li><a href="/luvue/engineering/Vite/06-vite-plugin常用的插件.html" class="sidebar-link">06-vite-plugin常用的插件</a></li><li><a href="/luvue/engineering/Vite/07-精通Vite2之插件开发指南.html" class="sidebar-link">07-精通Vite2之插件开发指南</a></li><li><a href="/luvue/engineering/Vite/08-vite2基础插件.html" class="sidebar-link">08-vite2基础插件</a></li><li><a href="/luvue/engineering/Vite/09-vite2进阶插件.html" class="sidebar-link">09-vite2进阶插件</a></li><li><a href="/luvue/engineering/Vite/10-Vite2+React实践.html" class="sidebar-link">10-Vite2+React实践</a></li><li><a href="/luvue/engineering/Vite/11-十分钟了解vite如何支持react.html" class="sidebar-link">11-十分钟了解vite如何支持react</a></li><li><a href="/luvue/engineering/Vite/12-Vite2搞Vue2.html" class="sidebar-link">12-Vite2搞Vue2</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/babel/" class="sidebar-heading clickable"><span>babel</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/other/" class="sidebar-heading clickable"><span>other</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/rollup/" class="sidebar-heading clickable"><span>rollup</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/vue-cli/" class="sidebar-heading clickable"><span>vue-cli</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/webpack/" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/webpack2/" class="sidebar-heading clickable"><span>webpack2</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vite-原理剖析"><a href="#vite-原理剖析" class="header-anchor">#</a> vite 原理剖析</h1> <p></p><div class="table-of-contents"><ul><li><a href="#一-什么是-vite">一.什么是 Vite？</a></li><li><a href="#二-vite-的实现原理">二.vite 的实现原理</a></li><li><a href="#三-手把手实现-vite">三.手把手实现 vite</a><ul><li><a href="#_1-安装依赖">1.安装依赖</a></li><li><a href="#_2-基本结构搭建">2.基本结构搭建</a></li><li><a href="#_3-静态服务配置">3.静态服务配置</a></li><li><a href="#_4-重写模块路径">4.重写模块路径</a></li><li><a href="#_5-解析-modules-文件">5.解析 /@modules 文件</a></li><li><a href="#_6-处理-process-的问题">6.处理 process 的问题</a></li><li><a href="#_7-处理-vue-后缀文件">7.处理.vue后缀文件</a></li><li><a href="#_8-热更新-hot-module-reload-原理">8.热更新(Hot Module Reload)原理</a></li></ul></li><li><a href="#vite-热更新的实现">Vite 热更新的实现</a><ul><li><a href="#客户端">客户端</a></li><li><a href="#服务端">服务端</a></li><li><a href="#客户端逻辑的注入">客户端逻辑的注入</a></li></ul></li></ul></div><p></p> <h2 id="一-什么是-vite"><a href="#一-什么是-vite" class="header-anchor">#</a> 一.什么是 Vite？</h2> <p>法语 Vite（轻量，轻快）<code>vite</code> 是一个基于 <code>Vue3</code> 单文件组件的非打包开发服务器，它做到了本地快速开发启动, 实现按需编译，不再等待整个应用编译完成</p> <blockquote><p>面向现代浏览器，基于原生模块系统 <code>ESModule</code> 实现。<code>webpack</code> 的开发环境很慢（开发时需要进行编译放到内存中）</p></blockquote> <h2 id="二-vite-的实现原理"><a href="#二-vite-的实现原理" class="header-anchor">#</a> 二.vite 的实现原理</h2> <p>我们先来总结下 Vite 的实现原理，<code>vite</code> 在浏览器端使用 <code>export import</code> 的方式导入和导出模块，同时实现了按需加载。vite 高度依赖 module script 特性</p> <p><strong>过程如下</strong>:</p> <ul><li>在 <code>koa</code> 中间件里获取请求 body</li> <li>通过 <a href="https://www.npmjs.com/package/es-module-lexer" target="_blank" rel="noopener noreferrer">es-module-lexer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 解析资源 <code>ast</code> 拿到 <code>import</code> 的内容</li> <li>判断 <code>import</code> 的资源是否是 <code>npm</code> 模块</li> <li>返回处理后的资源路径：<code>&quot;vue&quot; =&gt; &quot;/@modules/vue&quot;</code></li></ul> <p>将处理的 template,script,style 等所需的依赖以 <code>http</code> 请求的形式，通过 query 参数形式区分并加载 <code>SFC</code> 文件各个模块内容。</p> <h2 id="三-手把手实现-vite"><a href="#三-手把手实现-vite" class="header-anchor">#</a> 三.手把手实现 vite</h2> <h3 id="_1-安装依赖"><a href="#_1-安装依赖" class="header-anchor">#</a> 1.安装依赖</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> es-module-lexer koa koa-static magic-string
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><code>koa</code>、<code>koa-static</code> <code>vite</code>内部使用 <code>koa</code> 进行编写</li> <li><code>es-module-lexer</code> 分析 <code>ES6import</code> 语法</li> <li><code>magic-string</code> 实现重写字符串内容</li></ul> <h3 id="_2-基本结构搭建"><a href="#_2-基本结构搭建" class="header-anchor">#</a> 2.基本结构搭建</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 构建上下文对象</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">,</span>
    root<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 扩展ctx属性</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> resolvedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 依次注册所有插件</span>
  resolvedPlugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">plugin</span> <span class="token operator">=&gt;</span> <span class="token function">plugin</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> app<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_3-静态服务配置"><a href="#_3-静态服务配置" class="header-anchor">#</a> 3.静态服务配置</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> serveStaticPlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./serverPluginServeStatic'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolvedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span>serveStaticPlugin<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">serveStaticPlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> app<span class="token punctuation">,</span> root <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 以当前根目录作为静态目录</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 以public目录作为根目录</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>serveStaticPlugin <span class="token operator">=</span> serveStaticPlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>让当前目录下的文件和 public 目录下的文件可以直接被访问</p></blockquote> <h3 id="_4-重写模块路径"><a href="#_4-重写模块路径" class="header-anchor">#</a> 4.重写模块路径</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> moduleRewritePlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./serverPluginModuleRewrite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolvedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span>moduleRewritePlugin<span class="token punctuation">,</span> serveStaticPlugin<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> readBody <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'es-module-lexer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'magic-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">rewriteImports</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> imports <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> magicString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>imports<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imports<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> s<span class="token punctuation">,</span> e <span class="token punctuation">}</span> <span class="token operator">=</span> imports<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> id <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[^\/\.]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        id <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/@modules/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token comment">// 修改路径增加 /@modules 前缀</span>
        magicString<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> magicString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">moduleRewritePlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> app<span class="token punctuation">,</span> root <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对类型是js的文件进行拦截</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 读取文件中的内容</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readBody</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 重写import中无法识别的路径</span>
      <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token function">rewriteImports</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>moduleRewritePlugin <span class="token operator">=</span> moduleRewritePlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><blockquote><p>对 <code>js</code> 文件中的 <code>import</code> 语法进行路径的重写，改写后的路径会再次向服务器拦截请求</p></blockquote> <p><strong>读取文件内容</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Readable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">readBody</span><span class="token punctuation">(</span><span class="token parameter">stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stream <span class="token keyword">instanceof</span> <span class="token class-name">Readable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">chunk</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>res <span class="token operator">+=</span> chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> stream<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>readBody <span class="token operator">=</span> readBody<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_5-解析-modules-文件"><a href="#_5-解析-modules-文件" class="header-anchor">#</a> 5.解析 <code>/@modules</code> 文件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> moduleResolvePlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./serverPluginModuleResolve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolvedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span>moduleRewritePlugin<span class="token punctuation">,</span> moduleResolvePlugin<span class="token punctuation">,</span> serveStaticPlugin<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promises<span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> moduleRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/@modules\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolveVue <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">moduleResolvePlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> app<span class="token punctuation">,</span> root <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> vueResolved <span class="token operator">=</span> <span class="token function">resolveVue</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对 /@modules 开头的路径进行映射</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>moduleRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 去掉 /@modules/路径</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>moduleRE<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'js'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>vueResolved<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> content<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>moduleResolvePlugin <span class="token operator">=</span> moduleResolvePlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><blockquote><p>将/@modules 开头的路径解析成对应的真实文件，返回给浏览器</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">resolveVue</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> compilerPkgPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span> <span class="token string">'@vue/compiler-sfc/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> compilerPkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>compilerPkgPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 编译模块的路径  node中编译</span>
  <span class="token keyword">const</span> compilerPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>compilerPkgPath<span class="token punctuation">)</span><span class="token punctuation">,</span> compilerPkg<span class="token punctuation">.</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">resolvePath</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span>
    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@vue/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.esm-bundler.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// dom运行</span>
  <span class="token keyword">const</span> runtimeDomPath <span class="token operator">=</span> <span class="token function">resolvePath</span><span class="token punctuation">(</span><span class="token string">'runtime-dom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 核心运行</span>
  <span class="token keyword">const</span> runtimeCorePath <span class="token operator">=</span> <span class="token function">resolvePath</span><span class="token punctuation">(</span><span class="token string">'runtime-core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 响应式模块</span>
  <span class="token keyword">const</span> reactivityPath <span class="token operator">=</span> <span class="token function">resolvePath</span><span class="token punctuation">(</span><span class="token string">'reactivity'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 共享模块</span>
  <span class="token keyword">const</span> sharedPath <span class="token operator">=</span> <span class="token function">resolvePath</span><span class="token punctuation">(</span><span class="token string">'shared'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">vue</span><span class="token operator">:</span> runtimeDomPath<span class="token punctuation">,</span>
    <span class="token string-property property">'@vue/runtime-dom'</span><span class="token operator">:</span> runtimeDomPath<span class="token punctuation">,</span>
    <span class="token string-property property">'@vue/runtime-core'</span><span class="token operator">:</span> runtimeCorePath<span class="token punctuation">,</span>
    <span class="token string-property property">'@vue/reactivity'</span><span class="token operator">:</span> reactivityPath<span class="token punctuation">,</span>
    <span class="token string-property property">'@vue/shared'</span><span class="token operator">:</span> sharedPath<span class="token punctuation">,</span>
    <span class="token literal-property property">compiler</span><span class="token operator">:</span> compilerPath<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><blockquote><p>编译的模块使用 <code>commonjs</code> 规范,其他文件均使用 <code>es6</code> 模块</p></blockquote> <h3 id="_6-处理-process-的问题"><a href="#_6-处理-process-的问题" class="header-anchor">#</a> 6.处理 process 的问题</h3> <p>浏览器中并没有 process 变量，所以我们需要在 <code>html</code> 中注入 process 变量</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> htmlRewritePlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./serverPluginHtml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolvedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span>
  htmlRewritePlugin<span class="token punctuation">,</span>
  moduleRewritePlugin<span class="token punctuation">,</span>
  moduleResolvePlugin<span class="token punctuation">,</span>
  serveStaticPlugin<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> readBody <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">htmlRewritePlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> root<span class="token punctuation">,</span> app <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> devInjection <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;script&gt;
        window.process = {env:{NODE_ENV:'development'}}
    &lt;/script&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readBody</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;head&gt;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$&amp;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>devInjection<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>htmlRewritePlugin <span class="token operator">=</span> htmlRewritePlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>在 <code>html</code> 的 <code>head</code> 标签中注入脚本</p></blockquote> <h3 id="_7-处理-vue后缀文件"><a href="#_7-处理-vue后缀文件" class="header-anchor">#</a> 7.处理<code>.vue</code>后缀文件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> vuePlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./serverPluginVue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolvedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span>
  htmlRewritePlugin<span class="token punctuation">,</span>
  moduleRewritePlugin<span class="token punctuation">,</span>
  moduleResolvePlugin<span class="token punctuation">,</span>
  vuePlugin<span class="token punctuation">,</span>
  serveStaticPlugin<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promises<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolveVue <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> defaultExportRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">((?:^|\n|;)\s*)export default</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">vuePlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> app<span class="token punctuation">,</span> root <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// vue文件处理</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取文件内容</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> parse<span class="token punctuation">,</span> compileTemplate <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">resolveVue</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">.</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> descriptor <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析文件内容</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>script<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> content <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>script<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
        <span class="token keyword">let</span> replaced <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>defaultExportRE<span class="token punctuation">,</span> <span class="token string">'$1const __script ='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        code <span class="token operator">+=</span> replaced<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> templateRequest <span class="token operator">=</span> ctx<span class="token punctuation">.</span>path <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?type=template</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        code <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nimport { render as __render } from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>templateRequest<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        code <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n__script.render = __render</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'js'</span><span class="token punctuation">;</span>
      code <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nexport default __script</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">'template'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'js'</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> content <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>template<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">source</span><span class="token operator">:</span> content <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>vuePlugin <span class="token operator">=</span> vuePlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><blockquote><p>在后端将.vue 文件进行解析成如下结果</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'/@modules/vue'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> __script <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">,</span>
      click<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token keyword">as</span> __render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'/src/App.vue?type=template'</span><span class="token punctuation">;</span>
__script<span class="token punctuation">.</span>render <span class="token operator">=</span> __render<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> __script<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  toDisplayString <span class="token keyword">as</span> _toDisplayString<span class="token punctuation">,</span>
  createVNode <span class="token keyword">as</span> _createVNode<span class="token punctuation">,</span>
  Fragment <span class="token keyword">as</span> _Fragment<span class="token punctuation">,</span>
  openBlock <span class="token keyword">as</span> _openBlock<span class="token punctuation">,</span>
  createBlock <span class="token keyword">as</span> _createBlock<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'/@modules/vue'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token function">_openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">_createBlock</span><span class="token punctuation">(</span>
      _Fragment<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token function">_createVNode</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'计数器:'</span> <span class="token operator">+</span> <span class="token function">_toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">/* TEXT */</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">_createVNode</span><span class="token punctuation">(</span>
          <span class="token string">'button'</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">onClick</span><span class="token operator">:</span> _cache<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>_cache<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token parameter">$event</span> <span class="token operator">=&gt;</span> _ctx<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>$event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">'+'</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token number">64</span> <span class="token comment">/* STABLE_FRAGMENT */</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><blockquote><p>解析后的结果可以直接在 <code>createApp</code> 方法中进行使用</p></blockquote> <h3 id="_8-热更新-hot-module-reload-原理"><a href="#_8-热更新-hot-module-reload-原理" class="header-anchor">#</a> 8.热更新(Hot Module Reload)原理</h3> <p>Vite 的热加载原理，其实就是在客户端与服务端建立了一个 websocket 链接，当代码被修改时，服务端发送消息通知客户端去请求修改模块的代码，完成热更新。</p> <p><strong>服务端原理</strong></p> <p>服务端做的就是监听代码文件的改变，在合适的时机向客户端发送 websocket 信息通知客户端去请求新的模块代码。</p> <p><strong>客户端原理</strong></p> <p>Vite 的 websocket 相关代码在 处理 html 中时被写入代码中。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> clientPublicPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/vite/client</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> devInjectionCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n&lt;script type=&quot;module&quot;&gt;import &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>clientPublicPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&lt;/script&gt;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">rewriteHtml</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">importer</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">html</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">injectScriptToHtml</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> devInjectionCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>当 request.path 路径是 <code>/vite/client</code> 时，请求得到对应的客户端代码，因此在客户端中我们创建了一个 websocket 服务并与服务端建立了连接。
Vite 会接受到来自客户端的消息。通过不同的消息触发一些事件。做到浏览器端的即时热模块更换（热更新）。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Listen for messages</span>
socket<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">as</span> HMRPayload <span class="token operator">|</span> MultiUpdatePayload
  <span class="token keyword">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'multi'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    payload<span class="token punctuation">.</span>updates<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>handleMessage<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">handleMessage</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">payload</span><span class="token operator">:</span> HMRPayload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> changeSrcPath<span class="token punctuation">,</span> timestamp <span class="token punctuation">}</span> <span class="token operator">=</span> payload <span class="token keyword">as</span> UpdatePayload
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'connected'</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] connected.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'vue-reload'</span><span class="token operator">:</span>
      <span class="token function">queueUpdate</span><span class="token punctuation">(</span>
        <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">warnFailedFetch</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            __VUE_HMR_RUNTIME__<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> m<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> reloaded.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'vue-rerender'</span><span class="token operator">:</span>
      <span class="token keyword">const</span> templatePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?type=template</span><span class="token template-punctuation string">`</span></span>
      <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>templatePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        __VUE_HMR_RUNTIME__<span class="token punctuation">.</span><span class="token function">rerender</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> m<span class="token punctuation">.</span>render<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> template updated.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'style-update'</span><span class="token operator">:</span>
      <span class="token comment">// check if this is referenced in html via &lt;link&gt;</span>
      <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">link[href*='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">']</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>
          <span class="token string">'href'</span><span class="token punctuation">,</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'&amp;'</span> <span class="token operator">:</span> <span class="token string">'?'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// imported CSS</span>
      <span class="token keyword">const</span> importQuery <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'&amp;import'</span> <span class="token operator">:</span> <span class="token string">'?import'</span>
      <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>importQuery<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> updated.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'style-remove'</span><span class="token operator">:</span>
      <span class="token function">removeStyle</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'js-update'</span><span class="token operator">:</span>
      <span class="token function">queueUpdate</span><span class="token punctuation">(</span><span class="token function">updateModule</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> changeSrcPath<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'custom'</span><span class="token operator">:</span>
      <span class="token keyword">const</span> cbs <span class="token operator">=</span> customUpdateMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cbs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>customData<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'full-reload'</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// if html file is edited, only reload the page if the browser is</span>
        <span class="token comment">// currently on that page.</span>
        <span class="token keyword">const</span> pagePath <span class="token operator">=</span> location<span class="token punctuation">.</span>pathname
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          pagePath <span class="token operator">===</span> path <span class="token operator">||</span>
          <span class="token punctuation">(</span>pagePath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pagePath <span class="token operator">+</span> <span class="token string">'index.html'</span> <span class="token operator">===</span> path<span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><h2 id="vite-热更新的实现"><a href="#vite-热更新的实现" class="header-anchor">#</a> Vite 热更新的实现</h2> <p>我们知道，如果要实现热更新，那么就需要浏览器和服务器建立某种通信机制，这样浏览器才能收到通知进行热更新。Vite 的是通过 <code>WebSocket</code> 来实现的热更新通信。</p> <h3 id="客户端"><a href="#客户端" class="header-anchor">#</a> 客户端</h3> <p>客户端的代码在 <code>src/client/client.ts</code>，主要是创建 <code>WebSocket</code> 客户端，监听来自服务端的 <code>HMR</code> 消息推送。</p> <p>Vite 的 <code>WS</code> 客户端目前监听这几种消息：</p> <ul><li><code>connected</code>: WebSocket 连接成功</li> <li><code>vue-reload</code>: Vue 组件重新加载（当你修改了 script 里的内容时）</li> <li><code>vue-rerender</code>: Vue 组件重新渲染（当你修改了 template 里的内容时）</li> <li><code>style-update</code>: 样式更新</li> <li><code>style-remove</code>: 样式移除</li> <li><code>js-update</code>: js 文件更新</li> <li><code>full-reload</code>: fallback 机制，网页重刷新</li></ul> <p>其中针对 Vue 组件本身的一些更新，都可以直接调用 <code>HMRRuntime</code> 提供的方法，非常方便。其余的更新逻辑，基本上都是利用了 <code>timestamp</code> 刷新缓存重新执行的方法来达到更新的目的。
核心逻辑如下，我感觉非常清晰明了：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> HMRRuntime <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span> <span class="token comment">// 来自 Vue3.0 的 HMRRuntime</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[vite] connecting...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

declare <span class="token keyword">var</span> <span class="token literal-property property">__VUE_HMR_RUNTIME__</span><span class="token operator">:</span> HMRRuntime<span class="token punctuation">;</span>

<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ws://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>location<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Listen for messages</span>
socket<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> path<span class="token punctuation">,</span> id<span class="token punctuation">,</span> index<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> customData <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'connected'</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] connected.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'vue-reload'</span><span class="token operator">:</span>
      <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        __VUE_HMR_RUNTIME__<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> m<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> reloaded.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用 HMRRUNTIME 的方法更新</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'vue-rerender'</span><span class="token operator">:</span>
      <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?type=template&amp;t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        __VUE_HMR_RUNTIME__<span class="token punctuation">.</span><span class="token function">rerender</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> m<span class="token punctuation">.</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> template updated.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用 HMRRUNTIME 的方法更新</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'style-update'</span><span class="token operator">:</span>
      <span class="token function">updateStyle</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?type=style&amp;index=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重新加载 style 的 URL</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> style</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> updated.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'style-remove'</span><span class="token operator">:</span>
      <span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vite-css-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>link<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除 style</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'js-update'</span><span class="token operator">:</span>
      <span class="token keyword">const</span> update <span class="token operator">=</span> jsUpdateMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">update</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用新的时间戳加载并执行 js，达到更新的目的</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite]: js module reloaded: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vite] got js update notification but no client callback was registered. Something is wrong.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'custom'</span><span class="token operator">:</span>
      <span class="token keyword">const</span> cbs <span class="token operator">=</span> customUpdateMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cbs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span>customData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'full-reload'</span><span class="token operator">:</span>
      location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="服务端"><a href="#服务端" class="header-anchor">#</a> 服务端</h3> <p>服务端的实现位于 <code>src/node/serverPluginHmr.ts</code>。核心是监听项目文件的变更，然后根据不同文件类型（目前只有 <code>vue</code> 和 <code>js</code>）来做不同的处理：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 更新时间戳</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleVueReload</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleJSReload</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>对于 <code>Vue</code> 文件的热更新而言，主要是重新编译 Vue 文件，检测 <code>template 、script 、style</code> 的改动，如果有改动就通过 <code>WS</code> 服务端发起对应的热更新请求。</p> <p>简单的源码分析如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleVueReload</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">file</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">timestamp</span><span class="token operator">:</span> number <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> content<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> publicPath <span class="token operator">=</span> resolver<span class="token punctuation">.</span><span class="token function">fileToRequest</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取文件的路径</span>
  <span class="token keyword">const</span> cacheEntry <span class="token operator">=</span> vueCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取缓存里的内容</span>

  <span class="token function">debugHmr</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">busting Vue cache for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  vueCache<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发生变动了因此之前的缓存可以删除</span>

  <span class="token keyword">const</span> descriptor <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parseSFC</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> file<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 编译 Vue 文件</span>

  <span class="token keyword">const</span> prevDescriptor <span class="token operator">=</span> cacheEntry <span class="token operator">&amp;&amp;</span> cacheEntry<span class="token punctuation">.</span>descriptor<span class="token punctuation">;</span> <span class="token comment">// 获取前一次的缓存</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevDescriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这个文件之前从未被访问过（本次是第一次访问），也就没必要热更新</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 设置两个标志位，用于判断是需要 reload 还是 rerender</span>
  <span class="token keyword">let</span> needReload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> needRerender <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果 script 部分不同则需要 reload</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEqual</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>script<span class="token punctuation">,</span> prevDescriptor<span class="token punctuation">.</span>script<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    needReload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果 template 部分不同则需要 rerender</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEqual</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>template<span class="token punctuation">,</span> prevDescriptor<span class="token punctuation">.</span>template<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    needRerender <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> styleId <span class="token operator">=</span> <span class="token function">hash_sum</span><span class="token punctuation">(</span>publicPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取之前的 style 以及下一次（或者说热更新）的 style</span>
  <span class="token keyword">const</span> prevStyles <span class="token operator">=</span> prevDescriptor<span class="token punctuation">.</span>styles <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> nextStyles <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>styles <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果不需要 reload，则查看是否需要更新 style</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needReload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextStyles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevStyles<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isEqual</span><span class="token punctuation">(</span>prevStyles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> nextStyles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'style-update'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">path</span><span class="token operator">:</span> publicPath<span class="token punctuation">,</span>
          <span class="token literal-property property">index</span><span class="token operator">:</span> i<span class="token punctuation">,</span>
          <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>styleId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          timestamp<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果 style 标签及内容删掉了，则需要发送 `style-remove` 的通知</span>
  prevStyles<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>nextStyles<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'style-remove'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> publicPath<span class="token punctuation">,</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>styleId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">+</span> nextStyles<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      timestamp<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果需要 reload 发送 `vue-reload` 通知</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>needReload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'vue-reload'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> publicPath<span class="token punctuation">,</span>
      timestamp<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>needRerender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否则发送 `vue-rerender` 通知</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'vue-rerender'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> publicPath<span class="token punctuation">,</span>
      timestamp<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>对于热更新 <code>js</code> 文件而言，会递归地查找引用这个文件的 <code>importer</code>。比如是某个 <code>Vue</code> 文件所引用了这个 js，就会被查找出来。假如最终发现找不到引用者，则会返回 <code>hasDeadEnd: true</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> vueImporters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 查找并存放需要热更新的 Vue 文件</span>
<span class="token keyword">const</span> jsHotImporters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 查找并存放需要热更新的 js 文件</span>
<span class="token keyword">const</span> hasDeadEnd <span class="token operator">=</span> <span class="token function">walkImportChain</span><span class="token punctuation">(</span>
  publicPath<span class="token punctuation">,</span>
  importers<span class="token punctuation">,</span>
  vueImporters<span class="token punctuation">,</span>
  jsHotImporters
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果 <code>hasDeadEnd</code> 为 <code>true</code>，则直接发送 <code>full-reload</code>。如果 <code>vueImporters</code>或 <code>jsHotImporters</code> 里查找到需要热更新的文件，则发起热更新通知：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>hasDeadEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'full-reload'</span><span class="token punctuation">,</span>
    timestamp<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  vueImporters<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">vueImporter</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'vue-reload'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> vueImporter<span class="token punctuation">,</span>
      timestamp<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  jsHotImporters<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">jsImporter</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'js-update'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> jsImporter<span class="token punctuation">,</span>
      timestamp<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="客户端逻辑的注入"><a href="#客户端逻辑的注入" class="header-anchor">#</a> 客户端逻辑的注入</h3> <p>写到这里，还有一个问题是，我们在自己的代码里并没有引入 <code>HRM</code> 的 <code>client</code> 代码，Vite 是如何把 client 代码注入的呢？</p> <p>回到上面的一张图，Vite 重写 App.vue 文件的内容并返回时：</p> <div align="center"><img src="/luvue/images/vite/vite66.awebp" alt="vite/vite66.awebp"></div> <p>注意这张图里的代码区第一句话 <code>import { updateStyle } from '/@hmr'</code>，并且在左侧请求列表中也有一个对 <code>@hmr</code> 文件的请求。这个请求是啥呢？</p> <div align="center"><img src="/luvue/images/vite/vite67.awebp" alt="vite/vite67.awebp"></div> <p>可以发现，这个请求就是上面说的客户端逻辑的 <code>client.ts</code> 的内容。</p> <p>在 <code>src/node/serverPluginHmr.ts</code> 里，有针对 <code>@hmr</code> 文件的解析处理：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> hmrClientFilePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./client.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> hmrClientId <span class="token operator">=</span> <span class="token string">'@hmr'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> hmrClientPublicPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hmrClientId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path <span class="token operator">!==</span> hmrClientPublicPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求路径如果不是 @hmr 就跳过</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">debugHmr</span><span class="token punctuation">(</span><span class="token string">'serving hmr client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'js'</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">cachedRead</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> hmrClientFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回 client.js 的内容</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/luvue/engineering/Tabable/SyncWaterfallHook.js.html" class="prev">SyncWaterfallHook.js</a></span> <span class="next"><a href="/luvue/engineering/Vite/02-100行代码快速实现一个简易版vite.html">02-100行代码快速实现一个简易版vite</a>
      →
    </span></p></div> </main> <span data-v-2ae0ee72></span></div><div class="global-ui"></div></div>
    <script src="/luvue/assets/js/app.24d3cb9c.js" defer></script><script src="/luvue/assets/js/2.7e9a2be9.js" defer></script><script src="/luvue/assets/js/3.92ecc592.js" defer></script><script src="/luvue/assets/js/34.e0ca9d9d.js" defer></script>
  </body>
</html>
