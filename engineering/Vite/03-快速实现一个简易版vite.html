<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>快速实现一个简易版 vite | Ailjc notes</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel=" " href=" ">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/luvue/assets/css/0.styles.0c275c11.css" as="style"><link rel="preload" href="/luvue/assets/js/app.50227b6d.js" as="script"><link rel="preload" href="/luvue/assets/js/2.dc297d8e.js" as="script"><link rel="preload" href="/luvue/assets/js/3.51a2d233.js" as="script"><link rel="preload" href="/luvue/assets/js/36.911edf94.js" as="script"><link rel="prefetch" href="/luvue/assets/js/10.4dcff8ef.js"><link rel="prefetch" href="/luvue/assets/js/100.4a463fa3.js"><link rel="prefetch" href="/luvue/assets/js/101.16c4fcf8.js"><link rel="prefetch" href="/luvue/assets/js/102.5b1d6c4c.js"><link rel="prefetch" href="/luvue/assets/js/103.14584991.js"><link rel="prefetch" href="/luvue/assets/js/104.116f4d80.js"><link rel="prefetch" href="/luvue/assets/js/105.81576762.js"><link rel="prefetch" href="/luvue/assets/js/106.5757f0a1.js"><link rel="prefetch" href="/luvue/assets/js/107.011fc1df.js"><link rel="prefetch" href="/luvue/assets/js/108.502e4c8c.js"><link rel="prefetch" href="/luvue/assets/js/109.904aca6f.js"><link rel="prefetch" href="/luvue/assets/js/11.e6154571.js"><link rel="prefetch" href="/luvue/assets/js/110.97e25b5c.js"><link rel="prefetch" href="/luvue/assets/js/111.edcade6b.js"><link rel="prefetch" href="/luvue/assets/js/112.75c283fd.js"><link rel="prefetch" href="/luvue/assets/js/113.ac993ad7.js"><link rel="prefetch" href="/luvue/assets/js/114.1dfc2617.js"><link rel="prefetch" href="/luvue/assets/js/115.a55cebf2.js"><link rel="prefetch" href="/luvue/assets/js/116.e3650879.js"><link rel="prefetch" href="/luvue/assets/js/117.c98d9d80.js"><link rel="prefetch" href="/luvue/assets/js/118.2ef2cb19.js"><link rel="prefetch" href="/luvue/assets/js/119.a56e96cb.js"><link rel="prefetch" href="/luvue/assets/js/12.271e8805.js"><link rel="prefetch" href="/luvue/assets/js/120.ea37c8e9.js"><link rel="prefetch" href="/luvue/assets/js/121.e84aa3eb.js"><link rel="prefetch" href="/luvue/assets/js/122.2809183d.js"><link rel="prefetch" href="/luvue/assets/js/123.ef109ed8.js"><link rel="prefetch" href="/luvue/assets/js/124.d7a754ba.js"><link rel="prefetch" href="/luvue/assets/js/125.e368457d.js"><link rel="prefetch" href="/luvue/assets/js/126.2b1e6d99.js"><link rel="prefetch" href="/luvue/assets/js/127.d197f125.js"><link rel="prefetch" href="/luvue/assets/js/128.1a3bba89.js"><link rel="prefetch" href="/luvue/assets/js/129.43fa9b4c.js"><link rel="prefetch" href="/luvue/assets/js/13.f6b3db37.js"><link rel="prefetch" href="/luvue/assets/js/130.ff13b9c1.js"><link rel="prefetch" href="/luvue/assets/js/131.25eb4de5.js"><link rel="prefetch" href="/luvue/assets/js/132.386f97d9.js"><link rel="prefetch" href="/luvue/assets/js/133.defdd861.js"><link rel="prefetch" href="/luvue/assets/js/134.0aba29a4.js"><link rel="prefetch" href="/luvue/assets/js/135.f1cc2592.js"><link rel="prefetch" href="/luvue/assets/js/136.5fea8f28.js"><link rel="prefetch" href="/luvue/assets/js/137.15521ec2.js"><link rel="prefetch" href="/luvue/assets/js/138.2e96476f.js"><link rel="prefetch" href="/luvue/assets/js/139.b3e580c7.js"><link rel="prefetch" href="/luvue/assets/js/14.e2545646.js"><link rel="prefetch" href="/luvue/assets/js/140.7254c946.js"><link rel="prefetch" href="/luvue/assets/js/141.309b75d5.js"><link rel="prefetch" href="/luvue/assets/js/142.e1587e8c.js"><link rel="prefetch" href="/luvue/assets/js/143.c6e04498.js"><link rel="prefetch" href="/luvue/assets/js/144.ccf79776.js"><link rel="prefetch" href="/luvue/assets/js/145.faa65998.js"><link rel="prefetch" href="/luvue/assets/js/146.1b7c11e7.js"><link rel="prefetch" href="/luvue/assets/js/147.f19de9ec.js"><link rel="prefetch" href="/luvue/assets/js/148.aba5552d.js"><link rel="prefetch" href="/luvue/assets/js/149.f1c10580.js"><link rel="prefetch" href="/luvue/assets/js/15.a3a78949.js"><link rel="prefetch" href="/luvue/assets/js/150.8c715a8a.js"><link rel="prefetch" href="/luvue/assets/js/151.1d867a79.js"><link rel="prefetch" href="/luvue/assets/js/152.22ae9445.js"><link rel="prefetch" href="/luvue/assets/js/153.1024de46.js"><link rel="prefetch" href="/luvue/assets/js/154.48bb1114.js"><link rel="prefetch" href="/luvue/assets/js/155.bd946cd8.js"><link rel="prefetch" href="/luvue/assets/js/156.f1d78b05.js"><link rel="prefetch" href="/luvue/assets/js/157.63356c24.js"><link rel="prefetch" href="/luvue/assets/js/158.44bfb42f.js"><link rel="prefetch" href="/luvue/assets/js/159.41731d4e.js"><link rel="prefetch" href="/luvue/assets/js/16.bdbc9ac3.js"><link rel="prefetch" href="/luvue/assets/js/160.fe64fd3e.js"><link rel="prefetch" href="/luvue/assets/js/161.3af3f899.js"><link rel="prefetch" href="/luvue/assets/js/162.a020acea.js"><link rel="prefetch" href="/luvue/assets/js/163.ebfa2fea.js"><link rel="prefetch" href="/luvue/assets/js/164.5c72d951.js"><link rel="prefetch" href="/luvue/assets/js/165.739d51ec.js"><link rel="prefetch" href="/luvue/assets/js/166.54be55b5.js"><link rel="prefetch" href="/luvue/assets/js/167.6f6b0af9.js"><link rel="prefetch" href="/luvue/assets/js/168.059c4bbb.js"><link rel="prefetch" href="/luvue/assets/js/169.9583f311.js"><link rel="prefetch" href="/luvue/assets/js/17.267c53f7.js"><link rel="prefetch" href="/luvue/assets/js/170.f7ab2a56.js"><link rel="prefetch" href="/luvue/assets/js/171.aa5c6d65.js"><link rel="prefetch" href="/luvue/assets/js/172.7b70d120.js"><link rel="prefetch" href="/luvue/assets/js/173.8d733f83.js"><link rel="prefetch" href="/luvue/assets/js/174.41a36264.js"><link rel="prefetch" href="/luvue/assets/js/175.643cec2e.js"><link rel="prefetch" href="/luvue/assets/js/176.17a19152.js"><link rel="prefetch" href="/luvue/assets/js/177.00bffe2d.js"><link rel="prefetch" href="/luvue/assets/js/178.39d6dd1d.js"><link rel="prefetch" href="/luvue/assets/js/179.97c25b6d.js"><link rel="prefetch" href="/luvue/assets/js/18.b4dc00ad.js"><link rel="prefetch" href="/luvue/assets/js/180.f001f92c.js"><link rel="prefetch" href="/luvue/assets/js/181.b4ff3df9.js"><link rel="prefetch" href="/luvue/assets/js/182.21c49e0c.js"><link rel="prefetch" href="/luvue/assets/js/183.a68aedcf.js"><link rel="prefetch" href="/luvue/assets/js/184.1cc2979e.js"><link rel="prefetch" href="/luvue/assets/js/185.820ead5b.js"><link rel="prefetch" href="/luvue/assets/js/186.2ad000ef.js"><link rel="prefetch" href="/luvue/assets/js/187.fa9b511d.js"><link rel="prefetch" href="/luvue/assets/js/188.cfcaabfb.js"><link rel="prefetch" href="/luvue/assets/js/189.c7913649.js"><link rel="prefetch" href="/luvue/assets/js/19.61df46ad.js"><link rel="prefetch" href="/luvue/assets/js/190.a66da869.js"><link rel="prefetch" href="/luvue/assets/js/191.d21b8a3e.js"><link rel="prefetch" href="/luvue/assets/js/192.3a3f0b99.js"><link rel="prefetch" href="/luvue/assets/js/193.6005ffb1.js"><link rel="prefetch" href="/luvue/assets/js/194.9b365175.js"><link rel="prefetch" href="/luvue/assets/js/195.4e4e83f5.js"><link rel="prefetch" href="/luvue/assets/js/196.24df233b.js"><link rel="prefetch" href="/luvue/assets/js/197.42cfce0b.js"><link rel="prefetch" href="/luvue/assets/js/198.3998b360.js"><link rel="prefetch" href="/luvue/assets/js/199.6e1b267e.js"><link rel="prefetch" href="/luvue/assets/js/20.ae4d73d6.js"><link rel="prefetch" href="/luvue/assets/js/200.78a26196.js"><link rel="prefetch" href="/luvue/assets/js/201.e15689f7.js"><link rel="prefetch" href="/luvue/assets/js/202.351e4200.js"><link rel="prefetch" href="/luvue/assets/js/203.6732fa0f.js"><link rel="prefetch" href="/luvue/assets/js/204.bdaedc2f.js"><link rel="prefetch" href="/luvue/assets/js/205.769cfdfa.js"><link rel="prefetch" href="/luvue/assets/js/206.5980160d.js"><link rel="prefetch" href="/luvue/assets/js/207.4f27fd16.js"><link rel="prefetch" href="/luvue/assets/js/208.f715439d.js"><link rel="prefetch" href="/luvue/assets/js/209.26ff4509.js"><link rel="prefetch" href="/luvue/assets/js/21.756c7992.js"><link rel="prefetch" href="/luvue/assets/js/210.7c211a09.js"><link rel="prefetch" href="/luvue/assets/js/211.70a47632.js"><link rel="prefetch" href="/luvue/assets/js/212.fda6d44b.js"><link rel="prefetch" href="/luvue/assets/js/213.ec7d646a.js"><link rel="prefetch" href="/luvue/assets/js/214.3c165f1f.js"><link rel="prefetch" href="/luvue/assets/js/215.79377a1f.js"><link rel="prefetch" href="/luvue/assets/js/216.1300dd6d.js"><link rel="prefetch" href="/luvue/assets/js/217.1ee87399.js"><link rel="prefetch" href="/luvue/assets/js/218.6f58fde9.js"><link rel="prefetch" href="/luvue/assets/js/219.3e5ec5b0.js"><link rel="prefetch" href="/luvue/assets/js/22.68b75c4f.js"><link rel="prefetch" href="/luvue/assets/js/220.bac8627d.js"><link rel="prefetch" href="/luvue/assets/js/221.65afbd17.js"><link rel="prefetch" href="/luvue/assets/js/222.10b495b9.js"><link rel="prefetch" href="/luvue/assets/js/223.9483fde2.js"><link rel="prefetch" href="/luvue/assets/js/224.f0f0b115.js"><link rel="prefetch" href="/luvue/assets/js/225.82f4db59.js"><link rel="prefetch" href="/luvue/assets/js/226.837beb3c.js"><link rel="prefetch" href="/luvue/assets/js/227.88dfd603.js"><link rel="prefetch" href="/luvue/assets/js/228.926b67f1.js"><link rel="prefetch" href="/luvue/assets/js/229.d5432625.js"><link rel="prefetch" href="/luvue/assets/js/23.f144c5d8.js"><link rel="prefetch" href="/luvue/assets/js/230.af30858c.js"><link rel="prefetch" href="/luvue/assets/js/231.d094a5d4.js"><link rel="prefetch" href="/luvue/assets/js/232.001ef00e.js"><link rel="prefetch" href="/luvue/assets/js/233.63941e40.js"><link rel="prefetch" href="/luvue/assets/js/234.942f27c3.js"><link rel="prefetch" href="/luvue/assets/js/235.304392bc.js"><link rel="prefetch" href="/luvue/assets/js/236.d9a2338f.js"><link rel="prefetch" href="/luvue/assets/js/237.3e31a7be.js"><link rel="prefetch" href="/luvue/assets/js/238.50a6e0a4.js"><link rel="prefetch" href="/luvue/assets/js/239.67f7ea74.js"><link rel="prefetch" href="/luvue/assets/js/24.050e500e.js"><link rel="prefetch" href="/luvue/assets/js/240.7e126350.js"><link rel="prefetch" href="/luvue/assets/js/241.4b6526f2.js"><link rel="prefetch" href="/luvue/assets/js/242.2c0594df.js"><link rel="prefetch" href="/luvue/assets/js/243.2947ca1f.js"><link rel="prefetch" href="/luvue/assets/js/244.c13ff375.js"><link rel="prefetch" href="/luvue/assets/js/245.f35e7258.js"><link rel="prefetch" href="/luvue/assets/js/246.a4160daf.js"><link rel="prefetch" href="/luvue/assets/js/247.5add7de3.js"><link rel="prefetch" href="/luvue/assets/js/248.285f48bf.js"><link rel="prefetch" href="/luvue/assets/js/249.6bfc19fe.js"><link rel="prefetch" href="/luvue/assets/js/25.7161d756.js"><link rel="prefetch" href="/luvue/assets/js/250.7d9d5a0d.js"><link rel="prefetch" href="/luvue/assets/js/251.ad83fc91.js"><link rel="prefetch" href="/luvue/assets/js/252.79ce4a94.js"><link rel="prefetch" href="/luvue/assets/js/253.6733159c.js"><link rel="prefetch" href="/luvue/assets/js/254.8cbd88de.js"><link rel="prefetch" href="/luvue/assets/js/255.a6ded312.js"><link rel="prefetch" href="/luvue/assets/js/256.4a6348be.js"><link rel="prefetch" href="/luvue/assets/js/257.16709fb2.js"><link rel="prefetch" href="/luvue/assets/js/258.65f7c45d.js"><link rel="prefetch" href="/luvue/assets/js/259.d6bf3339.js"><link rel="prefetch" href="/luvue/assets/js/26.da9ec7cd.js"><link rel="prefetch" href="/luvue/assets/js/260.2e2fc30d.js"><link rel="prefetch" href="/luvue/assets/js/261.8ed2d945.js"><link rel="prefetch" href="/luvue/assets/js/262.02d4d5ca.js"><link rel="prefetch" href="/luvue/assets/js/263.8a02e4d0.js"><link rel="prefetch" href="/luvue/assets/js/264.5fad29a4.js"><link rel="prefetch" href="/luvue/assets/js/265.1cd29535.js"><link rel="prefetch" href="/luvue/assets/js/266.e5a1aad7.js"><link rel="prefetch" href="/luvue/assets/js/267.a51a94be.js"><link rel="prefetch" href="/luvue/assets/js/268.5d9bc388.js"><link rel="prefetch" href="/luvue/assets/js/269.81be7c5e.js"><link rel="prefetch" href="/luvue/assets/js/27.d35fe8d8.js"><link rel="prefetch" href="/luvue/assets/js/270.bf9cf8c5.js"><link rel="prefetch" href="/luvue/assets/js/271.f5f0e39d.js"><link rel="prefetch" href="/luvue/assets/js/272.2c2d8519.js"><link rel="prefetch" href="/luvue/assets/js/273.207adc32.js"><link rel="prefetch" href="/luvue/assets/js/274.4dceda17.js"><link rel="prefetch" href="/luvue/assets/js/275.c1310482.js"><link rel="prefetch" href="/luvue/assets/js/276.4201cd6e.js"><link rel="prefetch" href="/luvue/assets/js/277.88e1d30f.js"><link rel="prefetch" href="/luvue/assets/js/278.5914996c.js"><link rel="prefetch" href="/luvue/assets/js/279.74b37999.js"><link rel="prefetch" href="/luvue/assets/js/28.07d99649.js"><link rel="prefetch" href="/luvue/assets/js/280.c9568110.js"><link rel="prefetch" href="/luvue/assets/js/281.9f65d139.js"><link rel="prefetch" href="/luvue/assets/js/282.1650bd06.js"><link rel="prefetch" href="/luvue/assets/js/283.33bbeb99.js"><link rel="prefetch" href="/luvue/assets/js/284.1abe4631.js"><link rel="prefetch" href="/luvue/assets/js/285.518df1bf.js"><link rel="prefetch" href="/luvue/assets/js/286.af519e66.js"><link rel="prefetch" href="/luvue/assets/js/287.b6460486.js"><link rel="prefetch" href="/luvue/assets/js/288.47db7cc9.js"><link rel="prefetch" href="/luvue/assets/js/289.33cc7dc0.js"><link rel="prefetch" href="/luvue/assets/js/29.7a42aa9c.js"><link rel="prefetch" href="/luvue/assets/js/290.4a4def2b.js"><link rel="prefetch" href="/luvue/assets/js/291.ff1d48f1.js"><link rel="prefetch" href="/luvue/assets/js/292.0e4d6a16.js"><link rel="prefetch" href="/luvue/assets/js/293.4475f8fa.js"><link rel="prefetch" href="/luvue/assets/js/294.19226719.js"><link rel="prefetch" href="/luvue/assets/js/295.09aea195.js"><link rel="prefetch" href="/luvue/assets/js/296.98217b5e.js"><link rel="prefetch" href="/luvue/assets/js/297.b8ff51d6.js"><link rel="prefetch" href="/luvue/assets/js/298.990d4d9f.js"><link rel="prefetch" href="/luvue/assets/js/299.5df2719c.js"><link rel="prefetch" href="/luvue/assets/js/30.f14df500.js"><link rel="prefetch" href="/luvue/assets/js/300.fffd2c27.js"><link rel="prefetch" href="/luvue/assets/js/301.3d6b453a.js"><link rel="prefetch" href="/luvue/assets/js/302.caa4deb9.js"><link rel="prefetch" href="/luvue/assets/js/303.7a1ad789.js"><link rel="prefetch" href="/luvue/assets/js/304.fd6421f9.js"><link rel="prefetch" href="/luvue/assets/js/305.9963fce8.js"><link rel="prefetch" href="/luvue/assets/js/306.20906cc0.js"><link rel="prefetch" href="/luvue/assets/js/307.9b2c7f2f.js"><link rel="prefetch" href="/luvue/assets/js/308.c6636c3c.js"><link rel="prefetch" href="/luvue/assets/js/309.ba0a0e71.js"><link rel="prefetch" href="/luvue/assets/js/31.8b2636da.js"><link rel="prefetch" href="/luvue/assets/js/310.22345224.js"><link rel="prefetch" href="/luvue/assets/js/311.7c423dba.js"><link rel="prefetch" href="/luvue/assets/js/312.1a9b57a9.js"><link rel="prefetch" href="/luvue/assets/js/313.358832dc.js"><link rel="prefetch" href="/luvue/assets/js/314.cc992c63.js"><link rel="prefetch" href="/luvue/assets/js/315.51fdd92e.js"><link rel="prefetch" href="/luvue/assets/js/32.a1812ddd.js"><link rel="prefetch" href="/luvue/assets/js/33.4f4d5e3f.js"><link rel="prefetch" href="/luvue/assets/js/34.d81874f6.js"><link rel="prefetch" href="/luvue/assets/js/35.808cadca.js"><link rel="prefetch" href="/luvue/assets/js/37.4718c1c4.js"><link rel="prefetch" href="/luvue/assets/js/38.a71b26b8.js"><link rel="prefetch" href="/luvue/assets/js/39.1e2c90a1.js"><link rel="prefetch" href="/luvue/assets/js/4.81c04c44.js"><link rel="prefetch" href="/luvue/assets/js/40.c27fa3a1.js"><link rel="prefetch" href="/luvue/assets/js/41.7ef6ece6.js"><link rel="prefetch" href="/luvue/assets/js/42.65a4e5f1.js"><link rel="prefetch" href="/luvue/assets/js/43.fe8f1ca9.js"><link rel="prefetch" href="/luvue/assets/js/44.4cbd0be7.js"><link rel="prefetch" href="/luvue/assets/js/45.7ba58c4e.js"><link rel="prefetch" href="/luvue/assets/js/46.5b26ac52.js"><link rel="prefetch" href="/luvue/assets/js/47.4886ee59.js"><link rel="prefetch" href="/luvue/assets/js/48.6ca30618.js"><link rel="prefetch" href="/luvue/assets/js/49.bf5ae195.js"><link rel="prefetch" href="/luvue/assets/js/5.7c785cd7.js"><link rel="prefetch" href="/luvue/assets/js/50.d2063889.js"><link rel="prefetch" href="/luvue/assets/js/51.40853d68.js"><link rel="prefetch" href="/luvue/assets/js/52.4595cda0.js"><link rel="prefetch" href="/luvue/assets/js/53.f65e7aed.js"><link rel="prefetch" href="/luvue/assets/js/54.e92efc34.js"><link rel="prefetch" href="/luvue/assets/js/55.c19cb715.js"><link rel="prefetch" href="/luvue/assets/js/56.d9b2c912.js"><link rel="prefetch" href="/luvue/assets/js/57.97fdefbb.js"><link rel="prefetch" href="/luvue/assets/js/58.a8454dc8.js"><link rel="prefetch" href="/luvue/assets/js/59.2176e352.js"><link rel="prefetch" href="/luvue/assets/js/6.f13ef292.js"><link rel="prefetch" href="/luvue/assets/js/60.9903c2e8.js"><link rel="prefetch" href="/luvue/assets/js/61.1840a87b.js"><link rel="prefetch" href="/luvue/assets/js/62.f9de293d.js"><link rel="prefetch" href="/luvue/assets/js/63.f0b5bd0c.js"><link rel="prefetch" href="/luvue/assets/js/64.9bfd9747.js"><link rel="prefetch" href="/luvue/assets/js/65.5091d072.js"><link rel="prefetch" href="/luvue/assets/js/66.1110c30b.js"><link rel="prefetch" href="/luvue/assets/js/67.d0123a6f.js"><link rel="prefetch" href="/luvue/assets/js/68.cfb6235b.js"><link rel="prefetch" href="/luvue/assets/js/69.eaef6f8c.js"><link rel="prefetch" href="/luvue/assets/js/7.b9daa433.js"><link rel="prefetch" href="/luvue/assets/js/70.92d45540.js"><link rel="prefetch" href="/luvue/assets/js/71.cea0d0db.js"><link rel="prefetch" href="/luvue/assets/js/72.5f4fd7b1.js"><link rel="prefetch" href="/luvue/assets/js/73.2bd9f09b.js"><link rel="prefetch" href="/luvue/assets/js/74.4f59112e.js"><link rel="prefetch" href="/luvue/assets/js/75.89861829.js"><link rel="prefetch" href="/luvue/assets/js/76.b02997f7.js"><link rel="prefetch" href="/luvue/assets/js/77.4d732275.js"><link rel="prefetch" href="/luvue/assets/js/78.338bc517.js"><link rel="prefetch" href="/luvue/assets/js/79.f4cf76b6.js"><link rel="prefetch" href="/luvue/assets/js/8.ae058ff6.js"><link rel="prefetch" href="/luvue/assets/js/80.598885dc.js"><link rel="prefetch" href="/luvue/assets/js/81.9e624105.js"><link rel="prefetch" href="/luvue/assets/js/82.70b483bb.js"><link rel="prefetch" href="/luvue/assets/js/83.96e15db9.js"><link rel="prefetch" href="/luvue/assets/js/84.1d0a2fca.js"><link rel="prefetch" href="/luvue/assets/js/85.c9523e2f.js"><link rel="prefetch" href="/luvue/assets/js/86.11b4914d.js"><link rel="prefetch" href="/luvue/assets/js/87.9e995a9e.js"><link rel="prefetch" href="/luvue/assets/js/88.768abc2b.js"><link rel="prefetch" href="/luvue/assets/js/89.889b6d0c.js"><link rel="prefetch" href="/luvue/assets/js/9.c7db66f1.js"><link rel="prefetch" href="/luvue/assets/js/90.3d24896e.js"><link rel="prefetch" href="/luvue/assets/js/91.0d861dc9.js"><link rel="prefetch" href="/luvue/assets/js/92.225a6a9c.js"><link rel="prefetch" href="/luvue/assets/js/93.52403ad6.js"><link rel="prefetch" href="/luvue/assets/js/94.603cf2a0.js"><link rel="prefetch" href="/luvue/assets/js/95.c46d3f66.js"><link rel="prefetch" href="/luvue/assets/js/96.fb8ddca9.js"><link rel="prefetch" href="/luvue/assets/js/97.492b0923.js"><link rel="prefetch" href="/luvue/assets/js/98.0a287ebb.js"><link rel="prefetch" href="/luvue/assets/js/99.1786ba72.js">
    <link rel="stylesheet" href="/luvue/assets/css/0.styles.0c275c11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/luvue/" class="home-link router-link-active"><!----> <span class="site-name">Ailjc notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link router-link-active">工程化</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link router-link-active">工程化</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/babel/" class="sidebar-heading clickable"><span>babel</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/cssPrecompiler/" class="sidebar-heading clickable"><span>cssPrecompiler</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/Loader/" class="sidebar-heading clickable"><span>Loader</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/other/" class="sidebar-heading clickable"><span>other</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/rollup/" class="sidebar-heading clickable"><span>rollup</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/Tabable/" class="sidebar-heading clickable"><span>Tabable</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/Vite/" class="sidebar-heading clickable router-link-active open"><span>Vite</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/luvue/engineering/Vite/01-vite原理剖析.html" class="sidebar-link">01-vite原理剖析</a></li><li><a href="/luvue/engineering/Vite/02-100行代码快速实现一个简易版vite.html" class="sidebar-link">02-100行代码快速实现一个简易版vite</a></li><li><a href="/luvue/engineering/Vite/03-快速实现一个简易版vite.html" class="active sidebar-link">03-快速实现一个简易版vite</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/03-快速实现一个简易版vite.html#要解决的问题" class="sidebar-link">要解决的问题</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/03-快速实现一个简易版vite.html#准备工作" class="sidebar-link">准备工作</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/03-快速实现一个简易版vite.html#源码分析" class="sidebar-link">源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/03-快速实现一个简易版vite.html#server-的创建过程" class="sidebar-link">server 的创建过程</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/03-快速实现一个简易版vite.html#依赖预构建" class="sidebar-link">依赖预构建</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/03-快速实现一个简易版vite.html#transformmiddleware" class="sidebar-link">transformMiddleware</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/03-快速实现一个简易版vite.html#小结一下" class="sidebar-link">小结一下</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/03-快速实现一个简易版vite.html#实践一下" class="sidebar-link">实践一下</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/engineering/Vite/03-快速实现一个简易版vite.html#最后的总结" class="sidebar-link">最后的总结</a></li></ul></li><li><a href="/luvue/engineering/Vite/04-手撸Vite.html" class="sidebar-link">04-手撸Vite</a></li><li><a href="/luvue/engineering/Vite/05-10分钟搞懂Vite-devServer.html" class="sidebar-link">05-10分钟搞懂Vite-devServer</a></li><li><a href="/luvue/engineering/Vite/06-vite-plugin常用的插件.html" class="sidebar-link">06-vite-plugin常用的插件</a></li><li><a href="/luvue/engineering/Vite/07-精通Vite2之插件开发指南.html" class="sidebar-link">07-精通Vite2之插件开发指南</a></li><li><a href="/luvue/engineering/Vite/08-vite2基础插件.html" class="sidebar-link">08-vite2基础插件</a></li><li><a href="/luvue/engineering/Vite/09-vite2进阶插件.html" class="sidebar-link">09-vite2进阶插件</a></li><li><a href="/luvue/engineering/Vite/10-Vite2+React实践.html" class="sidebar-link">10-Vite2+React实践</a></li><li><a href="/luvue/engineering/Vite/11-十分钟了解vite如何支持react.html" class="sidebar-link">11-十分钟了解vite如何支持react</a></li><li><a href="/luvue/engineering/Vite/12-Vite2搞Vue2.html" class="sidebar-link">12-Vite2搞Vue2</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/vue-cli/" class="sidebar-heading clickable"><span>vue-cli</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/webpack/" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/webpack2/" class="sidebar-heading clickable"><span>webpack2</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="快速实现一个简易版-vite"><a href="#快速实现一个简易版-vite" class="header-anchor">#</a> 快速实现一个简易版 vite</h1> <p></p><div class="table-of-contents"><ul><li><a href="#要解决的问题">要解决的问题</a></li><li><a href="#准备工作">准备工作</a></li><li><a href="#源码分析">源码分析</a><ul><li><a href="#server-的创建过程">server 的创建过程</a></li><li><a href="#依赖预构建">依赖预构建</a></li><li><a href="#transformmiddleware">transformMiddleware</a></li><li><a href="#小结一下">小结一下</a></li><li><a href="#实践一下">实践一下</a></li></ul></li><li><a href="#最后的总结">最后的总结</a></li></ul></div><p></p> <p>本文最终实现的简易版 vite 可通过 <a href="https://github.com/levelyu/simple-vite" target="_blank" rel="noopener noreferrer">github 地址下载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，代码实现地较为简单（不到 100 行）可运行后再看此文，阅读效果可能更佳~</p> <h2 id="要解决的问题"><a href="#要解决的问题" class="header-anchor">#</a> 要解决的问题</h2> <p>先我们参照官方文档启动一个 vue 模板的 vite-demo 项目</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">yarn</span> create @vitejs/app vite-demo --template vue
<span class="token builtin class-name">cd</span> vite-demo
<span class="token function">yarn</span>
<span class="token function">yarn</span> dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后打开浏览器查看网络请求，我们不难发现 vite 正如官方文档所述利用浏览器支持原生 ES 模块的特性，让浏览器解析了 import 语句并发出网络请求避免了本地编译打包的过程，因此启动速度非常之快。</p> <p>常言道“先知其然,然后知其所以然”,在打开了 vite 模板工程的源文件再对照上述的网络请求后，有的同学可能有以下几个疑问：</p> <div align="center"><img src="/luvue/images/vite/vite10.awebp" alt="vite/vite10.awebp"></div> <ol><li>main.js 返回的内容 其中 impor 语句为什么被改写成了 import { createApp } from '/node_modules/.vite/vue.js？</li> <li>查看本地文件也会发现 node_modules 文件夹下为什么会多出了一个.vit 文件夹？</li></ol> <div align="center"><img src="/luvue/images/vite/vite11.awebp" alt="vite/vite11.awebp"></div> <ol start="3"><li>.vue 文件的请求是怎么处理并返回能正常运行的 js 呢？</li> <li>为什么会多出两个 js 文件请求 /@vite/client 和 /node_modules/vite/dist/client/env.js 以及一个 websocket 连接？</li></ol> <p>对于问题 4，实际上是 vite devServer 的热更新相关的功能，不在本文的研究重点，因此本文的目的就是带着问题 1，2，3，参照源码实现一个没有热更新没有打包功能的极简易的 vite。（注：本文参考的 vite 源码版本号为 2.3.0）</p> <h2 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h2> <p>工欲善其事,必先利其器。既然是从源码分析问题，那就先准备好调试工作。参照<a href="https://www.vitejs.net/guide/" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <p>首先克隆 vite 仓库并创建一个软链接</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">git</span> clone git@github.com:vitejs/vite.git

<span class="token builtin class-name">cd</span> vite <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span>

<span class="token builtin class-name">cd</span> packages/vite <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span> build <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span> <span class="token function">link</span>

<span class="token function">yarn</span> dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>进入之前初始化好的 vite-demo 项目并链接到本地 vite 仓库地址</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> vite-demo
<span class="token function">yarn</span> <span class="token function">link</span> vite
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>从 vite bin 目录下 vite.js 文件不难发现 vite 命令对应的入口文件在 node_modules/vite/dist/node/cli.js</p> <div align="center"><img src="/luvue/images/vite/vite12.awebp" alt="vite/vite12.awebp"></div> <p>因此我们可以在 vite-demo 的 package.json 文件中加入以下脚本命令：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code> <span class="token property">&quot;debug&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node --inspect-brk node_modules/vite/dist/node/cli.js&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>并运行命令 yarn debug 后打开浏览器控制台即可看到 node 的图标，点击后，我们就可以开始进行源码调试的工作了:</p> <div align="center"><img src="/luvue/images/vite/vite13.awebp" alt="vite/vite13.awebp"></div> <h2 id="源码分析"><a href="#源码分析" class="header-anchor">#</a> 源码分析</h2> <blockquote><p>注意：为方便理解，本文对应的源码均为截取后的伪代码</p></blockquote> <h3 id="server-的创建过程"><a href="#server-的创建过程" class="header-anchor">#</a> server 的创建过程</h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/node/cli.ts</span>
cli
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'[root]'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token string">'serve'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> createServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./server'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>不难看出上述入口文件代码是从 src/node/server/index.ts 引入了一个 createServer 方法并调用返回了一个 server 对象，紧接着调用了 server 的 listen 方法。ok,那就让我们看看这个 createServer 方法内部做了哪些事情:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/node/server/index.ts</span>

<span class="token comment">// ....</span>
<span class="token keyword">import</span> connect <span class="token keyword">from</span> <span class="token string">'connect'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> transformMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./middlewares/transform'</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> httpServer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolveHttpServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 实际 server 的配置会读取 vite.config.js 以及各种插件中的配置 本文力求通俗简易就不再详细分析赘述...</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token punctuation">{</span>
    httpServer<span class="token punctuation">,</span>
    <span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">startServer</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">transformMiddleware</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">await</span> <span class="token function">runOptimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> server<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startServer</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> httpServer <span class="token operator">=</span> server<span class="token punctuation">.</span>httpServer<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hostname <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    httpServer<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// src/node/server/http.ts</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">resolveHttpServer</span><span class="token punctuation">(</span>serveroptions<span class="token punctuation">,</span> app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>通过上述伪代码可以发现，vite2 最终是调用了 http.ts 中的 resolveHttpServer 方法，通过 node 原生的 http 模块创建的 server。同时在 createServer 方法内部，使用了 connect 框架作为中间件。</p> <h3 id="依赖预构建"><a href="#依赖预构建" class="header-anchor">#</a> 依赖预构建</h3> <p>细心的同学不难发现在上述 createServer 方法的伪代码中有个 runOptimize 方法，下面让我们看看这个函数里具体做了哪些事情：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/node/server/index.ts</span>

<span class="token keyword">const</span> <span class="token function-variable function">runOptimize</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>cacheDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    server<span class="token punctuation">.</span>_isRunningOptimizer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      server<span class="token punctuation">.</span>_optimizeDepsMetadata <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">optimizeDeps</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      server<span class="token punctuation">.</span>_isRunningOptimizer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    server<span class="token punctuation">.</span>_registerMissingImport <span class="token operator">=</span> <span class="token function">createMissingImporterRegisterFn</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>实际该方法最重要的是调用了依赖预构建的核心方法：<code>optimizeDeps</code>， 其定义在 src/node/optimizer/index.ts 中，并且在 server 启动前就已调用。</p> <p>那么何为<code>依赖预构建</code>呢，vite 不是 No Bundle 吗？对此，官方文档做出了详细解释：<a href="https://www.vitejs.net/guide/dep-pre-bundling.html" target="_blank" rel="noopener noreferrer">点此查看原因<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，简而言之其目的有二：</p> <ol><li>兼容 CommonJS 和 AMD 模块的依赖</li> <li>减少模块间依赖引用导致过多的请求次数</li></ol> <p>再结合以下伪代码分析：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/node/optimizer/index.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> build <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'esbuild'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> scanImports <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./scan'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">optimizeDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// cacheDir 的定义在 src/node/config.ts</span>
  <span class="token keyword">const</span> cacheDir <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.vite</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token comment">// optimizeDeps  函数依赖预构建的重要函数</span>
  <span class="token keyword">const</span> dataPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">,</span> <span class="token string">'_metadata.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emptyDir</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建 cacheDir 目录</span>
    fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">(</span><span class="token punctuation">{</span> deps<span class="token punctuation">,</span> missing <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">scanImports</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// eg: deps = {vue: &quot;C:/code/sourcecode/vite-demo/node_modules/vue/dist/vue.runtime.esm-bundler.js&quot;}</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    entryPoints<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>flatIdDeps<span class="token punctuation">)</span><span class="token punctuation">,</span>
    outdir<span class="token operator">:</span> cacheDir<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">writeFile</span><span class="token punctuation">(</span>dataPath<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>至此，我们基本可以得到开篇问题 2（为什么 node_modules 下多出了一个.vite 文件夹）的答案了。那么，可能又有同学有以下两个疑问：</p> <ol><li>vite 是如何分析找到哪些模块是需要预构建的呢？</li> <li>vite 是如何完成预构建的同时保证构建速度的呢？</li></ol> <p>带着这两个问题，继续一路 debug 下去，不难发现答案就是 esbuild，关于 esbuild 是什么这里就不再赘述了，这里就贴一张官方文档的对比图感受下，总之就是一个字：快！！！</p> <div align="center"><img src="/luvue/images/vite/vite14.awebp" alt="vite/vite14.awebp"></div> <p>继续回到刚才 src/node/optimizer/index.ts 中的伪代码，实际上 scanImports 函数其实就是完成对 import 语句的扫描，并返回了需要构建的依赖 deps, 下图则说明了这个 deps 其实就是 main.js 中唯一的依赖 vue 对应的路径：</p> <div align="center"><img src="/luvue/images/vite/vite15.awebp" alt="vite/vite15.awebp"></div> <p>那么这个 scanImports 是如何找到我们的唯一依赖 vue 呢：进入 scanImports 函数有以下伪代码：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/node/optimizer/scan.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Loader<span class="token punctuation">,</span> Plugin<span class="token punctuation">,</span> build<span class="token punctuation">,</span> transform <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'esbuild'</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">scanImports</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cosnt entry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globEntries</span><span class="token punctuation">(</span><span class="token string">'**/*.html'</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span>
    <span class="token keyword">const</span> plugin <span class="token operator">=</span> <span class="token function">esbuildScanPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        write<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        entryPoints<span class="token operator">:</span> <span class="token punctuation">[</span>entry<span class="token punctuation">]</span><span class="token punctuation">,</span>
        bundle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'esm'</span><span class="token punctuation">,</span>
       <span class="token comment">// ...</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">esbuildScanPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'vite:dep-scan'</span><span class="token punctuation">,</span>
        <span class="token function">setup</span><span class="token punctuation">(</span>build<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span>
                <span class="token punctuation">{</span> filter<span class="token operator">:</span> htmlTypesRE<span class="token punctuation">,</span> namespace<span class="token operator">:</span> <span class="token string">'html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 读取 html 内容  正则匹配到 &lt;script&gt; 内的内容</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                    loader<span class="token operator">:</span> <span class="token string">'js'</span><span class="token punctuation">,</span>
                    content<span class="token operator">:</span> '<span class="token keyword">import</span> <span class="token string">&quot;/src/main.js&quot;</span> <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>&quot;
                <span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
           build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token constant">JS_TYPES_RE</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> id <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// eg: id = 'C:\\code\\sourcecode\\vite-demo\\src\\main.js'</span>

                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                    loader<span class="token operator">:</span> <span class="token string">'js'</span><span class="token punctuation">,</span>
                    content<span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// eg: 读取 main.js 内容 内有 import vue from 'vue'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>filter<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\w@][^:]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> id<span class="token punctuation">,</span> importer <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// eg: id = &quot;vue&quot;</span>
                <span class="token comment">// eg: importer = &quot;C:\\code\\sourcecode\\vite-demo\\src\\main.js&quot;</span>
                <span class="token comment">// 加入依赖</span>
                depImports<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eg: 返回&quot;C:/code/sourcecode/vite-demo/node_modules/vue/dist/vue.runtime.esm-bundler.js&quot;</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                    path： <span class="token string">'C:/code/sourcecode/vite-demo/node_modules/vue/dist/vue.runtime.esm-bundler.js'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>对照代码注释并结合以下流程图</p> <div align="center"><img src="/luvue/images/vite/vite16.awebp" alt="vite/vite16.awebp"></div> <p>至此我们可以得出结论：vite 主要是通过一个内置的 vite:dep-scan esbuild 插件分析依赖项并将其写入一个_metadata.json 文件中，并通过 esbuild 将依赖的模块（如将 vue.runtime.esm-bundler.js）打包至.vite 文件中（产生一个 vue.js 和 vue.js.map 文件），这也就是开篇问题 2（本地多了一个.vite 文件夹）的答案。</p> <h3 id="transformmiddleware"><a href="#transformmiddleware" class="header-anchor">#</a> transformMiddleware</h3> <p>在上节中我们分析了 vite 预构建的过程，最终其将打包后的文件写入在.vite 文件夹内解决了开篇提出的问题 2。那么让我们继续回到开篇提到的问题 1：main.js 中的 import vue from 'vue'是如何改写成 import vue from '/node_modules/.vite/vue.js'的：</p> <p>还记得我们在 src/node/optimizer/index.ts 中的一段代码吗：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">//src/node/optimizer/index.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> transformMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./middlewares/transform'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>transformMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>实际上 transformMiddleware 正是 vite devServer 核心的中间件，简而言之它负责拦截处理各种文件的请求并将其内容转换成浏览器能识别的正确代码，下面让我们看下 transformMiddleware 做了哪些事情：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/node/server/middlewares/transform.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> transformRequest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../transformRequest'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">transformMiddleware</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ....</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isJSRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">send</span><span class="token punctuation">(</span>
      req<span class="token punctuation">,</span>
      res<span class="token punctuation">,</span>
      result<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
      type<span class="token punctuation">,</span>
      result<span class="token punctuation">.</span>etag<span class="token punctuation">,</span>
      <span class="token comment">// allow browser to cache npm deps!</span>
      isDep <span class="token operator">?</span> <span class="token string">'max-age=31536000,immutable'</span> <span class="token operator">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span>
      result<span class="token punctuation">.</span>map
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>可以看得出它对 js 的请求，是通过 vite 中间件的一个核心方法 transformRequest 处理的，并将结果发送至浏览器</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/node/server/transformRequest.ts</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  code <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> transformResult <span class="token operator">=</span> <span class="token keyword">await</span> pluginContainer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  code <span class="token operator">=</span> transformResult<span class="token punctuation">.</span>code<span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>transformRequest 中代码的核心处理是 pluginContainer.transform 方法，而 transform 方法会遍历 vite 内置的所有插件以及用户配置的插件处理转换 code，其中内置的一个核心的插件为 import-analysis</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/node/plugins/importAnalysis.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> parse <span class="token keyword">as</span> parseImports <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'es-module-lexer'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">importAnalysisPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'vite:import-analysis'</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> ssr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> specifier <span class="token operator">=</span> <span class="token function">parseImports</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// specifier = vue</span>
      <span class="token keyword">await</span> <span class="token function">normalizeUrl</span><span class="token punctuation">(</span>specifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token function-variable function">normalizeUrl</span> <span class="token operator">=</span> <span class="token keyword">async</span> specifier <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>specifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// eg: resolved = {id: &quot;C:/code/sourcecode/vite-demo/node_modules/.vite/vue.js?v=82c5917e&quot;}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>对 importAnalysisPlugin 函数内部做的事情可简单归纳如下：</p> <ol><li>使用一个词法分析利器 es-module-lexer 对源代码进行词法分析，并最终能拿到 main.js 中的语句 import vue from 'vue'中的 vue</li> <li>调用 reslove 方法最终其会先后调用 vite 内置的两个 plugin：vite:pre-alias 及 vite:resolve</li> <li>最终在 vite:resolve 内的钩子函数 resolveId 内部调用 tryOptimizedResolve</li> <li>tryOptimizedResolve 最终会通过读取依赖构建阶段的缓存的依赖映射对象，拿到 vue 对应的路径</li></ol> <div align="center"><img src="/luvue/images/vite/vite17.awebp" alt="vite/vite17.awebp"></div> <h3 id="小结一下"><a href="#小结一下" class="header-anchor">#</a> 小结一下</h3> <p>至此我们已经通过源码分析解决了开篇所提到的问题 1 和问题 2，简单地总结下就是：</p> <ol><li>vite 在启动服务器之前通过 esbuild 及内置的 vite:dep-scan esbuild 插件将 main.js 中的依赖 vue 预构建打包至 /node_modules/.vite/下</li> <li>核心中间件 transformMiddleware 拦截 main.js 请求，读取其内容，在 import-analysis 的插件内部通过 es-module-lexer 分析 import 语句读取到依赖 vue,再通过一系列的内置 plugin 最终将 import 语句中的 vue 转换成 vue 对应预构建的真实路径</li></ol> <p>对于问题 3vite 是如何转换.vue 文件的请求，vite 同样是通过 transformMiddleware 拦截.vue 请求并调用外部插件@vitejs/plugin-vue 处理转换的，感兴趣的同学可以查看 plugin-vue 的源码, 本文就不再赘述了而是通过下文的实践章节以代码来解释。</p> <h3 id="实践一下"><a href="#实践一下" class="header-anchor">#</a> 实践一下</h3> <p>ok，在一顿分析之后我们终于来到了 coding 的环节了，废话不多说，我们先创建一个 server</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// simple-vite/vit/index.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> connect <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">createServer</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 依赖预构建</span>
  <span class="token keyword">await</span> <span class="token function">optimizeDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'simple-vite-dev-server start at localhost: 3000!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 用于返回 html 的中间件</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>indexHtmlMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 处理 js 和 vue 请求的中间件</span>
middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>transformMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>接着我们写下依赖预构建的函数 optimizeDeps</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// simple-vite/vit/index.js</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> esbuild <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'esbuild'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 因为我们的 vite 目录和测试的 src 目录在同一层，因此加了个../</span>
<span class="token keyword">const</span> cacheDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'node_modules/.vite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">optimizeDeps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 在分析依赖的时候 这里为简单实现就没按照源码使用 esbuild 插件去分析</span>
  <span class="token comment">// 而是直接简单粗暴的读取了上级 package.json 的 dependencies 字段</span>
  <span class="token keyword">const</span> deps <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 关于 esbuild 的参数可参考官方文档</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> esbuild<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    entryPoints<span class="token operator">:</span> deps<span class="token punctuation">,</span>
    bundle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'esm'</span><span class="token punctuation">,</span>
    logLevel<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
    splitting<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    outdir<span class="token operator">:</span> cacheDir<span class="token punctuation">,</span>
    treeShaking<span class="token operator">:</span> <span class="token string">'ignore-annotations'</span><span class="token punctuation">,</span>
    metafile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    define<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">'process.env.NODE_ENV'</span><span class="token operator">:</span> <span class="token string">'&quot;development&quot;'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> outputs <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>metafile<span class="token punctuation">.</span>outputs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>dep <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">[</span>dep<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'/'</span> <span class="token operator">+</span> outputs<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>output <span class="token operator">=&gt;</span> output<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dep<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> dataPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">,</span> <span class="token string">'_metadata.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>dataPath<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>至此依赖预构建的函数已写完，当我们运行命令后会发现有打包后的依赖包及依赖映射的 json 文件,而且整个过程非常快</p> <div align="center"><img src="/luvue/images/vite/vite18.awebp" alt="vite/vite18.awebp"></div> <p>再然后我们来实现下中间件函数，indexHtmlMiddleware 没什么好说的就是读取返回根目录的 index.html</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// simple-vite/vit/index.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">indexHtmlMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> htmlPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> htmlContent <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>htmlPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>htmlContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>最核心的当属 transformMiddleware 了,首先让我们处理下 js 文件</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// simple-vite/vit/index.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">transformMiddleware</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 因为预构建我们配置生成了 map 文件所以同样要处理下 map 文件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">)</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.map'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> jsPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> code <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>jsPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token comment">// map 文件不需要分析 import 语句</span>
    <span class="token keyword">const</span> transformCode <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.map'</span><span class="token punctuation">)</span> <span class="token operator">?</span> code <span class="token operator">:</span> <span class="token keyword">await</span> <span class="token function">importAnalysis</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>transformCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>transformMiddleware 最关键的就是 importAnalysis 函数了，正如 vite2 源码里一样其正是处理分析源代码中的 import 语句，并将依赖包替换成预构建包的路径</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// simple-vite/vit/index.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> init<span class="token punctuation">,</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'es-module-lexer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'magic-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">importAnalysis</span> <span class="token operator">=</span> <span class="token keyword">async</span> code <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// es-module-lexer 的 init 必须在 parse 前 Resolve</span>
  <span class="token keyword">await</span> init<span class="token punctuation">;</span>
  <span class="token comment">// 通过 es-module-lexer 分析源 code 中所有的 import 语句</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>imports<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果没有 import 语句我们直接返回源 code</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imports <span class="token operator">||</span> <span class="token operator">!</span>imports<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> code<span class="token punctuation">;</span>
  <span class="token comment">// 定义依赖映射的对象</span>
  <span class="token keyword">const</span> metaData <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">,</span> <span class="token string">'_metadata.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// magic-string vite2 源码中使用到的一个工具 主要适用于将源代码中的某些轻微修改或者替换</span>
  <span class="token keyword">let</span> transformCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  imports<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>importer <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// n： 表示模块的名称 如 vue</span>
    <span class="token comment">// s: 模块名称在导入语句中的起始位置</span>
    <span class="token comment">// e: 模块名称在导入语句中的结束位置</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> n<span class="token punctuation">,</span> s<span class="token punctuation">,</span> e <span class="token punctuation">}</span> <span class="token operator">=</span> importer<span class="token punctuation">;</span>
    <span class="token comment">// 得到模块对应预构建后的真实路径  如</span>
    <span class="token keyword">const</span> replacePath <span class="token operator">=</span> metaData<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">||</span> n<span class="token punctuation">;</span>
    <span class="token comment">// 将模块名称替换成真实路径如/node_modules/.vite</span>
    transformCode <span class="token operator">=</span> transformCode<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">,</span> replacePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> transformCode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>至此，对于 js 请求已处理完毕，其中主要用到的两个包 es-module-lexer 和 magic-string 感兴趣的同学可以去对应的 github 地址了解。最后让我们再处理下.vue 文件吧：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// simple-vite/vit/index.js</span>
<span class="token keyword">const</span> compileSFC <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@vue/compiler-sfc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> compileDom <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'@vue/compiler-dom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">transformMiddleware</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vuePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 拿到 vue 文件中的内容</span>
    <span class="token keyword">const</span> vueContent <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>vuePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过@vue/compiler-sfc 将 vue 中的内容解析成 AST</span>
    <span class="token keyword">const</span> vueParseContet <span class="token operator">=</span> compileSFC<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>vueContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 得到 vue 文件中 script 内的 code</span>
    <span class="token keyword">const</span> scriptContent <span class="token operator">=</span> vueParseContet<span class="token punctuation">.</span>descriptor<span class="token punctuation">.</span>script<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token keyword">const</span> replaceScript <span class="token operator">=</span> scriptContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'export default '</span><span class="token punctuation">,</span> <span class="token string">'const __script = '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 得到 vue 文件中 template 内的内容</span>
    <span class="token keyword">const</span> tpl <span class="token operator">=</span> vueParseContet<span class="token punctuation">.</span>descriptor<span class="token punctuation">.</span>template<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token comment">// 通过@vue/compiler-dom 将其解析成 render 函数</span>
    <span class="token keyword">const</span> tplCode <span class="token operator">=</span> compileDom<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>tpl<span class="token punctuation">,</span> <span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span>
    <span class="token keyword">const</span> tplCodeReplace <span class="token operator">=</span> tplCode<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
      <span class="token string">'export function render(_ctx, _cache)'</span><span class="token punctuation">,</span>
      <span class="token string">'__script.render=(_ctx, _cache)=&gt;'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最后不要忘了 script 内的 code 还要再一次进行 import 语句分析替换</span>
    <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> <span class="token function">importAnalysis</span><span class="token punctuation">(</span>replaceScript<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
                </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tplCodeReplace<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
                export default __script;
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/javascript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">importAnalysis</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>关于.vue 文件的处理好像也没什么好说的了，看代码看注释就完事了，想深入了解的同学可查看<a href="https://github.com/vitejs/vite/tree/main/packages/plugin-vue" target="_blank" rel="noopener noreferrer">@vitejs/plugin-vue<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。然后让我们看下此代码实现的最终效果吧：</p> <div align="center"><img src="/luvue/images/vite/vite19.awebp" alt="vite/vite19.awebp"></div> <p>如上图所示，所有请求的文件最终都转换成了浏览器能成功运行的 js 代码。</p> <h2 id="最后的总结"><a href="#最后的总结" class="header-anchor">#</a> 最后的总结</h2> <p>本文的最终目的是参照 vite2 源码实现一个极其简易版的 vite，其主要功能简而言之是以下两点：</p> <ol><li>利用 <code>esbuild</code> 进行预构建工作，其目的是能将我们依赖的浏览器不支持运行的 CJS 和 AMD 模块的代码打包转换为浏览器支持的 ES 模块代码，同时避免了过多的网络请求次数。</li> <li>模拟源码实现一个 <code>transformMiddleware</code>，其目的是能将源代码进行转换浏览器能支持运行的代码，如：分析源代码的 import 语句并其替换为浏览器可执行的 import 语句以及将 vue 文件转换为可执行的 js 代码。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/luvue/engineering/Vite/02-100行代码快速实现一个简易版vite.html" class="prev">02-100行代码快速实现一个简易版vite</a></span> <span class="next"><a href="/luvue/engineering/Vite/04-手撸Vite.html">04-手撸Vite</a>
      →
    </span></p></div> </main> <span data-v-2ae0ee72></span></div><div class="global-ui"></div></div>
    <script src="/luvue/assets/js/app.50227b6d.js" defer></script><script src="/luvue/assets/js/2.dc297d8e.js" defer></script><script src="/luvue/assets/js/3.51a2d233.js" defer></script><script src="/luvue/assets/js/36.911edf94.js" defer></script>
  </body>
</html>
