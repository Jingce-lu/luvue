<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>rollup - 构建原理及简易实现 | Ailjc notes</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel=" " href=" ">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/luvue/assets/css/0.styles.0c275c11.css" as="style"><link rel="preload" href="/luvue/assets/js/app.3055a672.js" as="script"><link rel="preload" href="/luvue/assets/js/2.edd550b3.js" as="script"><link rel="preload" href="/luvue/assets/js/3.29a3f40f.js" as="script"><link rel="preload" href="/luvue/assets/js/35.9ce2b7e0.js" as="script"><link rel="prefetch" href="/luvue/assets/js/10.45961e4a.js"><link rel="prefetch" href="/luvue/assets/js/100.cdaae3a3.js"><link rel="prefetch" href="/luvue/assets/js/101.be077908.js"><link rel="prefetch" href="/luvue/assets/js/102.857f579a.js"><link rel="prefetch" href="/luvue/assets/js/103.ac7164da.js"><link rel="prefetch" href="/luvue/assets/js/104.35dd95b3.js"><link rel="prefetch" href="/luvue/assets/js/105.4c866dbb.js"><link rel="prefetch" href="/luvue/assets/js/106.f6a0fefe.js"><link rel="prefetch" href="/luvue/assets/js/107.23bf9216.js"><link rel="prefetch" href="/luvue/assets/js/108.4f94dc95.js"><link rel="prefetch" href="/luvue/assets/js/109.d6585cd4.js"><link rel="prefetch" href="/luvue/assets/js/11.20012366.js"><link rel="prefetch" href="/luvue/assets/js/110.27af1683.js"><link rel="prefetch" href="/luvue/assets/js/111.42014fe0.js"><link rel="prefetch" href="/luvue/assets/js/112.4c450064.js"><link rel="prefetch" href="/luvue/assets/js/113.23a9833e.js"><link rel="prefetch" href="/luvue/assets/js/114.42c6a414.js"><link rel="prefetch" href="/luvue/assets/js/115.58d08b40.js"><link rel="prefetch" href="/luvue/assets/js/116.31367804.js"><link rel="prefetch" href="/luvue/assets/js/117.d530886d.js"><link rel="prefetch" href="/luvue/assets/js/118.d03fd7ca.js"><link rel="prefetch" href="/luvue/assets/js/119.b4ba1fec.js"><link rel="prefetch" href="/luvue/assets/js/12.3ec53ea8.js"><link rel="prefetch" href="/luvue/assets/js/120.f7cdcf33.js"><link rel="prefetch" href="/luvue/assets/js/121.9edf8d61.js"><link rel="prefetch" href="/luvue/assets/js/122.516425b2.js"><link rel="prefetch" href="/luvue/assets/js/123.85ada9d3.js"><link rel="prefetch" href="/luvue/assets/js/124.55de3407.js"><link rel="prefetch" href="/luvue/assets/js/125.75a8f93d.js"><link rel="prefetch" href="/luvue/assets/js/126.485292bb.js"><link rel="prefetch" href="/luvue/assets/js/127.274beb15.js"><link rel="prefetch" href="/luvue/assets/js/128.5234acb9.js"><link rel="prefetch" href="/luvue/assets/js/129.c7f7fd63.js"><link rel="prefetch" href="/luvue/assets/js/13.4d1c9585.js"><link rel="prefetch" href="/luvue/assets/js/130.1b47d904.js"><link rel="prefetch" href="/luvue/assets/js/131.0b06ac47.js"><link rel="prefetch" href="/luvue/assets/js/132.54414c2d.js"><link rel="prefetch" href="/luvue/assets/js/133.fc024453.js"><link rel="prefetch" href="/luvue/assets/js/134.1ebf2f7b.js"><link rel="prefetch" href="/luvue/assets/js/135.58071e80.js"><link rel="prefetch" href="/luvue/assets/js/136.8d718f9a.js"><link rel="prefetch" href="/luvue/assets/js/137.dc3f0b8c.js"><link rel="prefetch" href="/luvue/assets/js/138.aaa35cdb.js"><link rel="prefetch" href="/luvue/assets/js/139.c01e7a66.js"><link rel="prefetch" href="/luvue/assets/js/14.4368d31f.js"><link rel="prefetch" href="/luvue/assets/js/140.8c150c50.js"><link rel="prefetch" href="/luvue/assets/js/141.4220b633.js"><link rel="prefetch" href="/luvue/assets/js/142.4f344477.js"><link rel="prefetch" href="/luvue/assets/js/143.077c9793.js"><link rel="prefetch" href="/luvue/assets/js/144.dbc84efa.js"><link rel="prefetch" href="/luvue/assets/js/145.c3fae95a.js"><link rel="prefetch" href="/luvue/assets/js/146.c1bf6fef.js"><link rel="prefetch" href="/luvue/assets/js/147.49e20552.js"><link rel="prefetch" href="/luvue/assets/js/148.b0b94a1e.js"><link rel="prefetch" href="/luvue/assets/js/149.db859341.js"><link rel="prefetch" href="/luvue/assets/js/15.425c3d86.js"><link rel="prefetch" href="/luvue/assets/js/150.a6a6ab48.js"><link rel="prefetch" href="/luvue/assets/js/151.ea38a2e0.js"><link rel="prefetch" href="/luvue/assets/js/152.34b60e21.js"><link rel="prefetch" href="/luvue/assets/js/153.926d1496.js"><link rel="prefetch" href="/luvue/assets/js/154.5d7f764e.js"><link rel="prefetch" href="/luvue/assets/js/155.4f05ce74.js"><link rel="prefetch" href="/luvue/assets/js/156.c251b8f8.js"><link rel="prefetch" href="/luvue/assets/js/157.659c36e1.js"><link rel="prefetch" href="/luvue/assets/js/158.86b91fed.js"><link rel="prefetch" href="/luvue/assets/js/159.eeb62dbe.js"><link rel="prefetch" href="/luvue/assets/js/16.6e74756b.js"><link rel="prefetch" href="/luvue/assets/js/160.26c7c228.js"><link rel="prefetch" href="/luvue/assets/js/161.83318b26.js"><link rel="prefetch" href="/luvue/assets/js/162.9811dde2.js"><link rel="prefetch" href="/luvue/assets/js/163.a00c0ecd.js"><link rel="prefetch" href="/luvue/assets/js/164.78675901.js"><link rel="prefetch" href="/luvue/assets/js/165.57c726cd.js"><link rel="prefetch" href="/luvue/assets/js/166.fc622104.js"><link rel="prefetch" href="/luvue/assets/js/167.eb02cd78.js"><link rel="prefetch" href="/luvue/assets/js/168.d80ace33.js"><link rel="prefetch" href="/luvue/assets/js/169.a2fe4ebc.js"><link rel="prefetch" href="/luvue/assets/js/17.d9200946.js"><link rel="prefetch" href="/luvue/assets/js/170.3334fe5b.js"><link rel="prefetch" href="/luvue/assets/js/171.644da1a1.js"><link rel="prefetch" href="/luvue/assets/js/172.66d4dad3.js"><link rel="prefetch" href="/luvue/assets/js/173.fe72f858.js"><link rel="prefetch" href="/luvue/assets/js/174.e2137912.js"><link rel="prefetch" href="/luvue/assets/js/175.edcfc12d.js"><link rel="prefetch" href="/luvue/assets/js/176.54e8b4fc.js"><link rel="prefetch" href="/luvue/assets/js/177.888c1b03.js"><link rel="prefetch" href="/luvue/assets/js/178.2cc4a4f3.js"><link rel="prefetch" href="/luvue/assets/js/179.b8871aad.js"><link rel="prefetch" href="/luvue/assets/js/18.970d299c.js"><link rel="prefetch" href="/luvue/assets/js/180.dde37e1f.js"><link rel="prefetch" href="/luvue/assets/js/181.cadd9de0.js"><link rel="prefetch" href="/luvue/assets/js/182.26a780ff.js"><link rel="prefetch" href="/luvue/assets/js/183.c7633618.js"><link rel="prefetch" href="/luvue/assets/js/184.48d143e7.js"><link rel="prefetch" href="/luvue/assets/js/185.9bb54fb4.js"><link rel="prefetch" href="/luvue/assets/js/186.d8a8c5c6.js"><link rel="prefetch" href="/luvue/assets/js/187.366057c7.js"><link rel="prefetch" href="/luvue/assets/js/188.3119d73d.js"><link rel="prefetch" href="/luvue/assets/js/189.2597ec07.js"><link rel="prefetch" href="/luvue/assets/js/19.5b4f364a.js"><link rel="prefetch" href="/luvue/assets/js/190.d7856a04.js"><link rel="prefetch" href="/luvue/assets/js/191.e362659c.js"><link rel="prefetch" href="/luvue/assets/js/192.da1ed7b2.js"><link rel="prefetch" href="/luvue/assets/js/193.9b055401.js"><link rel="prefetch" href="/luvue/assets/js/194.b848666d.js"><link rel="prefetch" href="/luvue/assets/js/195.14b35ef5.js"><link rel="prefetch" href="/luvue/assets/js/196.db0788b7.js"><link rel="prefetch" href="/luvue/assets/js/197.c46efad6.js"><link rel="prefetch" href="/luvue/assets/js/198.6d2f0ca5.js"><link rel="prefetch" href="/luvue/assets/js/199.8281f9ba.js"><link rel="prefetch" href="/luvue/assets/js/20.04f94469.js"><link rel="prefetch" href="/luvue/assets/js/200.fac0cd43.js"><link rel="prefetch" href="/luvue/assets/js/201.ef78b025.js"><link rel="prefetch" href="/luvue/assets/js/202.70e4aec8.js"><link rel="prefetch" href="/luvue/assets/js/203.b19a9896.js"><link rel="prefetch" href="/luvue/assets/js/204.8621217d.js"><link rel="prefetch" href="/luvue/assets/js/205.75e6ce9f.js"><link rel="prefetch" href="/luvue/assets/js/206.fa0ea666.js"><link rel="prefetch" href="/luvue/assets/js/207.987a2c6c.js"><link rel="prefetch" href="/luvue/assets/js/208.a931f476.js"><link rel="prefetch" href="/luvue/assets/js/209.42f88558.js"><link rel="prefetch" href="/luvue/assets/js/21.4720e285.js"><link rel="prefetch" href="/luvue/assets/js/210.d3bfc368.js"><link rel="prefetch" href="/luvue/assets/js/211.01ea8708.js"><link rel="prefetch" href="/luvue/assets/js/212.dad5480f.js"><link rel="prefetch" href="/luvue/assets/js/213.06e75ae6.js"><link rel="prefetch" href="/luvue/assets/js/214.370540e4.js"><link rel="prefetch" href="/luvue/assets/js/215.5d0374f2.js"><link rel="prefetch" href="/luvue/assets/js/216.eafecd5c.js"><link rel="prefetch" href="/luvue/assets/js/217.b74649d4.js"><link rel="prefetch" href="/luvue/assets/js/218.e74eec9e.js"><link rel="prefetch" href="/luvue/assets/js/219.fe36fd7b.js"><link rel="prefetch" href="/luvue/assets/js/22.a241c1de.js"><link rel="prefetch" href="/luvue/assets/js/220.8a03d869.js"><link rel="prefetch" href="/luvue/assets/js/221.3e182884.js"><link rel="prefetch" href="/luvue/assets/js/222.b96d83c3.js"><link rel="prefetch" href="/luvue/assets/js/223.98780ee5.js"><link rel="prefetch" href="/luvue/assets/js/224.55e77afc.js"><link rel="prefetch" href="/luvue/assets/js/225.7a25aa80.js"><link rel="prefetch" href="/luvue/assets/js/226.f9c707c4.js"><link rel="prefetch" href="/luvue/assets/js/227.4ae88c67.js"><link rel="prefetch" href="/luvue/assets/js/228.2ca0a572.js"><link rel="prefetch" href="/luvue/assets/js/229.60c711b7.js"><link rel="prefetch" href="/luvue/assets/js/23.64b72b4e.js"><link rel="prefetch" href="/luvue/assets/js/230.cb03a065.js"><link rel="prefetch" href="/luvue/assets/js/231.8e43f45f.js"><link rel="prefetch" href="/luvue/assets/js/232.ea8bbde3.js"><link rel="prefetch" href="/luvue/assets/js/233.ac9af77c.js"><link rel="prefetch" href="/luvue/assets/js/234.ca2fc3f2.js"><link rel="prefetch" href="/luvue/assets/js/235.067bd5e8.js"><link rel="prefetch" href="/luvue/assets/js/236.3ad62ad0.js"><link rel="prefetch" href="/luvue/assets/js/237.cde00877.js"><link rel="prefetch" href="/luvue/assets/js/238.94eb3bd8.js"><link rel="prefetch" href="/luvue/assets/js/239.e70409b8.js"><link rel="prefetch" href="/luvue/assets/js/24.fef8c701.js"><link rel="prefetch" href="/luvue/assets/js/240.4241957b.js"><link rel="prefetch" href="/luvue/assets/js/241.c4ee5c82.js"><link rel="prefetch" href="/luvue/assets/js/25.409f40e0.js"><link rel="prefetch" href="/luvue/assets/js/26.f8b1ce9a.js"><link rel="prefetch" href="/luvue/assets/js/27.e82818fd.js"><link rel="prefetch" href="/luvue/assets/js/28.0bfb495f.js"><link rel="prefetch" href="/luvue/assets/js/29.4dbc1612.js"><link rel="prefetch" href="/luvue/assets/js/30.a959330e.js"><link rel="prefetch" href="/luvue/assets/js/31.100a41c6.js"><link rel="prefetch" href="/luvue/assets/js/32.79a3fc64.js"><link rel="prefetch" href="/luvue/assets/js/33.9d0f512a.js"><link rel="prefetch" href="/luvue/assets/js/34.c5c6c391.js"><link rel="prefetch" href="/luvue/assets/js/36.fc80d89f.js"><link rel="prefetch" href="/luvue/assets/js/37.f09c0eb8.js"><link rel="prefetch" href="/luvue/assets/js/38.88b87058.js"><link rel="prefetch" href="/luvue/assets/js/39.23c596b8.js"><link rel="prefetch" href="/luvue/assets/js/4.5618a167.js"><link rel="prefetch" href="/luvue/assets/js/40.9afc4743.js"><link rel="prefetch" href="/luvue/assets/js/41.bad3ed94.js"><link rel="prefetch" href="/luvue/assets/js/42.0dec5451.js"><link rel="prefetch" href="/luvue/assets/js/43.aa9d0e21.js"><link rel="prefetch" href="/luvue/assets/js/44.221c217c.js"><link rel="prefetch" href="/luvue/assets/js/45.f0ba095d.js"><link rel="prefetch" href="/luvue/assets/js/46.d7bc08b5.js"><link rel="prefetch" href="/luvue/assets/js/47.fe5d4edf.js"><link rel="prefetch" href="/luvue/assets/js/48.0b4112ed.js"><link rel="prefetch" href="/luvue/assets/js/49.541d70b1.js"><link rel="prefetch" href="/luvue/assets/js/5.81cd1113.js"><link rel="prefetch" href="/luvue/assets/js/50.9338fa61.js"><link rel="prefetch" href="/luvue/assets/js/51.049b084e.js"><link rel="prefetch" href="/luvue/assets/js/52.9021e9e2.js"><link rel="prefetch" href="/luvue/assets/js/53.ee41e726.js"><link rel="prefetch" href="/luvue/assets/js/54.1f3bb31c.js"><link rel="prefetch" href="/luvue/assets/js/55.5c2e24e0.js"><link rel="prefetch" href="/luvue/assets/js/56.402eb13f.js"><link rel="prefetch" href="/luvue/assets/js/57.8fd6561f.js"><link rel="prefetch" href="/luvue/assets/js/58.c8f9291d.js"><link rel="prefetch" href="/luvue/assets/js/59.ff4a0fed.js"><link rel="prefetch" href="/luvue/assets/js/6.9a05f5dc.js"><link rel="prefetch" href="/luvue/assets/js/60.ef8ddbbc.js"><link rel="prefetch" href="/luvue/assets/js/61.ac9780cf.js"><link rel="prefetch" href="/luvue/assets/js/62.7eb6cd66.js"><link rel="prefetch" href="/luvue/assets/js/63.f6184b0a.js"><link rel="prefetch" href="/luvue/assets/js/64.f2df73ae.js"><link rel="prefetch" href="/luvue/assets/js/65.823ff3fe.js"><link rel="prefetch" href="/luvue/assets/js/66.068fa56b.js"><link rel="prefetch" href="/luvue/assets/js/67.a58f447e.js"><link rel="prefetch" href="/luvue/assets/js/68.ad0d4475.js"><link rel="prefetch" href="/luvue/assets/js/69.4b75ac3d.js"><link rel="prefetch" href="/luvue/assets/js/7.bf06d7b4.js"><link rel="prefetch" href="/luvue/assets/js/70.44da9c56.js"><link rel="prefetch" href="/luvue/assets/js/71.4e5ce64a.js"><link rel="prefetch" href="/luvue/assets/js/72.89210c37.js"><link rel="prefetch" href="/luvue/assets/js/73.a2542c1a.js"><link rel="prefetch" href="/luvue/assets/js/74.3c9d3f1b.js"><link rel="prefetch" href="/luvue/assets/js/75.da0a95a0.js"><link rel="prefetch" href="/luvue/assets/js/76.4168cd26.js"><link rel="prefetch" href="/luvue/assets/js/77.1ee95342.js"><link rel="prefetch" href="/luvue/assets/js/78.35f2ef39.js"><link rel="prefetch" href="/luvue/assets/js/79.c8518e07.js"><link rel="prefetch" href="/luvue/assets/js/8.31f9acca.js"><link rel="prefetch" href="/luvue/assets/js/80.8b2bf30b.js"><link rel="prefetch" href="/luvue/assets/js/81.f1537b64.js"><link rel="prefetch" href="/luvue/assets/js/82.82d19909.js"><link rel="prefetch" href="/luvue/assets/js/83.dfc28a79.js"><link rel="prefetch" href="/luvue/assets/js/84.a289c030.js"><link rel="prefetch" href="/luvue/assets/js/85.d1aa5612.js"><link rel="prefetch" href="/luvue/assets/js/86.6c7412d6.js"><link rel="prefetch" href="/luvue/assets/js/87.f9b887f7.js"><link rel="prefetch" href="/luvue/assets/js/88.19f423af.js"><link rel="prefetch" href="/luvue/assets/js/89.ebc19a45.js"><link rel="prefetch" href="/luvue/assets/js/9.d2ef661a.js"><link rel="prefetch" href="/luvue/assets/js/90.39834eaa.js"><link rel="prefetch" href="/luvue/assets/js/91.dee61774.js"><link rel="prefetch" href="/luvue/assets/js/92.e2a4afd1.js"><link rel="prefetch" href="/luvue/assets/js/93.951d933c.js"><link rel="prefetch" href="/luvue/assets/js/94.d1b74c74.js"><link rel="prefetch" href="/luvue/assets/js/95.b15eb61a.js"><link rel="prefetch" href="/luvue/assets/js/96.10581589.js"><link rel="prefetch" href="/luvue/assets/js/97.a437eaf2.js"><link rel="prefetch" href="/luvue/assets/js/98.4fb5e190.js"><link rel="prefetch" href="/luvue/assets/js/99.f859d5b5.js">
    <link rel="stylesheet" href="/luvue/assets/css/0.styles.0c275c11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/luvue/" class="home-link router-link-active"><!----> <span class="site-name">Ailjc notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link router-link-active">工程化</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link router-link-active">工程化</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/Vite/" class="sidebar-heading clickable"><span>Vite</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/rollup/" class="sidebar-heading clickable router-link-active open"><span>rollup</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/luvue/engineering/rollup/01-10分钟快速入门rollupJs1.html" class="sidebar-link">01-10分钟快速入门rollupJs1</a></li><li><a href="/luvue/engineering/rollup/02-10分钟快速进阶rollupJs2.html" class="sidebar-link">02-10分钟快速进阶rollupJs2</a></li><li><a href="/luvue/engineering/rollup/03-rollup.html" class="sidebar-link">03-rollup</a></li><li><a href="/luvue/engineering/rollup/04-手写Rollup.html" class="sidebar-link">04-手写Rollup</a></li><li><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html" class="active sidebar-link">05-rollup构建原理及简易实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#一、rollup-概述" class="sidebar-link">一、Rollup 概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#rollup-是什么" class="sidebar-link">Rollup 是什么</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#二、rollup-前置知识" class="sidebar-link">二、Rollup 前置知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#magic-string" class="sidebar-link">magic-string</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#ast" class="sidebar-link">AST</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#ast-工作流" class="sidebar-link">AST 工作流</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#acorn" class="sidebar-link">acorn</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#作用域-作用域链" class="sidebar-link">作用域/作用域链</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#三、rollup" class="sidebar-link">三、Rollup</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#rollup-是怎样工作的呢" class="sidebar-link">Rollup 是怎样工作的呢？</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#rollup-构建流程分析" class="sidebar-link">Rollup 构建流程分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#rollup-构建流程" class="sidebar-link">Rollup 构建流程</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#_1-new-bundle-build" class="sidebar-link">1.new Bundle(), build()</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#_2-new-module" class="sidebar-link">2.new Module()</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#_3-generate" class="sidebar-link">3.generate（）</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html#小结" class="sidebar-link">小结</a></li></ul></li></ul></li><li><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html" class="sidebar-link">06-从0到1解读rollup-Plugin</a></li><li><a href="/luvue/engineering/rollup/07-项目减重之rollup的Tree-shaking.html" class="sidebar-link">07-项目减重之rollup的Tree-shaking</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/webpack/" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/渲染性能优化/" class="sidebar-heading clickable"><span>渲染性能优化</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rollup-构建原理及简易实现"><a href="#rollup-构建原理及简易实现" class="header-anchor">#</a> rollup - 构建原理及简易实现</h1> <p></p><div class="table-of-contents"><ul><li><a href="#一、rollup-概述">一、Rollup 概述</a><ul><li><a href="#rollup-是什么">Rollup 是什么</a></li></ul></li><li><a href="#二、rollup-前置知识">二、Rollup 前置知识</a><ul><li><a href="#magic-string">magic-string</a></li><li><a href="#ast">AST</a></li><li><a href="#ast-工作流">AST 工作流</a></li><li><a href="#acorn">acorn</a></li><li><a href="#作用域-作用域链">作用域/作用域链</a></li></ul></li><li><a href="#三、rollup">三、Rollup</a><ul><li><a href="#rollup-是怎样工作的呢">Rollup 是怎样工作的呢？</a></li></ul></li><li><a href="#rollup-构建流程分析">Rollup 构建流程分析</a><ul><li><a href="#rollup-构建流程">Rollup 构建流程</a></li><li><a href="#_1-new-bundle-build">1.new Bundle(), build()</a></li><li><a href="#_2-new-module">2.new Module()</a></li><li><a href="#_3-generate">3.generate（）</a></li><li><a href="#小结">小结</a></li></ul></li></ul></div><p></p> <h2 id="一、rollup-概述"><a href="#一、rollup-概述" class="header-anchor">#</a> 一、Rollup 概述</h2> <p>官网地址：<a href="/luvue/engineering/rollup/rollupjs.org/guide/en/">rollupjs.org/guide/en/</a></p> <h3 id="rollup-是什么"><a href="#rollup-是什么" class="header-anchor">#</a> Rollup 是什么</h3> <p>我们先看看 Rollup 的作者 Rich Harris 是怎么讲的？<br> <strong>Rollup 是一个模块化的打包工具</strong>。本质上，它会合并 JavaScript 文件。而且你不需要去手动指定它们的顺序，或者去担心文件之间的变量名冲突。它的内部实现会比说的复杂一点，但是它就是这么做的 —— <code>合并</code>。</p> <p>Rollup 是一个模块打包器，支持 ES6 模块，支持 Tree-shaking，但不支持 webpack 的 code-splitting、模块热更新等，这意味着它更适合用来做类库项目的打包器而不是应用程序项目的打包器。</p> <h2 id="二、rollup-前置知识"><a href="#二、rollup-前置知识" class="header-anchor">#</a> 二、Rollup 前置知识</h2> <h3 id="magic-string"><a href="#magic-string" class="header-anchor">#</a> magic-string</h3> <p><code>magic-string</code> 是 Rollup 作者写的一个关于字符串操作的库，这个库主要是对字符串一些常用方法进行了封装</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">var</span> MagicString <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'magic-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> magicString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span><span class="token string">'export var name = &quot;zhangsan&quot;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 以下所有操作都是基于原生字符串</span>
<span class="token comment">// 类似于截取字符串</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>magicString<span class="token punctuation">.</span><span class="token function">snip</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// export</span>
<span class="token comment">// 从开始到结束删除</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>magicString<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  var name = &quot;zhangsan&quot;</span>

<span class="token comment">// 多个模块，把他们打包在一个文件里，需要把很多文件的源代码合并在一起</span>
<span class="token keyword">let</span> bundleString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">.</span><span class="token function">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bundleString<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  content<span class="token operator">:</span> <span class="token string">'console.log(hello)'</span><span class="token punctuation">,</span>
  separator<span class="token operator">:</span> <span class="token string">'\n'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bundleString<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  content<span class="token operator">:</span> <span class="token string">'console.log(world)'</span><span class="token punctuation">,</span>
  separator<span class="token operator">:</span> <span class="token string">'\n'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// // 原理类似</span>
<span class="token comment">// let str = ''</span>
<span class="token comment">// str += 'console.log(hello);\n'</span>
<span class="token comment">// str += 'console.log(world);\n'</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bundleString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// hello</span>
<span class="token comment">// world</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="ast"><a href="#ast" class="header-anchor">#</a> AST</h3> <p>通过 javascript parse 可以把代码转化为一颗抽象语法树 AST，这颗树定义了代码的结构，通过操纵这个树，我们可以精确的定位到声明语句、赋值语句、运算符语句等等，实现对代码的分析、优化、变更等操作 源代码：main.js</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// main.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> a <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a'</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>转化为 AST 是长这样子的，如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Program&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 这个 AST 类型为 Program，表明是一个程序</span>
  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
  <span class="token property">&quot;body&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// body 是一个数组，每一条语句都对应 body 下的一个语句</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ImportDeclaration&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 导入声明类型</span>
      <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span>
      <span class="token property">&quot;specifiers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ImportSpecifier&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
          <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
          <span class="token property">&quot;imported&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a&quot;</span> <span class="token comment">// 导入模块命名 name 'a'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;local&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a&quot;</span> <span class="token comment">// 本地模块命名，同 imported.name</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Literal&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
        <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./a&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 导入路径 './a'</span>
        <span class="token property">&quot;raw&quot;</span><span class="token operator">:</span> <span class="token string">&quot;'./a'&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ExpressionStatement&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 表达式类型</span>
      <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>
      <span class="token property">&quot;expression&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 调用表达式类型</span>
        <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
        <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>
        <span class="token property">&quot;callee&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MemberExpression&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
          <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">35</span><span class="token punctuation">,</span>
          <span class="token property">&quot;object&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">31</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;console&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;property&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">35</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;log&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;computed&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">&quot;optional&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;arguments&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">36</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">37</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;optional&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sourceType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><h3 id="ast-工作流"><a href="#ast-工作流" class="header-anchor">#</a> AST 工作流</h3> <p>Parse（解析）将代码转化成抽象语法树，树上有很多的 estree 节点 Transform(转换) 对抽象语法树进行转换 Generate（代码生成） 将上一步经过转换过的抽象语法树生成新的代码</p> <h3 id="acorn"><a href="#acorn" class="header-anchor">#</a> acorn</h3> <p>acorn 是一个 JavaScript 语法解析器，它将 JavaScript 字符串解析成语法抽象树 AST 如果想了解 AST 语法树可以点下这个网址 <a href="/luvue/engineering/rollup/astexplorer.net/">astexplorer.net/</a></p> <h3 id="作用域-作用域链"><a href="#作用域-作用域链" class="header-anchor">#</a> 作用域/作用域链</h3> <p>在 js 中，作用域是用来规定变量访问范围的规则， 作用域链是由当前执行环境和上层执行环境的一系列变量对象组成的，它保证了当前执行环境对符合访问权限的变量和函数的有序访问</p> <h2 id="三、rollup"><a href="#三、rollup" class="header-anchor">#</a> 三、Rollup</h2> <h3 id="rollup-是怎样工作的呢"><a href="#rollup-是怎样工作的呢" class="header-anchor">#</a> Rollup 是怎样工作的呢？</h3> <p>你给它一个入口文件 —— 通常是 index.js。Rollup 将使用 Acorn 读取解析文件 —— 将返回给我们一种叫抽象语法树（AST）的东西。 一旦有了 AST ，你就可以发现许多关于代码的东西，比如它包含哪些 import 声明。​</p> <p>假设 index.js 文件头部有这样一行：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> foo <span class="token keyword">from</span> <span class="token string">'./foo.js'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>这就意味着 Rollup 需要去加载，解析，分析在 index.js 中引入的 ./foo.js。重复解析直到没有更多的模块被加载进来。更重要的是，所有的这些操作都是可插拔的，所以您可以从 node_modules 中导入或者使用 sourcemap-aware 的方式将 ES2015 编译成 ES5 代码</strong>。</p> <p>在 Rollup 中，一个文件就是一个模块，每个模块都会根据文件的代码生成一个 AST 抽象语法树。
​
分析 AST 节点，就是看这个节点有没有调用函数方法，有没有读到变量，有，就查看是否在当前作用域，如果不在就往上找，直到找到模块顶级作用域为止。如果本模块都没找到，说明这个函数、方法依赖于其他模块，需要从其他模块引入。如果发现其他模块中有方法依赖其他模块，就会递归读取其他模块，如此循环直到没有依赖的模块为止
找到这些变量或着方法是在哪里定义的，把定义语句包含进来即可
其他无关代码一律不要
​
看如下代码，我们先实际操作一下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> foo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./foo'</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> city <span class="token operator">=</span> <span class="token string">'hangzhou'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// foo.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> bar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./bar'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// bar.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// rollup.config.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">'./dist/bundle.js'</span><span class="token punctuation">,</span> <span class="token comment">// 打包后的存放文件</span>
    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span> <span class="token comment">//输出格式 amd es6 life umd cjs</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'bundleName'</span><span class="token punctuation">,</span> <span class="token comment">//如果输出格式 life，umd 需要指定一个全局变量</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>执行 <code>npm run build</code>,会得到如下结果：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>以上，我们可以看到 <code>Rollup 只是会合并你的代码 —— 没有任何浪费</code>。所产生的包也可以更好的缩小。有人称之为 “作用域提升（scope hoisting）”。
其次，它把你导入的模块中的未使用代码移除。这被称为“（摇树优化）treeshaking”。</p> <p>总之，Rollup 就是一个模块化的打包工具。
​
接下来我们进入源码，具体分析下 Rollup 的构建流程</p> <h2 id="rollup-构建流程分析"><a href="#rollup-构建流程分析" class="header-anchor">#</a> Rollup 构建流程分析</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code>│  bundle<span class="token punctuation">.</span>js <span class="token comment">// Bundle 打包器，在打包过程中会生成一个 bundle 实例，用于收集其他模块的代码，最后再将收集的代码打包到一起。</span>
│  external<span class="token operator">-</span>module<span class="token punctuation">.</span>js <span class="token comment">// ExternalModule 外部模块，例如引入了 'path' 模块，就会生成一个 ExternalModule 实例。</span>
│  module<span class="token punctuation">.</span>js <span class="token comment">// Module 模块，module 实例。</span>
│  rollup<span class="token punctuation">.</span>js <span class="token comment">// rollup 函数，一切的开始，调用它进行打包。</span>
│
├─ast <span class="token comment">// ast 目录，包含了和 AST 相关的类和函数</span>
│      analyse<span class="token punctuation">.</span>js <span class="token comment">// 主要用于分析 AST 节点的作用域和依赖项。</span>
│      Scope<span class="token punctuation">.</span>js <span class="token comment">// 在分析 AST 节点时为每一个节点生成对应的 Scope 实例，主要是记录每个 AST 节点对应的作用域。</span>
│      walk<span class="token punctuation">.</span>js <span class="token comment">// walk 就是递归调用 AST 节点进行分析。</span>
│
├─finalisers
│      cjs<span class="token punctuation">.</span>js
│      index<span class="token punctuation">.</span>js
│
└─utils <span class="token comment">// 一些帮助函数</span>
        map<span class="token operator">-</span>helpers<span class="token punctuation">.</span>js
        object<span class="token punctuation">.</span>js
        promise<span class="token punctuation">.</span>js
        replaceIdentifiers<span class="token punctuation">.</span>js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="rollup-构建流程"><a href="#rollup-构建流程" class="header-anchor">#</a> Rollup 构建流程</h3> <p>我们以 index.js 入口文件，index 依赖了 foo.js,foo 依赖了 bar.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> foo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./foo'</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> city <span class="token operator">=</span> <span class="token string">'hangzhou'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// foo.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> bar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./bar'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// bar.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>debug 起来!!!</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// debug.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rollup <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/rollup'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 入口文件的绝对路径</span>
<span class="token keyword">let</span> entry <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src/main.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 和源码有所不同，这里使用的是同步，增加可读性</span>
<span class="token function">rollup</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token string">'bundle.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_1-new-bundle-build"><a href="#_1-new-bundle-build" class="header-anchor">#</a> 1.new Bundle(), build()</h3> <p>首先生成一个 Bundle 实例，也就是打包器。 然后执行 build 打包编译</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// rollup.js</span>
<span class="token keyword">let</span> Bundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./bundle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">rollup</span><span class="token punctuation">(</span><span class="token parameter">entry<span class="token punctuation">,</span> outputFileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Bundle 代表打包对象，里面包含所有的模块信息</span>
  <span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entry <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用 build 方法开始进行编译</span>
  bundle<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>outputFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> rollup<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>lib/bundle.js 根据入口路径出发（在 bundle 中，我们会首先统一处理下入口文件的后缀），去找到他的模块定义，在 fetchModule 中，会生成一个 module 实例</p> <div align="center"><img src="/luvue/images/rollup/rollup10.awebp" alt="rollup/rollup10.awebp"></div> <p>我们关注红框中的代码，会发现返回了一个 module</p> <div align="center"><img src="/luvue/images/rollup/rollup11.awebp" alt="rollup/rollup11.awebp"></div> <h3 id="_2-new-module"><a href="#_2-new-module" class="header-anchor">#</a> 2.new Module()</h3> <p>每个文件都是一个模块，每个模块都会有一个 Module 实例。 在 Module 实例中，会调用 acorn 库的 parse() 方法将代码解析成 AST。</p> <div align="center"><img src="/luvue/images/rollup/rollup12.awebp" alt="rollup/rollup12.awebp"></div> <p>对生成的 AST 进行分析 <code>analyse</code> 我们先看一下入口文件 index.js 生成的 AST</p> <div align="center"><img src="/luvue/images/rollup/rollup13.awebp" alt="rollup/rollup13.awebp"></div> <div align="center"><img src="/luvue/images/rollup/rollup14.awebp" alt="rollup/rollup14.awebp"></div> <p>可以看到 ast.body 是一个数组，分别对应 index.js 的五条语句 展开这个 ast 树如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Program&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">128</span><span class="token punctuation">,</span>
  <span class="token property">&quot;body&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ImportDeclaration&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 导入声明</span>
      <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">31</span><span class="token punctuation">,</span>
      <span class="token property">&quot;specifiers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ImportSpecifier&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
          <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
          <span class="token property">&quot;imported&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;local&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Literal&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
        <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./foo.js&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;raw&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\&quot;./foo.js\&quot;&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ExpressionStatement&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">37</span><span class="token punctuation">,</span>
      <span class="token property">&quot;expression&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
        <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">37</span><span class="token punctuation">,</span>
        <span class="token property">&quot;callee&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
          <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">35</span><span class="token punctuation">,</span>
          <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;arguments&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;optional&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VariableDeclaration&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">59</span><span class="token punctuation">,</span>
      <span class="token property">&quot;declarations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VariableDeclarator&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
          <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">59</span><span class="token punctuation">,</span>
          <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">46</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;city&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;init&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Literal&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">49</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">59</span><span class="token punctuation">,</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hangzhou&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;raw&quot;</span><span class="token operator">:</span> <span class="token string">&quot;'hangzhou'&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;var&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">61</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">104</span><span class="token punctuation">,</span>
      <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">70</span><span class="token punctuation">,</span>
        <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">74</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;expression&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">&quot;generator&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">&quot;async&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;body&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;BlockStatement&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">77</span><span class="token punctuation">,</span>
        <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">104</span><span class="token punctuation">,</span>
        <span class="token property">&quot;body&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ExpressionStatement&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">83</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">102</span><span class="token punctuation">,</span>
            <span class="token property">&quot;expression&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">83</span><span class="token punctuation">,</span>
              <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">102</span><span class="token punctuation">,</span>
              <span class="token property">&quot;callee&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MemberExpression&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">83</span><span class="token punctuation">,</span>
                <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">94</span><span class="token punctuation">,</span>
                <span class="token property">&quot;object&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">83</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">90</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;console&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">&quot;property&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">91</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">94</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;log&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">&quot;computed&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token property">&quot;optional&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token property">&quot;arguments&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Literal&quot;</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">95</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">101</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;raw&quot;</span><span class="token operator">:</span> <span class="token string">&quot;'test'&quot;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token property">&quot;optional&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ExpressionStatement&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">106</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">125</span><span class="token punctuation">,</span>
      <span class="token property">&quot;expression&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">106</span><span class="token punctuation">,</span>
        <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">125</span><span class="token punctuation">,</span>
        <span class="token property">&quot;callee&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MemberExpression&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">106</span><span class="token punctuation">,</span>
          <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">117</span><span class="token punctuation">,</span>
          <span class="token property">&quot;object&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">106</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">113</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;console&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;property&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">114</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">117</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;log&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;computed&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">&quot;optional&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;arguments&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">118</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">124</span><span class="token punctuation">,</span>
            <span class="token property">&quot;callee&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">118</span><span class="token punctuation">,</span>
              <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">122</span><span class="token punctuation">,</span>
              <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;arguments&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">&quot;optional&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;optional&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sourceType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br></div></div><p>我们通过这个 AST 树，分析 <strong>analyse</strong>具体做了什么???​</p> <p>第一步：分析当前模块导入【import】和导出【exports】模块，将引入的模块和导出的模块存储起来 this.imports = {};//存放着当前模块所有的导入
this.exports = {};//存放着当前模块所有的导出</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//存放着当前模块所有的导入</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//存放着当前模块所有的导出</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 说明这是一个 import 语句</span>
    <span class="token keyword">let</span> source <span class="token operator">=</span> node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 从哪个模块导入的</span>
    <span class="token keyword">let</span> specifiers <span class="token operator">=</span> node<span class="token punctuation">.</span>specifiers<span class="token punctuation">;</span> <span class="token comment">// 导入标识符</span>
    specifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">specifier</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> name <span class="token operator">=</span> specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token punctuation">;</span> <span class="token comment">//name</span>
      <span class="token keyword">const</span> localName <span class="token operator">=</span> specifier<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">;</span> <span class="token comment">//name</span>
      <span class="token comment">//本地的哪个变量，是从哪个模块的的哪个变量导出的</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>localName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> localName<span class="token punctuation">,</span> source <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//}else if(/^Export/.test(node.type)){ // 导出方法有很多</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ExportNamedDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 说明这是一个 exports 语句</span>
    <span class="token keyword">let</span> declaration <span class="token operator">=</span> node<span class="token punctuation">.</span>declaration<span class="token punctuation">;</span> <span class="token comment">//VariableDeclaration</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>declaration<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'VariableDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> name <span class="token operator">=</span> declaration<span class="token punctuation">.</span>declarations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">,</span>
        <span class="token literal-property property">localName</span><span class="token operator">:</span> name<span class="token punctuation">,</span>
        <span class="token literal-property property">expression</span><span class="token operator">:</span> declaration<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">analyse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//找到了_defines 和 _dependsOn</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>打断点可以看到，foo 已经被存入 imports =》<strong>import { foo } from &quot;./foo&quot;;</strong> exports:{} 表示没有导出语句</p> <div align="center"><img src="/luvue/images/rollup/rollup15.awebp" alt="rollup/rollup15.awebp"></div> <p><code>第二步：analyse(this.ast, this.code, this); //找到_defines 和 _dependsOn</code></p> <p>找出当前模块使用到了哪些变量<br>
标记哪些变量时当前模块声明的，哪些变量是导入别的模块的变量<br>
我们定义以下字段用来存放：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">_defines</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//存放当前模块定义的所有的全局变量</span>
<span class="token literal-property property">_dependsOn</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//当前模块没有定义但是使用到的变量，也就是依赖的外部变量</span>
<span class="token literal-property property">_included</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//此语句是否已经被包含到打包结果中，防止重复打包</span>
<span class="token literal-property property">_source</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">snip</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token comment">//magicString.snip 返回的还是 magicString 实例 clone</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>​
分析每个 AST 节点之间的作用域，构建 scope tree，</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token parameter">ast<span class="token punctuation">,</span> magicString<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//先创建一个模块内的全局作用域</span>
  <span class="token comment">//遍历当前的所有的语法树的所有的顶级节点</span>
  ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//给作用域添加变量 var function const let 变量声明</span>
    <span class="token keyword">function</span> <span class="token function">addToScope</span><span class="token punctuation">(</span><span class="token parameter">declaration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> name <span class="token operator">=</span> declaration<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span> <span class="token comment">//获得这个声明的变量</span>
      scope<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scope<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果当前是全局作用域的话</span>
        statement<span class="token punctuation">.</span>_defines<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">_defines</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//存放当前模块定义的所有的全局变量</span>
      <span class="token literal-property property">_dependsOn</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//当前模块没有定义但是使用到的变量，也就是依赖的外部变量</span>
      <span class="token literal-property property">_included</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//此语句是否已经 被包含到打包结果中了</span>
      <span class="token comment">//start 指的是此节点在源代码中的起始索引,end 就是结束索引</span>
      <span class="token comment">//magicString.snip 返回的还是 magicString 实例 clone</span>
      <span class="token literal-property property">_source</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">snip</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//这一步在构建我们的作用域链</span>
    <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> newScope<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token string">'FunctionDeclaration'</span><span class="token operator">:</span>
            <span class="token keyword">const</span> params <span class="token operator">=</span> node<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'FunctionDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">addToScope</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果遍历到的是一个函数声明，我会创建一个新的作用域对象</span>
            newScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              <span class="token literal-property property">parent</span><span class="token operator">:</span> scope<span class="token punctuation">,</span> <span class="token comment">//父作用域就是当前的作用域</span>
              params<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'VariableDeclaration'</span><span class="token operator">:</span> <span class="token comment">//并不会生成一个新的作用域</span>
            node<span class="token punctuation">.</span>declarations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>addToScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//当前节点声明一个新的作用域</span>
          <span class="token comment">//如果此节点生成一个新的作用域，那么会在这个节点放一个_scope，指向新的作用域</span>
          Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">'_scope'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> newScope <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          scope <span class="token operator">=</span> newScope<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//如果此节点产出了一个新的作用域，那等离开这个节点，scope 回到父作用法域</span>
          scope <span class="token operator">=</span> scope<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ast<span class="token punctuation">.</span>_scope <span class="token operator">=</span> scope<span class="token punctuation">;</span>
  <span class="token comment">//找出外部依赖_dependsOn</span>
  ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          scope <span class="token operator">=</span> node<span class="token punctuation">.</span>_scope<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment">//如果这个节点放有一个 scope 属性，说明这个节点产生了一个新的作用域</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'Identifier'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//从当前的作用域向上递归，找这个变量在哪个作用域中定义</span>
          <span class="token keyword">const</span> definingScope <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definingScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">[</span>node<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//表示这是一个外部依赖的变量</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          scope <span class="token operator">=</span> scope<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><p>断点可以看到**<code>_defines</code> 和 <code>_dependsOn</code>**分别存入了当前变量和引入的变量</p> <div align="center"><img src="/luvue/images/rollup/rollup16.awebp" alt="rollup/rollup16.awebp"></div> <div align="center"><img src="/luvue/images/rollup/rollup17.awebp" alt="rollup/rollup17.awebp"></div> <p><code>第三步：this.definitions = {}; 把全局变量的定义语句存放到 definitions 里</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// module.js</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>definitions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//存放着所有的全局变量的定义语句</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//key 是全局变量名，值是定义这个全局变量的语句</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> statement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>第四步：展开语句，展开当前模块的所有语句，把这些语句中定义的变量的语句都放到结果里</code></p> <p>if (statement.type === 'ImportDeclaration') {return} 如果是导入声明语句，既 import { foo } from &quot;./foo&quot;;这条语句我们是不需要的，return 掉</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//展开这个模块里的语句，把些语句中定义的变量的语句都放到结果里</span>
  <span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> allStatements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span>
      <span class="token keyword">let</span> statements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      allStatements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>statements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> allStatements<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>expandStatement</strong>：找到当前节点依赖的变量，找到这些变量的声明语句。 这些语句可能是在当前模块声明的，也也可能是在导入的模块的声明的 然后放入结果里</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token function">expandStatement</span><span class="token punctuation">(</span><span class="token parameter">statement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dependencies <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//外部依赖 [name]</span>
    dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//找到定义这个变量的声明节点，这个节点可以有在当前模块内，也可能在依赖的模块里</span>
      <span class="token keyword">let</span> definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      statement<span class="token punctuation">.</span>_included <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//表示这个节点已经确定被纳入结果里了，以后就不需要重复添加了</span>
      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>define: 找到定义这个变量的声明节点，这个节点可以有在当前模块内，也可能在依赖的模块里 const module = this.bundle.fetchModule(importData.source, this.path);</strong> 获取导入变量的模块</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>   <span class="token function">define</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查找一下导入变量里有没有 name</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> importData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取导入变量的模块</span>
      <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bundle<span class="token punctuation">.</span><span class="token function">fetchModule</span><span class="token punctuation">(</span>importData<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 这个 module 模块也有导入导出</span>
      <span class="token keyword">const</span> exportData <span class="token operator">=</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">[</span>importData<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 返回这个导入模块变量的声明语句</span>
      <span class="token keyword">return</span> module<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>exportData<span class="token punctuation">.</span>localName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//definitions 是对象,key 当前模块的变量名，值是定义这个变量的语句</span>
      <span class="token keyword">let</span> statement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>statement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div align="center"><img src="/luvue/images/rollup/rollup18.awebp" alt="rollup/rollup18.awebp"></div> <p>this.statements 里就是所有我们分析标记之后返回的数组</p> <div align="center"><img src="/luvue/images/rollup/rollup19.awebp" alt="rollup/rollup19.awebp"></div> <p>以上分析了很多，但总结来就是做了以下事情：</p> <ul><li>收集导入和导出变量</li> <li>建立映射关系，方便后续使用</li> <li>收集所有语句定义的变量</li> <li>建立变量和声明语句之间的对应关系，方便后续使用</li> <li>过滤 <code>import</code> 语句</li> <li>删除关键词</li> <li>输出语句时，判断变量是否为 <code>import</code></li> <li>如是需要递归再次收集依赖文件的变量</li> <li>否则直接输出</li> <li>构建依赖关系，创建作用域链，交由./src/ast/analyse.js 文件处理</li> <li>在抽象语法树的每一条语句上挂载<code>_source(源代码)</code>、<code>_defines</code>(当前模块定义的变量)、<code>_dependsOn</code>(外部依赖的变量)、<code>_included</code>(是否已经包含在输出语句中)</li> <li>收集每个语句上定义的变量，创建作用域链</li></ul> <h3 id="_3-generate"><a href="#_3-generate" class="header-anchor">#</a> 3.generate（）</h3> <p>第一步：移除额外代码
例如从 foo.js 中引入的 foo() 函数代码是这样的：export function foo() {}。rollup 会移除掉 export，变 成 function foo() {}。因为它们就要打包在一起了，所以就不需要 export 了。
​
第二步：把 AST 节点的源码 addSource 到 magicString,这个操作本质上相当于拼字符串,</p> <div align="center"><img src="/luvue/images/rollup/rollup20.awebp" alt="rollup/rollup20.awebp"></div> <p>第三步：<strong>return magicString.toString()</strong>。 返回合并后源代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> magicString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString<span class="token punctuation">.</span>Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>statements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> source <span class="token operator">=</span> statement<span class="token punctuation">.</span>_source<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ExportNamedDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        source<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>declaration<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      magicString<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> source<span class="token punctuation">,</span>
        <span class="token literal-property property">separator</span><span class="token operator">:</span> <span class="token string">'\n'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">code</span><span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>最后输出到'dist/bundle.js'中</p> <div align="center"><img src="/luvue/images/rollup/rollup21.awebp" alt="rollup/rollup21.awebp"></div> <h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <p>简单来说，Rollup 构建其实就是做了以下几件事：</p> <ul><li>获取入口文件的内容，包装成 module，生成抽象语法树</li> <li>对入口文件抽象语法树进行依赖解析</li> <li>生成最终代码</li> <li>写入目标文件</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/luvue/engineering/rollup/04-手写Rollup.html" class="prev">04-手写Rollup</a></span> <span class="next"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html">06-从0到1解读rollup-Plugin</a>
      →
    </span></p></div> </main> <span data-v-2ae0ee72></span></div><div class="global-ui"></div></div>
    <script src="/luvue/assets/js/app.3055a672.js" defer></script><script src="/luvue/assets/js/2.edd550b3.js" defer></script><script src="/luvue/assets/js/3.29a3f40f.js" defer></script><script src="/luvue/assets/js/35.9ce2b7e0.js" defer></script>
  </body>
</html>
