<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从 0 到 1 解读 rollup Plugin | Ailjc notes</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel=" " href=" ">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/luvue/assets/css/0.styles.0c275c11.css" as="style"><link rel="preload" href="/luvue/assets/js/app.24d3cb9c.js" as="script"><link rel="preload" href="/luvue/assets/js/2.7e9a2be9.js" as="script"><link rel="preload" href="/luvue/assets/js/3.92ecc592.js" as="script"><link rel="preload" href="/luvue/assets/js/65.90372937.js" as="script"><link rel="prefetch" href="/luvue/assets/js/10.fefd87d0.js"><link rel="prefetch" href="/luvue/assets/js/100.19a916cd.js"><link rel="prefetch" href="/luvue/assets/js/101.15e09ebc.js"><link rel="prefetch" href="/luvue/assets/js/102.8c2aa751.js"><link rel="prefetch" href="/luvue/assets/js/103.80aaf15e.js"><link rel="prefetch" href="/luvue/assets/js/104.4b17369d.js"><link rel="prefetch" href="/luvue/assets/js/105.e3b99d7f.js"><link rel="prefetch" href="/luvue/assets/js/106.6cb53770.js"><link rel="prefetch" href="/luvue/assets/js/107.0faf8906.js"><link rel="prefetch" href="/luvue/assets/js/108.695346d6.js"><link rel="prefetch" href="/luvue/assets/js/109.438c6b2e.js"><link rel="prefetch" href="/luvue/assets/js/11.141d84f1.js"><link rel="prefetch" href="/luvue/assets/js/110.6ffb0399.js"><link rel="prefetch" href="/luvue/assets/js/111.61fd8319.js"><link rel="prefetch" href="/luvue/assets/js/112.9998d3be.js"><link rel="prefetch" href="/luvue/assets/js/113.89ee7c2f.js"><link rel="prefetch" href="/luvue/assets/js/114.b21dd215.js"><link rel="prefetch" href="/luvue/assets/js/115.e5ecdcf4.js"><link rel="prefetch" href="/luvue/assets/js/116.5ca6e10a.js"><link rel="prefetch" href="/luvue/assets/js/117.44d630a9.js"><link rel="prefetch" href="/luvue/assets/js/118.3a710062.js"><link rel="prefetch" href="/luvue/assets/js/119.00b1d4d9.js"><link rel="prefetch" href="/luvue/assets/js/12.2730a5bc.js"><link rel="prefetch" href="/luvue/assets/js/120.f785e761.js"><link rel="prefetch" href="/luvue/assets/js/121.021c6306.js"><link rel="prefetch" href="/luvue/assets/js/122.e0bf3cfc.js"><link rel="prefetch" href="/luvue/assets/js/123.01466def.js"><link rel="prefetch" href="/luvue/assets/js/124.2dcfea2f.js"><link rel="prefetch" href="/luvue/assets/js/125.41167849.js"><link rel="prefetch" href="/luvue/assets/js/126.5d739372.js"><link rel="prefetch" href="/luvue/assets/js/127.f56f652e.js"><link rel="prefetch" href="/luvue/assets/js/128.40b9b278.js"><link rel="prefetch" href="/luvue/assets/js/129.207137ba.js"><link rel="prefetch" href="/luvue/assets/js/13.60de938c.js"><link rel="prefetch" href="/luvue/assets/js/130.db104c86.js"><link rel="prefetch" href="/luvue/assets/js/131.2c9e9b26.js"><link rel="prefetch" href="/luvue/assets/js/132.d3d980cb.js"><link rel="prefetch" href="/luvue/assets/js/133.aa1a804e.js"><link rel="prefetch" href="/luvue/assets/js/134.231966e7.js"><link rel="prefetch" href="/luvue/assets/js/135.2dbcd9a0.js"><link rel="prefetch" href="/luvue/assets/js/136.919530da.js"><link rel="prefetch" href="/luvue/assets/js/137.c703c0a8.js"><link rel="prefetch" href="/luvue/assets/js/138.d0fbe76a.js"><link rel="prefetch" href="/luvue/assets/js/139.d6ceef15.js"><link rel="prefetch" href="/luvue/assets/js/14.1bd46c2e.js"><link rel="prefetch" href="/luvue/assets/js/140.5ed92165.js"><link rel="prefetch" href="/luvue/assets/js/141.916b71f0.js"><link rel="prefetch" href="/luvue/assets/js/142.27fd2bd5.js"><link rel="prefetch" href="/luvue/assets/js/143.6ada4af5.js"><link rel="prefetch" href="/luvue/assets/js/144.bd6f10eb.js"><link rel="prefetch" href="/luvue/assets/js/145.10c93542.js"><link rel="prefetch" href="/luvue/assets/js/146.038104a3.js"><link rel="prefetch" href="/luvue/assets/js/147.ef6ffd68.js"><link rel="prefetch" href="/luvue/assets/js/148.7d62ecb5.js"><link rel="prefetch" href="/luvue/assets/js/149.ae6c8e49.js"><link rel="prefetch" href="/luvue/assets/js/15.8a053615.js"><link rel="prefetch" href="/luvue/assets/js/150.5350b1a8.js"><link rel="prefetch" href="/luvue/assets/js/151.1f9fee8b.js"><link rel="prefetch" href="/luvue/assets/js/152.e6e676be.js"><link rel="prefetch" href="/luvue/assets/js/153.068ed172.js"><link rel="prefetch" href="/luvue/assets/js/154.3c4d0eb6.js"><link rel="prefetch" href="/luvue/assets/js/155.f99df381.js"><link rel="prefetch" href="/luvue/assets/js/156.537a2efd.js"><link rel="prefetch" href="/luvue/assets/js/157.0acfc338.js"><link rel="prefetch" href="/luvue/assets/js/158.26d3338f.js"><link rel="prefetch" href="/luvue/assets/js/159.6f1cc4e1.js"><link rel="prefetch" href="/luvue/assets/js/16.7f7a3ee8.js"><link rel="prefetch" href="/luvue/assets/js/160.5bd2b3df.js"><link rel="prefetch" href="/luvue/assets/js/161.f50a7be4.js"><link rel="prefetch" href="/luvue/assets/js/162.4846c312.js"><link rel="prefetch" href="/luvue/assets/js/163.3d6f75ae.js"><link rel="prefetch" href="/luvue/assets/js/164.cf7094e1.js"><link rel="prefetch" href="/luvue/assets/js/165.b084c14e.js"><link rel="prefetch" href="/luvue/assets/js/166.d91162ba.js"><link rel="prefetch" href="/luvue/assets/js/167.69358e95.js"><link rel="prefetch" href="/luvue/assets/js/168.0b12410a.js"><link rel="prefetch" href="/luvue/assets/js/169.91d22f58.js"><link rel="prefetch" href="/luvue/assets/js/17.6a766300.js"><link rel="prefetch" href="/luvue/assets/js/170.c3c7e2cd.js"><link rel="prefetch" href="/luvue/assets/js/171.33dd8106.js"><link rel="prefetch" href="/luvue/assets/js/172.af5c5706.js"><link rel="prefetch" href="/luvue/assets/js/173.5d6b421f.js"><link rel="prefetch" href="/luvue/assets/js/174.6c53f57e.js"><link rel="prefetch" href="/luvue/assets/js/175.737dc55c.js"><link rel="prefetch" href="/luvue/assets/js/176.55b0940c.js"><link rel="prefetch" href="/luvue/assets/js/177.c88610d7.js"><link rel="prefetch" href="/luvue/assets/js/178.5858fe0b.js"><link rel="prefetch" href="/luvue/assets/js/179.9125a0ca.js"><link rel="prefetch" href="/luvue/assets/js/18.ceac0c46.js"><link rel="prefetch" href="/luvue/assets/js/180.3e38599d.js"><link rel="prefetch" href="/luvue/assets/js/181.25c2e254.js"><link rel="prefetch" href="/luvue/assets/js/182.80fa8809.js"><link rel="prefetch" href="/luvue/assets/js/183.da1b5a2b.js"><link rel="prefetch" href="/luvue/assets/js/184.acba5e76.js"><link rel="prefetch" href="/luvue/assets/js/185.eaf51d55.js"><link rel="prefetch" href="/luvue/assets/js/186.8de639f8.js"><link rel="prefetch" href="/luvue/assets/js/187.a02bfc44.js"><link rel="prefetch" href="/luvue/assets/js/188.5f5aac79.js"><link rel="prefetch" href="/luvue/assets/js/189.5e8eaa5e.js"><link rel="prefetch" href="/luvue/assets/js/19.82af8a5d.js"><link rel="prefetch" href="/luvue/assets/js/190.6e3dd61d.js"><link rel="prefetch" href="/luvue/assets/js/191.ff42b9b7.js"><link rel="prefetch" href="/luvue/assets/js/192.133d06c7.js"><link rel="prefetch" href="/luvue/assets/js/193.64fba768.js"><link rel="prefetch" href="/luvue/assets/js/194.660335c7.js"><link rel="prefetch" href="/luvue/assets/js/195.9f6cae6d.js"><link rel="prefetch" href="/luvue/assets/js/196.586e8911.js"><link rel="prefetch" href="/luvue/assets/js/197.9c1be23d.js"><link rel="prefetch" href="/luvue/assets/js/198.95b7d4ed.js"><link rel="prefetch" href="/luvue/assets/js/199.3844e818.js"><link rel="prefetch" href="/luvue/assets/js/20.c59106ba.js"><link rel="prefetch" href="/luvue/assets/js/200.ef447f95.js"><link rel="prefetch" href="/luvue/assets/js/201.10481b4c.js"><link rel="prefetch" href="/luvue/assets/js/202.8b3925fe.js"><link rel="prefetch" href="/luvue/assets/js/203.8e740ff3.js"><link rel="prefetch" href="/luvue/assets/js/204.10e0ff19.js"><link rel="prefetch" href="/luvue/assets/js/205.aa8b64c3.js"><link rel="prefetch" href="/luvue/assets/js/206.5cadd5e0.js"><link rel="prefetch" href="/luvue/assets/js/207.1c3fb502.js"><link rel="prefetch" href="/luvue/assets/js/208.37e57586.js"><link rel="prefetch" href="/luvue/assets/js/209.b251f57c.js"><link rel="prefetch" href="/luvue/assets/js/21.dbcb08ca.js"><link rel="prefetch" href="/luvue/assets/js/210.f4c69350.js"><link rel="prefetch" href="/luvue/assets/js/211.a60ef32b.js"><link rel="prefetch" href="/luvue/assets/js/212.5df085a0.js"><link rel="prefetch" href="/luvue/assets/js/213.6cca02ed.js"><link rel="prefetch" href="/luvue/assets/js/214.e437f7ba.js"><link rel="prefetch" href="/luvue/assets/js/215.9731e93e.js"><link rel="prefetch" href="/luvue/assets/js/216.be0f0876.js"><link rel="prefetch" href="/luvue/assets/js/217.36c30f83.js"><link rel="prefetch" href="/luvue/assets/js/218.680c6053.js"><link rel="prefetch" href="/luvue/assets/js/219.d01d0032.js"><link rel="prefetch" href="/luvue/assets/js/22.6382f403.js"><link rel="prefetch" href="/luvue/assets/js/220.5ca1be98.js"><link rel="prefetch" href="/luvue/assets/js/221.a6371702.js"><link rel="prefetch" href="/luvue/assets/js/222.db815fbb.js"><link rel="prefetch" href="/luvue/assets/js/223.db9037a7.js"><link rel="prefetch" href="/luvue/assets/js/224.23cd9e02.js"><link rel="prefetch" href="/luvue/assets/js/225.45220dd3.js"><link rel="prefetch" href="/luvue/assets/js/226.0b9b7a79.js"><link rel="prefetch" href="/luvue/assets/js/227.0eaaaaf4.js"><link rel="prefetch" href="/luvue/assets/js/228.382e9e0e.js"><link rel="prefetch" href="/luvue/assets/js/229.3ae1b558.js"><link rel="prefetch" href="/luvue/assets/js/23.c6b6dae9.js"><link rel="prefetch" href="/luvue/assets/js/230.d4487ee4.js"><link rel="prefetch" href="/luvue/assets/js/231.f2163054.js"><link rel="prefetch" href="/luvue/assets/js/232.df938b18.js"><link rel="prefetch" href="/luvue/assets/js/233.9330e97c.js"><link rel="prefetch" href="/luvue/assets/js/234.cc4ebd06.js"><link rel="prefetch" href="/luvue/assets/js/235.a222b8e0.js"><link rel="prefetch" href="/luvue/assets/js/236.25768542.js"><link rel="prefetch" href="/luvue/assets/js/237.38e66e45.js"><link rel="prefetch" href="/luvue/assets/js/238.55b39563.js"><link rel="prefetch" href="/luvue/assets/js/239.ae76877e.js"><link rel="prefetch" href="/luvue/assets/js/24.d1d8ef7c.js"><link rel="prefetch" href="/luvue/assets/js/240.924c3283.js"><link rel="prefetch" href="/luvue/assets/js/241.bcfcb6f8.js"><link rel="prefetch" href="/luvue/assets/js/242.7221bb51.js"><link rel="prefetch" href="/luvue/assets/js/243.19be8d64.js"><link rel="prefetch" href="/luvue/assets/js/244.b0ab537d.js"><link rel="prefetch" href="/luvue/assets/js/245.c9903538.js"><link rel="prefetch" href="/luvue/assets/js/246.7c7b2b9c.js"><link rel="prefetch" href="/luvue/assets/js/247.773b9f34.js"><link rel="prefetch" href="/luvue/assets/js/248.094da9b6.js"><link rel="prefetch" href="/luvue/assets/js/249.2c6cf0c1.js"><link rel="prefetch" href="/luvue/assets/js/25.541ff376.js"><link rel="prefetch" href="/luvue/assets/js/250.fb1d17fd.js"><link rel="prefetch" href="/luvue/assets/js/251.fcc04c86.js"><link rel="prefetch" href="/luvue/assets/js/252.3a8d2b0b.js"><link rel="prefetch" href="/luvue/assets/js/253.6225bd1a.js"><link rel="prefetch" href="/luvue/assets/js/254.9d4efc27.js"><link rel="prefetch" href="/luvue/assets/js/255.84f219e2.js"><link rel="prefetch" href="/luvue/assets/js/256.dce304d6.js"><link rel="prefetch" href="/luvue/assets/js/257.597148bd.js"><link rel="prefetch" href="/luvue/assets/js/258.86361cde.js"><link rel="prefetch" href="/luvue/assets/js/259.f963bf59.js"><link rel="prefetch" href="/luvue/assets/js/26.aa800826.js"><link rel="prefetch" href="/luvue/assets/js/260.3a2b7c24.js"><link rel="prefetch" href="/luvue/assets/js/261.8b31c343.js"><link rel="prefetch" href="/luvue/assets/js/262.9bc9b4ed.js"><link rel="prefetch" href="/luvue/assets/js/263.cf027585.js"><link rel="prefetch" href="/luvue/assets/js/264.fdd59d42.js"><link rel="prefetch" href="/luvue/assets/js/265.92a6c3e1.js"><link rel="prefetch" href="/luvue/assets/js/266.6dff3d79.js"><link rel="prefetch" href="/luvue/assets/js/267.748610ba.js"><link rel="prefetch" href="/luvue/assets/js/268.7403658e.js"><link rel="prefetch" href="/luvue/assets/js/269.b06f9631.js"><link rel="prefetch" href="/luvue/assets/js/27.234a1646.js"><link rel="prefetch" href="/luvue/assets/js/270.7b4756b5.js"><link rel="prefetch" href="/luvue/assets/js/271.555a52f0.js"><link rel="prefetch" href="/luvue/assets/js/272.d7885b5c.js"><link rel="prefetch" href="/luvue/assets/js/273.f2233d66.js"><link rel="prefetch" href="/luvue/assets/js/274.723b3e19.js"><link rel="prefetch" href="/luvue/assets/js/275.4048adb4.js"><link rel="prefetch" href="/luvue/assets/js/276.2f1e1578.js"><link rel="prefetch" href="/luvue/assets/js/277.cbba2bac.js"><link rel="prefetch" href="/luvue/assets/js/278.53995e86.js"><link rel="prefetch" href="/luvue/assets/js/279.4f6ccf8b.js"><link rel="prefetch" href="/luvue/assets/js/28.f5cb3cd0.js"><link rel="prefetch" href="/luvue/assets/js/280.673b10f1.js"><link rel="prefetch" href="/luvue/assets/js/281.c68eaa9d.js"><link rel="prefetch" href="/luvue/assets/js/282.daf11127.js"><link rel="prefetch" href="/luvue/assets/js/283.f9098504.js"><link rel="prefetch" href="/luvue/assets/js/284.6e81376b.js"><link rel="prefetch" href="/luvue/assets/js/285.0886b889.js"><link rel="prefetch" href="/luvue/assets/js/286.fac16ac5.js"><link rel="prefetch" href="/luvue/assets/js/287.06875def.js"><link rel="prefetch" href="/luvue/assets/js/288.f1c3ab86.js"><link rel="prefetch" href="/luvue/assets/js/289.5fa60820.js"><link rel="prefetch" href="/luvue/assets/js/29.d66372db.js"><link rel="prefetch" href="/luvue/assets/js/290.30e32d07.js"><link rel="prefetch" href="/luvue/assets/js/291.ba2fabdb.js"><link rel="prefetch" href="/luvue/assets/js/292.1e88c8f2.js"><link rel="prefetch" href="/luvue/assets/js/293.46d9f2af.js"><link rel="prefetch" href="/luvue/assets/js/294.9e9e9a97.js"><link rel="prefetch" href="/luvue/assets/js/295.51089eeb.js"><link rel="prefetch" href="/luvue/assets/js/296.e3aa873c.js"><link rel="prefetch" href="/luvue/assets/js/297.80bbdcce.js"><link rel="prefetch" href="/luvue/assets/js/298.5a37e3df.js"><link rel="prefetch" href="/luvue/assets/js/299.6cc42bda.js"><link rel="prefetch" href="/luvue/assets/js/30.dc058ead.js"><link rel="prefetch" href="/luvue/assets/js/300.607335b0.js"><link rel="prefetch" href="/luvue/assets/js/301.395651cb.js"><link rel="prefetch" href="/luvue/assets/js/302.4d29a7f4.js"><link rel="prefetch" href="/luvue/assets/js/31.023e058b.js"><link rel="prefetch" href="/luvue/assets/js/32.c38eba45.js"><link rel="prefetch" href="/luvue/assets/js/33.96ae807e.js"><link rel="prefetch" href="/luvue/assets/js/34.e0ca9d9d.js"><link rel="prefetch" href="/luvue/assets/js/35.1ef08ee2.js"><link rel="prefetch" href="/luvue/assets/js/36.9f317212.js"><link rel="prefetch" href="/luvue/assets/js/37.4edf1dd8.js"><link rel="prefetch" href="/luvue/assets/js/38.16c29e38.js"><link rel="prefetch" href="/luvue/assets/js/39.2a932be2.js"><link rel="prefetch" href="/luvue/assets/js/4.0b4fc096.js"><link rel="prefetch" href="/luvue/assets/js/40.82cb02c3.js"><link rel="prefetch" href="/luvue/assets/js/41.12394088.js"><link rel="prefetch" href="/luvue/assets/js/42.d2fa2e92.js"><link rel="prefetch" href="/luvue/assets/js/43.1cb4fd05.js"><link rel="prefetch" href="/luvue/assets/js/44.66674ed7.js"><link rel="prefetch" href="/luvue/assets/js/45.eb01a397.js"><link rel="prefetch" href="/luvue/assets/js/46.c87680a3.js"><link rel="prefetch" href="/luvue/assets/js/47.3b88dbdc.js"><link rel="prefetch" href="/luvue/assets/js/48.f9343fda.js"><link rel="prefetch" href="/luvue/assets/js/49.ac55888f.js"><link rel="prefetch" href="/luvue/assets/js/5.768ccd03.js"><link rel="prefetch" href="/luvue/assets/js/50.f7b99ab4.js"><link rel="prefetch" href="/luvue/assets/js/51.adbf4796.js"><link rel="prefetch" href="/luvue/assets/js/52.2f534912.js"><link rel="prefetch" href="/luvue/assets/js/53.cc8c809f.js"><link rel="prefetch" href="/luvue/assets/js/54.386d731a.js"><link rel="prefetch" href="/luvue/assets/js/55.3f6022b7.js"><link rel="prefetch" href="/luvue/assets/js/56.a651fa0f.js"><link rel="prefetch" href="/luvue/assets/js/57.e4dcd280.js"><link rel="prefetch" href="/luvue/assets/js/58.ccf3ec02.js"><link rel="prefetch" href="/luvue/assets/js/59.b9647de8.js"><link rel="prefetch" href="/luvue/assets/js/6.ac3e0798.js"><link rel="prefetch" href="/luvue/assets/js/60.93806c99.js"><link rel="prefetch" href="/luvue/assets/js/61.89498686.js"><link rel="prefetch" href="/luvue/assets/js/62.15faac6d.js"><link rel="prefetch" href="/luvue/assets/js/63.9d855c5d.js"><link rel="prefetch" href="/luvue/assets/js/64.ba1547e2.js"><link rel="prefetch" href="/luvue/assets/js/66.42c645cb.js"><link rel="prefetch" href="/luvue/assets/js/67.fc7bf953.js"><link rel="prefetch" href="/luvue/assets/js/68.b048c6f4.js"><link rel="prefetch" href="/luvue/assets/js/69.cd1ca1b0.js"><link rel="prefetch" href="/luvue/assets/js/7.0c495c55.js"><link rel="prefetch" href="/luvue/assets/js/70.de796229.js"><link rel="prefetch" href="/luvue/assets/js/71.79fbccd7.js"><link rel="prefetch" href="/luvue/assets/js/72.ef920547.js"><link rel="prefetch" href="/luvue/assets/js/73.7aad1269.js"><link rel="prefetch" href="/luvue/assets/js/74.70e82141.js"><link rel="prefetch" href="/luvue/assets/js/75.7c695c09.js"><link rel="prefetch" href="/luvue/assets/js/76.ebb5ed1a.js"><link rel="prefetch" href="/luvue/assets/js/77.1b4696ba.js"><link rel="prefetch" href="/luvue/assets/js/78.17fbd9e8.js"><link rel="prefetch" href="/luvue/assets/js/79.347e97c2.js"><link rel="prefetch" href="/luvue/assets/js/8.3505ba5a.js"><link rel="prefetch" href="/luvue/assets/js/80.a68ac880.js"><link rel="prefetch" href="/luvue/assets/js/81.29697f3f.js"><link rel="prefetch" href="/luvue/assets/js/82.19ca69f9.js"><link rel="prefetch" href="/luvue/assets/js/83.46ead34f.js"><link rel="prefetch" href="/luvue/assets/js/84.e67d55b4.js"><link rel="prefetch" href="/luvue/assets/js/85.9d228e88.js"><link rel="prefetch" href="/luvue/assets/js/86.43b52482.js"><link rel="prefetch" href="/luvue/assets/js/87.a3a73d27.js"><link rel="prefetch" href="/luvue/assets/js/88.f1caa267.js"><link rel="prefetch" href="/luvue/assets/js/89.1e0c098e.js"><link rel="prefetch" href="/luvue/assets/js/9.65549bfc.js"><link rel="prefetch" href="/luvue/assets/js/90.814a1362.js"><link rel="prefetch" href="/luvue/assets/js/91.604291e4.js"><link rel="prefetch" href="/luvue/assets/js/92.f66726d9.js"><link rel="prefetch" href="/luvue/assets/js/93.46431418.js"><link rel="prefetch" href="/luvue/assets/js/94.c9f65d27.js"><link rel="prefetch" href="/luvue/assets/js/95.9217bd28.js"><link rel="prefetch" href="/luvue/assets/js/96.72450da7.js"><link rel="prefetch" href="/luvue/assets/js/97.1e48a1d5.js"><link rel="prefetch" href="/luvue/assets/js/98.b5889720.js"><link rel="prefetch" href="/luvue/assets/js/99.2635376c.js">
    <link rel="stylesheet" href="/luvue/assets/css/0.styles.0c275c11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/luvue/" class="home-link router-link-active"><!----> <span class="site-name">Ailjc notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link router-link-active">工程化</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link router-link-active">工程化</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/Loader/" class="sidebar-heading clickable"><span>Loader</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/Tabable/" class="sidebar-heading clickable"><span>Tabable</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/Vite/" class="sidebar-heading clickable"><span>Vite</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/babel/" class="sidebar-heading clickable"><span>babel</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/other/" class="sidebar-heading clickable"><span>other</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/rollup/" class="sidebar-heading clickable router-link-active open"><span>rollup</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/luvue/engineering/rollup/01-10分钟快速入门rollupJs1.html" class="sidebar-link">01-10分钟快速入门rollupJs1</a></li><li><a href="/luvue/engineering/rollup/02-10分钟快速进阶rollupJs2.html" class="sidebar-link">02-10分钟快速进阶rollupJs2</a></li><li><a href="/luvue/engineering/rollup/03-rollup.html" class="sidebar-link">03-rollup</a></li><li><a href="/luvue/engineering/rollup/04-手写Rollup.html" class="sidebar-link">04-手写Rollup</a></li><li><a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html" class="sidebar-link">05-rollup构建原理及简易实现</a></li><li><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html" class="active sidebar-link">06-从0到1解读rollup-Plugin</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#rollup-为什么需要-plugin" class="sidebar-link">rollup 为什么需要 Plugin</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#rollup-c-打包流程" class="sidebar-link">rollup -c 打包流程</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#理解-rollup-plugin" class="sidebar-link">理解 rollup plugin</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#分分钟写个-rollup-插件" class="sidebar-link">分分钟写个 rollup 插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#插件其实很简单" class="sidebar-link">插件其实很简单</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#一个例子" class="sidebar-link">一个例子</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#rollup-plugin-功能的实现" class="sidebar-link">rollup plugin 功能的实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#钩子函数的调用时机" class="sidebar-link">钩子函数的调用时机</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#钩子函数处理方式分类" class="sidebar-link">钩子函数处理方式分类</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#构建钩子函数" class="sidebar-link">构建钩子函数</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#输出钩子函数" class="sidebar-link">输出钩子函数</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#钩子函数加载实现" class="sidebar-link">钩子函数加载实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#_1-hookfirst" class="sidebar-link">1. hookFirst</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#_2-hookfirstsync" class="sidebar-link">2. hookFirstSync</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#_3-hookparallel" class="sidebar-link">3. hookParallel</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#_4-hookreducearg0" class="sidebar-link">4.hookReduceArg0</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#_5-hookreducearg0sync" class="sidebar-link">5.hookReduceArg0Sync</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#_6-hookreducevalue" class="sidebar-link">6. hookReduceValue</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#_7-hookreducevaluesync" class="sidebar-link">7. hookReduceValueSync</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#_8-hookseq" class="sidebar-link">8. hookSeq</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#_9-hookseqsync" class="sidebar-link">9.hookSeqSync</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#runhook-sync" class="sidebar-link">runHook(Sync)</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#rollup-rollup" class="sidebar-link">rollup.rollup()</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#build-阶段" class="sidebar-link">build 阶段</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#generate-阶段" class="sidebar-link">generate 阶段</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#小结" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#插件上下文" class="sidebar-link">插件上下文</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#插件的缓存" class="sidebar-link">插件的缓存</a></li><li class="sidebar-sub-header"><a href="/luvue/engineering/rollup/06-从0到1解读rollup-Plugin.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/luvue/engineering/rollup/07-项目减重之rollup的Tree-shaking.html" class="sidebar-link">07-项目减重之rollup的Tree-shaking</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/vue-cli/" class="sidebar-heading clickable"><span>vue-cli</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/webpack/" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/engineering/webpack2/" class="sidebar-heading clickable"><span>webpack2</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="从-0-到-1-解读-rollup-plugin"><a href="#从-0-到-1-解读-rollup-plugin" class="header-anchor">#</a> 从 0 到 1 解读 rollup Plugin</h1> <p></p><div class="table-of-contents"><ul><li><a href="#rollup-为什么需要-plugin">rollup 为什么需要 Plugin</a><ul><li><a href="#rollup-c-打包流程">rollup -c 打包流程</a></li><li><a href="#理解-rollup-plugin">理解 rollup plugin</a></li></ul></li><li><a href="#分分钟写个-rollup-插件">分分钟写个 rollup 插件</a><ul><li><a href="#插件其实很简单">插件其实很简单</a></li><li><a href="#一个例子">一个例子</a></li></ul></li><li><a href="#rollup-plugin-功能的实现">rollup plugin 功能的实现</a><ul><li><a href="#钩子函数的调用时机">钩子函数的调用时机</a></li><li><a href="#钩子函数处理方式分类">钩子函数处理方式分类</a></li><li><a href="#构建钩子函数">构建钩子函数</a></li><li><a href="#输出钩子函数">输出钩子函数</a></li></ul></li><li><a href="#钩子函数加载实现">钩子函数加载实现</a><ul><li><a href="#_1-hookfirst">1. hookFirst</a></li><li><a href="#_2-hookfirstsync">2. hookFirstSync</a></li><li><a href="#_3-hookparallel">3. hookParallel</a></li><li><a href="#_4-hookreducearg0">4.hookReduceArg0</a></li><li><a href="#_5-hookreducearg0sync">5.hookReduceArg0Sync</a></li><li><a href="#_6-hookreducevalue">6. hookReduceValue</a></li><li><a href="#_7-hookreducevaluesync">7. hookReduceValueSync</a></li><li><a href="#_8-hookseq">8. hookSeq</a></li><li><a href="#_9-hookseqsync">9.hookSeqSync</a></li></ul></li><li><a href="#runhook-sync">runHook(Sync)</a></li><li><a href="#rollup-rollup">rollup.rollup()</a><ul><li><a href="#build-阶段">build 阶段</a></li><li><a href="#generate-阶段">generate 阶段</a></li><li><a href="#小结">小结</a></li></ul></li><li><a href="#插件上下文">插件上下文</a></li><li><a href="#插件的缓存">插件的缓存</a></li><li><a href="#总结">总结</a></li></ul></div><p></p> <h2 id="rollup-为什么需要-plugin"><a href="#rollup-为什么需要-plugin" class="header-anchor">#</a> rollup 为什么需要 Plugin</h2> <h3 id="rollup-c-打包流程"><a href="#rollup-c-打包流程" class="header-anchor">#</a> rollup -c 打包流程</h3> <p>在 rollup 的打包流程中，通过相对路径，将一个入口文件和一个模块创建成了一个简单的 <code>bundle</code>。随着构建更复杂的 bundle，通常需要更大的灵活性——引入 npm 安装的模块、通过 <code>Babel</code> 编译代码、和 JSON 文件打交道等。通过 rollup -c 打包的实现流程可以参考下面的流程图理解。</p> <div align="center"><img src="/luvue/images/rollup/rollup7.awebp" alt="rollup/rollup7.awebp"></div> <p>为此，我们可以通过 <code>插件(plugins)</code> 在打包的关键过程(<a href="https://rollupjs.org/guide/en/#build-hooks" target="_blank" rel="noopener noreferrer">不同阶段调用的钩子函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)中更改 <code>Rollup</code> 的行为。</p> <p>这其实和 webpack 的插件相类似，不同的是，webpack 区分 <code>loader</code> 和 <code>plugin</code>，而 rollup 的 plugin 既可以担任 loader 的角色，也可以胜任传统 plugin 的角色。
​</p> <h3 id="理解-rollup-plugin"><a href="#理解-rollup-plugin" class="header-anchor">#</a> 理解 rollup plugin</h3> <p>引用官网的解释：</p> <blockquote><p>Rollup 插件是一个具有下面描述的一个或多个属性、构建钩子和输出生成钩子的对象，它遵循我们的约定。<br>
一个插件应该作为一个包来分发，该包导出一个可以用插件特定选项调用的函数，并返回这样一个对象。<br>
插件允许你定制 Rollup 的行为，例如，在捆绑之前编译代码，或者在你的 node_modules 文件夹中找到第三方模块。</p></blockquote> <p>简单来说，rollup 的插件是一个普通的函数，函数返回一个对象，该对象包含一些属性(如 name)，和不同阶段的钩子函数（构建 build 和输出 output 阶段），此处应该回顾下上面的流程图。​</p> <p>关于约定</p> <ul><li>插件应该有一个带有 rollup-plugin-前缀的明确名称。</li> <li>在 package.json 中包含 rollup-plugin 关键字。</li> <li>插件应该支持测试，推荐 mocha 或者 ava 这类开箱支持 promises 的库。</li> <li>尽可能使用异步方法。</li> <li>用英语记录你的插件。</li> <li>确保你的插件输出正确的  sourcemap。</li> <li>如果你的插件使用 'virtual modules'（比如帮助函数），给模块名加上  \0  前缀。这可以阻止其他插件执行它。</li></ul> <h2 id="分分钟写个-rollup-插件"><a href="#分分钟写个-rollup-插件" class="header-anchor">#</a> 分分钟写个 rollup 插件</h2> <h3 id="插件其实很简单"><a href="#插件其实很简单" class="header-anchor">#</a> 插件其实很简单</h3> <p>可以打开<a href="https://github.com/rollup/plugins" target="_blank" rel="noopener noreferrer">rollup  插件列表<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，随便找个你感兴趣的插件，看下源代码。
​
有不少插件都是几十行，不超过 100 行的。比如图片文件多格式支持插件<code>@rollup/plugin-image</code> 的代码甚至不超过 50 行，而将 json 文件转换为 ES6 模块的插件 <code>@rollup/plugin-json</code> 源代码更少。</p> <h3 id="一个例子"><a href="#一个例子" class="header-anchor">#</a> 一个例子</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 官网的一个例子</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">myExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'my-example'</span><span class="token punctuation">,</span> <span class="token comment">// 名字用来展示在警告和报错中</span>
    <span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">===</span> <span class="token string">'virtual-module'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> source<span class="token punctuation">;</span> <span class="token comment">// rollup 不应该查询其他插件或文件系统</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// other ids 正常处理</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">'virtual-module'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'export default &quot;This is virtual!&quot;'</span><span class="token punctuation">;</span> <span class="token comment">// source code for &quot;virtual-module&quot;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// other ids</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// rollup.config.js</span>
<span class="token keyword">import</span> myExample <span class="token keyword">from</span> <span class="token string">'./rollup-plugin-my-example.js'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">'virtual-module'</span><span class="token punctuation">,</span> <span class="token comment">// 配置 virtual-module 作为入口文件满足条件通过上述插件处理</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">myExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'es'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>光看不练假把式，模仿写一个：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 自己编的一个例子 QAQ</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">bundleReplace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'bundle-replace'</span><span class="token punctuation">,</span> <span class="token comment">// 名字用来展示在警告和报错中</span>
    <span class="token function">transform</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> bundle<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'key_word'</span><span class="token punctuation">,</span> <span class="token string">'replace_word'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">正则</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'替换内容'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// rollup.config.js</span>
<span class="token keyword">import</span> bundleReplace <span class="token keyword">from</span> <span class="token string">'./rollup-plugin-bundle-replace.js'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  input<span class="token operator">:</span> <span class="token string">'src/main.js'</span><span class="token punctuation">,</span> <span class="token comment">// 通用入口文件</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">bundleReplace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      file<span class="token operator">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>
      format<span class="token operator">:</span> <span class="token string">'es'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="rollup-plugin-功能的实现"><a href="#rollup-plugin-功能的实现" class="header-anchor">#</a> rollup plugin 功能的实现</h2> <p>我们要讲的 rollup plugin 也不可能就这么简单啦~~~<br>
接下来当然是结合例子分析实现原理~~</p> <p>再次解释一下：<br>
官方给出的例子中，插件函数导出模块中的 resolveId()和 load()是 rollup 中的两个钩子函数，笔者所写的正则转换插件中导出的 transform()也是 rollup 提供的钩子函数，下面将会介绍，根据钩子函数的三类调用时机划分众多钩子函数，而具体详细的钩子函数，和执行阶段可以参考官方文档。</p> <p>其实不难发现，rollup 的插件配置与 webpack 等框架中的插件使用大同小异，都是提供配置选项，注入当前构建结果相关的属性与方法，供开发者进行增删改查操作。</p> <p>那么插件写好了，rollup 是如何在打包过程中调用它并实现它的功能的呢？</p> <p><strong>相关概念</strong></p> <p>首先还是要了解必备的前置知识，大致浏览下 <code>rollup</code> 中处理 <code>plugin</code> 的方法，基本可以定位到 <code>PluginContext.ts</code>（上下文相关）、<code>PluginDriver.ts</code>（驱动相关）、<code>PluginCache.ts</code>（缓存相关）和 <code>PluginUtils.ts</code>（警告错误异常处理）等文件，其中最关键的就在 <code>PluginDriver.ts</code> 中了。</p> <p>首先要清楚插件驱动的概念，它是实现插件提供功能的的核心 -- <code>PluginDriver</code>，插件驱动器，调用插件和提供插件环境上下文等。</p> <h3 id="钩子函数的调用时机"><a href="#钩子函数的调用时机" class="header-anchor">#</a> 钩子函数的调用时机</h3> <p>大家在研究 rollup 插件的时候，最关注的莫过于钩子函数部分了，钩子函数的调用时机有三类:</p> <ul><li>const chunks = rollup.rollup 执行期间的构建钩子函数 - <a href="https%3A%2F%2Frollupjs.org%2Fguide%2Fen%2F%23build-hooks">Build Hooks</a></li> <li>chunks.generator(write)执行期间的输出钩子函数 - <a href="https%3A%2F%2Frollupjs.org%2Fguide%2Fen%2F%23output-generation-hooks">Output Generation Hooks</a></li> <li>监听文件变化并重新执行构建的 rollup.watch 执行期间的 watchChange 钩子函数</li></ul> <h3 id="钩子函数处理方式分类"><a href="#钩子函数处理方式分类" class="header-anchor">#</a> 钩子函数处理方式分类</h3> <p>除了以调用时机来划分钩子函数以外，我们还可以以钩子函数处理方式来划分，这样来看钩子函数就主要有以下四种版本：</p> <ul><li><code>async</code>: 处理 <code>promise</code> 的异步钩子，即这类 <code>hook</code> 可以返回一个解析为相同类型值的 <code>promise</code>，同步版本 <code>hook</code> 将被标记为  <code>sync</code>。</li> <li><code>first</code>: 如果多个插件实现了相同的钩子函数，那么会串式执行，从头到尾，但是，如果其中某个的返回值不是 <code>null</code> 也不是 <code>undefined</code> 的话，会直接终止掉后续插件。</li> <li><code>sequential</code>: 如果多个插件实现了相同的钩子函数，那么会串式执行，按照使用插件的顺序从头到尾执行，如果是异步的，会等待之前处理完毕，在执行下一个插件。</li> <li><code>parallel</code>: 同上，不过如果某个插件是异步的，其后的插件不会等待，而是并行执行，这个也就是我们在 <code>rollup.rollup()</code> 阶段看到的处理方式。</li></ul> <h3 id="构建钩子函数"><a href="#构建钩子函数" class="header-anchor">#</a> 构建钩子函数</h3> <p>为了与构建过程交互，你的插件对象需要包含一些构建钩子函数。<strong>构建钩子是构建的各个阶段调用的函数</strong>。构建钩子函数可以影响构建执行方式、提供构建的信息或者在构建完成后修改构建。rollup 中有不同的构建钩子函数，在构建阶段执行时，它们被 <a href="https://github.com/rollup/rollup/blob/07b3a02069594147665daa95d3fa3e041a82b2d0/cli/run/build.ts#L34" target="_blank" rel="noopener noreferrer">rollup.rollup(inputOptions)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 触发。
​
构建钩子函数主要关注在 Rollup 处理输入文件之前定位、提供和转换输入文件。构建阶段的第一个钩子是 <code>options</code>，最后一个钩子总是 <code>buildEnd</code>，除非有一个构建错误，在这种情况下 <code>closeBundle</code> 将在这之后被调用。</p> <p>顺便提一下，在观察模式下，<code>watchChange</code> 钩子可以在任何时候被触发，以通知新的运行将在当前运行产生其输出后被触发。当 <code>watcher</code> 关闭时，<code>closeWatcher</code> 钩子函数将被触发。</p> <h3 id="输出钩子函数"><a href="#输出钩子函数" class="header-anchor">#</a> 输出钩子函数</h3> <p>输出生成钩子函数可以提供关于生成的包的信息并在构建完成后立马执行。它们和构建钩子函数拥有一样的工作原理和相同的类型，但是不同的是它们分别被 ·<a href="https://github.com/rollup/rollup/blob/07b3a02069594147665daa95d3fa3e041a82b2d0/cli/run/build.ts#L44" target="_blank" rel="noopener noreferrer">bundle.generate(output)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或 <a href="https://github.com/rollup/rollup/blob/07b3a02069594147665daa95d3fa3e041a82b2d0/cli/run/build.ts#L64" target="_blank" rel="noopener noreferrer">bundle.write(outputOptions)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 调用。只使用输出生成钩子的插件也可以通过输出选项传入，因为只对某些输出运行。</p> <p>输出生成阶段的第一个钩子函数是 <a href="https%3A%2F%2Fgithub.com%2Frollup%2Frollup%2Fblob%2F07b3a02069594147665daa95d3fa3e041a82b2d0%2Fsrc%2FBundle.ts%23L50">outputOptions</a>，如果输出通过 <a href="https%3A%2F%2Fgithub.com%2Frollup%2Frollup%2Fblob%2Fmaster%2Fcli%2Frun%2Fbuild.ts%23L44">bundle.generate(...)</a> 成功生成则第一个钩子函数是 <a href="https%3A%2F%2Fgithub.com%2Frollup%2Frollup%2Fblob%2Fmaster%2Fsrc%2FBundle.ts%23L73">generateBundle</a>，如果输出通过 <a href="https://github.com/rollup/rollup/blob/07b3a02069594147665daa95d3fa3e041a82b2d0/src/watch/watch.ts#L200" target="_blank" rel="noopener noreferrer">bundle.write(...)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 生成则最后一个钩子函数是 <a href="https://github.com/rollup/rollup/blob/master/src/rollup/rollup.ts#L176" target="_blank" rel="noopener noreferrer">writeBundle<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，另外如果输出生成阶段发生了错误的话，最后一个钩子函数则是 <a href="https%3A%2F%2Fgithub.com%2Frollup%2Frollup%2Fblob%2Fmaster%2Fsrc%2FBundle.ts%23L70">renderError</a>。</p> <p>另外，<a href="https%3A%2F%2Fgithub.com%2Frollup%2Frollup%2Fblob%2Fmaster%2Fsrc%2Frollup%2Frollup.ts%23L59">closeBundle</a> 可以作为最后一个钩子被调用，但用户有责任手动调用 <code>bundle.close()</code> 来触发它。CLI 将始终确保这种情况发生。</p> <p>以上就是必须要知道的概念了，读到这里好像还是看不明白这些钩子函数到底是干啥的！那么接下来进入正题！
​</p> <h2 id="钩子函数加载实现"><a href="#钩子函数加载实现" class="header-anchor">#</a> 钩子函数加载实现</h2> <p><a href="https://github.com/rollup/rollup/blob/07b3a02069594147665daa95d3fa3e041a82b2d0/src/utils/PluginDriver.ts#L124" target="_blank" rel="noopener noreferrer">PluginDriver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  中有 9 个 hook 加载函数。主要是因为每种类别的 hook 都有同步和异步的版本。
​
接下来先看看 9 个 <code>hook</code> 加载函数及其应用场景（看完第一遍不知所以然，但是别人看了咱也得看，先看了再说，看不懂就多看几遍 QAQ ～）
​
排名不分先后，仅参考它们在 <code>PluginDriver.ts</code> 中出现的顺序 🌠。
​</p> <div align="center"><img src="/luvue/images/rollup/rollup8.awebp" alt="rollup/rollup8.awebp"></div> <h3 id="_1-hookfirst"><a href="#_1-hookfirst" class="header-anchor">#</a> 1. hookFirst</h3> <p>加载 <code>first</code> 类型的钩子函数，场景有  <code>resolveId</code>、<code>resolveAssetUrl</code>  等，在实例化 Graph 的时候，初始化初始化 promise 和 this.plugins，并通过覆盖之前的 promise，实现串行执行钩子函数。当多个插件实现了相同的钩子函数时从头到尾串式执行，如果其中某个的返回值不是 null 也不是 undefined 的话，就会直接终止掉后续插件。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">hookFirst</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">H</span> <span class="token keyword">extends</span> <span class="token keyword">keyof</span> PluginHooks<span class="token punctuation">,</span> <span class="token constant">R</span> <span class="token operator">=</span> ReturnType<span class="token operator">&lt;</span>PluginHooks<span class="token punctuation">[</span><span class="token constant">H</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span>
  hookName<span class="token operator">:</span> <span class="token constant">H</span><span class="token punctuation">,</span>
  args<span class="token operator">:</span> Args<span class="token operator">&lt;</span>PluginHooks<span class="token punctuation">[</span><span class="token constant">H</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  replaceContext<span class="token operator">?</span><span class="token operator">:</span> ReplaceContext <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  skip<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token operator">:</span> EnsurePromise<span class="token operator">&lt;</span><span class="token constant">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化 promise</span>
  <span class="token keyword">let</span> promise<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 实例化 Graph 的时候，初始化 this.plugins</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>skip <span class="token operator">===</span> i<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token comment">// 覆盖之前的 promise，即串行执行钩子函数</span>
    promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回非 null 或 undefined 的时候，停止运行，返回结果</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span>
      <span class="token comment">// 执行钩子函数</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runHook</span><span class="token punctuation">(</span>hookName<span class="token punctuation">,</span> args <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> replaceContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 返回 hook 过的 promise</span>
  <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="_2-hookfirstsync"><a href="#_2-hookfirstsync" class="header-anchor">#</a> 2. hookFirstSync</h3> <p><code>hookFirst</code> 的同步版本，使用场景有 <code>resolveFileUrl</code>、<code>resolveImportMeta</code> 等。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">hookFirstSync</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">H</span> <span class="token keyword">extends</span> <span class="token keyword">keyof</span> PluginHooks<span class="token punctuation">,</span> <span class="token constant">R</span> <span class="token operator">=</span> ReturnType<span class="token operator">&lt;</span>PluginHooks<span class="token punctuation">[</span><span class="token constant">H</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span>
  hookName<span class="token operator">:</span> <span class="token constant">H</span><span class="token punctuation">,</span>
  args<span class="token operator">:</span> Args<span class="token operator">&lt;</span>PluginHooks<span class="token punctuation">[</span><span class="token constant">H</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  replaceContext<span class="token operator">?</span><span class="token operator">:</span> ReplaceContext
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">R</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// runHook 的同步版本</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runHookSync</span><span class="token punctuation">(</span>hookName<span class="token punctuation">,</span> args<span class="token punctuation">,</span> i<span class="token punctuation">,</span> replaceContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回非 null 或 undefined 的时候，停止运行，返回结果</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> result <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 否则返回 null</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_3-hookparallel"><a href="#_3-hookparallel" class="header-anchor">#</a> 3. hookParallel</h3> <p>并行执行 hook，不会等待当前 hook 完成。也就是说如果某个插件是异步的，其后的插件不会等待，而是并行执行。使用场景 <code>buildEnd</code>、<code>buildStart</code>、<code>moduleParsed</code> 等。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token generic-function"><span class="token function">hookParallel</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">H</span> <span class="token keyword">extends</span> AsyncPluginHooks <span class="token operator">&amp;</span> ParallelPluginHooks<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  hookName<span class="token operator">:</span> <span class="token constant">H</span><span class="token punctuation">,</span>
  args<span class="token operator">:</span> Parameters<span class="token operator">&lt;</span>PluginHooks<span class="token punctuation">[</span><span class="token constant">H</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  replaceContext<span class="token operator">?</span><span class="token operator">:</span> ReplaceContext
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> promises<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hookPromise <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runHook</span><span class="token punctuation">(</span>hookName<span class="token punctuation">,</span> args<span class="token punctuation">,</span> plugin<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> replaceContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hookPromise<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
    promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hookPromise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_4-hookreducearg0"><a href="#_4-hookreducearg0" class="header-anchor">#</a> 4.hookReduceArg0</h3> <p>对 arg 第一项进行 reduce 操作。使用场景: <code>options</code>、<code>renderChunk</code> 等。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">hookReduceArg0</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">H</span> <span class="token keyword">extends</span> <span class="token keyword">keyof</span> PluginHooks<span class="token punctuation">,</span> <span class="token constant">V</span><span class="token punctuation">,</span> <span class="token constant">R</span> <span class="token operator">=</span> ReturnType<span class="token operator">&lt;</span>PluginHooks<span class="token punctuation">[</span><span class="token constant">H</span><span class="token punctuation">]</span><span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span>
  hookName<span class="token operator">:</span> <span class="token constant">H</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>arg0<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 取出传入的数组的第一个参数，将剩余的置于一个数组中</span>
  reduce<span class="token operator">:</span> Reduce<span class="token operator">&lt;</span><span class="token constant">V</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  replaceContext<span class="token operator">?</span><span class="token operator">:</span> ReplaceContext <span class="token comment">// 替换当前 plugin 调用时候的上下文环境</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认返回 source.code</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 第一个 promise 的时候只会接收到上面传递的 arg0</span>
    <span class="token comment">// 之后每一次 promise 接受的都是上一个插件处理过后的 source.code 值</span>
    promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>arg0 <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> hookPromise <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runHook</span><span class="token punctuation">(</span>hookName<span class="token punctuation">,</span> <span class="token punctuation">[</span>arg0<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> replaceContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果没有返回 promise，那么直接返回 arg0</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hookPromise<span class="token punctuation">)</span> <span class="token keyword">return</span> arg0<span class="token punctuation">;</span>
      <span class="token comment">// result 代表插件执行完成的返回值</span>
      <span class="token keyword">return</span> hookPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token function">reduce</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pluginContexts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> arg0<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="_5-hookreducearg0sync"><a href="#_5-hookreducearg0sync" class="header-anchor">#</a> 5.hookReduceArg0Sync</h3> <p><code>hookReduceArg0</code> 同步版本，使用场景 <code>transform</code>、<code>generateBundle</code> 等，不做赘述。</p> <h3 id="_6-hookreducevalue"><a href="#_6-hookreducevalue" class="header-anchor">#</a> 6. hookReduceValue</h3> <p>将返回值减少到类型 T，分别处理减少的值。允许钩子作为值。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token generic-function"><span class="token function">hookReduceValue</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">H</span> <span class="token keyword">extends</span> PluginValueHooks<span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
		hookName<span class="token operator">:</span> <span class="token constant">H</span><span class="token punctuation">,</span>
		initialValue<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
		args<span class="token operator">:</span> Parameters<span class="token operator">&lt;</span>AddonHookFunction<span class="token operator">&gt;</span><span class="token punctuation">,</span>
		<span class="token function-variable function">reduce</span><span class="token operator">:</span> <span class="token punctuation">(</span>
			reduction<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
			result<span class="token operator">:</span> ResolveValue<span class="token operator">&lt;</span>ReturnType<span class="token operator">&lt;</span>AddonHookFunction<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
			plugin<span class="token operator">:</span> Plugin
		<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
		replaceContext<span class="token operator">?</span><span class="token operator">:</span> ReplaceContext
	<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> hookPromise <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runHook</span><span class="token punctuation">(</span>hookName<span class="token punctuation">,</span> args<span class="token punctuation">,</span> plugin<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> replaceContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hookPromise<span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>
				<span class="token keyword">return</span> hookPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>result <span class="token operator">=&gt;</span>
					<span class="token function">reduce</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pluginContexts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> result<span class="token punctuation">,</span> plugin<span class="token punctuation">)</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> promise<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_7-hookreducevaluesync"><a href="#_7-hookreducevaluesync" class="header-anchor">#</a> 7. hookReduceValueSync</h3> <p>hookReduceValue 的同步版本。</p> <h3 id="_8-hookseq"><a href="#_8-hookseq" class="header-anchor">#</a> 8. hookSeq</h3> <p>加载  <code>sequential</code>  类型的钩子函数，和 <code>hookFirst</code> 的区别就是不能中断，使用场景有  <code>onwrite</code>、<code>generateBundle</code>  等。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">hookSeq</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">H</span> <span class="token keyword">extends</span> <span class="token keyword">keyof</span> PluginHooks<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  hookName<span class="token operator">:</span> <span class="token constant">H</span><span class="token punctuation">,</span>
  args<span class="token operator">:</span> Args<span class="token operator">&lt;</span>PluginHooks<span class="token punctuation">[</span><span class="token constant">H</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  replaceContext<span class="token operator">?</span><span class="token operator">:</span> ReplaceContext
  <span class="token comment">// hookFirst 通过 skip 参数决定是否跳过某个钩子函数</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> promise<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">runHook</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>hookName<span class="token punctuation">,</span> args <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> replaceContext<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_9-hookseqsync"><a href="#_9-hookseqsync" class="header-anchor">#</a> 9.hookSeqSync</h3> <p><code>hookSeq</code> 同步版本，不需要构造 promise，而是直接使用 <code>runHookSync</code> 执行钩子函数。使用场景有 <code>closeWatcher</code>、<code>watchChange</code> 等。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token generic-function"><span class="token function">hookSeqSync</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">H</span> <span class="token keyword">extends</span> SyncPluginHooks <span class="token operator">&amp;</span> SequentialPluginHooks<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  hookName<span class="token operator">:</span> <span class="token constant">H</span><span class="token punctuation">,</span>
  args<span class="token operator">:</span> Parameters<span class="token operator">&lt;</span>PluginHooks<span class="token punctuation">[</span><span class="token constant">H</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  replaceContext<span class="token operator">?</span><span class="token operator">:</span> ReplaceContext
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runHookSync</span><span class="token punctuation">(</span>hookName<span class="token punctuation">,</span> args<span class="token punctuation">,</span> plugin<span class="token punctuation">,</span> replaceContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>通过观察上面几种钩子函数的调用方式，我们可以发现，其内部有一个调用钩子函数的方法: runHook(Sync)(当然也分同步和异步版本)，该函数真正执行插件中提供的钩子函数。​</p> <p><code>也就是说，之前介绍了那么多的钩子函数，仅仅决定了我们插件的调用时机和调用方式(比如同步/异步)，而真正调用并执行插件函数(前面提到插件本身是个「函数」)的钩子其实是 runHook</code> 。</p> <h2 id="runhook-sync"><a href="#runhook-sync" class="header-anchor">#</a> runHook(Sync)</h2> <p>真正执行插件的钩子函数，同步版本和异步版本的区别是有无 permitValues 许可标识允许返回值而不是只允许返回函数。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">runHook</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  hookName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  pluginIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  permitValues<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  hookContext<span class="token operator">?</span><span class="token operator">:</span> ReplaceContext <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>previousHooks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>hookName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 找到当前 plugin</span>
  <span class="token keyword">const</span> plugin <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">[</span>pluginIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 找到当前执行的在 plugin 中定义的 hooks 钩子函数</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token punctuation">(</span>plugin <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>hookName<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hook<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">undefined</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

  <span class="token comment">// pluginContexts 在初始化 plugin 驱动器类的时候定义，是个数组，数组保存对应着每个插件的上下文环境</span>
  <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginContexts<span class="token punctuation">[</span>pluginIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 用于区分对待不同钩子函数的插件上下文</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hookContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context <span class="token operator">=</span> <span class="token function">hookContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 允许返回值，而不是一个函数钩子，使用 hookReduceValue 或 hookReduceValueSync 加载。</span>
      <span class="token comment">// 在 sync 同步版本钩子函数中，则没有 permitValues 许可标识允许返回值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> hook <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>permitValues<span class="token punctuation">)</span> <span class="token keyword">return</span> hook<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          code<span class="token operator">:</span> <span class="token string">'INVALID_PLUGIN_HOOK'</span><span class="token punctuation">,</span>
          message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error running plugin hook </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hookName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>plugin<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, expected a function hook.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 传入插件上下文和参数，返回插件执行结果</span>
      <span class="token keyword">return</span> <span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token function">throwPluginError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">{</span> hook<span class="token operator">:</span> hookName <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>看完这些钩子函数介绍，我们清楚了插件的调用时机、调用方式以及执行输出钩子函数。 但你以为这就结束了？？当然没有结束我们还要把这些钩子再带回 rollup 打包流程康康一下调用时机和调用方式的实例~~</p> <h2 id="rollup-rollup"><a href="#rollup-rollup" class="header-anchor">#</a> rollup.rollup()</h2> <p>又回到最初的起点~~~</p> <p>前面提到过，构建钩子函数在 Rollup 处理输入文件之前定位、提供和转换输入文件。那么当然要先从输入开始看起咯~</p> <h3 id="build-阶段"><a href="#build-阶段" class="header-anchor">#</a> build 阶段</h3> <h4 id=""><a href="#" class="header-anchor">#</a></h4> <p>处理 inputOptions</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 从处理 inputOptions 开始,你的插件钩子函数已到达！</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> options<span class="token operator">:</span> inputOptions<span class="token punctuation">,</span> unsetOptions<span class="token operator">:</span> unsetInputOptions <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getInputOptions</span><span class="token punctuation">(</span>
  rawInputOptions<span class="token punctuation">,</span>
  watcher <span class="token operator">!==</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>朋友们，把 async、first、sequential 和 parallel 以及 9 个钩子函数带上开搞！</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 处理 inputOptions 的应用场景下调用了 options 钩子</span>
<span class="token keyword">function</span> <span class="token function">applyOptionHook</span><span class="token punctuation">(</span>watchMode<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
    <span class="token comment">// 异步串行执行</span>
    inputOptions<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>GenericConfigObject<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    plugin<span class="token operator">:</span> Plugin
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>GenericConfigObject<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// plugin 配置存在</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">await</span> plugin<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span> meta<span class="token operator">:</span> <span class="token punctuation">{</span> rollupVersion<span class="token punctuation">,</span> watchMode <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 上下文</span>
          <span class="token keyword">await</span> inputOptions
        <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> GenericConfigObject<span class="token punctuation">)</span> <span class="token operator">||</span> inputOptions
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> inputOptions<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>接着标准化插件</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 标准化插件</span>
<span class="token keyword">function</span> <span class="token function">normalizePlugins</span><span class="token punctuation">(</span>plugins<span class="token operator">:</span> Plugin<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> anonymousPrefix<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> pluginIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pluginIndex <span class="token operator">&lt;</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> pluginIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> plugin <span class="token operator">=</span> plugins<span class="token punctuation">[</span>pluginIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plugin<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugin<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>anonymousPrefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="生成-graph-对象处理"><a href="#生成-graph-对象处理" class="header-anchor">#</a> 生成 graph 对象处理</h4> <p>重点来了！const graph = new Graph(inputOptions, watcher);里面就调用了我们上面介绍的一些关键钩子函数了～</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 不止处理缓存</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>pluginCache <span class="token operator">=</span> options<span class="token punctuation">.</span>cache<span class="token operator">?.</span>plugins <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 还有 WatchChangeHook 钩子</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>watchMode <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> handleChange<span class="token operator">:</span> <span class="token function-variable function">WatchChangeHook</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginDriver<span class="token punctuation">.</span><span class="token function">hookSeqSync</span><span class="token punctuation">(</span><span class="token string">'watchChange'</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hookSeq 同步版本,watchChange 使用场景下</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleClose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginDriver<span class="token punctuation">.</span><span class="token function">hookSeqSync</span><span class="token punctuation">(</span><span class="token string">'closeWatcher'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hookSeq 同步版本, closeWatcher 使用场景下</span>
  watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> handleChange<span class="token punctuation">)</span><span class="token punctuation">;</span>
  watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> handleClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
  watcher<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'restart'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    watcher<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> handleChange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    watcher<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> handleClose<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>pluginDriver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PluginDriver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginCache<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成一个插件驱动对象</span>
<span class="token operator">...</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>moduleLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modulesById<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginDriver<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化模块加载对象</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>到目前为止，处理 inputOptions 生成了 graph 对象，还记不记得！我们前面讲过_ graph 包含入口以及各种依赖的相互关系，操作方法，缓存等，在实例内部实现 AST 转换，是 rollup 的核心。</p> <p>我们还讲过！在*解析入口文件路径阶段，*为了_从入口文件的绝对路径出发找到它的模块定义，并获取这个入口模块所有的依赖语句，我们要先通过 resolveId()方法解析文件地址，拿到文件绝对路径。这个过程就是通过在 ModuleLoader 中调用 resolveId 完成的。resolveId() 我们在 tree-shaking 时讲到基本构建流程时已经介绍过的，下面看调用了钩子函数的具体方法~</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveIdViaPlugins</span><span class="token punctuation">(</span>
  source<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  importer<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  pluginDriver<span class="token operator">:</span> PluginDriver<span class="token punctuation">,</span>
  <span class="token function-variable function">moduleLoaderResolveId</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    source<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    importer<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    customOptions<span class="token operator">:</span> CustomPluginOptions <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    skip<span class="token operator">:</span> <span class="token punctuation">{</span> importer<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> plugin<span class="token operator">:</span> Plugin<span class="token punctuation">;</span> source<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ResolvedId <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  skip<span class="token operator">:</span> <span class="token punctuation">{</span> importer<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> plugin<span class="token operator">:</span> Plugin<span class="token punctuation">;</span> source<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  customOptions<span class="token operator">:</span> CustomPluginOptions <span class="token operator">|</span> <span class="token keyword">undefined</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> skipped<span class="token operator">:</span> Set<span class="token operator">&lt;</span>Plugin<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> replaceContext<span class="token operator">:</span> ReplaceContext <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>skip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    skipped <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> skippedCall <span class="token keyword">of</span> skip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">===</span> skippedCall<span class="token punctuation">.</span>source <span class="token operator">&amp;&amp;</span> importer <span class="token operator">===</span> skippedCall<span class="token punctuation">.</span>importer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        skipped<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>skippedCall<span class="token punctuation">.</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    replaceContext <span class="token operator">=</span> <span class="token punctuation">(</span>pluginContext<span class="token punctuation">,</span> plugin<span class="token punctuation">)</span><span class="token operator">:</span> PluginContext <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>pluginContext<span class="token punctuation">,</span>
      <span class="token function-variable function">resolve</span><span class="token operator">:</span> <span class="token punctuation">(</span>source<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> <span class="token punctuation">{</span> custom<span class="token punctuation">,</span> skipSelf <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">BLANK</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">moduleLoaderResolveId</span><span class="token punctuation">(</span>
          source<span class="token punctuation">,</span>
          importer<span class="token punctuation">,</span>
          custom<span class="token punctuation">,</span>
          skipSelf <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token operator">...</span>skip<span class="token punctuation">,</span> <span class="token punctuation">{</span> importer<span class="token punctuation">,</span> plugin<span class="token punctuation">,</span> source <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token operator">:</span> skip
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> pluginDriver<span class="token punctuation">.</span><span class="token function">hookFirst</span><span class="token punctuation">(</span>
    <span class="token comment">// hookFirst 被调用，通过插件处理获取就绝对路径，first 类型，如果有插件返回了值，那么后续所有插件的 resolveId 都不会被执行。</span>
    <span class="token string">'resolveId'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>source<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> <span class="token punctuation">{</span> custom<span class="token operator">:</span> customOptions <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    replaceContext<span class="token punctuation">,</span>
    skipped
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>拿到 resolveId hook 处理过返回的绝对路径后，就要从入口文件的绝对路径出发找到它的模块定义，并获取这个入口模块所有的依赖语句并返回所有内容。在这里，我们收集配置并标准化、分析文件并编译源码生成 AST、生成模块并解析依赖，最后生成 chunks，总而言之就是读取并修改文件！要注意的是，每个文件只会被一个插件的 load Hook 处理，因为它是以 hookFirst 来执行的。另外，如果你没有返回值，rollup 会自动读取文件。接下来进入 fetchModule 阶段~</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> module<span class="token operator">:</span> Module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginDriver<span class="token punctuation">.</span><span class="token function">hookParallel</span><span class="token punctuation">(</span><span class="token string">'moduleParsed'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>module<span class="token punctuation">.</span>info<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 并行执行 hook,moduleParsed 场景</span>
<span class="token operator">...</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addModuleSource</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span><span class="token comment">// addModuleSource</span>
source <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginDriver<span class="token punctuation">.</span><span class="token function">hookFirst</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">??</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在 load 阶段对代码进行转换、生成等操作</span>
<span class="token operator">...</span><span class="token comment">// resolveDynamicImport</span>
<span class="token keyword">const</span> resolution <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginDriver<span class="token punctuation">.</span><span class="token function">hookFirst</span><span class="token punctuation">(</span><span class="token string">'resolveDynamicImport'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  specifier<span class="token punctuation">,</span>
  importer
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="bundle-处理代码"><a href="#bundle-处理代码" class="header-anchor">#</a> bundle 处理代码</h4> <p>生成的 graph 对象准备进入 build 阶段~~build 开始与结束中的插件函数钩子</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">await</span> graph<span class="token punctuation">.</span>pluginDriver<span class="token punctuation">.</span><span class="token function">hookParallel</span><span class="token punctuation">(</span><span class="token string">'buildStart'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>inputOptions<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 并行执行 hook,buildStart 场景</span>
<span class="token operator">...</span>
<span class="token keyword">await</span> graph<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token keyword">await</span> graph<span class="token punctuation">.</span>pluginDriver<span class="token punctuation">.</span><span class="token function">hookParallel</span><span class="token punctuation">(</span><span class="token string">'buildEnd'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 并行执行 hook,buildEnd 场景</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果在 buildStart 和 build 阶段出现异常，就会提前触发处理 closeBundle 的 hookParallel 函数：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">await</span> graph<span class="token punctuation">.</span>pluginDriver<span class="token punctuation">.</span><span class="token function">hookParallel</span><span class="token punctuation">(</span><span class="token string">'closeBundle'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="generate-阶段"><a href="#generate-阶段" class="header-anchor">#</a> generate 阶段</h3> <h4 id="outputoptions"><a href="#outputoptions" class="header-anchor">#</a> outputOptions</h4> <p>在 handleGenerateWrite() 阶段，获取处理后的 outputOptions。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>outputPluginDriver<span class="token punctuation">.</span><span class="token function">hookReduceArg0Sync</span><span class="token punctuation">(</span>
  <span class="token string">'outputOptions'</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>rawOutputOptions<span class="token punctuation">.</span>output <span class="token operator">||</span> rawOutputOptions<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>OutputOptions<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>outputOptions<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> result <span class="token operator">||</span> outputOptions<span class="token punctuation">,</span>
  pluginContext <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">emitError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> pluginContext<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token function">errCannotEmitFromOptionsHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>pluginContext<span class="token punctuation">,</span>
      emitFile<span class="token operator">:</span> emitError<span class="token punctuation">,</span>
      setAssetSource<span class="token operator">:</span> emitError<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>将处理后的 outputOptions 作为传参生成 bundle 对象：</p> <h4 id="生成代码"><a href="#生成代码" class="header-anchor">#</a> 生成代码</h4> <p>在 <code>const generated = await bundle.generate(isWrite);</code> bundle 生成代码阶段，</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token operator">...</span> <span class="token comment">// render 开始</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginDriver<span class="token punctuation">.</span><span class="token function">hookParallel</span><span class="token punctuation">(</span><span class="token string">'renderStart'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>outputOptions<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputOptions<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span> <span class="token comment">// 该钩子函数执行过程中不能中断</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginDriver<span class="token punctuation">.</span><span class="token function">hookSeq</span><span class="token punctuation">(</span><span class="token string">'generateBundle'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>outputOptions<span class="token punctuation">,</span>
  outputBundle <span class="token keyword">as</span> OutputBundle<span class="token punctuation">,</span>
  isWrite
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>最后并行执行处理生成的代码~</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">await</span> outputPluginDriver<span class="token punctuation">.</span><span class="token function">hookParallel</span><span class="token punctuation">(</span><span class="token string">'writeBundle'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>outputOptions<span class="token punctuation">,</span> generated<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <p>不难看出插件函数钩子贯穿了整个 rollup 的打包过程，并扮演了不同角色，支撑起了相应功能实现。</p> <p>我们目前做的就是梳理并理解这个过程，再回过头来看这张图，是不是发现一些问题：比如调用钩子函数的方式不止 hookParallel 一种，而图中展示触发的钩子函数也只有几个并不全面等，这张图只是为了串一遍主流程，方便大家理解 rollup 打包流程及调用钩子函数的方式及时机。</p> <p>关于十几个钩子函数的使用不一一介绍，具体你的插件怎么写以及作用在哪些钩子函数中需要分析具体场景根据以上工作原理查阅文档自行编写。
​</p> <div align="center"><img src="/luvue/images/rollup/rollup9.awebp" alt="rollup/rollup9.awebp"></div> <p>最后再来讲讲 rollup 插件的两个周边叭～</p> <h2 id="插件上下文"><a href="#插件上下文" class="header-anchor">#</a> 插件上下文</h2> <p>rollup 给钩子函数注入了 <code>context</code>，也就是上下文环境，用来方便对 <code>chunks</code> 和其他构建信息进行增删改查。也就是说，在插件中，可以在各个 hook 中直接通过 this.xxx 来调用上面的方法。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> context<span class="token operator">:</span> PluginContext <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">addWatchFile</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    cache<span class="token operator">:</span> cacheInstance<span class="token punctuation">,</span>
    emitAsset<span class="token operator">:</span> <span class="token function">getDeprecatedContextHandler</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    emitChunk<span class="token operator">:</span> <span class="token function">getDeprecatedContextHandler</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    emitFile<span class="token operator">:</span> fileEmitter<span class="token punctuation">.</span>emitFile<span class="token punctuation">,</span>
    <span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    getAssetFileName<span class="token operator">:</span> <span class="token function">getDeprecatedContextHandler</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    getChunkFileName<span class="token operator">:</span> <span class="token function">getDeprecatedContextHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    getFileName<span class="token operator">:</span> fileEmitter<span class="token punctuation">.</span>getFileName<span class="token punctuation">,</span>
    <span class="token function-variable function">getModuleIds</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> graph<span class="token punctuation">.</span>modulesById<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    getModuleInfo<span class="token operator">:</span> graph<span class="token punctuation">.</span>getModuleInfo<span class="token punctuation">,</span>
    <span class="token function-variable function">getWatchFiles</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>graph<span class="token punctuation">.</span>watchFiles<span class="token punctuation">)</span><span class="token punctuation">,</span>
    isExternal<span class="token operator">:</span> <span class="token function">getDeprecatedContextHandler</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    meta<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 绑定 graph.watchMode</span>
        rollupVersion<span class="token punctuation">,</span>
        watchMode<span class="token operator">:</span> graph<span class="token punctuation">.</span>watchMode
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">moduleIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 绑定 graph.modulesById.keys();</span>
        <span class="token keyword">const</span> moduleIds <span class="token operator">=</span> graph<span class="token punctuation">.</span>modulesById<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">wrappedModuleIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    parse<span class="token operator">:</span> graph<span class="token punctuation">.</span>contextParse<span class="token punctuation">,</span> <span class="token comment">// 绑定 graph.contextParse</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> <span class="token punctuation">{</span> custom<span class="token punctuation">,</span> skipSelf <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">BLANK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 绑定 graph.moduleLoader 上方法</span>
        <span class="token keyword">return</span> graph<span class="token punctuation">.</span>moduleLoader<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> custom<span class="token punctuation">,</span> skipSelf <span class="token operator">?</span> pidx <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    resolveId<span class="token operator">:</span> <span class="token function">getDeprecatedContextHandler</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    setAssetSource<span class="token operator">:</span> fileEmitter<span class="token punctuation">.</span>setAssetSource<span class="token punctuation">,</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>warning<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="插件的缓存"><a href="#插件的缓存" class="header-anchor">#</a> 插件的缓存</h2> <p>插件还提供缓存的能力，利用了闭包实现的非常巧妙。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createPluginCache</span><span class="token punctuation">(</span>cache<span class="token operator">:</span> SerializablePluginCache<span class="token punctuation">)</span><span class="token operator">:</span> PluginCache <span class="token punctuation">{</span>
  <span class="token comment">// 利用闭包将 cache 缓存</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">has</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> item <span class="token operator">=</span> cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 如果访问了，那么重置访问过期次数，猜测：就是说明用户有意向主动去使用</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">get</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> item <span class="token operator">=</span> cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
      item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 如果访问了，那么重置访问过期次数</span>
      <span class="token keyword">return</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 存储单位是数组，第一项用来标记访问次数</span>
      cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">delete</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">delete</span> cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>然后创建缓存后，会添加在插件上下文中:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> createPluginCache <span class="token keyword">from</span> <span class="token string">'createPluginCache'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cacheInstance <span class="token operator">=</span> <span class="token function">createPluginCache</span><span class="token punctuation">(</span>
  pluginCache<span class="token punctuation">[</span>cacheKey<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pluginCache<span class="token punctuation">[</span>cacheKey<span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  cache<span class="token operator">:</span> cacheInstance<span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>之后我们就可以在插件中就可以使用 cache 进行插件环境下的缓存，进一步提升打包效率:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">testPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'test-plugin'</span><span class="token punctuation">,</span>
    <span class="token function">buildStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'prev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'prev'</span><span class="token punctuation">,</span> <span class="token string">'上一次插件执行的结果'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 第二次执行 rollup 的时候会执行</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'prev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> cache<span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> chunks <span class="token operator">=</span> <span class="token keyword">await</span> rollup<span class="token punctuation">.</span><span class="token function">rollup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> <span class="token string">'src/main.js'</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">testPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 需要传递上次的打包结果</span>
    cache<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cache <span class="token operator">=</span> chunks<span class="token punctuation">.</span>cache<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ol><li>rollup 的插件本质是一个处理函数，返回一个对象。返回的对象包含一些属性(如 name)，和不同阶段的钩子函数（构建 build 和输出 output 阶段），以实现插件内部的功能；</li> <li>关于返回的对象，在插件返回对象中的钩子函数中，大多数的钩子函数定义了 插件的调用时机和调用方式，只有 runHook(Sync)钩子真正执行了插件；</li> <li>关于插件调用时机和调用方法的触发取决于打包流程，在此我们通过图 1 流程图也梳理了一遍 rollup.rollup() 打包流程；</li> <li>插件原理都讲完了，插件调用当然 so easy，一个函数谁还不会用呢？而对于简单插件函数的开发页也不仅仅是单纯模仿，也可以做到心中有数了！</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/luvue/engineering/rollup/05-rollup构建原理及简易实现.html" class="prev">05-rollup构建原理及简易实现</a></span> <span class="next"><a href="/luvue/engineering/rollup/07-项目减重之rollup的Tree-shaking.html">07-项目减重之rollup的Tree-shaking</a>
      →
    </span></p></div> </main> <span data-v-2ae0ee72></span></div><div class="global-ui"></div></div>
    <script src="/luvue/assets/js/app.24d3cb9c.js" defer></script><script src="/luvue/assets/js/2.7e9a2be9.js" defer></script><script src="/luvue/assets/js/3.92ecc592.js" defer></script><script src="/luvue/assets/js/65.90372937.js" defer></script>
  </body>
</html>
