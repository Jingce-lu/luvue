<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>极简 Hooks 实现 | Luvue notes</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel=" " href=" ">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/luvue/assets/css/0.styles.0c275c11.css" as="style"><link rel="preload" href="/luvue/assets/js/app.bd06d157.js" as="script"><link rel="preload" href="/luvue/assets/js/2.435f734b.js" as="script"><link rel="preload" href="/luvue/assets/js/3.116bd10d.js" as="script"><link rel="preload" href="/luvue/assets/js/73.473315ad.js" as="script"><link rel="prefetch" href="/luvue/assets/js/10.25b052a7.js"><link rel="prefetch" href="/luvue/assets/js/100.30bacd39.js"><link rel="prefetch" href="/luvue/assets/js/101.64eddbeb.js"><link rel="prefetch" href="/luvue/assets/js/102.61476ef5.js"><link rel="prefetch" href="/luvue/assets/js/103.b374cb2d.js"><link rel="prefetch" href="/luvue/assets/js/104.dcaca048.js"><link rel="prefetch" href="/luvue/assets/js/105.988e3596.js"><link rel="prefetch" href="/luvue/assets/js/106.8857b0e1.js"><link rel="prefetch" href="/luvue/assets/js/107.68522df0.js"><link rel="prefetch" href="/luvue/assets/js/108.b35b814f.js"><link rel="prefetch" href="/luvue/assets/js/109.ab4c7e31.js"><link rel="prefetch" href="/luvue/assets/js/11.2637f019.js"><link rel="prefetch" href="/luvue/assets/js/110.78d8248a.js"><link rel="prefetch" href="/luvue/assets/js/111.82ce8d85.js"><link rel="prefetch" href="/luvue/assets/js/112.12249a54.js"><link rel="prefetch" href="/luvue/assets/js/113.a4f19600.js"><link rel="prefetch" href="/luvue/assets/js/114.8e65e438.js"><link rel="prefetch" href="/luvue/assets/js/115.08a029b1.js"><link rel="prefetch" href="/luvue/assets/js/116.bf134290.js"><link rel="prefetch" href="/luvue/assets/js/117.a923a928.js"><link rel="prefetch" href="/luvue/assets/js/118.bc336ead.js"><link rel="prefetch" href="/luvue/assets/js/119.2f92d9f6.js"><link rel="prefetch" href="/luvue/assets/js/12.666a4192.js"><link rel="prefetch" href="/luvue/assets/js/120.e303c66a.js"><link rel="prefetch" href="/luvue/assets/js/121.40ceff18.js"><link rel="prefetch" href="/luvue/assets/js/122.f7f5105d.js"><link rel="prefetch" href="/luvue/assets/js/123.90079a8f.js"><link rel="prefetch" href="/luvue/assets/js/124.4bb8730c.js"><link rel="prefetch" href="/luvue/assets/js/125.b7999c7f.js"><link rel="prefetch" href="/luvue/assets/js/126.e0533c4d.js"><link rel="prefetch" href="/luvue/assets/js/127.89c46f0b.js"><link rel="prefetch" href="/luvue/assets/js/128.67627737.js"><link rel="prefetch" href="/luvue/assets/js/129.96112dc4.js"><link rel="prefetch" href="/luvue/assets/js/13.80dad4d9.js"><link rel="prefetch" href="/luvue/assets/js/130.cabff902.js"><link rel="prefetch" href="/luvue/assets/js/131.79ac215f.js"><link rel="prefetch" href="/luvue/assets/js/132.d9acbd97.js"><link rel="prefetch" href="/luvue/assets/js/133.9d930391.js"><link rel="prefetch" href="/luvue/assets/js/134.74066daa.js"><link rel="prefetch" href="/luvue/assets/js/135.1de5dd27.js"><link rel="prefetch" href="/luvue/assets/js/136.b54f803c.js"><link rel="prefetch" href="/luvue/assets/js/137.a508f817.js"><link rel="prefetch" href="/luvue/assets/js/138.9a443aef.js"><link rel="prefetch" href="/luvue/assets/js/139.209419f9.js"><link rel="prefetch" href="/luvue/assets/js/14.e6e40836.js"><link rel="prefetch" href="/luvue/assets/js/140.b3a13f8a.js"><link rel="prefetch" href="/luvue/assets/js/141.04cd7b08.js"><link rel="prefetch" href="/luvue/assets/js/142.4f7594f1.js"><link rel="prefetch" href="/luvue/assets/js/143.491cf6bf.js"><link rel="prefetch" href="/luvue/assets/js/144.c6c6b1d4.js"><link rel="prefetch" href="/luvue/assets/js/145.102b94dc.js"><link rel="prefetch" href="/luvue/assets/js/146.55fdfd58.js"><link rel="prefetch" href="/luvue/assets/js/147.1365ae3c.js"><link rel="prefetch" href="/luvue/assets/js/148.89b7e86c.js"><link rel="prefetch" href="/luvue/assets/js/149.c6cf854a.js"><link rel="prefetch" href="/luvue/assets/js/15.f0f66abc.js"><link rel="prefetch" href="/luvue/assets/js/150.727fb530.js"><link rel="prefetch" href="/luvue/assets/js/151.d5e57149.js"><link rel="prefetch" href="/luvue/assets/js/152.99ce124e.js"><link rel="prefetch" href="/luvue/assets/js/153.493f594c.js"><link rel="prefetch" href="/luvue/assets/js/154.df9c0737.js"><link rel="prefetch" href="/luvue/assets/js/155.b135c541.js"><link rel="prefetch" href="/luvue/assets/js/156.520062bf.js"><link rel="prefetch" href="/luvue/assets/js/157.718cf973.js"><link rel="prefetch" href="/luvue/assets/js/158.97868c1b.js"><link rel="prefetch" href="/luvue/assets/js/159.a493f6d4.js"><link rel="prefetch" href="/luvue/assets/js/16.686e4cd5.js"><link rel="prefetch" href="/luvue/assets/js/160.10a7b1f7.js"><link rel="prefetch" href="/luvue/assets/js/161.f314fe9c.js"><link rel="prefetch" href="/luvue/assets/js/162.0826911e.js"><link rel="prefetch" href="/luvue/assets/js/163.751f91b0.js"><link rel="prefetch" href="/luvue/assets/js/164.ff4246af.js"><link rel="prefetch" href="/luvue/assets/js/165.8a6663be.js"><link rel="prefetch" href="/luvue/assets/js/166.9d4815de.js"><link rel="prefetch" href="/luvue/assets/js/167.b79e20fc.js"><link rel="prefetch" href="/luvue/assets/js/168.abfa67ee.js"><link rel="prefetch" href="/luvue/assets/js/169.f8bbdc52.js"><link rel="prefetch" href="/luvue/assets/js/17.95c8e227.js"><link rel="prefetch" href="/luvue/assets/js/170.3f60e84e.js"><link rel="prefetch" href="/luvue/assets/js/171.dd17f9fb.js"><link rel="prefetch" href="/luvue/assets/js/172.b3ff7c93.js"><link rel="prefetch" href="/luvue/assets/js/173.312d63b3.js"><link rel="prefetch" href="/luvue/assets/js/174.193a445e.js"><link rel="prefetch" href="/luvue/assets/js/175.5fde5541.js"><link rel="prefetch" href="/luvue/assets/js/176.04f72a78.js"><link rel="prefetch" href="/luvue/assets/js/177.61af761d.js"><link rel="prefetch" href="/luvue/assets/js/178.db9bce6e.js"><link rel="prefetch" href="/luvue/assets/js/179.26e86af8.js"><link rel="prefetch" href="/luvue/assets/js/18.6bd7e2a3.js"><link rel="prefetch" href="/luvue/assets/js/180.8fec9507.js"><link rel="prefetch" href="/luvue/assets/js/181.2a3b9891.js"><link rel="prefetch" href="/luvue/assets/js/182.0642c84e.js"><link rel="prefetch" href="/luvue/assets/js/183.a6aa4900.js"><link rel="prefetch" href="/luvue/assets/js/184.cb475311.js"><link rel="prefetch" href="/luvue/assets/js/185.ac7279dd.js"><link rel="prefetch" href="/luvue/assets/js/186.f6d64740.js"><link rel="prefetch" href="/luvue/assets/js/19.588f1e2a.js"><link rel="prefetch" href="/luvue/assets/js/20.6e936b62.js"><link rel="prefetch" href="/luvue/assets/js/21.5a8c4caa.js"><link rel="prefetch" href="/luvue/assets/js/22.71db563d.js"><link rel="prefetch" href="/luvue/assets/js/23.d0499b69.js"><link rel="prefetch" href="/luvue/assets/js/24.8fd2dfc1.js"><link rel="prefetch" href="/luvue/assets/js/25.f57b939a.js"><link rel="prefetch" href="/luvue/assets/js/26.4105fe3a.js"><link rel="prefetch" href="/luvue/assets/js/27.9f24fb61.js"><link rel="prefetch" href="/luvue/assets/js/28.71c44a1e.js"><link rel="prefetch" href="/luvue/assets/js/29.8661793f.js"><link rel="prefetch" href="/luvue/assets/js/30.5fd0d07d.js"><link rel="prefetch" href="/luvue/assets/js/31.9845f4cc.js"><link rel="prefetch" href="/luvue/assets/js/32.7ef3c995.js"><link rel="prefetch" href="/luvue/assets/js/33.11c63d5e.js"><link rel="prefetch" href="/luvue/assets/js/34.d463da9c.js"><link rel="prefetch" href="/luvue/assets/js/35.02a8fbe4.js"><link rel="prefetch" href="/luvue/assets/js/36.a1afaf38.js"><link rel="prefetch" href="/luvue/assets/js/37.925865bb.js"><link rel="prefetch" href="/luvue/assets/js/38.1f842a56.js"><link rel="prefetch" href="/luvue/assets/js/39.bd9ed807.js"><link rel="prefetch" href="/luvue/assets/js/4.952d9840.js"><link rel="prefetch" href="/luvue/assets/js/40.8fd09048.js"><link rel="prefetch" href="/luvue/assets/js/41.d5e3abff.js"><link rel="prefetch" href="/luvue/assets/js/42.598ea217.js"><link rel="prefetch" href="/luvue/assets/js/43.3fff97e6.js"><link rel="prefetch" href="/luvue/assets/js/44.77edcbeb.js"><link rel="prefetch" href="/luvue/assets/js/45.85586fe5.js"><link rel="prefetch" href="/luvue/assets/js/46.c3ac4a88.js"><link rel="prefetch" href="/luvue/assets/js/47.b5bcf39a.js"><link rel="prefetch" href="/luvue/assets/js/48.3639bf26.js"><link rel="prefetch" href="/luvue/assets/js/49.2c8c9ace.js"><link rel="prefetch" href="/luvue/assets/js/5.0f16b785.js"><link rel="prefetch" href="/luvue/assets/js/50.7984c7e6.js"><link rel="prefetch" href="/luvue/assets/js/51.56daf81d.js"><link rel="prefetch" href="/luvue/assets/js/52.b0797bbe.js"><link rel="prefetch" href="/luvue/assets/js/53.de493e7f.js"><link rel="prefetch" href="/luvue/assets/js/54.2826909e.js"><link rel="prefetch" href="/luvue/assets/js/55.76bfde5a.js"><link rel="prefetch" href="/luvue/assets/js/56.264f2b51.js"><link rel="prefetch" href="/luvue/assets/js/57.2dfff002.js"><link rel="prefetch" href="/luvue/assets/js/58.fef0687f.js"><link rel="prefetch" href="/luvue/assets/js/59.e985b7de.js"><link rel="prefetch" href="/luvue/assets/js/6.383eb099.js"><link rel="prefetch" href="/luvue/assets/js/60.b36f80a9.js"><link rel="prefetch" href="/luvue/assets/js/61.12221ce9.js"><link rel="prefetch" href="/luvue/assets/js/62.e6b16c58.js"><link rel="prefetch" href="/luvue/assets/js/63.e3bcafb9.js"><link rel="prefetch" href="/luvue/assets/js/64.ca697d42.js"><link rel="prefetch" href="/luvue/assets/js/65.6f9c5189.js"><link rel="prefetch" href="/luvue/assets/js/66.068ffd7a.js"><link rel="prefetch" href="/luvue/assets/js/67.14066762.js"><link rel="prefetch" href="/luvue/assets/js/68.ba29b70c.js"><link rel="prefetch" href="/luvue/assets/js/69.a34fc542.js"><link rel="prefetch" href="/luvue/assets/js/7.466da337.js"><link rel="prefetch" href="/luvue/assets/js/70.c5148b68.js"><link rel="prefetch" href="/luvue/assets/js/71.b210abcd.js"><link rel="prefetch" href="/luvue/assets/js/72.4d9b48b9.js"><link rel="prefetch" href="/luvue/assets/js/74.d79594ed.js"><link rel="prefetch" href="/luvue/assets/js/75.d09dff23.js"><link rel="prefetch" href="/luvue/assets/js/76.2a3e1718.js"><link rel="prefetch" href="/luvue/assets/js/77.a09f8016.js"><link rel="prefetch" href="/luvue/assets/js/78.ab2200c2.js"><link rel="prefetch" href="/luvue/assets/js/79.1e76c9db.js"><link rel="prefetch" href="/luvue/assets/js/8.bc4cc08a.js"><link rel="prefetch" href="/luvue/assets/js/80.fcbec605.js"><link rel="prefetch" href="/luvue/assets/js/81.f1100b4f.js"><link rel="prefetch" href="/luvue/assets/js/82.010edac4.js"><link rel="prefetch" href="/luvue/assets/js/83.adeb2bb2.js"><link rel="prefetch" href="/luvue/assets/js/84.fa85d59d.js"><link rel="prefetch" href="/luvue/assets/js/85.af7d351f.js"><link rel="prefetch" href="/luvue/assets/js/86.31cb95df.js"><link rel="prefetch" href="/luvue/assets/js/87.ffd4a37f.js"><link rel="prefetch" href="/luvue/assets/js/88.d9717442.js"><link rel="prefetch" href="/luvue/assets/js/89.726ad3a0.js"><link rel="prefetch" href="/luvue/assets/js/9.c0942326.js"><link rel="prefetch" href="/luvue/assets/js/90.782315ee.js"><link rel="prefetch" href="/luvue/assets/js/91.65cbc16c.js"><link rel="prefetch" href="/luvue/assets/js/92.d69c56df.js"><link rel="prefetch" href="/luvue/assets/js/93.d8ff20d2.js"><link rel="prefetch" href="/luvue/assets/js/94.6249be93.js"><link rel="prefetch" href="/luvue/assets/js/95.761d5806.js"><link rel="prefetch" href="/luvue/assets/js/96.d180a55b.js"><link rel="prefetch" href="/luvue/assets/js/97.506ca407.js"><link rel="prefetch" href="/luvue/assets/js/98.4b4b92da.js"><link rel="prefetch" href="/luvue/assets/js/99.d83a8e34.js">
    <link rel="stylesheet" href="/luvue/assets/css/0.styles.0c275c11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/luvue/" class="home-link router-link-active"><!----> <span class="site-name">Luvue notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link router-link-active">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/opt/" class="nav-link">渲染性能优化</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link router-link-active">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/opt/" class="nav-link">渲染性能优化</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/01-理念篇/" class="sidebar-heading clickable"><span>01-理念篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/02-架构篇/" class="sidebar-heading clickable"><span>02-架构篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/03-实现篇/" class="sidebar-heading clickable open"><span>03-实现篇</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/luvue/react/03-实现篇/01-第五章Diff算法/" class="sidebar-heading clickable"><span>01-第五章Diff算法</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/luvue/react/03-实现篇/02-第六章状态更新/" class="sidebar-heading clickable"><span>02-第六章状态更新</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/luvue/react/03-实现篇/03-第七章Hooks/" class="sidebar-heading clickable open"><span>03-第七章Hooks</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/luvue/react/03-实现篇/03-第七章Hooks/01-Hooks理念.html" class="sidebar-link">01-Hooks理念</a></li><li><a href="/luvue/react/03-实现篇/03-第七章Hooks/02-极简Hooks实现.html" class="active sidebar-link">02-极简Hooks实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/react/03-实现篇/03-第七章Hooks/02-极简Hooks实现.html#工作原理" class="sidebar-link">工作原理</a></li><li class="sidebar-sub-header"><a href="/luvue/react/03-实现篇/03-第七章Hooks/02-极简Hooks实现.html#更新是什么" class="sidebar-link">更新是什么</a></li><li class="sidebar-sub-header"><a href="/luvue/react/03-实现篇/03-第七章Hooks/02-极简Hooks实现.html#update-数据结构" class="sidebar-link">update 数据结构</a></li><li class="sidebar-sub-header"><a href="/luvue/react/03-实现篇/03-第七章Hooks/02-极简Hooks实现.html#状态如何保存" class="sidebar-link">状态如何保存</a></li><li class="sidebar-sub-header"><a href="/luvue/react/03-实现篇/03-第七章Hooks/02-极简Hooks实现.html#hook-数据结构" class="sidebar-link">Hook 数据结构</a></li><li class="sidebar-sub-header"><a href="/luvue/react/03-实现篇/03-第七章Hooks/02-极简Hooks实现.html#模拟-react-调度更新流程" class="sidebar-link">模拟 React 调度更新流程</a></li><li class="sidebar-sub-header"><a href="/luvue/react/03-实现篇/03-第七章Hooks/02-极简Hooks实现.html#计算-state" class="sidebar-link">计算 state</a></li><li class="sidebar-sub-header"><a href="/luvue/react/03-实现篇/03-第七章Hooks/02-极简Hooks实现.html#对触发事件进行抽象" class="sidebar-link">对触发事件进行抽象</a></li><li class="sidebar-sub-header"><a href="/luvue/react/03-实现篇/03-第七章Hooks/02-极简Hooks实现.html#在线-demo" class="sidebar-link">在线 Demo</a></li><li class="sidebar-sub-header"><a href="/luvue/react/03-实现篇/03-第七章Hooks/02-极简Hooks实现.html#与-react-的区别" class="sidebar-link">与 React 的区别</a></li></ul></li><li><a href="/luvue/react/03-实现篇/03-第七章Hooks/03-Hooks数据结构.html" class="sidebar-link">03-Hooks数据结构</a></li><li><a href="/luvue/react/03-实现篇/03-第七章Hooks/04-useState与useReducer.html" class="sidebar-link">04-useState与useReducer</a></li><li><a href="/luvue/react/03-实现篇/03-第七章Hooks/05-useEffect.html" class="sidebar-link">05-useEffect</a></li><li><a href="/luvue/react/03-实现篇/03-第七章Hooks/06-useRef.html" class="sidebar-link">06-useRef</a></li><li><a href="/luvue/react/03-实现篇/03-第七章Hooks/07-useMemo与useCallback.html" class="sidebar-link">07-useMemo与useCallback</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/luvue/react/03-实现篇/04-第八章ConcurrentMode/" class="sidebar-heading clickable"><span>04-第八章ConcurrentMode</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="极简-hooks-实现"><a href="#极简-hooks-实现" class="header-anchor">#</a> 极简 Hooks 实现</h1> <p></p><div class="table-of-contents"><ul><li><a href="#工作原理">工作原理</a></li><li><a href="#更新是什么">更新是什么</a></li><li><a href="#update-数据结构">update 数据结构</a></li><li><a href="#状态如何保存">状态如何保存</a></li><li><a href="#hook-数据结构">Hook 数据结构</a></li><li><a href="#模拟-react-调度更新流程">模拟 React 调度更新流程</a></li><li><a href="#计算-state">计算 state</a></li><li><a href="#对触发事件进行抽象">对触发事件进行抽象</a></li><li><a href="#在线-demo">在线 Demo</a></li><li><a href="#与-react-的区别">与 React 的区别</a></li></ul></div><p></p> <p>为了更好理解<code>Hooks</code>原理，这一节我们遵循<code>React</code>的运行流程，实现一个不到 100 行代码的极简<code>useState Hook</code>。建议对照着代码来看本节内容。</p> <h2 id="工作原理"><a href="#工作原理" class="header-anchor">#</a> 工作原理</h2> <p>对于<code>useState Hook</code>，考虑如下例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>p onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以将工作分为两部分：</p> <ol><li><p>通过一些途径产生<code>更新</code>，<code>更新</code>会造成组件<code>render</code>。</p></li> <li><p>组件<code>render</code>时<code>useState</code>返回的<code>num</code>为更新后的结果。</p></li></ol> <p>其中<code>步骤1</code>的<code>更新</code>可以分为<code>mount</code>和<code>update</code>：</p> <ol><li><p>调用<code>ReactDOM.render</code>会产生<code>mount</code>的<code>更新</code>，<code>更新</code>内容为<code>useState</code>的<code>initialValue</code>（即<code>0</code>）。</p></li> <li><p>点击<code>p</code>标签触发<code>updateNum</code>会产生一次<code>update</code>的<code>更新</code>，<code>更新</code>内容为<code>num =&gt; num + 1</code>。</p></li></ol> <p>接下来讲解这两个步骤如何实现。</p> <h2 id="更新是什么"><a href="#更新是什么" class="header-anchor">#</a> 更新是什么</h2> <blockquote><ol><li>通过一些途径产生<code>更新</code>，<code>更新</code>会造成组件<code>render</code>。</li></ol></blockquote> <p>首先我们要明确<code>更新</code>是什么。</p> <p>在我们的极简例子中，<code>更新</code>就是如下数据结构：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 更新执行的函数</span>
  action<span class="token punctuation">,</span>
  <span class="token comment">// 与同一个Hook的其他更新形成链表</span>
  next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>对于<code>App</code>来说，点击<code>p</code>标签产生的<code>update</code>的<code>action</code>为<code>num =&gt; num + 1</code>。</p> <p>如果我们改写下<code>App</code>的<code>onClick</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 之前</span>
<span class="token keyword">return</span> <span class="token operator">&lt;</span>p onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// 之后</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>p
    onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
    <span class="token punctuation">{</span>num<span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>那么点击<code>p</code>标签会产生三个<code>update</code>。</p> <h2 id="update-数据结构"><a href="#update-数据结构" class="header-anchor">#</a> update 数据结构</h2> <p>这些<code>update</code>是如何组合在一起呢？</p> <p>答案是：他们会形成<code>环状单向链表</code>。</p> <p>调用<code>updateNum</code>实际调用的是<code>dispatchAction.bind(null, hook.queue)</code>，我们先来了解下这个函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建update</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
    action<span class="token punctuation">,</span>
    next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 环状单向链表操作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>

  <span class="token comment">// 模拟React开始调度更新</span>
  <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>环状链表操作不太容易理解，这里我们详细讲解下。</p> <p>当产生第一个<code>update</code>（我们叫他<code>u0</code>），此时<code>queue.pending === null</code>。</p> <p><code>update.next = update;</code>即<code>u0.next = u0</code>，他会和自己首尾相连形成<code>单向环状链表</code>。</p> <p>然后<code>queue.pending = update;</code>即<code>queue.pending = u0</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> u0 <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> u0
                <span class="token operator">^</span>       <span class="token operator">|</span>
                <span class="token operator">|</span>       <span class="token operator">|</span>
                <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>当产生第二个<code>update</code>（我们叫他<code>u1</code>），<code>update.next = queue.pending.next;</code>，此时<code>queue.pending.next === u0</code>，
即<code>u1.next = u0</code>。</p> <p><code>queue.pending.next = update;</code>，即<code>u0.next = u1</code>。</p> <p>然后<code>queue.pending = update;</code>即<code>queue.pending = u1</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> u1 <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span> u0
                <span class="token operator">^</span>       <span class="token operator">|</span>
                <span class="token operator">|</span>       <span class="token operator">|</span>
                <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>你可以照着这个例子模拟插入多个<code>update</code>的情况，会发现<code>queue.pending</code>始终指向最后一个插入的<code>update</code>。</p> <p>这样做的好处是，当我们要遍历<code>update</code>时，<code>queue.pending.next</code>指向第一个插入的<code>update</code>。</p> <h2 id="状态如何保存"><a href="#状态如何保存" class="header-anchor">#</a> 状态如何保存</h2> <p>现在我们知道，<code>更新</code>产生的<code>update</code>对象会保存在<code>queue</code>中。</p> <p>不同于<code>ClassComponent</code>的实例可以存储数据，对于<code>FunctionComponent</code>，<code>queue</code>存储在哪里呢？</p> <p>答案是：<code>FunctionComponent</code>对应的<code>fiber</code>中。</p> <p>我们使用如下精简的<code>fiber</code>结构：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// App组件对应的fiber对象</span>
<span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存该FunctionComponent对应的Hooks链表</span>
  memoizedState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// 指向App函数</span>
  stateNode<span class="token operator">:</span> App<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="hook-数据结构"><a href="#hook-数据结构" class="header-anchor">#</a> Hook 数据结构</h2> <p>接下来我们关注<code>fiber.memoizedState</code>中保存的<code>Hook</code>的数据结构。</p> <p>可以看到，<code>Hook</code>与<code>update</code>类似，都通过<code>链表</code>连接。不过<code>Hook</code>是<code>无环</code>的<code>单向链表</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>hook <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存update的queue，即上文介绍的queue</span>
  queue<span class="token operator">:</span> <span class="token punctuation">{</span>
    pending<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 保存hook对应的state</span>
  memoizedState<span class="token operator">:</span> initialState<span class="token punctuation">,</span>
  <span class="token comment">// 与下一个Hook连接形成单向无环链表</span>
  next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>注意区分<code>update</code>与<code>hook</code>的所属关系：</p> <p>每个<code>useState</code>对应一个<code>hook</code>对象。</p> <p>调用<code>const [num, updateNum] = useState(0);</code>时<code>updateNum</code>（即上文介绍的<code>dispatchAction</code>）产生的<code>update</code>保存在<code>useState</code>对应的<code>hook.queue</code>中。</p></div> <h2 id="模拟-react-调度更新流程"><a href="#模拟-react-调度更新流程" class="header-anchor">#</a> 模拟 React 调度更新流程</h2> <p>在上文<code>dispatchAction</code>末尾我们通过<code>schedule</code>方法模拟<code>React</code>调度更新流程。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...创建update</span>

  <span class="token comment">// ...环状单向链表操作</span>

  <span class="token comment">// 模拟React开始调度更新</span>
  <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>现在我们来实现他。</p> <p>我们用<code>isMount</code>变量指代是<code>mount</code>还是<code>update</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 首次render时是mount</span>
isMount <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 更新前将workInProgressHook重置为fiber保存的第一个Hook</span>
  workInProgressHook <span class="token operator">=</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token comment">// 触发组件render</span>
  fiber<span class="token punctuation">.</span><span class="token function">stateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 组件首次render为mount，以后再触发的更新为update</span>
  isMount <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>通过<code>workInProgressHook</code>变量指向当前正在工作的<code>hook</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>workInProgressHook <span class="token operator">=</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在组件<code>render</code>时，每当遇到下一个<code>useState</code>，我们移动<code>workInProgressHook</code>的指针。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样，只要每次组件<code>render</code>时<code>useState</code>的调用顺序及数量保持一致，那么始终可以通过<code>workInProgressHook</code>找到当前<code>useState</code>对应的<code>hook</code>对象。</p> <p>到此为止，我们已经完成第一步。</p> <blockquote><ol><li>通过一些途径产生<code>更新</code>，<code>更新</code>会造成组件<code>render</code>。</li></ol></blockquote> <p>接下来实现第二步。</p> <blockquote><ol start="2"><li>组件<code>render</code>时<code>useState</code>返回的<code>num</code>为更新后的结果。</li></ol></blockquote> <h2 id="计算-state"><a href="#计算-state" class="header-anchor">#</a> 计算 state</h2> <p>组件<code>render</code>时会调用<code>useState</code>，他的大体逻辑如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当前useState使用的hook会被赋值该该变量</span>
  <span class="token keyword">let</span> hook<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...mount时需要生成hook对象</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...update时从workInProgressHook中取出该useState对应的hook</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...根据queue.pending中保存的update更新state</span>
  <span class="token punctuation">}</span>
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>baseState<span class="token punctuation">,</span> <span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>我们首先关注如何获取<code>hook</code>对象：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// mount时为该useState生成hook</span>
  hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    queue<span class="token operator">:</span> <span class="token punctuation">{</span>
      pending<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    memoizedState<span class="token operator">:</span> initialState<span class="token punctuation">,</span>
    next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 将hook插入fiber.memoizedState链表末尾</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 移动workInProgressHook指针</span>
  workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// update时找到对应hook</span>
  hook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">;</span>
  <span class="token comment">// 移动workInProgressHook指针</span>
  workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>当找到该<code>useState</code>对应的<code>hook</code>后，如果该<code>hook.queue.pending</code>不为空（即存在<code>update</code>），则更新其<code>state</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// update执行前的初始state</span>
<span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取update环状单向链表中第一个update</span>
  <span class="token keyword">let</span> firstUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行update action</span>
    <span class="token keyword">const</span> action <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
    baseState <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>baseState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    firstUpdate <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

    <span class="token comment">// 最后一个update执行完后跳出循环</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>firstUpdate <span class="token operator">!==</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 清空queue.pending</span>
  hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将update action执行完后的state作为memoizedState</span>
hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>完整代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> hook<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hook <span class="token operator">=</span> <span class="token punctuation">{</span>
      queue<span class="token operator">:</span> <span class="token punctuation">{</span>
        pending<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      memoizedState<span class="token operator">:</span> initialState<span class="token punctuation">,</span>
      next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    hook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">;</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> baseState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> firstUpdate <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> action <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>action<span class="token punctuation">;</span>
      baseState <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>baseState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      firstUpdate <span class="token operator">=</span> firstUpdate<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>firstUpdate <span class="token operator">!==</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>

    hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>baseState<span class="token punctuation">,</span> <span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="对触发事件进行抽象"><a href="#对触发事件进行抽象" class="header-anchor">#</a> 对触发事件进行抽象</h2> <p>最后，让我们抽象一下<code>React</code>的事件触发方式。</p> <p>通过调用<code>App</code>返回的<code>click</code>方法模拟组件<code>click</code>的行为。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>isMount <span class="token operator">?</span> <span class="token string">'mount'</span> <span class="token operator">:</span> <span class="token string">'update'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> num: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="在线-demo"><a href="#在线-demo" class="header-anchor">#</a> 在线 Demo</h2> <p>至此，我们完成了一个不到 100 行代码的<code>Hooks</code>。重要的是，他与<code>React</code>的运行逻辑相同。</p> <p>::: details 精简 Hooks 的在线 Demo</p> <p>调用<code>window.app.click()</code>模拟组件点击事件。</p> <p>你也可以使用多个<code>useState</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num1<span class="token punctuation">,</span> updateNum1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>isMount <span class="token operator">?</span> <span class="token string">'mount'</span> <span class="token operator">:</span> <span class="token string">'update'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> num: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>isMount <span class="token operator">?</span> <span class="token string">'mount'</span> <span class="token operator">:</span> <span class="token string">'update'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> num1: </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> num1<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">updateNum1</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><a href="/luvue/react/03-实现篇/me.html">关注公众号</a>，后台回复<strong>616</strong>获得在线 Demo 地址</p> <p>:::</p> <h2 id="与-react-的区别"><a href="#与-react-的区别" class="header-anchor">#</a> 与 React 的区别</h2> <p>我们用尽可能少的代码模拟了<code>Hooks</code>的运行，但是相比<code>React Hooks</code>，他还有很多不足。以下是他与<code>React Hooks</code>的区别：</p> <ol><li><p><code>React Hooks</code>没有使用<code>isMount</code>变量，而是在不同时机使用不同的<code>dispatcher</code>。换言之，<code>mount</code>时的<code>useState</code>与<code>update</code>时的<code>useState</code>不是同一个函数。</p></li> <li><p><code>React Hooks</code>有中途跳过<code>更新</code>的优化手段。</p></li> <li><p><code>React Hooks</code>有<code>batchedUpdates</code>，当在<code>click</code>中触发三次<code>updateNum</code>，<code>精简React</code>会触发三次更新，而<code>React</code>只会触发一次。</p></li> <li><p><code>React Hooks</code>的<code>update</code>有<code>优先级</code>概念，可以跳过不高优先的<code>update</code>。</p></li></ol> <p>更多的细节，我们会在本章后续小节讲解。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/luvue/react/03-实现篇/03-第七章Hooks/01-Hooks理念.html" class="prev">01-Hooks理念</a></span> <span class="next"><a href="/luvue/react/03-实现篇/03-第七章Hooks/03-Hooks数据结构.html">03-Hooks数据结构</a>
      →
    </span></p></div> </main> <span data-v-2ae0ee72></span></div><div class="global-ui"></div></div>
    <script src="/luvue/assets/js/app.bd06d157.js" defer></script><script src="/luvue/assets/js/2.435f734b.js" defer></script><script src="/luvue/assets/js/3.116bd10d.js" defer></script><script src="/luvue/assets/js/73.473315ad.js" defer></script>
  </body>
</html>
