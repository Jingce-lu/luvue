<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>不再神秘的优先级机制 | Ailjc notes</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel=" " href=" ">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/luvue/assets/css/0.styles.0c275c11.css" as="style"><link rel="preload" href="/luvue/assets/js/app.50227b6d.js" as="script"><link rel="preload" href="/luvue/assets/js/2.dc297d8e.js" as="script"><link rel="preload" href="/luvue/assets/js/3.51a2d233.js" as="script"><link rel="preload" href="/luvue/assets/js/188.cfcaabfb.js" as="script"><link rel="prefetch" href="/luvue/assets/js/10.4dcff8ef.js"><link rel="prefetch" href="/luvue/assets/js/100.4a463fa3.js"><link rel="prefetch" href="/luvue/assets/js/101.16c4fcf8.js"><link rel="prefetch" href="/luvue/assets/js/102.5b1d6c4c.js"><link rel="prefetch" href="/luvue/assets/js/103.14584991.js"><link rel="prefetch" href="/luvue/assets/js/104.116f4d80.js"><link rel="prefetch" href="/luvue/assets/js/105.81576762.js"><link rel="prefetch" href="/luvue/assets/js/106.5757f0a1.js"><link rel="prefetch" href="/luvue/assets/js/107.011fc1df.js"><link rel="prefetch" href="/luvue/assets/js/108.502e4c8c.js"><link rel="prefetch" href="/luvue/assets/js/109.904aca6f.js"><link rel="prefetch" href="/luvue/assets/js/11.e6154571.js"><link rel="prefetch" href="/luvue/assets/js/110.97e25b5c.js"><link rel="prefetch" href="/luvue/assets/js/111.edcade6b.js"><link rel="prefetch" href="/luvue/assets/js/112.75c283fd.js"><link rel="prefetch" href="/luvue/assets/js/113.ac993ad7.js"><link rel="prefetch" href="/luvue/assets/js/114.1dfc2617.js"><link rel="prefetch" href="/luvue/assets/js/115.a55cebf2.js"><link rel="prefetch" href="/luvue/assets/js/116.e3650879.js"><link rel="prefetch" href="/luvue/assets/js/117.c98d9d80.js"><link rel="prefetch" href="/luvue/assets/js/118.2ef2cb19.js"><link rel="prefetch" href="/luvue/assets/js/119.a56e96cb.js"><link rel="prefetch" href="/luvue/assets/js/12.271e8805.js"><link rel="prefetch" href="/luvue/assets/js/120.ea37c8e9.js"><link rel="prefetch" href="/luvue/assets/js/121.e84aa3eb.js"><link rel="prefetch" href="/luvue/assets/js/122.2809183d.js"><link rel="prefetch" href="/luvue/assets/js/123.ef109ed8.js"><link rel="prefetch" href="/luvue/assets/js/124.d7a754ba.js"><link rel="prefetch" href="/luvue/assets/js/125.e368457d.js"><link rel="prefetch" href="/luvue/assets/js/126.2b1e6d99.js"><link rel="prefetch" href="/luvue/assets/js/127.d197f125.js"><link rel="prefetch" href="/luvue/assets/js/128.1a3bba89.js"><link rel="prefetch" href="/luvue/assets/js/129.43fa9b4c.js"><link rel="prefetch" href="/luvue/assets/js/13.f6b3db37.js"><link rel="prefetch" href="/luvue/assets/js/130.ff13b9c1.js"><link rel="prefetch" href="/luvue/assets/js/131.25eb4de5.js"><link rel="prefetch" href="/luvue/assets/js/132.386f97d9.js"><link rel="prefetch" href="/luvue/assets/js/133.defdd861.js"><link rel="prefetch" href="/luvue/assets/js/134.0aba29a4.js"><link rel="prefetch" href="/luvue/assets/js/135.f1cc2592.js"><link rel="prefetch" href="/luvue/assets/js/136.5fea8f28.js"><link rel="prefetch" href="/luvue/assets/js/137.15521ec2.js"><link rel="prefetch" href="/luvue/assets/js/138.2e96476f.js"><link rel="prefetch" href="/luvue/assets/js/139.b3e580c7.js"><link rel="prefetch" href="/luvue/assets/js/14.e2545646.js"><link rel="prefetch" href="/luvue/assets/js/140.7254c946.js"><link rel="prefetch" href="/luvue/assets/js/141.309b75d5.js"><link rel="prefetch" href="/luvue/assets/js/142.e1587e8c.js"><link rel="prefetch" href="/luvue/assets/js/143.c6e04498.js"><link rel="prefetch" href="/luvue/assets/js/144.ccf79776.js"><link rel="prefetch" href="/luvue/assets/js/145.faa65998.js"><link rel="prefetch" href="/luvue/assets/js/146.1b7c11e7.js"><link rel="prefetch" href="/luvue/assets/js/147.f19de9ec.js"><link rel="prefetch" href="/luvue/assets/js/148.aba5552d.js"><link rel="prefetch" href="/luvue/assets/js/149.f1c10580.js"><link rel="prefetch" href="/luvue/assets/js/15.a3a78949.js"><link rel="prefetch" href="/luvue/assets/js/150.8c715a8a.js"><link rel="prefetch" href="/luvue/assets/js/151.1d867a79.js"><link rel="prefetch" href="/luvue/assets/js/152.22ae9445.js"><link rel="prefetch" href="/luvue/assets/js/153.1024de46.js"><link rel="prefetch" href="/luvue/assets/js/154.48bb1114.js"><link rel="prefetch" href="/luvue/assets/js/155.bd946cd8.js"><link rel="prefetch" href="/luvue/assets/js/156.f1d78b05.js"><link rel="prefetch" href="/luvue/assets/js/157.63356c24.js"><link rel="prefetch" href="/luvue/assets/js/158.44bfb42f.js"><link rel="prefetch" href="/luvue/assets/js/159.41731d4e.js"><link rel="prefetch" href="/luvue/assets/js/16.bdbc9ac3.js"><link rel="prefetch" href="/luvue/assets/js/160.fe64fd3e.js"><link rel="prefetch" href="/luvue/assets/js/161.3af3f899.js"><link rel="prefetch" href="/luvue/assets/js/162.a020acea.js"><link rel="prefetch" href="/luvue/assets/js/163.ebfa2fea.js"><link rel="prefetch" href="/luvue/assets/js/164.5c72d951.js"><link rel="prefetch" href="/luvue/assets/js/165.739d51ec.js"><link rel="prefetch" href="/luvue/assets/js/166.54be55b5.js"><link rel="prefetch" href="/luvue/assets/js/167.6f6b0af9.js"><link rel="prefetch" href="/luvue/assets/js/168.059c4bbb.js"><link rel="prefetch" href="/luvue/assets/js/169.9583f311.js"><link rel="prefetch" href="/luvue/assets/js/17.267c53f7.js"><link rel="prefetch" href="/luvue/assets/js/170.f7ab2a56.js"><link rel="prefetch" href="/luvue/assets/js/171.aa5c6d65.js"><link rel="prefetch" href="/luvue/assets/js/172.7b70d120.js"><link rel="prefetch" href="/luvue/assets/js/173.8d733f83.js"><link rel="prefetch" href="/luvue/assets/js/174.41a36264.js"><link rel="prefetch" href="/luvue/assets/js/175.643cec2e.js"><link rel="prefetch" href="/luvue/assets/js/176.17a19152.js"><link rel="prefetch" href="/luvue/assets/js/177.00bffe2d.js"><link rel="prefetch" href="/luvue/assets/js/178.39d6dd1d.js"><link rel="prefetch" href="/luvue/assets/js/179.97c25b6d.js"><link rel="prefetch" href="/luvue/assets/js/18.b4dc00ad.js"><link rel="prefetch" href="/luvue/assets/js/180.f001f92c.js"><link rel="prefetch" href="/luvue/assets/js/181.b4ff3df9.js"><link rel="prefetch" href="/luvue/assets/js/182.21c49e0c.js"><link rel="prefetch" href="/luvue/assets/js/183.a68aedcf.js"><link rel="prefetch" href="/luvue/assets/js/184.1cc2979e.js"><link rel="prefetch" href="/luvue/assets/js/185.820ead5b.js"><link rel="prefetch" href="/luvue/assets/js/186.2ad000ef.js"><link rel="prefetch" href="/luvue/assets/js/187.fa9b511d.js"><link rel="prefetch" href="/luvue/assets/js/189.c7913649.js"><link rel="prefetch" href="/luvue/assets/js/19.61df46ad.js"><link rel="prefetch" href="/luvue/assets/js/190.a66da869.js"><link rel="prefetch" href="/luvue/assets/js/191.d21b8a3e.js"><link rel="prefetch" href="/luvue/assets/js/192.3a3f0b99.js"><link rel="prefetch" href="/luvue/assets/js/193.6005ffb1.js"><link rel="prefetch" href="/luvue/assets/js/194.9b365175.js"><link rel="prefetch" href="/luvue/assets/js/195.4e4e83f5.js"><link rel="prefetch" href="/luvue/assets/js/196.24df233b.js"><link rel="prefetch" href="/luvue/assets/js/197.42cfce0b.js"><link rel="prefetch" href="/luvue/assets/js/198.3998b360.js"><link rel="prefetch" href="/luvue/assets/js/199.6e1b267e.js"><link rel="prefetch" href="/luvue/assets/js/20.ae4d73d6.js"><link rel="prefetch" href="/luvue/assets/js/200.78a26196.js"><link rel="prefetch" href="/luvue/assets/js/201.e15689f7.js"><link rel="prefetch" href="/luvue/assets/js/202.351e4200.js"><link rel="prefetch" href="/luvue/assets/js/203.6732fa0f.js"><link rel="prefetch" href="/luvue/assets/js/204.bdaedc2f.js"><link rel="prefetch" href="/luvue/assets/js/205.769cfdfa.js"><link rel="prefetch" href="/luvue/assets/js/206.5980160d.js"><link rel="prefetch" href="/luvue/assets/js/207.4f27fd16.js"><link rel="prefetch" href="/luvue/assets/js/208.f715439d.js"><link rel="prefetch" href="/luvue/assets/js/209.26ff4509.js"><link rel="prefetch" href="/luvue/assets/js/21.756c7992.js"><link rel="prefetch" href="/luvue/assets/js/210.7c211a09.js"><link rel="prefetch" href="/luvue/assets/js/211.70a47632.js"><link rel="prefetch" href="/luvue/assets/js/212.fda6d44b.js"><link rel="prefetch" href="/luvue/assets/js/213.ec7d646a.js"><link rel="prefetch" href="/luvue/assets/js/214.3c165f1f.js"><link rel="prefetch" href="/luvue/assets/js/215.79377a1f.js"><link rel="prefetch" href="/luvue/assets/js/216.1300dd6d.js"><link rel="prefetch" href="/luvue/assets/js/217.1ee87399.js"><link rel="prefetch" href="/luvue/assets/js/218.6f58fde9.js"><link rel="prefetch" href="/luvue/assets/js/219.3e5ec5b0.js"><link rel="prefetch" href="/luvue/assets/js/22.68b75c4f.js"><link rel="prefetch" href="/luvue/assets/js/220.bac8627d.js"><link rel="prefetch" href="/luvue/assets/js/221.65afbd17.js"><link rel="prefetch" href="/luvue/assets/js/222.10b495b9.js"><link rel="prefetch" href="/luvue/assets/js/223.9483fde2.js"><link rel="prefetch" href="/luvue/assets/js/224.f0f0b115.js"><link rel="prefetch" href="/luvue/assets/js/225.82f4db59.js"><link rel="prefetch" href="/luvue/assets/js/226.837beb3c.js"><link rel="prefetch" href="/luvue/assets/js/227.88dfd603.js"><link rel="prefetch" href="/luvue/assets/js/228.926b67f1.js"><link rel="prefetch" href="/luvue/assets/js/229.d5432625.js"><link rel="prefetch" href="/luvue/assets/js/23.f144c5d8.js"><link rel="prefetch" href="/luvue/assets/js/230.af30858c.js"><link rel="prefetch" href="/luvue/assets/js/231.d094a5d4.js"><link rel="prefetch" href="/luvue/assets/js/232.001ef00e.js"><link rel="prefetch" href="/luvue/assets/js/233.63941e40.js"><link rel="prefetch" href="/luvue/assets/js/234.942f27c3.js"><link rel="prefetch" href="/luvue/assets/js/235.304392bc.js"><link rel="prefetch" href="/luvue/assets/js/236.d9a2338f.js"><link rel="prefetch" href="/luvue/assets/js/237.3e31a7be.js"><link rel="prefetch" href="/luvue/assets/js/238.50a6e0a4.js"><link rel="prefetch" href="/luvue/assets/js/239.67f7ea74.js"><link rel="prefetch" href="/luvue/assets/js/24.050e500e.js"><link rel="prefetch" href="/luvue/assets/js/240.7e126350.js"><link rel="prefetch" href="/luvue/assets/js/241.4b6526f2.js"><link rel="prefetch" href="/luvue/assets/js/242.2c0594df.js"><link rel="prefetch" href="/luvue/assets/js/243.2947ca1f.js"><link rel="prefetch" href="/luvue/assets/js/244.c13ff375.js"><link rel="prefetch" href="/luvue/assets/js/245.f35e7258.js"><link rel="prefetch" href="/luvue/assets/js/246.a4160daf.js"><link rel="prefetch" href="/luvue/assets/js/247.5add7de3.js"><link rel="prefetch" href="/luvue/assets/js/248.285f48bf.js"><link rel="prefetch" href="/luvue/assets/js/249.6bfc19fe.js"><link rel="prefetch" href="/luvue/assets/js/25.7161d756.js"><link rel="prefetch" href="/luvue/assets/js/250.7d9d5a0d.js"><link rel="prefetch" href="/luvue/assets/js/251.ad83fc91.js"><link rel="prefetch" href="/luvue/assets/js/252.79ce4a94.js"><link rel="prefetch" href="/luvue/assets/js/253.6733159c.js"><link rel="prefetch" href="/luvue/assets/js/254.8cbd88de.js"><link rel="prefetch" href="/luvue/assets/js/255.a6ded312.js"><link rel="prefetch" href="/luvue/assets/js/256.4a6348be.js"><link rel="prefetch" href="/luvue/assets/js/257.16709fb2.js"><link rel="prefetch" href="/luvue/assets/js/258.65f7c45d.js"><link rel="prefetch" href="/luvue/assets/js/259.d6bf3339.js"><link rel="prefetch" href="/luvue/assets/js/26.da9ec7cd.js"><link rel="prefetch" href="/luvue/assets/js/260.2e2fc30d.js"><link rel="prefetch" href="/luvue/assets/js/261.8ed2d945.js"><link rel="prefetch" href="/luvue/assets/js/262.02d4d5ca.js"><link rel="prefetch" href="/luvue/assets/js/263.8a02e4d0.js"><link rel="prefetch" href="/luvue/assets/js/264.5fad29a4.js"><link rel="prefetch" href="/luvue/assets/js/265.1cd29535.js"><link rel="prefetch" href="/luvue/assets/js/266.e5a1aad7.js"><link rel="prefetch" href="/luvue/assets/js/267.a51a94be.js"><link rel="prefetch" href="/luvue/assets/js/268.5d9bc388.js"><link rel="prefetch" href="/luvue/assets/js/269.81be7c5e.js"><link rel="prefetch" href="/luvue/assets/js/27.d35fe8d8.js"><link rel="prefetch" href="/luvue/assets/js/270.bf9cf8c5.js"><link rel="prefetch" href="/luvue/assets/js/271.f5f0e39d.js"><link rel="prefetch" href="/luvue/assets/js/272.2c2d8519.js"><link rel="prefetch" href="/luvue/assets/js/273.207adc32.js"><link rel="prefetch" href="/luvue/assets/js/274.4dceda17.js"><link rel="prefetch" href="/luvue/assets/js/275.c1310482.js"><link rel="prefetch" href="/luvue/assets/js/276.4201cd6e.js"><link rel="prefetch" href="/luvue/assets/js/277.88e1d30f.js"><link rel="prefetch" href="/luvue/assets/js/278.5914996c.js"><link rel="prefetch" href="/luvue/assets/js/279.74b37999.js"><link rel="prefetch" href="/luvue/assets/js/28.07d99649.js"><link rel="prefetch" href="/luvue/assets/js/280.c9568110.js"><link rel="prefetch" href="/luvue/assets/js/281.9f65d139.js"><link rel="prefetch" href="/luvue/assets/js/282.1650bd06.js"><link rel="prefetch" href="/luvue/assets/js/283.33bbeb99.js"><link rel="prefetch" href="/luvue/assets/js/284.1abe4631.js"><link rel="prefetch" href="/luvue/assets/js/285.518df1bf.js"><link rel="prefetch" href="/luvue/assets/js/286.af519e66.js"><link rel="prefetch" href="/luvue/assets/js/287.b6460486.js"><link rel="prefetch" href="/luvue/assets/js/288.47db7cc9.js"><link rel="prefetch" href="/luvue/assets/js/289.33cc7dc0.js"><link rel="prefetch" href="/luvue/assets/js/29.7a42aa9c.js"><link rel="prefetch" href="/luvue/assets/js/290.4a4def2b.js"><link rel="prefetch" href="/luvue/assets/js/291.ff1d48f1.js"><link rel="prefetch" href="/luvue/assets/js/292.0e4d6a16.js"><link rel="prefetch" href="/luvue/assets/js/293.4475f8fa.js"><link rel="prefetch" href="/luvue/assets/js/294.19226719.js"><link rel="prefetch" href="/luvue/assets/js/295.09aea195.js"><link rel="prefetch" href="/luvue/assets/js/296.98217b5e.js"><link rel="prefetch" href="/luvue/assets/js/297.b8ff51d6.js"><link rel="prefetch" href="/luvue/assets/js/298.990d4d9f.js"><link rel="prefetch" href="/luvue/assets/js/299.5df2719c.js"><link rel="prefetch" href="/luvue/assets/js/30.f14df500.js"><link rel="prefetch" href="/luvue/assets/js/300.fffd2c27.js"><link rel="prefetch" href="/luvue/assets/js/301.3d6b453a.js"><link rel="prefetch" href="/luvue/assets/js/302.caa4deb9.js"><link rel="prefetch" href="/luvue/assets/js/303.7a1ad789.js"><link rel="prefetch" href="/luvue/assets/js/304.fd6421f9.js"><link rel="prefetch" href="/luvue/assets/js/305.9963fce8.js"><link rel="prefetch" href="/luvue/assets/js/306.20906cc0.js"><link rel="prefetch" href="/luvue/assets/js/307.9b2c7f2f.js"><link rel="prefetch" href="/luvue/assets/js/308.c6636c3c.js"><link rel="prefetch" href="/luvue/assets/js/309.ba0a0e71.js"><link rel="prefetch" href="/luvue/assets/js/31.8b2636da.js"><link rel="prefetch" href="/luvue/assets/js/310.22345224.js"><link rel="prefetch" href="/luvue/assets/js/311.7c423dba.js"><link rel="prefetch" href="/luvue/assets/js/312.1a9b57a9.js"><link rel="prefetch" href="/luvue/assets/js/313.358832dc.js"><link rel="prefetch" href="/luvue/assets/js/314.cc992c63.js"><link rel="prefetch" href="/luvue/assets/js/315.51fdd92e.js"><link rel="prefetch" href="/luvue/assets/js/32.a1812ddd.js"><link rel="prefetch" href="/luvue/assets/js/33.4f4d5e3f.js"><link rel="prefetch" href="/luvue/assets/js/34.d81874f6.js"><link rel="prefetch" href="/luvue/assets/js/35.808cadca.js"><link rel="prefetch" href="/luvue/assets/js/36.911edf94.js"><link rel="prefetch" href="/luvue/assets/js/37.4718c1c4.js"><link rel="prefetch" href="/luvue/assets/js/38.a71b26b8.js"><link rel="prefetch" href="/luvue/assets/js/39.1e2c90a1.js"><link rel="prefetch" href="/luvue/assets/js/4.81c04c44.js"><link rel="prefetch" href="/luvue/assets/js/40.c27fa3a1.js"><link rel="prefetch" href="/luvue/assets/js/41.7ef6ece6.js"><link rel="prefetch" href="/luvue/assets/js/42.65a4e5f1.js"><link rel="prefetch" href="/luvue/assets/js/43.fe8f1ca9.js"><link rel="prefetch" href="/luvue/assets/js/44.4cbd0be7.js"><link rel="prefetch" href="/luvue/assets/js/45.7ba58c4e.js"><link rel="prefetch" href="/luvue/assets/js/46.5b26ac52.js"><link rel="prefetch" href="/luvue/assets/js/47.4886ee59.js"><link rel="prefetch" href="/luvue/assets/js/48.6ca30618.js"><link rel="prefetch" href="/luvue/assets/js/49.bf5ae195.js"><link rel="prefetch" href="/luvue/assets/js/5.7c785cd7.js"><link rel="prefetch" href="/luvue/assets/js/50.d2063889.js"><link rel="prefetch" href="/luvue/assets/js/51.40853d68.js"><link rel="prefetch" href="/luvue/assets/js/52.4595cda0.js"><link rel="prefetch" href="/luvue/assets/js/53.f65e7aed.js"><link rel="prefetch" href="/luvue/assets/js/54.e92efc34.js"><link rel="prefetch" href="/luvue/assets/js/55.c19cb715.js"><link rel="prefetch" href="/luvue/assets/js/56.d9b2c912.js"><link rel="prefetch" href="/luvue/assets/js/57.97fdefbb.js"><link rel="prefetch" href="/luvue/assets/js/58.a8454dc8.js"><link rel="prefetch" href="/luvue/assets/js/59.2176e352.js"><link rel="prefetch" href="/luvue/assets/js/6.f13ef292.js"><link rel="prefetch" href="/luvue/assets/js/60.9903c2e8.js"><link rel="prefetch" href="/luvue/assets/js/61.1840a87b.js"><link rel="prefetch" href="/luvue/assets/js/62.f9de293d.js"><link rel="prefetch" href="/luvue/assets/js/63.f0b5bd0c.js"><link rel="prefetch" href="/luvue/assets/js/64.9bfd9747.js"><link rel="prefetch" href="/luvue/assets/js/65.5091d072.js"><link rel="prefetch" href="/luvue/assets/js/66.1110c30b.js"><link rel="prefetch" href="/luvue/assets/js/67.d0123a6f.js"><link rel="prefetch" href="/luvue/assets/js/68.cfb6235b.js"><link rel="prefetch" href="/luvue/assets/js/69.eaef6f8c.js"><link rel="prefetch" href="/luvue/assets/js/7.b9daa433.js"><link rel="prefetch" href="/luvue/assets/js/70.92d45540.js"><link rel="prefetch" href="/luvue/assets/js/71.cea0d0db.js"><link rel="prefetch" href="/luvue/assets/js/72.5f4fd7b1.js"><link rel="prefetch" href="/luvue/assets/js/73.2bd9f09b.js"><link rel="prefetch" href="/luvue/assets/js/74.4f59112e.js"><link rel="prefetch" href="/luvue/assets/js/75.89861829.js"><link rel="prefetch" href="/luvue/assets/js/76.b02997f7.js"><link rel="prefetch" href="/luvue/assets/js/77.4d732275.js"><link rel="prefetch" href="/luvue/assets/js/78.338bc517.js"><link rel="prefetch" href="/luvue/assets/js/79.f4cf76b6.js"><link rel="prefetch" href="/luvue/assets/js/8.ae058ff6.js"><link rel="prefetch" href="/luvue/assets/js/80.598885dc.js"><link rel="prefetch" href="/luvue/assets/js/81.9e624105.js"><link rel="prefetch" href="/luvue/assets/js/82.70b483bb.js"><link rel="prefetch" href="/luvue/assets/js/83.96e15db9.js"><link rel="prefetch" href="/luvue/assets/js/84.1d0a2fca.js"><link rel="prefetch" href="/luvue/assets/js/85.c9523e2f.js"><link rel="prefetch" href="/luvue/assets/js/86.11b4914d.js"><link rel="prefetch" href="/luvue/assets/js/87.9e995a9e.js"><link rel="prefetch" href="/luvue/assets/js/88.768abc2b.js"><link rel="prefetch" href="/luvue/assets/js/89.889b6d0c.js"><link rel="prefetch" href="/luvue/assets/js/9.c7db66f1.js"><link rel="prefetch" href="/luvue/assets/js/90.3d24896e.js"><link rel="prefetch" href="/luvue/assets/js/91.0d861dc9.js"><link rel="prefetch" href="/luvue/assets/js/92.225a6a9c.js"><link rel="prefetch" href="/luvue/assets/js/93.52403ad6.js"><link rel="prefetch" href="/luvue/assets/js/94.603cf2a0.js"><link rel="prefetch" href="/luvue/assets/js/95.c46d3f66.js"><link rel="prefetch" href="/luvue/assets/js/96.fb8ddca9.js"><link rel="prefetch" href="/luvue/assets/js/97.492b0923.js"><link rel="prefetch" href="/luvue/assets/js/98.0a287ebb.js"><link rel="prefetch" href="/luvue/assets/js/99.1786ba72.js">
    <link rel="stylesheet" href="/luvue/assets/css/0.styles.0c275c11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/luvue/" class="home-link router-link-active"><!----> <span class="site-name">Ailjc notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link router-link-active">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link">工程化</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link router-link-active">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link">工程化</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/01-理念篇/" class="sidebar-heading clickable"><span>01-理念篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/02-架构篇/" class="sidebar-heading clickable"><span>02-架构篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/03-实现篇/" class="sidebar-heading clickable"><span>03-实现篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/04-构建/" class="sidebar-heading clickable"><span>04-构建</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/05-react18/" class="sidebar-heading clickable router-link-active open"><span>05-react18</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/luvue/react/05-react18/01-基于React18讲解Hooks原理.html" class="sidebar-link">01-基于React18讲解Hooks原理</a></li><li><a href="/luvue/react/05-react18/02-50行代码实现react时间分片.html" class="sidebar-link">02-50行代码实现react时间分片</a></li><li><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html" class="active sidebar-link">03-不再神秘的优先级机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#为什么需要优先级" class="sidebar-link">为什么需要优先级</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#同步模式下的-react-运行时" class="sidebar-link">同步模式下的 react 运行时</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#如何运用优先级机制优化-react-运行时" class="sidebar-link">如何运用优先级机制优化 react 运行时</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#确定不同场景下的调度优先级" class="sidebar-link">确定不同场景下的调度优先级</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#lane-优先级" class="sidebar-link">lane 优先级</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#event-优先级" class="sidebar-link">event 优先级</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#scheduler-优先级" class="sidebar-link">scheduler 优先级</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#优先级间的转换" class="sidebar-link">优先级间的转换</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#优先级机制如何设计" class="sidebar-link">优先级机制如何设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#设计思路" class="sidebar-link">设计思路</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#合并赛道" class="sidebar-link">合并赛道</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#释放赛道" class="sidebar-link">释放赛道</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#找出最高优先级赛道" class="sidebar-link">找出最高优先级赛道</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#快速定位赛道索引" class="sidebar-link">快速定位赛道索引</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#判断赛道是否被占用" class="sidebar-link">判断赛道是否被占用</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#如何将优先级机制融入-react-运行时" class="sidebar-link">如何将优先级机制融入 React 运行时</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#生成一个更新任务" class="sidebar-link">生成一个更新任务</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#步骤一-获取本次更新的优先级" class="sidebar-link">步骤一：获取本次更新的优先级</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#步骤二-创建-update-对象" class="sidebar-link">步骤二：创建 Update 对象</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#步骤三-关联优先级" class="sidebar-link">步骤三：关联优先级</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#高优先级任务打断低优先级任务" class="sidebar-link">高优先级任务打断低优先级任务</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#cancelcallback" class="sidebar-link">cancelCallback</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#pop-taskqueue" class="sidebar-link">pop(taskQueue)</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#低优先级任务重启" class="sidebar-link">低优先级任务重启</a></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#饥饿任务问题" class="sidebar-link">饥饿任务问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/06-react-router/" class="sidebar-heading clickable"><span>06-react-router</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="不再神秘的优先级机制"><a href="#不再神秘的优先级机制" class="header-anchor">#</a> 不再神秘的优先级机制</h1> <p></p><div class="table-of-contents"><ul><li><a href="#为什么需要优先级">为什么需要优先级</a><ul><li><a href="#同步模式下的-react-运行时">同步模式下的 react 运行时</a></li><li><a href="#如何运用优先级机制优化-react-运行时">如何运用优先级机制优化 react 运行时</a></li></ul></li><li><a href="#确定不同场景下的调度优先级">确定不同场景下的调度优先级</a><ul><li><a href="#lane-优先级">lane 优先级</a></li><li><a href="#event-优先级">event 优先级</a></li><li><a href="#scheduler-优先级">scheduler 优先级</a></li><li><a href="#优先级间的转换">优先级间的转换</a></li></ul></li><li><a href="#优先级机制如何设计">优先级机制如何设计</a><ul><li><a href="#设计思路">设计思路</a></li><li><a href="#合并赛道">合并赛道</a></li><li><a href="#释放赛道">释放赛道</a></li><li><a href="#找出最高优先级赛道">找出最高优先级赛道</a></li><li><a href="#快速定位赛道索引">快速定位赛道索引</a></li><li><a href="#判断赛道是否被占用">判断赛道是否被占用</a></li></ul></li><li><a href="#如何将优先级机制融入-react-运行时">如何将优先级机制融入 React 运行时</a><ul><li><a href="#生成一个更新任务">生成一个更新任务</a></li><li><a href="#步骤一-获取本次更新的优先级">步骤一：获取本次更新的优先级</a></li><li><a href="#步骤二-创建-update-对象">步骤二：创建 Update 对象</a></li><li><a href="#步骤三-关联优先级">步骤三：关联优先级</a></li><li><a href="#高优先级任务打断低优先级任务">高优先级任务打断低优先级任务</a></li><li><a href="#cancelcallback">cancelCallback</a></li><li><a href="#pop-taskqueue">pop(taskQueue)</a></li><li><a href="#低优先级任务重启">低优先级任务重启</a></li><li><a href="#饥饿任务问题">饥饿任务问题</a></li></ul></li><li><a href="#总结">总结</a></li></ul></div><p></p> <h2 id="为什么需要优先级"><a href="#为什么需要优先级" class="header-anchor">#</a> 为什么需要优先级</h2> <p>优先级机制最终目的是为了实现<code>高优先级任务优先执行，低优先级任务延后执行</code>。</p> <p>实现这一目的的本质就是在低优先级任务执行时，有更高优先级任务进来的话，可以打断低优先级任务的执行。</p> <h3 id="同步模式下的-react-运行时"><a href="#同步模式下的-react-运行时" class="header-anchor">#</a> 同步模式下的 react 运行时</h3> <p>我们知道在同步模式下，从 <code>setState</code> 到 虚拟 DOM 遍历，再到真实 DOM 更新，整个过程都是同步执行且无法被中断的，这样可能就会出现一个问题 —— 用户事件触发的更新被阻塞。</p> <p>什么是用户事件触发的更新被阻塞？如果 React 正在进行更新任务，此时用户触发了交互事件，且在事件回调中执行了 <code>setState</code>，在<code>同步模式</code>下，这个更新任务需要 <code>等待</code> 当前正在更新的任务完成之后，才会被执行。假如当前 React 正在进行的更新任务耗时比较久，用户事件触发的更新任务不能及时被执行，造成下个更新任务被阻塞，从而形成了卡顿。</p> <p>这时候，我们就希望能够及时响应用户触发的事件，优先执行用户事件触发的更新任务，也就是我们说的<code>异步模式</code></p> <p>我们可以比较一下，<code>同步模式</code>下和<code>异步模式</code>(<code>优先级机制</code>)下更新任务执行的差异</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./styles.css'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> React<span class="token punctuation">.</span>Component <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      list<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>domRef <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout 准备更新'</span><span class="token punctuation">,</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          list<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updateLanes<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout 更新完毕'</span><span class="token punctuation">,</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>domRef<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div
        ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>domRef <span class="token operator">=</span> v<span class="token punctuation">)</span><span class="token punctuation">}</span>
        className<span class="token operator">=</span><span class="token string">'App'</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'click 准备更新'</span><span class="token punctuation">,</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>
            <span class="token punctuation">{</span> list<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> updateLanes<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'click 更新完毕'</span><span class="token punctuation">,</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token punctuation">{</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
          <span class="token operator">&lt;</span>h1 key<span class="token operator">=</span><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token operator">+</span>index<span class="token punctuation">}</span><span class="token operator">&gt;</span>Hello <span class="token punctuation">{</span>i<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>上面代码在同步模式下的打印是</p> <div align="center"><img src="/luvue/images/react/05-react18/react18-092501.webp" alt="react/05-react18/react18-092501.webp"></div> <p>可以看到 <code>click 事件</code> 触发的更新，需要等待 <code>setTimeout</code> 触发的更新才会被执行</p> <p>上面代码在<code>异步模式</code>下的打印是</p> <div align="center"><img src="/luvue/images/react/05-react18/react18-092502.webp" alt="react/05-react18/react18-092502.webp"></div> <p>可以看到 <code>click 事件</code> 触发的更新，会比 <code>setTimeout</code> 触发的更新更优先执行，做到了及时响应用户事件，打断 <code>setTimeout</code> 更新任务(<code>低优先级任务</code>)的执行。</p> <h3 id="如何运用优先级机制优化-react-运行时"><a href="#如何运用优先级机制优化-react-运行时" class="header-anchor">#</a> 如何运用优先级机制优化 react 运行时</h3> <p>为了解决同步模式渲染下的缺陷，我们希望能够对 react 做出下面这些优化</p> <ol><li>确定不同场景下所触发更新的优先级，以便我们可以决定优先执行哪些任务</li> <li>若有更高优先级的任务进来，我们需要打断当前进行的任务，然后执行这个高优先级任务</li> <li>确保低优先级任务不会被一直打断，在一定时间后能够被升级为最高优先级的任务</li></ol> <h2 id="确定不同场景下的调度优先级"><a href="#确定不同场景下的调度优先级" class="header-anchor">#</a> 确定不同场景下的调度优先级</h2> <p>看过 react 源码的小伙伴可能都会有一个疑惑，为什么源码里面有那么多优先级相关的单词？？怎么区分他们呢？</p> <p>其实在 react 中主要分为两类优先级，<code>scheduler</code> 优先级和 <code>lane</code> 优先级，<code>lane</code>优先级下面又派生出 <code>event</code> 优先级</p> <ul><li>lane 优先级：主要用于任务调度前，对当前正在进行的任务和被调度任务做一个优先级校验，判断是否需要打断当前正在进行的任务</li> <li>event 优先级：本质上也是 lane 优先级，lane 优先级是通用的，event 优先级更多是结合浏览器原生事件，对 lane 优先级做了分类和映射</li> <li>scheduler 优先级：主要用在时间分片中任务过期时间的计算</li></ul> <h3 id="lane-优先级"><a href="#lane-优先级" class="header-anchor">#</a> lane 优先级</h3> <p>可以用赛道的概念去理解 lane 优先级，lane 优先级有 31 个，我们可以用 31 位的二进制值去表示，值的每一位代表一条赛道对应一个 lane 优先级，<code>赛道位置越靠前，优先级越高</code></p> <table><thead><tr><th>优先级</th> <th>十进制值</th> <th>二进制值</th> <th>赛道位置</th></tr></thead> <tbody><tr><td>NoLane</td> <td>0</td> <td>0000000000000000000000000000000</td> <td>0</td></tr> <tr><td>SyncLane</td> <td>1</td> <td>0000000000000000000000000000001</td> <td>0</td></tr> <tr><td>InputContinuousHydrationLane</td> <td>2</td> <td>0000000000000000000000000000010</td> <td>1</td></tr> <tr><td>InputContinuousLane</td> <td>4</td> <td>0000000000000000000000000000100</td> <td>2</td></tr> <tr><td>DefaultHydrationLane</td> <td>8</td> <td>0000000000000000000000000001000</td> <td>3</td></tr> <tr><td>DefaultLane</td> <td>16</td> <td>0000000000000000000000000010000</td> <td>4</td></tr> <tr><td>TransitionHydrationLane</td> <td>32</td> <td>0000000000000000000000000100000</td> <td>5</td></tr> <tr><td>TransitionLane1</td> <td>64</td> <td>0000000000000000000000001000000</td> <td>6</td></tr> <tr><td>TransitionLane2</td> <td>128</td> <td>0000000000000000000000010000000</td> <td>7</td></tr> <tr><td>TransitionLane3</td> <td>256</td> <td>0000000000000000000000100000000</td> <td>8</td></tr> <tr><td>TransitionLane4</td> <td>512</td> <td>0000000000000000000001000000000</td> <td>9</td></tr> <tr><td>TransitionLane5</td> <td>1024</td> <td>0000000000000000000010000000000</td> <td>10</td></tr> <tr><td>TransitionLane</td> <td>2048</td> <td>0000000000000000000100000000000</td> <td>11</td></tr> <tr><td>TransitionLane7</td> <td>4096</td> <td>0000000000000000001000000000000</td> <td>12</td></tr> <tr><td>TransitionLane8</td> <td>8192</td> <td>0000000000000000010000000000000</td> <td>13</td></tr> <tr><td>TransitionLane9</td> <td>16384</td> <td>0000000000000000100000000000000</td> <td>14</td></tr> <tr><td>TransitionLane10</td> <td>32768</td> <td>0000000000000001000000000000000</td> <td>15</td></tr> <tr><td>TransitionLane11</td> <td>65536</td> <td>0000000000000010000000000000000</td> <td>16</td></tr> <tr><td>TransitionLane12</td> <td>131072</td> <td>0000000000000100000000000000000</td> <td>17</td></tr> <tr><td>TransitionLane13</td> <td>262144</td> <td>0000000000001000000000000000000</td> <td>18</td></tr> <tr><td>TransitionLane14</td> <td>524288</td> <td>0000000000010000000000000000000</td> <td>19</td></tr> <tr><td>TransitionLane15</td> <td>1048576</td> <td>0000000000100000000000000000000</td> <td>20</td></tr> <tr><td>TransitionLane16</td> <td>2097152</td> <td>0000000001000000000000000000000</td> <td>21</td></tr> <tr><td>RetryLane1</td> <td>4194304</td> <td>0000000010000000000000000000000</td> <td>22</td></tr> <tr><td>RetryLane2</td> <td>8388608</td> <td>0000000100000000000000000000000</td> <td>23</td></tr> <tr><td>RetryLane3</td> <td>16777216</td> <td>0000001000000000000000000000000</td> <td>24</td></tr> <tr><td>RetryLane4</td> <td>33554432</td> <td>0000010000000000000000000000000</td> <td>25</td></tr> <tr><td>RetryLane5</td> <td>67108864</td> <td>0000100000000000000000000000000</td> <td>26</td></tr> <tr><td>SelectiveHydrationLane</td> <td>134217728</td> <td>0001000000000000000000000000000</td> <td>27</td></tr> <tr><td>IdleHydrationLane</td> <td>268435456</td> <td>0010000000000000000000000000000</td> <td>28</td></tr> <tr><td>IdleLane</td> <td>536870912</td> <td>0100000000000000000000000000000</td> <td>29</td></tr> <tr><td>OffscreenLane</td> <td>1073741824</td> <td>1000000000000000000000000000000</td> <td>30</td></tr></tbody></table> <h3 id="event-优先级"><a href="#event-优先级" class="header-anchor">#</a> event 优先级</h3> <table><thead><tr><th>EventPriority</th> <th></th> <th>Lane</th> <th>数值</th></tr></thead> <tbody><tr><td>DiscreteEventPriority</td> <td>离散事件。click、keydown、focusin 等，事件的触发不是连续，可以做到快速响应</td> <td>SyncLane</td> <td>1</td></tr> <tr><td>ContinuousEventPriority</td> <td>连续事件。drag、scroll、mouseover 等，事件的是连续触发的，快速响应可能会阻塞渲染，优先级较离散事件低</td> <td>InputContinuousLane</td> <td>4</td></tr> <tr><td>DefaultEventPriority</td> <td>默认的事件优先级</td> <td>DefaultLane</td> <td>16</td></tr> <tr><td>IdleEventPriority</td> <td>空闲的优先级</td> <td>IdleLane</td> <td>536870912</td></tr></tbody></table> <h3 id="scheduler-优先级"><a href="#scheduler-优先级" class="header-anchor">#</a> scheduler 优先级</h3> <table><thead><tr><th>SchedulerPriority</th> <th>EventPriority</th> <th>大于&gt;17.0.2</th> <th>小于&gt;17.0.2</th></tr></thead> <tbody><tr><td>ImmediatePriority</td> <td>DiscreteEventPriority</td> <td>1</td> <td>99</td></tr> <tr><td>UserblockingPriority</td> <td>Userblocking</td> <td>2</td> <td>98</td></tr> <tr><td>NormalPriority</td> <td>DefaultEventPriority</td> <td>3</td> <td>97</td></tr> <tr><td>LowPriority</td> <td>DefaultEventPriority</td> <td>4</td> <td>96</td></tr> <tr><td>IdlePriority</td> <td>IdleEventPriority</td> <td>5</td> <td>95</td></tr> <tr><td>NoPriority</td> <td></td> <td>0</td> <td>90</td></tr></tbody></table> <h3 id="优先级间的转换"><a href="#优先级间的转换" class="header-anchor">#</a> 优先级间的转换</h3> <ul><li>lane 优先级 转 event 优先级（参考 <code>lanesToEventPriority</code> 函数）
<ul><li>转换规则：以区间的形式根据传入的 lane 返回对应的 event 优先级。比如传入的优先级不大于 Discrete 优先级，就返回 Discrete 优先级，以此类推</li></ul></li> <li>event 优先级 转 scheduler 优先级（参考 <code>ensureRootIsScheduled</code> 函数）
<ul><li>转换规则：可以参考上面 scheduler 优先级表</li></ul></li> <li>event 优先级 转 lane 优先级（参考 <code>getEventPriority</code> 函数）
<ul><li>转换规则：对于非离散、连续的事件，会根据一定规则作转换，具体课参考上面 event 优先级表</li></ul></li></ul> <h2 id="优先级机制如何设计"><a href="#优先级机制如何设计" class="header-anchor">#</a> 优先级机制如何设计</h2> <p>说到优先级机制，我们可能马上能联想到的是优先级队列，其最突出的特性是<code>最高优先级先出</code>，react 的优先级机制跟优先级队列类似，不过其利用了<code>赛道</code>的概念，配合<code>位与运算</code>丰富了队列的功能，比起优先级队列，读写速度更快，更加容易理解</p> <h3 id="设计思路"><a href="#设计思路" class="header-anchor">#</a> 设计思路</h3> <ol><li>合并赛道：维护一个队列，可以存储被占用的赛道</li> <li>释放赛道：根据优先级释放对应被占用赛道</li> <li>找出最高优先级赛道：获取队列中最高优先级赛道</li> <li>快速定位赛道索引：根据优先级获取赛道在队列中所在的位置</li> <li>判断赛道是否被占用：根据传入优先级判断该优先级所在赛道是否被占用</li></ol> <h3 id="合并赛道"><a href="#合并赛道" class="header-anchor">#</a> 合并赛道</h3> <ul><li>场景
<ul><li>比如当前正在调度的任务优先级是 DefaultLane，用户点击触发更新，有一个高优先级的任务 SyncLane 产生，需要存储这个任务所占用的赛道</li></ul></li> <li>运算过程
<ul><li>运算方式：位或运算 - <code>a | b</code></li> <li>运算结果：DefaultLane 和 SyncLane 分别占用了第 1 条和第 5 条赛道</li></ul></li></ul> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>DefaultLane优先级为16，SyncLane优先级为1

<span class="token key attr-name">16 | 1</span> <span class="token punctuation">=</span> <span class="token value attr-value">17</span>

17的二进制值为10001
16的二进制值为10000，1的二进制值为00001
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="释放赛道"><a href="#释放赛道" class="header-anchor">#</a> 释放赛道</h3> <ul><li>场景
<ul><li>SyncLane 任务执行完，需要释放占用的赛道</li></ul></li> <li>运算过程
<ul><li>运算方式：位与+位非 - <code>a &amp; ~b</code></li> <li>运算结果：SyncLane 赛道被释放，只剩下 DefaultLane 赛道</li></ul></li></ul> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token key attr-name">17 &amp; ~1</span> <span class="token punctuation">=</span> <span class="token value attr-value">16</span>
17的二进制值为10001

为什么用位非？
<span class="token key attr-name">~1</span> <span class="token punctuation">=</span> <span class="token value attr-value">-2</span>
2 的二进制是00010，-2的话符号位取反变为10010
10001和10010进行位与运算得到10000，也就是十进制的16
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="找出最高优先级赛道"><a href="#找出最高优先级赛道" class="header-anchor">#</a> 找出最高优先级赛道</h3> <ul><li>场景
<ul><li>当前有 DefaultLane 和 SyncLane 两个优先级的任务占用赛道，在进入 ensureRootIsScheduled 方法后，我需要先调度优先级最高的任务，所以需要找出当前优先级最高的赛道</li></ul></li> <li>运算过程
<ul><li>运算方式：位与+符号位取反 - <code>a &amp; -b</code></li> <li>运算结果：找到了最高优先级的任务 SyncLane，SyncLane 任务为同步任务，Scheduler 将以同步优先级调度当前应用根节点</li></ul></li></ul> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code><span class="token key attr-name">17 &amp; -17</span> <span class="token punctuation">=</span> <span class="token value attr-value">1</span>

17的二进制值为10001
-17的二进制值为00001
10001和00001进行位与运算得到1，也就是SyncLane
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="快速定位赛道索引"><a href="#快速定位赛道索引" class="header-anchor">#</a> 快速定位赛道索引</h3> <ul><li>场景
<ul><li>饥饿任务唤醒：在发起调度前，我们需要对队列中的所有赛道进行一个判断，判断该赛道的任务是否过期，如果过期，就优先执行该过期任务。为此，需要维护一个长度为 31 的数组，数组的每个元素的下标索引与 31 个优先级赛道一一对应，数组中存储的是<code>任务的过期时间</code>，在判断时，我们希望能根据优先级快速找到该优先级在数组中对应的位置。</li></ul></li> <li>运算过程
<ul><li>运算方式：<code>Math.clz32</code></li> <li>运算结果：找到了 DefaultLane 的索引位置为 4，那就可以释放应用根节点上的 eventTimes、expirationTimes，将其所在位置的值赋值为-1，然后执行对应的过期任务</li></ul></li></ul> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>// 找出 DefaultLane 赛道索引
<span class="token key attr-name">31 - Math.clz32(16)</span> <span class="token punctuation">=</span> <span class="token value attr-value">4</span>

16的二进制值为10000
索引4对应的就是第五个赛道
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Math.clz32 是用来干什么的？</p> <ul><li>获取一个十进制数字对应二进制值中开头 0 的个数。</li> <li>所以用 31 减去 <code>Math.clz32</code> 的值就能得到该赛道的索引</li></ul> <h3 id="判断赛道是否被占用"><a href="#判断赛道是否被占用" class="header-anchor">#</a> 判断赛道是否被占用</h3> <p><code>异步模式</code>下会存在高优先级任务插队的情况，此情况下 <code>state</code> 的计算方式会跟<code>同步模式</code>下有些不同。</p> <ul><li>场景
<ol><li>我们 <code>setState</code> 之后并不是马上就会更新 state，而是会根据 setState 的内容生成一个 <code>Update</code> 对象，这个对象包含了更新内容、更新优先级等属性。</li> <li>更新 <code>state</code> 这个动作是在 <code>processUpdateQueue</code> 函数里进行的，函数里面会判断 <code>Update</code> 对象的优先级所在赛道是否被占用，来决定是否在此轮任务中计算这个 Update 对象的 state
<ul><li>如果被占用，代表 <code>Update</code> 对象优先级和当前正在进行的任务相等，可以根据 <code>Update</code> 对象计算 state 并更新到 <code>Fiber</code> 节点的 <code>memoizedState</code> 属性上</li> <li>如果未被占用，代表当前正在进行的任务优先级比这个 <code>Update</code> 对象优先级高，相应的这个低优先级的 <code>Update</code> 对象将暂不被计算 state，留到下一轮低优先级任务被重启时再进行计算</li></ul></li></ol></li> <li>运算过程
<ul><li>运算方式：位与 <code>(renderLanes &amp; updateLanes) == updateLanes</code></li> <li>运算结果：0 代表当前调度优先级高于某个 Update 对象优先级</li></ul></li></ul> <div class="language-ini line-numbers-mode"><pre class="language-ini"><code>运算公式
<span class="token key attr-name">(1 &amp; 16)</span> <span class="token punctuation">=</span><span class="token value attr-value">= 16</span>

1的二进制值为00001
16的二进制值为10000
00001和10000进行位与运算得到0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="如何将优先级机制融入-react-运行时"><a href="#如何将优先级机制融入-react-运行时" class="header-anchor">#</a> 如何将优先级机制融入 React 运行时</h2> <h3 id="生成一个更新任务"><a href="#生成一个更新任务" class="header-anchor">#</a> 生成一个更新任务</h3> <p>生成任务的流程其实非常简单，入口就在我们常用的 setState 函数，先上图</p> <img src="/luvue/images/react/05-react18/react18-092503.webp" alt="react/05-react18/react18-092503.webp"> <p><code>setState</code> 函数内部执行的就是 <code>enqueueUpdate</code> 函数，而 <code>enqueueUpdate</code> 函数的工作主要分为 4 步：</p> <ol><li>获取本次更新的优先级。</li> <li>创建 <code>Update</code> 对象</li> <li>将本次更新优先级关联到当前 Fiber 节点、父级节点和应用根节点</li> <li>发起 <code>ensureRootIsScheduled</code> 调度。</li></ol> <h3 id="步骤一-获取本次更新的优先级"><a href="#步骤一-获取本次更新的优先级" class="header-anchor">#</a> 步骤一：获取本次更新的优先级</h3> <p>步骤一的工作是调用 <code>requestUpdateLane</code> 函数拿到此次更新任务的优先级</p> <ol><li>如果当前为非 <code>concurrent</code> 模式
<ul><li>当前不在 render 阶段。返回 syncLane</li> <li>当前正在 render 阶段。返回 workInProgressRootRenderLanes 中最高的优先级（这里就用到上面的优先级运算机制，<code>找出最高优先级赛道</code>）</li></ul></li> <li>如果当前为 <code>concurrent</code> 模式
<ul><li>需要执行延迟任务的话，比如 <code>Suspend</code>、<code>useTransition</code>、<code>useDefferedValue</code> 等特性。在 <code>transition</code> 类型的优先级中寻找空闲的赛道。<code>transition</code> 类型的赛道有 16 条，从第 1 条到第 16 条，当到达第 16 条赛道后，下一次 transition 类型的任务会回到第 1 条赛道，如此往复。</li> <li>执行 <code>getCurrentUpdatePriority</code> 函数。获取当前更新优先级。如果不为 <code>NoLane</code> 就返回</li> <li>执行 <code>getCurrentEventPriority</code> 函数。返回当前的事件优先级。如果没有事件产生，返回 <code>DefaultEventPriority</code></li></ul></li></ol> <p>总的来说，<code>requestUpdateLane</code> 函数的优先级选取判断顺序如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SyncLane  &gt;&gt;  TransitionLane  &gt;&gt;  UpdateLane  &gt;&gt;  EventLane
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>估计有很多小伙伴都会很困惑一个问题，为什么会有这么多获取优先级的函数，这里我整理了一下其他函数的职责</p></blockquote> <img src="/luvue/images/react/05-react18/react18-092504.webp" alt="react/05-react18/react18-092504.webp"> <h3 id="步骤二-创建-update-对象"><a href="#步骤二-创建-update-对象" class="header-anchor">#</a> 步骤二：创建 Update 对象</h3> <p>这里的代码量不多，其实就是将 setState 的参数用一个对象封装起来，留给 render 阶段用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token parameter">eventTime<span class="token punctuation">,</span> lane</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
    eventTime<span class="token operator">:</span> eventTime<span class="token punctuation">,</span>
    lane<span class="token operator">:</span> lane<span class="token punctuation">,</span>
    tag<span class="token operator">:</span> UpdateState<span class="token punctuation">,</span>
    payload<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    callback<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> update<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="步骤三-关联优先级"><a href="#步骤三-关联优先级" class="header-anchor">#</a> 步骤三：关联优先级</h3> <p>在这里先解释两个概念，一个是 <code>HostRoot</code>，一个是 <code>FiberRootNode</code></p> <ul><li><code>HostRoot</code>：就是 <code>ReactDOM.render</code> 的第一个参数，组件树的根节点。<code>HostRoot</code>可能会存在多个，因为 <code>ReactDOM.render</code> 可以多次调用</li> <li><code>FiberRootNode</code>：react 的应用根节点，每个页面只有一个 react 的应用根节点。可以从 <code>HostRoot</code> 节点的 <code>stateNode</code> 属性访问</li></ul> <p>这里关联优先级主要执行了两个函数</p> <ol><li><code>markUpdateLaneFromFiberToRoot</code>。该函数主要做了两个事情
<ul><li>将优先级合并到当前 Fiber 节点的 lanes 属性中</li> <li>将优先级合并到父级节点的 childLanes 属性中（告诉父节点他的子节点有多少条赛道要跑） 但因为函数传入的 Fiber 节点是 <code>HostRoot</code>，也就是 <code>ReactDOM.render</code> 的根节点，也就是说没有父节点了，所以第二件事情没有做</li></ul></li> <li>markRootUpdated。该函数也是主要做了两个事情
<ul><li>将待调度任务优先级合并到当前 react 应用根节点上</li> <li>计算当前任务优先级赛道占用的开始时间（eventTime）</li></ul></li></ol> <p>由此可见，react 的优先级机制并不独立运行在每一个组件节点里面，而是依赖一个全局的 react 应用根节点去控制下面多个组件树的任务调度</p> <blockquote><p>将优先级关联到这些 Fiber 节点有什么用？</p></blockquote> <p>先说说他们的<code>区别</code></p> <ul><li>lanes：只存在非 react 应用根节点上，记录当前 Fiber 节点的 lane 优先级</li> <li>childLanes：只存在非 react 应用根节点上，记录当前 Fiber 节点下的所有子 Fiber 节点的 lane 优先级</li> <li>pendingLanes：只存在 react 应用根节点上，记录的是所有 HostRoot 的 lane 优先级</li></ul> <p>具体<code>应用场景</code></p> <ol><li>释放赛道。上面说的优先级运算机制提到了任务执行完毕会释放赛道，具体来说是在 commit 阶段结束之后释放被占用的优先级，也就是 markRootFinished 函数。</li> <li>判断赛道是否被占用。在 render 阶段的 beginWork 流程里面，会有很多判断 childLanes 是否被占用的判断</li></ol> <h3 id="高优先级任务打断低优先级任务"><a href="#高优先级任务打断低优先级任务" class="header-anchor">#</a> 高优先级任务打断低优先级任务</h3> <p>该部分流程可以分为三部曲</p> <ol><li>cancelCallback</li> <li>pop(taskQueue)</li> <li>低优先级任务重启</li></ol> <h3 id="cancelcallback"><a href="#cancelcallback" class="header-anchor">#</a> cancelCallback</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> existingCallbackNode <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackNode<span class="token punctuation">;</span>
<span class="token keyword">var</span> existingCallbackPriority <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackPriority<span class="token punctuation">;</span>
<span class="token keyword">var</span> newCallbackPriority <span class="token operator">=</span> <span class="token function">getHighestPriorityLane</span><span class="token punctuation">(</span>nextLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter">existingCallbackPriority <span class="token operator">===</span> newCallbackPriority</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter">existingCallbackNode <span class="token operator">!=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cancelCallback</span><span class="token punctuation">(</span>existingCallbackNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

newCallbackNode <span class="token operator">=</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>
    schedulerPriorityLevel<span class="token punctuation">,</span>
    <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> newCallbackPriority<span class="token punctuation">;</span>
root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> newCallbackNode<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>上面是 <code>ensureRootIsScheduled</code> 函数的一些代码片段，先对变量做解释</p> <ul><li><code>existingCallbackNode</code>：当前 render 阶段正在进行的任务</li> <li><code>existingCallbackPriority</code>：当前 render 阶段正在进行的任务优先级</li> <li><code>newCallbackPriority</code>：此次调度优先级</li></ul> <p>这里会判断 <code>existingCallbackPriority</code> 和 <code>newCallbackPriority</code> 两个优先级是否相等，如果相等，此次更新合并到当前正在进行的任务中。如果不相等，代表此次更新任务的优先级更高，需要打断当前正在进行的任务</p> <p>如何打断任务？</p> <ol><li>关键函数 <code>cancelCallback(existingCallbackNode)</code>，<code>cancelCallback</code> 函数就是将 <code>root.callbackNode</code> 赋值为 null</li> <li><code>performConcurrentWorkOnRoot</code> 函数会先把 <code>root.callbackNode</code> 缓存起来，在函数末尾会再判断 <code>root.callbackNode</code> 和开始缓存起来的值是否一样，如果不一样，就代表 <code>root.callbackNode</code> 被赋值为 null 了，有更高优先级任务进来。</li> <li>此时 <code>performConcurrentWorkOnRoot</code> 返回值为 null</li></ol> <p>下面是 <code>performConcurrentWorkOnRoot</code> 代码片段</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">...</span>
<span class="token keyword">var</span> originalCallbackNode <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackNode<span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token comment">// 函数末尾</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">.</span>callbackNode <span class="token operator">===</span> originalCallbackNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>由上面 <code>ensureRootIsScheduled</code> 的代码片段可以知道，<code>performConcurrentWorkOnRoot</code> 函数是被 <code>scheduleCallback</code> 函数调度的，具体返回后的逻辑需要到 <code>Scheduler</code> 模块去找</p> <h3 id="pop-taskqueue"><a href="#pop-taskqueue" class="header-anchor">#</a> pop(taskQueue)</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> callback <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">pop</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上面是 <code>Scheduler</code> 模块里面 <code>workLoop</code> 函数的代码片段，<code>currentTask.callback</code> 就是 <code>scheduleCallback</code> 的第二个参数，也就是 <code>performConcurrentWorkOnRoot</code> 函数</p> <p>承接上个主题，如果 <code>performConcurrentWorkOnRoot</code> 函数返回了 null，<code>workLoop</code> 内部就会执行 <code>pop(taskQueue)</code>，将当前的任务从 <code>taskQueue</code> 中弹出。</p> <h3 id="低优先级任务重启"><a href="#低优先级任务重启" class="header-anchor">#</a> 低优先级任务重启</h3> <p>上一步中说道一个低优先级任务从 <code>taskQueue</code> 中被弹出。那高优先级任务执行完毕之后，如何重启回之前的低优先级任务呢？</p> <p>关键是在 <code>commitRootImpl</code> 函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> remainingLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lanes<span class="token punctuation">,</span> finishedWork<span class="token punctuation">.</span>childLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">markRootFinished</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> remainingLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">...</span>

<span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>markRootFinished</code> 函数刚刚上面说了是释放已完成任务所占用的赛道，那也就是说未完成任务依然会占用其赛道，所以我们可以重新调用 <code>ensureRootIsScheduled</code> 发起一次新的调度，去重启低优先级任务的执行。我们可以看下重启部分的判断</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> nextLanes <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>
    root<span class="token punctuation">,</span> root <span class="token operator">===</span> workInProgressRoot <span class="token operator">?</span> workInProgressRootRenderLanes <span class="token operator">:</span> NoLanes
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果 nextLanes 为 NoLanes，就证明所有任务都执行完毕了</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>nextLanes <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoLane<span class="token punctuation">;</span>
    <span class="token comment">// 只要 nextLanes 为 NoLanes，就可以结束调度了</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 如果 nextLanes 不为 NoLanes，就代表还有任务未执行完，也就是那些被打断的低优先级任务</span>
<span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="饥饿任务问题"><a href="#饥饿任务问题" class="header-anchor">#</a> 饥饿任务问题</h3> <p>上面说到，在高优先级任务执行完毕之后，低优先级任务就会被重启，但假设如果持续有高优先级任务持续进来，我的低优先级任务岂不是没有重启之日？</p> <p>所以 react 为了处理解决饥饿任务问题，react 在 <code>ensureRootIsScheduled</code> 函数开始的时候做了以下处理：（参考 <code>markStarvedLanesAsExpired</code> 函数）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> lanes <span class="token operator">=</span> pendingLanes<span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>lanes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token function">pickArbitraryLaneIndex</span><span class="token punctuation">(</span>lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> lane <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> index<span class="token punctuation">;</span>
  <span class="token keyword">var</span> expirationTime <span class="token operator">=</span> expirationTimes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> NoTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token punctuation">(</span>lane <span class="token operator">&amp;</span> suspendedLanes<span class="token punctuation">)</span> <span class="token operator">===</span> NoLanes <span class="token operator">||</span>
      <span class="token punctuation">(</span>lane <span class="token operator">&amp;</span> pingedLanes<span class="token punctuation">)</span> <span class="token operator">!==</span> NoLanes
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      expirationTimes<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computeExpirationTime</span><span class="token punctuation">(</span>lane<span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">&lt;=</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    root<span class="token punctuation">.</span>expiredLanes <span class="token operator">|=</span> lane<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  lanes <span class="token operator">&amp;=</span> <span class="token operator">~</span>lane<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol><li>遍历 31 条赛道，判断每条赛道的过期时间是否为 <code>NoTimestamp</code>，如果是，且该赛道存在待执行的任务，则为该赛道初始化过期时间</li> <li>如果该赛道已存在过期时间，且过期时间已经小于当前时间，则代表任务已过期，需要将当前优先级合并到 <code>expiredLanes</code>，这样在下一轮 render 阶段就会以同步优先级调度当前 <code>HostRoot</code></li></ol> <p>可以参考 render 阶段执行的函数 <code>performConcurrentWorkOnRoot</code> 中的代码片段</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> exitStatus <span class="token operator">=</span>
  <span class="token function">shouldTimeSlice</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didTimeout
    <span class="token operator">?</span> <span class="token function">renderRootConcurrent</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到只要 <code>shouldTimeSlice</code> 只要返回 false，就会执行 <code>renderRootSync</code>，也就是以同步优先级进入 render 阶段。而 <code>shouldTimeSlice</code> 的逻辑也就是刚刚的 <code>expiredLanes</code> 属性相关</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">shouldTimeSlice</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> lanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果 expiredLanes 里面有东西，代表有饥饿任务</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lanes <span class="token operator">&amp;</span> root<span class="token punctuation">.</span>expiredLanes<span class="token punctuation">)</span> <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> SyncDefaultLanes <span class="token operator">=</span>
    InputContinuousHydrationLane <span class="token operator">|</span>
    InputContinuousLane <span class="token operator">|</span>
    DefaultHydrationLane <span class="token operator">|</span>
    DefaultLane<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>lanes <span class="token operator">&amp;</span> SyncDefaultLanes<span class="token punctuation">)</span> <span class="token operator">===</span> NoLanes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>react 的优先级机制在源码中并不是一个独立的，解耦的模块，而是涉及到了 react 整体运行的方方面面，最后回归整理下优先级机制在源码中的使用，让大家对优先级机制有一个更加整体的认知。</p> <ol><li>时间分片。涉及到任务打断、根据优先级计算分片时长</li> <li>setState 生成 Update 对象。每个 Update 对象里面都有一个 lane 属性，代表此次更新的优先级</li> <li>高优先级任务打断低优先级任务。每一次调度都会对正在进行任务和当前任务最高优先级做比较，如果不相等，就代表有高优先级任务进来，需要打断当前正在的任务。</li> <li>低优先级任务重启。协调 (<code>reconcile</code>) 的下一个阶段是渲染 (renderer)，也就是我们说的 commit 阶段，在此阶段末尾，会调用 <code>ensureRootIsScheduled</code> 发起一次新的调度，执行尚未完成的低优先级任务。</li> <li>饥饿任务唤醒。每次调度的开始，都会先检查下有没有过期任务，如果有的话，下一次就会以同步优先级进行 render 任务(<code>reconcile</code>)，同步优先级就是最高的优先级，不会被打断</li></ol> <p>最后的最后，整理了一张整体的 react 思维导图，<code>Scheduler</code> 模块的基本整理完了，后面的会围绕 render 阶段和 commit 阶段开讲。</p> <img src="/luvue/images/react/05-react18/react18-092505.webp" alt="react/05-react18/react18-092505.webp"></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/luvue/react/05-react18/02-50行代码实现react时间分片.html" class="prev">02-50行代码实现react时间分片</a></span> <span class="next"><a href="/luvue/react/06-react-router/01-react-router-v6.html">01-react-router-v6</a>
      →
    </span></p></div> </main> <span data-v-2ae0ee72></span></div><div class="global-ui"></div></div>
    <script src="/luvue/assets/js/app.50227b6d.js" defer></script><script src="/luvue/assets/js/2.dc297d8e.js" defer></script><script src="/luvue/assets/js/3.51a2d233.js" defer></script><script src="/luvue/assets/js/188.cfcaabfb.js" defer></script>
  </body>
</html>
