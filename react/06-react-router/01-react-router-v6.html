<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React-Router v6 完全解读指南 - react-router 篇 | Ailjc notes</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel=" " href=" ">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/luvue/assets/css/0.styles.0c275c11.css" as="style"><link rel="preload" href="/luvue/assets/js/app.50227b6d.js" as="script"><link rel="preload" href="/luvue/assets/js/2.dc297d8e.js" as="script"><link rel="preload" href="/luvue/assets/js/3.51a2d233.js" as="script"><link rel="preload" href="/luvue/assets/js/190.a66da869.js" as="script"><link rel="prefetch" href="/luvue/assets/js/10.4dcff8ef.js"><link rel="prefetch" href="/luvue/assets/js/100.4a463fa3.js"><link rel="prefetch" href="/luvue/assets/js/101.16c4fcf8.js"><link rel="prefetch" href="/luvue/assets/js/102.5b1d6c4c.js"><link rel="prefetch" href="/luvue/assets/js/103.14584991.js"><link rel="prefetch" href="/luvue/assets/js/104.116f4d80.js"><link rel="prefetch" href="/luvue/assets/js/105.81576762.js"><link rel="prefetch" href="/luvue/assets/js/106.5757f0a1.js"><link rel="prefetch" href="/luvue/assets/js/107.011fc1df.js"><link rel="prefetch" href="/luvue/assets/js/108.502e4c8c.js"><link rel="prefetch" href="/luvue/assets/js/109.904aca6f.js"><link rel="prefetch" href="/luvue/assets/js/11.e6154571.js"><link rel="prefetch" href="/luvue/assets/js/110.97e25b5c.js"><link rel="prefetch" href="/luvue/assets/js/111.edcade6b.js"><link rel="prefetch" href="/luvue/assets/js/112.75c283fd.js"><link rel="prefetch" href="/luvue/assets/js/113.ac993ad7.js"><link rel="prefetch" href="/luvue/assets/js/114.1dfc2617.js"><link rel="prefetch" href="/luvue/assets/js/115.a55cebf2.js"><link rel="prefetch" href="/luvue/assets/js/116.e3650879.js"><link rel="prefetch" href="/luvue/assets/js/117.c98d9d80.js"><link rel="prefetch" href="/luvue/assets/js/118.2ef2cb19.js"><link rel="prefetch" href="/luvue/assets/js/119.a56e96cb.js"><link rel="prefetch" href="/luvue/assets/js/12.271e8805.js"><link rel="prefetch" href="/luvue/assets/js/120.ea37c8e9.js"><link rel="prefetch" href="/luvue/assets/js/121.e84aa3eb.js"><link rel="prefetch" href="/luvue/assets/js/122.2809183d.js"><link rel="prefetch" href="/luvue/assets/js/123.ef109ed8.js"><link rel="prefetch" href="/luvue/assets/js/124.d7a754ba.js"><link rel="prefetch" href="/luvue/assets/js/125.e368457d.js"><link rel="prefetch" href="/luvue/assets/js/126.2b1e6d99.js"><link rel="prefetch" href="/luvue/assets/js/127.d197f125.js"><link rel="prefetch" href="/luvue/assets/js/128.1a3bba89.js"><link rel="prefetch" href="/luvue/assets/js/129.43fa9b4c.js"><link rel="prefetch" href="/luvue/assets/js/13.f6b3db37.js"><link rel="prefetch" href="/luvue/assets/js/130.ff13b9c1.js"><link rel="prefetch" href="/luvue/assets/js/131.25eb4de5.js"><link rel="prefetch" href="/luvue/assets/js/132.386f97d9.js"><link rel="prefetch" href="/luvue/assets/js/133.defdd861.js"><link rel="prefetch" href="/luvue/assets/js/134.0aba29a4.js"><link rel="prefetch" href="/luvue/assets/js/135.f1cc2592.js"><link rel="prefetch" href="/luvue/assets/js/136.5fea8f28.js"><link rel="prefetch" href="/luvue/assets/js/137.15521ec2.js"><link rel="prefetch" href="/luvue/assets/js/138.2e96476f.js"><link rel="prefetch" href="/luvue/assets/js/139.b3e580c7.js"><link rel="prefetch" href="/luvue/assets/js/14.e2545646.js"><link rel="prefetch" href="/luvue/assets/js/140.7254c946.js"><link rel="prefetch" href="/luvue/assets/js/141.309b75d5.js"><link rel="prefetch" href="/luvue/assets/js/142.e1587e8c.js"><link rel="prefetch" href="/luvue/assets/js/143.c6e04498.js"><link rel="prefetch" href="/luvue/assets/js/144.ccf79776.js"><link rel="prefetch" href="/luvue/assets/js/145.faa65998.js"><link rel="prefetch" href="/luvue/assets/js/146.1b7c11e7.js"><link rel="prefetch" href="/luvue/assets/js/147.f19de9ec.js"><link rel="prefetch" href="/luvue/assets/js/148.aba5552d.js"><link rel="prefetch" href="/luvue/assets/js/149.f1c10580.js"><link rel="prefetch" href="/luvue/assets/js/15.a3a78949.js"><link rel="prefetch" href="/luvue/assets/js/150.8c715a8a.js"><link rel="prefetch" href="/luvue/assets/js/151.1d867a79.js"><link rel="prefetch" href="/luvue/assets/js/152.22ae9445.js"><link rel="prefetch" href="/luvue/assets/js/153.1024de46.js"><link rel="prefetch" href="/luvue/assets/js/154.48bb1114.js"><link rel="prefetch" href="/luvue/assets/js/155.bd946cd8.js"><link rel="prefetch" href="/luvue/assets/js/156.f1d78b05.js"><link rel="prefetch" href="/luvue/assets/js/157.63356c24.js"><link rel="prefetch" href="/luvue/assets/js/158.44bfb42f.js"><link rel="prefetch" href="/luvue/assets/js/159.41731d4e.js"><link rel="prefetch" href="/luvue/assets/js/16.bdbc9ac3.js"><link rel="prefetch" href="/luvue/assets/js/160.fe64fd3e.js"><link rel="prefetch" href="/luvue/assets/js/161.3af3f899.js"><link rel="prefetch" href="/luvue/assets/js/162.a020acea.js"><link rel="prefetch" href="/luvue/assets/js/163.ebfa2fea.js"><link rel="prefetch" href="/luvue/assets/js/164.5c72d951.js"><link rel="prefetch" href="/luvue/assets/js/165.739d51ec.js"><link rel="prefetch" href="/luvue/assets/js/166.54be55b5.js"><link rel="prefetch" href="/luvue/assets/js/167.6f6b0af9.js"><link rel="prefetch" href="/luvue/assets/js/168.059c4bbb.js"><link rel="prefetch" href="/luvue/assets/js/169.9583f311.js"><link rel="prefetch" href="/luvue/assets/js/17.267c53f7.js"><link rel="prefetch" href="/luvue/assets/js/170.f7ab2a56.js"><link rel="prefetch" href="/luvue/assets/js/171.aa5c6d65.js"><link rel="prefetch" href="/luvue/assets/js/172.7b70d120.js"><link rel="prefetch" href="/luvue/assets/js/173.8d733f83.js"><link rel="prefetch" href="/luvue/assets/js/174.41a36264.js"><link rel="prefetch" href="/luvue/assets/js/175.643cec2e.js"><link rel="prefetch" href="/luvue/assets/js/176.17a19152.js"><link rel="prefetch" href="/luvue/assets/js/177.00bffe2d.js"><link rel="prefetch" href="/luvue/assets/js/178.39d6dd1d.js"><link rel="prefetch" href="/luvue/assets/js/179.97c25b6d.js"><link rel="prefetch" href="/luvue/assets/js/18.b4dc00ad.js"><link rel="prefetch" href="/luvue/assets/js/180.f001f92c.js"><link rel="prefetch" href="/luvue/assets/js/181.b4ff3df9.js"><link rel="prefetch" href="/luvue/assets/js/182.21c49e0c.js"><link rel="prefetch" href="/luvue/assets/js/183.a68aedcf.js"><link rel="prefetch" href="/luvue/assets/js/184.1cc2979e.js"><link rel="prefetch" href="/luvue/assets/js/185.820ead5b.js"><link rel="prefetch" href="/luvue/assets/js/186.2ad000ef.js"><link rel="prefetch" href="/luvue/assets/js/187.fa9b511d.js"><link rel="prefetch" href="/luvue/assets/js/188.cfcaabfb.js"><link rel="prefetch" href="/luvue/assets/js/189.c7913649.js"><link rel="prefetch" href="/luvue/assets/js/19.61df46ad.js"><link rel="prefetch" href="/luvue/assets/js/191.d21b8a3e.js"><link rel="prefetch" href="/luvue/assets/js/192.3a3f0b99.js"><link rel="prefetch" href="/luvue/assets/js/193.6005ffb1.js"><link rel="prefetch" href="/luvue/assets/js/194.9b365175.js"><link rel="prefetch" href="/luvue/assets/js/195.4e4e83f5.js"><link rel="prefetch" href="/luvue/assets/js/196.24df233b.js"><link rel="prefetch" href="/luvue/assets/js/197.42cfce0b.js"><link rel="prefetch" href="/luvue/assets/js/198.3998b360.js"><link rel="prefetch" href="/luvue/assets/js/199.6e1b267e.js"><link rel="prefetch" href="/luvue/assets/js/20.ae4d73d6.js"><link rel="prefetch" href="/luvue/assets/js/200.78a26196.js"><link rel="prefetch" href="/luvue/assets/js/201.e15689f7.js"><link rel="prefetch" href="/luvue/assets/js/202.351e4200.js"><link rel="prefetch" href="/luvue/assets/js/203.6732fa0f.js"><link rel="prefetch" href="/luvue/assets/js/204.bdaedc2f.js"><link rel="prefetch" href="/luvue/assets/js/205.769cfdfa.js"><link rel="prefetch" href="/luvue/assets/js/206.5980160d.js"><link rel="prefetch" href="/luvue/assets/js/207.4f27fd16.js"><link rel="prefetch" href="/luvue/assets/js/208.f715439d.js"><link rel="prefetch" href="/luvue/assets/js/209.26ff4509.js"><link rel="prefetch" href="/luvue/assets/js/21.756c7992.js"><link rel="prefetch" href="/luvue/assets/js/210.7c211a09.js"><link rel="prefetch" href="/luvue/assets/js/211.70a47632.js"><link rel="prefetch" href="/luvue/assets/js/212.fda6d44b.js"><link rel="prefetch" href="/luvue/assets/js/213.ec7d646a.js"><link rel="prefetch" href="/luvue/assets/js/214.3c165f1f.js"><link rel="prefetch" href="/luvue/assets/js/215.79377a1f.js"><link rel="prefetch" href="/luvue/assets/js/216.1300dd6d.js"><link rel="prefetch" href="/luvue/assets/js/217.1ee87399.js"><link rel="prefetch" href="/luvue/assets/js/218.6f58fde9.js"><link rel="prefetch" href="/luvue/assets/js/219.3e5ec5b0.js"><link rel="prefetch" href="/luvue/assets/js/22.68b75c4f.js"><link rel="prefetch" href="/luvue/assets/js/220.bac8627d.js"><link rel="prefetch" href="/luvue/assets/js/221.65afbd17.js"><link rel="prefetch" href="/luvue/assets/js/222.10b495b9.js"><link rel="prefetch" href="/luvue/assets/js/223.9483fde2.js"><link rel="prefetch" href="/luvue/assets/js/224.f0f0b115.js"><link rel="prefetch" href="/luvue/assets/js/225.82f4db59.js"><link rel="prefetch" href="/luvue/assets/js/226.837beb3c.js"><link rel="prefetch" href="/luvue/assets/js/227.88dfd603.js"><link rel="prefetch" href="/luvue/assets/js/228.926b67f1.js"><link rel="prefetch" href="/luvue/assets/js/229.d5432625.js"><link rel="prefetch" href="/luvue/assets/js/23.f144c5d8.js"><link rel="prefetch" href="/luvue/assets/js/230.af30858c.js"><link rel="prefetch" href="/luvue/assets/js/231.d094a5d4.js"><link rel="prefetch" href="/luvue/assets/js/232.001ef00e.js"><link rel="prefetch" href="/luvue/assets/js/233.63941e40.js"><link rel="prefetch" href="/luvue/assets/js/234.942f27c3.js"><link rel="prefetch" href="/luvue/assets/js/235.304392bc.js"><link rel="prefetch" href="/luvue/assets/js/236.d9a2338f.js"><link rel="prefetch" href="/luvue/assets/js/237.3e31a7be.js"><link rel="prefetch" href="/luvue/assets/js/238.50a6e0a4.js"><link rel="prefetch" href="/luvue/assets/js/239.67f7ea74.js"><link rel="prefetch" href="/luvue/assets/js/24.050e500e.js"><link rel="prefetch" href="/luvue/assets/js/240.7e126350.js"><link rel="prefetch" href="/luvue/assets/js/241.4b6526f2.js"><link rel="prefetch" href="/luvue/assets/js/242.2c0594df.js"><link rel="prefetch" href="/luvue/assets/js/243.2947ca1f.js"><link rel="prefetch" href="/luvue/assets/js/244.c13ff375.js"><link rel="prefetch" href="/luvue/assets/js/245.f35e7258.js"><link rel="prefetch" href="/luvue/assets/js/246.a4160daf.js"><link rel="prefetch" href="/luvue/assets/js/247.5add7de3.js"><link rel="prefetch" href="/luvue/assets/js/248.285f48bf.js"><link rel="prefetch" href="/luvue/assets/js/249.6bfc19fe.js"><link rel="prefetch" href="/luvue/assets/js/25.7161d756.js"><link rel="prefetch" href="/luvue/assets/js/250.7d9d5a0d.js"><link rel="prefetch" href="/luvue/assets/js/251.ad83fc91.js"><link rel="prefetch" href="/luvue/assets/js/252.79ce4a94.js"><link rel="prefetch" href="/luvue/assets/js/253.6733159c.js"><link rel="prefetch" href="/luvue/assets/js/254.8cbd88de.js"><link rel="prefetch" href="/luvue/assets/js/255.a6ded312.js"><link rel="prefetch" href="/luvue/assets/js/256.4a6348be.js"><link rel="prefetch" href="/luvue/assets/js/257.16709fb2.js"><link rel="prefetch" href="/luvue/assets/js/258.65f7c45d.js"><link rel="prefetch" href="/luvue/assets/js/259.d6bf3339.js"><link rel="prefetch" href="/luvue/assets/js/26.da9ec7cd.js"><link rel="prefetch" href="/luvue/assets/js/260.2e2fc30d.js"><link rel="prefetch" href="/luvue/assets/js/261.8ed2d945.js"><link rel="prefetch" href="/luvue/assets/js/262.02d4d5ca.js"><link rel="prefetch" href="/luvue/assets/js/263.8a02e4d0.js"><link rel="prefetch" href="/luvue/assets/js/264.5fad29a4.js"><link rel="prefetch" href="/luvue/assets/js/265.1cd29535.js"><link rel="prefetch" href="/luvue/assets/js/266.e5a1aad7.js"><link rel="prefetch" href="/luvue/assets/js/267.a51a94be.js"><link rel="prefetch" href="/luvue/assets/js/268.5d9bc388.js"><link rel="prefetch" href="/luvue/assets/js/269.81be7c5e.js"><link rel="prefetch" href="/luvue/assets/js/27.d35fe8d8.js"><link rel="prefetch" href="/luvue/assets/js/270.bf9cf8c5.js"><link rel="prefetch" href="/luvue/assets/js/271.f5f0e39d.js"><link rel="prefetch" href="/luvue/assets/js/272.2c2d8519.js"><link rel="prefetch" href="/luvue/assets/js/273.207adc32.js"><link rel="prefetch" href="/luvue/assets/js/274.4dceda17.js"><link rel="prefetch" href="/luvue/assets/js/275.c1310482.js"><link rel="prefetch" href="/luvue/assets/js/276.4201cd6e.js"><link rel="prefetch" href="/luvue/assets/js/277.88e1d30f.js"><link rel="prefetch" href="/luvue/assets/js/278.5914996c.js"><link rel="prefetch" href="/luvue/assets/js/279.74b37999.js"><link rel="prefetch" href="/luvue/assets/js/28.07d99649.js"><link rel="prefetch" href="/luvue/assets/js/280.c9568110.js"><link rel="prefetch" href="/luvue/assets/js/281.9f65d139.js"><link rel="prefetch" href="/luvue/assets/js/282.1650bd06.js"><link rel="prefetch" href="/luvue/assets/js/283.33bbeb99.js"><link rel="prefetch" href="/luvue/assets/js/284.1abe4631.js"><link rel="prefetch" href="/luvue/assets/js/285.518df1bf.js"><link rel="prefetch" href="/luvue/assets/js/286.af519e66.js"><link rel="prefetch" href="/luvue/assets/js/287.b6460486.js"><link rel="prefetch" href="/luvue/assets/js/288.47db7cc9.js"><link rel="prefetch" href="/luvue/assets/js/289.33cc7dc0.js"><link rel="prefetch" href="/luvue/assets/js/29.7a42aa9c.js"><link rel="prefetch" href="/luvue/assets/js/290.4a4def2b.js"><link rel="prefetch" href="/luvue/assets/js/291.ff1d48f1.js"><link rel="prefetch" href="/luvue/assets/js/292.0e4d6a16.js"><link rel="prefetch" href="/luvue/assets/js/293.4475f8fa.js"><link rel="prefetch" href="/luvue/assets/js/294.19226719.js"><link rel="prefetch" href="/luvue/assets/js/295.09aea195.js"><link rel="prefetch" href="/luvue/assets/js/296.98217b5e.js"><link rel="prefetch" href="/luvue/assets/js/297.b8ff51d6.js"><link rel="prefetch" href="/luvue/assets/js/298.990d4d9f.js"><link rel="prefetch" href="/luvue/assets/js/299.5df2719c.js"><link rel="prefetch" href="/luvue/assets/js/30.f14df500.js"><link rel="prefetch" href="/luvue/assets/js/300.fffd2c27.js"><link rel="prefetch" href="/luvue/assets/js/301.3d6b453a.js"><link rel="prefetch" href="/luvue/assets/js/302.caa4deb9.js"><link rel="prefetch" href="/luvue/assets/js/303.7a1ad789.js"><link rel="prefetch" href="/luvue/assets/js/304.fd6421f9.js"><link rel="prefetch" href="/luvue/assets/js/305.9963fce8.js"><link rel="prefetch" href="/luvue/assets/js/306.20906cc0.js"><link rel="prefetch" href="/luvue/assets/js/307.9b2c7f2f.js"><link rel="prefetch" href="/luvue/assets/js/308.c6636c3c.js"><link rel="prefetch" href="/luvue/assets/js/309.ba0a0e71.js"><link rel="prefetch" href="/luvue/assets/js/31.8b2636da.js"><link rel="prefetch" href="/luvue/assets/js/310.22345224.js"><link rel="prefetch" href="/luvue/assets/js/311.7c423dba.js"><link rel="prefetch" href="/luvue/assets/js/312.1a9b57a9.js"><link rel="prefetch" href="/luvue/assets/js/313.358832dc.js"><link rel="prefetch" href="/luvue/assets/js/314.cc992c63.js"><link rel="prefetch" href="/luvue/assets/js/315.51fdd92e.js"><link rel="prefetch" href="/luvue/assets/js/32.a1812ddd.js"><link rel="prefetch" href="/luvue/assets/js/33.4f4d5e3f.js"><link rel="prefetch" href="/luvue/assets/js/34.d81874f6.js"><link rel="prefetch" href="/luvue/assets/js/35.808cadca.js"><link rel="prefetch" href="/luvue/assets/js/36.911edf94.js"><link rel="prefetch" href="/luvue/assets/js/37.4718c1c4.js"><link rel="prefetch" href="/luvue/assets/js/38.a71b26b8.js"><link rel="prefetch" href="/luvue/assets/js/39.1e2c90a1.js"><link rel="prefetch" href="/luvue/assets/js/4.81c04c44.js"><link rel="prefetch" href="/luvue/assets/js/40.c27fa3a1.js"><link rel="prefetch" href="/luvue/assets/js/41.7ef6ece6.js"><link rel="prefetch" href="/luvue/assets/js/42.65a4e5f1.js"><link rel="prefetch" href="/luvue/assets/js/43.fe8f1ca9.js"><link rel="prefetch" href="/luvue/assets/js/44.4cbd0be7.js"><link rel="prefetch" href="/luvue/assets/js/45.7ba58c4e.js"><link rel="prefetch" href="/luvue/assets/js/46.5b26ac52.js"><link rel="prefetch" href="/luvue/assets/js/47.4886ee59.js"><link rel="prefetch" href="/luvue/assets/js/48.6ca30618.js"><link rel="prefetch" href="/luvue/assets/js/49.bf5ae195.js"><link rel="prefetch" href="/luvue/assets/js/5.7c785cd7.js"><link rel="prefetch" href="/luvue/assets/js/50.d2063889.js"><link rel="prefetch" href="/luvue/assets/js/51.40853d68.js"><link rel="prefetch" href="/luvue/assets/js/52.4595cda0.js"><link rel="prefetch" href="/luvue/assets/js/53.f65e7aed.js"><link rel="prefetch" href="/luvue/assets/js/54.e92efc34.js"><link rel="prefetch" href="/luvue/assets/js/55.c19cb715.js"><link rel="prefetch" href="/luvue/assets/js/56.d9b2c912.js"><link rel="prefetch" href="/luvue/assets/js/57.97fdefbb.js"><link rel="prefetch" href="/luvue/assets/js/58.a8454dc8.js"><link rel="prefetch" href="/luvue/assets/js/59.2176e352.js"><link rel="prefetch" href="/luvue/assets/js/6.f13ef292.js"><link rel="prefetch" href="/luvue/assets/js/60.9903c2e8.js"><link rel="prefetch" href="/luvue/assets/js/61.1840a87b.js"><link rel="prefetch" href="/luvue/assets/js/62.f9de293d.js"><link rel="prefetch" href="/luvue/assets/js/63.f0b5bd0c.js"><link rel="prefetch" href="/luvue/assets/js/64.9bfd9747.js"><link rel="prefetch" href="/luvue/assets/js/65.5091d072.js"><link rel="prefetch" href="/luvue/assets/js/66.1110c30b.js"><link rel="prefetch" href="/luvue/assets/js/67.d0123a6f.js"><link rel="prefetch" href="/luvue/assets/js/68.cfb6235b.js"><link rel="prefetch" href="/luvue/assets/js/69.eaef6f8c.js"><link rel="prefetch" href="/luvue/assets/js/7.b9daa433.js"><link rel="prefetch" href="/luvue/assets/js/70.92d45540.js"><link rel="prefetch" href="/luvue/assets/js/71.cea0d0db.js"><link rel="prefetch" href="/luvue/assets/js/72.5f4fd7b1.js"><link rel="prefetch" href="/luvue/assets/js/73.2bd9f09b.js"><link rel="prefetch" href="/luvue/assets/js/74.4f59112e.js"><link rel="prefetch" href="/luvue/assets/js/75.89861829.js"><link rel="prefetch" href="/luvue/assets/js/76.b02997f7.js"><link rel="prefetch" href="/luvue/assets/js/77.4d732275.js"><link rel="prefetch" href="/luvue/assets/js/78.338bc517.js"><link rel="prefetch" href="/luvue/assets/js/79.f4cf76b6.js"><link rel="prefetch" href="/luvue/assets/js/8.ae058ff6.js"><link rel="prefetch" href="/luvue/assets/js/80.598885dc.js"><link rel="prefetch" href="/luvue/assets/js/81.9e624105.js"><link rel="prefetch" href="/luvue/assets/js/82.70b483bb.js"><link rel="prefetch" href="/luvue/assets/js/83.96e15db9.js"><link rel="prefetch" href="/luvue/assets/js/84.1d0a2fca.js"><link rel="prefetch" href="/luvue/assets/js/85.c9523e2f.js"><link rel="prefetch" href="/luvue/assets/js/86.11b4914d.js"><link rel="prefetch" href="/luvue/assets/js/87.9e995a9e.js"><link rel="prefetch" href="/luvue/assets/js/88.768abc2b.js"><link rel="prefetch" href="/luvue/assets/js/89.889b6d0c.js"><link rel="prefetch" href="/luvue/assets/js/9.c7db66f1.js"><link rel="prefetch" href="/luvue/assets/js/90.3d24896e.js"><link rel="prefetch" href="/luvue/assets/js/91.0d861dc9.js"><link rel="prefetch" href="/luvue/assets/js/92.225a6a9c.js"><link rel="prefetch" href="/luvue/assets/js/93.52403ad6.js"><link rel="prefetch" href="/luvue/assets/js/94.603cf2a0.js"><link rel="prefetch" href="/luvue/assets/js/95.c46d3f66.js"><link rel="prefetch" href="/luvue/assets/js/96.fb8ddca9.js"><link rel="prefetch" href="/luvue/assets/js/97.492b0923.js"><link rel="prefetch" href="/luvue/assets/js/98.0a287ebb.js"><link rel="prefetch" href="/luvue/assets/js/99.1786ba72.js">
    <link rel="stylesheet" href="/luvue/assets/css/0.styles.0c275c11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/luvue/" class="home-link router-link-active"><!----> <span class="site-name">Ailjc notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link router-link-active">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link">工程化</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link router-link-active">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link">工程化</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/01-理念篇/" class="sidebar-heading clickable"><span>01-理念篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/02-架构篇/" class="sidebar-heading clickable"><span>02-架构篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/03-实现篇/" class="sidebar-heading clickable"><span>03-实现篇</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/04-构建/" class="sidebar-heading clickable"><span>04-构建</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/05-react18/" class="sidebar-heading clickable"><span>05-react18</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/react/06-react-router/" class="sidebar-heading clickable router-link-active open"><span>06-react-router</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/luvue/react/06-react-router/01-react-router-v6.html" aria-current="page" class="active sidebar-link">01-react-router-v6</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#router-源码解析" class="sidebar-link">Router 源码解析</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#memoryrouter-源码解析" class="sidebar-link">MemoryRouter 源码解析</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#结论" class="sidebar-link">结论</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#route-源码解析" class="sidebar-link">Route 源码解析</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#routes-源码解析" class="sidebar-link">Routes 源码解析</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#结论-2" class="sidebar-link">结论</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#useroutes-源码解析" class="sidebar-link">useRoutes 源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#routecontext" class="sidebar-link">RouteContext</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#拆分-useroutes" class="sidebar-link">拆分 useRoutes</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#路由匹配阶段" class="sidebar-link">路由匹配阶段</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#路由扁平化" class="sidebar-link">路由扁平化</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#路由权值计算与排序" class="sidebar-link">路由权值计算与排序</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#路由匹配与合并" class="sidebar-link">路由匹配与合并</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#路由渲染阶段" class="sidebar-link">路由渲染阶段</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#结论-3" class="sidebar-link">结论</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#outlet-与-useoutlet-源码解析" class="sidebar-link">Outlet 与 useOutlet 源码解析</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#结论-4" class="sidebar-link">结论</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#navigate-与-usenavigate-源码解析" class="sidebar-link">Navigate 与 useNavigate 源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#路径解析" class="sidebar-link">路径解析</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#结论-5" class="sidebar-link">结论</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#方法" class="sidebar-link">方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#createroutesfromchildren" class="sidebar-link">createRoutesFromChildren</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#generatepath" class="sidebar-link">generatePath</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#matchroutes" class="sidebar-link">matchRoutes</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#matchpath" class="sidebar-link">matchPath</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#rendermatches" class="sidebar-link">renderMatches</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#resolvepath" class="sidebar-link">resolvePath</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#hooks" class="sidebar-link">hooks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#useinroutercontext" class="sidebar-link">useInRouterContext</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#uselocation" class="sidebar-link">useLocation</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#usenavigationtype" class="sidebar-link">useNavigationType</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#useresolvedpath" class="sidebar-link">useResolvedPath</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#usehref" class="sidebar-link">useHref</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#usematch" class="sidebar-link">useMatch</a></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#useparams" class="sidebar-link">useParams</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/react/06-react-router/01-react-router-v6.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/luvue/react/06-react-router/02-react-router-v6实现集中式路由.html" class="sidebar-link">02-react-router-v6实现集中式路由</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-router-v6-完全解读指南-react-router-篇"><a href="#react-router-v6-完全解读指南-react-router-篇" class="header-anchor">#</a> React-Router v6 完全解读指南 - react-router 篇</h1> <p></p><div class="table-of-contents"><ul><li><a href="#router-源码解析">Router 源码解析</a></li><li><a href="#memoryrouter-源码解析">MemoryRouter 源码解析</a></li><li><a href="#结论">结论</a></li><li><a href="#route-源码解析">Route 源码解析</a></li><li><a href="#routes-源码解析">Routes 源码解析</a></li><li><a href="#结论">结论</a></li><li><a href="#useroutes-源码解析">useRoutes 源码解析</a><ul><li><a href="#routecontext">RouteContext</a></li><li><a href="#拆分-useroutes">拆分 useRoutes</a></li><li><a href="#路由匹配阶段">路由匹配阶段</a></li><li><a href="#路由扁平化">路由扁平化</a></li><li><a href="#路由权值计算与排序">路由权值计算与排序</a></li><li><a href="#路由匹配与合并">路由匹配与合并</a></li><li><a href="#路由渲染阶段">路由渲染阶段</a></li></ul></li><li><a href="#结论">结论</a></li><li><a href="#outlet-与-useoutlet-源码解析">Outlet 与 useOutlet 源码解析</a></li><li><a href="#结论">结论</a></li><li><a href="#navigate-与-usenavigate-源码解析">Navigate 与 useNavigate 源码解析</a><ul><li><a href="#路径解析">路径解析</a></li><li><a href="#结论">结论</a></li></ul></li><li><a href="#方法">方法</a><ul><li><a href="#createroutesfromchildren">createRoutesFromChildren</a></li><li><a href="#generatepath">generatePath</a></li><li><a href="#matchroutes">matchRoutes</a></li><li><a href="#matchpath">matchPath</a></li><li><a href="#rendermatches">renderMatches</a></li><li><a href="#resolvepath">resolvePath</a></li></ul></li><li><a href="#hooks">hooks</a><ul><li><a href="#useinroutercontext">useInRouterContext</a></li><li><a href="#uselocation">useLocation</a></li><li><a href="#usenavigationtype">useNavigationType</a></li><li><a href="#useresolvedpath">useResolvedPath</a></li><li><a href="#usehref">useHref</a></li><li><a href="#usematch">useMatch</a></li><li><a href="#useparams">useParams</a></li></ul></li><li><a href="#总结">总结</a></li></ul></div><p></p> <h1 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h1> <p>在 React-Router v6 完全解读指南 - <code>history</code> 篇 一文中我们说到了 react-router 的依赖库 <code>history</code>，介绍了其内部操作浏览器路由的方式和实现原理。它是 <code>react-router</code> 内部路由导航的核心库，甚至可以说，react-router 仅仅是围绕该库做了一层基于 React 的封装，如果有不了解的同学可以先看一下上面的文章。</p> <p>接下来步入本文正题，基于源码层面讲一讲 react-router v6 中的设计理念与实践指南。</p> <blockquote><p>写此文章时 react-router 最新版为 v6.2.1，所以整片文章会以此时间节点进行分析，如果后续有一些大更新会考虑再加入这些特性的解</p></blockquote> <blockquote><p>本文内容只包括 react-router v6 版本的内容，不会与 v5 版本做比较，如果想要了解如何从 v5 迁移到 v6，可以查看官方的迁移指南</p></blockquote> <p>实际上 react-router 的仓库中一共有三个包：<code>react-router</code>、<code>react-router-dom</code>和<code>react-router-native</code>，其中 <code>react-router</code> 包是整个 react-router 的核心，几乎所有与运行平台无关的方法、组件和 hooks 都是在这里定义的。</p> <h1 id="从-router-开始讲起"><a href="#从-router-开始讲起" class="header-anchor">#</a> 从 Router 开始讲起</h1> <p><code>Router</code> 在 <code>react-router</code> 内部主要用于提供全局的路由导航对象（一般由 <code>history</code> 库提供）以及当前的路由导航状态，在项目中使用时一般是必须并且唯一的。<br>
不过我们一般不会直接使用该组件，更多会使用已经封装好路由导航对象的 <code>BrowserRouter</code>（react-router-dom 包引入）、<code>HashRouter</code>（react-router-dom 包引入）和 <code>MemoryRouter</code>（react-router 包引入）。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> rootElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
  rootElement
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="router-源码解析"><a href="#router-源码解析" class="header-anchor">#</a> Router 源码解析</h2> <p>首先我们需要定义两个 <code>Context</code>，用于存储全局的路由导航对象以及导航位置的上下文。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> History<span class="token punctuation">,</span> Location <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'history'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Action <span class="token keyword">as</span> NavigationType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'history'</span><span class="token punctuation">;</span>

<span class="token comment">// 只包含，go、push、replace、createHref 四个方法的 History 对象，用于在 react-router 中进行路由跳转</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Navigator</span> <span class="token operator">=</span> Pick<span class="token operator">&lt;</span>History<span class="token punctuation">,</span> <span class="token string">'go'</span> <span class="token operator">|</span> <span class="token string">'push'</span> <span class="token operator">|</span> <span class="token string">'replace'</span> <span class="token operator">|</span> <span class="token string">'createHref'</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">NavigationContextObject</span> <span class="token punctuation">{</span>
  basename<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  navigator<span class="token operator">:</span> Navigator<span class="token punctuation">;</span>
  <span class="token keyword">static</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 内部含有 navigator 对象的全局上下文，官方不推荐在外直接使用
 */</span>
<span class="token keyword">const</span> NavigationContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createContext</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationContextObject<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">LocationContextObject</span> <span class="token punctuation">{</span>
  location<span class="token operator">:</span> Location<span class="token punctuation">;</span>
  navigationType<span class="token operator">:</span> NavigationType<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 内部含有当前 location 与 action 的 type，一般用于在内部获取当前 location，官方不推荐在外直接使用
 */</span>
<span class="token keyword">const</span> LocationContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createContext</span><span class="token generic class-name"><span class="token operator">&lt;</span>LocationContextObject<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这是官方对于上面两个 context 的导出，可以看到都是被定义为不安全的，并且可能会有着重大更改，强烈不建议使用</span>
<span class="token comment">/** @internal */</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  NavigationContext <span class="token keyword">as</span> UNSAFE_NavigationContext<span class="token punctuation">,</span>
  LocationContext <span class="token keyword">as</span> UNSAFE_LocationContext<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>除此之外，react-router 还为我们提供了基于 <code>LocationContext</code> 的三个 hooks：<code>useInRouterContext</code>、<code>useNavigationType</code> 与 <code>useLocation</code>。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 断言方法
 */</span>
<span class="token keyword">function</span> <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token parameter">cond<span class="token operator">:</span> any<span class="token punctuation">,</span> message<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">asserts</span> cond <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cond<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 判断当前组件是否在一个 Router 中
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useInRouterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>LocationContext<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 获取当前的跳转的 action type
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useNavigationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> NavigationType <span class="token punctuation">{</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>LocationContext<span class="token punctuation">)</span><span class="token punctuation">.</span>navigationType<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 获取当前跳转的 location
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Location <span class="token punctuation">{</span>
  <span class="token comment">// useLocation 必须在 Router 提供的上下文中使用</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token function">useInRouterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// TODO: This error is probably because they somehow have 2 versions of the</span>
    <span class="token comment">// router loaded. We can help them understand how to avoid that.</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">useLocation() may be used only in the context of a &lt;Router&gt; component.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>LocationContext<span class="token punctuation">)</span><span class="token punctuation">.</span>location<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>然后再定义 <code>Router</code> 组件，并在 <code>Router</code> 组件中使用上面的两个 <code>Context</code>：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// 接上面，这里额外还从 history 中引入了 parsePath 方法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> parsePath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'history'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RouterProps</span> <span class="token punctuation">{</span>
  <span class="token comment">// 路由前缀</span>
  basename<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  children<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode<span class="token punctuation">;</span>
  <span class="token comment">// 必传，当前 location</span>
  <span class="token comment">/*
      interface Location {
            pathname: string;
            search: string;
            hash: string;
            state: any;
            key: string;
      }
  */</span>
  location<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>Location<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">// 当前路由跳转的类型，有 POP，PUSH 与 REPLACE 三种</span>
  navigationType<span class="token operator">?</span><span class="token operator">:</span> NavigationType<span class="token punctuation">;</span>
  <span class="token comment">// 必传，history 中的导航对象，我们可以在这里传入统一外部的 history</span>
  navigator<span class="token operator">:</span> Navigator<span class="token punctuation">;</span>
  <span class="token comment">// 是否为静态路由（ssr）</span>
  <span class="token keyword">static</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 提供渲染 Route 的上下文，但是一般不直接使用这个组件，会包装在 BrowserRouter 等二次封装的路由中
 * 整个应用程序应该只有一个 Router
 * Router 的作用就是格式化传入的原始 location 并渲染全局上下文 NavigationContext、LocationContext
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  basename<span class="token operator">:</span> basenameProp <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
  children <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  location<span class="token operator">:</span> locationProp<span class="token punctuation">,</span>
  navigationType <span class="token operator">=</span> NavigationType<span class="token punctuation">.</span>Pop<span class="token punctuation">,</span>
  navigator<span class="token punctuation">,</span>
  <span class="token keyword">static</span><span class="token operator">:</span> staticProp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token operator">:</span> RouterProps<span class="token punctuation">)</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// 断言，Router 不能在其余 Router 内部，否则抛出错误</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token operator">!</span><span class="token function">useInRouterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You cannot render a &lt;Router&gt; inside another &lt;Router&gt;.</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> You should never have more than one in your app.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 格式化 basename，去掉 url 中多余的 /，比如 /a//b 改为 /a/b</span>
  <span class="token keyword">let</span> basename <span class="token operator">=</span> <span class="token function">normalizePathname</span><span class="token punctuation">(</span>basenameProp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 全局的导航上下文信息，包括路由前缀，导航对象等</span>
  <span class="token keyword">let</span> navigationContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useMemo</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> basename<span class="token punctuation">,</span> navigator<span class="token punctuation">,</span> <span class="token keyword">static</span><span class="token operator">:</span> staticProp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>basename<span class="token punctuation">,</span> navigator<span class="token punctuation">,</span> staticProp<span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 转换 location，传入 string 将转换为对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> locationProp <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// parsePath 用于将 locationProp 转换为 Path 对象，都是 history 库引入的</span>
    <span class="token comment">/*
        interface Path {
              pathname: string;
              search: string;
              hash: string;
        }
    */</span>
    locationProp <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>locationProp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> <span class="token punctuation">{</span>
    pathname <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    search <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
    hash <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
    state <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token string">'default'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> locationProp<span class="token punctuation">;</span>

  <span class="token comment">// 经过抽离 base 后的真正的 location，如果抽离 base 失败返回 null</span>
  <span class="token keyword">let</span> location <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// stripBasename 用于去除 pathname 前面 basename 部分</span>
    <span class="token keyword">let</span> trailingPathname <span class="token operator">=</span> <span class="token function">stripBasename</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> basename<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>trailingPathname <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      pathname<span class="token operator">:</span> trailingPathname<span class="token punctuation">,</span>
      search<span class="token punctuation">,</span>
      hash<span class="token punctuation">,</span>
      state<span class="token punctuation">,</span>
      key<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>basename<span class="token punctuation">,</span> pathname<span class="token punctuation">,</span> search<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> state<span class="token punctuation">,</span> key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>location <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token comment">// 唯一传入 location 的地方</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">NavigationContext.Provider</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>navigationContext<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">LocationContext.Provider</span></span>
        <span class="token attr-name">children</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>children<span class="token punctuation">}</span></span>
        <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> location<span class="token punctuation">,</span> navigationType <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
      <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">NavigationContext.Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br></div></div><p>可以看到，<strong><code>Router</code> 组件内部并没有什么复杂的逻辑，仅仅只是提供 <code>Context</code> 与格式化外部传入的 <code>location</code> 对象（而实际上这个 <code>location</code> 对象一般也不用我们传入）</strong>。</p> <p>同时，在上面，除了使用了 <code>history</code> 提供的 <code>parsePath</code> 方法，还使用了 <code>normalizePathname</code> 与 <code>stripBasename</code> 两个 react-router 内部定义的方法。
下面它们的源码：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 格式化 pathname
 * @param pathname
 * @returns
 */</span>
<span class="token keyword">const</span> normalizePathname <span class="token operator">=</span> <span class="token punctuation">(</span>pathname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">string</span> <span class="token operator">=&gt;</span>
  pathname<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 *
 * 抽离 basename，获取纯粹的 path，如果没有匹配到则返回 null
 * @param pathname
 * @param basename
 * @returns
 */</span>
<span class="token keyword">function</span> <span class="token function">stripBasename</span><span class="token punctuation">(</span><span class="token parameter">pathname<span class="token operator">:</span> string<span class="token punctuation">,</span> basename<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>basename <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> pathname<span class="token punctuation">;</span>

  <span class="token comment">// 如果 basename 与 pathname 不匹配，返回 null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pathname<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>basename<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 上面只验证了是否 pathname 包含 basename，这里还需要验证包含 basename 后第一个字母是否为 /，不为 / 证明并不是该 basename 下的路径，返回 null</span>
  <span class="token keyword">let</span> nextChar <span class="token operator">=</span> pathname<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>basename<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChar <span class="token operator">&amp;&amp;</span> nextChar <span class="token operator">!==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 返回去除掉 basename 的 path</span>
  <span class="token keyword">return</span> pathname<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>basename<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h2 id="memoryrouter-源码解析"><a href="#memoryrouter-源码解析" class="header-anchor">#</a> MemoryRouter 源码解析</h2> <p>刚刚说完了 <code>Router</code> 组件是怎么封装的，还没说到它是怎么在其余高阶路由组件中使用的，趁热打铁，下面再来看看 <code>MemoryRouter</code> 的源码（只有 <code>MemoryRouter</code> 是被定义在 react-router 包中的，所以这里就先讲 <code>MemoryRouter</code> 了，<code>BrowserRouter</code> 与 <code>HashRouter</code> 跟它原理类似）。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> InitialEntry<span class="token punctuation">,</span> MemoryHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'history'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createMemoryHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'history'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">MemoryRouterProps</span> <span class="token punctuation">{</span>
  <span class="token comment">// 路由前缀</span>
  basename<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  children<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode<span class="token punctuation">;</span>
  <span class="token comment">// 与 createMemoryHistory 返回的 history 对象参数相对应，代表的是自定义的页面栈与索引</span>
  initialEntries<span class="token operator">?</span><span class="token operator">:</span> InitialEntry<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  initialIndex<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * react-router 里面只有 MemoryRouter，其余的 router 在 react-router-dom 里
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">MemoryRouter</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  basename<span class="token punctuation">,</span>
  children<span class="token punctuation">,</span>
  initialEntries<span class="token punctuation">,</span>
  initialIndex<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token operator">:</span> MemoryRouterProps</span><span class="token punctuation">)</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactElement <span class="token punctuation">{</span>
  <span class="token comment">// history 对象的引用</span>
  <span class="token keyword">let</span> historyRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">useRef</span><span class="token generic class-name"><span class="token operator">&lt;</span>MemoryHistory<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>historyRef<span class="token punctuation">.</span>current <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建 memoryHistory</span>
    historyRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token function">createMemoryHistory</span><span class="token punctuation">(</span><span class="token punctuation">{</span> initialEntries<span class="token punctuation">,</span> initialIndex <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> history <span class="token operator">=</span> historyRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    action<span class="token operator">:</span> history<span class="token punctuation">.</span>action<span class="token punctuation">,</span>
    location<span class="token operator">:</span> history<span class="token punctuation">.</span>location<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 监听 history 改变，改变后重新 setState</span>
  React<span class="token punctuation">.</span><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>setState<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>history<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 简单的初始化并将相应状态与 React 绑定</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Router</span></span>
      <span class="token attr-name">basename</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>basename<span class="token punctuation">}</span></span>
      <span class="token attr-name">children</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>children<span class="token punctuation">}</span></span>
      <span class="token attr-name">location</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>location<span class="token punctuation">}</span></span>
      <span class="token attr-name">navigationType</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>action<span class="token punctuation">}</span></span>
      <span class="token attr-name">navigator</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span></span>
    <span class="token punctuation">/&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>可以看到，所谓的高阶路由其实就是将 <code>history</code> 库与我们声明的 <code>Router</code> 组件绑定起来，当<code>history.listen</code> 监听到路由改变后重新设置当前的 <code>location</code> 与 <code>action</code>。</p> <h2 id="结论"><a href="#结论" class="header-anchor">#</a> 结论</h2> <ul><li><code>Router</code> 组件是 <code>react-router</code> 应用中必不可少的，一般直接写在应用最外层，它提供了一系列关于路由跳转和状态的上下文属性和方法。</li> <li>一般不会直接使用 <code>Router</code> 组件，而是使用 <code>react-router</code> 内部提供的高阶 <code>Router</code> 组件，而这些高阶组件实际上就是将 <code>history</code> 库中提供的导航对象与 <code>Router</code> 组件连接起来，进而控制应用的导航状态。</li></ul> <h1 id="router-准备完毕-开始配置-route"><a href="#router-准备完毕-开始配置-route" class="header-anchor">#</a> Router 准备完毕，开始配置 Route</h1> <p>我们再来看看官方的例子：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter<span class="token punctuation">,</span> Routes<span class="token punctuation">,</span> Route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span><span class="token punctuation">;</span>
<span class="token comment">// 这几个页面不用管它</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Expenses <span class="token keyword">from</span> <span class="token string">'./routes/expenses'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Invoices <span class="token keyword">from</span> <span class="token string">'./routes/invoices'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> rootElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/expenses<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Expenses</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/invoices<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Invoices</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
  rootElement
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在例子中，我们引入了两个新的组件：<code>Routes</code> 与 <code>Route</code>。我们将每个路由 url 与页面相对应，写在了 <code>Route</code> 的 <code>props</code> 中，然后使用 <code>Routes</code> 将这些 <code>Route</code> 包裹起来作为 <code>children</code> 传入。这样，我们就得到定义好路由的应用了。</p> <p>下面我们来看看嵌套路由的例子：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span><span class="token comment">/* 子路由为父路由 chilren，注意子路由 path 开头要能与父路由匹配 */</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/expenses<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Expenses</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/invoices<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Invoices</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在 App 组件内部：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Outlet <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      App
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Outlet</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上面的例子中我们又引入一个新的组件 <code>Outlet</code>，该组件用于在父路由元素中呈现它们的子路由元素。</p> <p>也就是说，<strong>后续子路由匹配到的内容都会放到 <code>Outlet</code> 组件中，当父路由元素在内部渲染它时，就会展示匹配到的子路由元素</strong>。 也许你会觉得很神奇，它内部到底是如何工作的呢？先别急，我们现在先只讲如何在页面中渲染子路由，至于它的渲染原理后面再细说。</p> <h2 id="route-源码解析"><a href="#route-源码解析" class="header-anchor">#</a> Route 源码解析</h2> <p>我们先来看看 <code>Route</code> 组件的源码：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// Route 有三种 props 类型，这里先了解内部参数的含义，下面会细讲</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PathRouteProps</span> <span class="token punctuation">{</span>
  caseSensitive<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">// children 代表子路由</span>
  children<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode<span class="token punctuation">;</span>
  element<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  index<span class="token operator">?</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">LayoutRouteProps</span> <span class="token punctuation">{</span>
  children<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode<span class="token punctuation">;</span>
  element<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IndexRouteProps</span> <span class="token punctuation">{</span>
  element<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  index<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Route 组件内部没有进行任何操作，仅仅只是定义 props，而我们就是为了使用它的 props
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Route</span><span class="token punctuation">(</span>
  <span class="token parameter">_props<span class="token operator">:</span> PathRouteProps <span class="token operator">|</span> LayoutRouteProps <span class="token operator">|</span> IndexRouteProps</span>
<span class="token punctuation">)</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里可以看出 Route 不能够被渲染出来，渲染会直接抛出错误，证明 Router 拿到 Route 后也不会在内部操作</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">A &lt;Route&gt; is only ever to be used as the child of &lt;Routes&gt; element, </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">never rendered directly. Please wrap your &lt;Route&gt; in a &lt;Routes&gt;.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>该组件的定义可能会改变大多数人对于组件的认知，该组件竟然不是为了渲染界面而存在的，它在 <strong><code>react-router</code> 内仅仅只是个传递参数的工具人（后续讲 <code>Routes</code> 会细说）</strong>，对用户的唯一作用就是提供命令式的路由配置方式。</p> <p><code>Route</code> 组件提供了三种 <code>props</code> 类型，这也是 react-router 官方规定的三种路由类型：<code>路径路由</code>、<code>布局路由</code>和<code>索引路由</code>。</p> <ul><li>路径路由：最普遍的路由定义方式，可以定义要匹配的 path 以及是否允许大小写不同等配置。<div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Teams</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token attr-name">caseSensitive</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams/:teamId<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Team</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams/new<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">NewTeamForm</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li>布局路由：用于处理有共同布局时的路由定义方式，使用这种方式可以减少重复性的组件渲染，比如下面这样：<div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token punctuation">{</span><span class="token comment">/* 布局路由 */</span><span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">PageLayout</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/privacy<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Privacy</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/tos<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tos</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/contact-us<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Contact</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div>否则你很可能会写成这样：<div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token punctuation">{</span><span class="token comment">/* 包裹布局组件 */</span><span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span>
    <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/privacy<span class="token punctuation">'</span></span>
    <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">PageLayout</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Privacy</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">PageLayout</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">}</span></span>
  <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token punctuation">{</span><span class="token comment">/* 重复包裹布局组件 */</span><span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span>
    <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/tos<span class="token punctuation">'</span></span>
    <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">PageLayout</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tos</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">PageLayout</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">}</span></span>
  <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/contact-us<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Contact</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div>也许你看到了，布局组件是没有 <code>path</code> 属性的（或者你可以看做 <code>path</code> 为空字符串），它是否能匹配上当前的 <code>pathname</code> 实际取决于其内部的子路由，在路由匹配时 react-router 会跳过此路由，直接匹配其子路由，当子路由匹配上时会从匹配到的子路由开始由内到外查找对应父路由提供的 <code>element</code> 再进行渲染。
更详细的理解可以看<a href="https://reactrouter.com/docs/en/v6/getting-started/concepts#layout-routes" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li>索引路由：最特殊的路由定义方式，当设置 <code>index</code> 为 <code>true</code> 时会启用该路由，该路由内部不能有子路由，并且它能匹配到的 <code>path</code> 永远与父路由非<code>*</code>路径（这是 react-router v6 中的路径匹配规则，_代表所有的路径，比如<code>/foo/_</code>在这里索引路由可以匹配/foo 或者/foo/）一致。换种方法来说，它相当于目录里面的 index.js 文件，当我们引入目录时，默认会引用到它。<div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Teams</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams/:teamId<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Team</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams/new<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">NewTeamForm</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">index</span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">LeagueStandings</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div>当 <code>pathname</code> 为<code>/teams</code> 是会渲染<code>&lt;LeagueStandings /&gt;</code>组件。</li></ul> <p>下面是一个比较完整的路由配置：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span><span class="token comment">/* pathname 为 / 默认为 &lt;Home /&gt; */</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">index</span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Home</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Teams</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams/:teamId<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Team</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams/:teamId/edit<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">EditTeam</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams/new<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">NewTeamForm</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* pathname 为 /teams 默认为 &lt;LeagueStandings /&gt; */</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">index</span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">LeagueStandings</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token punctuation">{</span><span class="token comment">/* pathname 为 /privacy 或 /tos 才能匹配到 &lt;PageLayout /&gt; */</span><span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">PageLayout</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/privacy<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Privacy</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/tos<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tos</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/contact-us<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Contact</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="routes-源码解析"><a href="#routes-源码解析" class="header-anchor">#</a> Routes 源码解析</h2> <p>看了 <code>Route</code> 组件的源码，你会想 <code>Routes</code> 肯定也没有这么简单。没错，它其实也是个工具人，用于在内部解析传入 <code>Route</code> 的 <code>props</code>，下面再来看看源码：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RoutesProps</span> <span class="token punctuation">{</span>
  children<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode<span class="token punctuation">;</span>
  <span class="token comment">// 用户传入的 location 对象，一般不传，默认用当前浏览器的 location</span>
  location<span class="token operator">?</span><span class="token operator">:</span> Partial<span class="token operator">&lt;</span>Location<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 所有的 Route 都需要 Routes 包裹，用于渲染 Route（拿到 Route 的 props 的值，不渲染真实的 DOM 节点）
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Routes</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  children<span class="token punctuation">,</span>
  location<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token operator">:</span> RoutesProps</span><span class="token punctuation">)</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">useRoutes</span><span class="token punctuation">(</span><span class="token function">createRoutesFromChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>它调用了 <code>useRoutes</code> 这个 <code>hook</code>，并且使用了 <code>createRoutesFromChildren</code> 这个方法将 <code>children</code> 转换为了 <code>useRoutes</code> 的配置参数，从而得到最后的路由元素。</p> <p>至于 <code>useRoutes</code> 是什么，在这里先不细说，下面马上就会讲到，现在只是简单介绍一下：它是一种声明式的路由生成方式（使用 <code>Routes</code> 与 <code>Route</code> 是命令式的方式），通过传入一个配置对象数组来自动生成对应的渲染路由元素，同时此 API 也向用户开放。</p> <p>下面详细解释下 <code>createRoutesFromChildren</code>：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// 路由配置对象</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RouteObject</span> <span class="token punctuation">{</span>
  <span class="token comment">// 路由 path 是否匹配大小写</span>
  caseSensitive<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">// 子路由</span>
  children<span class="token operator">?</span><span class="token operator">:</span> RouteObject<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 要渲染的组件</span>
  element<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode<span class="token punctuation">;</span>
  <span class="token comment">// 是否是索引路由</span>
  index<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  path<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 将 Route 组件转换为 route 对象，提供给 useRoutes 使用
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRoutesFromChildren</span><span class="token punctuation">(</span>
  <span class="token parameter">children<span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode</span>
<span class="token punctuation">)</span><span class="token operator">:</span> RouteObject<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> routes<span class="token operator">:</span> RouteObject<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// 内部逻辑很简单，就是递归遍历 children，获取 &lt;Route /&gt; props 上的所有信息，然后格式化后推入 routes 数组中</span>
  React<span class="token punctuation">.</span>Children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>React<span class="token punctuation">.</span><span class="token function">isValidElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Ignore non-elements. This allows people to more easily inline</span>
      <span class="token comment">// conditionals in their route config.</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 空节点，忽略掉继续往下遍历</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>type <span class="token operator">===</span> React<span class="token punctuation">.</span>Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Transparently support React.Fragment and its children.</span>
      routes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
        routes<span class="token punctuation">,</span>
        <span class="token function">createRoutesFromChildren</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 不要传入其它组件，只能传 Route</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span>
      element<span class="token punctuation">.</span>type <span class="token operator">===</span> Route<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> element<span class="token punctuation">.</span>type <span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">.</span>name
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] is not a &lt;Route&gt; component. All component children of &lt;Routes&gt; must be a &lt;Route&gt; or &lt;React.Fragment&gt;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> route<span class="token operator">:</span> RouteObject <span class="token operator">=</span> <span class="token punctuation">{</span>
      caseSensitive<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>caseSensitive<span class="token punctuation">,</span>
      element<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>element<span class="token punctuation">,</span>
      index<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>index<span class="token punctuation">,</span>
      path<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 递归</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      route<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">createRoutesFromChildren</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    routes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> routes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><h2 id="结论-2"><a href="#结论-2" class="header-anchor">#</a> 结论</h2> <ul><li><code>react-router</code> 在路由定义时同时提供了两种方式：命令式与声明式，而这两者本质上都是调用的同一种路由生成的方法。</li> <li><code>Route</code> 可以被看做一个挂载用户传入参数的对象，它不会在页面中渲染，而是会被 <code>Routes</code> 接受并解析，我们也不能单独使用它。</li> <li><code>Routes</code> 与 Route 强绑定，有 Routes 则必定要传入且只能传入 Route。</li></ul> <h1 id="另一种路由配置方式-useroutes-核心概念"><a href="#另一种路由配置方式-useroutes-核心概念" class="header-anchor">#</a> 另一种路由配置方式 - useRoutes（核心概念）</h1> <blockquote><p><code>useRoutes</code> 是整个 <code>react-router v6</code> 的核心所在，内部包含了大量的解析与匹配逻辑。</p></blockquote> <p>在前面我们使用了命令式的方式配置路由，发现它们在内部也会被 <code>react-router</code> 转换为声明式的路由配置方式，也就是使用 <code>useRoutes</code> 来创建路由。实际上 react-router 对外暴露了 <code>useRoutes</code> 方法，用户一样可以直接使用类似 <code>vue-router</code> 的声明式写法定义路由。</p> <p>直接上示例：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span><span class="token punctuation">;</span>

<span class="token comment">// 此时 App 返回的就是已经渲染好的路由元素了</span>
<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token function">useRoutes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
      element<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Dashboard</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          path<span class="token operator">:</span> <span class="token string">'/messages'</span><span class="token punctuation">,</span>
          element<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">DashboardMessages</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/tasks'</span><span class="token punctuation">,</span> element<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">DashboardTasks</span></span> <span class="token punctuation">/&gt;</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/team'</span><span class="token punctuation">,</span> element<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AboutPage</span></span> <span class="token punctuation">/&gt;</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>可以看到，写法和之前还是大同小异的。</p> <h2 id="useroutes-源码解析"><a href="#useroutes-源码解析" class="header-anchor">#</a> useRoutes 源码解析</h2> <h3 id="routecontext"><a href="#routecontext" class="header-anchor">#</a> RouteContext</h3> <p>在这里，我们又需要引入一个新的 <code>Context</code> - <code>RouteContext</code>，它存储了两个属性：<code>outlet</code> 与 <code>matches</code>。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 动态参数的定义
 */</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Params<span class="token operator">&lt;</span>Key <span class="token keyword">extends</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token builtin">string</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> <span class="token punctuation">[</span>key <span class="token keyword">in</span> Key<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RouteMatch<span class="token operator">&lt;</span>ParamKey <span class="token keyword">extends</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token builtin">string</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// params 参数，比如 :id 等</span>
  params<span class="token operator">:</span> Params<span class="token operator">&lt;</span>ParamKey<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token comment">// 匹配到的 pathname</span>
  pathname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 子路由匹配之前的路径 url，这里可以把它看做是只要以 /* 结尾路径（这是父路由的路径）中 /* 之前的部分
   */</span>
  pathnameBase<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">// 定义的路由对象</span>
  route<span class="token operator">:</span> RouteObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">RouteContextObject</span> <span class="token punctuation">{</span>
  <span class="token comment">// 一个 ReactElement，内部包含有所有子路由组成的聚合组件，其实 Outlet 组件内部就是它</span>
  outlet<span class="token operator">:</span> React<span class="token punctuation">.</span>ReactElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 一个成功匹配到的路由数组，索引从小到大层级依次变深</span>
  matches<span class="token operator">:</span> RouteMatch<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 包含全部匹配到的路由，官方不推荐在外直接使用
 */</span>
<span class="token keyword">const</span> RouteContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createContext</span><span class="token generic class-name"><span class="token operator">&lt;</span>RouteContextObject<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  outlet<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  matches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** @internal */</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> RouteContext <span class="token keyword">as</span> UNSAFE_RouteContext <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><blockquote><p><code>RouteContext</code> 官方也是不建议我们在外部使用的，可能你会想它提供的 <code>matches</code> 数组是否能用来完成某些功能，比如面包屑导航。请不要这样做，你应该使用 react-router 提供的 <code>matchRoutes</code> 方法来手动匹配，而不是使用它。 因为该 matches 数组的值会根据你的路由匹配层级而动态改变，你可能无法获得你想要的效果。</p></blockquote> <p><code>RouteContext</code> 也是路由渲染的关键之一，从它的 <code>outlet</code> 属性和之前使用的 <code>Outlet</code> 组件你也许能想到：<strong>它的 <code>Context.Provider</code> 调用次数不止一次，而是和子路由的嵌套层数息息相关的</strong>。</p> <h3 id="拆分-useroutes"><a href="#拆分-useroutes" class="header-anchor">#</a> 拆分 useRoutes</h3> <p>说完了 <code>RouteContext</code>，下面进入正题。</p> <p><code>useRoutes</code> 内部逻辑十分复杂，我们先来看看最外层的代码，将其逻辑拆分出来：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 1.该 hooks 不是只调用一次，每次重新匹配到路由时就会重新调用渲染新的 element
 * 2.当多次调用 useRoutes 时需要解决内置的 route 上下文问题，继承外层的匹配结果
 * 3.内部通过计算所有的 routes 与当前的 location 关系，经过路径权重计算，得到 matches 数组，然后将 matches 数组重新渲染为嵌套结构的组件
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRoutes</span><span class="token punctuation">(</span>
  <span class="token parameter">routes<span class="token operator">:</span> RouteObject<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  locationArg<span class="token operator">?</span><span class="token operator">:</span> Partial<span class="token operator">&lt;</span>Location<span class="token operator">&gt;</span> <span class="token operator">|</span> string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// useRoutes 必须最外层有 Router 包裹，不然报错</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token function">useInRouterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// TODO: This error is probably because they somehow have 2 versions of the</span>
    <span class="token comment">// router loaded. We can help them understand how to avoid that.</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">useRoutes() may be used only in the context of a &lt;Router&gt; component.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 1.当此 useRoutes 为第一层级的路由定义时，matches 为空数组（默认值）</span>
  <span class="token comment">// 2.当该 hooks 在一个已经调用了 useRoutes 的渲染环境中渲染时，matches 含有值（也就是有 Routes 的上下文环境嵌套）</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> matches<span class="token operator">:</span> parentMatches <span class="token punctuation">}</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>RouteContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 最后 match 到的 route（深度最深），该 route 将作为父 route，我们后续的 routes 都是其子级</span>
  <span class="token keyword">let</span> routeMatch <span class="token operator">=</span> parentMatches<span class="token punctuation">[</span>parentMatches<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 下面是父级 route 的参数，我们会基于以下参数操作，如果项目中只在一个地方调用了 useRoutes，一般都会是默认值</span>
  <span class="token keyword">let</span> parentParams <span class="token operator">=</span> routeMatch <span class="token operator">?</span> routeMatch<span class="token punctuation">.</span>params <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 父路由的完整 pathname，比如路由设置为 /foo/*，当前导航是 /foo/1，那么 parentPathname 就是 /foo/1</span>
  <span class="token keyword">let</span> parentPathname <span class="token operator">=</span> routeMatch <span class="token operator">?</span> routeMatch<span class="token punctuation">.</span>pathname <span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
  <span class="token comment">// 同上面的 parentPathname，不过是 /* 前的部分，也就是 /foo</span>
  <span class="token keyword">let</span> parentPathnameBase <span class="token operator">=</span> routeMatch <span class="token operator">?</span> routeMatch<span class="token punctuation">.</span>pathnameBase <span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> parentRoute <span class="token operator">=</span> routeMatch <span class="token operator">&amp;&amp;</span> routeMatch<span class="token punctuation">.</span>route<span class="token punctuation">;</span>
  <span class="token comment">// 获取上下文环境中的 location</span>
  <span class="token keyword">let</span> locationFromContext <span class="token operator">=</span> <span class="token function">useLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 判断是否手动传入了 location，否则用默认上下文的 location</span>
  <span class="token keyword">let</span> location<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>locationArg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 格式化为 Path 对象</span>
    <span class="token keyword">let</span> parsedLocationArg <span class="token operator">=</span>
      <span class="token keyword">typeof</span> locationArg <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>locationArg<span class="token punctuation">)</span> <span class="token operator">:</span> locationArg<span class="token punctuation">;</span>
    <span class="token comment">// 如果传入了 location，判断是否与父级路由匹配（作为子路由存在）</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span>
      parentPathnameBase <span class="token operator">===</span> <span class="token string">'/'</span> <span class="token operator">||</span>
        parsedLocationArg<span class="token punctuation">.</span>pathname<span class="token operator">?.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>parentPathnameBase<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">When overriding the location using \`&lt;Routes location&gt;\` or \`useRoutes(routes, location)\`, </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">the location pathname must begin with the portion of the URL pathname that was </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">matched by all parent routes. The current pathname base is &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parentPathnameBase<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">but pathname &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parsedLocationArg<span class="token punctuation">.</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was given in the \`location\` prop.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    location <span class="token operator">=</span> parsedLocationArg<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    location <span class="token operator">=</span> locationFromContext<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> pathname <span class="token operator">=</span> location<span class="token punctuation">.</span>pathname <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
  <span class="token comment">// 剩余的 pathname，整体 pathname 减掉父级已经匹配的 pathname，才是本次 routes 要匹配的 pathname（适用于 parentMatches 匹配不为空的情况）</span>
  <span class="token keyword">let</span> remainingPathname <span class="token operator">=</span>
    parentPathnameBase <span class="token operator">===</span> <span class="token string">'/'</span>
      <span class="token operator">?</span> pathname
      <span class="token operator">:</span> pathname<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>parentPathnameBase<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
  <span class="token comment">// 匹配当前路径，注意是移除了 parentPathname 的相关路径后的匹配</span>

  <span class="token comment">// 通过传入的 routes 配置项与当前的路径，匹配对应渲染的路由</span>
  <span class="token keyword">let</span> matches <span class="token operator">=</span> <span class="token function">matchRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> <span class="token punctuation">{</span> pathname<span class="token operator">:</span> remainingPathname <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 参数为当前匹配到的 matches 路由数组和外层 useRoutes 的 matches 路由数组</span>
  <span class="token comment">// 返回的是 React.Element，渲染所有的 matches 对象</span>
  <span class="token keyword">return</span> <span class="token function">_renderMatches</span><span class="token punctuation">(</span>
    <span class="token comment">// 没有 matches 会返回 null</span>
    matches <span class="token operator">&amp;&amp;</span>
      matches<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token comment">// 合并外层调用 useRoutes 得到的参数，内部的 Route 会有外层 Route（其实这也叫父 Route） 的所有匹配属性。</span>
        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> match<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          params<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> parentParams<span class="token punctuation">,</span> match<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token comment">// joinPaths 函数用于合并字符串</span>
          pathname<span class="token operator">:</span> <span class="token function">joinPaths</span><span class="token punctuation">(</span><span class="token punctuation">[</span>parentPathnameBase<span class="token punctuation">,</span> match<span class="token punctuation">.</span>pathname<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          pathnameBase<span class="token operator">:</span>
            match<span class="token punctuation">.</span>pathnameBase <span class="token operator">===</span> <span class="token string">'/'</span>
              <span class="token operator">?</span> parentPathnameBase
              <span class="token operator">:</span> <span class="token function">joinPaths</span><span class="token punctuation">(</span><span class="token punctuation">[</span>parentPathnameBase<span class="token punctuation">,</span> match<span class="token punctuation">.</span>pathnameBase<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 外层 parentMatches 部分，最后会一起加入最终 matches 参数中</span>
    parentMatches
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 将多个 path 合并为一个
 * @param paths path 数组
 * @returns
 */</span>
<span class="token keyword">const</span> joinPaths <span class="token operator">=</span> <span class="token punctuation">(</span>paths<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">string</span> <span class="token operator">=&gt;</span>
  paths<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/\/+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><p>接上面关于在 <code>useRoutes</code> 中调用 <code>RouteContext</code> 的解释，<code>useRoutes</code> 在开头就用到了 <code>RouteContext</code>，而它内部有值的情况是这样的：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span><span class="token comment">/* 注意，这里父级后面必须加上 /* 用于匹配后续的任意子路由，否则按照 react-router 的路由匹配方式是无法匹配上内部嵌套的子路由的 */</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams/*<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Teams</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在 <code>Teams</code> 组件内部</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Routes<span class="token punctuation">,</span> Route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Team <span class="token keyword">from</span> <span class="token string">'./Team'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> NewTeamForm <span class="token keyword">from</span> <span class="token string">'./NewTeamForm'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Teams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 组件内部继续使用 useRoutes（之前说过了，使用 Routes 组件就是调用 useRoutes）</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* 这里会在内部处理父路由已经匹配到的路径前缀，所以不要写成 /teams/:teamId，直接写后面的部分 */</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/:teamId<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Team</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/new<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">NewTeamForm</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>这证明我们不一定要全部将路由定义在最外层，可以适当拆解出子路由，做一些比较特殊的功能，比如路由的条件渲染，鉴权等</strong>。</p> <p>这里整体概括一下 useRoutes 做的事情：</p> <ol><li>获取上下文中调用 <code>useRoutes</code> 后的信息，如果有信息证明此次调用时作为子路由使用的，需要合并父路由的匹配信息。</li> <li>移除父路由已经匹配完毕的 <code>pathname</code> 前缀后，调用 <code>matchRoutes</code> 与当前传入的 <code>routes</code> 配置相匹配，返回匹配到的 <code>matches</code> 数组。</li> <li>调用 <code>_renderMatches</code> 方法，渲染上一步得到的 matches 数组。</li></ol> <p>整个流程对应三个阶段：<strong>路由上下文解析阶段，路由匹配阶段，路由渲染阶段</strong>。</p> <p>路由上下文解析阶段不用多说，下面详细说说后面两个阶段。</p> <h3 id="路由匹配阶段"><a href="#路由匹配阶段" class="header-anchor">#</a> 路由匹配阶段</h3> <p>路由匹配阶段其实就是调用 <code>matchRoutes</code> 方法的过程，我们来看看这个方法：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 通过 routes 与 location 得到 matches 数组
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">matchRoutes</span><span class="token punctuation">(</span>
  <span class="token comment">// 用户传入的 routes 对象</span>
  routes<span class="token operator">:</span> RouteObject<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 当前匹配到的 location，注意这在 useRoutes 内部是先有过处理的</span>
  locationArg<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>Location<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token comment">// 这个参数在 useRoutes 内部是没有用到的，但是该方法是对外暴露的，用户可以使用这个参数来添加统一的路径前缀</span>
  basename <span class="token operator">=</span> <span class="token string">'/'</span>
<span class="token punctuation">)</span><span class="token operator">:</span> RouteMatch<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// 先格式化为 Path 对象</span>
  <span class="token keyword">let</span> location <span class="token operator">=</span>
    <span class="token keyword">typeof</span> locationArg <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>locationArg<span class="token punctuation">)</span> <span class="token operator">:</span> locationArg<span class="token punctuation">;</span>

  <span class="token comment">// 之前提到过，抽离 basename，获取纯粹的 pathname</span>
  <span class="token keyword">let</span> pathname <span class="token operator">=</span> <span class="token function">stripBasename</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">,</span> basename<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// basename 匹配失败，返回 null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 1.扁平化 routes，将树状的 routes 对象根据 path 扁平为一维数组，同时包含当前路由的权重值</span>
  <span class="token keyword">let</span> branches <span class="token operator">=</span> <span class="token function">flattenRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2.传入扁平化后的数组，根据内部匹配到的权重排序</span>
  <span class="token function">rankRouteBranches</span><span class="token punctuation">(</span>branches<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> matches <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 3.这里就是权重比较完成后的解析顺序，权重高的在前面，先进行匹配，然后是权重低的匹配</span>
  <span class="token comment">// branches 中有一个匹配到了就终止循环，或者全都没有匹配到</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> matches <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> branches<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历扁平化的 routes，查看每个 branch 的路径匹配规则是否能匹配到 pathname</span>
    matches <span class="token operator">=</span> <span class="token function">matchRouteBranch</span><span class="token punctuation">(</span>branches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> matches<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>仔细看完上面的代码，我们发现 <code>matchRoutes</code> 又在内部将路由的匹配分为了三个阶段：<strong>路由扁平化、路由权值计算与排序、路由匹配与合并</strong>。</p> <h3 id="路由扁平化"><a href="#路由扁平化" class="header-anchor">#</a> 路由扁平化</h3> <p>将路由扁平化处理是为了更好的进行权值排序，我们先看看处理前后的对比</p> <p>处理前：</p> <div align="center"><img src="/luvue/images/react/06-react-router/react-router-090601.jpg" alt="react/06-react-router/react-router-090601.jpg"></div> <p>处理后：</p> <div align="center"><img src="/luvue/images/react/06-react-router/react-router-090602.jpg" alt="react/06-react-router/react-router-090602.jpg"></div> <p>可以看到，嵌套树形的数据结构被我们拍平为了一维数组，更加适合比较排序。</p> <p>路由扁平化是在 <code>flattenRoutes</code> 方法中处理的：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// 保存在 branch 中的路由信息，后续路由匹配时会用到</span>
<span class="token keyword">interface</span> <span class="token class-name">RouteMeta</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 路由的相对路径（刨除与父路由重复部分）
   */</span>
  relativePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  caseSensitive<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 用户在 routes 数组中定义的索引位置（相对其兄弟 route 而言）
   */</span>
  childrenIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  route<span class="token operator">:</span> RouteObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 扁平化的路由对象，包含当前路由对象对应的完整 path，权重得分与用于匹配的路由信息</span>
<span class="token keyword">interface</span> <span class="token class-name">RouteBranch</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 完整的 path（合并了父路由的，下面会引入相对路由的概念）
   */</span>
  path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 权重，用于排序
   */</span>
  score<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 路径 meta，依次为从父级到子级的路径规则，最后一个是路由自己
   */</span>
  routesMeta<span class="token operator">:</span> RouteMeta<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 扁平化路由，会将所有路由扁平为一个数组，用于比较权重
 * @param routes 第一次在外部调用只需要传入该值，用于转换的 routes 数组
 * @param branches
 * @param parentsMeta
 * @param parentPath
 * @returns
 */</span>
<span class="token keyword">function</span> <span class="token function">flattenRoutes</span><span class="token punctuation">(</span>
  routes<span class="token operator">:</span> RouteObject<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 除了 routes，下面三个都是递归的时候使用的</span>
  branches<span class="token operator">:</span> RouteBranch<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  parentsMeta<span class="token operator">:</span> RouteMeta<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  parentPath <span class="token operator">=</span> <span class="token string">''</span>
<span class="token punctuation">)</span><span class="token operator">:</span> RouteBranch<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">route<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前 branch 管理的 route meta</span>
    <span class="token keyword">let</span> meta<span class="token operator">:</span> RouteMeta <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">// 只保存相对路径，这里的值下面会进行处理</span>
      relativePath<span class="token operator">:</span> route<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
      caseSensitive<span class="token operator">:</span> route<span class="token punctuation">.</span>caseSensitive <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token comment">// index 是用户给出的 routes 顺序，会一定程度影响 branch 的排序（当为同一层级 route 时）</span>
      childrenIndex<span class="token operator">:</span> index<span class="token punctuation">,</span>
      <span class="token comment">// 当前 route 对象</span>
      route<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果 route 以 / 开头，那么它应该完全包含父 route 的 path，否则报错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>meta<span class="token punctuation">.</span>relativePath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">invariant</span><span class="token punctuation">(</span>
        meta<span class="token punctuation">.</span>relativePath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>parentPath<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Absolute route path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>meta<span class="token punctuation">.</span>relativePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; nested under path </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parentPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is not valid. An absolute child route path </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">must start with the combined path of all its parent routes.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 把父路由前缀去除，只要相对路径</span>
      meta<span class="token punctuation">.</span>relativePath <span class="token operator">=</span> meta<span class="token punctuation">.</span>relativePath<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>parentPath<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 完整的 path，合并了父路由的 path</span>
    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">joinPaths</span><span class="token punctuation">(</span><span class="token punctuation">[</span>parentPath<span class="token punctuation">,</span> meta<span class="token punctuation">.</span>relativePath<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 第一次使用 parentsMeta 为空数组，从外到内依次推入 meta 到该数组中</span>
    <span class="token keyword">let</span> routesMeta <span class="token operator">=</span> parentsMeta<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>meta<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 开始递归</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> route<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是 index route，报错，因为 index route 不能有 children</span>
      <span class="token function">invariant</span><span class="token punctuation">(</span>
        route<span class="token punctuation">.</span>index <span class="token operator">!==</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Index routes must not have child routes. Please remove </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">all child routes from route path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">flattenRoutes</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>children<span class="token punctuation">,</span> branches<span class="token punctuation">,</span> routesMeta<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 没有路径的路由（之前提到过的布局路由）不参与路由匹配，除非它是索引路由</span>
    <span class="token comment">/* 
      注意：递归是在前面进行的，也就是说布局路由的子路由是会参与匹配的
      而子路由会有布局路由的路由信息，这也是布局路由能正常渲染的原因。
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>route<span class="token punctuation">.</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// routesMeta，包含父 route 到自己的全部 meta 信息</span>
    <span class="token comment">// computeScore 是计算权值的方法，我们后面再说</span>
    branches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">,</span> score<span class="token operator">:</span> <span class="token function">computeScore</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> route<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> routesMeta <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> branches<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><p><strong>我们除了关心是如何将路由扁平化之外，这里还要额外讲到一点 - 相对路由</strong>。</p> <p>在前面的例子中我一直使用的绝对路径赋值给 <code>Route</code> 的 <code>path</code> 属性，但从上面的代码中我们可以看到，path 属性是可以接收相对路径的，只要不以/开头都会被看做是相对路径，最终的匹配结果都会和父路由的 path 相结合（详细的匹配代码在后面的路由匹配与合并阶段）。</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Teams</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span><span class="token comment">/* 不加 / 是相对路径，继承父路由的路径，效果与 /teams/:teamId 等同 */</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>:teamId<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Team</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>new<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">NewTeamForm</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="路由权值计算与排序"><a href="#路由权值计算与排序" class="header-anchor">#</a> 路由权值计算与排序</h3> <p>讲到权值计算，我们要先说说权值的基本单位，react-router 中定义了五种不同的权值单位：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// 动态路由权重，比如 /foo/:id</span>
<span class="token keyword">const</span> dynamicSegmentValue <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">// 索引路由权重，也就是加了 index 为 true 属性的路由</span>
<span class="token keyword">const</span> indexRouteValue <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">// 空路由权重，当一段路径值为空时匹配，只有最后的路径以 / 结尾才会用到它</span>
<span class="token keyword">const</span> emptySegmentValue <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// 静态路由权重</span>
<span class="token keyword">const</span> staticSegmentValue <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">// 路由通配符权重，为负的，代表当我们写 * 时实际会降低权重</span>
<span class="token keyword">const</span> splatPenalty <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>当我们进行路径匹配时，会按照<code>/</code>分割每一段 <code>path</code>，然后依次匹配上面的五种权值单位，最后将所有匹配结果合并，就是最终的 path 总权值。</p> <p>我们再来看看之前提到的 <code>computeScore</code> 函数：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// 判断是否有动态参数，比如 :id 等</span>
<span class="token keyword">const</span> paramRe <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^:\w+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token comment">// 判断是否为 *</span>
<span class="token keyword">const</span> <span class="token function-variable function">isSplat</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">s<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> s <span class="token operator">===</span> <span class="token string">'*'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 计算路由权值，根据权值大小匹配路由
 * 静态值 &gt; params 动态参数
 * @param path 完整的路由路径，不是相对路径
 * @param index
 * @returns
 */</span>
<span class="token keyword">function</span> <span class="token function">computeScore</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token operator">:</span> string<span class="token punctuation">,</span> index<span class="token operator">:</span> boolean <span class="token operator">|</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> segments <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化权重值，有几段路径就是几，路径多的初始权值高</span>
  <span class="token keyword">let</span> initialScore <span class="token operator">=</span> segments<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token comment">// 有一个 * 权重减 2</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>segments<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>isSplat<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    initialScore <span class="token operator">+=</span> splatPenalty<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 用户传了 index，index 是布尔值，代表 IndexRouter，权重 +2</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    initialScore <span class="token operator">+=</span> indexRouteValue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 在过滤出非 * 的部分</span>
  <span class="token keyword">return</span> segments
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span><span class="token function">isSplat</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token parameter">score<span class="token punctuation">,</span> segment</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        score <span class="token operator">+</span>
        <span class="token comment">// 如果有动态参数</span>
        <span class="token punctuation">(</span>paramRe<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token comment">// 动态参数权重 3</span>
            dynamicSegmentValue
          <span class="token operator">:</span> segment <span class="token operator">===</span> <span class="token string">''</span>
          <span class="token operator">?</span> <span class="token comment">// 空值权重为 1，这个其实只有一种情况，path 最后面多一个 /，比如 /foo 与 /foo/ 的区别</span>
            emptySegmentValue
          <span class="token operator">:</span> <span class="token comment">// 静态值权重最高为 10</span>
            staticSegmentValue<span class="token punctuation">)</span><span class="token punctuation">,</span>
      initialScore
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>可以看到，<code>computeScore</code> 内部就是按照我们上面说的规则计算出一段 path 的总权值。</p> <p>你之前是否想过，<strong>同时设置了 index 为 true 的索引路由与一个 path 与父路由完全相同的子路由谁会被匹配</strong>。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Teams</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span><span class="token comment">/* 这里 path='' 和下面是等同的，但是不能不写 path，否则会被认为是布局路由，不会参与匹配, '' == null =&gt; false */</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/teams<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Team</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">index</span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">LeagueStandings</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>而从这里你就能知道，索引路由会被匹配，因为它们传入 <code>computeScore</code> 的 <code>path</code> 是一致的（之前有过处理，最后传入的都是父路由的 path），但是索引路由会多一个 indexRouteValue，权值会+2。</p> <p>再次回顾之前的代码：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// 1.扁平化 routes，将树状的 routes 对象根据 path 扁平为一维数组，同时包含当前路由的权重值</span>
<span class="token keyword">let</span> branches <span class="token operator">=</span> <span class="token function">flattenRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2.传入扁平化后的数组，根据内部匹配到的权重排序</span>
<span class="token function">rankRouteBranches</span><span class="token punctuation">(</span>branches<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们已经讲完了 <code>flattenRoutes</code> 与内部的权值计算，生成了一个扁平化的路由数组，下一步则是调用 <code>rankRouteBranches</code> 方法进行路由排序：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 排序，比较权重值
 * @param branches
 */</span>
<span class="token keyword">function</span> <span class="token function">rankRouteBranches</span><span class="token punctuation">(</span><span class="token parameter">branches<span class="token operator">:</span> RouteBranch<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  branches<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    a<span class="token punctuation">.</span>score <span class="token operator">!==</span> b<span class="token punctuation">.</span>score
      <span class="token operator">?</span> <span class="token comment">// 排序，权值大的在前面</span>
        b<span class="token punctuation">.</span>score <span class="token operator">-</span> a<span class="token punctuation">.</span>score
      <span class="token operator">:</span> <span class="token comment">// 如果 a.score === b.score</span>
        <span class="token function">compareIndexes</span><span class="token punctuation">(</span>
          <span class="token comment">// routesMeta 是一个从最外层路由到子路由的数组</span>
          <span class="token comment">// childrenIndex 是按照 routes 中 route 传入的顺序传值的，写在后面的 index 更大（注意是同级）</span>
          a<span class="token punctuation">.</span>routesMeta<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">meta</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> meta<span class="token punctuation">.</span>childrenIndex<span class="token punctuation">)</span><span class="token punctuation">,</span>
          b<span class="token punctuation">.</span>routesMeta<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">meta</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> meta<span class="token punctuation">.</span>childrenIndex<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 比较子 route 的 index，判断是否为兄弟 route，如果不是则返回 0，比较没有意义，不做任何操作
 * @param a
 * @param b
 * @returns
 */</span>
<span class="token keyword">function</span> <span class="token function">compareIndexes</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token operator">:</span> number<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token operator">:</span> number<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token comment">// 是否为兄弟 route</span>
  <span class="token keyword">let</span> siblings <span class="token operator">=</span>
    <span class="token comment">// 这里是比较除了最后一个 route 的 path，需要全部一致才是兄弟 route</span>
    a<span class="token punctuation">.</span>length <span class="token operator">===</span> b<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> n <span class="token operator">===</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> siblings
    <span class="token operator">?</span> <span class="token comment">// 如果是兄弟节点，按照传入的顺序排序 a.length - 1 和 b.length - 1 是相等的，只是内部的值不同</span>
      a<span class="token punctuation">[</span>a<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span>b<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token operator">:</span> <span class="token comment">// 只比较兄弟节点，如果不是兄弟节点，则权重相同</span>
      <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>最后，我们得到的就是已经排好序的扁平化数组</p> <h3 id="路由匹配与合并"><a href="#路由匹配与合并" class="header-anchor">#</a> 路由匹配与合并</h3> <p>排序完毕后，下一步就是路由匹配了，根据排序好的顺序，我们按照索引从低到高依次匹配路径，也就是之前 <code>matchRoutes</code> 中的这部分代码：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">let</span> matches <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// 3.这里就是权重比较完成后的解析顺序，权重高的在前面，先进行匹配，然后是权重低的匹配</span>
<span class="token comment">// branches 中有一个匹配到了就终止循环，或者全都没有匹配到</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> matches <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> branches<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 遍历扁平化的 routes，查看每个 branch 的路径匹配规则是否能匹配到 pathname</span>
  matches <span class="token operator">=</span> <span class="token function">matchRouteBranch</span><span class="token punctuation">(</span>branches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在这里，我们调用了 <code>matchRouteBranch</code> 方法：</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">/**
 * 通过 branch 和当前的 pathname 得到真正的 matches 数组
 * @param branch
 * @param routesArg
 * @param pathname
 * @returns
 */</span>
<span class="token keyword">function</span> matchRouteBranch<span class="token operator">&lt;</span>ParamKey <span class="token keyword">extends</span> <span class="token class-name">string</span> <span class="token operator">=</span> string<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  branch<span class="token operator">:</span> RouteBranch<span class="token punctuation">,</span>
  pathname<span class="token operator">:</span> string
<span class="token punctuation">)</span><span class="token operator">:</span> RouteMatch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ParamKey</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">[] | null </span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> routesMeta <span class="token punctuation">}</span> <span class="token operator">=</span> branch<span class="token punctuation">;</span>

  <span class="token comment">// 初始化匹配到的值</span>
  <span class="token keyword">let</span> matchedParams <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> matchedPathname <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// 最终的 matches 数组</span>
  <span class="token keyword">let</span> matches<span class="token operator">:</span> RouteMatch<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 遍历 routesMeta 数组，最后一项是自己的 route，前面是 parentRoute</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> routesMeta<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> meta <span class="token operator">=</span> routesMeta<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否为最后一个 route</span>
    <span class="token keyword">let</span> end <span class="token operator">=</span> i <span class="token operator">===</span> routesMeta<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// pathname 匹配过父 route 后的剩余的路径名</span>
    <span class="token keyword">let</span> remainingPathname <span class="token operator">=</span>
      matchedPathname <span class="token operator">===</span> <span class="token string">&quot;/&quot;</span>
        <span class="token operator">?</span> pathname
        <span class="token operator">:</span> pathname<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>matchedPathname<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用的相对路径规则匹配剩余的值</span>
    <span class="token comment">// matchPath 方法用于单个路径的匹配，下面细讲</span>
    <span class="token keyword">let</span> match <span class="token operator">=</span> <span class="token function">matchPath</span><span class="token punctuation">(</span>
      <span class="token comment">// 在匹配时只有最后一个 route 的 end 才会是 true，其余都是 false，这里的 end 意味路径最末尾的 /</span>
      <span class="token punctuation">{</span> path<span class="token operator">:</span> meta<span class="token punctuation">.</span>relativePath<span class="token punctuation">,</span> caseSensitive<span class="token operator">:</span> meta<span class="token punctuation">.</span>caseSensitive<span class="token punctuation">,</span> end <span class="token punctuation">}</span><span class="token punctuation">,</span>
      remainingPathname
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 没匹配上，直接返回 null，整个 route 都匹配失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 匹配上了合并 params，注意这里是改变的 matchedParams，所以所有 route 的 params 都是同一个</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>matchedParams<span class="token punctuation">,</span> match<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> route <span class="token operator">=</span> meta<span class="token punctuation">.</span>route<span class="token punctuation">;</span>

    <span class="token comment">// 匹配上了就把路径再补全</span>
    matches<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      params<span class="token operator">:</span> matchedParams<span class="token punctuation">,</span>
      pathname<span class="token operator">:</span> <span class="token function">joinPaths</span><span class="token punctuation">(</span><span class="token punctuation">[</span>matchedPathname<span class="token punctuation">,</span> match<span class="token punctuation">.</span>pathname<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      pathnameBase<span class="token operator">:</span> <span class="token function">joinPaths</span><span class="token punctuation">(</span><span class="token punctuation">[</span>matchedPathname<span class="token punctuation">,</span> match<span class="token punctuation">.</span>pathnameBase<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      route
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更改 matchedPathname，已经匹配上的 pathname 前缀，用作后续子 route 的循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">.</span>pathnameBase <span class="token operator">!==</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      matchedPathname <span class="token operator">=</span> <span class="token function">joinPaths</span><span class="token punctuation">(</span><span class="token punctuation">[</span>matchedPathname<span class="token punctuation">,</span> match<span class="token punctuation">.</span>pathnameBase<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> matches<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>从传入的 <code>branch</code> 中我们拿到了 <code>routesMeta</code> 这个包含了所有路由层级的数组，又开始了一层层的路由匹配，然后把每一次匹配上的完整路径与参数都推入 <code>matches</code> 数组中，最后返回。</p> <p>下面是 <code>matchPath</code> 方法具体的匹配流程：</p> <blockquote><p>整个流程比较晦涩，几乎全是正则表达式，同时伴随着比较复杂的类型体操，笔者会尽量写清楚每一阶段的注释，如果暂时还是无法理解可以跳过，只需要知道 <code>matchPath</code> 方法的作用就行了。</p></blockquote> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 如果 ts 解析参数失败的状态，和下面一起看
 */</span>
<span class="token keyword">type</span> <span class="token class-name">ParamParseFailed</span> <span class="token operator">=</span> <span class="token punctuation">{</span> failed<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 这里就是类型体操了，主要是解析 params 中的具体参数，比如解析出 /:a 中的 a，拿到后单独提出来
 * ParamParseSegment&lt;'/:a/:b'&gt; =&gt; 'a' | 'b'
 */</span>
<span class="token keyword">type</span> <span class="token class-name">ParamParseSegment<span class="token operator">&lt;</span>Segment <span class="token keyword">extends</span> <span class="token builtin">string</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span>
  <span class="token comment">// 递归查左右是否有 :id 这样的路径存在</span>
  <span class="token comment">// Check here if there exists a forward slash in the string.</span>
  Segment <span class="token keyword">extends</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">infer</span> LeftSegment<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">infer</span> RightSegment<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token operator">?</span> <span class="token comment">// 如果有 /，代表是一个 url，开始解析</span>
      <span class="token comment">// 递归解析左边</span>
      ParamParseSegment<span class="token operator">&lt;</span>LeftSegment<span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token keyword">infer</span></span> LeftResult
      <span class="token comment">// 递归解析右边</span>
      <span class="token operator">?</span> ParamParseSegment<span class="token operator">&lt;</span>RightSegment<span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token keyword">infer</span></span> RightResult
        <span class="token operator">?</span> LeftResult <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">string</span></span>
          <span class="token operator">?</span> <span class="token comment">// 左边解析成功，再解析右边，取二者的交集，比如 &quot;foo&quot; | &quot;bar&quot;</span>
            RightResult <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">string</span></span>
            <span class="token operator">?</span> LeftResult <span class="token operator">|</span> RightResult
            <span class="token operator">:</span> LeftResult
          <span class="token operator">:</span> <span class="token comment">// 如果左边解析失败，则看右边是否能成功，都失败返回 ParamParseFailed</span>
          RightResult <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">string</span></span>
          <span class="token operator">?</span> RightResult
          <span class="token operator">:</span> ParamParseFailed
        <span class="token operator">:</span> ParamParseFailed
      <span class="token operator">:</span> <span class="token comment">// 如果左边不能被解析，那么直接解析右边</span>
      ParamParseSegment<span class="token operator">&lt;</span>RightSegment<span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token keyword">infer</span></span> RightResult
      <span class="token operator">?</span> RightResult <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">string</span></span>
        <span class="token operator">?</span> RightResult
        <span class="token operator">:</span> ParamParseFailed
      <span class="token operator">:</span> ParamParseFailed
    <span class="token operator">:</span> <span class="token comment">// 如果没有 /，则判断是否本事符合 :id 这样的形式，如果符合返回动态参数名，否则返回 ParamParseFailed</span>
    Segment <span class="token keyword">extends</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">infer</span> Remaining<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token operator">?</span> Remaining
    <span class="token operator">:</span> ParamParseFailed<span class="token punctuation">;</span>

<span class="token comment">/**
 * 解析给定的字符串类型，失败就返回 string 类型，否则返回在字符串中动态引用部分的联合类型
 */</span>
<span class="token keyword">type</span> <span class="token class-name">ParamParseKey<span class="token operator">&lt;</span>Segment <span class="token keyword">extends</span> <span class="token builtin">string</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span>
  ParamParseSegment<span class="token operator">&lt;</span>Segment<span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">string</span></span>
    <span class="token operator">?</span> ParamParseSegment<span class="token operator">&lt;</span>Segment<span class="token operator">&gt;</span>
    <span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>


<span class="token comment">/**
 * 一个 match 路径的模式，匹配时会将下面三个属性结合起来生成一个正则表达式用于匹配路径
 */</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PathPattern<span class="token operator">&lt;</span>Path <span class="token keyword">extends</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token builtin">string</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 模式要构造的路径
   * 这里的 Path 可以不直接写 string 类型，可以是具体的路径，因为 ts 可以直接解析出对应参数
   */</span>
  path<span class="token operator">:</span> Path<span class="token punctuation">;</span>
  caseSensitive<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 为 true 时忽略尾部斜杠，否则会至少匹配到完整的单词边界
   */</span>
  end<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * PathPattern 匹配后的信息
 */</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PathMatch<span class="token operator">&lt;</span>ParamKey <span class="token keyword">extends</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token builtin">string</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 路径中的动态参数
   */</span>
  params<span class="token operator">:</span> Params<span class="token operator">&lt;</span>ParamKey<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 匹配到的路径部分
   */</span>
  pathname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 在子路由之前匹配的路径部分。
   */</span>
  pathnameBase<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 用来 match 路径的 pattern
   */</span>
  pattern<span class="token operator">:</span> PathPattern<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 消除 readonly</span>
<span class="token keyword">type</span> <span class="token class-name">Mutable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">-</span><span class="token keyword">readonly</span> <span class="token punctuation">[</span><span class="token constant">P</span> <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">P</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 判断 pathname 是否匹配传入的 pattern，如果不匹配返回 null，如果匹配就返回进过解析后的值
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">matchPath</span><span class="token generic class-name"><span class="token operator">&lt;</span>
  ParamKey <span class="token keyword">extends</span> ParamParseKey<span class="token operator">&lt;</span>Path<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  Path <span class="token keyword">extends</span> <span class="token builtin">string</span>
<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  pattern<span class="token operator">:</span> PathPattern<span class="token operator">&lt;</span>Path<span class="token operator">&gt;</span> <span class="token operator">|</span> Path<span class="token punctuation">,</span>
  pathname<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> PathMatch<span class="token operator">&lt;</span>ParamKey<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// 格式化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> pattern <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pattern <span class="token operator">=</span> <span class="token punctuation">{</span> path<span class="token operator">:</span> pattern<span class="token punctuation">,</span> caseSensitive<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将 pattern 的参数共同编译为一个正则表达式 matcher，用于路径匹配，该正则会将动态路径作为 group 依次捕获</span>
  <span class="token comment">// 同时还会返回一个 params 参数名组成的数组，paramNames 内为动态参数名，比如 *、id</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span>matcher<span class="token punctuation">,</span> paramNames<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">compilePath</span><span class="token punctuation">(</span>
    pattern<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
    pattern<span class="token punctuation">.</span>caseSensitive<span class="token punctuation">,</span>
    pattern<span class="token punctuation">.</span>end
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 开始匹配</span>
  <span class="token keyword">let</span> match <span class="token operator">=</span> pathname<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 匹配到的 pathname</span>
  <span class="token keyword">let</span> matchedPathname <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// $1 代表第 n 个括号内的内容，这里其实就是去除最后一层路径后面的所有 /</span>
  <span class="token keyword">let</span> pathnameBase <span class="token operator">=</span> matchedPathname<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(.)\/+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 捕获到的动态路由数组，从数组的第二个元素开始就是 () 中匹配到的内容，比如 /about/*，传入 /about/1，就会匹配到 1（*也被看做是动态路由）</span>
  <span class="token keyword">let</span> captureGroups <span class="token operator">=</span> match<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 匹配到所有的动态参数，包括 * 和 :id 等</span>
  <span class="token keyword">let</span> params<span class="token operator">:</span> Params <span class="token operator">=</span> paramNames<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">reduce</span><span class="token generic class-name"><span class="token operator">&lt;</span>Mutable<span class="token operator">&lt;</span>Params<span class="token operator">&gt;&gt;</span></span></span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> paramName<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里是使用原始字符串计算，因为后续在 params 中已经解码了，pathnameBase 获取会有问题</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>paramName <span class="token operator">===</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对应匹配到的值</span>
        <span class="token keyword">let</span> splatValue <span class="token operator">=</span> captureGroups<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 这个匹配在这里其实就是把例如 /home/* 这样的路径变为 /home。
         * 比如在 Route 中设置为 /home/*，实际路径匹配为 /home/2，这里 matchedPathname 就为 /home/2，而 pathnameBase 为 /home
         */</span>
        pathnameBase <span class="token operator">=</span> matchedPathname
          <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> matchedPathname<span class="token punctuation">.</span>length <span class="token operator">-</span> splatValue<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
          <span class="token comment">// 去除末尾的 /</span>
          <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(.)\/+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;$1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 解码</span>
      memo<span class="token punctuation">[</span>paramName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">safelyDecodeURIComponent</span><span class="token punctuation">(</span>
        captureGroups<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        paramName
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    params<span class="token punctuation">,</span>
    pathname<span class="token operator">:</span> matchedPathname<span class="token punctuation">,</span>
    pathnameBase<span class="token punctuation">,</span>
    pattern
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * 解码 url，做了层封装，失败返回传入的 value
 * @param value
 * @param paramName
 * @returns
 */</span>
<span class="token keyword">function</span> <span class="token function">safelyDecodeURIComponent</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> string<span class="token punctuation">,</span> paramName<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warning</span><span class="token punctuation">(</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The value for the URL param &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>paramName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; will not be decoded because</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> the string &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is a malformed URL segment. This is probably</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> due to a bad percent encoding (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">).</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 解析 path，会将 path =&gt; 对应的 RegExp，同时解析出 path 的所有 params
 * @param path
 * @param caseSensitive 是否兼容大小写不一致
 * @param end 是否匹配末尾的 /，否则应匹配到单词边界
 * @returns
 */</span>
<span class="token keyword">function</span> <span class="token function">compilePath</span><span class="token punctuation">(</span>
  <span class="token parameter">path<span class="token operator">:</span> string<span class="token punctuation">,</span>
  caseSensitive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  end <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span>RegExp<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token comment">// path 不能是 /home* 这样的，否则打印警告</span>
  <span class="token function">warning</span><span class="token punctuation">(</span>
    path <span class="token operator">===</span> <span class="token string">&quot;*&quot;</span> <span class="token operator">||</span> <span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Route path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; will be treated as if it were </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;/*&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; because the \`*\` character must </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">always follow a \`/\` in the pattern. To get rid of this warning, </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">please change the route path to &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;/*&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 动态路径名数组</span>
  <span class="token keyword">let</span> paramNames<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> regexpSource <span class="token operator">=</span>
    <span class="token string">&quot;^&quot;</span> <span class="token operator">+</span>
    path
      <span class="token comment">// 先忽略尾部的 / 和 /*</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/*\*?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">// 确保开头有一个 /</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">// 转义特殊与正则表达式有关的字符</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\.*+^$?{}|()[\]]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&quot;\\$&amp;&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">// 转义以:开头的路径块，也就是 params，比如 :id</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">:(\w+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token operator">:</span> string<span class="token punctuation">,</span> paramName<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        paramNames<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>paramName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;([^\\/]+)&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 在这里处理尾部的 /* 和 *</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 尾部有 * 才代表 params 中有 *</span>
    paramNames<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    regexpSource <span class="token operator">+=</span>
      path <span class="token operator">===</span> <span class="token string">&quot;*&quot;</span> <span class="token operator">||</span> path <span class="token operator">===</span> <span class="token string">&quot;/*&quot;</span>
        <span class="token operator">?</span> <span class="token comment">// 如果为 * 或 /* 则处理任意值</span>
          <span class="token string">&quot;(.*)$&quot;</span>
        <span class="token operator">:</span> <span class="token comment">// 这里 (?:x) 是非捕获匹配，捕获通过 match 将 () 中的值返回，也就不会放入 params 中</span>
          <span class="token comment">// 下面是匹配 /xxx 和 /*（/出现 0 次或多次），下面两者有相互重叠的地方，后续官方应该会改吧，感觉怪怪的</span>
          <span class="token string">&quot;(?:\\/(.+)|\\/*)$&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果最后没有以 * 结尾，则只是忽略末尾的 /，否则我们应该至少匹配到一个单次边界（兼容 end 为 true 的情况，还有更多其他的情况，比如 /home/ /home@，也就是匹配到的单词后的字符不能是 a-z、A-Z、0-9）</span>
    regexpSource <span class="token operator">+=</span> end
      <span class="token operator">?</span> <span class="token string">&quot;\\/*$&quot;</span>
      <span class="token operator">:</span>
        <span class="token comment">// 限制了父 routes 只能匹配到自己的单词，如果为 false，那么 /home 可以匹配 /home/home2，但是不能匹配 /home2，也就是说必须要只有 /home，或者有 /home/ 作为前缀</span>
        <span class="token comment">// 匹配到单词边界</span>
        <span class="token string">&quot;(?:\\b|\\/|$)&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// path =&gt; pattern</span>
  <span class="token keyword">let</span> matcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>regexpSource<span class="token punctuation">,</span> caseSensitive <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token string">&quot;i&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>matcher<span class="token punctuation">,</span> paramNames<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br></div></div><p>至此，我们就完成了路由匹配阶段的所有操作。</p> <h3 id="路由渲染阶段"><a href="#路由渲染阶段" class="header-anchor">#</a> 路由渲染阶段</h3> <p>路由渲染阶段相对于路由匹配阶段代码会少很多，但是可能比较难以理解，<code>useRoutes</code> 在内部是调用 <code>_renderMatches</code> 方法来实现的，这里先看源码：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 其实就是渲染 RouteContext.Provider 组件（包括多个嵌套的 Provider）
 */</span>
<span class="token keyword">function</span> <span class="token function">_renderMatches</span><span class="token punctuation">(</span>
  matches<span class="token operator">:</span> RouteMatch<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// 如果在已有 match 的 route 内部调用，会合并父 context 的 match</span>
  parentMatches<span class="token operator">:</span> RouteMatch<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>matches <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 生成 outlet 组件，注意这里是从后往前 reduce，所以索引在前的 match 是最外层，也就是父路由对应的 match 是最外层</span>
  <span class="token comment">/**
   *  可以看到 outlet 是通过不断递归生成的组件，最外层的 outlet 递归层数最多，包含有所有的内层组件，
   *  所以我们在外层使用的 &lt;Outlet /&gt; 是包含有所有子组件的聚合组件
   * */</span>
  <span class="token keyword">return</span> matches<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">outlet<span class="token punctuation">,</span> match<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">RouteContext.Provider</span></span>
        <span class="token comment">// 如果有 element 就渲染 element，如果没有填写 element，则默认是 &lt;Outlet /&gt;，继续渲染内嵌的 &lt;Route /&gt;</span>
        <span class="token attr-name">children</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>
          match<span class="token punctuation">.</span>route<span class="token punctuation">.</span>element <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> match<span class="token punctuation">.</span>route<span class="token punctuation">.</span>element <span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Outlet</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">}</span></span>
        <span class="token comment">// 代表当前 RouteContext 匹配到的值，matches 并不是全局状态一致的，会根据层级不同展示不同的值，最后一个层级是完全的 matches，这也是之前提到过的不要在外部使用 RouteContext 的原因</span>
        <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
          outlet<span class="token punctuation">,</span>
          matches<span class="token operator">:</span> parentMatches<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>matches<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
      <span class="token punctuation">/&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最内层的 outlet 为 null，也就是最后的子路由</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token keyword">as</span> React<span class="token punctuation">.</span>ReactElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>实际上，上面 方法生成的 Element 是一个多个<code>RouteContext.Provider</code>组成的聚合体，大致的图解是这样的：</p> <div align="center"><img src="/luvue/images/react/06-react-router/react-router-090603.jpg" alt="react/06-react-router/react-router-090603.jpg"></div> <p>路由渲染阶段要做的事很少，就是将之前得到的 matches 数组渲染为 React 元素。</p> <h2 id="结论-3"><a href="#结论-3" class="header-anchor">#</a> 结论</h2> <ul><li><code>useRoutes</code> 是 react-router 中核心，用户不管是直接使用 <code>useRoutes</code> 还是用 <code>Routes</code> 与 <code>Route</code> 组件结合最终都会转换为它。该 hook 拥有三个阶段：<strong>路由上下文解析阶段、路由匹配阶段、路由渲染阶段</strong></li> <li><code>useRoutes</code> 在上下文解析阶段会解析在外层是否已经调用过 <code>useRoutes</code>，如果调用过会先获取外层的上下文数据，最后将外层数据与用户传入的 routes 数组结合，生成最终结果。</li> <li><code>useRoutes</code> 在匹配阶段会将传入的 <code>routes</code> 与当前的 <code>location</code>（可手动传入，但内部会做校验）做一层匹配，通过对 route 中声明的 path 的权重计算，拿到当前 pathname 所能匹配到的最佳 matches 数组，索引从小到大层数关系从外到内。</li> <li><code>useRoutes</code> 在渲染阶段会将 matches 数组渲染为一个聚合的 React Element，该元素整体是许多 <code>RouteContext.Provider</code> 的嵌套，从外到内依次是【<code>父 =&gt; 子 =&gt; 孙子</code>】这样的关系，每个 Provider 包含两个值，与该级别对应的 matches 数组（最后的元素时该级别的 route 自身）与 outlet 元素，<code>outlet</code> 元素就是嵌套 <code>RouteContext.Provider</code> 存放的地方，每个 RouteContext.Provider 的 children 就是 route 的 element 属性。</li> <li>每次使用 <code>outlet</code> 实际上都是渲染的内置的路由关系（如果当前 <code>route</code> 没有 <code>element</code> 属性，则默认渲染 outlet，这也是为什么可以直接写不带 <code>element</code> 的<code>&lt;Route/&gt;</code>组件嵌套的原因），我们可以在当前级别 route 的 element 中任意地方使用 outlet 来渲染子路由。</li></ul> <h1 id="子路由是如何渲染的-outlet-useoutlet"><a href="#子路由是如何渲染的-outlet-useoutlet" class="header-anchor">#</a> 子路由是如何渲染的 - Outlet &amp; useOutlet</h1> <p>如果你看懂了之前的内容，应该很容易就能猜到，子路由的渲染就是使用的 <code>useContext</code> 获取 <code>RouteContext.Provider</code> 中的 <code>outlet</code> 属性。同样的，react-router 为我们提供了两种调用方式：<code>&lt;Outlet /&gt;</code>与 <code>useOutlet</code>：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Outlet<span class="token punctuation">,</span> useOutlet <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Dashboard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> outlet <span class="token operator">=</span> <span class="token function">useOutlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Dashboard</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>outlet<span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* 或者下面这样 */</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* &lt;Outlet /&gt; */</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Dashboard</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>messages<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">DashboardMessages</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>tasks<span class="token punctuation">'</span></span> <span class="token attr-name">element</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">DashboardTasks</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Route</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Routes</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>同时，react-router 还允许我们在 outlet 中传递上下文信息：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Outlet<span class="token punctuation">,</span> useOutlet<span class="token punctuation">,</span> useOutletContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 下面两种方式等同</span>
  <span class="token comment">// const outlet = useOutlet([count, setCount])</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Outlet</span></span> <span class="token attr-name">context</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在子路由中获取传入的上下文信息</span>
<span class="token keyword">function</span> <span class="token function">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useOutletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">increment</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>increment<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="outlet-与-useoutlet-源码解析"><a href="#outlet-与-useoutlet-源码解析" class="header-anchor">#</a> Outlet 与 useOutlet 源码解析</h2> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// 在 outlet 中传入的上下文信息</span>
<span class="token keyword">const</span> OutletContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createContext</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 可以在嵌套的 routes 中使用，这里的上下文信息是用户在使用 &lt;Outlet /&gt; 或者 useOutlet 时传入的
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">useOutletContext</span><span class="token generic class-name"><span class="token operator">&lt;</span>Context <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Context <span class="token punctuation">{</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>OutletContext<span class="token punctuation">)</span> <span class="token keyword">as</span> Context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 拿到当前的 outlet，这里可以直接传入 outlet 的上下文信息
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useOutlet</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token operator">?</span><span class="token operator">:</span> unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> outlet <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>RouteContext<span class="token punctuation">)</span><span class="token punctuation">.</span>outlet<span class="token punctuation">;</span>
  <span class="token comment">// 可以看到，当 context 有值时才使用 OutletContext.Provider，如果没有值会继续沿用父路由的 OutletContext.Provider 中的值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>outlet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">OutletContext.Provider</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>context<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>outlet<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">OutletContext.Provider</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> outlet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">OutletProps</span> <span class="token punctuation">{</span>
  <span class="token comment">// 可以传入要提供给 outlet 内部元素的上下文信息</span>
  context<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 就是获取 context 上当前的 outlet
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Outlet</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token operator">:</span> OutletProps</span><span class="token punctuation">)</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">useOutlet</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>这几个方法本身还是很简单的，这里就不细说了</p> <h2 id="结论-4"><a href="#结论-4" class="header-anchor">#</a> 结论</h2> <ul><li>react-router 中使用<code>&lt;Outlet /&gt;</code>或 <code>useOutlet</code> 渲染子路由，而它们内部实际就是渲染 <code>RouteContext</code> 中的 outlet 属性。</li> <li><code>&lt;Outlet /&gt;</code>和 <code>useOutlet</code> 中可以传入上下文信息，在子路由中使用 <code>useOutletContext</code> 获取。传入该参数会覆盖掉父路由的上下文信息，如果不传，则会由内向外获取上下文信息。</li></ul> <h1 id="如何让路由跳转-navigate-usenavigate"><a href="#如何让路由跳转-navigate-usenavigate" class="header-anchor">#</a> 如何让路由跳转 - Navigate &amp; useNavigate</h1> <p>和子路由的渲染一样，react-router 同样提供了两种路由跳转的方式：<code>&lt;Navigate /&gt;</code>与 <code>useNavigate</code>。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useNavigate<span class="token punctuation">,</span> Navigate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> navigate <span class="token operator">=</span> <span class="token function">useNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 下面两种写法等同</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">navigate</span><span class="token punctuation">(</span><span class="token string">'/foo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Navigate</span></span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/foo<span class="token punctuation">'</span></span> <span class="token attr-name">relplace</span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>我们还可以像磁盘路径一样传入相对路径，此时路由会根据当前的 location 跳转。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useNavigate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">SignupForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> navigate <span class="token operator">=</span> <span class="token function">useNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleSubmit</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">submitForm</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 跳转到当前路由父路由下面的 success 路径， /auth/signup =&gt; /auth/success</span>
    <span class="token function">navigate</span><span class="token punctuation">(</span><span class="token string">'../success'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>其中，useNavigate 会返回一个 <code>navigator</code> 函数，该函数可以用于编程式导航。</p> <h2 id="navigate-与-usenavigate-源码解析"><a href="#navigate-与-usenavigate-源码解析" class="header-anchor">#</a> Navigate 与 useNavigate 源码解析</h2> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// useNavigate 返回的 navigate 函数定义，可以传入 to 或者传入数字控制浏览器页面栈的显示</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">NavigateFunction</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span>to<span class="token operator">:</span> To<span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> NavigateOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span>delta<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">NavigateOptions</span> <span class="token punctuation">{</span>
  <span class="token comment">// 是否替换当前栈</span>
  replace<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token comment">// 当前导航的 state</span>
  state<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 返回的 navigate 函数可以传和文件夹相同的路径规则
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> NavigateFunction <span class="token punctuation">{</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token function">useInRouterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// TODO: This error is probably because they somehow have 2 versions of the</span>
    <span class="token comment">// router loaded. We can help them understand how to avoid that.</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">useNavigate() may be used only in the context of a &lt;Router&gt; component.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Router 提供的 navigator，本质是 history 对象</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> basename<span class="token punctuation">,</span> navigator <span class="token punctuation">}</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>NavigationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 当前路由层级的 matches 对象（我们在前面说了，不同的 RouteContext.Provider 层级不同该值不同）</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> matches <span class="token punctuation">}</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>RouteContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> pathname<span class="token operator">:</span> locationPathname <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 依次匹配到的子路由之前的路径（/* 之前）</span>
  <span class="token keyword">let</span> routePathnamesJson <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
    matches<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> match<span class="token punctuation">.</span>pathnameBase<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 是否已经初始化完毕（useEffect），这里是要让页面不要在一渲染的时候就跳转，应该在 useEffect 后才能跳转，也就是说如果一渲染就要跳转页面应该写在 useEffect 中</span>
  <span class="token keyword">let</span> activeRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    activeRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 返回的跳转函数</span>
  <span class="token keyword">let</span> navigate<span class="token operator">:</span> NavigateFunction <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">to<span class="token operator">:</span> To <span class="token operator">|</span> number<span class="token punctuation">,</span> options<span class="token operator">:</span> NavigateOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果是数字</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        navigator<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 实际路径的获取，这个方法比较复杂，我们下面单独说</span>
      <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">resolveTo</span><span class="token punctuation">(</span>
        to<span class="token punctuation">,</span>
        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>routePathnamesJson<span class="token punctuation">)</span><span class="token punctuation">,</span>
        locationPathname
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 有 basename，加上 basename</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>basename <span class="token operator">!==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">.</span>pathname <span class="token operator">=</span> <span class="token function">joinPaths</span><span class="token punctuation">(</span><span class="token punctuation">[</span>basename<span class="token punctuation">,</span> path<span class="token punctuation">.</span>pathname<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>replace <span class="token operator">?</span> navigator<span class="token punctuation">.</span>replace <span class="token operator">:</span> navigator<span class="token punctuation">.</span>push<span class="token punctuation">)</span><span class="token punctuation">(</span>
        path<span class="token punctuation">,</span>
        options<span class="token punctuation">.</span>state
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>basename<span class="token punctuation">,</span> navigator<span class="token punctuation">,</span> routePathnamesJson<span class="token punctuation">,</span> locationPathname<span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> navigate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> To <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'history'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">NavigateProps</span> <span class="token punctuation">{</span>
  <span class="token comment">// To 从 history 中引入</span>
  <span class="token comment">/*
    export declare type To = string | PartialPath;
  */</span>
  to<span class="token operator">:</span> To<span class="token punctuation">;</span>
  replace<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  state<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 组件式导航，当页面渲染后立刻调用 navigate 方法，很简单的封装
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Navigate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> to<span class="token punctuation">,</span> replace<span class="token punctuation">,</span> state <span class="token punctuation">}</span><span class="token operator">:</span> NavigateProps</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// 必须在 Router 上下文中</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token function">useInRouterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// TODO: This error is probably because they somehow have 2 versions of</span>
    <span class="token comment">// the router loaded. We can help them understand how to avoid that.</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;Navigate&gt; may be used only in the context of a &lt;Router&gt; component.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> navigate <span class="token operator">=</span> <span class="token function">useNavigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">navigate</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token punctuation">{</span> replace<span class="token punctuation">,</span> state <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br></div></div><p>可以看到，Navigate 内部还是调用的 useNavigate，而 useNavigate 内部则是对用户传入的路径做处理，获取到最终的路径值，再传递给 NavigationContext 提供 navigator 对象。</p> <h3 id="路径解析"><a href="#路径解析" class="header-anchor">#</a> 路径解析</h3> <p>下面是 resolveTo 内部处理路径的详细代码：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// Path 对象是定义在 history 中的</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> Path <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'history'</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 将 to 解析为实际要跳转的路径，因为 to 可以是相对路径等，不是完全传入的 /xxx 开头的绝对路径
 * @param toArg 要跳转的路径
 * @param routePathnames 当前的所有父 Route 匹配到的路径
 * @param locationPathname 当前的 location 中的 pathname
 * @returns
 */</span>
<span class="token keyword">function</span> <span class="token function">resolveTo</span><span class="token punctuation">(</span>
  toArg<span class="token operator">:</span> To<span class="token punctuation">,</span>
  routePathnames<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  locationPathname<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token comment">// 返回 Path 对象</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Path <span class="token punctuation">{</span>
  <span class="token keyword">let</span> to <span class="token operator">=</span> <span class="token keyword">typeof</span> toArg <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>toArg<span class="token punctuation">)</span> <span class="token operator">:</span> toArg<span class="token punctuation">;</span>
  <span class="token comment">// 如果 to 没有提供路径名，比如仅仅是改变 search 字符串，返回 /</span>
  <span class="token keyword">let</span> toPathname <span class="token operator">=</span> toArg <span class="token operator">===</span> <span class="token string">''</span> <span class="token operator">||</span> to<span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">''</span> <span class="token operator">?</span> <span class="token string">'/'</span> <span class="token operator">:</span> to<span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>

  <span class="token comment">// 从哪个路由导航，主要是为了处理相对路径关系</span>
  <span class="token keyword">let</span> from<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token comment">// 没有提供 to，from 就是当前路径，不会改变 pathname</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>toPathname <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    from <span class="token operator">=</span> locationPathname<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 提供了 to，要去除掉 .. 找到 from，然后把 to 的 .. 消</span>
    <span class="token comment">// 注意这里的 routePathnames 在外部是通过 matches 映射来的，它的最后一段路由是调用 useNavigate 的路由，而不是 pathname 的最后一段路由</span>
    <span class="token comment">/**
     * eg: 比如当前 pathname 为 /auth/login，我们在 path = /auth 对应的路由下使用了 useNavigate，然后 navigate('..')，此时回到的页面是 /，而不是 /auth
     */</span>
    <span class="token keyword">let</span> routePathnameIndex <span class="token operator">=</span> routePathnames<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>toPathname<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> toSegments <span class="token operator">=</span> toPathname<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// to 和 a 标签的 href 是不同的，a 标签的 href 不会解析相对路径</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>toSegments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'..'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        toSegments<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据 toPathname 的 .. 数量往前回退</span>
        routePathnameIndex <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      to<span class="token punctuation">.</span>pathname <span class="token operator">=</span> toSegments<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果 .. 的数量超过了父路由的匹配数量，则默认回到根路径 /</span>
    from <span class="token operator">=</span> routePathnameIndex <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> routePathnames<span class="token punctuation">[</span>routePathnameIndex<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 注意，此时的 to 只处理了以 .. 开头的情况，还没处理中间有 .. 的情况，包括只有单个 . 的情况</span>
  <span class="token comment">// 下面进一步根据 to 和 from 转换为 Path 对象</span>
  <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">resolvePath</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果 toPathname 以 / 结尾，我们这里也要加上</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    toPathname <span class="token operator">&amp;&amp;</span>
    toPathname <span class="token operator">!==</span> <span class="token string">'/'</span> <span class="token operator">&amp;&amp;</span>
    toPathname<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>path<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">.</span>pathname <span class="token operator">+=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> path<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>上面是用了 <code>resolvePath</code> 方法做了进一步的转换，下面是这部分的源码：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 把传入的路径解析为 Path 对象，并会在这里处理相对路径之间的关系
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolvePath</span><span class="token punctuation">(</span>to<span class="token operator">:</span> To<span class="token punctuation">,</span> fromPathname <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token operator">:</span> Path <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> pathname<span class="token operator">:</span> toPathname<span class="token punctuation">,</span> search <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> hash <span class="token operator">=</span> <span class="token string">''</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
    <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span> <span class="token operator">:</span> to<span class="token punctuation">;</span>

  <span class="token comment">// 通过 to 不是相对路径，直接使用，如果是相对路径，处理相对路径</span>
  <span class="token keyword">let</span> pathname <span class="token operator">=</span> toPathname
    <span class="token operator">?</span> toPathname<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
      <span class="token operator">?</span> toPathname
      <span class="token operator">:</span> <span class="token comment">// 处理相对路径</span>
        <span class="token function">resolvePathname</span><span class="token punctuation">(</span>toPathname<span class="token punctuation">,</span> fromPathname<span class="token punctuation">)</span>
    <span class="token operator">:</span> fromPathname<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    pathname<span class="token punctuation">,</span>
    search<span class="token operator">:</span> <span class="token function">normalizeSearch</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">,</span>
    hash<span class="token operator">:</span> <span class="token function">normalizeHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 *
 * 处理相对路径
 * @param relativePath 相对路径
 * @param fromPathname 上下文路径
 * @returns
 */</span>
<span class="token keyword">function</span> <span class="token function">resolvePathname</span><span class="token punctuation">(</span><span class="token parameter">relativePath<span class="token operator">:</span> string<span class="token punctuation">,</span> fromPathname<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token comment">// 去除末尾的 /，然后用 / 分割。如果传入的 fromPathname 为 / 则返回 [&quot;&quot;]，注意 [&quot;&quot;] 是默认值。最小就是 [&quot;&quot;]</span>
  <span class="token keyword">let</span> segments <span class="token operator">=</span> fromPathname<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 这时的 relativePath 并不是以 / 开头的</span>
  <span class="token keyword">let</span> relativeSegments <span class="token operator">=</span> relativePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 这段代码就是解析路径，将 .. 和 . 这些与父级目录相比较，然后解析成绝对路径</span>
  relativeSegments<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">segment</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>segment <span class="token operator">===</span> <span class="token string">'..'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Keep the root &quot;&quot; segment so the pathname starts at /</span>
      <span class="token comment">// 注意这里是大于 1。证明这里会保证相对路径最后转换为以 / 开头的绝对路径</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>segments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> segments<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>segment <span class="token operator">!==</span> <span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果不是 .，添加新的路径，. 代表当前路径，没有作用</span>
      segments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 聚合上面的路径数组</span>
  <span class="token keyword">return</span> segments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> segments<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 格式化 search 字符串
 * @param search
 * @returns
 */</span>
<span class="token keyword">const</span> normalizeSearch <span class="token operator">=</span> <span class="token punctuation">(</span>search<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">string</span> <span class="token operator">=&gt;</span>
  <span class="token operator">!</span>search <span class="token operator">||</span> search <span class="token operator">===</span> <span class="token string">'?'</span>
    <span class="token operator">?</span> <span class="token string">''</span>
    <span class="token operator">:</span> search<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
    <span class="token operator">?</span> search
    <span class="token operator">:</span> <span class="token string">'?'</span> <span class="token operator">+</span> search<span class="token punctuation">;</span>

<span class="token comment">/**
 * 格式化 hash 字符串
 * @param hash
 * @returns
 */</span>
<span class="token keyword">const</span> normalizeHash <span class="token operator">=</span> <span class="token punctuation">(</span>hash<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">string</span> <span class="token operator">=&gt;</span>
  <span class="token operator">!</span>hash <span class="token operator">||</span> hash <span class="token operator">===</span> <span class="token string">'#'</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> hash<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token operator">?</span> hash <span class="token operator">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> hash<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>总的来说，路径解析主要就是将相对路径转换为浏览器能认识的绝对路径。</p> <h3 id="结论-5"><a href="#结论-5" class="header-anchor">#</a> 结论</h3> <ul><li>react-router 中使用<code>&lt;Navigate /&gt;</code>或 <code>useNavigate</code> 跳转路由，但实际内部是使用的 <code>NavigationContext</code> 提供的 <code>navigator</code> 对象（也就是 history 库提供的路由跳转对象）。</li> <li><code>&lt;Navigate /&gt;</code>内可以传类似磁盘路径<code>.</code>与<code>..</code>的相对路径，在内部会依次将每一段路由拆分，最终生成要跳转的绝对路径。</li></ul> <h1 id="核心功能完结-额外的辅助-api"><a href="#核心功能完结-额外的辅助-api" class="header-anchor">#</a> 核心功能完结，额外的辅助 API</h1> <h2 id="方法"><a href="#方法" class="header-anchor">#</a> 方法</h2> <h3 id="createroutesfromchildren"><a href="#createroutesfromchildren" class="header-anchor">#</a> createRoutesFromChildren</h3> <p>将 <code>Routes</code> 组件内部的 <code>Route</code> 组件转换为符合 <code>useRoutes</code> 规范的 <code>routes</code> 数组，在 <code>Routes</code> 源码解析中讲过。</p> <h3 id="generatepath"><a href="#generatepath" class="header-anchor">#</a> generatePath</h3> <p><code>generatePath(path , params)</code>根据传入的 <code>params</code> 对象将 path 的动态参数补并返回。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 将 params 放入 path 对应的动态参数中，比如 /:id/* 与 {id:'foo','*':'bar'} =&gt; /foo/bar
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">generatePath</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token operator">:</span> string<span class="token punctuation">,</span> params<span class="token operator">:</span> Params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> path
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">:(\w+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 params 中没有完全包含 path 中的动态参数，则报错</span>
      <span class="token function">invariant</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Missing &quot;:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; param</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/*\*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      <span class="token comment">// 判断路径为 * 的情况</span>
      params<span class="token punctuation">[</span><span class="token string">'*'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> params<span class="token punctuation">[</span><span class="token string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="matchroutes"><a href="#matchroutes" class="header-anchor">#</a> matchRoutes</h3> <p><code>matchRoutes(routes, locationArg, basename)</code>通过传入的 <code>routes</code> 配置项和当前 <code>location</code> 得到 <code>routes</code> 中能与 <code>location</code> 匹配的 <code>matches</code> 数组，在 <code>useRoutes</code> 源码解析 - 路由匹配阶段中讲过。</p> <h3 id="matchpath"><a href="#matchpath" class="header-anchor">#</a> matchPath</h3> <p><code>matchPath(pattern, pathname)</code>通过判断 pathname 是否匹配传入的 pattern，如果不匹配返回 null，如果匹配经过解析后的 match 对象，在 useRoutes 源码解析 - 路由匹配阶段中讲过。</p> <h3 id="rendermatches"><a href="#rendermatches" class="header-anchor">#</a> renderMatches</h3> <p>用于渲染 <code>matchRoutes</code> 方法的返回值为 React Element，其实内部就是调用了之前 useRoutes 路由渲染阶段的_renderMatches 方法。</p> <p>以下是源码：</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderMatches</span><span class="token punctuation">(</span>
  <span class="token parameter">matches<span class="token operator">:</span> RouteMatch<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">_renderMatches</span><span class="token punctuation">(</span>matches<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="resolvepath"><a href="#resolvepath" class="header-anchor">#</a> resolvePath</h3> <p><code>resolvePath(to, from)</code>将 <code>to</code> 与 <code>from</code> 两个路径相结合生成一个最终要跳转的路径，在 <code>Navigate</code> 与 <code>useNavigate</code> 源码解析中讲过。</p> <h2 id="hooks"><a href="#hooks" class="header-anchor">#</a> hooks</h2> <h3 id="useinroutercontext"><a href="#useinroutercontext" class="header-anchor">#</a> useInRouterContext</h3> <p>判断当前组件是否在 <code>Router</code> 上下文中，在 <code>Router</code> 源码解析中讲过。</p> <h3 id="uselocation"><a href="#uselocation" class="header-anchor">#</a> useLocation</h3> <p>获取当前浏览器的 <code>location</code>，在 Router 源码解析中讲过。</p> <h3 id="usenavigationtype"><a href="#usenavigationtype" class="header-anchor">#</a> useNavigationType</h3> <p>获取当前浏览器跳转时的 <code>action type</code>，在 Router 源码解析中讲过。</p> <h3 id="useresolvedpath"><a href="#useresolvedpath" class="header-anchor">#</a> useResolvedPath</h3> <p><code>useResolvedPath(to)</code>根据当前 location 获取解析传入 to 的路径，返回 Path 对象。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 转换路径的钩子，将 to 格式化为 Path 对象
 * type To = string | PartialPath;
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useResolvedPath</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token operator">:</span> To</span><span class="token punctuation">)</span><span class="token operator">:</span> Path <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> matches <span class="token punctuation">}</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>RouteContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> pathname<span class="token operator">:</span> locationPathname <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// JSON.stringify 是为了不每次 map 时生成新的地址依赖</span>
  <span class="token keyword">let</span> routePathnamesJson <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
    matches<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> match<span class="token punctuation">.</span>pathnameBase<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">useMemo</span><span class="token punctuation">(</span>
    <span class="token comment">// resolveTo 在讲 useNavigate 的时候说过，就是处理当前路径与 to 的关系，还有相对路径的转换</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolveTo</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>routePathnamesJson<span class="token punctuation">)</span><span class="token punctuation">,</span> locationPathname<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>to<span class="token punctuation">,</span> routePathnamesJson<span class="token punctuation">,</span> locationPathname<span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="usehref"><a href="#usehref" class="header-anchor">#</a> useHref</h3> <p><code>useHref(to)</code>用自动给传入的 to 路径添加 basename，返回一个新的 url。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 主要为了通过当前的 pathname，基于上下文的 basename 合并为完整的 url，官方这边建议是用于自定义的 link 组件，这样可以自动添加 basename
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useHref</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token operator">:</span> To</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token function">useInRouterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// TODO: This error is probably because they somehow have 2 versions of the</span>
    <span class="token comment">// router loaded. We can help them understand how to avoid that.</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">useHref() may be used only in the context of a &lt;Router&gt; component.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token punctuation">{</span> basename<span class="token punctuation">,</span> navigator <span class="token punctuation">}</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>NavigationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> hash<span class="token punctuation">,</span> pathname<span class="token punctuation">,</span> search <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useResolvedPath</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> joinedPathname <span class="token operator">=</span> pathname<span class="token punctuation">;</span>
  <span class="token comment">// 拿到带 basename 的 href</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>basename <span class="token operator">!==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 格式化 to 参数，获取 pathname</span>
    <span class="token keyword">let</span> toPathname <span class="token operator">=</span> <span class="token function">getToPathname</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否结尾带有 /</span>
    <span class="token keyword">let</span> endsWithSlash <span class="token operator">=</span> toPathname <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> toPathname<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    joinedPathname <span class="token operator">=</span>
      pathname <span class="token operator">===</span> <span class="token string">'/'</span>
        <span class="token operator">?</span> <span class="token comment">// 如果是 /，在前面添加 basename</span>
          basename <span class="token operator">+</span> <span class="token punctuation">(</span>endsWithSlash <span class="token operator">?</span> <span class="token string">'/'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token comment">// 合并 path</span>
          <span class="token function">joinPaths</span><span class="token punctuation">(</span><span class="token punctuation">[</span>basename<span class="token punctuation">,</span> pathname<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 把 To 对象转换为 string</span>
  <span class="token keyword">return</span> navigator<span class="token punctuation">.</span><span class="token function">createHref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> pathname<span class="token operator">:</span> joinedPathname<span class="token punctuation">,</span> search<span class="token punctuation">,</span> hash <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 获取 to 的 pathname
 * @param to
 * @returns
 */</span>
<span class="token keyword">function</span> <span class="token function">getToPathname</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token operator">:</span> To</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token punctuation">{</span>
  <span class="token comment">// Empty strings should be treated the same as / paths</span>
  <span class="token keyword">return</span> to <span class="token operator">===</span> <span class="token string">''</span> <span class="token operator">||</span> <span class="token punctuation">(</span>to <span class="token keyword">as</span> Path<span class="token punctuation">)</span><span class="token punctuation">.</span>pathname <span class="token operator">===</span> <span class="token string">''</span>
    <span class="token operator">?</span> <span class="token string">'/'</span>
    <span class="token operator">:</span> <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span>
    <span class="token operator">?</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span>pathname
    <span class="token operator">:</span> to<span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h3 id="usematch"><a href="#usematch" class="header-anchor">#</a> useMatch</h3> <p><code>useMatch(pattern)</code>一般用于需要根据 pathname 判断组件自身状态时使用。比如 NavLink，当传入的 pattern 能与当前 pathname 匹配则显示 active 状态。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 查询指定路由是否能匹配上当前的 pathname
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">useMatch</span><span class="token generic class-name"><span class="token operator">&lt;</span>
  ParamKey <span class="token keyword">extends</span> ParamParseKey<span class="token operator">&lt;</span>Path<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  Path <span class="token keyword">extends</span> <span class="token builtin">string</span>
<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pattern<span class="token operator">:</span> PathPattern<span class="token operator">&lt;</span>Path<span class="token operator">&gt;</span> <span class="token operator">|</span> Path<span class="token punctuation">)</span><span class="token operator">:</span> PathMatch<span class="token operator">&lt;</span>ParamKey<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token function">useInRouterContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// TODO: This error is probably because they somehow have 2 versions of the</span>
    <span class="token comment">// router loaded. We can help them understand how to avoid that.</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">useMatch() may be used only in the context of a &lt;Router&gt; component.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token punctuation">{</span> pathname <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token generic-function"><span class="token function">matchPath</span><span class="token generic class-name"><span class="token operator">&lt;</span>ParamKey<span class="token punctuation">,</span> Path<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> pathname<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    pathname<span class="token punctuation">,</span>
    pattern<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="useparams"><a href="#useparams" class="header-anchor">#</a> useParams</h3> <p><code>useParams</code> 用于获取当前 url 匹配到的所有 params。</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
 * 拿到当前 url 匹配到的所有 params
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">useParams</span><span class="token generic class-name"><span class="token operator">&lt;</span>
  <span class="token comment">// 可以传入泛型参数手动修改返回类型</span>
  ParamsOrKey <span class="token keyword">extends</span> <span class="token builtin">string</span> <span class="token operator">|</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token builtin">string</span>
<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Readonly<span class="token operator">&lt;</span>
  <span class="token comment">// 如果传入的是 string 的联合类型，代表是必选项，一定会有对应的参数，如果传入对象类型就是可选项</span>
  <span class="token punctuation">[</span>ParamsOrKey<span class="token punctuation">]</span> <span class="token keyword">extends</span> <span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span> <span class="token operator">?</span> Params<span class="token operator">&lt;</span>ParamsOrKey<span class="token operator">&gt;</span> <span class="token operator">:</span> Partial<span class="token operator">&lt;</span>ParamsOrKey<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> matches <span class="token punctuation">}</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>RouteContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> routeMatch <span class="token operator">=</span> matches<span class="token punctuation">[</span>matches<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> routeMatch <span class="token operator">?</span> <span class="token punctuation">(</span>routeMatch<span class="token punctuation">.</span>params <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本文算是一篇对 <code>react-router v6</code> 核心原理深度剖析的文章。从最开始的 <code>Router</code> 上下文讲起，<strong>讲到了两种路由的配置方式以及实现原理，路由如何计算权重，如何匹配以及如何渲染（这是最核心的地方）</strong>，进而推进到子路由的渲染原理，最后又讲到了两种路由的跳转方式以及对相对路由的解析结果。</p> <p>除此之外，我们还拓展了 react-router 额外对外暴露的辅助 API，用于辅助用户进行路由相关操作。</p> <p>react-router v6 是一次全面升级的版本，它带来了更少的代码量与更强大的功能，同时它的核心实现思路也是非常值得借鉴的。如果你想要开发一款独立路由库，或许能够从中得到启发。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/luvue/react/05-react18/03-不再神秘的优先级机制.html" class="prev">03-不再神秘的优先级机制</a></span> <span class="next"><a href="/luvue/react/06-react-router/02-react-router-v6实现集中式路由.html">02-react-router-v6实现集中式路由</a>
      →
    </span></p></div> </main> <span data-v-2ae0ee72></span></div><div class="global-ui"></div></div>
    <script src="/luvue/assets/js/app.50227b6d.js" defer></script><script src="/luvue/assets/js/2.dc297d8e.js" defer></script><script src="/luvue/assets/js/3.51a2d233.js" defer></script><script src="/luvue/assets/js/190.a66da869.js" defer></script>
  </body>
</html>
