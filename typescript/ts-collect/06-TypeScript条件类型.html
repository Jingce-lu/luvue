<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TypeScript 条件类型 | Luvue notes</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel=" " href=" ">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/luvue/assets/css/0.styles.0c275c11.css" as="style"><link rel="preload" href="/luvue/assets/js/app.bd06d157.js" as="script"><link rel="preload" href="/luvue/assets/js/2.435f734b.js" as="script"><link rel="preload" href="/luvue/assets/js/3.116bd10d.js" as="script"><link rel="preload" href="/luvue/assets/js/113.a4f19600.js" as="script"><link rel="prefetch" href="/luvue/assets/js/10.25b052a7.js"><link rel="prefetch" href="/luvue/assets/js/100.30bacd39.js"><link rel="prefetch" href="/luvue/assets/js/101.64eddbeb.js"><link rel="prefetch" href="/luvue/assets/js/102.61476ef5.js"><link rel="prefetch" href="/luvue/assets/js/103.b374cb2d.js"><link rel="prefetch" href="/luvue/assets/js/104.dcaca048.js"><link rel="prefetch" href="/luvue/assets/js/105.988e3596.js"><link rel="prefetch" href="/luvue/assets/js/106.8857b0e1.js"><link rel="prefetch" href="/luvue/assets/js/107.68522df0.js"><link rel="prefetch" href="/luvue/assets/js/108.b35b814f.js"><link rel="prefetch" href="/luvue/assets/js/109.ab4c7e31.js"><link rel="prefetch" href="/luvue/assets/js/11.2637f019.js"><link rel="prefetch" href="/luvue/assets/js/110.78d8248a.js"><link rel="prefetch" href="/luvue/assets/js/111.82ce8d85.js"><link rel="prefetch" href="/luvue/assets/js/112.12249a54.js"><link rel="prefetch" href="/luvue/assets/js/114.8e65e438.js"><link rel="prefetch" href="/luvue/assets/js/115.08a029b1.js"><link rel="prefetch" href="/luvue/assets/js/116.bf134290.js"><link rel="prefetch" href="/luvue/assets/js/117.a923a928.js"><link rel="prefetch" href="/luvue/assets/js/118.bc336ead.js"><link rel="prefetch" href="/luvue/assets/js/119.2f92d9f6.js"><link rel="prefetch" href="/luvue/assets/js/12.666a4192.js"><link rel="prefetch" href="/luvue/assets/js/120.e303c66a.js"><link rel="prefetch" href="/luvue/assets/js/121.40ceff18.js"><link rel="prefetch" href="/luvue/assets/js/122.f7f5105d.js"><link rel="prefetch" href="/luvue/assets/js/123.90079a8f.js"><link rel="prefetch" href="/luvue/assets/js/124.4bb8730c.js"><link rel="prefetch" href="/luvue/assets/js/125.b7999c7f.js"><link rel="prefetch" href="/luvue/assets/js/126.e0533c4d.js"><link rel="prefetch" href="/luvue/assets/js/127.89c46f0b.js"><link rel="prefetch" href="/luvue/assets/js/128.67627737.js"><link rel="prefetch" href="/luvue/assets/js/129.96112dc4.js"><link rel="prefetch" href="/luvue/assets/js/13.80dad4d9.js"><link rel="prefetch" href="/luvue/assets/js/130.cabff902.js"><link rel="prefetch" href="/luvue/assets/js/131.79ac215f.js"><link rel="prefetch" href="/luvue/assets/js/132.d9acbd97.js"><link rel="prefetch" href="/luvue/assets/js/133.9d930391.js"><link rel="prefetch" href="/luvue/assets/js/134.74066daa.js"><link rel="prefetch" href="/luvue/assets/js/135.1de5dd27.js"><link rel="prefetch" href="/luvue/assets/js/136.b54f803c.js"><link rel="prefetch" href="/luvue/assets/js/137.a508f817.js"><link rel="prefetch" href="/luvue/assets/js/138.9a443aef.js"><link rel="prefetch" href="/luvue/assets/js/139.209419f9.js"><link rel="prefetch" href="/luvue/assets/js/14.e6e40836.js"><link rel="prefetch" href="/luvue/assets/js/140.b3a13f8a.js"><link rel="prefetch" href="/luvue/assets/js/141.04cd7b08.js"><link rel="prefetch" href="/luvue/assets/js/142.4f7594f1.js"><link rel="prefetch" href="/luvue/assets/js/143.491cf6bf.js"><link rel="prefetch" href="/luvue/assets/js/144.c6c6b1d4.js"><link rel="prefetch" href="/luvue/assets/js/145.102b94dc.js"><link rel="prefetch" href="/luvue/assets/js/146.55fdfd58.js"><link rel="prefetch" href="/luvue/assets/js/147.1365ae3c.js"><link rel="prefetch" href="/luvue/assets/js/148.89b7e86c.js"><link rel="prefetch" href="/luvue/assets/js/149.c6cf854a.js"><link rel="prefetch" href="/luvue/assets/js/15.f0f66abc.js"><link rel="prefetch" href="/luvue/assets/js/150.727fb530.js"><link rel="prefetch" href="/luvue/assets/js/151.d5e57149.js"><link rel="prefetch" href="/luvue/assets/js/152.99ce124e.js"><link rel="prefetch" href="/luvue/assets/js/153.493f594c.js"><link rel="prefetch" href="/luvue/assets/js/154.df9c0737.js"><link rel="prefetch" href="/luvue/assets/js/155.b135c541.js"><link rel="prefetch" href="/luvue/assets/js/156.520062bf.js"><link rel="prefetch" href="/luvue/assets/js/157.718cf973.js"><link rel="prefetch" href="/luvue/assets/js/158.97868c1b.js"><link rel="prefetch" href="/luvue/assets/js/159.a493f6d4.js"><link rel="prefetch" href="/luvue/assets/js/16.686e4cd5.js"><link rel="prefetch" href="/luvue/assets/js/160.10a7b1f7.js"><link rel="prefetch" href="/luvue/assets/js/161.f314fe9c.js"><link rel="prefetch" href="/luvue/assets/js/162.0826911e.js"><link rel="prefetch" href="/luvue/assets/js/163.751f91b0.js"><link rel="prefetch" href="/luvue/assets/js/164.ff4246af.js"><link rel="prefetch" href="/luvue/assets/js/165.8a6663be.js"><link rel="prefetch" href="/luvue/assets/js/166.9d4815de.js"><link rel="prefetch" href="/luvue/assets/js/167.b79e20fc.js"><link rel="prefetch" href="/luvue/assets/js/168.abfa67ee.js"><link rel="prefetch" href="/luvue/assets/js/169.f8bbdc52.js"><link rel="prefetch" href="/luvue/assets/js/17.95c8e227.js"><link rel="prefetch" href="/luvue/assets/js/170.3f60e84e.js"><link rel="prefetch" href="/luvue/assets/js/171.dd17f9fb.js"><link rel="prefetch" href="/luvue/assets/js/172.b3ff7c93.js"><link rel="prefetch" href="/luvue/assets/js/173.312d63b3.js"><link rel="prefetch" href="/luvue/assets/js/174.193a445e.js"><link rel="prefetch" href="/luvue/assets/js/175.5fde5541.js"><link rel="prefetch" href="/luvue/assets/js/176.04f72a78.js"><link rel="prefetch" href="/luvue/assets/js/177.61af761d.js"><link rel="prefetch" href="/luvue/assets/js/178.db9bce6e.js"><link rel="prefetch" href="/luvue/assets/js/179.26e86af8.js"><link rel="prefetch" href="/luvue/assets/js/18.6bd7e2a3.js"><link rel="prefetch" href="/luvue/assets/js/180.8fec9507.js"><link rel="prefetch" href="/luvue/assets/js/181.2a3b9891.js"><link rel="prefetch" href="/luvue/assets/js/182.0642c84e.js"><link rel="prefetch" href="/luvue/assets/js/183.a6aa4900.js"><link rel="prefetch" href="/luvue/assets/js/184.cb475311.js"><link rel="prefetch" href="/luvue/assets/js/185.ac7279dd.js"><link rel="prefetch" href="/luvue/assets/js/186.f6d64740.js"><link rel="prefetch" href="/luvue/assets/js/19.588f1e2a.js"><link rel="prefetch" href="/luvue/assets/js/20.6e936b62.js"><link rel="prefetch" href="/luvue/assets/js/21.5a8c4caa.js"><link rel="prefetch" href="/luvue/assets/js/22.71db563d.js"><link rel="prefetch" href="/luvue/assets/js/23.d0499b69.js"><link rel="prefetch" href="/luvue/assets/js/24.8fd2dfc1.js"><link rel="prefetch" href="/luvue/assets/js/25.f57b939a.js"><link rel="prefetch" href="/luvue/assets/js/26.4105fe3a.js"><link rel="prefetch" href="/luvue/assets/js/27.9f24fb61.js"><link rel="prefetch" href="/luvue/assets/js/28.71c44a1e.js"><link rel="prefetch" href="/luvue/assets/js/29.8661793f.js"><link rel="prefetch" href="/luvue/assets/js/30.5fd0d07d.js"><link rel="prefetch" href="/luvue/assets/js/31.9845f4cc.js"><link rel="prefetch" href="/luvue/assets/js/32.7ef3c995.js"><link rel="prefetch" href="/luvue/assets/js/33.11c63d5e.js"><link rel="prefetch" href="/luvue/assets/js/34.d463da9c.js"><link rel="prefetch" href="/luvue/assets/js/35.02a8fbe4.js"><link rel="prefetch" href="/luvue/assets/js/36.a1afaf38.js"><link rel="prefetch" href="/luvue/assets/js/37.925865bb.js"><link rel="prefetch" href="/luvue/assets/js/38.1f842a56.js"><link rel="prefetch" href="/luvue/assets/js/39.bd9ed807.js"><link rel="prefetch" href="/luvue/assets/js/4.952d9840.js"><link rel="prefetch" href="/luvue/assets/js/40.8fd09048.js"><link rel="prefetch" href="/luvue/assets/js/41.d5e3abff.js"><link rel="prefetch" href="/luvue/assets/js/42.598ea217.js"><link rel="prefetch" href="/luvue/assets/js/43.3fff97e6.js"><link rel="prefetch" href="/luvue/assets/js/44.77edcbeb.js"><link rel="prefetch" href="/luvue/assets/js/45.85586fe5.js"><link rel="prefetch" href="/luvue/assets/js/46.c3ac4a88.js"><link rel="prefetch" href="/luvue/assets/js/47.b5bcf39a.js"><link rel="prefetch" href="/luvue/assets/js/48.3639bf26.js"><link rel="prefetch" href="/luvue/assets/js/49.2c8c9ace.js"><link rel="prefetch" href="/luvue/assets/js/5.0f16b785.js"><link rel="prefetch" href="/luvue/assets/js/50.7984c7e6.js"><link rel="prefetch" href="/luvue/assets/js/51.56daf81d.js"><link rel="prefetch" href="/luvue/assets/js/52.b0797bbe.js"><link rel="prefetch" href="/luvue/assets/js/53.de493e7f.js"><link rel="prefetch" href="/luvue/assets/js/54.2826909e.js"><link rel="prefetch" href="/luvue/assets/js/55.76bfde5a.js"><link rel="prefetch" href="/luvue/assets/js/56.264f2b51.js"><link rel="prefetch" href="/luvue/assets/js/57.2dfff002.js"><link rel="prefetch" href="/luvue/assets/js/58.fef0687f.js"><link rel="prefetch" href="/luvue/assets/js/59.e985b7de.js"><link rel="prefetch" href="/luvue/assets/js/6.383eb099.js"><link rel="prefetch" href="/luvue/assets/js/60.b36f80a9.js"><link rel="prefetch" href="/luvue/assets/js/61.12221ce9.js"><link rel="prefetch" href="/luvue/assets/js/62.e6b16c58.js"><link rel="prefetch" href="/luvue/assets/js/63.e3bcafb9.js"><link rel="prefetch" href="/luvue/assets/js/64.ca697d42.js"><link rel="prefetch" href="/luvue/assets/js/65.6f9c5189.js"><link rel="prefetch" href="/luvue/assets/js/66.068ffd7a.js"><link rel="prefetch" href="/luvue/assets/js/67.14066762.js"><link rel="prefetch" href="/luvue/assets/js/68.ba29b70c.js"><link rel="prefetch" href="/luvue/assets/js/69.a34fc542.js"><link rel="prefetch" href="/luvue/assets/js/7.466da337.js"><link rel="prefetch" href="/luvue/assets/js/70.c5148b68.js"><link rel="prefetch" href="/luvue/assets/js/71.b210abcd.js"><link rel="prefetch" href="/luvue/assets/js/72.4d9b48b9.js"><link rel="prefetch" href="/luvue/assets/js/73.473315ad.js"><link rel="prefetch" href="/luvue/assets/js/74.d79594ed.js"><link rel="prefetch" href="/luvue/assets/js/75.d09dff23.js"><link rel="prefetch" href="/luvue/assets/js/76.2a3e1718.js"><link rel="prefetch" href="/luvue/assets/js/77.a09f8016.js"><link rel="prefetch" href="/luvue/assets/js/78.ab2200c2.js"><link rel="prefetch" href="/luvue/assets/js/79.1e76c9db.js"><link rel="prefetch" href="/luvue/assets/js/8.bc4cc08a.js"><link rel="prefetch" href="/luvue/assets/js/80.fcbec605.js"><link rel="prefetch" href="/luvue/assets/js/81.f1100b4f.js"><link rel="prefetch" href="/luvue/assets/js/82.010edac4.js"><link rel="prefetch" href="/luvue/assets/js/83.adeb2bb2.js"><link rel="prefetch" href="/luvue/assets/js/84.fa85d59d.js"><link rel="prefetch" href="/luvue/assets/js/85.af7d351f.js"><link rel="prefetch" href="/luvue/assets/js/86.31cb95df.js"><link rel="prefetch" href="/luvue/assets/js/87.ffd4a37f.js"><link rel="prefetch" href="/luvue/assets/js/88.d9717442.js"><link rel="prefetch" href="/luvue/assets/js/89.726ad3a0.js"><link rel="prefetch" href="/luvue/assets/js/9.c0942326.js"><link rel="prefetch" href="/luvue/assets/js/90.782315ee.js"><link rel="prefetch" href="/luvue/assets/js/91.65cbc16c.js"><link rel="prefetch" href="/luvue/assets/js/92.d69c56df.js"><link rel="prefetch" href="/luvue/assets/js/93.d8ff20d2.js"><link rel="prefetch" href="/luvue/assets/js/94.6249be93.js"><link rel="prefetch" href="/luvue/assets/js/95.761d5806.js"><link rel="prefetch" href="/luvue/assets/js/96.d180a55b.js"><link rel="prefetch" href="/luvue/assets/js/97.506ca407.js"><link rel="prefetch" href="/luvue/assets/js/98.4b4b92da.js"><link rel="prefetch" href="/luvue/assets/js/99.d83a8e34.js">
    <link rel="stylesheet" href="/luvue/assets/css/0.styles.0c275c11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/luvue/" class="home-link router-link-active"><!----> <span class="site-name">Luvue notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link router-link-active">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/opt/" class="nav-link">渲染性能优化</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link router-link-active">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/opt/" class="nav-link">渲染性能优化</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/typescript/study/" class="sidebar-heading clickable"><span>study</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/typescript/ts-collect/" class="sidebar-heading clickable router-link-active open"><span>ts-collect</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/luvue/typescript/ts-collect/01-TypeScript中提升幸福感的10个高级技巧.html" class="sidebar-link">01-TypeScript中提升幸福感的10个高级技巧</a></li><li><a href="/luvue/typescript/ts-collect/02-走近Ts.html" class="sidebar-link">02-走近Ts</a></li><li><a href="/luvue/typescript/ts-collect/03-玩转TypeScript工具类型（上）.html" class="sidebar-link">03-玩转TypeScript工具类型（上）</a></li><li><a href="/luvue/typescript/ts-collect/04-玩转TypeScript工具类型（中）.html" class="sidebar-link">04-玩转TypeScript工具类型（中）</a></li><li><a href="/luvue/typescript/ts-collect/05-玩转TypeScript工具类型（下）.html" class="sidebar-link">05-玩转TypeScript工具类型（下）</a></li><li><a href="/luvue/typescript/ts-collect/06-TypeScript条件类型.html" class="active sidebar-link">06-TypeScript条件类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/typescript/ts-collect/06-TypeScript条件类型.html#从一个条件类型开始" class="sidebar-link">从一个条件类型开始</a></li><li class="sidebar-sub-header"><a href="/luvue/typescript/ts-collect/06-TypeScript条件类型.html#可分配性" class="sidebar-link">可分配性</a></li><li class="sidebar-sub-header"><a href="/luvue/typescript/ts-collect/06-TypeScript条件类型.html#基于-分发条件类型-来细化联合类型" class="sidebar-link">基于“分发条件类型”来细化联合类型</a></li><li class="sidebar-sub-header"><a href="/luvue/typescript/ts-collect/06-TypeScript条件类型.html#分发条件类型的一个真实使用场景" class="sidebar-link">分发条件类型的一个真实使用场景</a></li><li class="sidebar-sub-header"><a href="/luvue/typescript/ts-collect/06-TypeScript条件类型.html#使用-infer-解构类型" class="sidebar-link">使用 infer 解构类型</a></li><li class="sidebar-sub-header"><a href="/luvue/typescript/ts-collect/06-TypeScript条件类型.html#其他的内置条件类型" class="sidebar-link">其他的内置条件类型</a></li></ul></li><li><a href="/luvue/typescript/ts-collect/07-TypeScript内置工具.html" class="sidebar-link">07-TypeScript内置工具</a></li><li><a href="/luvue/typescript/ts-collect/08-Type-Challenges.html" class="sidebar-link">08-Type-Challenges</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="typescript-条件类型"><a href="#typescript-条件类型" class="header-anchor">#</a> TypeScript 条件类型</h1> <p></p><div class="table-of-contents"><ul><li><a href="#从一个条件类型开始">从一个条件类型开始</a></li><li><a href="#可分配性">可分配性</a></li><li><a href="#基于-分发条件类型-来细化联合类型">基于“分发条件类型”来细化联合类型</a></li><li><a href="#分发条件类型的一个真实使用场景">分发条件类型的一个真实使用场景</a></li><li><a href="#使用-infer-解构类型">使用 infer 解构类型</a></li><li><a href="#其他的内置条件类型">其他的内置条件类型</a></li></ul></div><p></p> <p>条件类型或许并不是每天都会用到，但是你可能一直都在间接的使用它们。因为它们非常适合“管道(plumbing)”或者是“框架”代码，用来处理 <strong>API 边界(API boundaries)和底层的一些东西(behind-the-scenes kinda stuff)</strong>。</p> <h2 id="从一个条件类型开始"><a href="#从一个条件类型开始" class="header-anchor">#</a> 从一个条件类型开始</h2> <p>这里有一段 JavaScript 代码：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> text <span class="token operator">&amp;&amp;</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">f</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">process</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在这段代码中，很明显<code>.toUpperCase()</code>的调用是安全的。每次给 <code>process</code> 传入一个字符串，函数返回一个字符串。</p> <p>但是需要注意的是，我们也可以给这个函数传入一些别的参数，比如 <code>null</code>，这时候函数会返回 <code>null</code>。而这时候对返回结果调用 <code>toUpperCase()</code>将会报错。</p> <p>当然我们可以给这个函数添加一些基础的类型，让 <code>TypeScript</code> 来检查我们是否在安全的使用这个函数：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span>text<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> text <span class="token operator">&amp;&amp;</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">f</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这么做看起来是安全的。如果像之前那样使用会发生什么？</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">//    ⌄ Type Error! :(</span>

<span class="token function">process</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>TypeScript</code> 提示了类型错误，因为它认为 <code>process(&quot;foo&quot;)</code>可能会返回 <code>null</code>，即使我们很清楚的知道实际上运行结果返回的不是 null。但是 <code>TypeScript</code> 并没有办法对运行时的状态进行预测。
有一种方法能够帮助 TypeScript 更好的理解这个函数，就是使用<code>重载(overloading)</code>，重载可以为一个函数提供多个类型签名，来让 TypeScript 根据给定的上下文来决定使用哪一个。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>
<span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span>text<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span>text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span>text<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>

  <span class="token operator">...</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这样如果我们传入一个 <code>string</code>，它就会返回一个 <code>string</code>。如果我们传入一个 <code>null</code>，它就会返回一个 <code>null</code>。</p> <p>现在这个函数可以像我们所希望的那样工作了：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// All clear!</span>

<span class="token function">process</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//           ⌄ Type Error! :)</span>

<span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>但是这里有另外一个用例没有生效：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">declare</span> <span class="token keyword">const</span> maybeFoo<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">//      ⌄ Type Error! :(</span>

<span class="token function">process</span><span class="token punctuation">(</span>maybeFoo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><a href="https://www.typescriptlang.org/play?#code/GYVwdgxgLglg9mABABwE5wgUwM7YBRSYAeUAXImCADZUCU5lNA3AFCiSwIrpa4HFlE2KKhhgA5vSEix41gHp5idtHhI0GHPkIlyw0RMQAfCtTp6Zhk4yqsVndTy39diAIZgAnlI+fEAbxZERBYAXxYWABNMCCo3VExECARhREJhCwNxY1MaFg1ebRwoWiA" target="_blank" rel="noopener noreferrer">亲手试一试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>TypeScript</code> 不允许我们传入一个类型 <code>string | null</code> 的参数，因为它无法合并重载声明。这时候我们既可以选择新增一种重载类型，(╯°□°)╯︵ ┻━┻ 亦或者选择使用条件类型。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">process</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>

  text<span class="token operator">:</span> <span class="token constant">T</span>

<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">string</span></span> <span class="token operator">?</span> <span class="token builtin">string</span> <span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>

  <span class="token operator">...</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>如上所示，我们引入一个类型变量 <code>T</code> 来做 <code>text</code> 参数的类型。然后我们可以使用 T 作为条件返回类型的一部分：<code>T extends string ? string : null</code>。你或许已经注意到了这看起来像是一个三元表达式。事实上，它确实做着相似的事情，但是是在类型系统进行编译时完成的。
这样做就兼顾到了我们所有的使用用例：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">typeof</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; string</span>

<span class="token keyword">typeof</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; null</span>

<span class="token keyword">typeof</span> <span class="token function">process</span><span class="token punctuation">(</span>maybeFoo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; string | null</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这就是条件类型，一种三元表达式，它看起来总是长这样：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token constant">B</span></span> <span class="token operator">?</span> <span class="token constant">C</span> <span class="token operator">:</span> <span class="token constant">D</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>A、B、C、D</code> 可以是任何我们已知的类型表达式，重点是在左边，<code>A extends B</code> 条件。</p> <h2 id="可分配性"><a href="#可分配性" class="header-anchor">#</a> 可分配性</h2> <p><code>extends</code> 关键字是条件类型的核心，<code>A extends B</code> 就意味着<strong>任何满足类型为 A 的值都可以安全的分配(assign)给类型为 B 的变量</strong>。用类型系统的话讲叫：<strong>A 能够分配给 B（A is assignable to B）</strong>。从如下这段代码中理解一下<strong>可分配</strong>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">declare</span> <span class="token keyword">const</span> a<span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> b<span class="token operator">:</span> <span class="token constant">B</span> <span class="token operator">=</span> a<span class="token punctuation">;</span>

<span class="token comment">// type check succeeds only if A is assignable to B</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>TypeScript 使用的是一种被称为结构类型的方法来决定哪些类型可以相互分配。这种类型系统在大约十年前开始出现在主流语言中，如果你有 <code>C#</code>或者 <code>Java</code> 经验可能会觉得这种类型系统有点反直觉。
你或许听说过和动态类型语言息息相关的鸭子类型（ducking type），ducking type 的短语出自一个谚语：</p> <blockquote><p>If it looks like a duck, swims like a duck, and quacks like a duck, then it probably is a duck.</p></blockquote> <p>在鸭子类型中，我们通过事物的行为来判断一个事物，而不是通过看它是谁或者追溯它来自何处。可以把它理解为“任人唯贤”。结构类型就是将这种思想应用于静态编译时类型系统的产物。</p> <p>所以 TypeScript 只关心一个类型能够做什么，而不关心它叫什么以及它在类型层次结构中处于什么位置。
来看一个简单的例子：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name"><span class="token constant">A</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name"><span class="token constant">B</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> b<span class="token operator">:</span> <span class="token constant">B</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">A</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ✔ all good</span>

<span class="token keyword">const</span> a<span class="token operator">:</span> <span class="token constant">A</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">B</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ✔ all good</span>

<span class="token keyword">new</span> <span class="token class-name"><span class="token constant">A</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token constant">B</span></span><span class="token punctuation">;</span> <span class="token comment">// =&gt; false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在上面代码中，TypeScript 将两个完全不相关的类型视为相等的，因为它们具有相同的结构和能力。但是在运行时，这两个类并不是等价的。
这是 TypeScript 和 JavaScript 在语义上存在显著差别的一个典型例子。这看起来似乎是一个问题，其实是因为结构类型要比 Java 风格的名义（nominal）类型要更加的灵活多变，后者更加关注名称（names）和层次结构（hierarchy）。但是这两者并不是互相排斥的，在某些语言中，例如 Scala 和 Flow，允许你混用它们来解决特定问题。
除此之外，可分配性和结构类型这两者在实际的代码中是非常直观的：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">Shape</span> <span class="token punctuation">{</span>
  color<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Circle</span> <span class="token punctuation">{</span>
  color<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  radius<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ✔ All good! Circles have a color</span>

<span class="token keyword">const</span> shape<span class="token operator">:</span> Shape <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Circle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ✘ Type error! Not all shapes have a radius!</span>

<span class="token keyword">const</span> circle<span class="token operator">:</span> Circle <span class="token operator">=</span> shape<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>所以从结构上来看，<code>A extends B</code> 很像是 <strong>A 是 B 的超集</strong>。说的更明白点，就是<strong>类型 A 包含类型 B 的所有属性，并且可能还有更多</strong>。</p> <p>有一个需要注意的点，就是<strong>字面（literal）类型</strong>。在 <code>TypeScript</code> 中你可以使用字面量本身作为类型。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">let</span> fruit<span class="token operator">:</span> <span class="token string">'banana'</span> <span class="token operator">=</span> <span class="token string">'banana'</span><span class="token punctuation">;</span>

<span class="token comment">// Type Error! &quot;apple&quot; is not assignable to &quot;banana&quot;</span>

fruit <span class="token operator">=</span> <span class="token string">'apple'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>&quot;banana&quot;作为字符串并没有比其他的字符串多出来什么属性，但是&quot;banana&quot;作为一个类型，却要比 string 类型具体的多，它只允许赋值为&quot;banana&quot;。</p> <p>所以也可以从另一个角度理解 <code>A extends B</code>：<strong>那就是 A 是 B 的一个更具体的版本</strong>。这里的“具体”的含义可以理解为有更多的属性或者是更加的明确，也就是有更多的限制。与之前的提到的 A 是 B 的超集一个含义。</p> <p>这就引出了<strong>顶层类型（Top）和底层类型（Bottom）</strong>，也就是不那么具体的类型和最具体的类型。</p> <p>在类型理论中，顶层类型是所有其他的类型都可以分配的类型，如果我们对一个类型没有任何具体的信息，那么就可以把这个类型设置为顶层类型，顶层类型被视为所有可能类型的联合：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Top</span> <span class="token operator">=</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token punctuation">{</span>foo<span class="token operator">:</span> Bar<span class="token punctuation">}</span> <span class="token operator">|</span> Baz<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token operator">...</span> <span class="token operator">|</span> ∞
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>TypeScript 包含两个顶层类型：<code>any</code> 和 <code>unknown</code>。</p> <ul><li>使用 <code>any</code> 就意味着：你无法确定值的类型，所以 <code>TypeScript</code> 会假定你使用的是正确的，并且不会有任何的告警</li> <li>使用 <code>unknown</code> 就意味着：同样是无法确定值的类型，但是 <code>TypeScript</code> 会要求你在运行时检查值的类型</li></ul> <p>底层（bottom）类型是其他类型不可分配的类型，也没有值可以赋值给这个类型的变量。可以将其视为空联合类型：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Bottom</span> <span class="token operator">=</span> ∅
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>TypeScript</code> 中有一个底层类型：<code>never</code>。这个类型很能见名知意，也就是啥也不是。</p> <p>在使用条件类型时，了解顶层类型和底层类型很有用。<code>never</code> 在使用条件类型细化联合类型的时候尤其有用。</p> <h2 id="基于-分发条件类型-来细化联合类型"><a href="#基于-分发条件类型-来细化联合类型" class="header-anchor">#</a> 基于“分发条件类型”来细化联合类型</h2> <p>条件类型可以用来过滤掉联合类型的特定成员。用一个例子来说明，首先我们定义一个联合类型 Animal：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Animal</span> <span class="token operator">=</span> Lion <span class="token operator">|</span> Zebra <span class="token operator">|</span> Tiger <span class="token operator">|</span> Shark<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果我们需要一个函数来过滤出哪些是猫科动物，我们可以写一个工具类型 <code>ExtractCat</code> 来实现：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ExtractCat<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token punctuation">{</span> <span class="token function">meow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">}</span> <span class="token operator">?</span> <span class="token constant">A</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">Cat</span> <span class="token operator">=</span> ExtractCat<span class="token operator">&lt;</span>Animal<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// =&gt; Lion | Tiger</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>I know lions and tigers don't meow, but how cute would it be if they did ^_^
起初，这种方式让我觉得有点迷糊又神奇。接下来我们深入了解一下 <code>TypeScript</code> 在处理 <code>ExtractCat&lt;Animal&gt;</code>时做了什么：</p> <p>首先，它将 <code>ExtractCat</code> 递归的应用于 <code>Animal</code> 的所有成员：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Cat</span> <span class="token operator">=</span>
  <span class="token operator">|</span> ExtractCat<span class="token operator">&lt;</span>Lion<span class="token operator">&gt;</span>
  <span class="token operator">|</span> ExtractCat<span class="token operator">&lt;</span>Zebra<span class="token operator">&gt;</span>
  <span class="token operator">|</span> ExtractCat<span class="token operator">&lt;</span>Tiger<span class="token operator">&gt;</span>
  <span class="token operator">|</span> ExtractCat<span class="token operator">&lt;</span>Shark<span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后它判断这些条件类型：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Cat</span> <span class="token operator">=</span> Lion <span class="token operator">|</span> <span class="token builtin">never</span> <span class="token operator">|</span> Tiger <span class="token operator">|</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接下来一些有趣的事情发生了，还记得没有值可以是 never 类型么？所以在联合类型中包含 never 是没有任何意义的，所以 TypeScript 抛弃了它：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Cat</span> <span class="token operator">=</span> Lion <span class="token operator">|</span> Tiger<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在 TypeScript 中，这种条件类型的用法被称为分发条件类型（distributive conditional type）。</p> <p>这种“分发”，也就是联合类型以递归方式展开，但是这是有限制的：只发生在 extends 关键字左侧是普通类型变量的时候。我们将在下一节看到这意味着什么以及如何突破这种限制。</p> <h2 id="分发条件类型的一个真实使用场景"><a href="#分发条件类型的一个真实使用场景" class="header-anchor">#</a> 分发条件类型的一个真实使用场景</h2> <p>前段时间我正在写一个 Chrome 插件，它有一个 <code>background</code> 脚本和一个 <code>view</code> 脚本，这两者运行在不同的执行上下文中。它们之间需要共享状态，唯一的途径就是通过可序列化消息传递机制。受 <code>Redux</code> 启发我定义了一个全局联合类型 <code>Action</code> 来作为可以在不同上下文中传递的消息的模型。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Action</span> <span class="token operator">=</span>
  <span class="token operator">|</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'INIT'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token operator">|</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'SYNC'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token operator">|</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'LOG_IN'</span><span class="token punctuation">;</span>

      emailAddress<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token operator">|</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'LOG_IN_SUCCESS'</span><span class="token punctuation">;</span>

      accessToken<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>还有一个全局的 <code>dispatch</code> 函数，通过这个函数就可以在不同的上下文广播消息。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token operator">:</span> Action<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'INIT'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'LOG_IN'</span><span class="token punctuation">,</span>

  emailAddress<span class="token operator">:</span> <span class="token string">'david.sheldrick@artsy.net'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'LOG_IN_SUCCESS'</span><span class="token punctuation">,</span>

  accessToken<span class="token operator">:</span> <span class="token string">'038fh239h923908h'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这个 API 是类型安全的，并且与我的 IDE 的自动补全功能配合的也很好，我完全可以到这里就结束了，然后去做别的事情。
但是总有个想法在我的脑海里挥之不去，我相信大多数开发者可能都会有这种想法。</p> <p>我希望可以像这样调用 <code>dispatch</code> 函数：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// first argument is the 'type'</span>

<span class="token comment">// second is any extra parameters</span>

<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'LOG_IN_SUCCESS'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  accessToken<span class="token operator">:</span> <span class="token string">'038fh239h923908h'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>派生第一个参数的类型很简单：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ActionType</span> <span class="token operator">=</span> Action<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// =&gt; &quot;INIT&quot; | &quot;SYNC&quot; | &quot;LOG_IN&quot; | &quot;LOG_IN_SUCCESS&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>但是第二个参数的类型是由第一个参数决定的，我们可以使用一个类型变量来对依赖进行建模：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">dispatch</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> ActionType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  type<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>

  args<span class="token operator">:</span> ExtractActionParameters<span class="token operator">&lt;</span>Action<span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>那么这里的 <code>ExtractActionParameters</code> 是什么东西呢？</p> <p>显然是一个条件类型！如下所示是第一次尝试实现 <code>ExtractActionParameters</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ExtractActionParameters<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">}</span> <span class="token operator">?</span> <span class="token constant">A</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这很像之前的 <code>ExtractCat</code> 那个例子，在那个例子里我们通过搜索是否具有 <code>meow()</code>来过滤 <code>Animals 联合类型</code>。在这里我们通过 <code>type</code> 属性来过滤 <code>Action 联合类型</code>。我们来看一下实际效果：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Test</span> <span class="token operator">=</span> ExtractActionParameters<span class="token operator">&lt;</span>Action<span class="token punctuation">,</span> <span class="token string">'LOG_IN'</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// =&gt; { type: &quot;LOG_IN&quot;, emailAddress: string }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>到这里已经差不多了，但是目前提取的结果还保留着 <code>type</code>，这就导致在调用 <code>dispatch</code> 还是需要再写一次 <code>type</code>，这和我们的初衷并不一致。</p> <p>我们可以通过组合使用条件类型和 <code>keyof</code> 操作符来实现一个<code>映射类型（mapped type）</code>，达到排除 <code>type</code> 属性的目的。</p> <p>映射类型允许你在一个键的联合类型上通过映射来创建一个新的类型</p> <ul><li>首先，可以使用 keyof 操作符获取一个已经存在的类型的所有键作为一个联合类型返回</li> <li>然后，可以使用条件类型来筛选这个键的联合类型返回一个筛选后的类型</li></ul> <p>接下来通过一个具体的例子演示一下如何实现：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ExcludeTypeKey<span class="token operator">&lt;</span><span class="token constant">K</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">K</span> <span class="token keyword">extends</span> <span class="token string">'type'</span> <span class="token operator">?</span> <span class="token builtin">never</span> <span class="token operator">:</span> <span class="token constant">K</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">Test</span> <span class="token operator">=</span> ExcludeTypeKey<span class="token operator">&lt;</span><span class="token string">'emailAddress'</span> <span class="token operator">|</span> <span class="token string">'type'</span> <span class="token operator">|</span> <span class="token string">'foo'</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// =&gt; &quot;emailAddress&quot; | &quot;foo&quot;</span>

<span class="token keyword">type</span> <span class="token class-name">ExcludeTypeField<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token constant">K</span> <span class="token keyword">in</span> ExcludeTypeKey<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">Test</span> <span class="token operator">=</span> ExcludeTypeField<span class="token operator">&lt;</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'LOG_IN'</span><span class="token punctuation">;</span> emailAddress<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// =&gt; { emailAddress: string }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>然后，我们就可以使用 <code>ExcludeTypeField</code> 来重新定义 <code>ExtractActionParameters</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ExtractActionParameters<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">}</span>
  <span class="token operator">?</span> ExcludeTypeField<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span>
  <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在，这个新版本的 <code>dispatch</code> 函数是类型安全的了：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// All clear! :)</span>

<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'LOG_IN_SUCCESS'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  accessToken<span class="token operator">:</span> <span class="token string">'038fh239h923908h'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'LOG_IN_SUCCESS'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// Type Error! :)</span>

  badKey<span class="token operator">:</span> <span class="token string">'038fh239h923908h'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Type Error! :)</span>

<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'BAD_TYPE'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  accessToken<span class="token operator">:</span> <span class="token string">'038fh239h923908h'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>还剩一个严重的问题需要处理，那就是如果一个 action 没有参数需要传递，但我还是需要写一个空对象作为 dispatch 函数的第二个参数。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'INIT'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这是一种可耻的浪费行为，告诉拜登今天晚上别等我打麻将了，我要修复这个问题，立刻！马上！！🤪</p> <p>可能我们会立即想到的一个做法是把第二个参数设置为可选的，但这会导致一个新的问题就是有参数的 action 如果不传递参数也会被允许，这就不满足类型安全了。</p> <p>更好的做法是定义一个 dispatch 函数的重载：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// And let's say that any actions that don't require</span>

<span class="token comment">// extra parameters are 'simple' actions.</span>

<span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>type<span class="token operator">:</span> SimpleActionType<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token comment">// this signature is just like before</span>

<span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">dispatch</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> ActionType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  type<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>

  args<span class="token operator">:</span> ExtractActionParameters<span class="token operator">&lt;</span>Action<span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">SimpleActionType</span> <span class="token operator">=</span> ExtractSimpleAction<span class="token operator">&lt;</span>Action<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>那么我们应该如何定义条件类型 <code>ExtractSimpleAction</code> 呢？我们知道如果把一个 <code>action</code> 类型的 <code>type</code> 字段去掉，返回的是一个空对象的话，那么这个 <code>action</code> 就是一个 <code>SimpleActionType</code>。按照这个思路我们似乎可以这么实现</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ExtractSimpleAction<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> ExcludeTypeField<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">?</span> <span class="token constant">A</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但是这样是达不到我们期望的效果的。因为 <code>ExcludeTypeField&lt;A&gt; extends {}</code>总是会返回 <code>true</code>。这是因为 <code>ExcludeTypeField&lt;A&gt;</code>的返回值不存在无法分配给<code>{}</code>的情况。</p> <p>既然这样，我们就交换两个参数的位置：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ExtractSimpleAction<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">extends</span> <span class="token class-name">ExcludeTypeField<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span></span> <span class="token operator">?</span> <span class="token constant">A</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在看起来如果 <code>ExcludeTypeField&lt;A&gt;</code>是空对象，那么就会走 <code>true</code> 分支，否则就会走 <code>false</code> 分支。</p> <p>你以为这就解决了？并没有。这个条件类型是不起作用的。也许有的读者还记得之前说过这段话：</p> <blockquote><p>这种“分发”，也就是联合类型以递归方式展开，只发生在 <code>extends</code> 关键字左侧是普通类型变量的时候</p></blockquote> <p>类型变量常常被定义在泛型参数列表中，被<code>&lt;</code>和<code>&gt;</code>包裹。例如：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>
<span class="token keyword">type</span> <span class="token class-name">Blah<span class="token operator">&lt;</span>These<span class="token punctuation">,</span> Are<span class="token punctuation">,</span> Type<span class="token punctuation">,</span> Variables<span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token operator">...</span>


<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">blah</span><span class="token generic class-name"><span class="token operator">&lt;</span>And<span class="token punctuation">,</span> So<span class="token punctuation">,</span> Are<span class="token punctuation">,</span> These<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token operator">...</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>如果你希望联合类型递归展开应用条件类型，那么这个联合类型需要：</p> <ul><li>绑定在一个类型变量上</li> <li>这个类型变量需要出现在 <code>extends</code> 关键字的左侧</li></ul> <p>如下所示是可以展开应用条件类型的例子：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Blah<span class="token operator">&lt;</span>Var<span class="token operator">&gt;</span></span> <span class="token operator">=</span> Var <span class="token keyword">extends</span> <span class="token class-name">Whatever</span> <span class="token operator">?</span> <span class="token constant">A</span> <span class="token operator">:</span> <span class="token constant">B</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这些就不可以：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Blah<span class="token operator">&lt;</span>Var<span class="token operator">&gt;</span></span> <span class="token operator">=</span> Foo<span class="token operator">&lt;</span>Var<span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">Whatever</span> <span class="token operator">?</span> <span class="token constant">A</span> <span class="token operator">:</span> <span class="token constant">B</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">Blah<span class="token operator">&lt;</span>Var<span class="token operator">&gt;</span></span> <span class="token operator">=</span> Whatever <span class="token keyword">extends</span> <span class="token class-name">Var</span> <span class="token operator">?</span> <span class="token constant">A</span> <span class="token operator">:</span> <span class="token constant">B</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>当我发现这个限制的时候，我认为我发现了一个分发条件类型在底层工作方式上的一个根本缺陷。我觉得这可能是对算法复杂度做的某种让步。我觉得可能是我的用例太高级了以至于 TypeScript 显得有些无能为力。
但事实证明我错了，这只是一个实用的语言设计来避免额外的语法，要解决也很简单：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ExtractSimpleAction<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">any</span></span>
  <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">extends</span> <span class="token class-name">ExcludeTypeField<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span></span>
    <span class="token operator">?</span> <span class="token constant">A</span>
    <span class="token operator">:</span> <span class="token builtin">never</span>
  <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如上所示，我们只是把我们的逻辑包裹在了一个额外的条件判断中，这个外层的条件类型会永远执行 true。</p> <p>最终，我们可以删除无用的多余代码了：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'INIT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>TypeScript 提供了一些我们可以在本节使用的内置类型：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// Exclude from U those types that are assignable to T</span>

<span class="token keyword">type</span> <span class="token class-name">Exclude<span class="token operator">&lt;</span><span class="token constant">U</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">U</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token constant">T</span></span> <span class="token operator">?</span> <span class="token builtin">never</span> <span class="token operator">:</span> <span class="token constant">U</span><span class="token punctuation">;</span>

<span class="token comment">// Extract from U those types that are assignable to T</span>

<span class="token keyword">type</span> <span class="token class-name">Extract<span class="token operator">&lt;</span><span class="token constant">U</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">U</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token constant">T</span></span> <span class="token operator">?</span> <span class="token constant">U</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>之前我们是这样实现 <code>ExcludeTypeField</code> 的：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ExcludeTypeField<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token constant">K</span> <span class="token keyword">in</span> ExcludeTypeKey<span class="token operator">&lt;</span><span class="token keyword">keyof</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在我们可以这样做：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ExcludeTypeField<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token constant">K</span> <span class="token keyword">in</span> Exclude<span class="token operator">&lt;</span><span class="token keyword">keyof</span> <span class="token constant">A</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>之前我们这样实现 <code>ExtractActionParameters</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ExtractActionParameters<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">}</span>
  <span class="token operator">?</span> ExcludeTypeField<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span>
  <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在我们可以这样实现：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">ExtractActionParameters<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> ExcludeTypeField<span class="token operator">&lt;</span>Extract<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">}</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="使用-infer-解构类型"><a href="#使用-infer-解构类型" class="header-anchor">#</a> 使用 infer 解构类型</h2> <p>条件类型还有另外一个关键字：<code>infer</code>。它可以在 <code>extends</code> 关键字右侧的类型表达式中的任何位置使用。使用它可以为出现在该位置的任何类型命名。例如：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Unpack<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token keyword">infer</span> <span class="token constant">E</span><span class="token operator">&gt;</span></span> <span class="token operator">?</span> <span class="token constant">E</span> <span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">Test</span> <span class="token operator">=</span> Unpack<span class="token operator">&lt;</span>Apple<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// =&gt; Apple</span>

<span class="token keyword">type</span> <span class="token class-name">Test</span> <span class="token operator">=</span> Unpack<span class="token operator">&lt;</span>Apple<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// =&gt; Apple</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>它可以优雅的处理歧义：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Stairs</span> <span class="token operator">=</span> Unpack<span class="token operator">&lt;</span>Apple<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> Pear<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// =&gt; Apple | Pear</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>你甚至可以多次使用 <code>infer</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">Flip<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token punctuation">[</span><span class="token keyword">infer</span> <span class="token constant">A</span><span class="token punctuation">,</span> <span class="token keyword">infer</span> <span class="token constant">B</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">Stairs</span> <span class="token operator">=</span> Flip<span class="token operator">&lt;</span><span class="token punctuation">[</span>Pear<span class="token punctuation">,</span> Apple<span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// =&gt; [Apple, Pear]</span>

<span class="token keyword">type</span> <span class="token class-name">Union<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token punctuation">[</span><span class="token keyword">infer</span> <span class="token constant">A</span><span class="token punctuation">,</span> <span class="token keyword">infer</span> <span class="token constant">A</span><span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token constant">A</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">Stairs</span> <span class="token operator">=</span> Union<span class="token operator">&lt;</span><span class="token punctuation">[</span>Apple<span class="token punctuation">,</span> Pear<span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// =&gt; Apple | Pear</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="其他的内置条件类型"><a href="#其他的内置条件类型" class="header-anchor">#</a> 其他的内置条件类型</h2> <p>我们已经看到了 Exclude 和 Extract，并且 TypeScript 提供了其他一些开箱即用的条件类型。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// Exclude null and undefined from T</span>

<span class="token keyword">type</span> <span class="token class-name">NonNullable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token keyword">null</span></span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token builtin">never</span> <span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>

<span class="token comment">// Obtain the parameters of a function type in a tuple</span>

<span class="token keyword">type</span> <span class="token class-name">Parameters<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token keyword">infer</span> <span class="token constant">P</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span> <span class="token operator">?</span> <span class="token constant">P</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>

<span class="token comment">// Obtain the parameters of a constructor function type in a tuple</span>

<span class="token keyword">type</span> <span class="token class-name">ConstructorParameters<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token keyword">new</span></span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token keyword">infer</span> <span class="token constant">P</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span>
  <span class="token operator">?</span> <span class="token constant">P</span>
  <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>

<span class="token comment">// Obtain the return type of a function type</span>

<span class="token keyword">type</span> <span class="token class-name">ReturnType<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">infer</span> <span class="token constant">R</span> <span class="token operator">?</span> <span class="token constant">R</span> <span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

<span class="token comment">// Obtain the return type of a constructor function type</span>

<span class="token keyword">type</span> <span class="token class-name">InstanceType<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token keyword">new</span></span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">infer</span> <span class="token constant">R</span> <span class="token operator">?</span> <span class="token constant">R</span> <span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/luvue/typescript/ts-collect/05-玩转TypeScript工具类型（下）.html" class="prev">05-玩转TypeScript工具类型（下）</a></span> <span class="next"><a href="/luvue/typescript/ts-collect/07-TypeScript内置工具.html">07-TypeScript内置工具</a>
      →
    </span></p></div> </main> <span data-v-2ae0ee72></span></div><div class="global-ui"></div></div>
    <script src="/luvue/assets/js/app.bd06d157.js" defer></script><script src="/luvue/assets/js/2.435f734b.js" defer></script><script src="/luvue/assets/js/3.116bd10d.js" defer></script><script src="/luvue/assets/js/113.a4f19600.js" defer></script>
  </body>
</html>
