<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3 响应式原理 | Ailjc notes</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel=" " href=" ">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/luvue/assets/css/0.styles.0c275c11.css" as="style"><link rel="preload" href="/luvue/assets/js/app.24d3cb9c.js" as="script"><link rel="preload" href="/luvue/assets/js/2.7e9a2be9.js" as="script"><link rel="preload" href="/luvue/assets/js/3.92ecc592.js" as="script"><link rel="preload" href="/luvue/assets/js/232.df938b18.js" as="script"><link rel="prefetch" href="/luvue/assets/js/10.fefd87d0.js"><link rel="prefetch" href="/luvue/assets/js/100.19a916cd.js"><link rel="prefetch" href="/luvue/assets/js/101.15e09ebc.js"><link rel="prefetch" href="/luvue/assets/js/102.8c2aa751.js"><link rel="prefetch" href="/luvue/assets/js/103.80aaf15e.js"><link rel="prefetch" href="/luvue/assets/js/104.4b17369d.js"><link rel="prefetch" href="/luvue/assets/js/105.e3b99d7f.js"><link rel="prefetch" href="/luvue/assets/js/106.6cb53770.js"><link rel="prefetch" href="/luvue/assets/js/107.0faf8906.js"><link rel="prefetch" href="/luvue/assets/js/108.695346d6.js"><link rel="prefetch" href="/luvue/assets/js/109.438c6b2e.js"><link rel="prefetch" href="/luvue/assets/js/11.141d84f1.js"><link rel="prefetch" href="/luvue/assets/js/110.6ffb0399.js"><link rel="prefetch" href="/luvue/assets/js/111.61fd8319.js"><link rel="prefetch" href="/luvue/assets/js/112.9998d3be.js"><link rel="prefetch" href="/luvue/assets/js/113.89ee7c2f.js"><link rel="prefetch" href="/luvue/assets/js/114.b21dd215.js"><link rel="prefetch" href="/luvue/assets/js/115.e5ecdcf4.js"><link rel="prefetch" href="/luvue/assets/js/116.5ca6e10a.js"><link rel="prefetch" href="/luvue/assets/js/117.44d630a9.js"><link rel="prefetch" href="/luvue/assets/js/118.3a710062.js"><link rel="prefetch" href="/luvue/assets/js/119.00b1d4d9.js"><link rel="prefetch" href="/luvue/assets/js/12.2730a5bc.js"><link rel="prefetch" href="/luvue/assets/js/120.f785e761.js"><link rel="prefetch" href="/luvue/assets/js/121.021c6306.js"><link rel="prefetch" href="/luvue/assets/js/122.e0bf3cfc.js"><link rel="prefetch" href="/luvue/assets/js/123.01466def.js"><link rel="prefetch" href="/luvue/assets/js/124.2dcfea2f.js"><link rel="prefetch" href="/luvue/assets/js/125.41167849.js"><link rel="prefetch" href="/luvue/assets/js/126.5d739372.js"><link rel="prefetch" href="/luvue/assets/js/127.f56f652e.js"><link rel="prefetch" href="/luvue/assets/js/128.40b9b278.js"><link rel="prefetch" href="/luvue/assets/js/129.207137ba.js"><link rel="prefetch" href="/luvue/assets/js/13.60de938c.js"><link rel="prefetch" href="/luvue/assets/js/130.db104c86.js"><link rel="prefetch" href="/luvue/assets/js/131.2c9e9b26.js"><link rel="prefetch" href="/luvue/assets/js/132.d3d980cb.js"><link rel="prefetch" href="/luvue/assets/js/133.aa1a804e.js"><link rel="prefetch" href="/luvue/assets/js/134.231966e7.js"><link rel="prefetch" href="/luvue/assets/js/135.2dbcd9a0.js"><link rel="prefetch" href="/luvue/assets/js/136.919530da.js"><link rel="prefetch" href="/luvue/assets/js/137.c703c0a8.js"><link rel="prefetch" href="/luvue/assets/js/138.d0fbe76a.js"><link rel="prefetch" href="/luvue/assets/js/139.d6ceef15.js"><link rel="prefetch" href="/luvue/assets/js/14.1bd46c2e.js"><link rel="prefetch" href="/luvue/assets/js/140.5ed92165.js"><link rel="prefetch" href="/luvue/assets/js/141.916b71f0.js"><link rel="prefetch" href="/luvue/assets/js/142.27fd2bd5.js"><link rel="prefetch" href="/luvue/assets/js/143.6ada4af5.js"><link rel="prefetch" href="/luvue/assets/js/144.bd6f10eb.js"><link rel="prefetch" href="/luvue/assets/js/145.10c93542.js"><link rel="prefetch" href="/luvue/assets/js/146.038104a3.js"><link rel="prefetch" href="/luvue/assets/js/147.ef6ffd68.js"><link rel="prefetch" href="/luvue/assets/js/148.7d62ecb5.js"><link rel="prefetch" href="/luvue/assets/js/149.ae6c8e49.js"><link rel="prefetch" href="/luvue/assets/js/15.8a053615.js"><link rel="prefetch" href="/luvue/assets/js/150.5350b1a8.js"><link rel="prefetch" href="/luvue/assets/js/151.1f9fee8b.js"><link rel="prefetch" href="/luvue/assets/js/152.e6e676be.js"><link rel="prefetch" href="/luvue/assets/js/153.068ed172.js"><link rel="prefetch" href="/luvue/assets/js/154.3c4d0eb6.js"><link rel="prefetch" href="/luvue/assets/js/155.f99df381.js"><link rel="prefetch" href="/luvue/assets/js/156.537a2efd.js"><link rel="prefetch" href="/luvue/assets/js/157.0acfc338.js"><link rel="prefetch" href="/luvue/assets/js/158.26d3338f.js"><link rel="prefetch" href="/luvue/assets/js/159.6f1cc4e1.js"><link rel="prefetch" href="/luvue/assets/js/16.7f7a3ee8.js"><link rel="prefetch" href="/luvue/assets/js/160.5bd2b3df.js"><link rel="prefetch" href="/luvue/assets/js/161.f50a7be4.js"><link rel="prefetch" href="/luvue/assets/js/162.4846c312.js"><link rel="prefetch" href="/luvue/assets/js/163.3d6f75ae.js"><link rel="prefetch" href="/luvue/assets/js/164.cf7094e1.js"><link rel="prefetch" href="/luvue/assets/js/165.b084c14e.js"><link rel="prefetch" href="/luvue/assets/js/166.d91162ba.js"><link rel="prefetch" href="/luvue/assets/js/167.69358e95.js"><link rel="prefetch" href="/luvue/assets/js/168.0b12410a.js"><link rel="prefetch" href="/luvue/assets/js/169.91d22f58.js"><link rel="prefetch" href="/luvue/assets/js/17.6a766300.js"><link rel="prefetch" href="/luvue/assets/js/170.c3c7e2cd.js"><link rel="prefetch" href="/luvue/assets/js/171.33dd8106.js"><link rel="prefetch" href="/luvue/assets/js/172.af5c5706.js"><link rel="prefetch" href="/luvue/assets/js/173.5d6b421f.js"><link rel="prefetch" href="/luvue/assets/js/174.6c53f57e.js"><link rel="prefetch" href="/luvue/assets/js/175.737dc55c.js"><link rel="prefetch" href="/luvue/assets/js/176.55b0940c.js"><link rel="prefetch" href="/luvue/assets/js/177.c88610d7.js"><link rel="prefetch" href="/luvue/assets/js/178.5858fe0b.js"><link rel="prefetch" href="/luvue/assets/js/179.9125a0ca.js"><link rel="prefetch" href="/luvue/assets/js/18.ceac0c46.js"><link rel="prefetch" href="/luvue/assets/js/180.3e38599d.js"><link rel="prefetch" href="/luvue/assets/js/181.25c2e254.js"><link rel="prefetch" href="/luvue/assets/js/182.80fa8809.js"><link rel="prefetch" href="/luvue/assets/js/183.da1b5a2b.js"><link rel="prefetch" href="/luvue/assets/js/184.acba5e76.js"><link rel="prefetch" href="/luvue/assets/js/185.eaf51d55.js"><link rel="prefetch" href="/luvue/assets/js/186.8de639f8.js"><link rel="prefetch" href="/luvue/assets/js/187.a02bfc44.js"><link rel="prefetch" href="/luvue/assets/js/188.5f5aac79.js"><link rel="prefetch" href="/luvue/assets/js/189.5e8eaa5e.js"><link rel="prefetch" href="/luvue/assets/js/19.82af8a5d.js"><link rel="prefetch" href="/luvue/assets/js/190.6e3dd61d.js"><link rel="prefetch" href="/luvue/assets/js/191.ff42b9b7.js"><link rel="prefetch" href="/luvue/assets/js/192.133d06c7.js"><link rel="prefetch" href="/luvue/assets/js/193.64fba768.js"><link rel="prefetch" href="/luvue/assets/js/194.660335c7.js"><link rel="prefetch" href="/luvue/assets/js/195.9f6cae6d.js"><link rel="prefetch" href="/luvue/assets/js/196.586e8911.js"><link rel="prefetch" href="/luvue/assets/js/197.9c1be23d.js"><link rel="prefetch" href="/luvue/assets/js/198.95b7d4ed.js"><link rel="prefetch" href="/luvue/assets/js/199.3844e818.js"><link rel="prefetch" href="/luvue/assets/js/20.c59106ba.js"><link rel="prefetch" href="/luvue/assets/js/200.ef447f95.js"><link rel="prefetch" href="/luvue/assets/js/201.10481b4c.js"><link rel="prefetch" href="/luvue/assets/js/202.8b3925fe.js"><link rel="prefetch" href="/luvue/assets/js/203.8e740ff3.js"><link rel="prefetch" href="/luvue/assets/js/204.10e0ff19.js"><link rel="prefetch" href="/luvue/assets/js/205.aa8b64c3.js"><link rel="prefetch" href="/luvue/assets/js/206.5cadd5e0.js"><link rel="prefetch" href="/luvue/assets/js/207.1c3fb502.js"><link rel="prefetch" href="/luvue/assets/js/208.37e57586.js"><link rel="prefetch" href="/luvue/assets/js/209.b251f57c.js"><link rel="prefetch" href="/luvue/assets/js/21.dbcb08ca.js"><link rel="prefetch" href="/luvue/assets/js/210.f4c69350.js"><link rel="prefetch" href="/luvue/assets/js/211.a60ef32b.js"><link rel="prefetch" href="/luvue/assets/js/212.5df085a0.js"><link rel="prefetch" href="/luvue/assets/js/213.6cca02ed.js"><link rel="prefetch" href="/luvue/assets/js/214.e437f7ba.js"><link rel="prefetch" href="/luvue/assets/js/215.9731e93e.js"><link rel="prefetch" href="/luvue/assets/js/216.be0f0876.js"><link rel="prefetch" href="/luvue/assets/js/217.36c30f83.js"><link rel="prefetch" href="/luvue/assets/js/218.680c6053.js"><link rel="prefetch" href="/luvue/assets/js/219.d01d0032.js"><link rel="prefetch" href="/luvue/assets/js/22.6382f403.js"><link rel="prefetch" href="/luvue/assets/js/220.5ca1be98.js"><link rel="prefetch" href="/luvue/assets/js/221.a6371702.js"><link rel="prefetch" href="/luvue/assets/js/222.db815fbb.js"><link rel="prefetch" href="/luvue/assets/js/223.db9037a7.js"><link rel="prefetch" href="/luvue/assets/js/224.23cd9e02.js"><link rel="prefetch" href="/luvue/assets/js/225.45220dd3.js"><link rel="prefetch" href="/luvue/assets/js/226.0b9b7a79.js"><link rel="prefetch" href="/luvue/assets/js/227.0eaaaaf4.js"><link rel="prefetch" href="/luvue/assets/js/228.382e9e0e.js"><link rel="prefetch" href="/luvue/assets/js/229.3ae1b558.js"><link rel="prefetch" href="/luvue/assets/js/23.c6b6dae9.js"><link rel="prefetch" href="/luvue/assets/js/230.d4487ee4.js"><link rel="prefetch" href="/luvue/assets/js/231.f2163054.js"><link rel="prefetch" href="/luvue/assets/js/233.9330e97c.js"><link rel="prefetch" href="/luvue/assets/js/234.cc4ebd06.js"><link rel="prefetch" href="/luvue/assets/js/235.a222b8e0.js"><link rel="prefetch" href="/luvue/assets/js/236.25768542.js"><link rel="prefetch" href="/luvue/assets/js/237.38e66e45.js"><link rel="prefetch" href="/luvue/assets/js/238.55b39563.js"><link rel="prefetch" href="/luvue/assets/js/239.ae76877e.js"><link rel="prefetch" href="/luvue/assets/js/24.d1d8ef7c.js"><link rel="prefetch" href="/luvue/assets/js/240.924c3283.js"><link rel="prefetch" href="/luvue/assets/js/241.bcfcb6f8.js"><link rel="prefetch" href="/luvue/assets/js/242.7221bb51.js"><link rel="prefetch" href="/luvue/assets/js/243.19be8d64.js"><link rel="prefetch" href="/luvue/assets/js/244.b0ab537d.js"><link rel="prefetch" href="/luvue/assets/js/245.c9903538.js"><link rel="prefetch" href="/luvue/assets/js/246.7c7b2b9c.js"><link rel="prefetch" href="/luvue/assets/js/247.773b9f34.js"><link rel="prefetch" href="/luvue/assets/js/248.094da9b6.js"><link rel="prefetch" href="/luvue/assets/js/249.2c6cf0c1.js"><link rel="prefetch" href="/luvue/assets/js/25.541ff376.js"><link rel="prefetch" href="/luvue/assets/js/250.fb1d17fd.js"><link rel="prefetch" href="/luvue/assets/js/251.fcc04c86.js"><link rel="prefetch" href="/luvue/assets/js/252.3a8d2b0b.js"><link rel="prefetch" href="/luvue/assets/js/253.6225bd1a.js"><link rel="prefetch" href="/luvue/assets/js/254.9d4efc27.js"><link rel="prefetch" href="/luvue/assets/js/255.84f219e2.js"><link rel="prefetch" href="/luvue/assets/js/256.dce304d6.js"><link rel="prefetch" href="/luvue/assets/js/257.597148bd.js"><link rel="prefetch" href="/luvue/assets/js/258.86361cde.js"><link rel="prefetch" href="/luvue/assets/js/259.f963bf59.js"><link rel="prefetch" href="/luvue/assets/js/26.aa800826.js"><link rel="prefetch" href="/luvue/assets/js/260.3a2b7c24.js"><link rel="prefetch" href="/luvue/assets/js/261.8b31c343.js"><link rel="prefetch" href="/luvue/assets/js/262.9bc9b4ed.js"><link rel="prefetch" href="/luvue/assets/js/263.cf027585.js"><link rel="prefetch" href="/luvue/assets/js/264.fdd59d42.js"><link rel="prefetch" href="/luvue/assets/js/265.92a6c3e1.js"><link rel="prefetch" href="/luvue/assets/js/266.6dff3d79.js"><link rel="prefetch" href="/luvue/assets/js/267.748610ba.js"><link rel="prefetch" href="/luvue/assets/js/268.7403658e.js"><link rel="prefetch" href="/luvue/assets/js/269.b06f9631.js"><link rel="prefetch" href="/luvue/assets/js/27.234a1646.js"><link rel="prefetch" href="/luvue/assets/js/270.7b4756b5.js"><link rel="prefetch" href="/luvue/assets/js/271.555a52f0.js"><link rel="prefetch" href="/luvue/assets/js/272.d7885b5c.js"><link rel="prefetch" href="/luvue/assets/js/273.f2233d66.js"><link rel="prefetch" href="/luvue/assets/js/274.723b3e19.js"><link rel="prefetch" href="/luvue/assets/js/275.4048adb4.js"><link rel="prefetch" href="/luvue/assets/js/276.2f1e1578.js"><link rel="prefetch" href="/luvue/assets/js/277.cbba2bac.js"><link rel="prefetch" href="/luvue/assets/js/278.53995e86.js"><link rel="prefetch" href="/luvue/assets/js/279.4f6ccf8b.js"><link rel="prefetch" href="/luvue/assets/js/28.f5cb3cd0.js"><link rel="prefetch" href="/luvue/assets/js/280.673b10f1.js"><link rel="prefetch" href="/luvue/assets/js/281.c68eaa9d.js"><link rel="prefetch" href="/luvue/assets/js/282.daf11127.js"><link rel="prefetch" href="/luvue/assets/js/283.f9098504.js"><link rel="prefetch" href="/luvue/assets/js/284.6e81376b.js"><link rel="prefetch" href="/luvue/assets/js/285.0886b889.js"><link rel="prefetch" href="/luvue/assets/js/286.fac16ac5.js"><link rel="prefetch" href="/luvue/assets/js/287.06875def.js"><link rel="prefetch" href="/luvue/assets/js/288.f1c3ab86.js"><link rel="prefetch" href="/luvue/assets/js/289.5fa60820.js"><link rel="prefetch" href="/luvue/assets/js/29.d66372db.js"><link rel="prefetch" href="/luvue/assets/js/290.30e32d07.js"><link rel="prefetch" href="/luvue/assets/js/291.ba2fabdb.js"><link rel="prefetch" href="/luvue/assets/js/292.1e88c8f2.js"><link rel="prefetch" href="/luvue/assets/js/293.46d9f2af.js"><link rel="prefetch" href="/luvue/assets/js/294.9e9e9a97.js"><link rel="prefetch" href="/luvue/assets/js/295.51089eeb.js"><link rel="prefetch" href="/luvue/assets/js/296.e3aa873c.js"><link rel="prefetch" href="/luvue/assets/js/297.80bbdcce.js"><link rel="prefetch" href="/luvue/assets/js/298.5a37e3df.js"><link rel="prefetch" href="/luvue/assets/js/299.6cc42bda.js"><link rel="prefetch" href="/luvue/assets/js/30.dc058ead.js"><link rel="prefetch" href="/luvue/assets/js/300.607335b0.js"><link rel="prefetch" href="/luvue/assets/js/301.395651cb.js"><link rel="prefetch" href="/luvue/assets/js/302.4d29a7f4.js"><link rel="prefetch" href="/luvue/assets/js/31.023e058b.js"><link rel="prefetch" href="/luvue/assets/js/32.c38eba45.js"><link rel="prefetch" href="/luvue/assets/js/33.96ae807e.js"><link rel="prefetch" href="/luvue/assets/js/34.e0ca9d9d.js"><link rel="prefetch" href="/luvue/assets/js/35.1ef08ee2.js"><link rel="prefetch" href="/luvue/assets/js/36.9f317212.js"><link rel="prefetch" href="/luvue/assets/js/37.4edf1dd8.js"><link rel="prefetch" href="/luvue/assets/js/38.16c29e38.js"><link rel="prefetch" href="/luvue/assets/js/39.2a932be2.js"><link rel="prefetch" href="/luvue/assets/js/4.0b4fc096.js"><link rel="prefetch" href="/luvue/assets/js/40.82cb02c3.js"><link rel="prefetch" href="/luvue/assets/js/41.12394088.js"><link rel="prefetch" href="/luvue/assets/js/42.d2fa2e92.js"><link rel="prefetch" href="/luvue/assets/js/43.1cb4fd05.js"><link rel="prefetch" href="/luvue/assets/js/44.66674ed7.js"><link rel="prefetch" href="/luvue/assets/js/45.eb01a397.js"><link rel="prefetch" href="/luvue/assets/js/46.c87680a3.js"><link rel="prefetch" href="/luvue/assets/js/47.3b88dbdc.js"><link rel="prefetch" href="/luvue/assets/js/48.f9343fda.js"><link rel="prefetch" href="/luvue/assets/js/49.ac55888f.js"><link rel="prefetch" href="/luvue/assets/js/5.768ccd03.js"><link rel="prefetch" href="/luvue/assets/js/50.f7b99ab4.js"><link rel="prefetch" href="/luvue/assets/js/51.adbf4796.js"><link rel="prefetch" href="/luvue/assets/js/52.2f534912.js"><link rel="prefetch" href="/luvue/assets/js/53.cc8c809f.js"><link rel="prefetch" href="/luvue/assets/js/54.386d731a.js"><link rel="prefetch" href="/luvue/assets/js/55.3f6022b7.js"><link rel="prefetch" href="/luvue/assets/js/56.a651fa0f.js"><link rel="prefetch" href="/luvue/assets/js/57.e4dcd280.js"><link rel="prefetch" href="/luvue/assets/js/58.ccf3ec02.js"><link rel="prefetch" href="/luvue/assets/js/59.b9647de8.js"><link rel="prefetch" href="/luvue/assets/js/6.ac3e0798.js"><link rel="prefetch" href="/luvue/assets/js/60.93806c99.js"><link rel="prefetch" href="/luvue/assets/js/61.89498686.js"><link rel="prefetch" href="/luvue/assets/js/62.15faac6d.js"><link rel="prefetch" href="/luvue/assets/js/63.9d855c5d.js"><link rel="prefetch" href="/luvue/assets/js/64.ba1547e2.js"><link rel="prefetch" href="/luvue/assets/js/65.90372937.js"><link rel="prefetch" href="/luvue/assets/js/66.42c645cb.js"><link rel="prefetch" href="/luvue/assets/js/67.fc7bf953.js"><link rel="prefetch" href="/luvue/assets/js/68.b048c6f4.js"><link rel="prefetch" href="/luvue/assets/js/69.cd1ca1b0.js"><link rel="prefetch" href="/luvue/assets/js/7.0c495c55.js"><link rel="prefetch" href="/luvue/assets/js/70.de796229.js"><link rel="prefetch" href="/luvue/assets/js/71.79fbccd7.js"><link rel="prefetch" href="/luvue/assets/js/72.ef920547.js"><link rel="prefetch" href="/luvue/assets/js/73.7aad1269.js"><link rel="prefetch" href="/luvue/assets/js/74.70e82141.js"><link rel="prefetch" href="/luvue/assets/js/75.7c695c09.js"><link rel="prefetch" href="/luvue/assets/js/76.ebb5ed1a.js"><link rel="prefetch" href="/luvue/assets/js/77.1b4696ba.js"><link rel="prefetch" href="/luvue/assets/js/78.17fbd9e8.js"><link rel="prefetch" href="/luvue/assets/js/79.347e97c2.js"><link rel="prefetch" href="/luvue/assets/js/8.3505ba5a.js"><link rel="prefetch" href="/luvue/assets/js/80.a68ac880.js"><link rel="prefetch" href="/luvue/assets/js/81.29697f3f.js"><link rel="prefetch" href="/luvue/assets/js/82.19ca69f9.js"><link rel="prefetch" href="/luvue/assets/js/83.46ead34f.js"><link rel="prefetch" href="/luvue/assets/js/84.e67d55b4.js"><link rel="prefetch" href="/luvue/assets/js/85.9d228e88.js"><link rel="prefetch" href="/luvue/assets/js/86.43b52482.js"><link rel="prefetch" href="/luvue/assets/js/87.a3a73d27.js"><link rel="prefetch" href="/luvue/assets/js/88.f1caa267.js"><link rel="prefetch" href="/luvue/assets/js/89.1e0c098e.js"><link rel="prefetch" href="/luvue/assets/js/9.65549bfc.js"><link rel="prefetch" href="/luvue/assets/js/90.814a1362.js"><link rel="prefetch" href="/luvue/assets/js/91.604291e4.js"><link rel="prefetch" href="/luvue/assets/js/92.f66726d9.js"><link rel="prefetch" href="/luvue/assets/js/93.46431418.js"><link rel="prefetch" href="/luvue/assets/js/94.c9f65d27.js"><link rel="prefetch" href="/luvue/assets/js/95.9217bd28.js"><link rel="prefetch" href="/luvue/assets/js/96.72450da7.js"><link rel="prefetch" href="/luvue/assets/js/97.1e48a1d5.js"><link rel="prefetch" href="/luvue/assets/js/98.b5889720.js"><link rel="prefetch" href="/luvue/assets/js/99.2635376c.js">
    <link rel="stylesheet" href="/luvue/assets/css/0.styles.0c275c11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/luvue/" class="home-link router-link-active"><!----> <span class="site-name">Ailjc notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link router-link-active">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link">工程化</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link router-link-active">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link">工程化</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vue3/手写原理/" class="sidebar-heading clickable"><span>手写原理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vue3/收集/" class="sidebar-heading clickable open"><span>收集</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/luvue/vue3/收集/01-Vue3设计思想.html" class="sidebar-link">01-Vue3设计思想</a></li><li><a href="/luvue/vue3/收集/01-响应式.html" class="sidebar-link">01-响应式</a></li><li><a href="/luvue/vue3/收集/02-Vue3架构介绍.html" class="sidebar-link">02-Vue3架构介绍</a></li><li><a href="/luvue/vue3/收集/03-Vue3开发环境搭建.html" class="sidebar-link">03-Vue3开发环境搭建</a></li><li><a href="/luvue/vue3/收集/04-Vue3响应式原理.html" class="active sidebar-link">04-Vue3响应式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/vue3/收集/04-Vue3响应式原理.html#vue3-对比-vue2-的变化" class="sidebar-link">Vue3 对比 Vue2 的变化</a></li><li class="sidebar-sub-header"><a href="/luvue/vue3/收集/04-Vue3响应式原理.html#compositionapi" class="sidebar-link">CompositionAPI</a></li><li class="sidebar-sub-header"><a href="/luvue/vue3/收集/04-Vue3响应式原理.html#reactivity-模块基本使用" class="sidebar-link">Reactivity 模块基本使用</a></li><li class="sidebar-sub-header"><a href="/luvue/vue3/收集/04-Vue3响应式原理.html#编写-reactive-函数" class="sidebar-link">编写 reactive 函数</a></li><li class="sidebar-sub-header"><a href="/luvue/vue3/收集/04-Vue3响应式原理.html#编写-effect-函数" class="sidebar-link">编写 effect 函数</a></li><li class="sidebar-sub-header"><a href="/luvue/vue3/收集/04-Vue3响应式原理.html#依赖收集" class="sidebar-link">依赖收集</a></li><li class="sidebar-sub-header"><a href="/luvue/vue3/收集/04-Vue3响应式原理.html#触发更新" class="sidebar-link">触发更新</a></li><li class="sidebar-sub-header"><a href="/luvue/vue3/收集/04-Vue3响应式原理.html#分支切换与-cleanup" class="sidebar-link">分支切换与 cleanup</a></li><li class="sidebar-sub-header"><a href="/luvue/vue3/收集/04-Vue3响应式原理.html#停止-effect" class="sidebar-link">停止 effect</a></li><li class="sidebar-sub-header"><a href="/luvue/vue3/收集/04-Vue3响应式原理.html#调度执行" class="sidebar-link">调度执行</a></li><li class="sidebar-sub-header"><a href="/luvue/vue3/收集/04-Vue3响应式原理.html#深度代理" class="sidebar-link">深度代理</a></li></ul></li><li><a href="/luvue/vue3/收集/05-Computed &amp; Watch.html" class="sidebar-link">05-Computed &amp; Watch</a></li><li><a href="/luvue/vue3/收集/06-Ref实现原理.html" class="sidebar-link">06-Ref实现原理</a></li><li><a href="/luvue/vue3/收集/07-Vue3渲染原理.html" class="sidebar-link">07-Vue3渲染原理</a></li><li><a href="/luvue/vue3/收集/08-Vue3Diff算法.html" class="sidebar-link">08-Vue3Diff算法</a></li><li><a href="/luvue/vue3/收集/09-组件渲染原理.html" class="sidebar-link">09-组件渲染原理</a></li><li><a href="/luvue/vue3/收集/10-编译优化.html" class="sidebar-link">10-编译优化</a></li><li><a href="/luvue/vue3/收集/11-模板编译原理.html" class="sidebar-link">11-模板编译原理</a></li><li><a href="/luvue/vue3/收集/12-异步组件实现原理.html" class="sidebar-link">12-异步组件实现原理</a></li><li><a href="/luvue/vue3/收集/13-函数式组件&amp;Teleport实现原理.html" class="sidebar-link">13-函数式组件&amp;Teleport实现原理</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vue3/源码分析/" class="sidebar-heading clickable"><span>源码分析</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue3-响应式原理"><a href="#vue3-响应式原理" class="header-anchor">#</a> Vue3 响应式原理</h1> <p></p><div class="table-of-contents"><ul><li><a href="#vue3-对比-vue2-的变化">Vue3 对比 Vue2 的变化</a></li><li><a href="#compositionapi">CompositionAPI</a></li><li><a href="#reactivity-模块基本使用">Reactivity 模块基本使用</a></li><li><a href="#编写-reactive-函数">编写 reactive 函数</a></li><li><a href="#编写-effect-函数">编写 effect 函数</a></li><li><a href="#依赖收集">依赖收集</a></li><li><a href="#触发更新">触发更新</a></li><li><a href="#分支切换与-cleanup">分支切换与 cleanup</a></li><li><a href="#停止-effect">停止 effect</a></li><li><a href="#调度执行">调度执行</a></li><li><a href="#深度代理">深度代理</a></li></ul></div><p></p> <h2 id="vue3-对比-vue2-的变化"><a href="#vue3-对比-vue2-的变化" class="header-anchor">#</a> Vue3 对比 Vue2 的变化</h2> <ul><li>在 Vue2 的时候使用 <code>defineProperty</code> 来进行数据的劫持, 需要对属性进行重写添加 <code>getter</code> 及 <code>setter</code> <strong>性能差</strong>。</li> <li>当新增属性和删除属性时无法监控变化。需要通过<code>$set</code>、<code>$delete</code> 实现</li> <li>数组不采用 defineProperty 来进行劫持 （浪费性能，对所有索引进行劫持会造成性能浪费）需要对数组单独进行处理</li></ul> <p>Vue3 中使用 <code>Proxy</code> 来实现响应式数据变化。从而解决了上述问题。</p> <h2 id="compositionapi"><a href="#compositionapi" class="header-anchor">#</a> CompositionAPI</h2> <ul><li>在 Vue2 中采用的是 <code>OptionsAPI</code>, 用户提供的 <code>data</code>,<code>props</code>,<code>methods</code>,<code>computed</code>,<code>watch</code> 等属性 (用户编写复杂业务逻辑会出现反复横跳问题)</li> <li>Vue2 中所有的属性都是通过 <code>this</code> 访问，<code>this</code> 存在指向明确问题</li> <li>Vue2 中很多未使用方法或属性依旧会被打包，并且所有全局 API 都在 Vue 对象上公开。<code>Composition API</code> 对 <code>tree-shaking</code> 更加友好，代码也更容易压缩。</li> <li>组件逻辑共享问题， Vue2 采用 mixins 实现组件之间的逻辑共享； 但是会有数据来源不明确，命名冲突等问题。 Vue3 采用 CompositionAPI 提取公共逻辑非常方便</li></ul> <p>简单的组件仍然可以采用 <code>OptionsAPI</code> 进行编写，<code>compositionAPI</code> 在复杂的逻辑中有着明显的优势~。 <code>reactivity</code> 模块中就包含了很多我们经常使用到的 API 例如：<code>computed</code>、<code>reactive</code>、<code>ref</code>、<code>effect</code> 等</p> <h2 id="reactivity-模块基本使用"><a href="#reactivity-模块基本使用" class="header-anchor">#</a> Reactivity 模块基本使用</h2> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./reactivity.global.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> shallowReactive<span class="token punctuation">,</span> shallowReadonly<span class="token punctuation">,</span> readonly <span class="token punctuation">}</span> <span class="token operator">=</span> VueReactivity<span class="token punctuation">;</span>
  <span class="token comment">// let state = reactive({ name: 'jw', age: 30 });</span>
  <span class="token comment">// const state = shallowReactive({ name: 'jw', age: 30 })</span>
  <span class="token comment">// const state = readonly({ name: 'jw', age: 30 })</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jw'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 副作用函数 (effect执行渲染了页面)</span>
    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'今年'</span> <span class="token operator">+</span> state<span class="token punctuation">.</span>age <span class="token operator">+</span> <span class="token string">'岁了'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>age<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p><code>reactive</code> 方法会将对象变成 <code>proxy</code> 对象， <code>effect</code> 中使用 <code>reactive</code> 对象时会进行依赖收集，稍后属性变化时会重新执行 <code>effect</code> 函数~。</p></blockquote> <h2 id="编写-reactive-函数"><a href="#编写-reactive-函数" class="header-anchor">#</a> 编写 reactive 函数</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> isObject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/shared'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> object<span class="token punctuation">,</span> <span class="token literal-property property">isReadonly</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 常用的就是reactive方法</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 后面的方法，不是重点我们先不进行实现...</span>
<span class="token comment">/*
export function shallowReactive(target: object) {
    return createReactiveObject(target, false)
}
export function readonly(target: object) {
    return createReactiveObject(target, true)
}
export function shallowReadonly(target: object) {
    return createReactiveObject(target, true)
}
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">value</span><span class="token operator">:</span> unknown</span><span class="token punctuation">)</span> <span class="token operator">:</span> value is Record<span class="token operator">&lt;</span>any<span class="token punctuation">,</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>由此可知这些方法接受的参数必须是一个对象类型。否则没有任何效果</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 缓存列表</span>
<span class="token keyword">const</span> <span class="token literal-property property">mutableHandlers</span><span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 等会谁来取值就做依赖收集</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 等会赋值的时候可以重新触发effect执行</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> object<span class="token punctuation">,</span> <span class="token literal-property property">isReadonly</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> exisitingProxy <span class="token operator">=</span> reactiveMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果已经代理过则直接返回代理后的对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exisitingProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> exisitingProxy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> mutableHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对对象进行代理</span>
  reactiveMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><blockquote><p>这里必须要使用 <code>Reflect</code> 进行操作，保证 <code>this</code> 指向永远指向代理对象</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> school <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'zf'</span><span class="token punctuation">,</span>
  <span class="token keyword">get</span> <span class="token function">num</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>school<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// return Reflect.get(target,key,receiver)</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span>num<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p>将对象使用 proxy 进行代理，如果对象已经被代理过，再次重复代理则返回上次代理结果。 那么，如果将一个代理对象传入呢？</p></blockquote> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token keyword">enum</span> ReactiveFlags <span class="token punctuation">{</span>
  <span class="token constant">IS_REACTIVE</span> <span class="token operator">=</span> <span class="token string">'__v_isReactive'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> mutableHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 在get中增加标识，当获取IS_REACTIVE时返回true</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>target<span class="token operator">:</span> object<span class="token punctuation">,</span> isReadonly<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在创建响应式对象时先进行取值，看是否已经是响应式对象</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><blockquote><p>这样我们防止重复代理就做好了~~~， 其实这里的逻辑相比 Vue2 真的是简单太多了。</p></blockquote> <h2 id="编写-effect-函数"><a href="#编写-effect-函数" class="header-anchor">#</a> 编写 effect 函数</h2> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">let</span> activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// 当前正在执行的effect</span>

<span class="token keyword">class</span> <span class="token class-name">ReactiveEffect</span> <span class="token punctuation">{</span>
  active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 收集effect中使用到的属性</span>
  parent <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">public</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 不是激活状态</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> activeEffect<span class="token punctuation">;</span> <span class="token comment">// 当前的effect就是他的父亲</span>
      activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// 设置成正在激活的是当前effect</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">;</span> <span class="token comment">// 执行完毕后还原activeEffect</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建响应式effect</span>
  _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让响应式effect默认执行</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="依赖收集"><a href="#依赖收集" class="header-anchor">#</a> 依赖收集</h2> <blockquote><p>默认执行 effect 时会对属性，进行依赖收集</p></blockquote> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 依赖收集</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录依赖关系</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {对象：map}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {对象：{ 属性 :[ dep, dep ]}}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让effect记住dep，这样后续可以用于清理</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><blockquote><p>将属性和对应的 effect 维护成映射关系，后续属性变化可以触发对应的 effect 函数重新 run</p></blockquote> <h2 id="触发更新"><a href="#触发更新" class="header-anchor">#</a> 触发更新</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 等会赋值的时候可以重新触发effect执行</span>
    <span class="token keyword">let</span> oldValue <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token operator">?</span><span class="token punctuation">,</span> newValue<span class="token operator">?</span><span class="token punctuation">,</span> oldValue<span class="token operator">?</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取对应的映射表</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  effects <span class="token operator">&amp;&amp;</span>
    effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 防止循环</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="分支切换与-cleanup"><a href="#分支切换与-cleanup" class="header-anchor">#</a> 分支切换与 cleanup</h2> <p>在渲染时我们要避免副作用函数产生的遗留</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">flag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'jw'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 副作用函数 (effect执行渲染了页面)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>flag <span class="token operator">?</span> state<span class="token punctuation">.</span>name <span class="token operator">:</span> state<span class="token punctuation">.</span>age<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'修改name，原则上不更新'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'zf'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-diff line-numbers-mode"><pre class="language-diff"><code>function cleanupEffect(effect) {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   const { deps } = effect; // 清理effect
</span><span class="token prefix unchanged"> </span><span class="token line">   for (let i = 0; i &lt; deps.length; i++) {
</span><span class="token prefix unchanged"> </span><span class="token line">       deps[i].delete(effect);
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line">   effect.deps.length = 0;
</span></span>}
class ReactiveEffect {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   active = true;
</span><span class="token prefix unchanged"> </span><span class="token line">   deps = []; // 收集effect中使用到的属性
</span><span class="token prefix unchanged"> </span><span class="token line">   parent = undefined;
</span><span class="token prefix unchanged"> </span><span class="token line">   constructor(public fn) { }
</span><span class="token prefix unchanged"> </span><span class="token line">   run() {
</span><span class="token prefix unchanged"> </span><span class="token line">       try {
</span><span class="token prefix unchanged"> </span><span class="token line">           this.parent = activeEffect; // 当前的effect就是他的父亲
</span><span class="token prefix unchanged"> </span><span class="token line">           activeEffect = this; // 设置成正在激活的是当前effect
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">           cleanupEffect(this);
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">           return this.fn(); // 先清理在运行
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span></span>}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><blockquote><p>这里要注意的是：触发时会进行清理操作（清理 effect），在重新进行收集（收集 effect）。在循环过程中会导致死循环。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>effect<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
s<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  s<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  s<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这样就导致死循环了</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="停止-effect"><a href="#停止-effect" class="header-anchor">#</a> 停止 effect</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveEffect</span> <span class="token punctuation">{</span>
  <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> options<span class="token operator">?</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> runner <span class="token operator">=</span> _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  runner<span class="token punctuation">.</span>effect <span class="token operator">=</span> _effect<span class="token punctuation">;</span>
  <span class="token keyword">return</span> runner<span class="token punctuation">;</span> <span class="token comment">// 返回runner</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="调度执行"><a href="#调度执行" class="header-anchor">#</a> 调度执行</h2> <p><code>trigger</code> 触发时，我们可以自己决定副作用函数执行的时机、次数、及执行方式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建响应式effect</span>
  <span class="token comment">// if(options){</span>
  <span class="token comment">//     Object.assign(_effect,options); // 扩展属性</span>
  <span class="token comment">// }</span>
  _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让响应式effect默认执行</span>
  <span class="token keyword">const</span> runner <span class="token operator">=</span> _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  runner<span class="token punctuation">.</span>effect <span class="token operator">=</span> _effect<span class="token punctuation">;</span>
  <span class="token keyword">return</span> runner<span class="token punctuation">;</span> <span class="token comment">// 返回runner</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token operator">?</span><span class="token punctuation">,</span> newValue<span class="token operator">?</span><span class="token punctuation">,</span> oldValue<span class="token operator">?</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>effects<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> effect <span class="token keyword">of</span> effects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果有调度函数则执行调度函数</span>
          effect<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="深度代理"><a href="#深度代理" class="header-anchor">#</a> 深度代理</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 等会谁来取值就做依赖收集</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>当取值时返回的值是对象，则返回这个对象的代理对象，从而实现深度代理</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/luvue/vue3/收集/03-Vue3开发环境搭建.html" class="prev">03-Vue3开发环境搭建</a></span> <span class="next"><a href="/luvue/vue3/收集/05-Computed &amp; Watch.html">05-Computed &amp; Watch</a>
      →
    </span></p></div> </main> <span data-v-2ae0ee72></span></div><div class="global-ui"></div></div>
    <script src="/luvue/assets/js/app.24d3cb9c.js" defer></script><script src="/luvue/assets/js/2.7e9a2be9.js" defer></script><script src="/luvue/assets/js/3.92ecc592.js" defer></script><script src="/luvue/assets/js/232.df938b18.js" defer></script>
  </body>
</html>
