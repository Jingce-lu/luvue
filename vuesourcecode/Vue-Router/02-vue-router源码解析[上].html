<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue-router 源码解析 | 1.4w 字 | 多图预警 - 【上】 | Ailjc notes</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel=" " href=" ">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/assets/css/0.styles.e687256a.css" as="style"><link rel="preload" href="/assets/js/app.bcf15098.js" as="script"><link rel="preload" href="/assets/js/2.c43dd9cb.js" as="script"><link rel="preload" href="/assets/js/3.e6d9e1d5.js" as="script"><link rel="preload" href="/assets/js/188.c35b8b85.js" as="script"><link rel="prefetch" href="/assets/js/10.df215ea6.js"><link rel="prefetch" href="/assets/js/100.3356af71.js"><link rel="prefetch" href="/assets/js/101.eefa5767.js"><link rel="prefetch" href="/assets/js/102.7893d189.js"><link rel="prefetch" href="/assets/js/103.04e05070.js"><link rel="prefetch" href="/assets/js/104.42d4ec51.js"><link rel="prefetch" href="/assets/js/105.841ae151.js"><link rel="prefetch" href="/assets/js/106.a938df4f.js"><link rel="prefetch" href="/assets/js/107.9943c1d5.js"><link rel="prefetch" href="/assets/js/108.84b58c39.js"><link rel="prefetch" href="/assets/js/109.1599e9c9.js"><link rel="prefetch" href="/assets/js/11.20012366.js"><link rel="prefetch" href="/assets/js/110.5eb93316.js"><link rel="prefetch" href="/assets/js/111.575fe0b2.js"><link rel="prefetch" href="/assets/js/112.578ad5b1.js"><link rel="prefetch" href="/assets/js/113.6ce2ad69.js"><link rel="prefetch" href="/assets/js/114.4f964297.js"><link rel="prefetch" href="/assets/js/115.6d2c657f.js"><link rel="prefetch" href="/assets/js/116.ca2aeebf.js"><link rel="prefetch" href="/assets/js/117.d26ba70d.js"><link rel="prefetch" href="/assets/js/118.7a04dd1e.js"><link rel="prefetch" href="/assets/js/119.1f1d5e4e.js"><link rel="prefetch" href="/assets/js/12.47ce94f1.js"><link rel="prefetch" href="/assets/js/120.f133f9ee.js"><link rel="prefetch" href="/assets/js/121.fea1198d.js"><link rel="prefetch" href="/assets/js/122.81c81a64.js"><link rel="prefetch" href="/assets/js/123.40cfd868.js"><link rel="prefetch" href="/assets/js/124.d00980e9.js"><link rel="prefetch" href="/assets/js/125.a5bd3f5b.js"><link rel="prefetch" href="/assets/js/126.608b52ad.js"><link rel="prefetch" href="/assets/js/127.41e64de7.js"><link rel="prefetch" href="/assets/js/128.5f4c7ff1.js"><link rel="prefetch" href="/assets/js/129.8acc324a.js"><link rel="prefetch" href="/assets/js/13.c0394047.js"><link rel="prefetch" href="/assets/js/130.120c6be1.js"><link rel="prefetch" href="/assets/js/131.986bf16f.js"><link rel="prefetch" href="/assets/js/132.4ef7b39b.js"><link rel="prefetch" href="/assets/js/133.85464537.js"><link rel="prefetch" href="/assets/js/134.1f5f6f6c.js"><link rel="prefetch" href="/assets/js/135.baa85b2b.js"><link rel="prefetch" href="/assets/js/136.abe5b6c9.js"><link rel="prefetch" href="/assets/js/137.774d3391.js"><link rel="prefetch" href="/assets/js/138.664612ca.js"><link rel="prefetch" href="/assets/js/139.1757f912.js"><link rel="prefetch" href="/assets/js/14.4ebbd5ab.js"><link rel="prefetch" href="/assets/js/140.5b44c0d9.js"><link rel="prefetch" href="/assets/js/141.3399fd28.js"><link rel="prefetch" href="/assets/js/142.ff053fd6.js"><link rel="prefetch" href="/assets/js/143.d56cb326.js"><link rel="prefetch" href="/assets/js/144.4f20334d.js"><link rel="prefetch" href="/assets/js/145.645fe3a5.js"><link rel="prefetch" href="/assets/js/146.fa10b67b.js"><link rel="prefetch" href="/assets/js/147.642d725a.js"><link rel="prefetch" href="/assets/js/148.496ba376.js"><link rel="prefetch" href="/assets/js/149.4ea2e75a.js"><link rel="prefetch" href="/assets/js/15.0e8080e2.js"><link rel="prefetch" href="/assets/js/150.02e38c3c.js"><link rel="prefetch" href="/assets/js/151.4e139ba0.js"><link rel="prefetch" href="/assets/js/152.15723a5a.js"><link rel="prefetch" href="/assets/js/153.e29cf0fc.js"><link rel="prefetch" href="/assets/js/154.daea5fb5.js"><link rel="prefetch" href="/assets/js/155.9470ca29.js"><link rel="prefetch" href="/assets/js/156.37133224.js"><link rel="prefetch" href="/assets/js/157.e81b4551.js"><link rel="prefetch" href="/assets/js/158.fa44e779.js"><link rel="prefetch" href="/assets/js/159.b3ee4c50.js"><link rel="prefetch" href="/assets/js/16.6e74756b.js"><link rel="prefetch" href="/assets/js/160.fd1d0192.js"><link rel="prefetch" href="/assets/js/161.e4d1e3d8.js"><link rel="prefetch" href="/assets/js/162.53949bf1.js"><link rel="prefetch" href="/assets/js/163.2ff1478c.js"><link rel="prefetch" href="/assets/js/164.0b547ddf.js"><link rel="prefetch" href="/assets/js/165.5a29880d.js"><link rel="prefetch" href="/assets/js/166.c35f0334.js"><link rel="prefetch" href="/assets/js/167.a1a6de3b.js"><link rel="prefetch" href="/assets/js/168.dc0a16c8.js"><link rel="prefetch" href="/assets/js/169.ad9114c9.js"><link rel="prefetch" href="/assets/js/17.e2759383.js"><link rel="prefetch" href="/assets/js/170.38676f00.js"><link rel="prefetch" href="/assets/js/171.05d74bfd.js"><link rel="prefetch" href="/assets/js/172.4d6dc06f.js"><link rel="prefetch" href="/assets/js/173.45ea859a.js"><link rel="prefetch" href="/assets/js/174.2d85e966.js"><link rel="prefetch" href="/assets/js/175.bb8307ff.js"><link rel="prefetch" href="/assets/js/176.6322d505.js"><link rel="prefetch" href="/assets/js/177.946d4343.js"><link rel="prefetch" href="/assets/js/178.b924fb4d.js"><link rel="prefetch" href="/assets/js/179.2d88d374.js"><link rel="prefetch" href="/assets/js/18.b2b1c448.js"><link rel="prefetch" href="/assets/js/180.3fcf753f.js"><link rel="prefetch" href="/assets/js/181.1498573e.js"><link rel="prefetch" href="/assets/js/182.c6f53f74.js"><link rel="prefetch" href="/assets/js/183.90c45652.js"><link rel="prefetch" href="/assets/js/184.2d404a73.js"><link rel="prefetch" href="/assets/js/185.3f714dcf.js"><link rel="prefetch" href="/assets/js/186.83092ac5.js"><link rel="prefetch" href="/assets/js/187.ea72b212.js"><link rel="prefetch" href="/assets/js/189.001b6d4d.js"><link rel="prefetch" href="/assets/js/19.f0d88a31.js"><link rel="prefetch" href="/assets/js/190.0ba54d2d.js"><link rel="prefetch" href="/assets/js/191.94458ca0.js"><link rel="prefetch" href="/assets/js/192.7cb21a75.js"><link rel="prefetch" href="/assets/js/193.3d766519.js"><link rel="prefetch" href="/assets/js/194.c751d11f.js"><link rel="prefetch" href="/assets/js/195.952a9dad.js"><link rel="prefetch" href="/assets/js/196.5fde53f9.js"><link rel="prefetch" href="/assets/js/197.f1bdd781.js"><link rel="prefetch" href="/assets/js/198.b2f2a2ab.js"><link rel="prefetch" href="/assets/js/199.02f2552b.js"><link rel="prefetch" href="/assets/js/20.5af06bdf.js"><link rel="prefetch" href="/assets/js/200.99aac804.js"><link rel="prefetch" href="/assets/js/201.82400862.js"><link rel="prefetch" href="/assets/js/202.807ad434.js"><link rel="prefetch" href="/assets/js/203.4f4d9eb6.js"><link rel="prefetch" href="/assets/js/204.0c8d2329.js"><link rel="prefetch" href="/assets/js/205.d01bc76b.js"><link rel="prefetch" href="/assets/js/206.578faca0.js"><link rel="prefetch" href="/assets/js/207.c696aba9.js"><link rel="prefetch" href="/assets/js/208.96d045ae.js"><link rel="prefetch" href="/assets/js/209.76466a21.js"><link rel="prefetch" href="/assets/js/21.aa961bab.js"><link rel="prefetch" href="/assets/js/210.c3d37cfa.js"><link rel="prefetch" href="/assets/js/211.6ef8f066.js"><link rel="prefetch" href="/assets/js/212.34fd2c4d.js"><link rel="prefetch" href="/assets/js/22.0f135229.js"><link rel="prefetch" href="/assets/js/23.833fbd24.js"><link rel="prefetch" href="/assets/js/24.79f9d29b.js"><link rel="prefetch" href="/assets/js/25.1f54693c.js"><link rel="prefetch" href="/assets/js/26.85ed2123.js"><link rel="prefetch" href="/assets/js/27.dd7191a8.js"><link rel="prefetch" href="/assets/js/28.747b1a7f.js"><link rel="prefetch" href="/assets/js/29.ce0a2fc3.js"><link rel="prefetch" href="/assets/js/30.c34926f7.js"><link rel="prefetch" href="/assets/js/31.47f516be.js"><link rel="prefetch" href="/assets/js/32.80d978e9.js"><link rel="prefetch" href="/assets/js/33.fd40cf15.js"><link rel="prefetch" href="/assets/js/34.78e97c6c.js"><link rel="prefetch" href="/assets/js/35.7e5b1cb1.js"><link rel="prefetch" href="/assets/js/36.1006ad50.js"><link rel="prefetch" href="/assets/js/37.1c508aab.js"><link rel="prefetch" href="/assets/js/38.217440b1.js"><link rel="prefetch" href="/assets/js/39.db731c09.js"><link rel="prefetch" href="/assets/js/4.3a38816f.js"><link rel="prefetch" href="/assets/js/40.24e008ac.js"><link rel="prefetch" href="/assets/js/41.f55740f2.js"><link rel="prefetch" href="/assets/js/42.e64c8653.js"><link rel="prefetch" href="/assets/js/43.fe16cee5.js"><link rel="prefetch" href="/assets/js/44.995f0b0b.js"><link rel="prefetch" href="/assets/js/45.eec86cd0.js"><link rel="prefetch" href="/assets/js/46.8a60d3ac.js"><link rel="prefetch" href="/assets/js/47.0a1c85e1.js"><link rel="prefetch" href="/assets/js/48.0c683174.js"><link rel="prefetch" href="/assets/js/49.1cca4907.js"><link rel="prefetch" href="/assets/js/5.a88aa8bc.js"><link rel="prefetch" href="/assets/js/50.c4391120.js"><link rel="prefetch" href="/assets/js/51.cdaa4eec.js"><link rel="prefetch" href="/assets/js/52.b67d2bcb.js"><link rel="prefetch" href="/assets/js/53.821c62f3.js"><link rel="prefetch" href="/assets/js/54.9da554d0.js"><link rel="prefetch" href="/assets/js/55.e4231e0d.js"><link rel="prefetch" href="/assets/js/56.7b2fdab2.js"><link rel="prefetch" href="/assets/js/57.389609e5.js"><link rel="prefetch" href="/assets/js/58.e79d046a.js"><link rel="prefetch" href="/assets/js/59.65921736.js"><link rel="prefetch" href="/assets/js/6.8dd53b15.js"><link rel="prefetch" href="/assets/js/60.282a405e.js"><link rel="prefetch" href="/assets/js/61.da6c417b.js"><link rel="prefetch" href="/assets/js/62.22294ded.js"><link rel="prefetch" href="/assets/js/63.693c34cb.js"><link rel="prefetch" href="/assets/js/64.89d4f466.js"><link rel="prefetch" href="/assets/js/65.f0dc66f0.js"><link rel="prefetch" href="/assets/js/66.aab8ab6d.js"><link rel="prefetch" href="/assets/js/67.f897938b.js"><link rel="prefetch" href="/assets/js/68.6f41ef7f.js"><link rel="prefetch" href="/assets/js/69.89682843.js"><link rel="prefetch" href="/assets/js/7.bee05971.js"><link rel="prefetch" href="/assets/js/70.e11ab6a4.js"><link rel="prefetch" href="/assets/js/71.b6ac93b3.js"><link rel="prefetch" href="/assets/js/72.4218d0b9.js"><link rel="prefetch" href="/assets/js/73.19b09391.js"><link rel="prefetch" href="/assets/js/74.01284808.js"><link rel="prefetch" href="/assets/js/75.c1ae9548.js"><link rel="prefetch" href="/assets/js/76.079176f2.js"><link rel="prefetch" href="/assets/js/77.8d7552a8.js"><link rel="prefetch" href="/assets/js/78.1f6a9d67.js"><link rel="prefetch" href="/assets/js/79.3817fe99.js"><link rel="prefetch" href="/assets/js/8.29edb771.js"><link rel="prefetch" href="/assets/js/80.a1591161.js"><link rel="prefetch" href="/assets/js/81.8577f860.js"><link rel="prefetch" href="/assets/js/82.b5fbb7c5.js"><link rel="prefetch" href="/assets/js/83.4ea0beda.js"><link rel="prefetch" href="/assets/js/84.b75c5709.js"><link rel="prefetch" href="/assets/js/85.37236b94.js"><link rel="prefetch" href="/assets/js/86.2e0b9716.js"><link rel="prefetch" href="/assets/js/87.2337c759.js"><link rel="prefetch" href="/assets/js/88.36907b69.js"><link rel="prefetch" href="/assets/js/89.c49ac34f.js"><link rel="prefetch" href="/assets/js/9.a92e523d.js"><link rel="prefetch" href="/assets/js/90.076495fd.js"><link rel="prefetch" href="/assets/js/91.ebb3982b.js"><link rel="prefetch" href="/assets/js/92.eedcefcc.js"><link rel="prefetch" href="/assets/js/93.9c7e1047.js"><link rel="prefetch" href="/assets/js/94.a390c961.js"><link rel="prefetch" href="/assets/js/95.585cd947.js"><link rel="prefetch" href="/assets/js/96.cf004466.js"><link rel="prefetch" href="/assets/js/97.91617a09.js"><link rel="prefetch" href="/assets/js/98.ce431385.js"><link rel="prefetch" href="/assets/js/99.b905d253.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e687256a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Ailjc notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/vuesourcecode/" class="nav-link router-link-active">源码分析</a></div><div class="nav-item"><a href="/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/engineering/" class="nav-link">工程化</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/vuesourcecode/" class="nav-link router-link-active">源码分析</a></div><div class="nav-item"><a href="/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/engineering/" class="nav-link">工程化</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/vuesourcecode/PWA&amp;WebComponent/" class="sidebar-heading clickable"><span>PWA&amp;WebComponent</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuesourcecode/Vite/" class="sidebar-heading clickable"><span>Vite</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuesourcecode/Vue-Router/" class="sidebar-heading clickable router-link-active open"><span>Vue-Router</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuesourcecode/Vue-Router/01-Vue-Router源码深度剖析.html" class="sidebar-link">01-Vue-Router源码深度剖析</a></li><li><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html" class="active sidebar-link">02-vue-router源码解析[上]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#设计思路" class="sidebar-link">设计思路</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#术语" class="sidebar-link">术语</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#路由规则、配置对象-routeconfig" class="sidebar-link">路由规则、配置对象(RouteConfig)</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#路由记录-routerecord" class="sidebar-link">路由记录(RouteRecord)</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#路由对象-route" class="sidebar-link">路由对象(Route)</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#位置-location" class="sidebar-link">位置(Location)</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#路由组件-routecomponent" class="sidebar-link">路由组件(RouteComponent)</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#环境" class="sidebar-link">环境</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#目录结构" class="sidebar-link">目录结构</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#基础例子" class="sidebar-link">基础例子</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#安装流程" class="sidebar-link">安装流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#install-js" class="sidebar-link">install.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#实例化流程" class="sidebar-link">实例化流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#vuerouter-的构造函数" class="sidebar-link">VueRouter 的构造函数</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#创建匹配器" class="sidebar-link">创建匹配器</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#createroutemap" class="sidebar-link">createRouteMap</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#addrouterecord" class="sidebar-link">addRouteRecord</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#路由模式" class="sidebar-link">路由模式</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#初始化流程" class="sidebar-link">初始化流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#调用-init-时机" class="sidebar-link">调用 init 时机</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#init-方法" class="sidebar-link">init 方法</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#setuplisteners" class="sidebar-link">setupListeners</a></li><li class="sidebar-sub-header"><a href="/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html#小结" class="sidebar-link">小结</a></li></ul></li></ul></li><li><a href="/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html" class="sidebar-link">03-vue-router源码解析[中]</a></li><li><a href="/vuesourcecode/Vue-Router/04-vue-router源码解析[下].html" class="sidebar-link">04-vue-router源码解析[下]</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuesourcecode/vue2剖析源码/" class="sidebar-heading clickable"><span>vue2剖析源码</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuesourcecode/vuex/" class="sidebar-heading clickable"><span>vuex</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuesourcecode/vue服务端渲染/" class="sidebar-heading clickable"><span>vue服务端渲染</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuesourcecode/微前端/" class="sidebar-heading clickable"><span>微前端</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuesourcecode/手写核心原理/" class="sidebar-heading clickable"><span>手写核心原理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuesourcecode/脚手架/" class="sidebar-heading clickable"><span>脚手架</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-router-源码解析-1-4w-字-多图预警-【上】"><a href="#vue-router-源码解析-1-4w-字-多图预警-【上】" class="header-anchor">#</a> vue-router 源码解析 | 1.4w 字 | 多图预警 - 【上】</h1> <p></p><div class="table-of-contents"><ul><li><a href="#设计思路">设计思路</a></li><li><a href="#术语">术语</a><ul><li><a href="#路由规则、配置对象-routeconfig">路由规则、配置对象(RouteConfig)</a></li><li><a href="#路由记录-routerecord">路由记录(RouteRecord)</a></li><li><a href="#路由对象-route">路由对象(Route)</a></li><li><a href="#位置-location">位置(Location)</a></li><li><a href="#路由组件-routecomponent">路由组件(RouteComponent)</a></li></ul></li><li><a href="#环境">环境</a></li><li><a href="#目录结构">目录结构</a></li><li><a href="#基础例子">基础例子</a></li><li><a href="#安装流程">安装流程</a><ul><li><a href="#install-js">install.js</a></li></ul></li><li><a href="#实例化流程">实例化流程</a><ul><li><a href="#vuerouter-的构造函数">VueRouter 的构造函数</a></li><li><a href="#创建匹配器">创建匹配器</a></li><li><a href="#createroutemap">createRouteMap</a></li><li><a href="#addrouterecord">addRouteRecord</a></li><li><a href="#路由模式">路由模式</a></li></ul></li><li><a href="#初始化流程">初始化流程</a><ul><li><a href="#调用-init-时机">调用 init 时机</a></li><li><a href="#init-方法">init 方法</a></li><li><a href="#setuplisteners">setupListeners</a></li><li><a href="#小结">小结</a></li></ul></li></ul></div><p></p> <ul><li>项目地址 <a href="https://github.com/BryanAdamss/vue-router-for-analysis" target="_blank" rel="noopener noreferrer">https://github.com/BryanAdamss/vue-router-for-analysis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>uml 图源文件 <a href="https://github.com/BryanAdamss/vue-router-for-analysis/blob/dev/vue-router.EAP" target="_blank" rel="noopener noreferrer">https://github.com/BryanAdamss/vue-router-for-analysis/blob/dev/vue-router.EAP<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="设计思路"><a href="#设计思路" class="header-anchor">#</a> 设计思路</h2> <ul><li>服务端路由根据 <code>url</code> 分配对应处理程序，返回页面、接口返回</li> <li>前端路由是通过 <code>js</code> 根据 <code>url</code> 返回对对应组件</li></ul> <p>要实现路由，需要-路由映射表；</p> <ul><li>服务端做路由页面跳转时，映射表的反映的是 <code>url</code> 和<code>页面</code>的关系</li> <li>现在前端基本走模块化了，所以前端的路由映射表反映的是 <code>url</code> 和<code>组件</code>的关系</li></ul> <p>就像下面的伪代码一样</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 使用es6 map</span>
<span class="token keyword">const</span> routeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">'/'</span><span class="token punctuation">,</span> 首页组件<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'/bar'</span><span class="token punctuation">,</span> Bar组件<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'/bar/foo'</span><span class="token punctuation">,</span> Foo组件<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 你也可以用对象字面量</span>
<span class="token keyword">const</span> routeMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'/'</span><span class="token operator">:</span> 首页组件<span class="token punctuation">,</span>
  <span class="token string-property property">'/bar'</span><span class="token operator">:</span> Bar组件<span class="token punctuation">,</span>
  <span class="token string-property property">'/bar/foo'</span><span class="token operator">:</span> Foo组件<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>有了映射表，我们就知道 <code>url</code> 和<code>组件</code>的映射关系；</li> <li>但是，映射表维护的只是一个关系，并不能帮我们完成，访问<code>/bar</code>，返回 <code>Bar 组件</code>这样一个流程，所以我们还需要一个匹配器，来帮我们完成从 <code>url</code> 到<code>组件</code>的匹配工作；</li> <li>是不是有了 <code>路由映射表</code> 和 <code>匹配器</code> 就可以实现前端路由了呢？</li> <li>我们的 <code>spa</code> 是运行在浏览器环境中的，浏览器是有<code>前进、返回</code>功能的，需要我们记录访问过的 <code>url</code>；
<ul><li>我们知道，要实现这种类似<code>撤销、恢复</code>的功能，肯定需要使用到一种数据结构-<code>栈(stack)</code>；每访问一个<code>url</code>，将<code>url</code>，<code>push</code>到栈中，返回时，执行 <code>pop</code> 即可拿到上一次访问的 <code>url</code></li> <li>好在浏览器平台，已经给我们提供了这样的栈，无需我们自己实现，我们只需要去调用它的接口 <code>window.history</code> 实现功能即可</li></ul></li></ul> <p><strong>总结</strong> 要实现一个前端路由，需要三个部分</p> <ol><li>路由映射表
<ul><li>一个能表达 <code>url</code> 和 <code>组件</code> 关系的映射表，可以使用 <code>Map</code>、<code>对象字面量</code>来实现</li></ul></li> <li>匹配器
<ul><li>负责在访问 <code>url</code> 时，进行匹配，找出对应的 <code>组件</code></li></ul></li> <li>历史记录栈
<ul><li>浏览器平台，已经原生支持，无需实现，直接调用接口</li></ul></li></ol> <h2 id="术语"><a href="#术语" class="header-anchor">#</a> 术语</h2> <p>在分析 <code>vue-router</code> 源码前，我们先了解下 <code>vue-router</code> 中常出现的一些概念术语，如果理解起来吃力，可以先跳过，后面遇到，再回来看；</p> <h3 id="路由规则、配置对象-routeconfig"><a href="#路由规则、配置对象-routeconfig" class="header-anchor">#</a> 路由规则、配置对象(RouteConfig)</h3> <ul><li><p>路由的配置项，用来描述路由</p></li> <li><p>下图红框里面标出来的都是路由配置对象</p></li> <li><p>route-config.png
<img src="/images/vuesourcecode/vue-router/vue-router01.awebp" alt="vuesourcecode/vue-router/vue-router01.awebp"></p></li> <li><p>因为 <code>vue-router</code> 是支持<code>嵌套路由</code>的，所以配置对象也是可以相互嵌套的</p></li> <li><p>完整的形状如下</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">RouteConfig</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  component<span class="token operator">?</span><span class="token operator">:</span> Component<span class="token punctuation">,</span><span class="token comment">// 路由组件</span>
  name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token comment">// 命名路由</span>
  components<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> Component <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 命名视图组件</span>
  redirect<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> Location <span class="token operator">|</span> <span class="token builtin">Function</span><span class="token punctuation">,</span>
  props<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> Object <span class="token operator">|</span> <span class="token builtin">Function</span><span class="token punctuation">,</span>
  alias<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  children<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 嵌套路由</span>
  beforeEnter<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>to<span class="token operator">:</span> Route<span class="token punctuation">,</span> from<span class="token operator">:</span> Route<span class="token punctuation">,</span> next<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  meta<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>

  <span class="token comment">// 2.6.0+</span>
  caseSensitive<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> <span class="token comment">// 匹配规则是否大小写敏感？(默认值：false)</span>
  pathToRegexpOptions<span class="token operator">?</span><span class="token operator">:</span> Object <span class="token comment">// 编译正则的选项</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li></ul> <h3 id="路由记录-routerecord"><a href="#路由记录-routerecord" class="header-anchor">#</a> 路由记录(RouteRecord)</h3> <p>每一条路由规则都会生成一条路由记录；嵌套、别名路由也都会生成一条路由记录；是路由映射表的组成部分</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> record<span class="token operator">:</span> RouteRecord <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> normalizedPath<span class="token punctuation">,</span>
  regex<span class="token operator">:</span> <span class="token function">compileRouteRegex</span><span class="token punctuation">(</span>normalizedPath<span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 利用path-to-regexp包生成用来匹配path的增强正则对象，可以用来匹配动态路由</span>
  components<span class="token operator">:</span> route<span class="token punctuation">.</span>components <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> route<span class="token punctuation">.</span>component <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 保存路由组件，支持命名视图https://router.vuejs.org/zh/guide/essentials/named-views.html#命名视图</span>
  instances<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 保存每个命名router-view需要渲染的路由组件</span>
  name<span class="token punctuation">,</span>
  parent<span class="token punctuation">,</span>
  matchAs<span class="token punctuation">,</span>
  redirect<span class="token operator">:</span> route<span class="token punctuation">.</span>redirect<span class="token punctuation">,</span> <span class="token comment">// 重定向的路由配置对象</span>
  beforeEnter<span class="token operator">:</span> route<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span> <span class="token comment">// 路由独享的守卫</span>
  meta<span class="token operator">:</span> route<span class="token punctuation">.</span>meta <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 元信息</span>
  <span class="token comment">// 动态路由传参；https://router.vuejs.org/zh/guide/essentials/passing-props.html#路由组件传参</span>
  props<span class="token operator">:</span>
    route<span class="token punctuation">.</span>props <span class="token operator">==</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token operator">:</span> route<span class="token punctuation">.</span>components <span class="token comment">// 命名视图的传参规则需要使用route.props指定的规则</span>
      <span class="token operator">?</span> route<span class="token punctuation">.</span>props
      <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> route<span class="token punctuation">.</span>props <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="路由对象-route"><a href="#路由对象-route" class="header-anchor">#</a> 路由对象(Route)</h3> <ul><li><code>Route</code> 表示当前激活的路由的状态信息，包含了当前 <code>URL</code> 解析得到的信息，还有 <code>URL</code> 匹配到的路由记录们 (<code>route records</code>)。</li> <li><code>https://router.vuejs.org/zh/api/#路由对象</code></li> <li>注意，这说明一个 <code>Route</code> 可以关联多个 <code>RouteRecord</code></li> <li>通过 <code>this.$route</code> 访问到的就是 <code>Route</code> 对象</li> <li>route.png
<img src="/images/vuesourcecode/vue-router/vue-router02.awebp" alt="vuesourcecode/vue-router/vue-router02.awebp"></li> <li>路由对象是不可变 (<code>immutable</code>) 的，每次成功的导航后都会产生一个新的对象</li></ul> <h3 id="位置-location"><a href="#位置-location" class="header-anchor">#</a> 位置(Location)</h3> <ul><li>它并不是 <code>window.location</code> 的引用，<code>vue-router</code> 在内部定义了一个 <code>Location</code>，是一个用来描述目标位置的对象；</li> <li><code>$router.push/replace</code>、<code>router-link</code>的 <code>to</code> 接收的就是 <code>Location</code> 对象
<ul><li><code>https://router.vuejs.org/zh/api/#to</code></li></ul></li> <li><code>vue-router</code> 内部可以将一个<code>url string</code> 转换成 <code>Location</code> 对象，所以确切的说<code>$router.push/replace</code>、<code>router-link</code> 的 <code>to</code> 接收的都是一个 <code>RawLocation</code> 对象</li> <li><code>RawLocation</code> 对象是 <code>String</code> 和 <code>Location</code> 的联合类型</li></ul> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">RawLocation</span> <span class="token operator">=</span> <span class="token builtin">string</span> <span class="token operator">|</span> Location<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Location</span> <span class="token punctuation">{</span>
  name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  path<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  hash<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  query<span class="token operator">?</span><span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  params<span class="token operator">?</span><span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  append<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  replace<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="路由组件-routecomponent"><a href="#路由组件-routecomponent" class="header-anchor">#</a> 路由组件(RouteComponent)</h3> <ul><li>当路由成功匹配时，就需要在 <code>router-view</code> 渲染一个组件，这个需要被渲染的组件就是<code>路由组件</code></li> <li><code>RouteConfig</code> 中 <code>component</code>、<code>components</code> 中定义的 <code>vue 组件</code>就是路由组件</li> <li>路由组件的特殊性
<ul><li>拥有<strong>只在路由组件中生效</strong>的守卫(<code>beforeRouteEnter</code> 、<code>beforeRouteUpdate</code>、<code>beforeRouteLeave</code>)</li> <li>你是否跟我一样，曾经在组件中调用 <code>beforeRouteEnter</code> 发现没有生效，那是因为这个守卫只能在<code>路由组件</code>中被调用，在所有非路由组件中都不会被调用，包括路由组件的后代组件；你如果想在路由组件中实现 <code>beforeRouteEnter</code> 类似守卫监听效果，可以通过 <code>watch $route</code> 来手动判断</li></ul></li> <li>红框标记出来的是<code>路由组件</code> <img src="/images/vuesourcecode/vue-router/vue-router03.awebp" alt="vuesourcecode/vue-router/vue-router03.awebp"></li></ul> <h2 id="环境"><a href="#环境" class="header-anchor">#</a> 环境</h2> <ul><li>vue-router 版本:v3.1.6</li> <li>node 版本:v8.17.0</li> <li>分析仓库地址:<code>https://github.com/BryanAdamss/vue-router-for-analysis</code></li></ul> <h2 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h2> <img src="/images/vuesourcecode/vue-router/vue-router04.awebp" alt="vuesourcecode/vue-router/vue-router04.awebp"> <ul><li>examples
<ul><li>这里面存放了官方精心准备的案例</li> <li>不仅告诉你 vue-router 有哪些基础特性，还会告诉你怎么应对一些复杂场景，例如权限控制、动态添加路由等；总之，值得你去一探究竟；</li> <li>examples.png
<img src="/images/vuesourcecode/vue-router/vue-router05.awebp" alt="vuesourcecode/vue-router/vue-router05.awebp"></li> <li>在源码你想调试处添加 debugger 断点标识，然后启动例子 npm run dev，打开 localhost:8080 即可</li></ul></li> <li>src 目录
<ul><li><img src="/images/vuesourcecode/vue-router/vue-router06.awebp" alt="vuesourcecode/vue-router/vue-router06.awebp"></li> <li><code>components</code> 目录是存放内置组件 <code>router-link</code>、<code>router-view</code> 的</li> <li><code>history</code> 是存放核心 <code>history</code> 类的地方</li> <li><code>util</code> 中存放的是一些辅助函数</li> <li><code>index.js</code> 是 <code>vue-router</code> 的入口文件，也是 <code>vue-router</code> 类定义的地方</li> <li><code>install.js</code> 是安装逻辑所在文件</li></ul></li> <li><code>flow/declarations.js</code> <ul><li>它是 vue-router 的 flow 类型声明文件，通过它我们能知道 vue-router 中几个核心类(对象)是长什么样的</li> <li>它里面，大概长这样
<img src="/images/vuesourcecode/vue-router/vue-router07.awebp" alt="vuesourcecode/vue-router/vue-router07.awebp"></li></ul></li></ul> <h2 id="基础例子"><a href="#基础例子" class="header-anchor">#</a> 基础例子</h2> <ul><li><p>我们从最基础的例子开始看</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span><span class="token punctuation">;</span>
<span class="token comment">// 1. Use plugin.</span>
<span class="token comment">// 安装插件</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. Define route components</span>
<span class="token comment">// 定义路由组件</span>
<span class="token keyword">const</span> Home <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'&lt;div&gt;home&lt;/div&gt;'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'&lt;div&gt;foo&lt;/div&gt;'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Bar <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'&lt;div&gt;bar&lt;/div&gt;'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 3. Create the router</span>
<span class="token comment">// 实例化vue-router</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">routes</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token literal-property property">component</span><span class="token operator">:</span> Home <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span> <span class="token literal-property property">component</span><span class="token operator">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/bar'</span><span class="token punctuation">,</span> <span class="token literal-property property">component</span><span class="token operator">:</span> Bar <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 4. Create and mount root instance.</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  router<span class="token punctuation">,</span> <span class="token comment">// 注入router实例</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div id=&quot;app&quot;&gt;
      &lt;h1&gt;Basic&lt;/h1&gt;
      
      &lt;ul&gt;
        &lt;li&gt;&lt;router-link to=&quot;/&quot;&gt;/&lt;/router-link&gt;&lt;/li&gt;
        &lt;li&gt;&lt;router-link to=&quot;/foo&quot;&gt;/foo&lt;/router-link&gt;&lt;/li&gt;
        &lt;li&gt;&lt;router-link to=&quot;/bar&quot;&gt;/bar&lt;/router-link&gt;&lt;/li&gt;
      &lt;/ul&gt;
      
      &lt;router-view class=&quot;view&quot;&gt;&lt;/router-view&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div></li> <li><p>可以看到，首先使用 <code>vue</code> 的插件语法安装了 <code>vue-router</code>； 然后我们再实例化 <code>VueRouter</code>； 最后我们将 <code>VueRouter</code> 的实例注入到 <code>Vue</code></p></li> <li><p>涉及到三个核心流程：<code>安装</code>、<code>实例化</code>、<code>初始化</code></p></li></ul> <h2 id="安装流程"><a href="#安装流程" class="header-anchor">#</a> 安装流程</h2> <ul><li>只要是 <code>vue plugin</code>，肯定都会有一个 <code>install</code> 方法
<ul><li><a href="https%3A%2F%2Fcn.vuejs.org%2Fv2%2Fguide%2Fplugins.html%23%25E5%25BC%2580%25E5%258F%2591%25E6%258F%2592%25E4%25BB%25B6">cn.vuejs.org/v2/guide/pl…</a></li></ul></li> <li><code>vue-router</code> 的入口文件在 <code>src/index.js</code> 中</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/index.js</span>

<span class="token comment">/* @flow */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> install <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./install'</span> <span class="token comment">// 导入安装方法</span>
<span class="token operator">...</span>

<span class="token comment">// VueRouter类</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span> 
<span class="token punctuation">}</span>

<span class="token operator">...</span>

VueRouter<span class="token punctuation">.</span>install <span class="token operator">=</span> install <span class="token comment">// 挂载安装方法，Vue.use时，自动调用install方法</span>
VueRouter<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token string">'__VERSION__'</span>

<span class="token comment">// 浏览器环境，自动安装VueRouter</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter">inBrowser <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>可以看到，开头导入了 <code>install</code> 方法，并将其做为静态方法直接挂载到 <code>VueRouter</code> 上，这样，在 <code>Vue.use(VueRouter)</code>时，<code>install</code> 方法就会被调用；</li> <li>可以看到，如果在浏览器环境，并且通过 <code>script 标签</code>的形式引入 <code>Vue</code> 时(会在 <code>window</code> 上挂载 <code>Vue</code> 全局变量)，会尝试自动使用 <code>VueRouter</code></li></ul> <h3 id="install-js"><a href="#install-js" class="header-anchor">#</a> install.js</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/index.js</span>

<span class="token comment">/* @flow */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> install <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./install'</span> <span class="token comment">// 导入安装方法</span>
<span class="token operator">...</span>

<span class="token comment">// VueRouter类</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span> 
<span class="token punctuation">}</span>

<span class="token operator">...</span>

VueRouter<span class="token punctuation">.</span>install <span class="token operator">=</span> install <span class="token comment">// 挂载安装方法，Vue.use时，自动调用install方法</span>
VueRouter<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token string">'__VERSION__'</span>

<span class="token comment">// 浏览器环境，自动安装VueRouter</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter">inBrowser <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>可以看到，install 方法干了下面几件事</p> <ol><li><p>避免重复安装</p> <ul><li>通过添加 <code>installed</code> 标识来判断是否重复安装</li></ul></li> <li><p>保留 Vue 引用，避免将 Vue 做为依赖打包</p> <ul><li><code>install</code> 方法被调用时，会将 Vue 做为参数传入，Vue 会被赋值给事先定义好的 <code>_Vue</code> 变量</li> <li>在其它模块中，可以导入这个 <code>_Vue</code>，这样既能访问到 Vue，又避免了将 Vue 做为依赖打包</li> <li>这是一个插件开发实用小技巧</li></ul></li> <li><p>注册了一个全局混入</p> <ul><li><p>这个混入将影响注册之后所有创建的每个 Vue 实例，也就是后面每个 Vue 实例都会执行混入中的代码</p></li> <li><p>我们看下混入中的代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 注册全局混入</span>
Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this === new Vue({router:router}) === Vue根实例</span>

    <span class="token comment">// 判断是否使用了vue-router插件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 在Vue根实例上保存一些信息</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// 保存挂载VueRouter的Vue实例，此处为根实例</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">;</span> <span class="token comment">// 保存VueRouter实例，this.$options.router仅存在于Vue根实例上，其它Vue组件不包含此属性，所以下面的初始化，只会执行一次 // beforeCreate hook被触发时，调用</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化VueRouter实例，并传入Vue根实例 // 响应式定义_route属性，保证_route发生变化时，组件(router-view)会重新渲染</span>
      Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">,</span>
        <span class="token string">'_route'</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 回溯查找_routerRoot</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_routerRoot<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token comment">// 为router-view组件关联路由组件</span>

    <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">destroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// destroyed hook触发时，取消router-view和路由组件的关联</span>
    <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div></li> <li><p>它注册了两个生命周期钩子 <code>beforeCreate</code> 和 <code>destroyed</code>；</p></li> <li><p>注意</p> <ul><li>在这两个钩子中，<code>this</code> 是指向当时正在调用钩子的 vue 实例；</li> <li><strong>这两个钩子中的逻辑，在安装流程中是不会被执行的，只有在组件实例化时执行到钩子时才会被调用</strong></li></ul></li> <li><p>我们先看 <code>beforeCreate</code> 钩子</p></li> <li><p>它先判断了 <code>this.$options.router</code>是否存在，我们在<code>new Vue({router})</code>时，router 已经被保存到到<code>Vue根实例</code>的<code>$options</code> 上，而其它 <code>Vue</code> 实例的 <code>$options</code> 上是没有 <code>router</code> 的</p> <ul><li>所以 <code>if</code> 中的语句只在 <code>this === new Vue({router})</code>时，才会被执行，由于 <code>Vue 根实例</code>只有一个，所以这个逻辑只会被执行一次</li> <li>我们可以在 if 中打印 this 并结合调试工具看看
<ul><li><img src="/images/vuesourcecode/vue-router/vue-router08.awebp" alt="vuesourcecode/vue-router/vue-router08.awebp"></li></ul></li> <li>的确，if 中的逻辑只执行了一次，并且 this 就是指向 Vue 根实例</li></ul></li> <li><p>我们看下 if 中具体干了什么</p> <ul><li>在根实例上保存了<code>_routerRoot</code>，用来标识<code>router</code>挂载的<code>Vue实例</code></li> <li>在根实例上保存了<code>VueRouter</code>实例(<code>router</code>)</li> <li>对 router 进行了初始化(<code>init</code>)</li> <li>在根实例上，响应式定义了<code>_route</code>属性
<ul><li>保证<code>_route</code>变化时，<code>router-view</code>会重新渲染，这个我们后面在<code>router-view</code>组件中会细讲</li></ul></li></ul></li> <li><p>我们再看下 else 中具体干了啥</p> <ul><li>主要是为每个组件定义<code>_routerRoot</code>，采用的是逐层向上的回溯查找方式</li></ul></li> <li><p>我们看到还有个<code>registerInstance</code>方法，它在<code>beforeCreate</code>、<code>destroyed</code>都有被调用，只是参数个数不一样</p> <ul><li>在<code>beforeCreate</code>中传入了两个参数，且都是<code>this</code>即当前<code>vue实例</code>，而在<code>destroyed</code>中只传入了一个<code>vue实例</code></li> <li>我们在讲 router-view 时会细讲，你只需要知道它是用来为 router-view 组件关联或解绑路由组件用的即可</li> <li>传入两个参数即关联，传入一个参数即解绑</li></ul></li></ul></li> <li><p>添加实例属性、方法<br>
在<code>Vue</code>原型上注入<code>$router</code>、<code>$route</code>属性，方便在<code>vue实例</code>中通过<code>this.$router</code>、<code>this.$route</code>快捷访问</p></li> <li><p>注册<code>router-view</code>、<code>router-link</code>全局组件<br>
通过<code>Vue.component</code>语法注册了<code>router-view</code>和<code>router-link</code>两个全局组件</p></li> <li><p>设置路由组件守卫的合并策略<br>
设置路由组件的<code>beforeRouteEnter</code>、<code>beforeRouteLeave</code>、<code>beforeRouteUpdate</code>守卫的合并策略</p></li></ol> <p>总结</p> <img src="/images/vuesourcecode/vue-router/vue-router09.awebp" alt="vuesourcecode/vue-router/vue-router09.awebp"> <h2 id="实例化流程"><a href="#实例化流程" class="header-anchor">#</a> 实例化流程</h2> <ul><li>看完安装流程，我们紧接着来看下 <code>VueRouter</code> 的实例化过程</li> <li>这一节，重点关注实例化过程，所以我们只看 <code>constructor</code> 中的核心逻辑</li></ul> <h3 id="vuerouter-的构造函数"><a href="#vuerouter-的构造函数" class="header-anchor">#</a> VueRouter 的构造函数</h3> <p>我们打开<code>src/index.js</code>看下<code>VueRouter</code>构造函数</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/index.js</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>options<span class="token operator">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 保存挂载实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// VueRouter支持多实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 接收 beforeEach hook</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 接收 beforeResolve hook</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 接收 afterEach hook</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建路由matcher对象，传入routes路由配置列表及VueRouter实例</span>
    <span class="token keyword">let</span> mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'hash'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fallback <span class="token operator">=</span>
      mode <span class="token operator">===</span> <span class="token string">'history'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>supportsPushState <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fallback <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 是否回退</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mode <span class="token operator">=</span> <span class="token string">'hash'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token comment">// 非浏览器环境，强制使用abstract模式</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mode <span class="token operator">=</span> <span class="token string">'abstract'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span> <span class="token comment">// 根据不同mode，实例化不同history实例</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'history'</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'hash'</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'abstract'</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid mode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>构造函数主要干了下面几件事</p> <ol><li><p><strong>接收 RouterOptions</strong></p> <ul><li><p>可以看到，构造函数接收一个 <code>options 选项对象</code>，它的类型是 <code>RouterOptions</code>，我们来看下 <code>RouterOptions</code></p></li> <li><p>打开 <code>flow/declarations.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// flow/declarations.js</span>

declare type RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  routes<span class="token operator">?</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 路由配置规则列表</span>
  mode<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token comment">// 路由模式</span>
  fallback<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span> <span class="token comment">// 是否启用回退</span>
  base<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token comment">// base地址</span>
  linkActiveClass<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token comment">// router-link激活时类名</span>
  linkExactActiveClass<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token comment">// router-link精准激活时类名</span>
  parseQuery<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">query</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Object<span class="token punctuation">,</span> <span class="token comment">// 自定义解析qs的方法</span>
  stringifyQuery<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">query</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> string<span class="token punctuation">,</span> <span class="token comment">// 自定义序列化qs的方法</span>
  scrollBehavior<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    <span class="token comment">// 控制滚动行为</span>
    <span class="token literal-property property">to</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
    <span class="token literal-property property">from</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
    <span class="token literal-property property">savedPosition</span><span class="token operator">:</span> <span class="token operator">?</span>Position
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> PositionResult <span class="token operator">|</span> Promise<span class="token operator">&lt;</span>PositionResult<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li> <li><p><code>RouterOptions</code>定义了<code>VueRouter</code>所能接收的所有选项；
<a href="https%3A%2F%2Frouter.vuejs.org%2Fzh%2Fapi%2F%23router-%25E6%259E%2584%25E5%25BB%25BA%25E9%2580%2589%25E9%25A1%25B9">router.vuejs.org/zh/api/#rou…</a></p></li> <li><p>我们重点关注一下下面的几个选项值</p> <ul><li>routes 是路由配置规则列表，这个主要用来后续生成路由映射表的；
它是一个数组，每一项都是一个路由配置规则(<code>RouteConfig</code>)，关于 <code>RouteConfig</code>，可以回看术语那一节；</li> <li><code>mode</code>、<code>fallback</code> 是跟路由模式相关的</li></ul></li></ul></li> <li><p><strong>属性赋初值</strong><br>
对一些属性赋予了初值，例如，对接收<code>全局导航守卫(beforeEach、beforeResolve、afterEach)</code>的数组做了初始化</p></li> <li><p><strong>创建 matcher</strong></p> <ul><li>通过 <code>createMatcher</code> 生成了 <code>matcher</code></li> <li>这个 <code>matcher</code> 对象就是最初聊的匹配器，负责 url 匹配，它接收了 <code>routes</code> 和 <code>router</code> 实例；<code>createMatcher</code> 里面不光创建了 <code>matcher</code>，还创建了<code>路由映射表 RouteMap</code></li></ul></li> <li><p><strong>确定路由模式</strong></p> <ul><li><p>VueRouter 会根据 <code>options.mode</code>、<code>options.fallback</code>、<code>supportsPushState</code>、<code>inBrowser</code> 来确定最终的路由模式</p></li> <li><p>先确定<code>fallback</code>，fallback 只有在用户设置了<code>mode:history</code>并且当前环境不支持 <code>pushState</code> 且用户主动声明了需要回退，此时 <code>fallback</code> 才为 <code>true</code></p></li> <li><p>当 <code>fallback</code> 为 <code>true</code> 时会使用 <code>hash</code> 模式；</p></li> <li><p>如果最后发现处于非浏览器环境，则会强制使用 <code>abstract</code> 模式</p></li> <li><p>route-mode.png
<img src="/images/vuesourcecode/vue-router/vue-router10.awebp" alt="vuesourcecode/vue-router/vue-router10.awebp"></p></li> <li><p><code>inBrowser</code> 和 <code>supportsPushState</code> 的实现都很简单</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/util/dom.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> inBrowser <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">;</span> <span class="token comment">// 直接判断window是否存在，来确定是否在浏览器环境中</span>

<span class="token comment">// src/util/push-state.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> supportsPushState <span class="token operator">=</span>
  inBrowser <span class="token operator">&amp;&amp;</span> <span class="token comment">// 浏览器环境</span>
  <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ua <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token punctuation">(</span>ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Android 2.'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span>
        ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Android 4.0'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Mobile Safari'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Chrome'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Windows Phone'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 特殊浏览器直接不支持</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      window<span class="token punctuation">.</span>history <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> window<span class="token punctuation">.</span>history<span class="token punctuation">.</span>pushState <span class="token operator">===</span> <span class="token string">'function'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 判断是否支持pushState</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></li></ul></li> <li><p><strong>根据路由模式生成不同的 History 实例</strong></p></li></ol> <p><strong>小结</strong>
VueRouter 的构造函数主要干了下面几件事</p> <ul><li>接收一个 <code>RouterOptions</code></li> <li>然后对一些属性赋了初值</li> <li>生成了 matcher 匹配器</li> <li>确定路由模式</li> <li>根据不同路由模式生成不同 <code>History实例</code></li></ul> <h3 id="创建匹配器"><a href="#创建匹配器" class="header-anchor">#</a> 创建匹配器</h3> <p>我们来细看一下 <code>createMatcher</code> 里面的实现<br> <code>createMatcher</code> 的实现在 <code>src/create-matcher.js</code> 中</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code> <span class="token comment">// src/create-matcher.js</span>

<span class="token operator">...</span>

<span class="token comment">// Matcher类型</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Matcher</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">match</span><span class="token operator">:</span> <span class="token punctuation">(</span>raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> current<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span> redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Route<span class="token punctuation">;</span> <span class="token comment">// 匹配方法</span>
  <span class="token function-variable function">addRoutes</span><span class="token operator">:</span> <span class="token punctuation">(</span>routes<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span> <span class="token comment">// 添加Route方法</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Matcher工厂函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createMatcher</span> <span class="token punctuation">(</span>
  routes<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 路由配置列表</span>
  router<span class="token operator">:</span> VueRouter <span class="token comment">// VueRouter实例</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Matcher <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createRouteMap</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span> <span class="token comment">// 创建路由映射表</span>
  <span class="token comment">// 添加路由</span>
  <span class="token keyword">function</span> <span class="token function">addRoutes</span> <span class="token punctuation">(</span>routes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 由于传入pathList, pathMap, nameMap了，所以createRouteMap方法会执行添加逻辑</span>
    <span class="token function">createRouteMap</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 传入location,返回匹配的Route对象</span>
  <span class="token keyword">function</span> <span class="token function">match</span> <span class="token punctuation">(</span>
    raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
    currentRoute<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
    redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location
  <span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 返回Matcher对象，暴露match、addRoutes方法</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    match<span class="token punctuation">,</span>
    addRoutes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>可以看到，<code>createMatcher</code> 方法接收一个路由配置规则列表和 <code>router 实例</code>，返回一个 <code>Matcher</code> 对象</p> <p><code>Matcher</code> 对象包含一个用于匹配的 <code>match</code> 方法和一个动态添加路由的 <code>addRoutes</code> 方法；<br>
而这两个方法都声明在 <code>createMatcher</code> 内部，由于闭包特性，它能访问到 <code>createMatcher</code> 作用域的所有变量</p> <p><strong>小结</strong><br>
总结下 createMatcher 的逻辑<br> <img src="/images/vuesourcecode/vue-router/vue-router11.awebp" alt="vuesourcecode/vue-router/vue-router11.awebp"></p> <p>我们可以看到 <code>createMatcher</code> 和 <code>addRoutes</code> 方法中都调用了 <code>createRouteMap</code> 方法，二者只是传递的参数不同，从方法名看，这个方法肯定和 <code>路由表 RouteMap</code> 有关</p> <h3 id="createroutemap"><a href="#createroutemap" class="header-anchor">#</a> createRouteMap</h3> <p>createRouteMap 方法位于 <code>src/create-route-map.js</code> 中</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 创建路由映射map、添加路由记录</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouteMap</span><span class="token punctuation">(</span>
  routes<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 路由配置列表</span>
  oldPathList<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 旧pathList</span>
  oldPathMap<span class="token operator">?</span><span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 旧pathMap</span>
  oldNameMap<span class="token operator">?</span><span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token comment">// 旧nameMap</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  pathList<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  pathMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  nameMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token comment">// 若旧的路由相关映射列表及map存在，则使用旧的初始化（借此实现添加路由功能）</span>
  <span class="token comment">// the path list is used to control path matching priority</span>
  <span class="token keyword">const</span> pathList<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">=</span> oldPathList <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// $flow-disable-line</span>
  <span class="token keyword">const</span> pathMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token operator">=</span> oldPathMap <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// $flow-disable-line</span>
  <span class="token keyword">const</span> nameMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token operator">=</span> oldNameMap <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 遍历路由配置对象，生成/添加路由记录</span>

  routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ensure wildcard routes are always at the end // 确保path:*永远在在最后</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> pathList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pathList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pathList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      l<span class="token operator">--</span><span class="token punctuation">;</span>
      i<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token comment">// 开发环境，提示非嵌套路由的path必须以/或者*开头</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// warn if routes do not include leading slashes</span>
    <span class="token keyword">const</span> found <span class="token operator">=</span> pathList <span class="token comment">// check for missing leading slash</span>
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> path <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'*'</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'/'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>found<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> pathNames <span class="token operator">=</span> found<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Non-nested routes must include a leading slash character. Fix the following routes: \n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pathNames<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    pathList<span class="token punctuation">,</span>
    pathMap<span class="token punctuation">,</span>
    nameMap<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>可以看到 <code>createRouteMap</code> 返回一个对象，它包含 <code>pathList</code>、<code>pathMap</code> 和 <code>nameMap</code></p> <ul><li><code>pathList</code> 中存储了 <code>routes</code> 中的所有 <code>path</code></li> <li><code>pathMap</code> 维护的是 <code>path</code> 和 <code>路由记录 RouteRecord</code> 的映射</li> <li><code>nameMap</code> 维护的是 <code>name</code> 和 <code>路由记录 RouteRecord</code> 的映射</li></ul> <p>因为 VueRouter 支持命名路由<br>
后两者，都是为了快速找到对应的<code>路由记录</code></p> <p>可以看下使用下面的 routes 调用 createRouteMap 会返回什么</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Home <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> Foo<span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'child'</span><span class="token punctuation">,</span>
        component<span class="token operator">:</span> FooChild<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/bar/:dynamic'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Bar <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>route-map-obj.png<br> <img src="/images/vuesourcecode/vue-router/vue-router12.awebp" alt="vuesourcecode/vue-router/vue-router12.awebp"></p> <ul><li>由于没有命名路由，所以 <code>nameMap</code> 为空</li> <li><code>pathList</code> 存储了所有 <code>path</code>，有个为空，其实是<code>/</code>，在 <code>normalizePath</code> 时被删除</li> <li><code>pathMap</code> 记录了每个 <code>path</code> 和对应 <code>RouteRecord</code> 的映射关系</li></ul> <p><strong>小结</strong></p> <ul><li>VueRouter 的路由映射表由三部分组成:<code>pathList</code>、<code>pathMap</code>、<code>nameMap</code>；后两者是用来快速查找的</li> <li>createRouteMap 的逻辑
<ul><li>先判断路由相关映射表是否已经存在，若存在则使用，否则新建；<br>
这就实现了 <code>createRouteMap</code> 创建/新增的双重功能</li> <li>然后遍历 <code>routes</code>，依次为每个 <code>route</code> 调用 <code>addRouteRecord</code> 生成一个 <code>RouteRecord</code> 并更新 <code>pathList</code>、<code>pathMap</code> 和 <code>nameMap</code></li> <li>由于 pathList 在后续逻辑会用来遍历匹配，为了性能，所以需要将 <code>path:*</code>放置到 <code>pathList</code> 的最后</li> <li>最后检查非嵌套路由的 <code>path</code> 是否是以<code>/</code>或者<code>*</code>开头
<img src="/images/vuesourcecode/vue-router/vue-router13.awebp" alt="vuesourcecode/vue-router/vue-router13.awebp"></li></ul></li></ul> <h3 id="addrouterecord"><a href="#addrouterecord" class="header-anchor">#</a> addRouteRecord</h3> <p>这个方法主要是创建路由记录并更新路由映射表<br>
位于 <code>src/create-route-map.js</code></p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/create-route-map.js</span>

<span class="token comment">// 添加路由记录，更新pathList、pathMap、nameMap</span>
<span class="token keyword">function</span> <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>
  pathList<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  pathMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  nameMap<span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  route<span class="token operator">:</span> RouteConfig<span class="token punctuation">,</span>
  parent<span class="token operator">?</span><span class="token operator">:</span> RouteRecord<span class="token punctuation">,</span> <span class="token comment">// 父路由时记录</span>
  matchAs<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token comment">// 处理别名路由时使用</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// route.path不能为空</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>path <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;path&quot; is required in a route configuration.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// route.component不能为string</span>

    <span class="token function">assert</span><span class="token punctuation">(</span>
      <span class="token keyword">typeof</span> route<span class="token punctuation">.</span>component <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">route config &quot;component&quot; for path: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>
        path <span class="token operator">||</span> name
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> cannot be a </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">string id. Use an actual component instead.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> pathToRegexpOptions<span class="token operator">:</span> PathToRegexpOptions <span class="token operator">=</span>
    route<span class="token punctuation">.</span>pathToRegexpOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 生成格式化后的path(子路由会拼接上父路由的path)</span>

  <span class="token keyword">const</span> normalizedPath <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>
    path<span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    pathToRegexpOptions<span class="token punctuation">.</span>strict
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 匹配规则是否大小写敏感？(默认值：false)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> route<span class="token punctuation">.</span>caseSensitive <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pathToRegexpOptions<span class="token punctuation">.</span>sensitive <span class="token operator">=</span> route<span class="token punctuation">.</span>caseSensitive<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// 生成一条路由记录</span>

  <span class="token keyword">const</span> record<span class="token operator">:</span> RouteRecord <span class="token operator">=</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> normalizedPath<span class="token punctuation">,</span>
    regex<span class="token operator">:</span> <span class="token function">compileRouteRegex</span><span class="token punctuation">(</span>normalizedPath<span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 利用path-to-regexp包生成用来匹配path的增强正则对象，可以用来匹配动态路由</span>
    components<span class="token operator">:</span> route<span class="token punctuation">.</span>components <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> route<span class="token punctuation">.</span>component <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 保存路由组件，支持命名视图https://router.vuejs.org/zh/guide/essentials/named-views.html#命名视图</span>
    instances<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 保存router-view实例</span>
    name<span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    matchAs<span class="token punctuation">,</span>
    redirect<span class="token operator">:</span> route<span class="token punctuation">.</span>redirect<span class="token punctuation">,</span> <span class="token comment">// 重定向的路由配置对象</span>
    beforeEnter<span class="token operator">:</span> route<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span> <span class="token comment">// 路由独享的守卫</span>
    meta<span class="token operator">:</span> route<span class="token punctuation">.</span>meta <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 元信息</span>
    <span class="token comment">// 动态路由传参；https://router.vuejs.org/zh/guide/essentials/passing-props.html#路由组件传参</span>
    props<span class="token operator">:</span>
      route<span class="token punctuation">.</span>props <span class="token operator">==</span> <span class="token keyword">null</span>
        <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token operator">:</span> route<span class="token punctuation">.</span>components <span class="token comment">// 命名视图的传参规则需要使用route.props指定的规则</span>
        <span class="token operator">?</span> route<span class="token punctuation">.</span>props
        <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> route<span class="token punctuation">.</span>props <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 处理有子路由情况</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Warn if route is named, does not redirect and has a default child route.</span>
    <span class="token comment">// If users navigate to this route by name, the default child will</span>
    <span class="token comment">// not be rendered (GH Issue #629)</span>
    <span class="token comment">// https://github.com/vuejs/vue-router/issues/629</span>
    <span class="token comment">// 命名路由 &amp;&amp; 未使用重定向 &amp;&amp; 子路由配置对象path为''或/时，使用父路由的name跳转时，子路由将不会被渲染</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        route<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>route<span class="token punctuation">.</span>redirect <span class="token operator">&amp;&amp;</span>
        route<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Named Route '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>route<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' has a default child route. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">When navigating to this named route (:to=&quot;{name: '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>route<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'&quot;), </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">the default child route will not be rendered. Remove the name from </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this route and use the name of the default child route for named </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">links instead.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token comment">// 遍历生成子路由记录</span>

    route<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> childMatchAs <span class="token operator">=</span> matchAs <span class="token comment">// matchAs若有值，代表当前路由是别名路由，则需要单独生成别名路由的子路由，路径前缀需使用matchAs</span>
        <span class="token operator">?</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>matchAs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>child<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
      <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> child<span class="token punctuation">,</span> record<span class="token punctuation">,</span> childMatchAs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// 若pathMap中不存在当前路径，则更新pathList和pathMap</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pathList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> record<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// 处理别名；https://router.vuejs.org/zh/guide/essentials/redirect-and-alias.html#%E5%88%AB%E5%90%8D</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> aliases <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">)</span> <span class="token operator">?</span> route<span class="token punctuation">.</span>alias <span class="token operator">:</span> <span class="token punctuation">[</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// alias支持string，和Array&lt;String&gt;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> aliases<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> alias <span class="token operator">=</span> aliases<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> alias <span class="token operator">===</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// alias的值和path重复，需要给提示</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Found an alias with the same value as the path: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. You have to remove that alias. It will be ignored in development.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// skip in dev to make it work</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token comment">// 生成别名路由配置对象</span>

      <span class="token keyword">const</span> aliasRoute <span class="token operator">=</span> <span class="token punctuation">{</span>
        path<span class="token operator">:</span> alias<span class="token punctuation">,</span>
        children<span class="token operator">:</span> route<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 添加别名路由记录</span>

      <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>
        pathList<span class="token punctuation">,</span>
        pathMap<span class="token punctuation">,</span>
        nameMap<span class="token punctuation">,</span>
        aliasRoute<span class="token punctuation">,</span> <span class="token comment">// 别名路由</span>
        parent<span class="token punctuation">,</span> <span class="token comment">// 当前路由的父路由，因为是给当前路由取了个别名，所以二者其实是有同个父路由的</span>
        record<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span> <span class="token comment">// matchAs，用来生成别名路由的子路由；</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ! 总结：当前路由设置了alias后，会单独为当前路由及其所有子路由生成路由记录，且子路由的path前缀为matchAs(即别名路由的path)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token comment">// 处理命名路由</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更新nameMap</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> record<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>matchAs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 路由重名警告</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Duplicate named routes definition: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{ name: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;, path: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; }</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br></div></div><p>看下逻辑</p> <ul><li>检查了路由规则中的 <code>path</code> 和 <code>component</code></li> <li>生成 <code>path-to-regexp</code> 的选项 <code>pathToRegexpOptions</code></li> <li>格式化 <code>path</code>，如果是嵌套路由，则会追加上父路由的 <code>path</code></li> <li>生成路由记录</li> <li>处理嵌套路由，递归生成子路由记录</li> <li>更新 <code>pathList</code>、<code>pathMap</code></li> <li>处理别名路由，生成别名路由记录</li> <li>处理命名路由，更新 <code>nameMap</code></li></ul> <p>我们来看下几个核心逻辑</p> <ol><li><p><strong>路由记录</strong></p> <ul><li><p>路由记录记录了路由的核心信息</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> record<span class="token operator">:</span> RouteRecord <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> normalizedPath<span class="token punctuation">,</span> <span class="token comment">// 规范化后的路径</span>
  regex<span class="token operator">:</span> <span class="token function">compileRouteRegex</span><span class="token punctuation">(</span>normalizedPath<span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 利用path-to-regexp包生成用来匹配path的增强正则对象，可以用来匹配动态路由</span>
  components<span class="token operator">:</span> route<span class="token punctuation">.</span>components <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> route<span class="token punctuation">.</span>component <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 保存路由组件，支持命名视图https://router.vuejs.org/zh/guide/essentials/named-views.html#命名视图</span>
  instances<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 保存router-view实例</span>
  name<span class="token punctuation">,</span>
  parent<span class="token punctuation">,</span> <span class="token comment">// 父路由记录</span>
  matchAs<span class="token punctuation">,</span> <span class="token comment">// 别名路由需要使用</span>
  redirect<span class="token operator">:</span> route<span class="token punctuation">.</span>redirect<span class="token punctuation">,</span> <span class="token comment">// 重定向的路由配置对象</span>
  beforeEnter<span class="token operator">:</span> route<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span> <span class="token comment">// 路由独享的守卫</span>
  meta<span class="token operator">:</span> route<span class="token punctuation">.</span>meta <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 元信息</span>
  <span class="token comment">// 动态路由传参；https://router.vuejs.org/zh/guide/essentials/passing-props.html#路由组件传参</span>
  props<span class="token operator">:</span>
    route<span class="token punctuation">.</span>props <span class="token operator">==</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token operator">:</span> route<span class="token punctuation">.</span>components <span class="token comment">// 命名视图的传参规则需要使用route.props指定的规则</span>
      <span class="token operator">?</span> route<span class="token punctuation">.</span>props
      <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> route<span class="token punctuation">.</span>props <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></li> <li><p>路由记录有个 <code>regex</code> 字段，它是一个增强的正则表达式，它是实现动态路由匹配的关键</p></li> <li><p><code>regex</code> 是通过 <code>compileRouteRegex</code> 方法返回的，它里面调用了 <code>path-to-regexp</code></p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> Regexp <span class="token keyword">from</span> <span class="token string">'path-to-regexp'</span>

<span class="token operator">...</span>

<span class="token comment">// 使用path-to-regexp包，生成route对应的正则，可以用来生成动态路由需要的正则表达式</span>
<span class="token keyword">function</span> <span class="token function">compileRouteRegex</span> <span class="token punctuation">(</span>
  path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  pathToRegexpOptions<span class="token operator">:</span> PathToRegexpOptions
<span class="token punctuation">)</span><span class="token operator">:</span> RouteRegExp <span class="token punctuation">{</span>

  <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token function">Regexp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> keys<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    regex<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 重复key浸膏</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token operator">!</span>keys<span class="token punctuation">[</span>key<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Duplicate param keys in route with path: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
      keys<span class="token punctuation">[</span>key<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> regex
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></li> <li><p>我们看下 path-to-regexp 是如何使用的
<a href="https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fpath-to-regexp">官网是:www.npmjs.com/package/pat…</a></p></li> <li><p><code>Regexp</code> 接收三个参数 <code>path</code>，<code>keys</code>，<code>options</code>；</p> <ul><li><p><code>path</code> 为需要转换为正则的路径，</p></li> <li><p><code>keys</code> 是用来接收在 path 中找到的 key，可以传入，也可以直接使用返回值上的 keys 属性，</p></li> <li><p><code>options</code> 为选项</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> pathToRegexp <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'path-to-regexp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> regexp <span class="token operator">=</span> <span class="token function">pathToRegexp</span><span class="token punctuation">(</span><span class="token string">'/foo/:bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// regexp = /^\/foo\/([^\/]+?)\/?$/i</span>
<span class="token comment">// :bar被处理成正则的一个组了，当正则被执行时，就可以通过组取到bar对应的值</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>regexp<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// keys = [{ name: 'bar', prefix: '/', suffix: '', pattern: '[^\\/#\\?]+?', modifier: '' }]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul></li> <li><p>通过下面的例子，就可以知道动态路由获取参数值是如何实现的</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// test.js</span>

<span class="token keyword">const</span> pathToRegexp <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'path-to-regexp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> regexp <span class="token operator">=</span> <span class="token function">pathToRegexp</span><span class="token punctuation">(</span><span class="token string">'/foo/:bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>regexp<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录了key信息</span>

<span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token string">'/foo/test'</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regexp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 正则的组记录了value信息</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'key:'</span><span class="token punctuation">,</span> regexp<span class="token punctuation">.</span>keys<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">',value:'</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>path-to-regex-demo.png<br> <img src="/images/vuesourcecode/vue-router/vue-router14.awebp" alt="vuesourcecode/vue-router/vue-router14.awebp"></p></li></ul></li> <li><p><strong>生成嵌套路由记录</strong>
我们知道 <code>vue-router</code> 是支持嵌套路由的，我们来看看是如何生成嵌套路由记录的</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/create-route-map</span>

<span class="token comment">// 处理有子路由情况</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Warn if route is named, does not redirect and has a default child route.</span>
  <span class="token comment">// If users navigate to this route by name, the default child will</span>
  <span class="token comment">// not be rendered (GH Issue #629)</span>
  <span class="token comment">// https://github.com/vuejs/vue-router/issues/629</span>
  <span class="token comment">// 命名路由 &amp;&amp; 未使用重定向 &amp;&amp; 子路由配置对象path为''或/时，使用父路由的name跳转时，子路由将不会被渲染</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      route<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>route<span class="token punctuation">.</span>redirect <span class="token operator">&amp;&amp;</span>
      route<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Named Route '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>route<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' has a default child route. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">When navigating to this named route (:to=&quot;{name: '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>route<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'&quot;), </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">the default child route will not be rendered. Remove the name from </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">this route and use the name of the default child route for named </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">links instead.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token comment">// 遍历生成子路由记录</span>
  route<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> childMatchAs <span class="token operator">=</span> matchAs <span class="token comment">// matchAs若有值，代表当前路由是别名路由，则需要单独生成别名路由的子路由，路径前缀需使用matchAs</span>
      <span class="token operator">?</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>matchAs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>child<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> child<span class="token punctuation">,</span> record<span class="token punctuation">,</span> childMatchAs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><ul><li><p>首先针对 <code>#629</code> 问题做出了警告提示<br>
#629 问题主要是 当一个路由是 <code>命名路由 &amp;&amp; 未使用重定向 &amp;&amp; 子路由配置对象path为''或/</code>时，使用父路由的 <code>name</code> 跳转时，子路由将不会被渲染</p></li> <li><p>然后遍历子路由规则列表，生成子路由记录<br>
这里面还处理了别名路由的子路由情况: 遍历时如果发现父路由被标记为别名路由，则子路由的 path 前面需要加上父路由的 path，然后再生成记录</p></li> <li><p>我们可以看下下面的嵌套路由，生成的路由映射表长什么样</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/parent'</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> Parent<span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>nested-route.png
<img src="/images/vuesourcecode/vue-router/vue-router15.awebp" alt="vuesourcecode/vue-router/vue-router15.awebp"></p></li> <li><p>可以看到，子路由的 <code>path</code> 会前追加上父路由的 <code>path</code></p></li></ul></li> <li><p><strong>生成别名路由记录</strong></p> <ul><li><p><code>VueRouter</code>支持给路由设置别名；<code>/a</code> 的别名是 <code>/b</code>，意味着，当用户访问 <code>/b</code> 时，<code>URL</code> 会保持为 <code>/b</code>，但是路由匹配则为 <code>/a</code>，就像用户访问 <code>/a</code> 一样</p></li> <li><p>我们来看看椒如何生成别名路由记录的</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/create-route-map.js</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> aliases <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">)</span> <span class="token operator">?</span> route<span class="token punctuation">.</span>alias <span class="token operator">:</span> <span class="token punctuation">[</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// alias支持string，和Array&lt;String&gt;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> aliases<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> alias <span class="token operator">=</span> aliases<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> alias <span class="token operator">===</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// alias的值和path重复，需要给提示</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Found an alias with the same value as the path: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. You have to remove that alias. It will be ignored in development.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// skip in dev to make it work</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token comment">// 生成别名路由配置对象</span>

    <span class="token keyword">const</span> aliasRoute <span class="token operator">=</span> <span class="token punctuation">{</span>
      path<span class="token operator">:</span> alias<span class="token punctuation">,</span>
      children<span class="token operator">:</span> route<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 添加别名路由记录</span>

    <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>
      pathList<span class="token punctuation">,</span>
      pathMap<span class="token punctuation">,</span>
      nameMap<span class="token punctuation">,</span>
      aliasRoute<span class="token punctuation">,</span> <span class="token comment">// 别名路由</span>
      parent<span class="token punctuation">,</span> <span class="token comment">// 当前路由的父路由，因为是给当前路由取了个别名，所以二者其实是有同个父路由的</span>
      record<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span> <span class="token comment">// matchAs，用来生成别名路由的子路由；</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ! 总结：当前路由设置了alias后，会单独为当前路由及其所有子路由生成路由记录，且子路由的path前缀为matchAs(即别名路由的path)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div></li> <li><p>别名是支持单别名和多别名的，即<code>route.alias</code>支持传入<code>/foo</code>或<code>['/foo','/bar']</code>，所以先对这两种情况做了归一处理，统一处理成数组</p></li> <li><p>然后遍历这个数组，先检查别名和<code>path</code>是否重复，然后单独为别名路由生成一份配置传入，最后调用<code>addRouteRecord</code>生成别名路由记录
注意此处还通过<code>matchAs</code>处理了别名路由生成子路由的场景，主要通过设置<code>matchAs</code>为<code>record.path || '/'</code>，然后在生成子路由记录时，会根据<code>matchAs</code>生成别名路由记录的子记录，具体可看上面的嵌套路由章节</p></li> <li><p>我们看看，别名路由生成的的路由映射表长什么样</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/root'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Root<span class="token punctuation">,</span> alias<span class="token operator">:</span> <span class="token string">'/root-alias'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/home'</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> Home<span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Bar<span class="token punctuation">,</span> alias<span class="token operator">:</span> <span class="token string">'bar-alias'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'baz'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Baz<span class="token punctuation">,</span> alias<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/baz'</span><span class="token punctuation">,</span> <span class="token string">'baz-alias'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>alias-route.png
<img src="/images/vuesourcecode/vue-router/vue-router16.awebp" alt="vuesourcecode/vue-router/vue-router16.awebp"></p></li> <li><p>可以看到为别名路由和别名路由的子路由都单独生成了一条路由记录</p></li></ul></li> <li><p><strong>小结</strong></p> <ul><li>路由记录是<code>路由映射表</code>的重要组成部分
路由记录中的<code>regex</code>是处理动态路由传参的关键字段，主要是借助<code>path-to-regexp</code>实现的</li> <li>生成路由记录主要考虑了下面几种路由记录的生成
<ul><li>嵌套路由
子路由单独生成一条路由记录</li> <li>别名路由及别名路由子路由
别名路由及其子路由分别会生成一条路由记录</li> <li>命名路由</li></ul></li> <li>生成路由记录的整个流程如下图所示</li> <li>add-route-record.png
<img src="/images/vuesourcecode/vue-router/vue-router17.awebp" alt="vuesourcecode/vue-router/vue-router17.awebp"></li></ul></li></ol> <h3 id="路由模式"><a href="#路由模式" class="header-anchor">#</a> 路由模式</h3> <p>前端路由一个很重要的特性是要实现无刷新切换页面, 即 url 改变，页面不刷新实现页面的跳转</p> <p>要实现这一点，有两种方案<br>
一种<code>hash+hashChange</code>，另一种利用<code>History API</code>的<code>pushState+popState</code></p> <p>前者主要利用 <code>hash</code> 改变时页面不会刷新并会触发 <code>hashChange</code> 这个特性来实现前端路由<br>
后者充分利用了 <code>HTML5 History API</code> 的 <code>pushState</code> 方法和 <code>popState</code> 事件来实现前端路由</p> <p>二者比较</p> <ul><li>hash
<ul><li>兼容性好，<code>hashChange</code>支持到<code>IE8</code></li> <li><code>url</code>中会携带<code>/#/</code>，不美观</li> <li>不需要服务端改造</li></ul></li> <li>history
<ul><li>兼容到 IE10</li> <li>url 跟正常 url 一样</li> <li>由于其 url 跟正常 url 一样，所以在刷新时，会以此 url 为链接请求服务端页面，而服务端是没有这个页面的，会 404，因此需要服务端配合将所有请求重定向到首页，将整个路由的控制交给前端路由</li></ul></li></ul> <p>VueRouter 支持三种路由模式，分别为 <code>hash</code>、<code>history</code>、<code>abstract</code></p> <ul><li><code>hash</code> 模式就是第一种方案的实现</li> <li><code>history</code> 模式是第二种方案的实现</li> <li><code>abstract</code> 模式是用在非浏览器环境的，主要用于 <code>SSR</code></li></ul> <ol><li><p><strong>核心类</strong></p> <ul><li>VueRouter 的三种路由模式，主要由下面的三个核心类实现</li> <li>History
<ul><li>基础类</li> <li>位于<code>src/history/base.js</code></li></ul></li> <li>HTML5History
<ul><li>用于支持 pushState 的浏览器</li> <li><code>src/history/html5.js</code></li></ul></li> <li>HashHistory
<ul><li>用于不支持 pushState 的浏览器</li> <li><code>src/history/hash.js</code></li></ul></li> <li>AbstractHistory
<ul><li>用于非浏览器环境(服务端渲染)</li> <li><code>src/history/abstract.js</code></li></ul></li> <li>通过下面这张图，可以了解到他们之间的关系 route-mode-class.png
<img src="/images/vuesourcecode/vue-router/vue-router18.awebp" alt="vuesourcecode/vue-router/vue-router18.awebp"></li> <li><code>HTML5History</code>、<code>HashHistory</code>、<code>AbstractHistory</code> 三者都是继承于基础类 <code>History</code>；</li> <li>三者不光能访问 <code>History</code> 类的所有属性和方法，他们还都实现了基础类中声明的需要子类实现的 5 个接口(<code>go</code>、<code>push</code>、<code>replace</code>、<code>ensureURL</code>、<code>getCurrentLocation</code>)</li> <li>由于 <code>HashHistory</code> 监听 <code>hashChange</code> 的特殊性，所以会单独多一个 <code>setupListeners</code> 方法</li> <li><code>AbstractHistory</code> 由于需要在非浏览器环境使用，没有历史记录栈，所以只能通过 <code>index</code>、<code>stack</code> 来模拟</li> <li>前面我们分析 VueRouter 实例化过程时，知道 VueRouter 会在确定完路由模式后，会实例化不同的 History 实例</li> <li>那我们来看看不同 History 的实例化过程</li></ul></li> <li><p><strong>History 类</strong></p> <ul><li><p>它是父类(基类)，其它类都是继承它的</p></li> <li><p>代码位于<code>src/history/base.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/history/base.js</span>
<span class="token comment">// 父类</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
  router<span class="token operator">:</span> Router
  base<span class="token operator">:</span> string
  current<span class="token operator">:</span> Route
  pending<span class="token operator">:</span> <span class="token operator">?</span>Route
  <span class="token function-variable function">cb</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">r</span><span class="token operator">:</span> Route</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  ready<span class="token operator">:</span> boolean
  readyCbs<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span>
  readyErrorCbs<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span>
  errorCbs<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span>

  <span class="token comment">// implemented by sub-classes</span>
  <span class="token comment">// 需要子类(HTML5History、HashHistory)实现的方法</span>
  <span class="token operator">+</span><span class="token function-variable function">go</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">n</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token operator">+</span><span class="token function-variable function">push</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">loc</span><span class="token operator">:</span> RawLocation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token operator">+</span><span class="token function-variable function">replace</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">loc</span><span class="token operator">:</span> RawLocation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token operator">+</span><span class="token function-variable function">ensureURL</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">push<span class="token operator">?</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token operator">+</span><span class="token function-variable function">getCurrentLocation</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> string

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">router</span><span class="token operator">:</span> Router<span class="token punctuation">,</span> base<span class="token operator">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router <span class="token operator">=</span> router
    <span class="token comment">// 格式化base，保证base是以/开头</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>base <span class="token operator">=</span> <span class="token function">normalizeBase</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
    <span class="token comment">// start with a route object that stands for &quot;nowhere&quot;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token constant">START</span> <span class="token comment">// 当前指向的route对象，默认为START；即from</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 记录将要跳转的route；即to</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  
  <span class="token operator">...</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div></li> <li><p>可以看到，构造函数中主要干了下面几件事</p> <ul><li>保存了<code>router</code>实例</li> <li>规范化了<code>base</code>，确保<code>base</code>是以<code>/</code>开头</li> <li>初始化了当前路由指向，默认只想<code>START</code>初始路由；在路由跳转时，<code>this.current</code>代表的是<code>from</code></li> <li>初始化了路由跳转时的下个路由，默认为<code>null</code>；在路由跳转时，<code>this.pending</code>代表的是<code>to</code></li> <li>初始化了一些回调相关的属性</li></ul></li> <li><p><code>START</code>定义在<code>src/utils/route.js</code>中</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/utils/route.js</span>
<span class="token comment">// 初始路由</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">START</span> <span class="token operator">=</span> <span class="token function">createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>History 类的实例化过程如下 history.png
<img src="/images/vuesourcecode/vue-router/vue-router19.awebp" alt="vuesourcecode/vue-router/vue-router19.awebp"></p></li></ul></li> <li><p><strong>HTML5History 类</strong></p> <ul><li><p>我们再看看<code>HTML5History</code>类,它是继承自 History 类, 位于<code>src/history/html5.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HTML5History</span> <span class="token keyword">extends</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">router</span><span class="token operator">:</span> Router<span class="token punctuation">,</span> <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化父类History</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检测是否需要支持scroll</span>

    <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior<span class="token punctuation">;</span>
    <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll<span class="token punctuation">;</span> <span class="token comment">// 若支持scroll,初始化scroll相关逻辑</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setupScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token comment">// 获取初始location</span>

    <span class="token keyword">const</span> initLocation <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 监听popstate事件</span>

    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">;</span> <span class="token comment">// Avoiding first `popstate` event dispatched in some browsers but first // history route not updated since async guard at the same time. // 某些浏览器，会在打开页面时触发一次popstate</span>

      <span class="token comment">// 此时如果初始路由是异步路由,就会出现`popstate`先触发,初始路由后解析完成，进而导致route未更新</span>
      <span class="token comment">// 所以需要避免</span>
      <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> <span class="token constant">START</span> <span class="token operator">&amp;&amp;</span> location <span class="token operator">===</span> initLocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token comment">// 路由地址发生变化，则跳转，并在跳转后处理滚动</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">route</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleScroll</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div></li> <li><p>可以看到其是继承于<code>History类</code>，所以在构造函数中调用了父类构造函数(<code>super(router,base)</code>)</p></li> <li><p>检查了是否需要支持滚动行为，如果支持，则初始化滚动相关逻辑</p></li> <li><p>监听了<code>popstate</code>事件，并在<code>popstate</code>触发时，调用<code>transitionTo</code>方法实现跳转</p></li> <li><p>注意这里处理了一个异常场景</p> <ul><li>某些浏览器下，打开页面会触发一次<code>popstate</code>，此时如果路由组件是异步的，就会出现<code>popstate</code>事件触发了，但异步组件还没解析完成，最后导致<code>route</code>没有更新</li> <li>所以对这种情况做了屏蔽</li></ul></li> <li><p>关于滚动和路由跳转后面有专门章节会讲</p></li> <li><p>HTML5History 类的实例化过程如下 h5history.png
<img src="/images/vuesourcecode/vue-router/vue-router20.awebp" alt="vuesourcecode/vue-router/vue-router20.awebp"></p></li></ul></li> <li><p><strong>HashHistory 类</strong></p> <ul><li><p>位于 src/history/hash.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/history/hash.js</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HashHistory</span> <span class="token keyword">extends</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">router</span><span class="token operator">:</span> Router<span class="token punctuation">,</span> <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token operator">?</span>string<span class="token punctuation">,</span> <span class="token literal-property property">fallback</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 实例化父类</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// check history fallback deeplinking // fallback只有在指明了mode为history，但是浏览器又不支持popstate，用户手动指明了fallback为true时，才为true，其它情况为false // 如果需要回退，则将url换为hash模式(/#开头) // this.base来自父类</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fallback <span class="token operator">&amp;&amp;</span> <span class="token function">checkFallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ensureSlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p>它继承于<code>History</code>，所以也调用了<code>super(router,base)</code></p></li> <li><p>检查了<code>fallback</code>，看是否需要回退，前面说过，传入的<code>fallback</code>只有在用户设置了<code>history</code>且又不支持<code>pushState</code>并且启用了回退时才为<code>true</code></p></li> <li><p>所以，此时，需要将<code>history</code>模式的 url 替换成<code>hash</code>模式，即添加上<code>#</code>，这个逻辑是由<code>checkFallback</code>实现的</p></li> <li><p>如果不是<code>fallback</code>，则直接调用<code>ensureSlash</code>，确保<code>url</code>是以<code>/</code>开头的</p></li> <li><p>我们看下<code>checkFallback</code>、<code>ensureSlash</code>实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/history/hash.js</span>

<span class="token comment">/**
 * 检查回退，将url转换为hash模式(添加/#)
 */</span>
<span class="token keyword">function</span> <span class="token function">checkFallback</span><span class="token punctuation">(</span><span class="token parameter">base</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 地址不以/#开头，则添加之</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/#</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">cleanPath</span><span class="token punctuation">(</span>base <span class="token operator">+</span> <span class="token string">'/#'</span> <span class="token operator">+</span> location<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这一步实现了url替换</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 确保url是以/开头
 */</span>
<span class="token keyword">function</span> <span class="token function">ensureSlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">replaceHash</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 替换hash记录</span>
<span class="token keyword">function</span> <span class="token function">replaceHash</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 支持pushState，则优先使用replaceState</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div></li> <li><p>是不是发现<code>HashHistory</code>少了滚动支持和监听<code>hashChange</code>相关逻辑，这是因为<code>hashChange</code>存在一些特殊场景，需要等到<code>mounts</code>后才能监听
这一块的逻辑全放在了<code>setupListeners</code>方法中，<code>setupListeners</code>会在<code>VueRouter</code>调用<code>init</code>时被调用，这个我们在初始化章节再看</p></li> <li><p><code>HashHistory类</code>的实例化过程如下 hash-history.png
<img src="/images/vuesourcecode/vue-router/vue-router21.awebp" alt="vuesourcecode/vue-router/vue-router21.awebp"></p></li></ul></li> <li><p><strong>AbstractHistory 类</strong></p> <ul><li><p>AbstractHistory 是用于非浏览器环境的, 位于 src/history/abstract.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/history/abstract.js</span>

<span class="token comment">/**
 * 支持所有 JavaScript 运行环境，如 Node.js 服务器端。如果发现没有浏览器的 API，路由会自动强制进入这个模式
 *
 * @export
 * @class AbstractHistory
 * @extends {History}
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AbstractHistory</span> <span class="token keyword">extends</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">router</span><span class="token operator">:</span> Router<span class="token punctuation">,</span> <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化父类</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li> <li><p>可以看到它的实例化是最简单的，只初始化了父类，并对<code>index</code>、<code>stack</code>做了初始化</p></li> <li><p>前面说过，非浏览器环境，是没有历史记录栈的，所以使用 index、stack 来模拟历史记录栈</p></li> <li><p><code>AbstractHistory</code>类的实例化过程如下 abstract-history.png<br> <img src="/images/vuesourcecode/vue-router/vue-router22.awebp" alt="vuesourcecode/vue-router/vue-router22.awebp"></p></li></ul></li> <li><p><strong>小结</strong></p> <ul><li>这一小节我们对三种路由模式做了简单分析，并且还一起看了实现这三种路由模式所需要的 History 类是如何实例化的</li> <li>通过一个图来简单总结下 VueRouter 实例化过程 vue-router-instance.png<br> <img src="/images/vuesourcecode/vue-router/vue-router23.awebp" alt="vuesourcecode/vue-router/vue-router23.awebp"></li></ul></li></ol> <h2 id="初始化流程"><a href="#初始化流程" class="header-anchor">#</a> 初始化流程</h2> <h3 id="调用-init-时机"><a href="#调用-init-时机" class="header-anchor">#</a> 调用 init 时机</h3> <p>在分析安装流程时，我们知道 VueRouter 注册了一个全局混入，混入了<code>beforeCreate</code>钩子<br>
代码如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/install.js</span>

<span class="token comment">// 注册全局混入</span>
Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// 判断是否使用了vue-router插件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token operator">...</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router <span class="token comment">// 保存VueRouter实例，this.$options.router仅存在于Vue根实例上，其它Vue组件不包含此属性，所以下面的初始化，只会执行一次</span>
      <span class="token comment">// beforeCreate hook被触发时，调用</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// 初始化VueRouter实例，并传入Vue根实例</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">destroyed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>我们知道全局混入，会影响后续创建的所有 Vue 实例，所以<code>beforeCreate</code>首次触发是在 Vue 根实例实例化的时候即<code>new Vue({router})</code>时</p> <p>触发后调用<code>router</code>实例的<code>init</code>方法并传入<code>Vue根实例</code>，完成初始化流程；<br>
由于<code>router</code>仅存在于<code>Vue根实例</code>的<code>$options</code>上，所以，整个初始化只会被调用一次</p> <h3 id="init-方法"><a href="#init-方法" class="header-anchor">#</a> init 方法</h3> <p>VueRouter 的 init 方法位于<code>src/index.js</code></p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/install.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化,app为Vue根实例</span>
  <span class="token function">init</span><span class="token punctuation">(</span>app<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token comment">/* Vue component instance */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开发环境，确保已经安装VueRouter</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>
        install<span class="token punctuation">.</span>installed<span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">not installed. Make sure to call \`Vue.use(VueRouter)\` </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before creating root instance.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保存实例 // set up app destroyed handler // https://github.com/vuejs/vue-router/issues/2639 // 绑定destroyed hook，避免内存泄露</span>
    app<span class="token punctuation">.</span><span class="token function">$once</span><span class="token punctuation">(</span><span class="token string">'hook:destroyed'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// clean out app from this.apps array once destroyed</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ensure we still have a main app or null if no apps // we do not release the router so it can be reused // 需要确保始终有个主应用</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">===</span> app<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// main app previously initialized // return as we don't need to set up new history listener // main app已经存在，则不需要重复初始化history 的事件监听</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app<span class="token punctuation">;</span>

    <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 若是HTML5History类，则直接调用父类的transitionTo方法，跳转到当前location</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 若是HashHistory，在调用父类的transitionTo方法后，并传入onComplete、onAbort回调</span>
      <span class="token keyword">const</span> <span class="token function-variable function">setupHashListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用HashHistory.setupListeners方法，设置hashchange监听</span>
        <span class="token comment">// 在 route 切换完成之后再设置 hashchange 的监听,</span>
        <span class="token comment">// 修复https://github.com/vuejs/vue-router/issues/725</span>
        <span class="token comment">// 因为如果钩子函数 beforeEnter 是异步的话, beforeEnter 钩子就会被触发两次. 因为在初始化时, 如果此时的 hash 值不是以 / 开头的话就会补上 #/, 这个过程会触发 hashchange 事件, 就会再走一次生命周期钩子, 也就意味着会再次调用 beforeEnter 钩子函数.</span>
        history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
        history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        setupHashListener<span class="token punctuation">,</span> <span class="token comment">// transitionTo的onComplete回调</span>
        setupHashListener <span class="token comment">// transitionTo的onAbort回调</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token comment">// 调用父类的listen方法，添加回调； // 回调会在父类的updateRoute方法被调用时触发，重新为app._route赋值 // 由于app._route被定义为响应式，所以app._route发生变化，依赖app._route的组件(route-view组件)都会被重新渲染</span>

    history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>可以看到，主要做了下面几件事</p> <ul><li>检查了<code>VueRouter</code>是否已经安装</li> <li>保存了挂载<code>router实例</code>的<code>vue实例</code>
VueRouter 支持多实例嵌套，所以存在<code>this.apps</code>来保存持有<code>router实例</code>的<code>vue实例</code></li> <li>注册了一个一次性钩子<code>destroyed</code>，在<code>destroyed</code>时，卸载<code>this.app</code>，避免内存泄露</li> <li>检查了<code>this.app</code>，避免重复事件监听</li> <li>根据<code>history</code>类型，调用<code>transitionTo</code>跳转到不同的初始页面</li> <li>注册<code>updateRoute</code>回调，在<code>router</code>更新时，更新<code>app._route</code>完成页面重新渲染</li></ul> <h3 id="setuplisteners"><a href="#setuplisteners" class="header-anchor">#</a> setupListeners</h3> <p>上面说到，在初始化时，会根据<code>history类型</code>，调用<code>transitionTo</code>跳转到不同的初始页面</p> <p>为什么要跳转初始页面？<br>
因为在初始化时，url 可能指向其它页面，此时需要调用<code>getCurrentLocation</code>方法，从当前 url 上解析出路由，然后跳转之</p> <p>可以看到<code>HTML5History类</code>和<code>HashHistory类</code>调用<code>transitionTo</code>方法的参数不太一样</p> <ul><li>前者只传入了一个参数</li> <li>后者传入了三个参数</li></ul> <p>我们看下 transitionTo 方法的方法签名</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>
<span class="token comment">// src/history/base.js</span>
<span class="token operator">...</span>
<span class="token comment">// 父类</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  
  <span class="token comment">// 路由跳转</span>
  <span class="token function">transitionTo</span> <span class="token punctuation">(</span>
    location<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> <span class="token comment">// 原始location，一个url或者是一个Location interface(自定义形状，在types/router.d.ts中定义)</span>
    onComplete<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> <span class="token comment">// 跳转成功回调</span>
    onAbort<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token comment">// 跳转失败回调</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>   
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>首个参数是需要解析的地址，第二是跳转成功回调，第三个是跳转失败回调</p> <p>我们来看下 <code>HashHistory</code> 类为何需要传入回调</p> <p>可以看到传入的成功、失败回调都是 <code>setupHashListener</code> 函数,<code>setupHashListener</code> 函数内部调用了 <code>history.setupListeners</code> 方法，而这个方法是 <code>HashHistory</code> 类独有的</p> <p>打开<code>src/history/hash.js</code></p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/history/hash.js</span>

  <span class="token comment">// this is delayed until the app mounts</span>
  <span class="token comment">// to avoid the hashchange listener being fired too early</span>
  <span class="token comment">// 修复#725;https://github.com/vuejs/vue-router/issues/725</span>
  <span class="token comment">// 因为如果钩子函数 beforeEnter 是异步的话, beforeEnter 钩子就会被触发两次. 因为在初始化时, 如果此时的 hash 值不是以 / 开头的话就会补上 #/, 这个过程会触发 hashchange 事件, 就会再走一次生命周期钩子, 也就意味着会再次调用 beforeEnter 钩子函数.</span>
  <span class="token function">setupListeners</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router
    <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior
    <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll
    <span class="token comment">// 若支持scroll,初始化scroll相关逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setupScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 添加事件监听</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      supportsPushState <span class="token operator">?</span> <span class="token string">'popstate'</span> <span class="token operator">:</span> <span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token comment">// 优先使用popstate</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ensureSlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span><span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> route <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> <span class="token comment">/* to*/</span>route<span class="token punctuation">,</span> <span class="token comment">/* from*/</span>current<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 不支持pushState，直接替换记录</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">replaceHash</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>主要逻辑如下</p> <ul><li><code>setupListeners</code>主要判断了是否需要支持滚动行为，如果支持，则初始化相关逻辑</li> <li>然后添加 url 变化事件监听，之前说过实现路由有两种方案<code>pushState+popState</code>、<code>hash+hashChange</code></li> <li>可以看到这里即使是<code>HashHistory</code>也会优先使用<code>popstate</code>事件来监听 url 的变化</li> <li>当 url 发生变化时，会调用 transitionTo 跳转新路由</li> <li>可以看到这一块的逻辑和 HTML5History 类在实例化时处理的逻辑很类似</li></ul> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/history/html5.js</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HTML5History</span> <span class="token keyword">extends</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span>router<span class="token operator">:</span> Router<span class="token punctuation">,</span> base<span class="token operator">:</span> <span class="token operator">?</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    <span class="token comment">// 检测是否需要支持scroll</span>
    <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior
    <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll

    <span class="token comment">// 若支持scroll,初始化scroll相关逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setupScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取初始location</span>
    <span class="token keyword">const</span> initLocation <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>
    <span class="token comment">// 监听popstate事件</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token operator">...</span>

      <span class="token comment">// 路由地址发生变化，则跳转，并在跳转后处理滚动</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> route <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleScroll</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>那为何二者处理的时机不同呢？</p> <ul><li><code>HTML5Histroy</code>在实例化时监听事件</li> <li><code>HashHistory</code>在初次路由跳转结束后监听事件</li></ul> <p>这是为了修复<a href="https%3A%2F%2Fgithub.com%2Fvuejs%2Fvue-router%2Fissues%2F725">#725 问题</a></p> <ul><li>如果 <code>beforeEnter</code> 是异步的话，<code>beforeEnter</code> 就会触发两次，这是因为在初始化时，<code>hash</code>  值不是  <code>/</code>  开头的话就会补上<code>#/</code>，这个过程会触发  <code>hashchange</code>  事件，所以会再走一次生命周期钩子，导致再次调用 <code>beforeEnter</code> 钩子函数。所以只能将 <code>hashChange</code> 事件的监听延迟到初始路由跳转完成后；</li></ul> <h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <p>针对 init 流程，总结了下面的活动图 init.png</p> <img src="/images/vuesourcecode/vue-router/vue-router24.awebp" alt="vuesourcecode/vue-router/vue-router24.awebp"></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vuesourcecode/Vue-Router/01-Vue-Router源码深度剖析.html" class="prev">01-Vue-Router源码深度剖析</a></span> <span class="next"><a href="/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html">03-vue-router源码解析[中]</a>
      →
    </span></p></div> </main> <span data-v-2ae0ee72></span></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bcf15098.js" defer></script><script src="/assets/js/2.c43dd9cb.js" defer></script><script src="/assets/js/3.e6d9e1d5.js" defer></script><script src="/assets/js/188.c35b8b85.js" defer></script>
  </body>
</html>
