<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue-router 源码解析 | 1.5w 字 | 多图预警 - 【中】 | Ailjc notes</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel=" " href=" ">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/luvue/assets/css/0.styles.0c275c11.css" as="style"><link rel="preload" href="/luvue/assets/js/app.50227b6d.js" as="script"><link rel="preload" href="/luvue/assets/js/2.dc297d8e.js" as="script"><link rel="preload" href="/luvue/assets/js/3.51a2d233.js" as="script"><link rel="preload" href="/luvue/assets/js/292.0e4d6a16.js" as="script"><link rel="prefetch" href="/luvue/assets/js/10.4dcff8ef.js"><link rel="prefetch" href="/luvue/assets/js/100.4a463fa3.js"><link rel="prefetch" href="/luvue/assets/js/101.16c4fcf8.js"><link rel="prefetch" href="/luvue/assets/js/102.5b1d6c4c.js"><link rel="prefetch" href="/luvue/assets/js/103.14584991.js"><link rel="prefetch" href="/luvue/assets/js/104.116f4d80.js"><link rel="prefetch" href="/luvue/assets/js/105.81576762.js"><link rel="prefetch" href="/luvue/assets/js/106.5757f0a1.js"><link rel="prefetch" href="/luvue/assets/js/107.011fc1df.js"><link rel="prefetch" href="/luvue/assets/js/108.502e4c8c.js"><link rel="prefetch" href="/luvue/assets/js/109.904aca6f.js"><link rel="prefetch" href="/luvue/assets/js/11.e6154571.js"><link rel="prefetch" href="/luvue/assets/js/110.97e25b5c.js"><link rel="prefetch" href="/luvue/assets/js/111.edcade6b.js"><link rel="prefetch" href="/luvue/assets/js/112.75c283fd.js"><link rel="prefetch" href="/luvue/assets/js/113.ac993ad7.js"><link rel="prefetch" href="/luvue/assets/js/114.1dfc2617.js"><link rel="prefetch" href="/luvue/assets/js/115.a55cebf2.js"><link rel="prefetch" href="/luvue/assets/js/116.e3650879.js"><link rel="prefetch" href="/luvue/assets/js/117.c98d9d80.js"><link rel="prefetch" href="/luvue/assets/js/118.2ef2cb19.js"><link rel="prefetch" href="/luvue/assets/js/119.a56e96cb.js"><link rel="prefetch" href="/luvue/assets/js/12.271e8805.js"><link rel="prefetch" href="/luvue/assets/js/120.ea37c8e9.js"><link rel="prefetch" href="/luvue/assets/js/121.e84aa3eb.js"><link rel="prefetch" href="/luvue/assets/js/122.2809183d.js"><link rel="prefetch" href="/luvue/assets/js/123.ef109ed8.js"><link rel="prefetch" href="/luvue/assets/js/124.d7a754ba.js"><link rel="prefetch" href="/luvue/assets/js/125.e368457d.js"><link rel="prefetch" href="/luvue/assets/js/126.2b1e6d99.js"><link rel="prefetch" href="/luvue/assets/js/127.d197f125.js"><link rel="prefetch" href="/luvue/assets/js/128.1a3bba89.js"><link rel="prefetch" href="/luvue/assets/js/129.43fa9b4c.js"><link rel="prefetch" href="/luvue/assets/js/13.f6b3db37.js"><link rel="prefetch" href="/luvue/assets/js/130.ff13b9c1.js"><link rel="prefetch" href="/luvue/assets/js/131.25eb4de5.js"><link rel="prefetch" href="/luvue/assets/js/132.386f97d9.js"><link rel="prefetch" href="/luvue/assets/js/133.defdd861.js"><link rel="prefetch" href="/luvue/assets/js/134.0aba29a4.js"><link rel="prefetch" href="/luvue/assets/js/135.f1cc2592.js"><link rel="prefetch" href="/luvue/assets/js/136.5fea8f28.js"><link rel="prefetch" href="/luvue/assets/js/137.15521ec2.js"><link rel="prefetch" href="/luvue/assets/js/138.2e96476f.js"><link rel="prefetch" href="/luvue/assets/js/139.b3e580c7.js"><link rel="prefetch" href="/luvue/assets/js/14.e2545646.js"><link rel="prefetch" href="/luvue/assets/js/140.7254c946.js"><link rel="prefetch" href="/luvue/assets/js/141.309b75d5.js"><link rel="prefetch" href="/luvue/assets/js/142.e1587e8c.js"><link rel="prefetch" href="/luvue/assets/js/143.c6e04498.js"><link rel="prefetch" href="/luvue/assets/js/144.ccf79776.js"><link rel="prefetch" href="/luvue/assets/js/145.faa65998.js"><link rel="prefetch" href="/luvue/assets/js/146.1b7c11e7.js"><link rel="prefetch" href="/luvue/assets/js/147.f19de9ec.js"><link rel="prefetch" href="/luvue/assets/js/148.aba5552d.js"><link rel="prefetch" href="/luvue/assets/js/149.f1c10580.js"><link rel="prefetch" href="/luvue/assets/js/15.a3a78949.js"><link rel="prefetch" href="/luvue/assets/js/150.8c715a8a.js"><link rel="prefetch" href="/luvue/assets/js/151.1d867a79.js"><link rel="prefetch" href="/luvue/assets/js/152.22ae9445.js"><link rel="prefetch" href="/luvue/assets/js/153.1024de46.js"><link rel="prefetch" href="/luvue/assets/js/154.48bb1114.js"><link rel="prefetch" href="/luvue/assets/js/155.bd946cd8.js"><link rel="prefetch" href="/luvue/assets/js/156.f1d78b05.js"><link rel="prefetch" href="/luvue/assets/js/157.63356c24.js"><link rel="prefetch" href="/luvue/assets/js/158.44bfb42f.js"><link rel="prefetch" href="/luvue/assets/js/159.41731d4e.js"><link rel="prefetch" href="/luvue/assets/js/16.bdbc9ac3.js"><link rel="prefetch" href="/luvue/assets/js/160.fe64fd3e.js"><link rel="prefetch" href="/luvue/assets/js/161.3af3f899.js"><link rel="prefetch" href="/luvue/assets/js/162.a020acea.js"><link rel="prefetch" href="/luvue/assets/js/163.ebfa2fea.js"><link rel="prefetch" href="/luvue/assets/js/164.5c72d951.js"><link rel="prefetch" href="/luvue/assets/js/165.739d51ec.js"><link rel="prefetch" href="/luvue/assets/js/166.54be55b5.js"><link rel="prefetch" href="/luvue/assets/js/167.6f6b0af9.js"><link rel="prefetch" href="/luvue/assets/js/168.059c4bbb.js"><link rel="prefetch" href="/luvue/assets/js/169.9583f311.js"><link rel="prefetch" href="/luvue/assets/js/17.267c53f7.js"><link rel="prefetch" href="/luvue/assets/js/170.f7ab2a56.js"><link rel="prefetch" href="/luvue/assets/js/171.aa5c6d65.js"><link rel="prefetch" href="/luvue/assets/js/172.7b70d120.js"><link rel="prefetch" href="/luvue/assets/js/173.8d733f83.js"><link rel="prefetch" href="/luvue/assets/js/174.41a36264.js"><link rel="prefetch" href="/luvue/assets/js/175.643cec2e.js"><link rel="prefetch" href="/luvue/assets/js/176.17a19152.js"><link rel="prefetch" href="/luvue/assets/js/177.00bffe2d.js"><link rel="prefetch" href="/luvue/assets/js/178.39d6dd1d.js"><link rel="prefetch" href="/luvue/assets/js/179.97c25b6d.js"><link rel="prefetch" href="/luvue/assets/js/18.b4dc00ad.js"><link rel="prefetch" href="/luvue/assets/js/180.f001f92c.js"><link rel="prefetch" href="/luvue/assets/js/181.b4ff3df9.js"><link rel="prefetch" href="/luvue/assets/js/182.21c49e0c.js"><link rel="prefetch" href="/luvue/assets/js/183.a68aedcf.js"><link rel="prefetch" href="/luvue/assets/js/184.1cc2979e.js"><link rel="prefetch" href="/luvue/assets/js/185.820ead5b.js"><link rel="prefetch" href="/luvue/assets/js/186.2ad000ef.js"><link rel="prefetch" href="/luvue/assets/js/187.fa9b511d.js"><link rel="prefetch" href="/luvue/assets/js/188.cfcaabfb.js"><link rel="prefetch" href="/luvue/assets/js/189.c7913649.js"><link rel="prefetch" href="/luvue/assets/js/19.61df46ad.js"><link rel="prefetch" href="/luvue/assets/js/190.a66da869.js"><link rel="prefetch" href="/luvue/assets/js/191.d21b8a3e.js"><link rel="prefetch" href="/luvue/assets/js/192.3a3f0b99.js"><link rel="prefetch" href="/luvue/assets/js/193.6005ffb1.js"><link rel="prefetch" href="/luvue/assets/js/194.9b365175.js"><link rel="prefetch" href="/luvue/assets/js/195.4e4e83f5.js"><link rel="prefetch" href="/luvue/assets/js/196.24df233b.js"><link rel="prefetch" href="/luvue/assets/js/197.42cfce0b.js"><link rel="prefetch" href="/luvue/assets/js/198.3998b360.js"><link rel="prefetch" href="/luvue/assets/js/199.6e1b267e.js"><link rel="prefetch" href="/luvue/assets/js/20.ae4d73d6.js"><link rel="prefetch" href="/luvue/assets/js/200.78a26196.js"><link rel="prefetch" href="/luvue/assets/js/201.e15689f7.js"><link rel="prefetch" href="/luvue/assets/js/202.351e4200.js"><link rel="prefetch" href="/luvue/assets/js/203.6732fa0f.js"><link rel="prefetch" href="/luvue/assets/js/204.bdaedc2f.js"><link rel="prefetch" href="/luvue/assets/js/205.769cfdfa.js"><link rel="prefetch" href="/luvue/assets/js/206.5980160d.js"><link rel="prefetch" href="/luvue/assets/js/207.4f27fd16.js"><link rel="prefetch" href="/luvue/assets/js/208.f715439d.js"><link rel="prefetch" href="/luvue/assets/js/209.26ff4509.js"><link rel="prefetch" href="/luvue/assets/js/21.756c7992.js"><link rel="prefetch" href="/luvue/assets/js/210.7c211a09.js"><link rel="prefetch" href="/luvue/assets/js/211.70a47632.js"><link rel="prefetch" href="/luvue/assets/js/212.fda6d44b.js"><link rel="prefetch" href="/luvue/assets/js/213.ec7d646a.js"><link rel="prefetch" href="/luvue/assets/js/214.3c165f1f.js"><link rel="prefetch" href="/luvue/assets/js/215.79377a1f.js"><link rel="prefetch" href="/luvue/assets/js/216.1300dd6d.js"><link rel="prefetch" href="/luvue/assets/js/217.1ee87399.js"><link rel="prefetch" href="/luvue/assets/js/218.6f58fde9.js"><link rel="prefetch" href="/luvue/assets/js/219.3e5ec5b0.js"><link rel="prefetch" href="/luvue/assets/js/22.68b75c4f.js"><link rel="prefetch" href="/luvue/assets/js/220.bac8627d.js"><link rel="prefetch" href="/luvue/assets/js/221.65afbd17.js"><link rel="prefetch" href="/luvue/assets/js/222.10b495b9.js"><link rel="prefetch" href="/luvue/assets/js/223.9483fde2.js"><link rel="prefetch" href="/luvue/assets/js/224.f0f0b115.js"><link rel="prefetch" href="/luvue/assets/js/225.82f4db59.js"><link rel="prefetch" href="/luvue/assets/js/226.837beb3c.js"><link rel="prefetch" href="/luvue/assets/js/227.88dfd603.js"><link rel="prefetch" href="/luvue/assets/js/228.926b67f1.js"><link rel="prefetch" href="/luvue/assets/js/229.d5432625.js"><link rel="prefetch" href="/luvue/assets/js/23.f144c5d8.js"><link rel="prefetch" href="/luvue/assets/js/230.af30858c.js"><link rel="prefetch" href="/luvue/assets/js/231.d094a5d4.js"><link rel="prefetch" href="/luvue/assets/js/232.001ef00e.js"><link rel="prefetch" href="/luvue/assets/js/233.63941e40.js"><link rel="prefetch" href="/luvue/assets/js/234.942f27c3.js"><link rel="prefetch" href="/luvue/assets/js/235.304392bc.js"><link rel="prefetch" href="/luvue/assets/js/236.d9a2338f.js"><link rel="prefetch" href="/luvue/assets/js/237.3e31a7be.js"><link rel="prefetch" href="/luvue/assets/js/238.50a6e0a4.js"><link rel="prefetch" href="/luvue/assets/js/239.67f7ea74.js"><link rel="prefetch" href="/luvue/assets/js/24.050e500e.js"><link rel="prefetch" href="/luvue/assets/js/240.7e126350.js"><link rel="prefetch" href="/luvue/assets/js/241.4b6526f2.js"><link rel="prefetch" href="/luvue/assets/js/242.2c0594df.js"><link rel="prefetch" href="/luvue/assets/js/243.2947ca1f.js"><link rel="prefetch" href="/luvue/assets/js/244.c13ff375.js"><link rel="prefetch" href="/luvue/assets/js/245.f35e7258.js"><link rel="prefetch" href="/luvue/assets/js/246.a4160daf.js"><link rel="prefetch" href="/luvue/assets/js/247.5add7de3.js"><link rel="prefetch" href="/luvue/assets/js/248.285f48bf.js"><link rel="prefetch" href="/luvue/assets/js/249.6bfc19fe.js"><link rel="prefetch" href="/luvue/assets/js/25.7161d756.js"><link rel="prefetch" href="/luvue/assets/js/250.7d9d5a0d.js"><link rel="prefetch" href="/luvue/assets/js/251.ad83fc91.js"><link rel="prefetch" href="/luvue/assets/js/252.79ce4a94.js"><link rel="prefetch" href="/luvue/assets/js/253.6733159c.js"><link rel="prefetch" href="/luvue/assets/js/254.8cbd88de.js"><link rel="prefetch" href="/luvue/assets/js/255.a6ded312.js"><link rel="prefetch" href="/luvue/assets/js/256.4a6348be.js"><link rel="prefetch" href="/luvue/assets/js/257.16709fb2.js"><link rel="prefetch" href="/luvue/assets/js/258.65f7c45d.js"><link rel="prefetch" href="/luvue/assets/js/259.d6bf3339.js"><link rel="prefetch" href="/luvue/assets/js/26.da9ec7cd.js"><link rel="prefetch" href="/luvue/assets/js/260.2e2fc30d.js"><link rel="prefetch" href="/luvue/assets/js/261.8ed2d945.js"><link rel="prefetch" href="/luvue/assets/js/262.02d4d5ca.js"><link rel="prefetch" href="/luvue/assets/js/263.8a02e4d0.js"><link rel="prefetch" href="/luvue/assets/js/264.5fad29a4.js"><link rel="prefetch" href="/luvue/assets/js/265.1cd29535.js"><link rel="prefetch" href="/luvue/assets/js/266.e5a1aad7.js"><link rel="prefetch" href="/luvue/assets/js/267.a51a94be.js"><link rel="prefetch" href="/luvue/assets/js/268.5d9bc388.js"><link rel="prefetch" href="/luvue/assets/js/269.81be7c5e.js"><link rel="prefetch" href="/luvue/assets/js/27.d35fe8d8.js"><link rel="prefetch" href="/luvue/assets/js/270.bf9cf8c5.js"><link rel="prefetch" href="/luvue/assets/js/271.f5f0e39d.js"><link rel="prefetch" href="/luvue/assets/js/272.2c2d8519.js"><link rel="prefetch" href="/luvue/assets/js/273.207adc32.js"><link rel="prefetch" href="/luvue/assets/js/274.4dceda17.js"><link rel="prefetch" href="/luvue/assets/js/275.c1310482.js"><link rel="prefetch" href="/luvue/assets/js/276.4201cd6e.js"><link rel="prefetch" href="/luvue/assets/js/277.88e1d30f.js"><link rel="prefetch" href="/luvue/assets/js/278.5914996c.js"><link rel="prefetch" href="/luvue/assets/js/279.74b37999.js"><link rel="prefetch" href="/luvue/assets/js/28.07d99649.js"><link rel="prefetch" href="/luvue/assets/js/280.c9568110.js"><link rel="prefetch" href="/luvue/assets/js/281.9f65d139.js"><link rel="prefetch" href="/luvue/assets/js/282.1650bd06.js"><link rel="prefetch" href="/luvue/assets/js/283.33bbeb99.js"><link rel="prefetch" href="/luvue/assets/js/284.1abe4631.js"><link rel="prefetch" href="/luvue/assets/js/285.518df1bf.js"><link rel="prefetch" href="/luvue/assets/js/286.af519e66.js"><link rel="prefetch" href="/luvue/assets/js/287.b6460486.js"><link rel="prefetch" href="/luvue/assets/js/288.47db7cc9.js"><link rel="prefetch" href="/luvue/assets/js/289.33cc7dc0.js"><link rel="prefetch" href="/luvue/assets/js/29.7a42aa9c.js"><link rel="prefetch" href="/luvue/assets/js/290.4a4def2b.js"><link rel="prefetch" href="/luvue/assets/js/291.ff1d48f1.js"><link rel="prefetch" href="/luvue/assets/js/293.4475f8fa.js"><link rel="prefetch" href="/luvue/assets/js/294.19226719.js"><link rel="prefetch" href="/luvue/assets/js/295.09aea195.js"><link rel="prefetch" href="/luvue/assets/js/296.98217b5e.js"><link rel="prefetch" href="/luvue/assets/js/297.b8ff51d6.js"><link rel="prefetch" href="/luvue/assets/js/298.990d4d9f.js"><link rel="prefetch" href="/luvue/assets/js/299.5df2719c.js"><link rel="prefetch" href="/luvue/assets/js/30.f14df500.js"><link rel="prefetch" href="/luvue/assets/js/300.fffd2c27.js"><link rel="prefetch" href="/luvue/assets/js/301.3d6b453a.js"><link rel="prefetch" href="/luvue/assets/js/302.caa4deb9.js"><link rel="prefetch" href="/luvue/assets/js/303.7a1ad789.js"><link rel="prefetch" href="/luvue/assets/js/304.fd6421f9.js"><link rel="prefetch" href="/luvue/assets/js/305.9963fce8.js"><link rel="prefetch" href="/luvue/assets/js/306.20906cc0.js"><link rel="prefetch" href="/luvue/assets/js/307.9b2c7f2f.js"><link rel="prefetch" href="/luvue/assets/js/308.c6636c3c.js"><link rel="prefetch" href="/luvue/assets/js/309.ba0a0e71.js"><link rel="prefetch" href="/luvue/assets/js/31.8b2636da.js"><link rel="prefetch" href="/luvue/assets/js/310.22345224.js"><link rel="prefetch" href="/luvue/assets/js/311.7c423dba.js"><link rel="prefetch" href="/luvue/assets/js/312.1a9b57a9.js"><link rel="prefetch" href="/luvue/assets/js/313.358832dc.js"><link rel="prefetch" href="/luvue/assets/js/314.cc992c63.js"><link rel="prefetch" href="/luvue/assets/js/315.51fdd92e.js"><link rel="prefetch" href="/luvue/assets/js/32.a1812ddd.js"><link rel="prefetch" href="/luvue/assets/js/33.4f4d5e3f.js"><link rel="prefetch" href="/luvue/assets/js/34.d81874f6.js"><link rel="prefetch" href="/luvue/assets/js/35.808cadca.js"><link rel="prefetch" href="/luvue/assets/js/36.911edf94.js"><link rel="prefetch" href="/luvue/assets/js/37.4718c1c4.js"><link rel="prefetch" href="/luvue/assets/js/38.a71b26b8.js"><link rel="prefetch" href="/luvue/assets/js/39.1e2c90a1.js"><link rel="prefetch" href="/luvue/assets/js/4.81c04c44.js"><link rel="prefetch" href="/luvue/assets/js/40.c27fa3a1.js"><link rel="prefetch" href="/luvue/assets/js/41.7ef6ece6.js"><link rel="prefetch" href="/luvue/assets/js/42.65a4e5f1.js"><link rel="prefetch" href="/luvue/assets/js/43.fe8f1ca9.js"><link rel="prefetch" href="/luvue/assets/js/44.4cbd0be7.js"><link rel="prefetch" href="/luvue/assets/js/45.7ba58c4e.js"><link rel="prefetch" href="/luvue/assets/js/46.5b26ac52.js"><link rel="prefetch" href="/luvue/assets/js/47.4886ee59.js"><link rel="prefetch" href="/luvue/assets/js/48.6ca30618.js"><link rel="prefetch" href="/luvue/assets/js/49.bf5ae195.js"><link rel="prefetch" href="/luvue/assets/js/5.7c785cd7.js"><link rel="prefetch" href="/luvue/assets/js/50.d2063889.js"><link rel="prefetch" href="/luvue/assets/js/51.40853d68.js"><link rel="prefetch" href="/luvue/assets/js/52.4595cda0.js"><link rel="prefetch" href="/luvue/assets/js/53.f65e7aed.js"><link rel="prefetch" href="/luvue/assets/js/54.e92efc34.js"><link rel="prefetch" href="/luvue/assets/js/55.c19cb715.js"><link rel="prefetch" href="/luvue/assets/js/56.d9b2c912.js"><link rel="prefetch" href="/luvue/assets/js/57.97fdefbb.js"><link rel="prefetch" href="/luvue/assets/js/58.a8454dc8.js"><link rel="prefetch" href="/luvue/assets/js/59.2176e352.js"><link rel="prefetch" href="/luvue/assets/js/6.f13ef292.js"><link rel="prefetch" href="/luvue/assets/js/60.9903c2e8.js"><link rel="prefetch" href="/luvue/assets/js/61.1840a87b.js"><link rel="prefetch" href="/luvue/assets/js/62.f9de293d.js"><link rel="prefetch" href="/luvue/assets/js/63.f0b5bd0c.js"><link rel="prefetch" href="/luvue/assets/js/64.9bfd9747.js"><link rel="prefetch" href="/luvue/assets/js/65.5091d072.js"><link rel="prefetch" href="/luvue/assets/js/66.1110c30b.js"><link rel="prefetch" href="/luvue/assets/js/67.d0123a6f.js"><link rel="prefetch" href="/luvue/assets/js/68.cfb6235b.js"><link rel="prefetch" href="/luvue/assets/js/69.eaef6f8c.js"><link rel="prefetch" href="/luvue/assets/js/7.b9daa433.js"><link rel="prefetch" href="/luvue/assets/js/70.92d45540.js"><link rel="prefetch" href="/luvue/assets/js/71.cea0d0db.js"><link rel="prefetch" href="/luvue/assets/js/72.5f4fd7b1.js"><link rel="prefetch" href="/luvue/assets/js/73.2bd9f09b.js"><link rel="prefetch" href="/luvue/assets/js/74.4f59112e.js"><link rel="prefetch" href="/luvue/assets/js/75.89861829.js"><link rel="prefetch" href="/luvue/assets/js/76.b02997f7.js"><link rel="prefetch" href="/luvue/assets/js/77.4d732275.js"><link rel="prefetch" href="/luvue/assets/js/78.338bc517.js"><link rel="prefetch" href="/luvue/assets/js/79.f4cf76b6.js"><link rel="prefetch" href="/luvue/assets/js/8.ae058ff6.js"><link rel="prefetch" href="/luvue/assets/js/80.598885dc.js"><link rel="prefetch" href="/luvue/assets/js/81.9e624105.js"><link rel="prefetch" href="/luvue/assets/js/82.70b483bb.js"><link rel="prefetch" href="/luvue/assets/js/83.96e15db9.js"><link rel="prefetch" href="/luvue/assets/js/84.1d0a2fca.js"><link rel="prefetch" href="/luvue/assets/js/85.c9523e2f.js"><link rel="prefetch" href="/luvue/assets/js/86.11b4914d.js"><link rel="prefetch" href="/luvue/assets/js/87.9e995a9e.js"><link rel="prefetch" href="/luvue/assets/js/88.768abc2b.js"><link rel="prefetch" href="/luvue/assets/js/89.889b6d0c.js"><link rel="prefetch" href="/luvue/assets/js/9.c7db66f1.js"><link rel="prefetch" href="/luvue/assets/js/90.3d24896e.js"><link rel="prefetch" href="/luvue/assets/js/91.0d861dc9.js"><link rel="prefetch" href="/luvue/assets/js/92.225a6a9c.js"><link rel="prefetch" href="/luvue/assets/js/93.52403ad6.js"><link rel="prefetch" href="/luvue/assets/js/94.603cf2a0.js"><link rel="prefetch" href="/luvue/assets/js/95.c46d3f66.js"><link rel="prefetch" href="/luvue/assets/js/96.fb8ddca9.js"><link rel="prefetch" href="/luvue/assets/js/97.492b0923.js"><link rel="prefetch" href="/luvue/assets/js/98.0a287ebb.js"><link rel="prefetch" href="/luvue/assets/js/99.1786ba72.js">
    <link rel="stylesheet" href="/luvue/assets/css/0.styles.0c275c11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/luvue/" class="home-link router-link-active"><!----> <span class="site-name">Ailjc notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link router-link-active">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link">工程化</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/luvue/" class="nav-link">首页</a></div><div class="nav-item"><a href="/luvue/Js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/luvue/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/luvue/vuebase/" class="nav-link">快速掌握Vue</a></div><div class="nav-item"><a href="/luvue/node/" class="nav-link">Node</a></div><div class="nav-item"><a href="/luvue/typescript/" class="nav-link">Typescript</a></div><div class="nav-item"><a href="/luvue/vue3/" class="nav-link">Vue3</a></div><div class="nav-item"><a href="/luvue/vuesourcecode/" class="nav-link router-link-active">源码分析</a></div><div class="nav-item"><a href="/luvue/lu-ui/" class="nav-link">组件库</a></div><div class="nav-item"><a href="/luvue/engineering/" class="nav-link">工程化</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vuesourcecode/PWA&amp;WebComponent/" class="sidebar-heading clickable"><span>PWA&amp;WebComponent</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vuesourcecode/Vite/" class="sidebar-heading clickable"><span>Vite</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vuesourcecode/Vue-Router/" class="sidebar-heading clickable router-link-active open"><span>Vue-Router</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/luvue/vuesourcecode/Vue-Router/01-Vue-Router源码深度剖析.html" class="sidebar-link">01-Vue-Router源码深度剖析</a></li><li><a href="/luvue/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html" class="sidebar-link">02-vue-router源码解析[上]</a></li><li><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html" class="active sidebar-link">03-vue-router源码解析[中]</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#路由跳转" class="sidebar-link">路由跳转</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#transitionto" class="sidebar-link">transitionTo</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#路由匹配" class="sidebar-link">路由匹配</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#地址格式化-normalizelocation" class="sidebar-link">地址格式化 normalizeLocation</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#地址是否匹配判断-matchroute" class="sidebar-link">地址是否匹配判断 matchRoute</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#填充参数-fillparams" class="sidebar-link">填充参数 fillParams</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#创建路由对象-createroute" class="sidebar-link">创建路由对象_createRoute</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#createroute" class="sidebar-link">createRoute</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#创建别名路由对象-alias" class="sidebar-link">创建别名路由对象 alias</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#创建重定向路由对象-redirect" class="sidebar-link">创建重定向路由对象 redirect</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#小结" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#导航解析-确认-流程" class="sidebar-link">导航解析(确认)流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#判断重复跳转" class="sidebar-link">判断重复跳转</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#对比找出需要更新、失活、激活的路由记录" class="sidebar-link">对比找出需要更新、失活、激活的路由记录</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#抽取钩子、守卫函数、解析异步组件" class="sidebar-link">抽取钩子、守卫函数、解析异步组件</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#extractleaveguards、extractupdatehooks" class="sidebar-link">extractLeaveGuards、extractUpdateHooks</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#resolveasynccomponents" class="sidebar-link">resolveAsyncComponents</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#守卫队列的执行" class="sidebar-link">守卫队列的执行</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#runqueue" class="sidebar-link">runQueue</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#iterator" class="sidebar-link">iterator</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#队列执行" class="sidebar-link">队列执行</a></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#抽取-beforerouteenter" class="sidebar-link">抽取 beforeRouteEnter</a></li></ul></li><li class="sidebar-sub-header"><a href="/luvue/vuesourcecode/Vue-Router/03-vue-router源码解析[中].html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/luvue/vuesourcecode/Vue-Router/04-vue-router源码解析[下].html" class="sidebar-link">04-vue-router源码解析[下]</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vuesourcecode/vue2剖析源码/" class="sidebar-heading clickable"><span>vue2剖析源码</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vuesourcecode/vuex/" class="sidebar-heading clickable"><span>vuex</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vuesourcecode/vue服务端渲染/" class="sidebar-heading clickable"><span>vue服务端渲染</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vuesourcecode/微前端/" class="sidebar-heading clickable"><span>微前端</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vuesourcecode/手写核心原理/" class="sidebar-heading clickable"><span>手写核心原理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/luvue/vuesourcecode/脚手架/" class="sidebar-heading clickable"><span>脚手架</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-router-源码解析-1-5w-字-多图预警-【中】"><a href="#vue-router-源码解析-1-5w-字-多图预警-【中】" class="header-anchor">#</a> vue-router 源码解析 | 1.5w 字 | 多图预警 - 【中】</h1> <p></p><div class="table-of-contents"><ul><li><a href="#路由跳转">路由跳转</a><ul><li><a href="#transitionto">transitionTo</a></li></ul></li><li><a href="#路由匹配">路由匹配</a><ul><li><a href="#地址格式化-normalizelocation">地址格式化 normalizeLocation</a></li><li><a href="#地址是否匹配判断-matchroute">地址是否匹配判断 matchRoute</a></li><li><a href="#填充参数-fillparams">填充参数 fillParams</a></li><li><a href="#创建路由对象-createroute">创建路由对象_createRoute</a></li><li><a href="#createroute">createRoute</a></li><li><a href="#创建别名路由对象-alias">创建别名路由对象 alias</a></li><li><a href="#创建重定向路由对象-redirect">创建重定向路由对象 redirect</a></li><li><a href="#小结">小结</a></li></ul></li><li><a href="#导航解析-确认-流程">导航解析(确认)流程</a><ul><li><a href="#判断重复跳转">判断重复跳转</a></li><li><a href="#对比找出需要更新、失活、激活的路由记录">对比找出需要更新、失活、激活的路由记录</a></li><li><a href="#抽取钩子、守卫函数、解析异步组件">抽取钩子、守卫函数、解析异步组件</a></li><li><a href="#extractleaveguards、extractupdatehooks">extractLeaveGuards、extractUpdateHooks</a></li><li><a href="#resolveasynccomponents">resolveAsyncComponents</a></li><li><a href="#守卫队列的执行">守卫队列的执行</a></li><li><a href="#runqueue">runQueue</a></li><li><a href="#iterator">iterator</a></li><li><a href="#队列执行">队列执行</a></li><li><a href="#抽取-beforerouteenter">抽取 beforeRouteEnter</a></li></ul></li><li><a href="#总结">总结</a></li></ul></div><p></p> <h2 id="路由跳转"><a href="#路由跳转" class="header-anchor">#</a> 路由跳转</h2> <p>要实现路由的跳转，首先得从路由映射表中找到与地址匹配的路由对象，这个过程称之为路由匹配，找到匹配的路由后，然后再解析跳转</p> <p>所以实现路由跳转有两个关键步骤：路由匹配、导航解析</p> <p>VueRouter 将上述两个关键步骤封装到 <code>transitionTo</code> 方法中了</p> <p>接下来，我们先看看 <code>transitionTo</code> 的实现</p> <h3 id="transitionto"><a href="#transitionto" class="header-anchor">#</a> transitionTo</h3> <p>transitionTo 方法定义在基类 History 上的</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/history/base.js</span>

<span class="token operator">...</span>
<span class="token comment">// 父类</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>

  <span class="token comment">// 路由跳转</span>
  <span class="token function">transitionTo</span> <span class="token punctuation">(</span>
    location<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> <span class="token comment">// 原始location，一个url或者是一个Location interface(自定义形状，在types/router.d.ts中定义)</span>
    onComplete<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> <span class="token comment">// 跳转成功回调</span>
    onAbort<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token comment">// 跳转失败回调</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token comment">// 传入需要跳转的location和当前路由对象，返回to的Route</span>

    <span class="token comment">// 确认跳转</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>
      route<span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// onComplete，完成</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token comment">// 更新route，会触发afterEach钩子</span>
        onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token comment">// 调用onComplete回调</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// fire ready cbs once</span>
        <span class="token comment">// 触发ready回调</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// onAbort，报错（取消）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 触发error回调</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>在 setupListeners 章节也介绍过 transitionTo 的方法签名<br>
接收三个参数</p> <ul><li><code>location</code> 为 <code>RawLocation</code> 类型，代表需要解析的地址</li> <li><code>onComplete</code> 是跳转成功回调，在路由跳转成功时调用</li> <li><code>onAbort</code> 是跳转失败(取消)回调，在路由被取消时调用</li></ul> <p>看下内部逻辑</p> <ul><li>调用 <code>router</code> 实例的 <code>match</code> 方法，从路由映射表中取到将要跳转到的路由对象 route；这其实就是<code>路由匹配</code>过程；</li> <li>拿到将要跳转的 route 后，调用 <code>confirmTransition</code> 完成 route 的解析跳转，并在跳转成功、取消时调用对应回调方法；这是<code>导航解析</code>过程
<ul><li>成功时，调用 <code>updateRoute</code> 触发重新渲染，然后触发相关回调；关于渲染，我们后面章节会讲</li> <li>取消(失败)时，触发相关回调</li></ul></li></ul> <p>那我们下面先看下路由匹配过程</p> <h2 id="路由匹配"><a href="#路由匹配" class="header-anchor">#</a> 路由匹配</h2> <p><code>transitionTo</code> 中会调用 <code>router</code> 实例的 <code>match</code> 方法实现路由匹配</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/index.js</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>

    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取匹配的路由对象</span>
  <span class="token function">match</span> <span class="token punctuation">(</span>
    raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
    current<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
    redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location
  <span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> current<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>router 实例的 match</code> 方法，又调用的匹配器的 <code>match</code> 方法，将参数直接透传过去</p> <p>我们继续看匹配器的 match 方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/create-matcher.js</span>

<span class="token operator">...</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createMatcher</span> <span class="token punctuation">(</span>
  routes<span class="token operator">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 路由配置列表</span>
  router<span class="token operator">:</span> VueRouter <span class="token comment">// VueRouter实例</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Matcher <span class="token punctuation">{</span>
  <span class="token operator">...</span>

  <span class="token comment">// 传入location,返回匹配的Route对象</span>
  <span class="token keyword">function</span> <span class="token function">match</span> <span class="token punctuation">(</span>
    <span class="token parameter">raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
    currentRoute<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
    redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
    <span class="token comment">// 获取格式化后的location，由于闭包特性，所以此处能访问到router实例</span>
    <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">normalizeLocation</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> currentRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> location

    <span class="token comment">// 通过name匹配</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> record <span class="token operator">=</span> nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 未找到警告</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Route with name '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' does not exist</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 未找到路由记录，则创建一个空Route返回</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>record<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>

      <span class="token comment">// 获取动态路由参数名</span>
      <span class="token keyword">const</span> paramNames <span class="token operator">=</span> record<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>keys
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>key<span class="token punctuation">.</span>optional<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> key<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> location<span class="token punctuation">.</span>params <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 提取当前Route中符合动态路由参数名的值赋值给location</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoute <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> currentRoute<span class="token punctuation">.</span>params <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">const</span> key <span class="token keyword">in</span> currentRoute<span class="token punctuation">.</span>params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> paramNames<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 填充params</span>
      location<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">named route &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

      <span class="token comment">// 创建route</span>
      <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">.</span>path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

      <span class="token comment">// 遍历pathList，找到能匹配到的记录，然后生成Route</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pathList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> path <span class="token operator">=</span> pathList<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">const</span> record <span class="token operator">=</span> pathMap<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token function">matchRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>regex<span class="token punctuation">,</span> location<span class="token punctuation">.</span>path<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

          <span class="token comment">// 找到匹配的路由记录后，生成对应Route</span>
          <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// no match</span>
    <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
   
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><p>由于<code>router.match</code> 是将参数透传过来的，所以二者的签名一模一样</p> <ul><li><code>raw</code> 是 <code>RawLocation</code> 类型，是需要进行路由匹配的地址</li> <li><code>currentRoute</code> 是当前路由对象</li> <li><code>redirectedFrom</code> 代表从哪个地址重定向过来的</li></ul> <p>我们看下 match 方法逻辑</p> <ul><li>首先它对传入的 raw 地址，进行了格式化(规范化)</li> <li>然后取出格式化地址中的 name</li> <li><code>name</code> 存在，判断是否能通过 name 在 nameMap 中找到对应的路由记录 RouteRecord
<ul><li>无法找到，则创建一个新 route 对象返回</li> <li>可以找到，则填充 <code>params</code>，并使用此路由记录创建一个新的 Route 对象返回</li></ul></li> <li><code>name</code> 不存在，则判断 path 是否存在
<ul><li>存在，则利用 <code>pathList</code>、<code>pathMap</code> 调用 <code>matchRoute</code> 判断是否匹配，进而找到匹配的路由记录，然后使用此路由记录创建新 <code>route</code> 对象返回</li></ul></li> <li><code>name</code>、<code>path</code> 都不存在
<ul><li>则直接创建一个新 <code>route</code> 对象返回</li></ul></li></ul> <p>活动图如下 match.png<br> <img src="/luvue/images/vuesourcecode/vue-router/vue-router25.awebp" alt="vuesourcecode/vue-router/vue-router25.awebp"></p> <p>我们提取一下上述流程的关键词</p> <ul><li><code>地址格式化normalizeLocation</code></li> <li><code>地址是否匹配判断matchRoute</code></li> <li><code>填充参数fillParams</code></li> <li><code>创建路由对象_createRoute</code></li></ul> <h3 id="地址格式化-normalizelocation"><a href="#地址格式化-normalizelocation" class="header-anchor">#</a> 地址格式化 normalizeLocation</h3> <p>我们看下为何需要对地址做格式化<br>
我们知道 <code>VueRoute</code> 定义的地址是 <code>RawLocation</code> 类型的，而它是联合类型的，支持 <code>string</code> 和 <code>Location</code> 类型</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// flow/declarations.js</span>

declare type Location <span class="token operator">=</span> <span class="token punctuation">{</span>
  _normalized<span class="token operator">?</span><span class="token operator">:</span> boolean
  name<span class="token operator">?</span><span class="token operator">:</span> string
  path<span class="token operator">?</span><span class="token operator">:</span> string
  hash<span class="token operator">?</span><span class="token operator">:</span> string
  query<span class="token operator">?</span><span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
  params<span class="token operator">?</span><span class="token operator">:</span> Dictionary<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
  append<span class="token operator">?</span><span class="token operator">:</span> boolean
  replace<span class="token operator">?</span><span class="token operator">:</span> boolean
<span class="token punctuation">}</span>

declare type RawLocation <span class="token operator">=</span> string <span class="token operator">|</span> Location
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>所以下面的地址都是合法的</p> <p><code>$router.push</code>方法的参数也是的<code>RawLocation</code>类型，所以使用<code>$router.push</code>来举例</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 字符串形式</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 相对</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绝对</span>

<span class="token comment">// Location 对象形式</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'home'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/home'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/home'</span><span class="token punctuation">,</span> query<span class="token operator">:</span> <span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 携带qs</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'home'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 命名路由</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'detail'</span><span class="token punctuation">,</span> params<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 命名+带参</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> params<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 仅带参，针对仅有参数变化的相对跳转；相对参数跳转</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>可以看到 VueRouter 需要兼容上面所有情况，为了方便处理，需要对地址做格式化,看下实现逻辑</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/util/location.js</span>

<span class="token comment">// 格式化location</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">normalizeLocation</span><span class="token punctuation">(</span>
  raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> <span class="token comment">// 原始location，一个string，或者是一个已经格式化后的location</span>
  current<span class="token operator">:</span> <span class="token operator">?</span>Route<span class="token punctuation">,</span> <span class="token comment">// 当前路由对象</span>
  append<span class="token operator">:</span> <span class="token operator">?</span>boolean<span class="token punctuation">,</span> <span class="token comment">// 是否是追加模式</span>
  router<span class="token operator">:</span> <span class="token operator">?</span>VueRouter <span class="token comment">// VueRouter实例</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Location <span class="token punctuation">{</span>
  <span class="token keyword">let</span> next<span class="token operator">:</span> Location <span class="token operator">=</span> <span class="token keyword">typeof</span> raw <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token punctuation">{</span> path<span class="token operator">:</span> raw <span class="token punctuation">}</span> <span class="token operator">:</span> raw<span class="token punctuation">;</span> <span class="token comment">// named target // 已经格式化过，直接返回</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>_normalized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理命名形式，例如{name:'Home',params:{id:3}}</span>
    next <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> next<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> params <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      next<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// relative params // 处理{params:{id:1}}相对参数形式跳转</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>next<span class="token punctuation">.</span>path <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>params <span class="token operator">&amp;&amp;</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    next <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    next<span class="token punctuation">.</span>_normalized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> params<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 提取当前route的字段做为next的字段，因为相对参数形式，只有params，必须借助current提取一些字段</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 命名形式</span>
      next<span class="token punctuation">.</span>name <span class="token operator">=</span> current<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      next<span class="token punctuation">.</span>params <span class="token operator">=</span> params<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// path形式，从匹配记录中提取出当前path并填充参数</span>
      <span class="token keyword">const</span> rawPath <span class="token operator">=</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">;</span>
      next<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>rawPath<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">path </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>current<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">relative params navigation requires a current route.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// 处理path形式跳转，例如{path:'/test',query:{test:3}} // 解析path</span>

  <span class="token keyword">const</span> parsedPath <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> basePath <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">&amp;&amp;</span> current<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> parsedPath<span class="token punctuation">.</span>path
    <span class="token operator">?</span> <span class="token function">resolvePath</span><span class="token punctuation">(</span>parsedPath<span class="token punctuation">.</span>path<span class="token punctuation">,</span> basePath<span class="token punctuation">,</span> append <span class="token operator">||</span> next<span class="token punctuation">.</span>append<span class="token punctuation">)</span>
    <span class="token operator">:</span> basePath<span class="token punctuation">;</span> <span class="token comment">// 解析query</span>

  <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token function">resolveQuery</span><span class="token punctuation">(</span>
    parsedPath<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
    next<span class="token punctuation">.</span>query<span class="token punctuation">,</span> <span class="token comment">// 额外需要追加的qs</span>
    router <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>parseQuery <span class="token comment">// 支持传入自定义解析query的方法</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析hash</span>

  <span class="token keyword">let</span> hash <span class="token operator">=</span> next<span class="token punctuation">.</span>hash <span class="token operator">||</span> parsedPath<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hash <span class="token operator">&amp;&amp;</span> hash<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hash <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    _normalized<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 标识已经格式化过</span>
    path<span class="token punctuation">,</span>
    query<span class="token punctuation">,</span>
    hash<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>首先将 <code>string</code> 类型的转换为对象形式，方便后面统一处理<br>
如果发现地址已经做过格式化处理，则直接返回<br>
再判断是否是命名路由, 若是，则拷贝原始地址<code>raw</code>，拷贝<code>params</code>，直接返回<br>
处理了仅携带参数的相对路由(相对参数)跳转，就是<code>this.$router.push({params:{id:1}})</code>形式</p> <ul><li>对这种地址的定义是<code>没有path</code>、<code>仅有params</code>并且<code>当前路由对象存在</code></li> <li>主要处理逻辑是
<ul><li>先合并<code>params</code></li> <li>若是命名路由，则使用<code>current.name</code>做为<code>next.name</code>，并赋值<code>params</code></li> <li>非命名路由，从当前路由对象中找到匹配的路由记录，并取出路由记录上的 path 做为<code>next.path</code>，然后填充 params</li> <li>返回处理好的地址</li></ul></li> <li>由于这中跳转方式，仅有 <code>params</code>，所以必须从当前路由对象 <code>current</code> 上获取可用字段(<code>path</code>、<code>name</code>)，做为自身值，然后跳转</li></ul> <p>处理通过 path 跳转的方</p> <ul><li>调用 <code>parsePath</code> 从 <code>path</code> 中解析出 <code>path</code>、<code>query</code>、<code>hash</code></li> <li>然后以 <code>current.path</code> 为 <code>basePath</code>，解析(<code>resolve</code>)出<code>最终 path</code></li> <li>对 <code>query</code> 进行合并操作</li> <li>对 <code>hash</code> 进行前追加#操作</li> <li>返回带有 <code>_normalized:true</code> 标识的 <code>Location</code> 对象</li></ul> <p>经过上面一番处理，无论传入何种地址，都返回一个带有<code>_normalized:true</code>标识的<code>Location类型</code>的对象</p> <p>normalize-location.png<br> <img src="/luvue/images/vuesourcecode/vue-router/vue-router26.awebp" alt="vuesourcecode/vue-router/vue-router26.awebp"></p> <h3 id="地址是否匹配判断-matchroute"><a href="#地址是否匹配判断-matchroute" class="header-anchor">#</a> 地址是否匹配判断 matchRoute</h3> <p>我们知道 VueRouter 是支持动态路由匹配的，如下图所示 dynamic-route.png
<img src="/luvue/images/vuesourcecode/vue-router/vue-router27.awebp" alt="vuesourcecode/vue-router/vue-router27.awebp"></p> <p>我们在上篇的<code>生成路由记录</code>章节也介绍过，<code>VueRouter</code> 在生成路由记录时，会通过 <code>path-to-regexp</code> 包生成一个正则扩展对象并赋值到路由记录的 regex 字段上，用于后续的动态路由参数的获取</p> <ul><li>主要的逻辑是提供一个动态路由<code>user/:id</code>和一个地址<code>/user/345</code>，通过<code>path-to-regexp</code>就能生成一个对象<code>{id:345}</code>来表达参数的映射关系</li> <li>是一个借助动态路由，从 url 上提取参数的过程；<code>/user/345</code> -&gt; <code>{id:345}</code></li></ul> <p>上述提取参数的逻辑是在 <code>matchRoute</code> 实现的</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// matchRoute位于src/create-matcher.js</span>
<span class="token comment">// src/create-matcher.js</span>

<span class="token comment">// 检查path是否能通过regex的匹配，并对params对象正确赋值</span>
<span class="token keyword">function</span> <span class="token function">matchRoute</span><span class="token punctuation">(</span>regex<span class="token operator">:</span> RouteRegExp<span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> params<span class="token operator">:</span> Object<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> m <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 无法匹配上</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 符合正则 &amp;&amp; params不存在，则表示可以匹配</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// 符合正则 &amp;&amp; params存在，需要对params进行正确赋值 // path-to-regexp会将每个动态路由标记处处理成正则的一个组，所以i从1开始 // 参考https://www.npmjs.com/package/path-to-regexp // const keys = []; // const regexp = pathToRegexp(&quot;/foo/:bar&quot;, keys); // regexp = /^\/foo\/([^\/]+?)\/?$/i // :bar就被处理成正则的一个组了 // keys = [{ name: 'bar', prefix: '/', suffix: '', pattern: '[^\\/#\\?]+?', modifier: '' }]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> len <span class="token operator">=</span> m<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> regex<span class="token punctuation">.</span>keys<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// regex.keys返回匹配到的</span>
    <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token keyword">typeof</span> m<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Fix #1994: using * with props: true generates a param named 0</span>
      params<span class="token punctuation">[</span>key<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">'pathMatch'</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> truee<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>通过方法签名，可以知道它返回一个 <code>boolean</code> 值，这个值代表传入的 <code>path</code> 是否能通过 <code>regex</code> 的匹配；虽然返回一个 <code>boolean</code> 值，但是其内部还做了件很重要的事，从 <code>path</code> 上提取动态路由参数值，我们看下完整逻辑</p> <ul><li>首先调用 path.match(regex)</li> <li>不能匹配直接返回 false</li> <li>可以匹配且无 params，返回 true</li> <li>剩下的就只有一种情况，可以匹配且 params 存在，此时需要对 params 进行正确赋值
<ul><li>整个赋值，主要是遍历 path.match(regex)返回值并取出 regex 中存储的 key，然后依次赋值，关于细节可以参考上面的注释；</li> <li>关于 regex、path-to-regexp，可以参考生成路由记录章节和https://www.npmjs.com/package/path-to-regexp</li></ul></li> <li>还有一个点，赋值时的 pathMatch 是什么？
<ul><li>这其实是跟通配符即*有关的</li> <li>VueRouter 关于通配符的特殊处理可以看<a href="https%3A%2F%2Frouter.vuejs.org%2Fzh%2Fguide%2Fessentials%2Fdynamic-matching.html%23%25E6%258D%2595%25E8%258E%25B7%25E6%2589%2580%25E6%259C%2589%25E8%25B7%25AF%25E7%2594%25B1%25E6%2588%2596-404-not-found-%25E8%25B7%25AF%25E7%2594%25B1">router.vuejs.org/zh/guide/es…</a><br>
即 pathMatch 会代表通配符匹配到的路径</li></ul></li></ul> <p>官方例子如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token comment">// 会匹配所有路径</span>
  path<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token comment">// 会匹配以 `/user-` 开头的任意路径</span>
  path<span class="token operator">:</span> <span class="token string">'/user-*'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 给出一个路由 { path: '/user-*' }</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/user-admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>params<span class="token punctuation">.</span>pathMatch<span class="token punctuation">;</span> <span class="token comment">// 'admin'</span>
<span class="token comment">// 给出一个路由 { path: '*' }</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/non-existing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>params<span class="token punctuation">.</span>pathMatch<span class="token punctuation">;</span> <span class="token comment">// '/non-existing'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>match-route.png<br> <img src="/luvue/images/vuesourcecode/vue-router/vue-router28.awebp" alt="vuesourcecode/vue-router/vue-router28.awebp"></p> <h3 id="填充参数-fillparams"><a href="#填充参数-fillparams" class="header-anchor">#</a> 填充参数 fillParams</h3> <p><code>fillParams</code> 可以看做是 <code>matchRoute</code> 的逆操作，是一个借助动态路径，使用参数生成 url 的过程；即<code>/user/:id+{id:345}</code>-&gt; <code>/user/345</code></p> <p>可以看下它的实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/util/params.js</span>

<span class="token comment">// 缓存</span>
<span class="token keyword">const</span> regexpCompileCache<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 填充动态路由参数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>
  <span class="token parameter">path<span class="token operator">:</span> string<span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>
  routeMsg<span class="token operator">:</span> string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  params <span class="token operator">=</span> params <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// compile主要用来逆解析，https://www.npmjs.com/package/path-to-regexp#compile-reverse-path-to-regexp</span>
    <span class="token keyword">const</span> filler <span class="token operator">=</span>
      regexpCompileCache<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>regexpCompileCache<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> Regexp<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修复https://github.com/vuejs/vue-router/issues/2505#issuecomment-442353151 // Fix #2505 resolving asterisk routes { name: 'not-found', params: { pathMatch: '/not-found' }} // and fix #3106 so that you can work with location descriptor object having params.pathMatch equal to empty string</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> params<span class="token punctuation">.</span>pathMatch <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> params<span class="token punctuation">.</span>pathMatch<span class="token punctuation">;</span> <span class="token comment">// 返回逆解析后的路径</span>

    <span class="token keyword">return</span> <span class="token function">filler</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">{</span> pretty<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Fix #3072 no warn if `pathMatch` is string</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> params<span class="token punctuation">.</span>pathMatch <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">missing param for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>routeMsg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// delete the 0 if it was added</span>
    <span class="token keyword">delete</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><ul><li>可以看到整个逆解析逻辑是借助 <code>Regexp.compile</code> 结合 <code>regexpCompileCache</code> 实现的</li> <li><code>Regexp.compile</code>接收一个动态路由 path，返回一个函数，可用这个函数做逆解析；</li></ul> <p>Regexp.compile 例子如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// https://www.npmjs.com/package/path-to-regexp#compile-reverse-path-to-regexp</span>

<span class="token keyword">const</span> toPath <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">123</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//=&gt; &quot;/user/123&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>可以看到首先对 <code>Regexp.compile</code> 返回的函数做了缓存</li> <li>然后将 <code>matchRoute</code> 中添加的<code>pathMatch</code>赋值给<code>params[0]</code></li> <li>调用 <code>Regexp.compile</code> 返回函数，以 <code>params</code> 为入参，逆解析 <code>url</code> 并返回</li> <li>删除添加的 <code>params[0]</code></li></ul> <p>fill-params.png<br> <img src="/luvue/images/vuesourcecode/vue-router/vue-router29.awebp" alt="vuesourcecode/vue-router/vue-router29.awebp"></p> <h3 id="创建路由对象-createroute"><a href="#创建路由对象-createroute" class="header-anchor">#</a> 创建路由对象<code>_createRoute</code></h3> <p>上面无论是 <code>normalizeLocation</code>、<code>matchRoute</code>、<code>fillParams</code> 都是针对传入的地址做一些操作；</p> <p>而 <code>match</code> 方法的作用是找到与地址匹配的路由对象，而这个主要是由<code>_createRoute</code> 方法实现</p> <p>从命名上可以看出，这是个内部方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//src/create-matcher.js createMatcher方法内</span>

<span class="token keyword">function</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>
  <span class="token parameter">record<span class="token operator">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">,</span>
  location<span class="token operator">:</span> Location<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
  <span class="token comment">// 路由记录被标记为重定向</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>redirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> redirectedFrom <span class="token operator">||</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// 路由记录被标记为别名路由，见create-route-map.js</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">alias</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// 正常路由记录</span>

  <span class="token keyword">return</span> <span class="token function">createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">,</span> router<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>可以看到它接收三个参数</p> <ul><li><code>record</code> 用来生成 <code>Route 对象</code>的目标路由记录</li> <li><code>location</code> 目标地址</li> <li><code>redirectedFrom</code> 重定向的来源地址，这个参数只在发生重定向时才会有值</li></ul> <p>我们知道，在新增路由记录时，会对不同类型的记录添加上不同的标记字段</p> <ul><li>如为重定向路有记录添加 <code>redirect</code> 字段</li> <li>为别名路由添加 <code>matchAs</code> 字段</li></ul> <p>可以看到针对不同的路由记录类型调用了不同方法</p> <ul><li>重定向路由调用 <code>redirect</code> 方法</li> <li>别名路由调用 <code>alias</code> 方法</li> <li>其余的调用 <code>createRoute</code> 方法</li></ul> <p>活动图如下 create-route-inner.png<br> <img src="/luvue/images/vuesourcecode/vue-router/vue-router30.awebp" alt="vuesourcecode/vue-router/vue-router30.awebp"></p> <p>其实 <code>redirect</code>、<code>alias</code> 方法内部也调用了 <code>createRoute</code> 方法</p> <p>所以我们先看 <code>createRoute</code> 方法实现</p> <h3 id="createroute"><a href="#createroute" class="header-anchor">#</a> createRoute</h3> <p>createRoute 位于 src/util/route.js</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/util/route.js</span>

<span class="token comment">// 生成Route</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRoute</span><span class="token punctuation">(</span>
  record<span class="token operator">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">,</span>
  location<span class="token operator">:</span> Location<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Location<span class="token punctuation">,</span>
  router<span class="token operator">?</span><span class="token operator">:</span> VueRouter
<span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stringifyQuery <span class="token operator">=</span> router <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>stringifyQuery<span class="token punctuation">;</span> <span class="token comment">// 支持传入自定义序列化qs方法</span>
  <span class="token keyword">let</span> query<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> location<span class="token punctuation">.</span>query <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    query <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// location.query为引用值，避免相互影响，进行深拷贝</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 生成Route</span>

  <span class="token keyword">const</span> route<span class="token operator">:</span> Route <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> location<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
    meta<span class="token operator">:</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>meta<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> location<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    hash<span class="token operator">:</span> location<span class="token punctuation">.</span>hash <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    query<span class="token punctuation">,</span>
    params<span class="token operator">:</span> location<span class="token punctuation">.</span>params <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    fullPath<span class="token operator">:</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> stringifyQuery<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 完整path</span>
    matched<span class="token operator">:</span> record <span class="token operator">?</span> <span class="token function">formatMatch</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 获取所有匹配的路由记录</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 如果是从其它路由对重定向过来的，则需要记录重定向之前的地址</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">.</span>redirectedFrom <span class="token operator">=</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">,</span> stringifyQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// 防止篡改</span>

  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>由于 <code>VueRouter</code> 支持传入自定义<code>序列化 queryString</code> 方法，所以第一步先获取序列化 <code>queryString</code> 的方法<br>
然后对 <code>query</code> 做了一个深拷贝，避免相互影响<br>
接下来就是生成新 <code>Route</code> 对象<br>
如果是从其他路由重定向过来的，则生成完整的重定向来源地址，并赋值给新生成的 <code>Route</code> 对象<br>
最后调用 <code>Object.freeze</code> 冻结新 <code>Route</code> 对象，因为 <code>Route</code> 对象是 <code>immutable</code> 的</p> <p>整个流程如下 create-route.png<br> <img src="/luvue/images/vuesourcecode/vue-router/vue-router31.awebp" alt="vuesourcecode/vue-router/vue-router31.awebp"></p> <p>可以看到生成 <code>Route</code> 时，会调用 <code>getFullPath</code> 生成完整 <code>fullPath</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/util/route.js</span>

<span class="token comment">// 获取完整path</span>
<span class="token keyword">function</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">,</span> query <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> hash <span class="token operator">=</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> _stringifyQuery<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stringify <span class="token operator">=</span> _stringifyQuery <span class="token operator">||</span> stringifyQuery<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>path <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">stringify</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token operator">+</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>可以看到 <code>getFullPath</code> 是在 <code>path</code> 后面追加了 <code>qs</code> 和 <code>hash</code></li> <li>另外生成 <code>Route</code> 时，还会调用 <code>formatMatch</code> 来获取所有关联的路由记录</li> <li>主要通过向上查找的形式找到所有关联的路由记录</li></ul> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/util/route.js</span>

<span class="token comment">// 格式化匹配的路由记录，当一个路由记录匹配了，如果其还有父路由记录，则父路由记录肯定也是匹配的</span>
<span class="token comment">// /foo/bar 匹配了，则其父路由对象 /foo 肯定也匹配了</span>
<span class="token keyword">function</span> <span class="token function">formatMatch</span><span class="token punctuation">(</span>record<span class="token operator">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 队列头添加，所以父record永远在前面，当前record永远在最后；在router-view组件中获取匹配的route record时会用到</span>
    record <span class="token operator">=</span> record<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>难道一条 <code>Route</code> 不是对应(关联)一个<code>路由对象</code>吗？<br>
其实在术语表介绍 <code>Route</code> 路由对象时，也有所提及，一个<code>Route 路由对象</code>可能会关联多个 <code>RouteRecord 路由记录对象</code><br>
这是因为存在嵌套路由的情况，当子路由记录被匹配到时，其实代表着父路由记录也一定被匹配到了，看下面例子</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 当有下面的路由规则</span>
routes<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/parent'</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> Parent<span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>访问<code>/parent/foo</code> 时，匹配到的路由记录有两个<br>
match-demo-record.png<br> <img src="/luvue/images/vuesourcecode/vue-router/vue-router32.awebp" alt="vuesourcecode/vue-router/vue-router32.awebp"></p> <p>而且精准匹配到路由记录一定是最后一个，所以后面会看到用 <code>route.matched[route.matched.length - 1]</code>来获取当前 <code>route</code> 对应的精准匹配的 <code>RouteRecord</code></p> <p>看完 createRoute 的实现，我们再来看看 alias 的实现</p> <h3 id="创建别名路由对象-alias"><a href="#创建别名路由对象-alias" class="header-anchor">#</a> 创建别名路由对象 alias</h3> <p>alias 位于 src/create-matcher.js</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/create-matcher.js</span>

<span class="token comment">// 创建别名Route</span>
<span class="token keyword">function</span> <span class="token function">alias</span><span class="token punctuation">(</span>
  record<span class="token operator">:</span> RouteRecord<span class="token punctuation">,</span>
  location<span class="token operator">:</span> Location<span class="token punctuation">,</span>
  matchAs<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
  <span class="token comment">// 获取别名的完整路径</span>
  <span class="token keyword">const</span> aliasedPath <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>
    matchAs<span class="token punctuation">,</span>
    location<span class="token punctuation">.</span>params<span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">aliased route with path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>matchAs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取别名匹配的原始Route</span>

  <span class="token keyword">const</span> aliasedMatch <span class="token operator">=</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    _normalized<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> aliasedPath<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>aliasedMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> matched <span class="token operator">=</span> aliasedMatch<span class="token punctuation">.</span>matched<span class="token punctuation">;</span>
    <span class="token keyword">const</span> aliasedRecord <span class="token operator">=</span> matched<span class="token punctuation">[</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 找到所有匹配的路由记录的最后一个，即当前匹配的路由记录，逻辑见route.js formatMatch方法</span>
    location<span class="token punctuation">.</span>params <span class="token operator">=</span> aliasedMatch<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>aliasedRecord<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>逻辑如下</p> <ul><li>先拿 <code>matchAs</code> 得到 <code>aliasedPath</code>，</li> <li>然后拿 <code>aliasedPath</code> 走一遍 <code>match</code> 得到 <code>aliasedMatch</code> 路由对象</li> <li><code>aliasedMatch</code> 如果存在，拿 <code>aliasedMatch</code> 精准匹配的路由记录对象和 <code>location</code>，生成<code>路由对象</code>返回</li> <li>不存在，则创建一个新的<code>路由对象</code>返回</li></ul> <p>可能有点绕，我们举个例</p> <ul><li>前面我们知道，<code>/a</code>设置了别名<code>/b</code>时，会生成两条路由记录，且<code>/b</code>的路由记录上的<code>matchAs</code>为<code>/a</code></li> <li>此处传入的 <code>alias</code> 的 <code>matchAs</code> 就相当于<code>/a</code>，先拿 <code>matchAs</code> 即<code>/a</code> 得到填充过 <code>params</code> 的路径</li> <li>再以此路径调用 match 找到匹配的路由对象，记为 <code>routeA</code></li> <li>前面也提过，路由对象会关联路由记录，所以从 routeA 中可以得到精准匹配的路由记录 <code>routeRecordA</code></li> <li>拿此路由记录和<code>/b</code> 的 <code>location</code> 去生成路由对象并返回</li> <li>这样就实现了官网上说的<code>/a 的别名是 /b，意味着，当用户访问 /b 时，URL 会保持为 /b，但是路由匹配则为 /a，就像用户访问 /a 一样</code>。效果</li></ul> <p>活动图如下 alias.png
<img src="/luvue/images/vuesourcecode/vue-router/vue-router33.awebp" alt="vuesourcecode/vue-router/vue-router33.awebp"></p> <p>我们再来看看 redirect 的实现</p> <h3 id="创建重定向路由对象-redirect"><a href="#创建重定向路由对象-redirect" class="header-anchor">#</a> 创建重定向路由对象 redirect</h3> <p>我们先看下 record.redirect 可能的几种情况；
<code>https://router.vuejs.org/zh/guide/essentials/redirect-and-alias.html#重定向</code></p> <ul><li>字符串<code>{redirect:'/'}</code></li> <li>对象<code>{redirect:{path:'/test'}}</code>、<code>{redirect:{name:'Test'}}</code></li> <li>也支持传入函数<code>{redirect:to=&gt;{ return {name:'Test'}}}</code></li></ul> <p>我们先看这个 redirect 方法的入口</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/create-matcher.js _createRoute方法内部</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>redirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> redirectedFrom <span class="token operator">||</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>由于存在多次重定向的场景，所以需要保留首次触发重定向的地址即 <code>redirectedFrom</code></p> <ul><li><code>/a</code> -&gt; <code>/b</code> -&gt; <code>/c</code>，在<code>/c</code>中需要保留首次触发重定向的地址即<code>/a</code></li></ul> <p>多次重定向，如何保留首次触发重定向的地址呢？</p> <ul><li>在第一次重定向时，<code>redirectedFrom</code> 没有值</li> <li>在 <code>redirect</code> 方法内部会将 <code>location</code> 做为 <code>redirectedFrom</code> 参数调用 <code>match</code> 方法，match 如果发现仍然需要重定向，则会继续调用 <code>redirect</code>，此时 <code>redirectedFrom</code> 是有值的，就是首次传入的 location，依次循环，这样就完成了初始地址的传递</li></ul> <p>可以看下下面的例子</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/baz'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Baz<span class="token punctuation">,</span> redirect<span class="token operator">:</span> <span class="token string">'/foo'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// named redirect</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/named-redirect'</span><span class="token punctuation">,</span> redirect<span class="token operator">:</span> <span class="token string">'/baz'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// src/create-matcher.js _createRoute方法内部</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>redirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token string">'redirect count:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 统计调用次数</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'record:'</span><span class="token punctuation">,</span> record<span class="token punctuation">,</span> <span class="token string">'redirectedFrom:'</span><span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印重定向初始来源地址</span>
  <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> redirectedFrom <span class="token operator">||</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>当我们访问<code>/named-redirect</code> 路由时(触发路由跳转)，会重定向到<code>/baz</code>，<code>/baz</code> 又会重定向<code>到/foo</code>，最终展示 Foo 组件；所以，redirect 方法应该会被调用两次；</p> <p>我们可以看下上面例子的输出 redirect-demo.png
<img src="/luvue/images/vuesourcecode/vue-router/vue-router34.awebp" alt="vuesourcecode/vue-router/vue-router34.awebp"></p> <p>会发现 <code>redirect</code> 方法被调用了四次，前两次是路由跳转导致的 <code>redirect</code> 调用，后两次则是组件渲染时，需要解析路由从而触发的 <code>redirect</code> 调用；</p> <p>可以对比下调用栈</p> <ul><li>redirect-stack-1.png
<img src="/luvue/images/vuesourcecode/vue-router/vue-router35.awebp" alt="vuesourcecode/vue-router/vue-router35.awebp"></li> <li>redirect-stack-2.png
<img src="/luvue/images/vuesourcecode/vue-router/vue-router36.awebp" alt="vuesourcecode/vue-router/vue-router36.awebp"></li> <li>可以看到第一、第二次的 redirect 是由 transitionTo 触发的</li> <li>redirect-stack-3.png
<img src="/luvue/images/vuesourcecode/vue-router/vue-router37.awebp" alt="vuesourcecode/vue-router/vue-router37.awebp"></li> <li>redirect-stack-4.png
<img src="/luvue/images/vuesourcecode/vue-router/vue-router38.awebp" alt="vuesourcecode/vue-router/vue-router38.awebp"></li> <li>而第三、第四次都是组件渲染 render 调用 resolve 触发的</li></ul> <p>可以看到第一次调用<code>redirect</code>是从<code>/named-redirect</code>重定向到<code>/baz</code>，此时<code>redirectFrom</code>是没有值的<br>
而第二次调用是从<code>/baz</code>重定向到<code>/foo</code>，此时<code>redirectFrom</code>就是触发第一次重定向的地址<code>/named-redirect</code><br>
而且最终的<code>$route</code>上也会有个<code>redirectFrom</code>保留了触发第一次重定向的地址</p> <p>上面我们只是看了 redirectFrom 的意义，下面我们看看 redirect 的具体实现</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/create-matcher.js createMatcher方法内</span>
<span class="token comment">// 创建重定向Route</span>
<span class="token keyword">function</span> <span class="token function">redirect</span><span class="token punctuation">(</span>
  record<span class="token operator">:</span> RouteRecord<span class="token punctuation">,</span> <span class="token comment">// 触发重定向的路由记录(需要进行重定向的路由记录，包含redirect)</span>
  location<span class="token operator">:</span> Location <span class="token comment">// 触发重定向的初始地址()</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">const</span> originalRedirect <span class="token operator">=</span> record<span class="token punctuation">.</span>redirect<span class="token punctuation">;</span>
  <span class="token keyword">let</span> redirect <span class="token operator">=</span>
    <span class="token keyword">typeof</span> originalRedirect <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token comment">// redirect支持传入函数;https://router.vuejs.org/zh/guide/essentials/redirect-and-alias.html#重定向</span>
      <span class="token operator">?</span> <span class="token function">originalRedirect</span><span class="token punctuation">(</span><span class="token function">createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> originalRedirect<span class="token punctuation">;</span> <span class="token comment">// redirect返回的是一个路径path，如'/bar'</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> redirect <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redirect <span class="token operator">=</span> <span class="token punctuation">{</span> path<span class="token operator">:</span> redirect <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// originalRedirect函数返回一个非string、非object的值时，给予警告，并创建一个空Route</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redirect <span class="token operator">||</span> <span class="token keyword">typeof</span> redirect <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid redirect option: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>redirect<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// 到这一步，redirect一定是个object</span>

  <span class="token keyword">const</span> re<span class="token operator">:</span> Object <span class="token operator">=</span> redirect<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> re<span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> query<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> params <span class="token punctuation">}</span> <span class="token operator">=</span> location<span class="token punctuation">;</span>

  query <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'query'</span><span class="token punctuation">)</span> <span class="token operator">?</span> re<span class="token punctuation">.</span>query <span class="token operator">:</span> query<span class="token punctuation">;</span>
  hash <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'hash'</span><span class="token punctuation">)</span> <span class="token operator">?</span> re<span class="token punctuation">.</span>hash <span class="token operator">:</span> hash<span class="token punctuation">;</span>
  params <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'params'</span><span class="token punctuation">)</span> <span class="token operator">?</span> re<span class="token punctuation">.</span>params <span class="token operator">:</span> params<span class="token punctuation">;</span> <span class="token comment">// 重定向是命名路由形式</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// resolved named direct</span>
    <span class="token keyword">const</span> targetRecord <span class="token operator">=</span> nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 未找到命名路由警告</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>targetRecord<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">redirect failed: named route &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; not found.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">match</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        _normalized<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        name<span class="token punctuation">,</span>
        query<span class="token punctuation">,</span>
        hash<span class="token punctuation">,</span>
        params<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">undefined</span><span class="token punctuation">,</span>
      location
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重定向是path形式</span>
    <span class="token comment">// 1. resolve relative redirect，解析出完整路径</span>
    <span class="token keyword">const</span> rawPath <span class="token operator">=</span> <span class="token function">resolveRecordPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2. resolve params，填充params</span>
    <span class="token keyword">const</span> resolvedPath <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>
      rawPath<span class="token punctuation">,</span>
      params<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">redirect route with path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rawPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3. rematch with existing query and hash，重新匹配</span>
    <span class="token keyword">return</span> <span class="token function">match</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        _normalized<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span> resolvedPath<span class="token punctuation">,</span>
        query<span class="token punctuation">,</span>
        hash<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">undefined</span><span class="token punctuation">,</span>
      location
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid redirect option: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>redirect<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>可以看到首先对 record.redirect 进行规范化，统一生成一个 redirect 对象(重定向目标)</p> <p>为什么要进行规范化，前面也提过，redirect 支持字符串、对象、函数类型，所以需要规范化，方便后面统一处理</p> <p>接下来会优先取 redirect 的 query hash params 值来做 match，不存在时才会取初始地址 location 的 query hash params
接下来会判断重定向目标是命名形式还是 path 形式
命名形式</p> <p>先判断 nameMap 中有没有目标路由记录，没有则中断，并给予提示；
再重走 match 流程，并将 location 做为 redirectedFrom 传入，这样就完成了 redirectedFrom 的传递闭环
match 里面会继续判断是否有重定向，这样就覆盖了多重重定向的场景</p> <p>path 形式</p> <p>拿 path 匹配，需要获取完整路径，所以先从 record 拿出原始路径 rawPath 并填充前面解析出的 params 得出完整地址
再拿完整地址重走 match 流程，同时也将 location 做为 redirectedFrom 传入，完成 redirectedFrom 的传递闭环
match 里面会继续判断是否有重定向，这样就覆盖了多重重定向的场景</p> <p>如果既不是命名形式也不是 path 形式，则直接创建一个新路由对象返回
流程如下</p> <p>redirect-full.png
<img src="/luvue/images/vuesourcecode/vue-router/vue-router39.awebp" alt="vuesourcecode/vue-router/vue-router39.awebp"></p> <h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <ul><li>路由匹配的过程，其实就是拿<code>地址 RawLocation</code> 生成<code>路由对象 Route</code> 的过程，这中间<code>路由记录 RouteRecord</code> 起中间桥梁的作用，因为路由记录上保存了生成路由对象的重要信息；所以流程应该是拿地址从路由映射表中找到对应的<code>路由记录</code>，然后拿<code>路由记录</code>生成<code>路由对象</code></li> <li>上述匹配逻辑主要由 match 函数实现的，关键逻辑包含地址格式化 <code>normalizeLocation</code>、地址是否匹配判断 matchRoute、填充参数 fillParams、创建路由对象<code>_createRoute</code></li> <li>在 <code>normalizeLocation</code> 时，会对 rawLocation 进行规范化，方便后续处理</li> <li>在 <code>matchRoute</code> 时，会借助 <code>path-to-regexp</code> 检测地址是否匹配并提取出 params</li> <li><code>fillParams</code> 可以看做是提取 params 的逆向操作，主要用来对地址中的动态部分进行填充</li> <li>在<code>_createRoute</code> 时，会分别处理别名、重定向、多重重定向等场景</li> <li>经过上述流程，就可以拿到 <code>RawLocation</code> 对应的 Route</li> <li>拿到 Route，我们就可以进行导航的解析</li></ul> <h2 id="导航解析-确认-流程"><a href="#导航解析-确认-流程" class="header-anchor">#</a> 导航解析(确认)流程</h2> <p>前面提过在 transitionTo 方法中，调用完 match 方法得到目标 Route 后，就会调用 confirmTransition 方法来做导航解析<br>
我们知道 vue-router 在路由跳转时，会按顺序触发各种钩子、守卫函数，例如 beforeRouteLeave、beforeRouteEnter 等等；<br>
首先这些钩子、守卫有的是定义在 vue-router 实例上的，有的是路由独享的，有的是位于.vue 组件中的，所以第一步必须抽出这些钩子、守卫函数统一处理<br>
其次这些钩子、守卫是按顺序依次执行的，所以需要设计一个队列和迭代器来保证顺序执行<br>
最后还有一些特殊场景需要处理，例如异步路由组件如何保证顺序执行<br>
上述的相关逻辑封装在 confirmTransition 中<br>
confirmTransition 方法被定义在 src/base.js 中</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/base.js History类中</span>

<span class="token comment">// 确认路由跳转</span>
<span class="token function">confirmTransition</span> <span class="token punctuation">(</span><span class="token comment">/* to*/</span>route<span class="token operator">:</span> Route<span class="token punctuation">,</span> onComplete<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token comment">/* from */</span>

  <span class="token comment">// 取消</span>
  <span class="token keyword">const</span> <span class="token function-variable function">abort</span> <span class="token operator">=</span> err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// after merging https://github.com/vuejs/vue-router/pull/2771 we</span>
    <span class="token comment">// When the user navigates through history through back/forward buttons</span>
    <span class="token comment">// we do not want to throw the error. We only throw it if directly calling</span>
    <span class="token comment">// push/replace. That's why it's not included in isError</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isExtendedError</span><span class="token punctuation">(</span>NavigationDuplicated<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'uncaught error during route navigation:'</span><span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    onAbort <span class="token operator">&amp;&amp;</span> <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 相同Route，报重复错误</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token function">isSameRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token comment">// in the case the route map has been dynamically appended to</span>
    <span class="token comment">// 防止route map 被动态改变了</span>
    route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">===</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ensureURL由子类实现，主要根据传参确定是添加还是替换一个记录</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 替换当前历史记录</span>
    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NavigationDuplicated</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 对比前后route的RouteRecord，找出需要更新、失活、激活的的路由记录</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> updated<span class="token punctuation">,</span> deactivated<span class="token punctuation">,</span> activated <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">,</span>
    route<span class="token punctuation">.</span>matched
  <span class="token punctuation">)</span>

  <span class="token comment">// 生成需要执行的守卫、钩子队列</span>
  <span class="token keyword">const</span> queue<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
    <span class="token comment">// in-component leave guards</span>
    <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 提取路由组件中所有beforeRouteLeave守卫</span>
    <span class="token comment">// global before hooks</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span> <span class="token comment">// 全局的beforeEach守卫</span>
    <span class="token comment">// in-component update hooks</span>
    <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 提取路由组件中所有beforeRouteUpdate守卫</span>
    <span class="token comment">// in-config enter guards</span>
    activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 路由独享的beforeEnter守卫</span>
    <span class="token comment">// async components</span>
    <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span><span class="token comment">// 解析异步组件</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> route <span class="token comment">// 记录将要跳转的route，方便取消对比用</span>

  <span class="token comment">// 迭代函数</span>
  <span class="token keyword">const</span> <span class="token function-variable function">iterator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 当发现to发生变化，则代表需要取消</span>
      <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">hook</span><span class="token punctuation">(</span><span class="token comment">/* to*/</span>route<span class="token punctuation">,</span> <span class="token comment">/* from*/</span>current<span class="token punctuation">,</span> <span class="token comment">/* next*/</span><span class="token punctuation">(</span>to<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">isError</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// next(false) -&gt; abort navigation, ensure current URL</span>
          <span class="token comment">// next(false) -&gt; 取消跳转，添加一个新历史记录(但由于url地址未发生变化，所以并未添加记录)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token function">abort</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token comment">// next('/')</span>
          <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token keyword">typeof</span> to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// next({path:'/'})或next({name:'Home'})</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// next('/') or next({ path: '/' }) -&gt; redirect</span>
          <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 取消当前</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 调用子类方法的替换记录</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 调用子类方法的添加记录</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// confirm transition and pass on the value</span>
          <span class="token comment">// next()</span>
          <span class="token function">next</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">abort</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 执行队列</span>
  <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token comment">/* 执行结束回调*/</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 保存beforeRouteEnter中传给next的回调函数</span>
    <span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route <span class="token comment">// 表示跳转结束</span>

    <span class="token comment">// wait until async components are resolved before</span>
    <span class="token comment">// extracting in-component enter guards</span>
    <span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span> <span class="token comment">// 等待异步组件解析完，再抽取组件内的beforeRouteEnter守卫</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span><span class="token comment">// beforeResolve hooks</span>
    <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token comment">/* 执行结束回调*/</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>

      <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token comment">// 执行onComplete回调，onComplete中会调用updateRoute方法，内部会触发afterEach钩子</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 调用 beforeRouteEnter 守卫中传给 next 的回调函数</span>
          <span class="token comment">// next(vm=&gt;xxx)</span>
          postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br></div></div><p>我们可以先看下方法签名</p> <ul><li><code>route</code> 目标路由对象，需要解析的目标，可以理解为路由跳转时的 to 对象，而 current 则可以理解为 from 对象。</li> <li><code>onComplete</code> 跳转完成的回调</li> <li><code>onAbort</code> 取消、错误的回调</li></ul> <p>看下主要逻辑</p> <ul><li>首先处理了重复跳转的问题</li> <li>然后通过对比找出需要更新、失活、激活的路由记录</li> <li>从上述三种路由记录中抽取出对应钩子、守卫函数</li> <li>将钩子及守卫函数放入队列中并执行</li></ul> <h3 id="判断重复跳转"><a href="#判断重复跳转" class="header-anchor">#</a> 判断重复跳转</h3> <p>在判断重复跳转前定义了 <code>abort</code> 方法，它主要对 <code>onAbort</code> 方法做了一层包装；这个方法在导航发生取消时会被调用到</p> <p>它接收一个 <code>err</code> 参数，如果有注册错误回调并且 err 为非 <code>NavigationDuplicated</code> 错误则遍历 errorCbs 列表执行其中的错误回调<br>
最后调用 <code>onAbort</code> 回调并传入 err 参数交给外部处理</p> <p>接下来判断了是否重复跳转，主要利用 <code>isSameRoute</code> 检测了当前路由对象和目标路由对象是否相同，若相同且二者匹配到路由记录数量相同，则视为重复跳转，此时调用 abort 方法并传入 <code>NavigationDuplicated</code> 错误并终止流程<br> <code>isSameRoute</code> 主要判断了 <code>path、name、hash、query、params</code> 等关键信息是否相同，若相同则视为相同路由对象</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/util/route.js</span>

<span class="token comment">// 是否相同route</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isSameRoute</span><span class="token punctuation">(</span>a<span class="token operator">:</span> Route<span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token operator">?</span>Route<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">===</span> <span class="token constant">START</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">===</span> b<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>path <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// path都存在，比较path、hash、query是否相同</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      a<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>trailingSlashRE<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">===</span>
        b<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>trailingSlashRE<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      a<span class="token punctuation">.</span>hash <span class="token operator">===</span> b<span class="token punctuation">.</span>hash <span class="token operator">&amp;&amp;</span>
      <span class="token function">isObjectEqual</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>query<span class="token punctuation">,</span> b<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// name都存在，比较name、hash、query、params是否相同</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      a<span class="token punctuation">.</span>name <span class="token operator">===</span> b<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span>
      a<span class="token punctuation">.</span>hash <span class="token operator">===</span> b<span class="token punctuation">.</span>hash <span class="token operator">&amp;&amp;</span>
      <span class="token function">isObjectEqual</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>query<span class="token punctuation">,</span> b<span class="token punctuation">.</span>query<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">isObjectEqual</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>params<span class="token punctuation">,</span> b<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>注意，在确定是重复跳转后，仍然会调用子类的 ensureURL 方法来更新 url</p> <h3 id="对比找出需要更新、失活、激活的路由记录"><a href="#对比找出需要更新、失活、激活的路由记录" class="header-anchor">#</a> 对比找出需要更新、失活、激活的路由记录</h3> <p>判断完重复跳转后，就需要对比 <code>from</code>、<code>to</code> 路由对象，找出哪些路由记录需要更新，哪些失活、哪些需要激活，用来后续抽取钩子、守卫函数</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/history/base.js confirmTransition方法中</span>
<span class="token comment">// 对比前后route的RouteRecord，找出需要更新、失活、激活的的路由记录</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> updated<span class="token punctuation">,</span> deactivated<span class="token punctuation">,</span> activated <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">,</span>
  route<span class="token punctuation">.</span>matched
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>可以看到逻辑封装在了 <code>resolveQueue</code> 方法中，传入了当前和目标路由对象的记录列表，从返回值中解构出了 <code>updated</code>, <code>deactivated</code>, <code>activated</code></li> <li>看下 <code>resolveQueue</code> 实现</li></ul> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 对比curren、next的路由记录列表，找出需要更新、失活、激活的路由记录</span>
<span class="token keyword">function</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span>
  current<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  next<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  updated<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  activated<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  deactivated<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i<span class="token punctuation">;</span>
  <span class="token keyword">const</span> max <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>length<span class="token punctuation">,</span> next<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 找到首个不相等的路由记录索引</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!==</span> next<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token comment">// eg // current:[1,2,3] // next:[1,2,3,4,5] // i为3 // 需要更新的为[1,2,3] // 需要激活的为[4,5] // 需要失活的为[]</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    updated<span class="token operator">:</span> next<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 索引左侧是需要更新的</span>
    activated<span class="token operator">:</span> next<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 索引右侧是需要激活的</span>
    deactivated<span class="token operator">:</span> current<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 当前索引右侧是需要失活的</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>逻辑很简单</p> <ul><li>首先找出 <code>current</code> 和 <code>next</code> 列表长度的最大值，</li> <li>然后以此为循环最大次数循环找出首个不相等的路由记录索引</li> <li>以此索引为分界线，<code>next 列表</code>当前索引左侧为需要更新的路由记录、索引及索引右侧的为需要激活的路由记录</li> <li><code>current</code> 列表索引及右侧是需要失活的路由记录</li></ul> <p>举例</p> <ul><li>current 为:[1,2,3]、next 为[1,2,3,4,5]，当前路由对象包含 1、2、3 三个路由记录，目标路由对象包含 1、2、3、4、5 五个路由记录</li> <li>计算后 max 为 5</li> <li>循环，发现首个不相等的索引为 3</li> <li>所以需要更新的为 next.slice(0,3)即 1、2、3</li> <li>需要激活的为 next.slice(3)即 4、5</li> <li>需要失活的为 current.slice(3)，没有需要失活的</li> <li>找出了需要更新、激活、失活的路由记录，我们就可以从中抽取出对应的钩子、守卫函数</li></ul> <h3 id="抽取钩子、守卫函数、解析异步组件"><a href="#抽取钩子、守卫函数、解析异步组件" class="header-anchor">#</a> 抽取钩子、守卫函数、解析异步组件</h3> <p>抽取钩子、守卫函数、解析异步组件</p> <ul><li><code>router.beforeEach</code>全局前置守卫</li> <li><code>router.beforeResolve</code>全局解析守卫(v2.5.0 新增)</li> <li><code>router.afterEach</code>全局后置钩子</li> <li><code>RouteConfig.beforeEnter</code>路由独享的守卫</li> <li><code>vm.beforeRouteEntervue</code> 组件内路由进入守卫</li> <li><code>vm.beforeRouteUpdatevue</code> 组件内路由更新守卫(v2.2 新增)</li> <li><code>vm.beforeRouteLeavevue</code> 组件内路由离开守卫</li></ul> <p>可以看到有些是定义 <code>VueRouter</code> 实例上的，有些是定义在配置规则 <code>RouteConfig</code> 上的，有些是定义在 <code>RouteComponent</code> 路由组件上的</p> <ul><li>前两者的钩子、守卫是很容易获取到的，因为我们在 <code>History</code> 类中持有了 <code>VueRouter</code> 实例，很容易访问到这些守卫、钩子并且几乎不需要做额外处理就可以直接执行；</li> <li>唯一不好处理的是定义在 <code>RouteComponent 路由组件</code>中的守卫函数，需要借助 <code>RouteRecord</code> 拿到所有 <code>RouteComponent</code> 路由组件并从中抽取出对应守卫，最后还要为其绑定上下文，保证执行结果正确；</li></ul> <p>上节，我们已经拿到需要更新、激活、失活的 RouteRecord 路由记录，我们看下分别要从中抽取出哪些守卫</p> <ul><li><code>deactivated</code> 中抽取 <code>beforeRouteLeave</code></li> <li><code>updated</code> 中抽取 <code>beforeRouteUpdate</code></li> <li><code>activated</code> 中抽取 <code>beforeRouteEnter</code>，这里存在一个特殊场景，就是异步路由组件，需要等待异步路由组件解析完成后，才能抽取 <code>beforeRouteEnter</code> 守卫，这个后面会讲</li></ul> <p>我们先看下抽取的入口代码</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/history/base.js confirmTransition方法内</span>
<span class="token comment">// 生成需要执行的守卫、钩子队列</span>
<span class="token keyword">const</span> queue<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
  <span class="token comment">// in-component leave guards</span>
  <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 提取路由组件中所有beforeRouteLeave守卫 // global before hooks</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span> <span class="token comment">// 全局的beforeEach守卫 // in-component update hooks</span>
  <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 提取路由组件中所有beforeRouteUpdate守卫 // in-config enter guards</span>
  activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 路由独享的beforeEnter守卫 // async components</span>
  <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span> <span class="token comment">// 解析异步组件</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到定义了一个队列 queue<br>
依次做了下面的事</p> <ul><li>抽取了 deactivated 中的 beforeRouteLeave 守卫</li> <li>获取了 VueRouter 实例上定义的 beforeEach 守卫
beforeEach 守卫是直接定义在 VueRouter 实例上的</li> <li>从 updated 中抽取了 beforeRouteUpdate 守卫</li> <li>从 activated 中获取了路由独享的 beforeEnter 守卫
beforeEnter 守卫最初是定义在 RouteConfig 上的，后面又传递给路由记录，所以在路由记录上能直接获取到</li> <li>解析 activated 中的异步路由组件
路由组件支持 import()动态导入，所以这里要处理</li></ul> <p>我们先看方法名很类似的 extractLeaveGuards 和 extractUpdateHooks</p> <h3 id="extractleaveguards、extractupdatehooks"><a href="#extractleaveguards、extractupdatehooks" class="header-anchor">#</a> extractLeaveGuards、extractUpdateHooks</h3> <p>二者都位于 src/base.js</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/base.js</span>

<span class="token comment">// 传入路由记录列表，提取出beforeRouteLeave守卫并逆序输出</span>
<span class="token keyword">function</span> <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token builtin">Function</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">,</span> <span class="token string">'beforeRouteLeave'</span><span class="token punctuation">,</span> bindGuard<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 传入路由记录列表，提取出beforeRouteUpdate钩子</span>
<span class="token keyword">function</span> <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token builtin">Function</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>updated<span class="token punctuation">,</span> <span class="token string">'beforeRouteUpdate'</span><span class="token punctuation">,</span> bindGuard<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到二者内部都调用了 <code>extractGuards</code>，前者多传了一个参数 <code>true</code></p> <p>我们再看下 <code>extractGuards</code></p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/base.js</span>

<span class="token comment">// 提取守卫</span>
<span class="token keyword">function</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>
  records<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token comment">// 要提取的守卫名</span>
  bind<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> <span class="token comment">// 绑定守卫上下文函数</span>
  reverse<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">// 是否需要逆序</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token builtin">Function</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> guards <span class="token operator">=</span> <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token punctuation">(</span>
    def <span class="token comment">/*路由组件定义*/</span><span class="token punctuation">,</span>
    instance <span class="token comment">/*router-view实例*/</span><span class="token punctuation">,</span>
    match <span class="token comment">/*路由记录*/</span><span class="token punctuation">,</span>
    key <span class="token comment">/*视图名*/</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> guard <span class="token operator">=</span> <span class="token function">extractGuard</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 提取出路由组件中的守卫函数 // 为守卫绑定上下文</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>guard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span>
        <span class="token operator">?</span> guard<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 扁平化 + 逆序</span>
  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>reverse <span class="token operator">?</span> guards<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> guards<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>看下方法签名</p> <ul><li>接收一个路由记录数组 <code>records</code> <ul><li>即 <code>extractLeaveGuards</code> 中传入的 <code>deactivated</code> <code>路由记录数组；extractUpdateHooks</code> 中传入的 <code>updated</code> 路由记录数组</li></ul></li> <li>接收一个需要提取的守卫名 <code>name</code> <ul><li><code>beforeRouteLeave</code> 和 <code>beforeRouteUpdate</code> 字符串</li></ul></li> <li>一个绑定守卫上下的函数 <code>bind</code> <ul><li><code>extractLeaveGuards、extractUpdateHooks</code> 传递的都是 <code>bindGuard</code> 方法，这个方法我们在下面解析</li></ul></li> <li>以及一个是否需要逆序输出的 <code>reverse</code> 布尔值；可选参数；
<ul><li><code>extractLeaveGuards</code> 传递的是 <code>true</code>，代表返回的数组(守卫函数数组)需要逆序输出；</li></ul></li> <li>返回一个 item 是 Function 的数组</li></ul> <p>看下内部逻辑</p> <ul><li>调用 <code>flatMapComponents</code> 传入 <code>records</code> 和一个接收 <code>def, instance, match, key</code> 参数的箭头函数，返回一个 <code>guards</code> 守卫数组</li> <li>然后根据 <code>reverse</code> 来决定是否对 <code>guards</code> 数组做逆序处理
<ul><li>为何需要逆序?</li> <li>在 <code>createRoute</code> 章节也提过，在保存路由记录时是逆序的，精准匹配的路由记录在数组最后(length - 1 位置)，父记录在前</li> <li>部分守卫函数需要逆序逆序执行，例如 <code>beforeRouteLeave</code>，它需要先在精准匹配的路由组件上调用，再在父组件上调用</li></ul></li> <li>最后调用 <code>flatten</code> 将 <code>guards</code> 扁平化</li></ul> <p>先看下 flatMapComponents 实现</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/util/resolve-components.js</span>

<span class="token comment">// 扁平化路由记录中的路由组件</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>
  matched<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 路由记录数组</span>
  fn<span class="token operator">:</span> <span class="token builtin">Function</span> <span class="token comment">// 回调函数</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token builtin">Function</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>
    matched<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>components<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>
          m<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 命名视图对应的路由组件定义；一般对应fn的入参def</span>
          m<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// router-view实例；一般对应fn的入参_或instance</span>
          m<span class="token punctuation">,</span> <span class="token comment">// 匹配的路由记录；一般对应fn的入参match</span>
          key <span class="token comment">// 命名视图的key；一般对应fn的入参key</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>可以看到其接收一个路由记录数组 <code>matched</code> 和一个函数 <code>fn</code>，返回一个经过 <code>flatten</code> 处理的数组</p> <ul><li><code>matched</code> 就是我们传入的 <code>records</code></li> <li><code>fn</code> 就是接收 <code>def, instance, match, key</code> 参数的箭头函数</li></ul> <p>这个方法主要是遍历路由记录中的每个路由组件并用其做入参依次调用外部函数 fn，返回结果由 fn 函数决定，最后将结果数组扁平化输出</p> <ul><li>在解析异步组件时也会用到此方法</li></ul> <p>其会对传入的 <code>records</code> 调用 <code>map</code> 方法，并遍历每个 <code>record</code> 上定义的 <code>components</code> 字段，并对 <code>components</code> 再次进行 <code>map</code> 遍历，然后调用传入的 <code>fn，map</code> 结果就是 <code>fn</code> 返回的结果</p> <p><code>components</code> 字段是定义命名视图用的，长下面这样，<code>key</code> 为视图名，<code>value</code> 为对应路由组件</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>components<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span><span class="token operator">:</span> Foo<span class="token punctuation">,</span>
    a<span class="token operator">:</span> Bar<span class="token punctuation">,</span>
    b<span class="token operator">:</span> Baz
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>所以传入的 fn，即接收 <code>def, instance, match, key</code> 参数的箭头函数的四个参数分别为</p> <ul><li><code>def</code> 对应 <code>m.components[key]</code>即路由组件定义(Foo、Bar、Baz)</li> <li><code>instance</code> 对应 <code>m.instances[key]</code>是 router-view 组件实例，关于路由记录和 route-view 是如何关联的，会在介绍 view 组件时解析</li> <li>m 对应的就是当前遍历到的路由记录</li> <li>key 是当前遍历到的视图名</li></ul> <p>大体逻辑如下 flat-map-components.png<br> <img src="/luvue/images/vuesourcecode/vue-router/vue-router40.awebp" alt="vuesourcecode/vue-router/vue-router40.awebp"></p> <p>我们看下箭头函数内部的逻辑</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> guards <span class="token operator">=</span> <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token punctuation">(</span>
  def <span class="token comment">/*路由组件定义*/</span><span class="token punctuation">,</span>
  instance <span class="token comment">/*router-view实例*/</span><span class="token punctuation">,</span>
  match <span class="token comment">/*路由记录*/</span><span class="token punctuation">,</span>
  key <span class="token comment">/*视图名*/</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> guard <span class="token operator">=</span> <span class="token function">extractGuard</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 提取出路由组件中的守卫函数 // 为守卫绑定上下文</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>guard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span>
      <span class="token operator">?</span> guard<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>首先调用 <code>extractGuard</code> 从路由组件定义中直接抽取出对应 <code>name</code> 的守卫函数<br>
接下来调用传入 <code>extractGuards</code> 的 bind 方法为守卫绑定上下文</p> <p>我们看下 extractGuard 实现</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/base.js</span>

<span class="token comment">// 提取单个守卫</span>
<span class="token keyword">function</span> <span class="token function">extractGuard</span><span class="token punctuation">(</span>
  def<span class="token operator">:</span> Object <span class="token operator">|</span> <span class="token builtin">Function</span><span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> NavigationGuard <span class="token operator">|</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> def <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// extend now so that global mixins are applied.</span>
    def <span class="token operator">=</span> _Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>def<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> def<span class="token punctuation">.</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>主要有两个逻辑</p> <ul><li>调用 extend 以应用全局 mixins</li> <li>返回对应守卫函数</li></ul> <p>提取完单个守卫后，就需要调用传入的 bind 方法对其绑定上下文；<br> <code>bind</code> 方法其实是 <code>bindGuard</code></p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/history/base.js</span>

<span class="token comment">// 将守卫的上下文绑定到vue实例(路由组件)</span>
<span class="token keyword">function</span> <span class="token function">bindGuard</span><span class="token punctuation">(</span>guard<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span> instance<span class="token operator">:</span> <span class="token operator">?</span>_Vue<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>NavigationGuard <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token comment">/*已经绑定过上下文的守卫函数*/</span> <span class="token function">boundRouteGuard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">guard</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>经过上面的上下文绑定，从路由组件中抽取出的守卫函数就又回来到路由组件上下文中执行了，这样就保证了守卫函数无论在何处被调用，都能返回正确的结果</p> <p>extractGuards 主要完成了从路由组件中抽取守卫函数并为其绑定上下文的工作</p> <p>extract-guards.png<br> <img src="/luvue/images/vuesourcecode/vue-router/vue-router41.awebp" alt="vuesourcecode/vue-router/vue-router41.awebp"></p> <p>接下来我们要对激活的路由记录进行异步组件的解析<br>
主要通过 <code>resolveAsyncComponents</code> 方法实现的</p> <h3 id="resolveasynccomponents"><a href="#resolveasynccomponents" class="header-anchor">#</a> resolveAsyncComponents</h3> <p>在看如何解析异步组件前，我们先看下 vue 中的异步组件长什么样？</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// https://cn.vuejs.org/v2/guide/components-dynamic-async.html#异步组件</span>

<span class="token comment">// 接收resolve,reject</span>
Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'async-example'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 向 `resolve` 回调传递组件定义</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;I am async!&lt;/div&gt;'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 结合require使用</span>
Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'async-webpack-example'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这个特殊的 `require` 语法将会告诉 webpack</span>
  <span class="token comment">// 自动将你的构建代码切割成多个包，这些包</span>
  <span class="token comment">// 会通过 Ajax 请求加载</span>
  <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./my-async-component'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 结合import()使用</span>
Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>
  <span class="token string">'async-webpack-example'</span><span class="token punctuation">,</span> <span class="token comment">// 这个动态导入会返回一个 `Promise` 对象。</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./my-async-component'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 局部注册</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'my-component'</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./my-async-component'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 带有加载状态</span>
<span class="token keyword">const</span> <span class="token function-variable function">AsyncComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 需要加载的组件 (应该是一个 `Promise` 对象)</span>
  component<span class="token operator">:</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./MyComponent.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 异步组件加载时使用的组件</span>
  loading<span class="token operator">:</span> LoadingComponent<span class="token punctuation">,</span> <span class="token comment">// 加载失败时使用的组件</span>
  error<span class="token operator">:</span> ErrorComponent<span class="token punctuation">,</span> <span class="token comment">// 展示加载时组件的延时时间。默认值是 200 (毫秒)</span>
  delay<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token comment">// 如果提供了超时时间且组件加载也超时了， // 则使用加载失败时使用的组件。默认值是：`Infinity`</span>
  timeout<span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>文档对异步组件的描述<code>是Vue 允许你以一个工厂函数的方式定义你的组件，这个工厂函数会异步解析你的组件定义</code><br>
可以理解为：异步组件是一个工厂函数，函数内<code>resolve、reject</code>组件的定义、返回一个<code>Promise</code>、返回一个带有特定标识字段的对象<br>
解析路由记录中的异步组件代码位于<code>src/util/resolve-components.js</code></p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/util/resolve-components.js</span>

<span class="token comment">// 解析异步组件，返回一个接收to, from, next参数的函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>matched<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Function</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> hasAsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>matched<span class="token punctuation">,</span> <span class="token punctuation">(</span>
      <span class="token comment">/*路由组件定义*/</span> def<span class="token punctuation">,</span>
      <span class="token comment">/*router-view实例*/</span> _<span class="token punctuation">,</span>
      <span class="token comment">/*路由记录*/</span> match<span class="token punctuation">,</span>
      <span class="token comment">/*视图名*/</span> key
    <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// if it's a function and doesn't have cid attached,</span>
      <span class="token comment">// assume it's an async component resolve function.</span>
      <span class="token comment">// we are not using Vue's default async resolving mechanism because</span>
      <span class="token comment">// we want to halt the navigation until the incoming component has been</span>
      <span class="token comment">// resolved.</span>
      <span class="token comment">// def.cid为实例构造函数标识；https://github.com/vuejs/vue/search?q=cid&amp;unscoped_q=cid</span>
      <span class="token comment">// 组件的定义是函数且组件cid还未设置，则认为其是一个异步组件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> def <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> def<span class="token punctuation">.</span>cid <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasAsync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        pending<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 解析</span>

        <span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 加载后的组件定义是一个esm</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isESModule</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            resolvedDef <span class="token operator">=</span> resolvedDef<span class="token punctuation">.</span>default<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token comment">// save resolved on async factory in case it's used elsewhere // 保留异步组件工厂函数，方便后续使用</span>
          def<span class="token punctuation">.</span>resolved <span class="token operator">=</span>
            <span class="token keyword">typeof</span> resolvedDef <span class="token operator">===</span> <span class="token string">'function'</span>
              <span class="token operator">?</span> resolvedDef
              <span class="token operator">:</span> _Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
          match<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> resolvedDef<span class="token punctuation">;</span> <span class="token comment">// 替换路由记录的命名视图中的组件</span>
          pending<span class="token operator">--</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 所有异步组件加载完</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 报错</span>
        <span class="token keyword">const</span> reject <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to resolve async component </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            error <span class="token operator">=</span> <span class="token function">isError</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">?</span> reason <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 异步组件，https://cn.vuejs.org/v2/guide/components-dynamic-async.html#异步组件</span>

        <span class="token keyword">let</span> res<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          res <span class="token operator">=</span> <span class="token function">def</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回promise</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// new syntax in Vue 2.3</span>
            <span class="token comment">// 处理加载状态，返回一个包对象；https://cn.vuejs.org/v2/guide/components-dynamic-async.html#处理加载状态</span>
            <span class="token keyword">const</span> comp <span class="token operator">=</span> res<span class="token punctuation">.</span>component<span class="token punctuation">;</span> <span class="token comment">// 是通过import()加载，返回的是一个promise</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> comp<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              comp<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没有异步组件，直接next</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasAsync<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><p>可以看到其接收一个路由记录数组 matched，返回一个接收 from、to、next 的函数，内部是异步组件的解析逻辑<br> <code>resolveAsyncComponents</code> 被调用时并不会执行解析异步组件的逻辑，因为其只会返回一个函数，返回的函数会在运行队列时才会被调用，这时才会解析异步组件<br>
队列的运行，我们后面再看，我们先看下返回的函数内部是什么逻辑</p> <ul><li>定义了一个是否有异步组件的标识字段 <code>hasAsync</code>、以及当前待解析的异步组件数量 <code>pending</code></li> <li>然后调用了 <code>flatMapComponents</code> 拿到 <code>records</code> 中的所有路由组件，并依次调用传入的回调方法</li> <li>回调方法会接收到被遍历的路由组件，此时需要判断这个路由组件是否是异步组件，如果是，则开始异步组件的解析，否则跳过</li> <li>如果遍历结束发现 <code>hasAsync</code> 仍然为 <code>false</code>，代表没有异步组件直接 <code>next()</code>进行下一步即可</li></ul> <p>如何确定某个组件是否是异步组件呢？</p> <ul><li>前面我们说过，在 vue 中异步组件一定是个工厂函数，内部会调用 resove、reject 或返回 Promise 或返回特定格式对象，总之他肯定是个函数</li> <li>其次 vue 中每个实例都会有个唯一标识 cid，如果有 cid 就代表已经生成相应实例，所以异步组件的 cid 一定为 undefined</li> <li>所以判断是否是异步组件的依据就是 <code>函数 &amp;&amp; cid === 'undefined'</code></li></ul> <p>如果判断是异步组件，则将 <code>hasAsync</code> 置为 <code>true</code> 并让 <code>pending</code> 自增，代表有发现异步组件，在解析完组件后 <code>pending</code> 自减，当 <code>pending&lt;=0</code> 则代表异步组件解析结束，可以调用 next 进行下一步<br>
前面提过，vue 的异步组件工厂函数会接收 <code>resolve、reject</code> 两个方法并在从服务器得到组件定义后被调用；
在接收到服务器返回异步组件的定义时，这两个方法会被传入异步组件工厂函数<br>
由于异步组件工厂函数会返回一个 <code>Promise</code> 函数或特定格式的对象，所以会有下面情况</p> <ul><li>如果是返回 Promise，则将这两方法再传入返回的 <code>Promise.then</code> 中</li> <li>如果返回特定格式对象，则找到 <code>component</code> 字段，并将这两方法再传入 <code>component.then</code> 中</li></ul> <p>由于 resolve、reject 已经被 once 包装，即使传入多次，也只会被执行一次<br>
我们看下 resolve、reject 方法<br>
他们都被一个 once 方法包裹以保证只会被执行一次</p> <p>reject</p> <ul><li>直接抛出一个错误并调用 next 传递到下一流程
resolve</li> <li>先判断下是否是 esm，若是，则取其.default 字段来获取组件定义</li> <li>拿到组件定义后，会先保留异步组件工厂函数，方便后续使用</li> <li>然后替换路由记录的命名视图中的对应组件，这就完成了组件的解析并绑定到路由记录上</li></ul> <p>再次重申上面提到的逻辑都是 resolveAsyncComponents 返回的函数逻辑，这个函数逻辑会等到队列被执行时才实际调用<br>
至此，我们的队列 queue 已经包含了抽取出来的守卫、钩子、包含解析异步组件逻辑的函数<br>
队列已经构建完成，下面我们来看看它是如何执行的</p> <h3 id="守卫队列的执行"><a href="#守卫队列的执行" class="header-anchor">#</a> 守卫队列的执行</h3> <p>队列的执行是通过 runQueue、iterator 相互配合来实现的</p> <h3 id="runqueue"><a href="#runqueue" class="header-anchor">#</a> runQueue</h3> <p>runQueue 方法位于 src/util/async.js</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/util/async.js</span>

<span class="token comment">/* @flow */</span>
<span class="token comment">// 队列执行函数</span>
<span class="token comment">// queue 需要执行的队列</span>
<span class="token comment">// fn 迭代函数</span>
<span class="token comment">// cb 回调函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">runQueue</span><span class="token punctuation">(</span>
  queue<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  fn<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span>
  cb<span class="token operator">:</span> <span class="token builtin">Function</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">step</span> <span class="token operator">=</span> <span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 全部执行完，执行回调</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 存在，执行迭代函数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>
          queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token comment">/* next*/</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 否则，跳到下个执行</span>
        <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">step</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>可以看到它接收一个队列 queue、一个迭代函数 fn、一个执行完毕的回调函数 cb<br>
内部是一个递归的实现<br>
定义了一个 step 函数并接收 一个标识队列执行步骤的 index<br>
必须通过手动调用 step 才能跳到下一个队列项的执行</p> <p>在解析组件时会用到</p> <p>当 index 大于等于队列的长度时(递归的结束条件)，代表队列项全执行完毕，可以调用 cb<br>
否则，若还有队列项，则继续调用迭代函数 fn 并传入队列项和跳转下个队列项的 step(index + 1)函数<br>
若无队列项了，则直接跳到下个队列项的执行<br>
递归通过 step(0)来激活</p> <h3 id="iterator"><a href="#iterator" class="header-anchor">#</a> iterator</h3> <p>迭代器相关代码好下</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/history/base.js</span>

<span class="token comment">// 迭代函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">iterator</span> <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当发现to发生变化，则代表需要取消</span>
    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">hook</span><span class="token punctuation">(</span>
      <span class="token comment">/* to*/</span> route<span class="token punctuation">,</span>
      <span class="token comment">/* from*/</span> current<span class="token punctuation">,</span>
      <span class="token comment">/* next*/</span> <span class="token punctuation">(</span>to<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">isError</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// next(false) -&gt; abort navigation, ensure current URL</span>
          <span class="token comment">// next(false) -&gt; 取消跳转，添加一个新历史记录(但由于url地址未发生变化，所以并未添加记录)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">abort</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token comment">// next('/')</span>
          <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token keyword">typeof</span> to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// next({path:'/'})或next({name:'Home'})</span>
          <span class="token comment">// next('/') or next({ path: '/' }) -&gt; redirect</span>
          <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取消当前</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 调用子类方法的替换记录</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 调用子类方法的添加记录</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// confirm transition and pass on the value</span>
          <span class="token comment">// next()</span>
          <span class="token function">next</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">abort</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>可以看到其接收一个 hook 也就是守卫队列中的守卫、钩子函数和 next 函数(runQueue 传递过来的 step 函数)<br>
当在执行的过程中，路由发生变化，会立即取消<br>
然后尝试调用 hook，并传入目标路由对象、当前路由对象、以及一个接收 to 的箭头函数<br>
其实这三个参数就对应守卫会接收到的 from、to、next 三个参数</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们知道守卫的 next 是一个 function，并能接收下面几种参数以满足不同的路由跳转需求</p> <ul><li><code>next()</code>: 进行管道中的下一个钩子。</li> <li><code>next(false)</code>: 中断当前的导航。</li> <li><code>next('/')</code>  或者  <code>next({ path: '/' })</code>: 跳转到一个不同的地址。当前的导航被中断，然后进行一个新的导航。你可以向  next  传递任意位置对象，且允许设置诸如  replace: true、name: 'home'  之类的选项以及任何用在  router-link  的  to prop  或  router.push  中的选项。</li> <li><code>next(error)</code>: (2.4.0+) 如果传入  next  的参数是一个  Error  实例，则导航会被终止且该错误会被传递给  router.onError()  注册过的回调。</li></ul> <p>上面接收 to 的箭头函数就处理了上述几种场景<br>
队列中的每一项都会在 iterator 中被调用一次并通过 next()到跳转到下一个队列项的执行<br>
了解了 runQueue、iterator 后，我们再来看看队列实际执行的代码是什么样的</p> <h3 id="队列执行"><a href="#队列执行" class="header-anchor">#</a> 队列执行</h3> <p>队列执行的完整代码如下</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/history/base.js</span>

<span class="token comment">// 执行队列</span>
<span class="token function">runQueue</span><span class="token punctuation">(</span>
  queue<span class="token punctuation">,</span>
  iterator<span class="token punctuation">,</span>
  <span class="token comment">/* 执行结束回调*/</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 保存beforeRouteEnter中传给next的回调函数</span>
    <span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route<span class="token punctuation">;</span> <span class="token comment">// 表示跳转结束 // wait until async components are resolved before // extracting in-component enter guards</span>
    <span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待异步组件解析完，再抽取组件内的beforeRouteEnter守卫</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// beforeResolve hooks</span>
    <span class="token function">runQueue</span><span class="token punctuation">(</span>
      queue<span class="token punctuation">,</span>
      iterator<span class="token punctuation">,</span>
      <span class="token comment">/* 执行结束回调*/</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行onComplete回调，onComplete中会调用updateRoute方法，内部会触发afterEach钩子</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 调用 beforeRouteEnter 守卫中传给 next 的回调函数</span>
            <span class="token comment">// next(vm=&gt;xxx)</span>
            postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>可以看到，传入了队列 <code>queue</code>、迭代器 <code>iterator</code> 以及一个全部执行结束的回调函数<br>
先回顾下 <code>queue</code> 队列中有哪些元素</p> <ul><li>beforeRouteLeave 守卫</li> <li>全局的 beforeEach 守卫</li> <li>beforeRouteUpdate 守卫</li> <li>beforeEnter 守卫</li> <li>以及一个高阶函数，执行后会返回解析异步组件的函数</li></ul> <p>队列中的函数会在队列执行时依次在 iterator 中被调用<br>
前面几个都是已经提取出来的守卫函数，可以同步执行<br>
但是最后一个高阶函数执行后，会返回一个解析异步组件的函数<br>
其借助闭包的特性，能访问从 iterator 中传入的 from、to、next<br>
然后在解析完异步组件后调用 next，进入队列下一项的执行<br>
这样就能保证，即使队列中有异步函数，也能顺序地将队列执行完<br>
在整个守卫队列执行完后，就会执行结束回调<br>
执行结束回调时，此时异步组件已经全部解析完毕，就可以抽取 beforeRouteEnter 了</p> <h3 id="抽取-beforerouteenter"><a href="#抽取-beforerouteenter" class="header-anchor">#</a> 抽取 beforeRouteEnter</h3> <p>抽取 <code>beforeRouteEnter</code> 和其它守卫稍微有点不同</p> <ol><li>因为 <code>beforeRouteEnter</code> 所在的组件可能是异步的，所以 <code>beforeRouteEnter</code> 必须等到异步组件解析完毕才能开始抽取</li> <li>还有一个不同，就是在路由过渡动画为 <code>out-in</code> 时，异步组件可能已经解析完毕了，但是 router-view 实例可能还未注册，此时是不能调用 beforeRouteEnter 的；具体见<a href="https%3A%2F%2Fgithub.com%2Fvuejs%2Fvue-router%2Fissues%2F750">issue #750</a></li></ol> <p>因为 <code>beforeRouteEnter</code> 支持传一个回调给 <code>next</code> 来访问组件实例，就像下面这样</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token function">beforeRouteEnter</span> <span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token comment">/*postEnterCb*/</span>vm <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过 `vm` 访问组件实例</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>而这个 vm 是保存在 router-view 实例上的，所以需要等到 router-view 实例存在时，才能调用回调<br>
我们看下代码实现</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">//src/history/base.js</span>

<span class="token operator">...</span>
<span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 保存beforeRouteEnter中传给next的回调函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route <span class="token comment">// 表示跳转结束</span>
<span class="token comment">// wait until async components are resolved before</span>
<span class="token comment">// extracting in-component enter guards</span>
<span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span> <span class="token comment">// 等待异步组件解析完，再抽取组件内的beforeRouteEnter守卫</span>
<span class="token operator">...</span>


<span class="token comment">// 提取组件的beforeRouteEnter守卫</span>
<span class="token keyword">function</span> <span class="token function">extractEnterGuards</span> <span class="token punctuation">(</span>
  activated<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  cbs<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">Function</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// postEnterCbs</span>
  <span class="token function-variable function">isValid</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token builtin">Function</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>
    activated<span class="token punctuation">,</span>
    <span class="token string">'beforeRouteEnter'</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>guard<span class="token punctuation">,</span> _<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* 绑定beforeRouteEnter的执行上下文 */</span>
      <span class="token keyword">return</span> <span class="token function">bindEnterGuard</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 绑定beforeRouteEnter的执行上下文</span>
<span class="token keyword">function</span> <span class="token function">bindEnterGuard</span> <span class="token punctuation">(</span>
  guard<span class="token operator">:</span> NavigationGuard<span class="token punctuation">,</span>
  match<span class="token operator">:</span> RouteRecord<span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  cbs<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">Function</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// postEnterCbs</span>
  <span class="token function-variable function">isValid</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> NavigationGuard <span class="token punctuation">{</span>
  <span class="token comment">// 对组件内的beforeRouteEnter进行了包装</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">routeEnterGuard</span> <span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用组件内beforeRouteEnter守卫</span>
    <span class="token keyword">return</span> <span class="token function">guard</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token comment">/* beforeRouteEnter next函数；cb为next中回调*/</span>cb <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> cb <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// #750</span>
          <span class="token comment">// if a router-view is wrapped with an out-in transition,</span>
          <span class="token comment">// the instance may not have been registered at this time.</span>
          <span class="token comment">// we will need to poll for registration until current route</span>
          <span class="token comment">// is no longer valid.</span>
          <span class="token comment">// 如果router-view被out-in transition包裹</span>
          <span class="token comment">// 在确认路由，准备调用beforeRouteEnter守卫时，router-view实例可能还不存在</span>
          <span class="token comment">// 但是此时this.current已经为to</span>
          <span class="token comment">// 所以必须轮询调用cb直到instance存在</span>
          <span class="token function">poll</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> match<span class="token punctuation">.</span>instances<span class="token punctuation">,</span> key<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 迭代器下步</span>
      <span class="token function">next</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 轮询调用cb</span>
<span class="token keyword">function</span> <span class="token function">poll</span> <span class="token punctuation">(</span>
  cb<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token comment">/* cb为beforeRouteEnter next中回调*/</span> <span class="token comment">// somehow flow cannot infer this is a function</span>
  instances<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token function-variable function">isValid</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">boolean</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>_isBeingDestroyed <span class="token comment">// do not reuse being destroyed instance</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">poll</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> instances<span class="token punctuation">,</span> key<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>可以看到在调用 <code>extractEnterGuards</code> 前 在外层声明了一个 <code>postEnterCbs</code> 数组</p> <p>用来保存 <code>beforeRouteEnter</code> 中传给 <code>next</code> 的回调函数，我们称为 <code>postEnterCb</code>，也就是进入后的回调</p> <p>以及一个判断跳转是否结束的 <code>isValid</code> 函数<br> <code>isValid</code> 函数会被传入 <code>extractEnterGuards</code> 中<br> <code>extractEnterGuards</code> 中通过高阶函数形式返回一个包装了 <code>beforeRouteEnter</code> 的具名函数 <code>routeEnterGuard</code>，其会在执行队列时被调用，并执行真正的 <code>beforeRouteEnter</code> 守卫 guard<br> <code>guard</code> 在被执行时，会接收 <code>from、to</code> 以及一个被'改造'过的<code>next</code>，其接收一个 <code>postEnterCb</code><br>
这个 <code>postEnterCb</code> 可能在将来需要访问 <code>vm</code>
所以将 <code>postEnterCb</code> 用 <code>poll</code> 方法包裹塞入在外面定义好的 <code>postEnterCbs</code> 数组中<br>
poll 方法主要是用来解决前面提到的 issue #750 的，它会一直轮询，直到 router-view 实例存在时，再调用 postEnterCb 并传入挂载到 router-view 上的组件实例<br>
这样就实现了 next 中能访问到组件实例的逻辑<br>
抽取完 beforeRouteEnter 守卫和其中的 postEnterCbs 后，又在 queue 后拼接了 beforeResolve 守卫</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待异步组件解析完，再抽取组件内的beforeRouteEnter守卫</span>
<span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// beforeResolve hooks</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>此时 <code>queue</code> 中是 <code>routeEnterGuard</code> 函数及 <code>resolveHook</code><br>
然后执行此队列，队列中的 <code>routerEnterGuard</code> 和 <code>resolveHook</code> 会执行</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token function">runQueue</span><span class="token punctuation">(</span>
  queue<span class="token punctuation">,</span>
  iterator<span class="token punctuation">,</span>
  <span class="token comment">/* 执行结束回调*/</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行onComplete回调，onComplete中会调用updateRoute方法，内部会触发afterEach钩子</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用 beforeRouteEnter 守卫中传给 next 的回调函数</span>
        <span class="token comment">// next(vm=&gt;xxx)</span>
        postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>执行的逻辑和之前类似，beforeRouteEnter 和 beforeResolve 会被依次调用，然后执行队列结束回调<br>
队列结束回调中会调用 onComplete 并传入目标 Route 并在$nextTick 中遍历之前保存的 postEnterCbs，即传入 next 的回调<br>
此处的 onComplete 是确认路由时(confirmTransition)传入的</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/history/base.js transitionTo方法中</span>

   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>
      route<span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// onComplete，完成</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token comment">// 更新route，会触发afterEach钩子</span>
        onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token comment">// 调用onComplete回调</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// fire ready cbs once</span>
        <span class="token comment">// 触发ready回调</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cb <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// onAbort回调</span>
      err<span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>可以看到其调用 <code>updateRoute</code> 来更新 route，这会触发 <code>afterEach</code> 钩子<br>
调用 ensureURL 更新 url<br>
并调用传入 <code>transitionTo</code> 的 <code>onComplete</code> 函数，主要用来在 vue-router 初始化时为 <code>hash</code> 模式做初始化绑定(<code>setupHashListener</code>)<br>
最后触发通过 <code>onReady</code> 注册的 <code>readyCbs</code> 回调</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/history/base.js</span>

  <span class="token comment">// 更新路由，触发afterEach钩子</span>
  <span class="token function">updateRoute</span> <span class="token punctuation">(</span>route<span class="token operator">:</span> Route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
    <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> route<span class="token comment">// 更新current</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token comment">// 调用updateRoute回调，回调中会重新为_routerRoot._route赋值，进而触发router-view的重新渲染</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>afterHooks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>hook <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 触发afterEach狗子</span>
      hook <span class="token operator">&amp;&amp;</span> <span class="token function">hook</span><span class="token punctuation">(</span><span class="token comment">/* to*/</span>route<span class="token punctuation">,</span> <span class="token comment">/* from*/</span>prev<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>updateRoute</code> 会调用 <code>History</code> 上通过 <code>listen</code> 方法注册的更新回调，触发 roter-view 的重新渲染<br>
这些更新回调是在 vue-router 初始化时注册的</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/index.js init</span>
history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route<span class="token punctuation">;</span> <span class="token comment">// 更新route</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>然后执行所有 <code>afterEach</code> 钩子<br>
至此一次完整的路由跳转完成，相应的守卫及钩子也触发完成</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>整个导航的解析(确认)，其实就是从不同状态的路由记录中抽取出对应的守卫及钩子</li> <li>然后组成队列，使用 <code>runQueue</code>、<code>iterator</code> 巧妙的完成守卫的执行</li> <li>并在其中处理了异步组件的解析、<code>postEnterCb</code> 中实例获取的问题</li> <li>整个守卫、钩子的执行流程如下
<ul><li>导航被触发。</li> <li>在失活的组件里调用 <code>beforeRouteLeave</code> 守卫。</li> <li>调用全局的 <code>beforeEach</code> 守卫。</li> <li>在重用的组件里调用 <code>beforeRouteUpdate</code> 守卫 (2.2+)。</li> <li>在路由配置里调用  <code>beforeEnter</code>。</li> <li>解析异步路由组件。</li> <li>在被激活的组件里调用  <code>beforeRouteEnter</code>。</li> <li>调用全局的 <code>beforeResolve</code> 守卫 (2.5+)。</li> <li>导航被确认。</li> <li>调用全局的 <code>afterEach</code> 钩子。</li> <li>触发 <code>DOM</code> 更新。</li> <li>用创建好的实例调用 <code>beforeRouteEnter</code> 守卫中传给 <code>next</code> 的回调函数。</li></ul></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/luvue/vuesourcecode/Vue-Router/02-vue-router源码解析[上].html" class="prev">02-vue-router源码解析[上]</a></span> <span class="next"><a href="/luvue/vuesourcecode/Vue-Router/04-vue-router源码解析[下].html">04-vue-router源码解析[下]</a>
      →
    </span></p></div> </main> <span data-v-2ae0ee72></span></div><div class="global-ui"></div></div>
    <script src="/luvue/assets/js/app.50227b6d.js" defer></script><script src="/luvue/assets/js/2.dc297d8e.js" defer></script><script src="/luvue/assets/js/3.51a2d233.js" defer></script><script src="/luvue/assets/js/292.0e4d6a16.js" defer></script>
  </body>
</html>
